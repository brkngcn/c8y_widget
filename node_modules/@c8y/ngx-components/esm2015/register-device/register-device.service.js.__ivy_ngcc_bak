import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { DeviceRegistrationService, DeviceRegistrationStatus } from '@c8y/client';
import { get, pick } from 'lodash-es';
import { BehaviorSubject, forkJoin, from, Subject } from 'rxjs';
import { AlertService, gettext } from '@c8y/ngx-components';
import { finalize, map, mergeMap, takeLast, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@c8y/client/lib/src/device-registration/DeviceRegistrationService";
import * as i3 from "@c8y/ngx-components";
export class RegisterDeviceService {
    constructor(router, deviceRegService, alertService) {
        this.router = router;
        this.deviceRegService = deviceRegService;
        this.alertService = alertService;
        this._loading = new Subject();
        this._limit = new BehaviorSubject({ isReached: false });
        this._deviceRegistrationRequests = new BehaviorSubject({ data: [] });
        this.deviceRegistrationRequests$ = this._deviceRegistrationRequests.asObservable();
        this.loading$ = this._loading.asObservable();
        this.limit$ = this._limit.asObservable();
        this.deviceRegUrl = '/deviceregistration';
        this.endSubscriptions = new Subject();
    }
    isDeviceRegistration() {
        return get(this.router, 'url') === this.deviceRegUrl;
    }
    internalListUpdate(deviceRequests, pagingObject) {
        let { paging, data } = this._deviceRegistrationRequests.getValue();
        if (pagingObject) {
            paging = pagingObject;
        }
        data = [...data, ...deviceRequests];
        this._deviceRegistrationRequests.next({ data, paging });
    }
    onDeviceBootstrap(bsData) {
        const { id, status } = bsData;
        this._deviceRegistrationRequests.next({
            data: this.updateStatusById(id, status)
        });
    }
    list(pageSize = 100) {
        this._loading.next(true);
        this._deviceRegistrationRequests.next({ data: [], paging: undefined });
        from(this.deviceRegService.list({ pageSize, withTotalPages: true }))
            .pipe(takeUntil(this.endSubscriptions), finalize(() => this.limit()))
            .subscribe(res => {
            const { data, paging } = res;
            this.internalListUpdate(data, paging);
            this._loading.next(false);
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    createMultiple(newDeviceRequests) {
        if (newDeviceRequests && newDeviceRequests.length > 0) {
            this._loading.next(true);
            const newRequests$ = newDeviceRequests.map(element => {
                return from(this.deviceRegService.create(element)
                    .catch((err) => ({ res: err.res, data: Object.assign(Object.assign({}, err.data), { id: element.id }) })));
            });
            const groupedRequests = {
                success: [],
                failed: []
            };
            return forkJoin(newRequests$)
                .pipe(mergeMap(resp => resp.map(el => {
                el.res.ok ? groupedRequests.success.push(el.data) : groupedRequests.failed.push(el.data);
                return groupedRequests;
            })), takeLast(1), finalize(() => {
                this.internalListUpdate(groupedRequests.success);
                this._loading.next(false);
            }));
        }
    }
    remove(id) {
        this._loading.next(true);
        from(this.deviceRegService.delete(id))
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(res => {
            this._deviceRegistrationRequests.next({ data: this.removeDeviceRegistrationRequestById(id) });
            this._loading.next(false);
            this.alertService.success(gettext('Device registration cancelled.'));
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    accept(request) {
        this._loading.next(true);
        const payload = pick(request, ['id', 'securityToken']);
        from(this.deviceRegService.accept(payload))
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(res => {
            this._deviceRegistrationRequests.next({ data: this.updateStatusById(payload.id, DeviceRegistrationStatus.ACCEPTED) });
            this.limit();
            this._loading.next(false);
            this.alertService.success(gettext('Device registration accepted.'));
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    acceptAll() {
        const acceptedDeviceRequests = [];
        const failedDeviceRequests = [];
        this._loading.next(true);
        from(this.deviceRegService.acceptAll())
            .pipe(takeUntil(this.endSubscriptions), map(({ data }) => {
            data.map(deviceRegistrationRequest => {
                if (deviceRegistrationRequest.successful) {
                    acceptedDeviceRequests.push(deviceRegistrationRequest);
                    this.updateStatusById(deviceRegistrationRequest.id, DeviceRegistrationStatus.ACCEPTED);
                }
                else {
                    failedDeviceRequests.push(deviceRegistrationRequest);
                }
            });
            return data;
        }), finalize(() => {
            // update rendered list with successful accepted device registrations
            // see: this.updateStatusById(...)
            this.internalListUpdate([]);
            this.limit();
            this._loading.next(false);
            if (failedDeviceRequests.length > 0) {
                this.alertService.warning(gettext('Could not accept all pending registration requests.'), JSON.stringify({
                    failedDeviceRequests,
                    acceptedDeviceRequests
                }, undefined, 2));
            }
            else {
                this.alertService.success(gettext('Accepted all pending registration requests.'));
            }
        })).subscribe(res => {
            // empty by design
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    limit() {
        from(this.deviceRegService.limit())
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(res => this._limit.next(res.data), err => this.alertService.addServerFailure(err));
    }
    getRequestByStatus(status) {
        return this._deviceRegistrationRequests.getValue().data.filter(req => req.status === status);
    }
    ngOnDestroy() {
        this.endSubscriptions.next();
        this.endSubscriptions.complete();
    }
    updateStatusById(id, status) {
        const items = this._deviceRegistrationRequests.getValue().data;
        const matchingElementIndex = items.findIndex(element => element.id === id);
        if (matchingElementIndex >= 0) {
            items[matchingElementIndex].status = status;
        }
        return items;
    }
    removeDeviceRegistrationRequestById(id) {
        const items = this._deviceRegistrationRequests.getValue().data;
        const matchingElementIndex = items.findIndex(element => element.id === id);
        if (matchingElementIndex >= 0) {
            items.splice(matchingElementIndex, 1);
        }
        this._loading.next(false);
        return items;
    }
}
RegisterDeviceService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RegisterDeviceService_Factory() { return new RegisterDeviceService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.DeviceRegistrationService), i0.ɵɵinject(i3.AlertService)); }, token: RegisterDeviceService, providedIn: "root" });
RegisterDeviceService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
RegisterDeviceService.ctorParameters = () => [
    { type: Router },
    { type: DeviceRegistrationService },
    { type: AlertService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXItZGV2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9yZWdpc3Rlci1kZXZpY2UvcmVnaXN0ZXItZGV2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUNMLHlCQUF5QixFQUN6Qix3QkFBd0IsRUFPekIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBNEIsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RixPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUs5RSxNQUFNLE9BQU8scUJBQXFCO0lBWWhDLFlBQW9CLE1BQWMsRUFDZCxnQkFBMkMsRUFDM0MsWUFBMEI7UUFGMUIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBMkI7UUFDM0MsaUJBQVksR0FBWixZQUFZLENBQWM7UUFickMsYUFBUSxHQUFxQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzNDLFdBQU0sR0FBOEMsSUFBSSxlQUFlLENBQUMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM5RixnQ0FBMkIsR0FBMkYsSUFBSSxlQUFlLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4SixnQ0FBMkIsR0FBc0YsSUFB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QyxNQUFNLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDdkM7UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Ozs7WUF4TkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFsQlEsTUFBTTtZQUViLHlCQUF5QjtZQVdsQixZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7XG4gIERldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UsXG4gIERldmljZVJlZ2lzdHJhdGlvblN0YXR1cyxcbiAgSURldmljZVJlZ2lzdHJhdGlvbixcbiAgSURldmljZVJlZ2lzdHJhdGlvbkFjY2VwdCxcbiAgSURldmljZVJlZ2lzdHJhdGlvbkNyZWF0ZSxcbiAgSURldmljZVJlZ2lzdHJhdGlvbkxpbWl0LFxuICBJUmVzdWx0LFxuICBQYWdpbmdcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0LCBwaWNrIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZm9ya0pvaW4sIGZyb20sIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCwgSVJlYWx0aW1lRGV2aWNlQm9vdHN0cmFwIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBmaW5hbGl6ZSwgbWFwLCBtZXJnZU1hcCwgdGFrZUxhc3QsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUmVnaXN0ZXJEZXZpY2VTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgX2xvYWRpbmc6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdCgpO1xuICByZWFkb25seSBfbGltaXQ6IEJlaGF2aW9yU3ViamVjdDxJRGV2aWNlUmVnaXN0cmF0aW9uTGltaXQ+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7IGlzUmVhY2hlZDogZmFsc2UgfSk7XG4gIHJlYWRvbmx5IF9kZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0czogQmVoYXZpb3JTdWJqZWN0PHsgZGF0YTogSURldmljZVJlZ2lzdHJhdGlvbltdLCBwYWdpbmc/OiBQYWdpbmc8SURldmljZVJlZ2lzdHJhdGlvbj4gfT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHsgZGF0YTogW10gfSk7XG4gIHJlYWRvbmx5IGRldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzJDogT2JzZXJ2YWJsZTx7IGRhdGE6IElEZXZpY2VSZWdpc3RyYXRpb25bXSwgcGFnaW5nPzogUGFnaW5nPElEZXZpY2VSZWdpc3RyYXRpb24+IH0+ID0gdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IGxvYWRpbmckOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpcy5fbG9hZGluZy5hc09ic2VydmFibGUoKTtcbiAgcmVhZG9ubHkgbGltaXQkOiBPYnNlcnZhYmxlPElEZXZpY2VSZWdpc3RyYXRpb25MaW1pdD4gPSB0aGlzLl9saW1pdC5hc09ic2VydmFibGUoKTtcbiAgcGFnaW5nOiBQYWdpbmc8SURldmljZVJlZ2lzdHJhdGlvbj47XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkZXZpY2VSZWdVcmwgPSAnL2RldmljZXJlZ2lzdHJhdGlvbic7XG4gIHByaXZhdGUgZW5kU3Vic2NyaXB0aW9uczogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBkZXZpY2VSZWdTZXJ2aWNlOiBEZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlKSB7XG4gIH1cblxuICBpc0RldmljZVJlZ2lzdHJhdGlvbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZ2V0KHRoaXMucm91dGVyLCAndXJsJykgPT09IHRoaXMuZGV2aWNlUmVnVXJsO1xuICB9XG5cbiAgaW50ZXJuYWxMaXN0VXBkYXRlKGRldmljZVJlcXVlc3RzOiBJRGV2aWNlUmVnaXN0cmF0aW9uW10sIHBhZ2luZ09iamVjdD86IFBhZ2luZzxJRGV2aWNlUmVnaXN0cmF0aW9uPikge1xuICAgIGxldCB7IHBhZ2luZywgZGF0YSB9ID0gdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMuZ2V0VmFsdWUoKTtcbiAgICBpZiAocGFnaW5nT2JqZWN0KSB7XG4gICAgICBwYWdpbmcgPSBwYWdpbmdPYmplY3Q7XG4gICAgfVxuICAgIGRhdGEgPSBbLi4uZGF0YSwgLi4uZGV2aWNlUmVxdWVzdHNdO1xuICAgIHRoaXMuX2RldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzLm5leHQoeyBkYXRhLCBwYWdpbmcgfSk7XG4gIH1cblxuICBvbkRldmljZUJvb3RzdHJhcChic0RhdGE6IElSZWFsdGltZURldmljZUJvb3RzdHJhcCkge1xuICAgIGNvbnN0IHsgaWQsIHN0YXR1cyB9ID0gYnNEYXRhO1xuICAgIHRoaXMuX2RldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzLm5leHQoe1xuICAgICAgZGF0YTogdGhpcy51cGRhdGVTdGF0dXNCeUlkKGlkLCBzdGF0dXMpXG4gICAgfSk7XG4gIH1cblxuICBsaXN0KHBhZ2VTaXplOiBudW1iZXIgPSAxMDApIHtcbiAgICB0aGlzLl9sb2FkaW5nLm5leHQodHJ1ZSk7XG4gICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7IGRhdGE6IFtdLCBwYWdpbmc6IHVuZGVmaW5lZCB9KTtcblxuICAgIGZyb20odGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmxpc3QoeyBwYWdlU2l6ZSwgd2l0aFRvdGFsUGFnZXM6IHRydWUgfSkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucyksXG4gICAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMubGltaXQoKSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkYXRhLCBwYWdpbmcgfSA9IHJlcztcbiAgICAgICAgICB0aGlzLmludGVybmFsTGlzdFVwZGF0ZShkYXRhLCBwYWdpbmcpO1xuICAgICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBjcmVhdGVNdWx0aXBsZShuZXdEZXZpY2VSZXF1ZXN0czogSURldmljZVJlZ2lzdHJhdGlvbkNyZWF0ZVtdKSB7XG4gICAgaWYgKG5ld0RldmljZVJlcXVlc3RzICYmIG5ld0RldmljZVJlcXVlc3RzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKTtcbiAgICAgIGNvbnN0IG5ld1JlcXVlc3RzJCA9IG5ld0RldmljZVJlcXVlc3RzLm1hcChlbGVtZW50ID0+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgdGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmNyZWF0ZShlbGVtZW50KVxuICAgICAgICAgICAgLmNhdGNoKChlcnI6IElSZXN1bHQ8SURldmljZVJlZ2lzdHJhdGlvbj4pID0+IChcbiAgICAgICAgICAgICAgeyByZXM6IGVyci5yZXMsIGRhdGE6IHsgLi4uZXJyLmRhdGEsIGlkOiBlbGVtZW50LmlkIH0gfVxuICAgICAgICAgICAgKSkpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGdyb3VwZWRSZXF1ZXN0czoge1xuICAgICAgICBzdWNjZXNzOiBJRGV2aWNlUmVnaXN0cmF0aW9uW10sXG4gICAgICAgIGZhaWxlZDogSURldmljZVJlZ2lzdHJhdGlvbltdXG4gICAgICB9ID0ge1xuICAgICAgICBzdWNjZXNzOiBbXSxcbiAgICAgICAgZmFpbGVkOiBbXVxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIGZvcmtKb2luKG5ld1JlcXVlc3RzJClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWVyZ2VNYXAocmVzcCA9PiByZXNwLm1hcChlbCA9PiB7XG4gICAgICAgICAgICBlbC5yZXMub2sgPyBncm91cGVkUmVxdWVzdHMuc3VjY2Vzcy5wdXNoKGVsLmRhdGEpIDogZ3JvdXBlZFJlcXVlc3RzLmZhaWxlZC5wdXNoKGVsLmRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIGdyb3VwZWRSZXF1ZXN0cztcbiAgICAgICAgICB9KSksXG4gICAgICAgICAgdGFrZUxhc3QoMSksXG4gICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pbnRlcm5hbExpc3RVcGRhdGUoZ3JvdXBlZFJlcXVlc3RzLnN1Y2Nlc3MpO1xuICAgICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZShpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5fbG9hZGluZy5uZXh0KHRydWUpO1xuICAgIGZyb20odGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmRlbGV0ZShpZCkpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5lbmRTdWJzY3JpcHRpb25zKSlcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dChcbiAgICAgICAgICAgIHsgZGF0YTogdGhpcy5yZW1vdmVEZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0QnlJZChpZCkgfVxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0RldmljZSByZWdpc3RyYXRpb24gY2FuY2VsbGVkLicpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICB0aGlzLl9sb2FkaW5nLm5leHQoZmFsc2UpO1xuICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXJyKTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgfVxuXG4gIGFjY2VwdChyZXF1ZXN0OiBJRGV2aWNlUmVnaXN0cmF0aW9uKSB7XG4gICAgdGhpcy5fbG9hZGluZy5uZXh0KHRydWUpO1xuICAgIGNvbnN0IHBheWxvYWQgPSBwaWNrKHJlcXVlc3QsIFsnaWQnLCAnc2VjdXJpdHlUb2tlbiddKTtcbiAgICBmcm9tKHRoaXMuZGV2aWNlUmVnU2VydmljZS5hY2NlcHQocGF5bG9hZCkpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5lbmRTdWJzY3JpcHRpb25zKSlcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dChcbiAgICAgICAgICAgIHsgZGF0YTogdGhpcy51cGRhdGVTdGF0dXNCeUlkKHBheWxvYWQuaWQsIERldmljZVJlZ2lzdHJhdGlvblN0YXR1cy5BQ0NFUFRFRCkgfVxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5saW1pdCgpO1xuICAgICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdEZXZpY2UgcmVnaXN0cmF0aW9uIGFjY2VwdGVkLicpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICB0aGlzLl9sb2FkaW5nLm5leHQoZmFsc2UpO1xuICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXJyKTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgfVxuXG4gIGFjY2VwdEFsbCgpIHtcbiAgICBjb25zdCBhY2NlcHRlZERldmljZVJlcXVlc3RzOiBJRGV2aWNlUmVnaXN0cmF0aW9uQWNjZXB0W10gPSBbXTtcbiAgICBjb25zdCBmYWlsZWREZXZpY2VSZXF1ZXN0czogSURldmljZVJlZ2lzdHJhdGlvbkFjY2VwdFtdID0gW107XG4gICAgdGhpcy5fbG9hZGluZy5uZXh0KHRydWUpO1xuXG4gICAgZnJvbSh0aGlzLmRldmljZVJlZ1NlcnZpY2UuYWNjZXB0QWxsKCkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucyksXG4gICAgICAgIG1hcCgoeyBkYXRhIH0pID0+IHtcbiAgICAgICAgICBkYXRhLm1hcChkZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0ID0+IHtcbiAgICAgICAgICAgIGlmIChkZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0LnN1Y2Nlc3NmdWwpIHtcbiAgICAgICAgICAgICAgYWNjZXB0ZWREZXZpY2VSZXF1ZXN0cy5wdXNoKGRldmljZVJlZ2lzdHJhdGlvblJlcXVlc3QpO1xuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXR1c0J5SWQoZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdC5pZCwgRGV2aWNlUmVnaXN0cmF0aW9uU3RhdHVzLkFDQ0VQVEVEKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGZhaWxlZERldmljZVJlcXVlc3RzLnB1c2goZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pLFxuICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgLy8gdXBkYXRlIHJlbmRlcmVkIGxpc3Qgd2l0aCBzdWNjZXNzZnVsIGFjY2VwdGVkIGRldmljZSByZWdpc3RyYXRpb25zXG4gICAgICAgICAgLy8gc2VlOiB0aGlzLnVwZGF0ZVN0YXR1c0J5SWQoLi4uKVxuICAgICAgICAgIHRoaXMuaW50ZXJuYWxMaXN0VXBkYXRlKFtdKTtcbiAgICAgICAgICB0aGlzLmxpbWl0KCk7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICBpZiAoZmFpbGVkRGV2aWNlUmVxdWVzdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uud2FybmluZyhnZXR0ZXh0KCdDb3VsZCBub3QgYWNjZXB0IGFsbCBwZW5kaW5nIHJlZ2lzdHJhdGlvbiByZXF1ZXN0cy4nKSwgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBmYWlsZWREZXZpY2VSZXF1ZXN0cyxcbiAgICAgICAgICAgICAgYWNjZXB0ZWREZXZpY2VSZXF1ZXN0c1xuICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQWNjZXB0ZWQgYWxsIHBlbmRpbmcgcmVnaXN0cmF0aW9uIHJlcXVlc3RzLicpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZShcbiAgICAgIHJlcyA9PiB7XG4gICAgICAgIC8vIGVtcHR5IGJ5IGRlc2lnblxuICAgICAgfSxcbiAgICAgIGVyciA9PiB7XG4gICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXJyKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgbGltaXQoKSB7XG4gICAgZnJvbSh0aGlzLmRldmljZVJlZ1NlcnZpY2UubGltaXQoKSlcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmVuZFN1YnNjcmlwdGlvbnMpKVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgcmVzID0+IHRoaXMuX2xpbWl0Lm5leHQocmVzLmRhdGEpLFxuICAgICAgICBlcnIgPT4gdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnIpXG4gICAgICApO1xuICB9XG5cbiAgZ2V0UmVxdWVzdEJ5U3RhdHVzKHN0YXR1czogRGV2aWNlUmVnaXN0cmF0aW9uU3RhdHVzKTogSURldmljZVJlZ2lzdHJhdGlvbltdIHtcbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMuZ2V0VmFsdWUoKS5kYXRhLmZpbHRlcihyZXEgPT4gcmVxLnN0YXR1cyA9PT0gc3RhdHVzKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZW5kU3Vic2NyaXB0aW9ucy5uZXh0KCk7XG4gICAgdGhpcy5lbmRTdWJzY3JpcHRpb25zLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0YXR1c0J5SWQoaWQ6IHN0cmluZywgc3RhdHVzOiBEZXZpY2VSZWdpc3RyYXRpb25TdGF0dXMpIHtcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuX2RldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzLmdldFZhbHVlKCkuZGF0YTtcbiAgICBjb25zdCBtYXRjaGluZ0VsZW1lbnRJbmRleCA9IGl0ZW1zLmZpbmRJbmRleChlbGVtZW50ID0+IGVsZW1lbnQuaWQgPT09IGlkKTtcbiAgICBpZiAobWF0Y2hpbmdFbGVtZW50SW5kZXggPj0gMCkge1xuICAgICAgaXRlbXNbbWF0Y2hpbmdFbGVtZW50SW5kZXhdLnN0YXR1cyA9IHN0YXR1cztcbiAgICB9XG4gICAgcmV0dXJuIGl0ZW1zO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVEZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0QnlJZChpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLl9kZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0cy5nZXRWYWx1ZSgpLmRhdGE7XG4gICAgY29uc3QgbWF0Y2hpbmdFbGVtZW50SW5kZXggPSBpdGVtcy5maW5kSW5kZXgoZWxlbWVudCA9PiBlbGVtZW50LmlkID09PSBpZCk7XG4gICAgaWYgKG1hdGNoaW5nRWxlbWVudEluZGV4ID49IDApIHtcbiAgICAgIGl0ZW1zLnNwbGljZShtYXRjaGluZ0VsZW1lbnRJbmRleCwgMSk7XG4gICAgfVxuICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgcmV0dXJuIGl0ZW1zO1xuICB9XG59XG4iXX0=