import { __awaiter } from "tslib";
import { Component, Input, ViewChild } from '@angular/core';
import { C8yStepper, gettext } from '@c8y/ngx-components';
import { FormGroup } from '@angular/forms';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { ExtensibleDeviceRegistrationService } from './extensible-device-registration.service';
import { RegisterDeviceService } from '../../register-device.service';
import { STEP_STATE } from '@angular/cdk/stepper';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './extensible-device-registration.service';
import * as ɵngcc2 from '../../register-device.service';
import * as ɵngcc3 from 'ngx-bootstrap/modal';
import * as ɵngcc4 from '@c8y/ngx-components';
import * as ɵngcc5 from '@angular/common';
import * as ɵngcc6 from '@angular/cdk/stepper';
import * as ɵngcc7 from '@ngx-formly/core';

const _c0 = function () { return { cancel: true, back: true, next: true }; };
const _c1 = function () { return { next: "Register" }; };
function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_3_Template(rf, ctx) { if (rf & 1) {
    const _r9 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "c8y-stepper-buttons", 11);
    ɵngcc0.ɵɵlistener("onCancel", function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_3_Template_c8y_stepper_buttons_onCancel_0_listener() { ɵngcc0.ɵɵrestoreView(_r9); const ctx_r8 = ɵngcc0.ɵɵnextContext(2); return ctx_r8.close(); })("onNext", function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_3_Template_c8y_stepper_buttons_onNext_0_listener() { ɵngcc0.ɵɵrestoreView(_r9); const ctx_r10 = ɵngcc0.ɵɵnextContext(2); return ctx_r10.save(); });
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const i_r5 = ɵngcc0.ɵɵnextContext().index;
    const ctx_r6 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("showButtons", ɵngcc0.ɵɵpureFunction0(4, _c0))("labels", ɵngcc0.ɵɵpureFunction0(5, _c1))("pending", ctx_r6.pendingStatus)("disabled", ctx_r6.forms[i_r5].invalid);
} }
const _c2 = function (a1) { return { cancel: true, back: a1, next: true }; };
function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_4_Template(rf, ctx) { if (rf & 1) {
    const _r13 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "c8y-stepper-buttons", 12);
    ɵngcc0.ɵɵlistener("onCancel", function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_4_Template_c8y_stepper_buttons_onCancel_0_listener() { ɵngcc0.ɵɵrestoreView(_r13); const ctx_r12 = ɵngcc0.ɵɵnextContext(2); return ctx_r12.close(); });
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const i_r5 = ɵngcc0.ɵɵnextContext().index;
    const ctx_r7 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("showButtons", ɵngcc0.ɵɵpureFunction1(2, _c2, i_r5 !== 0))("disabled", ctx_r7.forms[i_r5].invalid);
} }
function ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "cdk-step", 6);
    ɵngcc0.ɵɵelementStart(1, "c8y-form-group", 7);
    ɵngcc0.ɵɵelement(2, "formly-form", 8);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(3, ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_3_Template, 1, 6, "c8y-stepper-buttons", 9);
    ɵngcc0.ɵɵtemplate(4, ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_c8y_stepper_buttons_4_Template, 1, 4, "c8y-stepper-buttons", 10);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const step_r4 = ctx.$implicit;
    const i_r5 = ctx.index;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("stepControl", ctx_r0.forms[i_r5])("label", ctx_r0.labels[i_r5]);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("form", ctx_r0.forms[i_r5])("fields", step_r4)("model", ctx_r0.model);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.isRegistrationStep());
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r0.isRegistrationStep());
} }
function ExtensibleDeviceRegistrationStepperComponent_c8y_operation_result_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 13);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(1, 3, ctx_r1.message));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
function ExtensibleDeviceRegistrationStepperComponent_ng_template_5_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 14);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(1, 3, ctx_r3.errorMessage));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
const _c3 = function () { return { edit: true, done: false }; };
const _c4 = function () { return ["m-40", "m-t-16", "m-b-16"]; };
const _c5 = function (a0, a1, a2) { return { cancel: a0, back: a1, next: a2 }; };
const _c6 = function () { return { back: "Fix issue", next: "Close" }; };
export class ExtensibleDeviceRegistrationStepperComponent {
    constructor(customProviderService, registerDeviceService, bsModalRef) {
        this.customProviderService = customProviderService;
        this.registerDeviceService = registerDeviceService;
        this.bsModalRef = bsModalRef;
        this.pendingStatus = false;
        this.forms = [];
        this.model = {};
        this.SERVER_ERROR = gettext('Cannot register your device.');
        this.SUCCESSFUL_REGISTRATION = gettext('Your device was successfully registered.');
        this.NO_CONNECTION = gettext('Unable to reach the microservice.');
    }
    ngOnInit() {
        this.steps.forEach(step => this.forms.push(new FormGroup({})));
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            this.pendingStatus = true;
            this.errorMessage = null;
            const { res, data } = yield this.customProviderService.registerDevice(this.contextPath, this.model)
                .catch(err => {
                return {
                    res: undefined,
                    data: undefined
                };
            })
                .finally(() => {
                this.pendingStatus = false;
                this.stepper.next();
            });
            if (res && data) {
                if (res.status >= 400 && res.status < 500) {
                    this.handleError(data.message || this.SERVER_ERROR);
                }
                else if (res.status >= 500) {
                    this.handleError(this.SERVER_ERROR);
                }
                else {
                    this.message = this.SUCCESSFUL_REGISTRATION;
                }
            }
            else {
                this.handleError(this.NO_CONNECTION);
            }
        });
    }
    close() {
        this.bsModalRef.hide();
    }
    complete() {
        this.registerDeviceService.list();
        this.bsModalRef.hide();
    }
    goToFirstStep() {
        this.stepper.selectedIndex = 0;
    }
    isRegistrationStep() {
        return this.stepper.selectedIndex === this.steps.length - 1;
    }
    finalStepStatus() {
        if (this.stepper.selectedIndex === this.steps.length) {
            if (this.errorMessage) {
                return STEP_STATE.ERROR;
            }
            else {
                return STEP_STATE.DONE;
            }
        }
        else {
            return STEP_STATE.NUMBER;
        }
    }
    handleError(message) {
        this.errorMessage = message;
    }
}
ExtensibleDeviceRegistrationStepperComponent.ɵfac = function ExtensibleDeviceRegistrationStepperComponent_Factory(t) { return new (t || ExtensibleDeviceRegistrationStepperComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ExtensibleDeviceRegistrationService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.RegisterDeviceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.BsModalRef)); };
ExtensibleDeviceRegistrationStepperComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: ExtensibleDeviceRegistrationStepperComponent, selectors: [["c8y-extensible-device-registration-stepper"]], viewQuery: function ExtensibleDeviceRegistrationStepperComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(C8yStepper, 7);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.stepper = _t.first);
    } }, inputs: { contextPath: "contextPath", labels: "labels", steps: "steps" }, decls: 8, vars: 19, consts: [["linear", "", 3, "disableProgressButtons", "disableDefaultIcons", "customClasses"], [3, "stepControl", "label", 4, "ngFor", "ngForOf"], [3, "state", "label"], ["type", "success", "class", "lead", 3, "text", "size", "vertical", 4, "ngIf", "ngIfElse"], ["errorInfo", ""], [1, "sticky-bottom", "d-block", "p-t-16", "p-b-16", "separator-top", "bg-white", 3, "showButtons", "labels", "onCancel", "onNext", "onBack"], [3, "stepControl", "label"], [1, "form-group", "p-24", "p-b-0", "p-t-16"], [3, "form", "fields", "model"], ["class", "sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white", 3, "showButtons", "labels", "pending", "disabled", "onCancel", "onNext", 4, "ngIf"], ["class", "sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white", 3, "showButtons", "disabled", "onCancel", 4, "ngIf"], [1, "sticky-bottom", "d-block", "p-t-16", "p-b-16", "separator-top", "bg-white", 3, "showButtons", "labels", "pending", "disabled", "onCancel", "onNext"], [1, "sticky-bottom", "d-block", "p-t-16", "p-b-16", "separator-top", "bg-white", 3, "showButtons", "disabled", "onCancel"], ["type", "success", 1, "lead", 3, "text", "size", "vertical"], ["type", "error", 1, "lead", 3, "text", "size", "vertical"]], template: function ExtensibleDeviceRegistrationStepperComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-stepper", 0);
        ɵngcc0.ɵɵtemplate(1, ExtensibleDeviceRegistrationStepperComponent_cdk_step_1_Template, 5, 7, "cdk-step", 1);
        ɵngcc0.ɵɵelementStart(2, "cdk-step", 2);
        ɵngcc0.ɵɵpipe(3, "translate");
        ɵngcc0.ɵɵtemplate(4, ExtensibleDeviceRegistrationStepperComponent_c8y_operation_result_4_Template, 2, 5, "c8y-operation-result", 3);
        ɵngcc0.ɵɵtemplate(5, ExtensibleDeviceRegistrationStepperComponent_ng_template_5_Template, 2, 5, "ng-template", null, 4, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵelementStart(7, "c8y-stepper-buttons", 5);
        ɵngcc0.ɵɵlistener("onCancel", function ExtensibleDeviceRegistrationStepperComponent_Template_c8y_stepper_buttons_onCancel_7_listener() { return ctx.close(); })("onNext", function ExtensibleDeviceRegistrationStepperComponent_Template_c8y_stepper_buttons_onNext_7_listener() { return ctx.complete(); })("onBack", function ExtensibleDeviceRegistrationStepperComponent_Template_c8y_stepper_buttons_onBack_7_listener() { return ctx.goToFirstStep(); });
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        const _r2 = ɵngcc0.ɵɵreference(6);
        ɵngcc0.ɵɵproperty("disableProgressButtons", true)("disableDefaultIcons", ɵngcc0.ɵɵpureFunction0(12, _c3))("customClasses", ɵngcc0.ɵɵpureFunction0(13, _c4));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngForOf", ctx.steps);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵpropertyInterpolate("label", ɵngcc0.ɵɵpipeBind1(3, 10, "Summary"));
        ɵngcc0.ɵɵproperty("state", ctx.finalStepStatus());
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.errorMessage)("ngIfElse", _r2);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("showButtons", ɵngcc0.ɵɵpureFunction3(14, _c5, ctx.errorMessage, ctx.errorMessage, !ctx.errorMessage))("labels", ɵngcc0.ɵɵpureFunction0(18, _c6));
    } }, directives: [ɵngcc4.C8yStepper, ɵngcc5.NgForOf, ɵngcc6.CdkStep, ɵngcc5.NgIf, ɵngcc4.C8yStepperButtons, ɵngcc4.FormGroupComponent, ɵngcc7.FormlyForm, ɵngcc4.OperationResultComponent], pipes: [ɵngcc4.C8yTranslatePipe], encapsulation: 2 });
ExtensibleDeviceRegistrationStepperComponent.ctorParameters = () => [
    { type: ExtensibleDeviceRegistrationService },
    { type: RegisterDeviceService },
    { type: BsModalRef }
];
ExtensibleDeviceRegistrationStepperComponent.propDecorators = {
    stepper: [{ type: ViewChild, args: [C8yStepper, { static: true },] }],
    contextPath: [{ type: Input }],
    labels: [{ type: Input }],
    steps: [{ type: Input }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ExtensibleDeviceRegistrationStepperComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-extensible-device-registration-stepper',
                template: "<c8y-stepper\n  [disableProgressButtons]=\"true\"\n  [disableDefaultIcons]=\"{ edit: true, done: false }\"\n  [customClasses]=\"['m-40', 'm-t-16', 'm-b-16']\"\n  linear\n>\n  <cdk-step *ngFor=\"let step of steps; let i = index\" [stepControl]=\"forms[i]\" [label]=\"labels[i]\">\n    <c8y-form-group class=\"form-group p-24 p-b-0 p-t-16\">\n      <formly-form [form]=\"forms[i]\" [fields]=\"step\" [model]=\"model\"></formly-form>\n    </c8y-form-group>\n    <c8y-stepper-buttons\n      class=\"sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white\"\n      *ngIf=\"isRegistrationStep()\"\n      [showButtons]=\"{ cancel: true, back: true, next: true }\"\n      [labels]=\"{ next: 'Register' }\"\n      (onCancel)=\"close()\"\n      (onNext)=\"save()\"\n      [pending]=\"pendingStatus\"\n      [disabled]=\"forms[i].invalid\"\n    ></c8y-stepper-buttons>\n    <c8y-stepper-buttons\n      class=\"sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white\"\n      *ngIf=\"!isRegistrationStep()\"\n      [showButtons]=\"{ cancel: true, back: i !== 0, next: true }\"\n      [disabled]=\"forms[i].invalid\"\n      (onCancel)=\"close()\"\n    ></c8y-stepper-buttons>\n  </cdk-step>\n  <cdk-step [state]=\"finalStepStatus()\" label=\"{{ 'Summary' | translate }}\">\n    <c8y-operation-result\n      *ngIf=\"!errorMessage; else errorInfo\"\n      text=\"{{ message | translate }}\"\n      [size]=\"84\"\n      [vertical]=\"true\"\n      type=\"success\"\n      class=\"lead\"\n    ></c8y-operation-result>\n    <ng-template #errorInfo>\n      <c8y-operation-result\n        text=\"{{ errorMessage | translate }}\"\n        [size]=\"84\"\n        [vertical]=\"true\"\n        type=\"error\"\n        class=\"lead\"\n      ></c8y-operation-result>\n    </ng-template>\n    <c8y-stepper-buttons\n      class=\"sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white\"\n      [showButtons]=\"{ cancel: errorMessage, back: errorMessage, next: !errorMessage }\"\n      [labels]=\"{ back: 'Fix issue', next: 'Close' }\"\n      (onCancel)=\"close()\"\n      (onNext)=\"complete()\"\n      (onBack)=\"goToFirstStep()\"\n    ></c8y-stepper-buttons>\n  </cdk-step>\n</c8y-stepper>\n"
            }]
    }], function () { return [{ type: ɵngcc1.ExtensibleDeviceRegistrationService }, { type: ɵngcc2.RegisterDeviceService }, { type: ɵngcc3.BsModalRef }]; }, { stepper: [{
            type: ViewChild,
            args: [C8yStepper, { static: true }]
        }], contextPath: [{
            type: Input
        }], labels: [{
            type: Input
        }], steps: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaWJsZS1kZXZpY2UtcmVnaXN0cmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9yZWdpc3Rlci1kZXZpY2UvZXh0ZW5zaWJsZS9zaW5nbGUvZXh0ZW5zaWJsZS1kZXZpY2UtcmVnaXN0cmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBVSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQy9GLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRXRFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU9sRCxNQUFNLE9BQU8sNENBQTRDO0FBQUcsSUFrQjFELFlBQ1UscUJBQTBELEVBQzFELHFCQUE0QyxFQUM1QyxVQUFzQjtBQUMvQixRQUhTLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBcUM7QUFBQyxRQUMzRCwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO0FBQUMsUUFDN0MsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUNsQyxRQWxCRSxrQkFBYSxHQUFZLEtBQUssQ0FBQztBQUNqQyxRQUFFLFVBQUssR0FBZ0IsRUFBRSxDQUFDO0FBQzFCLFFBQUUsVUFBSyxHQUFRLEVBQUUsQ0FBQztBQUNsQixRQU9t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QUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO0FBQzFELFlBQU0sSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO0FBQzdCLGdCQUFRLE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQztBQUNoQyxhQUFPO0FBQUMsaUJBQUs7QUFDYixnQkFBUSxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUM7QUFDL0IsYUFBTztBQUNQLFNBQUs7QUFBQyxhQUFLO0FBQ1gsWUFBTSxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUM7QUFDL0IsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNILElBQ1UsV0FBVyxDQUFDLE9BQWU7QUFDckMsUUFBSSxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQztBQUNoQyxJQUFFLENBQUM7QUFDSDt3RUE5RkMsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSw0Q0FBNEMsa0JBQ3REOzs7Ozs7Ozt5RUFBb0UsY0FDckU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c1BBRUc7QUFBQztBQUFzRSxZQVZsRSxtQ0FBbUM7QUFBSSxZQUN2QyxxQkFBcUI7QUFBSSxZQUZ6QixVQUFVO0FBQUc7QUFBRztBQUNjLHNCQWlCcEMsU0FBUyxTQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7QUFDcEMsMEJBRUYsS0FBSztBQUFLLHFCQUNWLEtBQUs7QUFBSyxvQkFDVixLQUFLO0FBQUk7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uSW5pdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDOHlTdGVwcGVyLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBGb3JtR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBCc01vZGFsUmVmIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBFeHRlbnNpYmxlRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSB9IGZyb20gJy4vZXh0ZW5zaWJsZS1kZXZpY2UtcmVnaXN0cmF0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVnaXN0ZXJEZXZpY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcmVnaXN0ZXItZGV2aWNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcgfSBmcm9tICdAbmd4LWZvcm1seS9jb3JlJztcbmltcG9ydCB7IFNURVBfU1RBVEUgfSBmcm9tICdAYW5ndWxhci9jZGsvc3RlcHBlcic7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1leHRlbnNpYmxlLWRldmljZS1yZWdpc3RyYXRpb24tc3RlcHBlcicsXG4gIHRlbXBsYXRlVXJsOiAnZXh0ZW5zaWJsZS1kZXZpY2UtcmVnaXN0cmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50Lmh0bWwnXG59KVxuXG5leHBvcnQgY2xhc3MgRXh0ZW5zaWJsZURldmljZVJlZ2lzdHJhdGlvblN0ZXBwZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgZXJyb3JNZXNzYWdlOiBzdHJpbmc7XG4gIHBlbmRpbmdTdGF0dXM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgZm9ybXM6IEZvcm1Hcm91cFtdID0gW107XG4gIG1vZGVsOiBhbnkgPSB7fTtcbiAgQFZpZXdDaGlsZChDOHlTdGVwcGVyLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBzdGVwcGVyOiBDOHlTdGVwcGVyO1xuXG4gIEBJbnB1dCgpIGNvbnRleHRQYXRoOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGxhYmVsczogc3RyaW5nW107XG4gIEBJbnB1dCgpIHN0ZXBzOiBGb3JtbHlGaWVsZENvbmZpZ1tdW107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBTRVJWRVJfRVJST1IgPSBnZXR0ZXh0KCdDYW5ub3QgcmVnaXN0ZXIgeW91ciBkZXZpY2UuJyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgU1VDQ0VTU0ZVTF9SRUdJU1RSQVRJT04gPSBnZXR0ZXh0KCdZb3VyIGRldmljZSB3YXMgc3VjY2Vzc2Z1bGx5IHJlZ2lzdGVyZWQuJyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgTk9fQ09OTkVDVElPTiA9IGdldHRleHQoJ1VuYWJsZSB0byByZWFjaCB0aGUgbWljcm9zZXJ2aWNlLicpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY3VzdG9tUHJvdmlkZXJTZXJ2aWNlOiBFeHRlbnNpYmxlRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHJlZ2lzdGVyRGV2aWNlU2VydmljZTogUmVnaXN0ZXJEZXZpY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFJlZjogQnNNb2RhbFJlZlxuICApIHtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc3RlcHMuZm9yRWFjaChzdGVwID0+IHRoaXMuZm9ybXMucHVzaChuZXcgRm9ybUdyb3VwKHt9KSkpO1xuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICB0aGlzLnBlbmRpbmdTdGF0dXMgPSB0cnVlO1xuICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gbnVsbDtcbiAgICBjb25zdCB7IHJlcywgZGF0YSB9ID0gYXdhaXQgdGhpcy5jdXN0b21Qcm92aWRlclNlcnZpY2UucmVnaXN0ZXJEZXZpY2UodGhpcy5jb250ZXh0UGF0aCwgdGhpcy5tb2RlbClcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlczogdW5kZWZpbmVkLFxuICAgICAgICBkYXRhOiB1bmRlZmluZWRcbiAgICAgIH07XG4gICAgfSlcbiAgICAuZmluYWxseSgoKSA9PiB7XG4gICAgICB0aGlzLnBlbmRpbmdTdGF0dXMgPSBmYWxzZTtcbiAgICAgIHRoaXMuc3RlcHBlci5uZXh0KCk7XG4gICAgfSk7XG5cbiAgICBpZiAocmVzICYmIGRhdGEpIHtcbiAgICAgIGlmIChyZXMuc3RhdHVzID49IDQwMCAmJiByZXMuc3RhdHVzIDwgNTAwKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZGF0YS5tZXNzYWdlIHx8IHRoaXMuU0VSVkVSX0VSUk9SKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1cyA+PSA1MDApIHtcbiAgICAgICAgdGhpcy5oYW5kbGVFcnJvcih0aGlzLlNFUlZFUl9FUlJPUik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm1lc3NhZ2UgPSB0aGlzLlNVQ0NFU1NGVUxfUkVHSVNUUkFUSU9OO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKHRoaXMuTk9fQ09OTkVDVElPTik7XG4gICAgfVxuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgdGhpcy5ic01vZGFsUmVmLmhpZGUoKTtcbiAgfVxuXG4gIGNvbXBsZXRlKCkge1xuICAgIHRoaXMucmVnaXN0ZXJEZXZpY2VTZXJ2aWNlLmxpc3QoKTtcbiAgICB0aGlzLmJzTW9kYWxSZWYuaGlkZSgpO1xuICB9XG5cbiAgZ29Ub0ZpcnN0U3RlcCgpIHtcbiAgICB0aGlzLnN0ZXBwZXIuc2VsZWN0ZWRJbmRleCA9IDA7XG4gIH1cblxuICBpc1JlZ2lzdHJhdGlvblN0ZXAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RlcHBlci5zZWxlY3RlZEluZGV4ID09PSB0aGlzLnN0ZXBzLmxlbmd0aCAtIDE7XG4gIH1cblxuICBmaW5hbFN0ZXBTdGF0dXMoKSB7XG4gICAgaWYgKHRoaXMuc3RlcHBlci5zZWxlY3RlZEluZGV4ID09PSB0aGlzLnN0ZXBzLmxlbmd0aCkge1xuICAgICAgaWYgKHRoaXMuZXJyb3JNZXNzYWdlKSB7XG4gICAgICAgIHJldHVybiBTVEVQX1NUQVRFLkVSUk9SO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFNURVBfU1RBVEUuRE9ORTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFNURVBfU1RBVEUuTlVNQkVSO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBtZXNzYWdlO1xuICB9XG59XG4iXX0=