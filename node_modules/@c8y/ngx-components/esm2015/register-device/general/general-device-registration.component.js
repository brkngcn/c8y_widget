import { __decorate } from "tslib";
import { ChangeDetectionStrategy, ChangeDetectorRef, Component } from '@angular/core';
import { TenantUiService, gettext, memoize } from '@c8y/ngx-components';
import { FormGroup } from '@angular/forms';
import { from, Subject, defer } from 'rxjs';
import { filter, shareReplay, switchMap, takeUntil, tap } from 'rxjs/operators';
import { InventoryService, TenantService } from '@c8y/client';
import { RegisterDeviceService } from '../register-device.service';
import { BsModalRef } from 'ngx-bootstrap/modal';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from '../register-device.service';
import * as ɵngcc4 from 'ngx-bootstrap/modal';
import * as ɵngcc5 from '@angular/cdk/stepper';
import * as ɵngcc6 from '@ngx-formly/core';
import * as ɵngcc7 from '@angular/common';

function GeneralDeviceRegistrationComponent_c8y_operation_result_16_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 19);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(1, 3, "Device registered"));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
function GeneralDeviceRegistrationComponent_c8y_operation_result_17_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 20);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(1, 3, "Failed to register device"));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
const _c0 = function (a0) { return { successfulDevicesCount: a0 }; };
function GeneralDeviceRegistrationComponent_ng_container_18_c8y_operation_result_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 19);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r7 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("text", ɵngcc0.ɵɵpipeBind2(1, 3, "{{ successfulDevicesCount }} devices registered", ɵngcc0.ɵɵpureFunction1(6, _c0, ctx_r7.success.length)))("size", 84)("vertical", true);
} }
const _c1 = function (a0) { return { failedDevicesCount: a0 }; };
function GeneralDeviceRegistrationComponent_ng_container_18_c8y_operation_result_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-operation-result", 20);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r8 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("text", ɵngcc0.ɵɵpipeBind2(1, 3, "{{ failedDevicesCount }} devices failed to register", ɵngcc0.ɵɵpureFunction1(6, _c1, ctx_r8.failed.length)))("size", 84)("vertical", true);
} }
function GeneralDeviceRegistrationComponent_ng_container_18_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, GeneralDeviceRegistrationComponent_ng_container_18_c8y_operation_result_1_Template, 2, 8, "c8y-operation-result", 11);
    ɵngcc0.ɵɵtemplate(2, GeneralDeviceRegistrationComponent_ng_container_18_c8y_operation_result_2_Template, 2, 8, "c8y-operation-result", 12);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.failed.length === 0);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.success.length === 0);
} }
const _c2 = function (a0, a1) { return { count: a0, total: a1 }; };
function GeneralDeviceRegistrationComponent_div_19_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 21);
    ɵngcc0.ɵɵelement(1, "c8y-operation-result", 20);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵelementStart(3, "p", 22);
    ɵngcc0.ɵɵdisableBindings();
    ɵngcc0.ɵɵtext(4, " Registration failed for {{ count }} devices out of {{ total }}. ");
    ɵngcc0.ɵɵenableBindings();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(2, 4, "Several devices failed to register"));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction2(6, _c2, ctx_r3.failed.length, ctx_r3.failed.length + ctx_r3.success.length));
} }
function GeneralDeviceRegistrationComponent_div_20_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 23);
    ɵngcc0.ɵɵtext(1, " Turn on the registered device(s) and wait for connection(s) to be established. Once a device is connected, its status will change to \"Pending acceptance\". You will need to approve it by clicking on the \"Accept\" button. ");
    ɵngcc0.ɵɵelementEnd();
} }
function GeneralDeviceRegistrationComponent_c8y_li_22_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-li");
    ɵngcc0.ɵɵelement(1, "c8y-li-icon", 24);
    ɵngcc0.ɵɵelementStart(2, "p");
    ɵngcc0.ɵɵtext(3);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(4, "small");
    ɵngcc0.ɵɵtext(5);
    ɵngcc0.ɵɵpipe(6, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(7, "c8y-li-collapse");
    ɵngcc0.ɵɵelementStart(8, "pre");
    ɵngcc0.ɵɵelementStart(9, "code");
    ɵngcc0.ɵɵtext(10);
    ɵngcc0.ɵɵpipe(11, "json");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const fail_r9 = ctx.$implicit;
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("icon", "ban");
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(fail_r9 == null ? null : fail_r9.id);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(6, 4, fail_r9 == null ? null : fail_r9.message));
    ɵngcc0.ɵɵadvance(5);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(11, 6, fail_r9 == null ? null : fail_r9.details));
} }
function GeneralDeviceRegistrationComponent_c8y_li_23_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-li");
    ɵngcc0.ɵɵelement(1, "c8y-li-icon", 25);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const s_r10 = ctx.$implicit;
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("icon", "check-circle");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", s_r10 == null ? null : s_r10.id, " ");
} }
const _c3 = function () { return { cancel: true, next: true }; };
const _c4 = function (a0) { return { back: a0, custom: true }; };
const _c5 = function () { return { back: "Fix errors", custom: "Close" }; };
export class GeneralDeviceRegistrationComponent {
    constructor(tenantUIService, tenantService, registerDeviceService, inventoryService, cd, bsModalRef) {
        this.tenantUIService = tenantUIService;
        this.tenantService = tenantService;
        this.registerDeviceService = registerDeviceService;
        this.inventoryService = inventoryService;
        this.cd = cd;
        this.bsModalRef = bsModalRef;
        this.MANAGEMENT = 'management';
        this.FILTER = {
            withTotalPages: true,
            pageSize: 25
        };
        this.form = new FormGroup({});
        this.model = {
            devicesToCreate: [{}]
        };
        this.options = {
            formState: {
                canLoadTenants: true,
            }
        };
        this.success = [];
        this.failed = [];
        this.fields = [
            {
                type: 'array',
                key: 'devicesToCreate',
                templateOptions: {
                    addText: gettext('Add device'),
                    addTextDataCy: 'add-device'
                },
                fieldArray: {
                    fieldGroup: [{
                            key: 'id',
                            type: 'string',
                            focus: true,
                            templateOptions: {
                                placeholder: '0123ab32fcd',
                                label: gettext('Device ID'),
                                required: true
                            },
                            validators: {
                                unique: {
                                    expression: (control) => {
                                        const found = control.root.get('devicesToCreate').value.filter(el => el.id === control.value);
                                        return found.length === 0;
                                    },
                                    message: () => gettext('Device ID duplicates are not allowed'),
                                },
                            },
                        },
                        {
                            key: 'tenant',
                            type: 'typeahead',
                            hideExpression: (model, formState, field) => {
                                if (!(formState === null || formState === void 0 ? void 0 : formState.canLoadTenants)) {
                                    field.formControl.setValue(null);
                                }
                                return !(formState === null || formState === void 0 ? void 0 : formState.canLoadTenants) || false;
                            },
                            defaultValue: { id: this.MANAGEMENT },
                            templateOptions: {
                                label: gettext('Add to tenant'),
                                required: true,
                                c8yForOptions: this.canLoadTenants$().pipe(filter(canLoad => canLoad), switchMap(() => this.getTenants$())),
                                container: 'body',
                                displayProperty: 'id',
                                valueProperties: ['id']
                            },
                            hooks: {
                                onInit: field => this.canLoadTenants$().pipe(tap(canLoad => {
                                    this.options.formState.canLoadTenants = canLoad;
                                    this.cd.detectChanges();
                                }))
                            }
                        },
                        {
                            key: 'group',
                            type: 'typeahead',
                            expressionProperties: {
                                'templateOptions.disabled': (model, formState, field) => {
                                    var _a, _b, _c;
                                    if (formState === null || formState === void 0 ? void 0 : formState.canLoadTenants) {
                                        if (((_a = model === null || model === void 0 ? void 0 : model.tenant) === null || _a === void 0 ? void 0 : _a.id) !== this.MANAGEMENT) {
                                            field.formControl.setValue(null);
                                        }
                                        return !(((_b = model === null || model === void 0 ? void 0 : model.tenant) === null || _b === void 0 ? void 0 : _b.id) === this.MANAGEMENT);
                                    }
                                    (_c = field === null || field === void 0 ? void 0 : field.templateOptions) === null || _c === void 0 ? true : delete _c.description;
                                    return false;
                                }
                            },
                            templateOptions: {
                                disabled: false,
                                label: gettext('Add to group'),
                                description: gettext('You can add device to specific group for management tenant only.'),
                                container: 'body',
                                displayProperty: 'name',
                                valueProperties: ['id'],
                                c8yForOptions: this.getGroups$()
                            },
                            hooks: {
                                onInit: field => this.canLoadTenants$().pipe(tap(canLoad => {
                                    this.options.formState.canLoadTenants = canLoad;
                                    this.cd.detectChanges();
                                }))
                            }
                        }]
                }
            }
        ];
        this.destroy$ = new Subject();
        this.lastCreatedDevices = [];
        this.isLoading$ = this.registerDeviceService.loading$;
    }
    ngAfterViewInit() {
        this.cd.detectChanges();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    create(eventObject) {
        var _a, _b;
        if (((_b = (_a = this.model) === null || _a === void 0 ? void 0 : _a.devicesToCreate) === null || _b === void 0 ? void 0 : _b.length) > 0) {
            this.lastCreatedDevices = [...this.model.devicesToCreate];
            const dataToSend = this.model.devicesToCreate.map((el) => {
                const { id, tenant, group } = el;
                let data = { id };
                if (tenant === null || tenant === void 0 ? void 0 : tenant.id) {
                    data = Object.assign(Object.assign({}, data), { tenantId: tenant.id });
                }
                if (group === null || group === void 0 ? void 0 : group.id) {
                    data = Object.assign(Object.assign({}, data), { groupId: group.id });
                }
                return data;
            });
            this.registerDeviceService.createMultiple(dataToSend)
                .pipe(takeUntil(this.destroy$))
                .subscribe(requests => {
                this.success = requests.success;
                this.failed = requests.failed;
                if (eventObject) {
                    eventObject.stepper.next();
                }
            });
        }
    }
    fixErrors(event, failedRequests) {
        if (failedRequests && failedRequests.length > 0) {
            this.options.resetModel({ devicesToCreate: [...this.lastCreatedDevices.filter(el => failedRequests.map(data => data.id).includes(el.id))] });
            this.cd.detectChanges();
        }
        event === null || event === void 0 ? void 0 : event.stepper.previous();
    }
    canLoadTenants$() {
        return defer(() => from(this.tenantUIService.isManagementTenant())).pipe(shareReplay(1));
    }
    getTenants$() {
        return defer(() => from(this.tenantService.list(this.FILTER))).pipe(shareReplay(1));
    }
    getGroups$() {
        return defer(() => from(this.inventoryService.listQuery({ __filter: { __has: 'c8y_IsDeviceGroup' }, __orderby: [{ name: 1 }] }, Object.assign({}, this.FILTER)))).pipe(shareReplay(1));
    }
}
GeneralDeviceRegistrationComponent.ɵfac = function GeneralDeviceRegistrationComponent_Factory(t) { return new (t || GeneralDeviceRegistrationComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.TenantUiService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.TenantService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.RegisterDeviceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.InventoryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.BsModalRef)); };
GeneralDeviceRegistrationComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: GeneralDeviceRegistrationComponent, selectors: [["c8y-general-device-registration"]], decls: 25, vars: 30, consts: [[3, "headerClasses", "customFooter"], ["c8y-modal-title", ""], [3, "c8yIcon"], ["linear", "", 3, "hideStepProgress"], [3, "stepControl"], [1, "p-b-16"], ["translate", "", 1, "p-l-24", "p-r-24", "p-t-16", "p-b-16", "m-b-0", "sticky-top", "separator-bottom", "text-medium", "text-16", "text-center", "bg-component"], [1, "formly-group-array-cols", "d-block", "p-24", "min-height-fit", 3, "form", "fields", "model", "options"], [1, "sticky-bottom", "d-block", "p-t-16", "p-b-16", "separator-top", "bg-white", 3, "showButtons", "disabled", "pending", "onNext", "onCancel"], ["state", "final"], [1, "p-24", "min-height-fit"], ["type", "success", "class", "lead", 3, "text", "size", "vertical", 4, "ngIf"], ["type", "error", "class", "lead", 3, "text", "size", "vertical", 4, "ngIf"], [4, "ngIf"], ["class", "p-l-24 p-r-24 text-center", 4, "ngIf"], ["class", "m-b-8 p-l-24 p-r-24", "translate", "", 4, "ngIf"], [1, "separator-top", "m-t-16"], [4, "ngFor", "ngForOf"], [1, "sticky-bottom", "d-block", "p-t-16", "p-b-16", "separator-top", "bg-white", 3, "showButtons", "labels", "onCustom", "onBack"], ["type", "success", 1, "lead", 3, "text", "size", "vertical"], ["type", "error", 1, "lead", 3, "text", "size", "vertical"], [1, "p-l-24", "p-r-24", "text-center"], ["translate", "", 1, "p-b-16", "text-danger", 3, "translateParams"], ["translate", "", 1, "m-b-8", "p-l-24", "p-r-24"], [1, "text-danger", 3, "icon"], [1, "text-success", 3, "icon"]], template: function GeneralDeviceRegistrationComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-modal", 0);
        ɵngcc0.ɵɵelementContainerStart(1, 1);
        ɵngcc0.ɵɵelement(2, "span", 2);
        ɵngcc0.ɵɵelementStart(3, "h4");
        ɵngcc0.ɵɵtext(4);
        ɵngcc0.ɵɵpipe(5, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementContainerEnd();
        ɵngcc0.ɵɵelementStart(6, "c8y-stepper", 3);
        ɵngcc0.ɵɵelementStart(7, "cdk-step", 4);
        ɵngcc0.ɵɵelementStart(8, "div", 5);
        ɵngcc0.ɵɵelementStart(9, "p", 6);
        ɵngcc0.ɵɵtext(10, " Register a general device ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelement(11, "formly-form", 7);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(12, "c8y-stepper-buttons", 8);
        ɵngcc0.ɵɵlistener("onNext", function GeneralDeviceRegistrationComponent_Template_c8y_stepper_buttons_onNext_12_listener($event) { return ctx.create($event); })("onCancel", function GeneralDeviceRegistrationComponent_Template_c8y_stepper_buttons_onCancel_12_listener() { return ctx.bsModalRef.hide(); });
        ɵngcc0.ɵɵpipe(13, "async");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(14, "cdk-step", 9);
        ɵngcc0.ɵɵelementStart(15, "div", 10);
        ɵngcc0.ɵɵtemplate(16, GeneralDeviceRegistrationComponent_c8y_operation_result_16_Template, 2, 5, "c8y-operation-result", 11);
        ɵngcc0.ɵɵtemplate(17, GeneralDeviceRegistrationComponent_c8y_operation_result_17_Template, 2, 5, "c8y-operation-result", 12);
        ɵngcc0.ɵɵtemplate(18, GeneralDeviceRegistrationComponent_ng_container_18_Template, 3, 2, "ng-container", 13);
        ɵngcc0.ɵɵtemplate(19, GeneralDeviceRegistrationComponent_div_19_Template, 5, 9, "div", 14);
        ɵngcc0.ɵɵtemplate(20, GeneralDeviceRegistrationComponent_div_20_Template, 2, 0, "div", 15);
        ɵngcc0.ɵɵelementStart(21, "c8y-list-group", 16);
        ɵngcc0.ɵɵtemplate(22, GeneralDeviceRegistrationComponent_c8y_li_22_Template, 12, 8, "c8y-li", 17);
        ɵngcc0.ɵɵtemplate(23, GeneralDeviceRegistrationComponent_c8y_li_23_Template, 3, 2, "c8y-li", 17);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(24, "c8y-stepper-buttons", 18);
        ɵngcc0.ɵɵlistener("onCustom", function GeneralDeviceRegistrationComponent_Template_c8y_stepper_buttons_onCustom_24_listener() { return ctx.bsModalRef.hide(); })("onBack", function GeneralDeviceRegistrationComponent_Template_c8y_stepper_buttons_onBack_24_listener($event) { return ctx.fixErrors($event, ctx.failed); });
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("headerClasses", "dialog-header")("customFooter", true);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("c8yIcon", "c8y-device-connect");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(5, 22, "Register devices"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("hideStepProgress", true);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("stepControl", ctx.form);
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("form", ctx.form)("fields", ctx.fields)("model", ctx.model)("options", ctx.options);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("showButtons", ɵngcc0.ɵɵpureFunction0(26, _c3))("disabled", !(ctx.form == null ? null : ctx.form.valid))("pending", ɵngcc0.ɵɵpipeBind1(13, 24, ctx.isLoading$));
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("ngIf", ctx.success.length === 1 && ctx.failed.length === 0);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.success.length === 0 && ctx.failed.length === 1);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.success.length > 1 || ctx.failed.length > 1);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.success.length > 0 && ctx.failed.length > 0);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.success.length > 0);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngForOf", ctx.failed);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngForOf", ctx.success);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("showButtons", ɵngcc0.ɵɵpureFunction1(27, _c4, ctx.failed.length > 0))("labels", ɵngcc0.ɵɵpureFunction0(29, _c5));
    } }, directives: [ɵngcc1.ModalComponent, ɵngcc1.IconDirective, ɵngcc1.C8yStepper, ɵngcc5.CdkStep, ɵngcc1.C8yTranslateDirective, ɵngcc6.FormlyForm, ɵngcc1.C8yStepperButtons, ɵngcc7.NgIf, ɵngcc1.ListGroupComponent, ɵngcc7.NgForOf, ɵngcc1.OperationResultComponent, ɵngcc1.ListItemComponent, ɵngcc1.ListItemIconComponent, ɵngcc1.ListItemCollapseComponent], pipes: [ɵngcc1.C8yTranslatePipe, ɵngcc7.AsyncPipe, ɵngcc7.JsonPipe], encapsulation: 2, changeDetection: 0 });
GeneralDeviceRegistrationComponent.ctorParameters = () => [
    { type: TenantUiService },
    { type: TenantService },
    { type: RegisterDeviceService },
    { type: InventoryService },
    { type: ChangeDetectorRef },
    { type: BsModalRef }
];
__decorate([
    memoize()
], GeneralDeviceRegistrationComponent.prototype, "canLoadTenants$", null);
__decorate([
    memoize()
], GeneralDeviceRegistrationComponent.prototype, "getTenants$", null);
__decorate([
    memoize()
], GeneralDeviceRegistrationComponent.prototype, "getGroups$", null);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(GeneralDeviceRegistrationComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-general-device-registration',
                template: "<c8y-modal [headerClasses]=\"'dialog-header'\" [customFooter]=\"true\">\n  <ng-container c8y-modal-title>\n    <span [c8yIcon]=\"'c8y-device-connect'\"></span>\n    <h4>{{ 'Register devices' | translate }}</h4>\n  </ng-container>\n  <c8y-stepper [hideStepProgress]=\"true\" linear>\n    <cdk-step [stepControl]=\"form\">\n      <div class=\"p-b-16\">\n        <p\n          class=\"\n            p-l-24 p-r-24 p-t-16 p-b-16\n            m-b-0\n            sticky-top\n            separator-bottom\n            text-medium text-16 text-center\n            bg-component\n          \"\n          translate\n        >\n          Register a general device\n        </p>\n        <formly-form\n          [form]=\"form\"\n          [fields]=\"fields\"\n          [model]=\"model\"\n          [options]=\"options\"\n          class=\"formly-group-array-cols d-block p-24 min-height-fit\"\n        ></formly-form>\n      </div>\n      <c8y-stepper-buttons\n        (onNext)=\"create($event)\"\n        (onCancel)=\"bsModalRef.hide()\"\n        [showButtons]=\"{ cancel: true, next: true }\"\n        [disabled]=\"!form?.valid\"\n        [pending]=\"isLoading$ | async\"\n        class=\"sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n    <cdk-step state=\"final\">\n      <div class=\"p-24 min-height-fit\">\n        <c8y-operation-result\n          *ngIf=\"success.length === 1 && failed.length === 0\"\n          text=\"{{ 'Device registered' | translate }}\"\n          [size]=\"84\"\n          [vertical]=\"true\"\n          type=\"success\"\n          class=\"lead\"\n        ></c8y-operation-result>\n        <c8y-operation-result\n          *ngIf=\"success.length === 0 && failed.length === 1\"\n          text=\"{{ 'Failed to register device' | translate }}\"\n          [size]=\"84\"\n          [vertical]=\"true\"\n          type=\"error\"\n          class=\"lead\"\n        ></c8y-operation-result>\n\n        <ng-container *ngIf=\"success.length > 1 || failed.length > 1\">\n          <c8y-operation-result\n            *ngIf=\"failed.length === 0\"\n            [text]=\"\n              '{{ successfulDevicesCount }} devices registered'\n                | translate: { successfulDevicesCount: success.length }\n            \"\n            [size]=\"84\"\n            [vertical]=\"true\"\n            type=\"success\"\n            class=\"lead\"\n          ></c8y-operation-result>\n          <c8y-operation-result\n            *ngIf=\"success.length === 0\"\n            [text]=\"\n              '{{ failedDevicesCount }} devices failed to register'\n                | translate: { failedDevicesCount: failed.length }\n            \"\n            [size]=\"84\"\n            [vertical]=\"true\"\n            type=\"error\"\n            class=\"lead\"\n          ></c8y-operation-result>\n        </ng-container>\n\n        <div *ngIf=\"success.length > 0 && failed.length > 0\" class=\"p-l-24 p-r-24 text-center\">\n          <c8y-operation-result\n            text=\"{{ 'Several devices failed to register' | translate }}\"\n            [size]=\"84\"\n            [vertical]=\"true\"\n            type=\"error\"\n            class=\"lead\"\n          ></c8y-operation-result>\n          <p\n            ngNonBindable\n            translate\n            [translateParams]=\"{ count: failed.length, total: failed.length + success.length }\"\n            class=\"p-b-16 text-danger\"\n          >\n            Registration failed for {{ count }} devices out of {{ total }}.\n          </p>\n        </div>\n\n        <div class=\"m-b-8 p-l-24 p-r-24\" *ngIf=\"success.length > 0\" translate>\n          Turn on the registered device(s) and wait for connection(s) to be established. Once a\n          device is connected, its status will change to \"Pending acceptance\". You will need to\n          approve it by clicking on the \"Accept\" button.\n        </div>\n\n        <c8y-list-group class=\"separator-top m-t-16\">\n          <c8y-li *ngFor=\"let fail of failed\">\n            <c8y-li-icon class=\"text-danger\" [icon]=\"'ban'\"></c8y-li-icon>\n            <p>{{ fail?.id }}</p>\n            <small>{{ fail?.message | translate }}</small>\n            <c8y-li-collapse>\n              <pre><code>{{ fail?.details | json }}</code></pre>\n            </c8y-li-collapse>\n          </c8y-li>\n\n          <c8y-li *ngFor=\"let s of success\">\n            <c8y-li-icon class=\"text-success\" [icon]=\"'check-circle'\"></c8y-li-icon>\n            {{ s?.id }}\n          </c8y-li>\n        </c8y-list-group>\n      </div>\n      <c8y-stepper-buttons\n        class=\"sticky-bottom d-block p-t-16 p-b-16 separator-top bg-white\"\n        (onCustom)=\"bsModalRef.hide()\"\n        (onBack)=\"fixErrors($event, failed)\"\n        [showButtons]=\"{ back: failed.length > 0, custom: true }\"\n        [labels]=\"{ back: 'Fix errors', custom: 'Close' }\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n  </c8y-stepper>\n</c8y-modal>\n",
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: ɵngcc1.TenantUiService }, { type: ɵngcc2.TenantService }, { type: ɵngcc3.RegisterDeviceService }, { type: ɵngcc2.InventoryService }, { type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc4.BsModalRef }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbC1kZXZpY2UtcmVnaXN0cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcmVnaXN0ZXItZGV2aWNlL2dlbmVyYWwvZ2VuZXJhbC1kZXZpY2UtcmVnaXN0cmF0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFpQix1QkFBdUIsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFFaEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEYsT0FBTyxFQUFlLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxJQUFJLEVBQWMsT0FBTyxFQUFFLEtBQUssRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN2RCxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBdUMsZ0JBQWdCLEVBQXdCLGFBQWEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN6SCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVuRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFhakQsTUFBTSxPQUFPLGtDQUFrQztBQUFHLElBZ0hoRCxZQUNVLGVBQWdDLEVBQ2hDLGFBQTRCLEVBQzVCLHFCQUE0QyxFQUM1QyxnQkFBa0MsRUFDbEMsRUFBcUIsRUFDdEIsVUFBc0I7QUFDOUIsUUFOUyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7QUFB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QUM7QUFDSDs4REF6TUMsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSxpQ0FBaUMsa0JBQzNDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztPQUF5RCxrQkFDekQ7V0FBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07SUFDaEQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7a2RBQ0k7QUFBQztBQUE0RCxZQXBCekQsZUFBZTtBQUFJLFlBSTBELGFBQWE7QUFBSSxZQUM5RixxQkFBcUI7QUFBSSxZQURZLGdCQUFnQjtBQUFJLFlBTmpCLGlCQUFpQjtBQUFJLFlBUzdELFVBQVU7QUFBRztBQTBMcEI7QUFBYSxJQURaLE9BQU8sRUFBRTtBQUNaLHlFQUdHO0FBR0Q7QUFBYSxJQURaLE9BQU8sRUFBRTtBQUNaLHFFQUlHO0FBR0Q7QUFBYSxJQURaLE9BQU8sRUFBRTtBQUNaLG9FQVNHOzs7Ozs7Ozs0UEFDSDtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zIH0gZnJvbSAnQG5neC1mb3JtbHkvY29yZSc7XG5pbXBvcnQgeyBUZW5hbnRVaVNlcnZpY2UsIGdldHRleHQsIEM4eVN0ZXBwZXIsIG1lbW9pemUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEZvcm1Db250cm9sLCBGb3JtR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlLCBTdWJqZWN0LCBkZWZlcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJRGV2aWNlUmVnaXN0cmF0aW9uLCBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSwgSVJlc3VsdExpc3QsIElUZW5hbnQsIFRlbmFudFNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBSZWdpc3RlckRldmljZVNlcnZpY2UgfSBmcm9tICcuLi9yZWdpc3Rlci1kZXZpY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBDZGtTdGVwIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3N0ZXBwZXInO1xuaW1wb3J0IHsgQnNNb2RhbFJlZiB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuXG5pbnRlcmZhY2UgR2VuZXJhbERldmljZVJlZ2lzdHJhdGlvbk1vZGVsVHlwZSB7XG4gIGlkOiBzdHJpbmc7XG4gIHRlbmFudD86IHtpZDogc3RyaW5nfTtcbiAgZ3JvdXA/OiB7aWQ6IHN0cmluZywgbmFtZT86IHN0cmluZ307XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1nZW5lcmFsLWRldmljZS1yZWdpc3RyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJ2dlbmVyYWwtZGV2aWNlLXJlZ2lzdHJhdGlvbi5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIEdlbmVyYWxEZXZpY2VSZWdpc3RyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICByZWFkb25seSBNQU5BR0VNRU5UID0gJ21hbmFnZW1lbnQnO1xuICByZWFkb25seSBGSUxURVI6IG9iamVjdCA9IHtcbiAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICBwYWdlU2l6ZTogMjVcbiAgfTtcblxuICBmb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gIG1vZGVsID0ge1xuICAgIGRldmljZXNUb0NyZWF0ZTogW3t9IGFzIEdlbmVyYWxEZXZpY2VSZWdpc3RyYXRpb25Nb2RlbFR5cGVdXG4gIH07XG4gIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zID0ge1xuICAgIGZvcm1TdGF0ZToge1xuICAgICAgY2FuTG9hZFRlbmFudHM6IHRydWUsXG4gICAgfVxuICB9O1xuXG4gIGlzTG9hZGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHN1Y2Nlc3M6IElEZXZpY2VSZWdpc3RyYXRpb25bXSA9IFtdO1xuICBmYWlsZWQ6IElEZXZpY2VSZWdpc3RyYXRpb25bXSA9IFtdO1xuXG4gIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtcbiAgICB7XG4gICAgICB0eXBlOiAnYXJyYXknLFxuICAgICAga2V5OiAnZGV2aWNlc1RvQ3JlYXRlJyxcbiAgICAgIHRlbXBsYXRlT3B0aW9uczoge1xuICAgICAgICBhZGRUZXh0OiBnZXR0ZXh0KCdBZGQgZGV2aWNlJyksXG4gICAgICAgIGFkZFRleHREYXRhQ3k6ICdhZGQtZGV2aWNlJ1xuICAgICAgfSxcbiAgICAgIGZpZWxkQXJyYXk6IHtcbiAgICAgICAgZmllbGRHcm91cDogW3tcbiAgICAgICAgICBrZXk6ICdpZCcsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgZm9jdXM6IHRydWUsXG4gICAgICAgICAgdGVtcGxhdGVPcHRpb25zOiB7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogJzAxMjNhYjMyZmNkJyxcbiAgICAgICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdEZXZpY2UgSUQnKSxcbiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgICAgICAgfSxcbiAgICAgICAgICB2YWxpZGF0b3JzOiB7XG4gICAgICAgICAgICB1bmlxdWU6IHtcbiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogKGNvbnRyb2w6IEZvcm1Db250cm9sKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSAoY29udHJvbC5yb290LmdldCgnZGV2aWNlc1RvQ3JlYXRlJykudmFsdWUgYXMgQXJyYXk8e2lkOiBzdHJpbmd9PikuZmlsdGVyKGVsID0+IGVsLmlkID09PSBjb250cm9sLnZhbHVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmQubGVuZ3RoID09PSAwO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBtZXNzYWdlOiAoKSA9PiBnZXR0ZXh0KCdEZXZpY2UgSUQgZHVwbGljYXRlcyBhcmUgbm90IGFsbG93ZWQnKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ3RlbmFudCcsXG4gICAgICAgICAgdHlwZTogJ3R5cGVhaGVhZCcsXG4gICAgICAgICAgaGlkZUV4cHJlc3Npb246IChtb2RlbDogYW55LCBmb3JtU3RhdGU6IGFueSwgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWZvcm1TdGF0ZT8uY2FuTG9hZFRlbmFudHMpIHtcbiAgICAgICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wuc2V0VmFsdWUobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gIWZvcm1TdGF0ZT8uY2FuTG9hZFRlbmFudHMgfHwgZmFsc2U7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBkZWZhdWx0VmFsdWU6IHtpZDogdGhpcy5NQU5BR0VNRU5UfSxcbiAgICAgICAgICB0ZW1wbGF0ZU9wdGlvbnM6IHtcbiAgICAgICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdBZGQgdG8gdGVuYW50JyksXG4gICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgIGM4eUZvck9wdGlvbnM6IHRoaXMuY2FuTG9hZFRlbmFudHMkKCkucGlwZShmaWx0ZXIoY2FuTG9hZCA9PiBjYW5Mb2FkKSwgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0VGVuYW50cyQoKSkpIGFzIE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SVRlbmFudD4+LFxuICAgICAgICAgICAgY29udGFpbmVyOiAnYm9keScsXG4gICAgICAgICAgICBkaXNwbGF5UHJvcGVydHk6ICdpZCcsXG4gICAgICAgICAgICB2YWx1ZVByb3BlcnRpZXM6IFsnaWQnXVxuICAgICAgICAgIH0sXG4gICAgICAgICAgaG9va3M6IHtcbiAgICAgICAgICAgIG9uSW5pdDogZmllbGQgPT4gdGhpcy5jYW5Mb2FkVGVuYW50cyQoKS5waXBlKHRhcChjYW5Mb2FkID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmZvcm1TdGF0ZS5jYW5Mb2FkVGVuYW50cyA9IGNhbkxvYWQ7XG4gICAgICAgICAgICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICAgICAgfSkpXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAga2V5OiAnZ3JvdXAnLFxuICAgICAgICAgIHR5cGU6ICd0eXBlYWhlYWQnLFxuICAgICAgICAgIGV4cHJlc3Npb25Qcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAndGVtcGxhdGVPcHRpb25zLmRpc2FibGVkJzogKG1vZGVsOiBhbnksIGZvcm1TdGF0ZTogYW55LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGZvcm1TdGF0ZT8uY2FuTG9hZFRlbmFudHMpIHtcbiAgICAgICAgICAgICAgICBpZiAobW9kZWw/LnRlbmFudD8uaWQgIT09IHRoaXMuTUFOQUdFTUVOVCkge1xuICAgICAgICAgICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wuc2V0VmFsdWUobnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiAhKG1vZGVsPy50ZW5hbnQ/LmlkID09PSB0aGlzLk1BTkFHRU1FTlQpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGRlbGV0ZSBmaWVsZD8udGVtcGxhdGVPcHRpb25zPy5kZXNjcmlwdGlvbjtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGVtcGxhdGVPcHRpb25zOiB7XG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBsYWJlbDogZ2V0dGV4dCgnQWRkIHRvIGdyb3VwJyksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogZ2V0dGV4dCgnWW91IGNhbiBhZGQgZGV2aWNlIHRvIHNwZWNpZmljIGdyb3VwIGZvciBtYW5hZ2VtZW50IHRlbmFudCBvbmx5LicpLFxuICAgICAgICAgICAgY29udGFpbmVyOiAnYm9keScsXG4gICAgICAgICAgICBkaXNwbGF5UHJvcGVydHk6ICduYW1lJyxcbiAgICAgICAgICAgIHZhbHVlUHJvcGVydGllczogWydpZCddLFxuICAgICAgICAgICAgYzh5Rm9yT3B0aW9uczogdGhpcy5nZXRHcm91cHMkKClcbiAgICAgICAgICB9LFxuICAgICAgICAgIGhvb2tzOiB7XG4gICAgICAgICAgICBvbkluaXQ6IGZpZWxkID0+IHRoaXMuY2FuTG9hZFRlbmFudHMkKCkucGlwZSh0YXAoY2FuTG9hZCA9PiB7XG4gICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5mb3JtU3RhdGUuY2FuTG9hZFRlbmFudHMgPSBjYW5Mb2FkO1xuICAgICAgICAgICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgIH1cbiAgICAgICAgfV1cbiAgICAgIH1cbiAgICB9XG4gIF07XG5cbiAgcHJpdmF0ZSBkZXN0cm95JDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBsYXN0Q3JlYXRlZERldmljZXM6IEdlbmVyYWxEZXZpY2VSZWdpc3RyYXRpb25Nb2RlbFR5cGVbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdGVuYW50VUlTZXJ2aWNlOiBUZW5hbnRVaVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRTZXJ2aWNlOiBUZW5hbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVnaXN0ZXJEZXZpY2VTZXJ2aWNlOiBSZWdpc3RlckRldmljZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHB1YmxpYyBic01vZGFsUmVmOiBCc01vZGFsUmVmXG4gICkge1xuICAgIHRoaXMuaXNMb2FkaW5nJCA9IHRoaXMucmVnaXN0ZXJEZXZpY2VTZXJ2aWNlLmxvYWRpbmckO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgY3JlYXRlKGV2ZW50T2JqZWN0OiB7c3RlcHBlcjogQzh5U3RlcHBlciwgc3RlcDogQ2RrU3RlcH0pIHtcbiAgICBpZiAodGhpcy5tb2RlbD8uZGV2aWNlc1RvQ3JlYXRlPy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmxhc3RDcmVhdGVkRGV2aWNlcyA9IFsuLi50aGlzLm1vZGVsLmRldmljZXNUb0NyZWF0ZV07XG5cbiAgICAgIGNvbnN0IGRhdGFUb1NlbmQgPSB0aGlzLm1vZGVsLmRldmljZXNUb0NyZWF0ZS5tYXAoKGVsOiBHZW5lcmFsRGV2aWNlUmVnaXN0cmF0aW9uTW9kZWxUeXBlKSA9PiB7XG4gICAgICAgIGNvbnN0IHtpZCwgdGVuYW50LCBncm91cH0gPSBlbDtcbiAgICAgICAgbGV0IGRhdGE6IHtpZDogc3RyaW5nLCB0ZW5hbnRJZD86IHN0cmluZywgZ3JvdXBJZD86IHN0cmluZ30gPSB7IGlkIH07XG5cbiAgICAgICAgaWYgKHRlbmFudD8uaWQpIHtcbiAgICAgICAgICBkYXRhID0geyAuLi5kYXRhLCB0ZW5hbnRJZDogdGVuYW50LmlkIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZ3JvdXA/LmlkKSB7XG4gICAgICAgICAgZGF0YSA9IHsgLi4uZGF0YSwgZ3JvdXBJZDogZ3JvdXAuaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMucmVnaXN0ZXJEZXZpY2VTZXJ2aWNlLmNyZWF0ZU11bHRpcGxlKGRhdGFUb1NlbmQpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAuc3Vic2NyaWJlKHJlcXVlc3RzID0+IHtcbiAgICAgICAgdGhpcy5zdWNjZXNzID0gcmVxdWVzdHMuc3VjY2VzcztcbiAgICAgICAgdGhpcy5mYWlsZWQgPSByZXF1ZXN0cy5mYWlsZWQ7XG5cbiAgICAgICAgaWYgKGV2ZW50T2JqZWN0KSB7XG4gICAgICAgICAgZXZlbnRPYmplY3Quc3RlcHBlci5uZXh0KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGZpeEVycm9ycyhldmVudDoge3N0ZXBwZXI6IEM4eVN0ZXBwZXIsIHN0ZXA6IENka1N0ZXB9LCBmYWlsZWRSZXF1ZXN0czogSURldmljZVJlZ2lzdHJhdGlvbltdKSB7XG4gICAgaWYgKGZhaWxlZFJlcXVlc3RzICYmIGZhaWxlZFJlcXVlc3RzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMub3B0aW9ucy5yZXNldE1vZGVsKHtkZXZpY2VzVG9DcmVhdGU6IFsuLi50aGlzLmxhc3RDcmVhdGVkRGV2aWNlcy5maWx0ZXIoZWwgPT4gZmFpbGVkUmVxdWVzdHMubWFwKGRhdGEgPT4gZGF0YS5pZCkuaW5jbHVkZXMoZWwuaWQpKV19KTtcbiAgICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgICBldmVudD8uc3RlcHBlci5wcmV2aW91cygpO1xuICB9XG5cbiAgQG1lbW9pemUoKVxuICBwcml2YXRlIGNhbkxvYWRUZW5hbnRzJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gZGVmZXIoKCkgPT5cbiAgICAgIGZyb20odGhpcy50ZW5hbnRVSVNlcnZpY2UuaXNNYW5hZ2VtZW50VGVuYW50KCkpKS5waXBlKHNoYXJlUmVwbGF5KDEpKTtcbiAgfVxuXG4gIEBtZW1vaXplKClcbiAgcHJpdmF0ZSBnZXRUZW5hbnRzJCgpOiBPYnNlcnZhYmxlPElSZXN1bHRMaXN0PElUZW5hbnQ+PiB7XG4gICAgcmV0dXJuIGRlZmVyKFxuICAgICAgKCkgPT4gZnJvbSh0aGlzLnRlbmFudFNlcnZpY2UubGlzdCh0aGlzLkZJTFRFUikpXG4gICAgKS5waXBlKHNoYXJlUmVwbGF5KDEpKTtcbiAgfVxuXG4gIEBtZW1vaXplKClcbiAgcHJpdmF0ZSBnZXRHcm91cHMkKCk6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgcmV0dXJuIGRlZmVyKCgpID0+XG4gICAgICBmcm9tKFxuICAgICAgICB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KFxuICAgICAgICAgIHsgX19maWx0ZXI6IHsgX19oYXM6ICdjOHlfSXNEZXZpY2VHcm91cCcgfSwgX19vcmRlcmJ5OiBbeyBuYW1lOiAxIH1dIH0sXG4gICAgICAgICAgeyAuLi50aGlzLkZJTFRFUiB9XG4gICAgICAgIClcbiAgICAgIClcbiAgICApLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICB9XG59XG4iXX0=