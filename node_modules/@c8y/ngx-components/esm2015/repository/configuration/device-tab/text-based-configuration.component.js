import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryService, OperationStatus } from '@c8y/client';
import { AlertService, gettext } from '@c8y/ngx-components';
import { DeviceConfigurationOperation, RepositoryService } from '@c8y/ngx-components/repository/shared';
import { DeviceConfigurationService } from './device-configuration.service';
export class TextBasedConfigurationComponent {
    constructor(route, alertService, repositoryService, deviceConfigurationService, inventoryService) {
        this.route = route;
        this.alertService = alertService;
        this.repositoryService = repositoryService;
        this.deviceConfigurationService = deviceConfigurationService;
        this.inventoryService = inventoryService;
        this.reloadingConfig = false;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.load();
        });
    }
    load() {
        return __awaiter(this, void 0, void 0, function* () {
            this.device = this.route.snapshot.parent.data.contextData;
            yield this.loadDevice();
            yield this.loadOperation();
            this.showTextBasedConfigReload = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.SEND_CONFIG]);
            this.showTextBasedConfigSave = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG]);
            if (this.device.c8y_Configuration && this.device.c8y_Configuration.config) {
                this.config = this.device.c8y_Configuration.config;
            }
        });
    }
    loadOperation() {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = yield this.repositoryService.getLastConfigUpdateOperation(this.device.id);
            if (operation !== null) {
                this.reloadingConfig =
                    !!operation.c8y_SendConfiguration &&
                        (operation.status === OperationStatus.PENDING ||
                            operation.status === OperationStatus.EXECUTING);
                this.repositoryService.observeOperation(operation).subscribe((operationUpdate) => {
                    this.latestOperation = operationUpdate;
                });
            }
        });
    }
    get savingConfig() {
        return this.latestOperation
            ? !!this.latestOperation.c8y_Configuration &&
                (this.latestOperation.status === OperationStatus.PENDING ||
                    this.latestOperation.status === OperationStatus.EXECUTING)
            : false;
    }
    reloadConfiguration() {
        return __awaiter(this, void 0, void 0, function* () {
            this.reloadingConfig = true;
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationReloadOperation(this.device);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationReloadSuccess(operationUpdate), operationUpdate => this.onOperationReloadError(operationUpdate), () => this.onOperationReloadComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    updateConfiguration(config) {
        return __awaiter(this, void 0, void 0, function* () {
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationUpdateOperation(this.device, config);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationUpdateSuccess(operationUpdate), operationUpdate => this.onOperationUpdateError(operationUpdate), () => this.onOperationUpdateComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    onOperationReloadSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be reloaded.'));
        }
    }
    onOperationReloadError(operationUpdate) {
        this.latestOperation = operationUpdate;
        this.reloadingConfig = false;
    }
    onOperationReloadComplete() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadDevice();
            this.config = this.device.c8y_Configuration.config;
            this.reloadingConfig = false;
        });
    }
    onOperationUpdateSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be updated.'));
        }
    }
    onOperationUpdateError(operationUpdate) {
        this.latestOperation = operationUpdate;
    }
    onOperationUpdateComplete() {
        this.device.c8y_Configuration.config = this.config;
    }
    loadDevice() {
        return __awaiter(this, void 0, void 0, function* () {
            this.device = (yield this.inventoryService.detail(this.device.id, {
                withChildren: false
            })).data;
        });
    }
}
TextBasedConfigurationComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-text-based-configuration',
                template: "<div class=\"d-flex d-col fit-h\">\n  <fieldset class=\"card-block bg-gray-white fit-w\">\n    <div class=\"content-flex-50\">\n      <div class=\"flex-item-left d-flex\">\n        <button\n          title=\"{{ 'Get configuration from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm flex-item-v-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'icon-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get configuration from device' | translate }}\n        </button>\n      </div>\n      <c8y-operation-details\n        *ngIf=\"latestOperation !== undefined\"\n        [operation]=\"latestOperation\"\n        class=\"flex-grow\"\n      ></c8y-operation-details>\n    </div>\n  </fieldset>\n  <div class=\"flex-grow\">\n    <textarea\n      [(ngModel)]=\"config\"\n      class=\"form-control fit-h p-r-16 p-l-16\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-w separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      id=\"send-config-btn\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig || !config\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending\u2026' | translate }}\" *ngIf=\"savingConfig\">\n        {{ 'Sending\u2026' | translate }}\n      </span>\n    </button>\n  </div>\n</div>\n"
            },] }
];
TextBasedConfigurationComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: AlertService },
    { type: RepositoryService },
    { type: DeviceConfigurationService },
    { type: InventoryService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvY29uZmlndXJhdGlvbi9kZXZpY2UtdGFiL3RleHQtYmFzZWQtY29uZmlndXJhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFBa0IsZ0JBQWdCLEVBQWMsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDeEcsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFNNUUsTUFBTSxPQUFPLCtCQUErQjtJQVExQyxZQUNVLEtBQXFCLEVBQ3JCLFlBQTBCLEVBQzFCLGlCQUFvQyxFQUNwQywwQkFBc0QsRUFDdEQsZ0JBQWtDO1FBSmxDLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBUjVDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO0lBVXhCLENBQUM7SUFFSyxRQUFROztZQUNaLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3BCLENBQUM7S0FBQTtJQUVLLElBQUk7O1lBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FB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QUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxPQUFPLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQztTQUN0RTtJQUNILENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxlQUFlO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0lBQ3pDLENBQUM7SUFFTyx5QkFBeUI7UUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxDQUFDO0lBRWEsVUFBVTs7WUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDaEUsWUFBWSxFQUFFLEtBQUs7YUFDcEIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ1gsQ0FBQztLQUFBOzs7WUF4SUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw4QkFBOEI7Z0JBQ3hDLHcrREFBd0Q7YUFDekQ7OztZQVRRLGNBQWM7WUFFZCxZQUFZO1lBQ2tCLGlCQUFpQjtZQUMvQywwQkFBMEI7WUFIVixnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UsIElPcGVyYXRpb24sIE9wZXJhdGlvblN0YXR1cyB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbiwgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnkvc2hhcmVkJztcbmltcG9ydCB7IERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9kZXZpY2UtY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXRleHQtYmFzZWQtY29uZmlndXJhdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi90ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFRleHRCYXNlZENvbmZpZ3VyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuICBsYXRlc3RPcGVyYXRpb246IElPcGVyYXRpb247XG4gIHNob3dUZXh0QmFzZWRDb25maWdSZWxvYWQ6IGJvb2xlYW47XG4gIHNob3dUZXh0QmFzZWRDb25maWdTYXZlOiBib29sZWFuO1xuICByZWxvYWRpbmdDb25maWcgPSBmYWxzZTtcbiAgY29uZmlnOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlOiBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2VcbiAgKSB7XG4gIH1cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWQoKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5kZXZpY2UgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhO1xuICAgIGF3YWl0IHRoaXMubG9hZERldmljZSgpO1xuICAgIGF3YWl0IHRoaXMubG9hZE9wZXJhdGlvbigpO1xuICAgIHRoaXMuc2hvd1RleHRCYXNlZENvbmZpZ1JlbG9hZCA9IHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuaGFzQW55U3VwcG9ydGVkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UsXG4gICAgICBbRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbi5TRU5EX0NPTkZJR11cbiAgICApO1xuICAgIHRoaXMuc2hvd1RleHRCYXNlZENvbmZpZ1NhdmUgPSB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0FueVN1cHBvcnRlZE9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgW0RldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uQ09ORklHXVxuICAgICk7XG4gICAgaWYgKHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uICYmIHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZykge1xuICAgICAgdGhpcy5jb25maWcgPSB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWc7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZE9wZXJhdGlvbigpIHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmdldExhc3RDb25maWdVcGRhdGVPcGVyYXRpb24odGhpcy5kZXZpY2UuaWQpO1xuICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIHtcbiAgICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID1cbiAgICAgICAgISFvcGVyYXRpb24uYzh5X1NlbmRDb25maWd1cmF0aW9uICYmXG4gICAgICAgIChvcGVyYXRpb24uc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuUEVORElORyB8fFxuICAgICAgICAgIG9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkcpO1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5vYnNlcnZlT3BlcmF0aW9uKG9wZXJhdGlvbikuc3Vic2NyaWJlKChvcGVyYXRpb25VcGRhdGUpID0+IHtcbiAgICAgICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXQgc2F2aW5nQ29uZmlnKCkge1xuICAgIHJldHVybiB0aGlzLmxhdGVzdE9wZXJhdGlvblxuICAgICAgPyAhIXRoaXMubGF0ZXN0T3BlcmF0aW9uLmM4eV9Db25maWd1cmF0aW9uICYmXG4gICAgICAgICAgKHRoaXMubGF0ZXN0T3BlcmF0aW9uLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcgfHxcbiAgICAgICAgICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLkVYRUNVVElORylcbiAgICAgIDogZmFsc2U7XG4gIH1cblxuICBhc3luYyByZWxvYWRDb25maWd1cmF0aW9uKCkge1xuICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID0gdHJ1ZTtcbiAgICBjb25zdCBvcGVyYXRpb25DZmcgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmNyZWF0ZVRleHRCYXNlZENvbmZpZ3VyYXRpb25SZWxvYWRPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZVxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2VcbiAgICAgICAgLmNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbkNmZylcbiAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZFN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSxcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZEVycm9yKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgKCkgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZENvbXBsZXRlKClcbiAgICAgICAgKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlQ29uZmlndXJhdGlvbihjb25maWcpIHtcbiAgICBjb25zdCBvcGVyYXRpb25DZmcgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmNyZWF0ZVRleHRCYXNlZENvbmZpZ3VyYXRpb25VcGRhdGVPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIGNvbmZpZ1xuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2VcbiAgICAgICAgLmNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbkNmZylcbiAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblVwZGF0ZVN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSxcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblVwZGF0ZUVycm9yKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgKCkgPT4gdGhpcy5vbk9wZXJhdGlvblVwZGF0ZUNvbXBsZXRlKClcbiAgICAgICAgKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblJlbG9hZFN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5QRU5ESU5HKSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gd2lsbCBiZSByZWxvYWRlZC4nKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblJlbG9hZEVycm9yKG9wZXJhdGlvblVwZGF0ZSkge1xuICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG9uT3BlcmF0aW9uUmVsb2FkQ29tcGxldGUoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkRGV2aWNlKCk7XG4gICAgdGhpcy5jb25maWcgPSB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWc7XG4gICAgdGhpcy5yZWxvYWRpbmdDb25maWcgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25VcGRhdGVTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSkge1xuICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgIGlmIChvcGVyYXRpb25VcGRhdGUuc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuUEVORElORykge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdDb25maWd1cmF0aW9uIHdpbGwgYmUgdXBkYXRlZC4nKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblVwZGF0ZUVycm9yKG9wZXJhdGlvblVwZGF0ZSkge1xuICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblVwZGF0ZUNvbXBsZXRlKCkge1xuICAgIHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZyA9IHRoaXMuY29uZmlnO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkRGV2aWNlKCkge1xuICAgIHRoaXMuZGV2aWNlID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwodGhpcy5kZXZpY2UuaWQsIHtcbiAgICAgIHdpdGhDaGlsZHJlbjogZmFsc2VcbiAgICB9KSkuZGF0YTtcbiAgfVxufVxuIl19