import { __awaiter } from "tslib";
import { Component, EventEmitter } from '@angular/core';
import { QueriesUtil } from '@c8y/client';
import { gettext, ModalSelectionMode } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { get, has, isEmpty, isEqual, omitBy } from 'lodash-es';
import { BehaviorSubject, merge, of, Subject } from 'rxjs';
import { map, mergeMap, switchMap, tap } from 'rxjs/operators';
import { RepositoryService } from '../repository.service';
// MODAL STRUCTURE
// - selectModalObject (repository entry (repositoryCategory) -> type c8y_Firmware/c8y_Software)
//   -- ISelectModalOption (repository binary entry (repositoryBinary) => type c8y_FirmwareBinary/c8y_SoftwareBinary)
//   -- ISelectModalOption...
// - selectModalObject...
/**
 * RepositorySelectModalComponent displays repository entries options and allows to select them.
 *
 * @example
 * ```
 * import { take } from 'rxjs/operators';
 * import { RepositorySelectModalComponent, ModalSelectionMode, RepositoryType } from '@c8y/ngx-components/repository/shared';
 *
 * const initialState = {
 *   repositoryType: RepositoryType.FIRMWARE,
 *   title: gettext('Install firmware'),
 *   subTitle: gettext('Available firmwares matching the device type'),
 *   icon: 'c8y-firmware',
 *   mode: ModalSelectionMode.SINGLE,
 *   labels: { ok: gettext('Install') },
 *   disableSelected: false
 * };
 *
 * const modal = this.bsModal.show(RepositorySelectModalComponent, {
 *   ignoreBackdropClick: true,
 *   initialState
 * });
 *
 * modal.content.load.next();
 * modal.content.resultEmitter.pipe(take(1)).subscribe((firmware) => {
 *   ...
 * })
 * ```
 */
export class RepositorySelectModalComponent {
    constructor(repositoryService, translateService) {
        this.repositoryService = repositoryService;
        this.translateService = translateService;
        /**
         * Optional
         * Allows to provide custom data.
         * @example
         * ```
         * import { from } from 'rxjs';
         *
         * const repositoryEntry = { name: 'ExampleEntry', type: 'c8y_Firmware' };
         * const versions = [{ c8y_Firmware: { version: '1.0.0', url: 'http://example.com' } }];
         *
         * const initialState = {repositoryEntriesWithVersions$: from({ ...repositoryEntry, versions })};
         * ```
         */
        this.repositoryEntriesWithVersions$ = undefined;
        /**
         * Optional
         * Allows to use custom badges templates.
         * @example
         * ```
         * import { gettext } from '@c8y/ngx-components';
         *
         * const badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
         * const initialState = { badgeTemplates };
         * ```
         */
        this.badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
        /**
         * Optional
         * Allows to provide custom modal title.
         */
        this.title = gettext('Select repository entry');
        /**
         * Loads the content of the modal.
         * Must be invoked by the modal's caller.
         */
        this.load = new Subject();
        /**
         * Triggers an update of the item list emitted.
         */
        this.updateInstallableList$ = new Subject();
        /**
         * Optional
         * Emits a filter criteria object currently entered in the filter input.
         * Use it to filter the items if you use custom repositoryEntriesWithVersions$.
         */
        this.searchTerm = new BehaviorSubject({});
        /**
         * Optional
         * Allows to provide device type query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.deviceTypeQuery = {};
        /**
         * Optional
         * Allows to provide query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.searchQuery = {};
        /**
         * Optional
         * Allows to provide custom labels for the buttons responsible for confirm/dismiss modal actions.
         */
        this.labels = { ok: gettext('Save') };
        /**
         * Optional
         * Allows to hide the name filter input field.
         * By default, the filter input field is displayed.
         */
        this.showFilter = true;
        /**
         * Optional
         * Allows to show a warning that the search criteria should be narrowed down.
         * By default, this warning is hidden.
         */
        this.areMoreEntries = false;
        /**
         * Emits whenever a new repository binary have been selected in the modal.
         */
        this.onChoiceUpdated = new EventEmitter();
        /**
         * Emits the list of selected options.
         */
        this.resultEmitter = new EventEmitter();
        /**
         * Optional
         * Allows to change selection mode.
         * Supported options:
         *   * single: only single option can be selected.
         *   * multiple: multiple options can be selected.
         */
        this.mode = ModalSelectionMode.SINGLE;
        /**
         * Allows to block selection of the other versions from the same repository entry.
         */
        this.disableSelected = true;
        this.filterCriteria = {};
        this.repositoryEntries$ = this.load.pipe(switchMap(() => this.repositoryEntriesWithVersions$), mergeMap(mos => this.aggregate(mos)), tap(items => {
            this.areMoreEntries = items.length >= this.PAGE_SIZE ? true : false;
        }), tap(items => (this.repositoryEntries = items)));
        this.modalEntries = merge(this.repositoryEntries$, this.updateInstallableList$.pipe(map((updateItemEvent) => {
            const itemToUpdate = (this.repositoryEntries || []).find(item => item.groupId === updateItemEvent.object.groupId);
            if (itemToUpdate) {
                const optionToUpdate = (itemToUpdate.options || []).find(option => option.obj.id === updateItemEvent.object.selectedId);
                if (optionToUpdate) {
                    optionToUpdate.template = updateItemEvent.template;
                    if (updateItemEvent.mapper) {
                        optionToUpdate.obj = updateItemEvent.mapper(optionToUpdate.obj);
                    }
                }
            }
            return this.repositoryEntries;
        })));
        this.PAGE_SIZE = 100;
        this.queriesUtil = new QueriesUtil();
    }
    ngOnInit() {
        if (!this.repositoryType) {
            throw new Error('Repository type must be defined');
        }
        if (!this.repositoryEntriesWithVersions$) {
            this.repositoryEntriesWithVersions$ = of(1).pipe(mergeMap(() => this.repositoryService.listRepositoryEntries(this.repositoryType, {
                query: this.queriesUtil.addAndFilter(this.deviceTypeQuery, has(this.searchQuery, 'name')
                    ? Object.assign(Object.assign({}, this.searchQuery), { name: `*${this.searchQuery.name}*` }) : this.searchQuery),
                params: { pageSize: this.PAGE_SIZE }
            })), map(({ data }) => data), map(mos => this.getAndAssignRepositoryBinaries(mos)));
        }
    }
    getAndAssignRepositoryBinaries(mos) {
        mos.forEach(mo => {
            mo.versions = this.repositoryService.listAllVersions(mo);
        });
        return mos;
    }
    search(filterCriteria) {
        this.filterCriteria = omitBy(Object.assign(Object.assign({}, this.filterCriteria), filterCriteria), isEmpty);
        if (!isEqual(this.filterCriteria, this.searchQuery)) {
            this.searchTerm.next(this.filterCriteria);
            this.searchQuery = this.filterCriteria;
            this.load.next();
        }
    }
    result(selectedItems) {
        this.resultEmitter.emit(selectedItems);
    }
    aggregate(mos) {
        return __awaiter(this, void 0, void 0, function* () {
            const repositoryType = this.repositoryType;
            const selectedItems = this.selected;
            return Promise.all(mos.map((repositoryEntry) => __awaiter(this, void 0, void 0, function* () {
                const options = this.getSelectModalOptions(yield this.repositoryService.fetchAllItemsFromList(repositoryEntry.versions), selectedItems, repositoryEntry, repositoryType);
                const selectModalObject = this.getSelectModalObject(repositoryEntry, options);
                return selectModalObject;
            })));
        });
    }
    getSelectModalOptions(versions, selectedItems, repositoryEntry, repositoryType) {
        const selectModalOptions = [];
        versions.forEach(repositoryBinary => {
            const isSelected = this.isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType);
            const { version } = repositoryBinary[`${repositoryType}`];
            const bodyValue = version || `(${this.translateService.instant(gettext('not specified`version`'))})`;
            const bodyClass = version ? '' : 'text-muted';
            selectModalOptions.push({
                body: [
                    {
                        value: bodyValue,
                        class: bodyClass
                    }
                ],
                obj: Object.assign(Object.assign(Object.assign({ id: repositoryBinary.id, name: repositoryEntry.name, version }, (get(repositoryBinary, 'c8y_Patch.dependency') && {
                    dependency: get(repositoryBinary, 'c8y_Patch.dependency')
                })), (get(repositoryBinary, 'c8y_Patch') && { isPatch: true })), { url: repositoryBinary[`${repositoryType}`].url, softwareType: repositoryEntry.softwareType }),
                selected: isSelected
            });
        });
        return selectModalOptions;
    }
    isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType) {
        const isSelected = selectedItems
            ? selectedItems.filter(repositoryFragment => repositoryFragment.name === repositoryEntry.name &&
                repositoryFragment.version === repositoryBinary[`${repositoryType}`].version).length > 0
            : false;
        return isSelected;
    }
    getSelectModalObject(repositoryEntry, options) {
        const label = options.length === 1
            ? this.translateService.instant(this.badgeTemplates['=1'], { count: options.length })
            : this.translateService.instant(this.badgeTemplates.other, { count: options.length });
        const selectModalObject = {
            groupId: repositoryEntry.id,
            body: [
                { value: repositoryEntry.name, class: 'text-truncate' },
                { value: repositoryEntry.description, class: 'text-truncate text-muted' }
            ],
            additionalInformation: { value: label, class: 'label label-info' },
            options
        };
        return selectModalObject;
    }
}
RepositorySelectModalComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-repository-select-modal',
                template: "<c8y-select-modal\n  [icon]=\"icon\"\n  [title]=\"title\"\n  [subTitle]=\"subTitle\"\n  [items]=\"modalEntries | async\"\n  [mode]=\"mode\"\n  [disableSelected]=\"disableSelected\"\n  [labels]=\"labels\"\n  [showFilter]=\"showFilter\"\n  [additionalFilterTemplate]=\"additionalFilterTemplate\"\n  [areMoreEntries]=\"areMoreEntries\"\n  [noItemsMessage]=\"noItemsMessage\"\n  (search)=\"search({ name: $event })\"\n  (onChoiceUpdated)=\"onChoiceUpdated.emit($event)\"\n  (result)=\"result($event)\"\n>\n</c8y-select-modal>\n"
            },] }
];
RepositorySelectModalComponent.ctorParameters = () => [
    { type: RepositoryService },
    { type: TranslateService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcmVwb3NpdG9yeS9zaGFyZWQvc2VsZWN0LW1vZGFsL3JlcG9zaXRvcnktc2VsZWN0LW1vZGFsLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFDckUsT0FBTyxFQUFrQixXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUQsT0FBTyxFQUNMLE9BQU8sRUFLUCxrQkFBa0IsRUFDbkIsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVEvRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRCxrQkFBa0I7QUFDbEIsZ0dBQWdHO0FBQ2hHLHFIQUFxSDtBQUNySCw2QkFBNkI7QUFDN0IseUJBQXlCO0FBRXpCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBNEJHO0FBTUgsTUFBTSxPQUFPLDhCQUE4QjtJQTBLekMsWUFDVSxpQkFBb0MsRUFDcEMsZ0JBQWtDO1FBRGxDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQTNLNUM7Ozs7Ozs7Ozs7OztX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RixDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUUxRixNQUFNLGlCQUFpQixHQUF1QjtZQUM1QyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUU7WUFDM0IsSUFBSSxFQUFFO2dCQUNKLEVBQUUsS0FBSyxFQUFFLGVBQWUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRTtnQkFDdkQsRUFBRSxLQUFLLEVBQUUsZUFBZSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsMEJBQTBCLEVBQUU7YUFDMUU7WUFDRCxxQkFBcUIsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixFQUFFO1lBQ2xFLE9BQU87U0FDUixDQUFDO1FBRUYsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDOzs7WUE5VUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw2QkFBNkI7Z0JBQ3ZDLHVoQkFBdUQ7YUFDeEQ7OztZQXpDUSxpQkFBaUI7WUFYakIsZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIFRlbXBsYXRlUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgUXVlcmllc1V0aWwgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBnZXR0ZXh0LFxuICBJU2VsZWN0TW9kYWxPYmplY3QsXG4gIElTZWxlY3RNb2RhbE9wdGlvbixcbiAgSVVwZGF0ZUl0ZW1FdmVudCxcbiAgTW9kYWxMYWJlbHMsXG4gIE1vZGFsU2VsZWN0aW9uTW9kZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IGdldCwgaGFzLCBpc0VtcHR5LCBpc0VxdWFsLCBvbWl0QnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgRmlsdGVyQ3JpdGVyaWEsXG4gIFJlcG9zaXRvcnlCaW5hcnksXG4gIFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgUmVwb3NpdG9yeVR5cGUsXG4gIFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVxufSBmcm9tICcuLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5zZXJ2aWNlJztcblxuLy8gTU9EQUwgU1RSVUNUVVJFXG4vLyAtIHNlbGVjdE1vZGFsT2JqZWN0IChyZXBvc2l0b3J5IGVudHJ5IChyZXBvc2l0b3J5Q2F0ZWdvcnkpIC0+IHR5cGUgYzh5X0Zpcm13YXJlL2M4eV9Tb2Z0d2FyZSlcbi8vICAgLS0gSVNlbGVjdE1vZGFsT3B0aW9uIChyZXBvc2l0b3J5IGJpbmFyeSBlbnRyeSAocmVwb3NpdG9yeUJpbmFyeSkgPT4gdHlwZSBjOHlfRmlybXdhcmVCaW5hcnkvYzh5X1NvZnR3YXJlQmluYXJ5KVxuLy8gICAtLSBJU2VsZWN0TW9kYWxPcHRpb24uLi5cbi8vIC0gc2VsZWN0TW9kYWxPYmplY3QuLi5cblxuLyoqXG4gKiBSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQgZGlzcGxheXMgcmVwb3NpdG9yeSBlbnRyaWVzIG9wdGlvbnMgYW5kIGFsbG93cyB0byBzZWxlY3QgdGhlbS5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgXG4gKiBpbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuICogaW1wb3J0IHsgUmVwb3NpdG9yeVNlbGVjdE1vZGFsQ29tcG9uZW50LCBNb2RhbFNlbGVjdGlvbk1vZGUsIFJlcG9zaXRvcnlUeXBlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5L3NoYXJlZCc7XG4gKlxuICogY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICogICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGUuRklSTVdBUkUsXG4gKiAgIHRpdGxlOiBnZXR0ZXh0KCdJbnN0YWxsIGZpcm13YXJlJyksXG4gKiAgIHN1YlRpdGxlOiBnZXR0ZXh0KCdBdmFpbGFibGUgZmlybXdhcmVzIG1hdGNoaW5nIHRoZSBkZXZpY2UgdHlwZScpLFxuICogICBpY29uOiAnYzh5LWZpcm13YXJlJyxcbiAqICAgbW9kZTogTW9kYWxTZWxlY3Rpb25Nb2RlLlNJTkdMRSxcbiAqICAgbGFiZWxzOiB7IG9rOiBnZXR0ZXh0KCdJbnN0YWxsJykgfSxcbiAqICAgZGlzYWJsZVNlbGVjdGVkOiBmYWxzZVxuICogfTtcbiAqXG4gKiBjb25zdCBtb2RhbCA9IHRoaXMuYnNNb2RhbC5zaG93KFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCwge1xuICogICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlLFxuICogICBpbml0aWFsU3RhdGVcbiAqIH0pO1xuICpcbiAqIG1vZGFsLmNvbnRlbnQubG9hZC5uZXh0KCk7XG4gKiBtb2RhbC5jb250ZW50LnJlc3VsdEVtaXR0ZXIucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKGZpcm13YXJlKSA9PiB7XG4gKiAgIC4uLlxuICogfSlcbiAqIGBgYFxuICovXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1yZXBvc2l0b3J5LXNlbGVjdC1tb2RhbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9yZXBvc2l0b3J5LXNlbGVjdC1tb2RhbC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUmVwb3NpdG9yeVNlbGVjdE1vZGFsQ29tcG9uZW50IHtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBwcm92aWRlIGN1c3RvbSBkYXRhLlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBcbiAgICogaW1wb3J0IHsgZnJvbSB9IGZyb20gJ3J4anMnO1xuICAgKlxuICAgKiBjb25zdCByZXBvc2l0b3J5RW50cnkgPSB7IG5hbWU6ICdFeGFtcGxlRW50cnknLCB0eXBlOiAnYzh5X0Zpcm13YXJlJyB9O1xuICAgKiBjb25zdCB2ZXJzaW9ucyA9IFt7IGM4eV9GaXJtd2FyZTogeyB2ZXJzaW9uOiAnMS4wLjAnLCB1cmw6ICdodHRwOi8vZXhhbXBsZS5jb20nIH0gfV07XG4gICAqXG4gICAqIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHtyZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IGZyb20oeyAuLi5yZXBvc2l0b3J5RW50cnksIHZlcnNpb25zIH0pfTtcbiAgICogYGBgXG4gICAqL1xuICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IE9ic2VydmFibGU8SU1hbmFnZWRPYmplY3RbXT4gPSB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBSZXBvc2l0b3J5IGVudHJ5IHR5cGUuXG4gICAqL1xuICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGUuRklSTVdBUkUgfCBSZXBvc2l0b3J5VHlwZS5TT0ZUV0FSRTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byB1c2UgY3VzdG9tIGJhZGdlcyB0ZW1wbGF0ZXMuXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYFxuICAgKiBpbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG4gICAqXG4gICAqIGNvbnN0IGJhZGdlVGVtcGxhdGVzID0geyAnPTEnOiBnZXR0ZXh0KCd7e2NvdW50fX0gdmVyc2lvbicpLCBvdGhlcjogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb25zJykgfTtcbiAgICogY29uc3QgaW5pdGlhbFN0YXRlID0geyBiYWRnZVRlbXBsYXRlcyB9O1xuICAgKiBgYGBcbiAgICovXG4gIGJhZGdlVGVtcGxhdGVzID0geyAnPTEnOiBnZXR0ZXh0KCd7e2NvdW50fX0gdmVyc2lvbicpLCBvdGhlcjogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb25zJykgfTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBwcm92aWRlIGN1c3RvbSBtb2RhbCB0aXRsZS5cbiAgICovXG4gIHRpdGxlOiBzdHJpbmcgPSBnZXR0ZXh0KCdTZWxlY3QgcmVwb3NpdG9yeSBlbnRyeScpO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgY3VzdG9tIG1vZGFsIHN1YnRpdGxlLlxuICAgKi9cbiAgc3ViVGl0bGU6IHN0cmluZztcbiAgLyoqXG4gICAqIExvYWRzIHRoZSBjb250ZW50IG9mIHRoZSBtb2RhbC5cbiAgICogTXVzdCBiZSBpbnZva2VkIGJ5IHRoZSBtb2RhbCdzIGNhbGxlci5cbiAgICovXG4gIGxvYWQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuICAvKipcbiAgICogVHJpZ2dlcnMgYW4gdXBkYXRlIG9mIHRoZSBpdGVtIGxpc3QgZW1pdHRlZC5cbiAgICovXG4gIHVwZGF0ZUluc3RhbGxhYmxlTGlzdCQ6IFN1YmplY3Q8SVVwZGF0ZUl0ZW1FdmVudDxhbnk+PiA9IG5ldyBTdWJqZWN0KCk7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBFbWl0cyBhIGZpbHRlciBjcml0ZXJpYSBvYmplY3QgY3VycmVudGx5IGVudGVyZWQgaW4gdGhlIGZpbHRlciBpbnB1dC5cbiAgICogVXNlIGl0IHRvIGZpbHRlciB0aGUgaXRlbXMgaWYgeW91IHVzZSBjdXN0b20gcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkLlxuICAgKi9cbiAgc2VhcmNoVGVybTogQmVoYXZpb3JTdWJqZWN0PEZpbHRlckNyaXRlcmlhPiA9IG5ldyBCZWhhdmlvclN1YmplY3Qoe30pO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgZGV2aWNlIHR5cGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBkZXZpY2VUeXBlUXVlcnk6IGFueSA9IHt9O1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBzZWFyY2hRdWVyeTogYW55ID0ge307XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBjdXN0b20gbGFiZWxzIGZvciB0aGUgYnV0dG9ucyByZXNwb25zaWJsZSBmb3IgY29uZmlybS9kaXNtaXNzIG1vZGFsIGFjdGlvbnMuXG4gICAqL1xuICBsYWJlbHM6IE1vZGFsTGFiZWxzID0geyBvazogZ2V0dGV4dCgnU2F2ZScpIH07XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gaGlkZSB0aGUgbmFtZSBmaWx0ZXIgaW5wdXQgZmllbGQuXG4gICAqIEJ5IGRlZmF1bHQsIHRoZSBmaWx0ZXIgaW5wdXQgZmllbGQgaXMgZGlzcGxheWVkLlxuICAgKi9cbiAgc2hvd0ZpbHRlcjogYm9vbGVhbiA9IHRydWU7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gc2hvdyBhIHdhcm5pbmcgdGhhdCB0aGUgc2VhcmNoIGNyaXRlcmlhIHNob3VsZCBiZSBuYXJyb3dlZCBkb3duLlxuICAgKiBCeSBkZWZhdWx0LCB0aGlzIHdhcm5pbmcgaXMgaGlkZGVuLlxuICAgKi9cbiAgYXJlTW9yZUVudHJpZXM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBkaXNwbGF5IGEgbW9yZSBzcGVjaWZpYyB0aGFuIHRoZSBkZWZhdWx0IG1lc3NhZ2UgaW4gY2FzZSB0aGVyZSBhcmUgbm8gaXRlbXMgdG8gZGlzcGxheS5cbiAgICovXG4gIG5vSXRlbXNNZXNzYWdlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcGFzcyB0aGUgYXJyYXkgb2YgaXRlbXMuIEVhY2ggaXRlbSBmcm9tIHRoaXMgYXJyYXkgd2lsbCBiZSBtYXJrZWQgYXMgc2VsZWN0ZWQgaW4gdGhlIG1vZGFsLlxuICAgKi9cbiAgc2VsZWN0ZWQ6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdO1xuICAvKipcbiAgICogRW1pdHMgd2hlbmV2ZXIgYSBuZXcgcmVwb3NpdG9yeSBiaW5hcnkgaGF2ZSBiZWVuIHNlbGVjdGVkIGluIHRoZSBtb2RhbC5cbiAgICovXG4gIG9uQ2hvaWNlVXBkYXRlZDogRXZlbnRFbWl0dGVyPElTZWxlY3RNb2RhbE9iamVjdD4gPSBuZXcgRXZlbnRFbWl0dGVyPElTZWxlY3RNb2RhbE9iamVjdD4oKTtcbiAgLyoqXG4gICAqIEVtaXRzIHRoZSBsaXN0IG9mIHNlbGVjdGVkIG9wdGlvbnMuXG4gICAqL1xuICByZXN1bHRFbWl0dGVyOiBFdmVudEVtaXR0ZXI8U2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10+ID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXVxuICA+KCk7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gY2hhbmdlIHNlbGVjdGlvbiBtb2RlLlxuICAgKiBTdXBwb3J0ZWQgb3B0aW9uczpcbiAgICogICAqIHNpbmdsZTogb25seSBzaW5nbGUgb3B0aW9uIGNhbiBiZSBzZWxlY3RlZC5cbiAgICogICAqIG11bHRpcGxlOiBtdWx0aXBsZSBvcHRpb25zIGNhbiBiZSBzZWxlY3RlZC5cbiAgICovXG4gIG1vZGU6IE1vZGFsU2VsZWN0aW9uTW9kZSA9IE1vZGFsU2VsZWN0aW9uTW9kZS5TSU5HTEU7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gdXNlIGN1c3RvbSBpY29uIGluIHRoZSBtb2RhbCBoZWFkZXIuXG4gICAqL1xuICBpY29uOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gYmxvY2sgc2VsZWN0aW9uIG9mIHRoZSBvdGhlciB2ZXJzaW9ucyBmcm9tIHRoZSBzYW1lIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqL1xuICBkaXNhYmxlU2VsZWN0ZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGZpbHRlckNyaXRlcmlhOiBGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuXG4gIHJlcG9zaXRvcnlFbnRyaWVzJDogT2JzZXJ2YWJsZTxJU2VsZWN0TW9kYWxPYmplY3RbXT4gPSB0aGlzLmxvYWQucGlwZShcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQpLFxuICAgIG1lcmdlTWFwKG1vcyA9PiB0aGlzLmFnZ3JlZ2F0ZShtb3MpKSxcbiAgICB0YXAoaXRlbXMgPT4ge1xuICAgICAgdGhpcy5hcmVNb3JlRW50cmllcyA9IGl0ZW1zLmxlbmd0aCA+PSB0aGlzLlBBR0VfU0laRSA/IHRydWUgOiBmYWxzZTtcbiAgICB9KSxcbiAgICB0YXAoaXRlbXMgPT4gKHRoaXMucmVwb3NpdG9yeUVudHJpZXMgPSBpdGVtcykpXG4gICk7XG5cbiAgbW9kYWxFbnRyaWVzOiBPYnNlcnZhYmxlPElTZWxlY3RNb2RhbE9iamVjdFtdPiA9IG1lcmdlKFxuICAgIHRoaXMucmVwb3NpdG9yeUVudHJpZXMkLFxuICAgIHRoaXMudXBkYXRlSW5zdGFsbGFibGVMaXN0JC5waXBlKFxuICAgICAgbWFwKCh1cGRhdGVJdGVtRXZlbnQ6IElVcGRhdGVJdGVtRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBpdGVtVG9VcGRhdGU6IElTZWxlY3RNb2RhbE9iamVjdCA9ICh0aGlzLnJlcG9zaXRvcnlFbnRyaWVzIHx8IFtdKS5maW5kKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbS5ncm91cElkID09PSB1cGRhdGVJdGVtRXZlbnQub2JqZWN0Lmdyb3VwSWRcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGl0ZW1Ub1VwZGF0ZSkge1xuICAgICAgICAgIGNvbnN0IG9wdGlvblRvVXBkYXRlOiBJU2VsZWN0TW9kYWxPcHRpb24gPSAoaXRlbVRvVXBkYXRlLm9wdGlvbnMgfHwgW10pLmZpbmQoXG4gICAgICAgICAgICBvcHRpb24gPT4gb3B0aW9uLm9iai5pZCA9PT0gKHVwZGF0ZUl0ZW1FdmVudC5vYmplY3QgYXMgYW55KS5zZWxlY3RlZElkXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAob3B0aW9uVG9VcGRhdGUpIHtcbiAgICAgICAgICAgIG9wdGlvblRvVXBkYXRlLnRlbXBsYXRlID0gdXBkYXRlSXRlbUV2ZW50LnRlbXBsYXRlO1xuICAgICAgICAgICAgaWYgKHVwZGF0ZUl0ZW1FdmVudC5tYXBwZXIpIHtcbiAgICAgICAgICAgICAgb3B0aW9uVG9VcGRhdGUub2JqID0gdXBkYXRlSXRlbUV2ZW50Lm1hcHBlcihvcHRpb25Ub1VwZGF0ZS5vYmopO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5RW50cmllcztcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBhZGRpdGlvbmFsIHRlbXBsYXRlIHRoYXQgd2lsbCBiZSByZW5kZXJlZCBpbiB0aGVcbiAgICogZmlsdGVycyBibG9jayBvbiB0b3Agb2YgdGhlIHJlc3VsdHMgbGlzdCBpbiB0aGUgc2VsZWN0IG1vZGFsLlxuICAgKi9cbiAgYWRkaXRpb25hbEZpbHRlclRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIHByaXZhdGUgUEFHRV9TSVpFID0gMTAwO1xuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcbiAgcHJpdmF0ZSByZXBvc2l0b3J5RW50cmllczogSVNlbGVjdE1vZGFsT2JqZWN0W107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5yZXBvc2l0b3J5VHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXBvc2l0b3J5IHR5cGUgbXVzdCBiZSBkZWZpbmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQgPSBvZigxKS5waXBlKFxuICAgICAgICBtZXJnZU1hcCgoKSA9PlxuICAgICAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2UubGlzdFJlcG9zaXRvcnlFbnRyaWVzKHRoaXMucmVwb3NpdG9yeVR5cGUsIHtcbiAgICAgICAgICAgIHF1ZXJ5OiB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2VUeXBlUXVlcnksXG4gICAgICAgICAgICAgIGhhcyh0aGlzLnNlYXJjaFF1ZXJ5LCAnbmFtZScpXG4gICAgICAgICAgICAgICAgPyB7IC4uLnRoaXMuc2VhcmNoUXVlcnksIG5hbWU6IGAqJHt0aGlzLnNlYXJjaFF1ZXJ5Lm5hbWV9KmAgfVxuICAgICAgICAgICAgICAgIDogdGhpcy5zZWFyY2hRdWVyeVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHBhcmFtczogeyBwYWdlU2l6ZTogdGhpcy5QQUdFX1NJWkUgfVxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICAgIG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpLFxuICAgICAgICBtYXAobW9zID0+IHRoaXMuZ2V0QW5kQXNzaWduUmVwb3NpdG9yeUJpbmFyaWVzKG1vcykpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGdldEFuZEFzc2lnblJlcG9zaXRvcnlCaW5hcmllcyhtb3M6IElNYW5hZ2VkT2JqZWN0W10pIHtcbiAgICBtb3MuZm9yRWFjaChtbyA9PiB7XG4gICAgICBtby52ZXJzaW9ucyA9IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UubGlzdEFsbFZlcnNpb25zKG1vKTtcbiAgICB9KTtcbiAgICByZXR1cm4gbW9zO1xuICB9XG5cbiAgc2VhcmNoKGZpbHRlckNyaXRlcmlhOiBGaWx0ZXJDcml0ZXJpYSkge1xuICAgIHRoaXMuZmlsdGVyQ3JpdGVyaWEgPSBvbWl0QnkoXG4gICAgICB7XG4gICAgICAgIC4uLnRoaXMuZmlsdGVyQ3JpdGVyaWEsXG4gICAgICAgIC4uLmZpbHRlckNyaXRlcmlhXG4gICAgICB9LFxuICAgICAgaXNFbXB0eVxuICAgICk7XG5cbiAgICBpZiAoIWlzRXF1YWwodGhpcy5maWx0ZXJDcml0ZXJpYSwgdGhpcy5zZWFyY2hRdWVyeSkpIHtcbiAgICAgIHRoaXMuc2VhcmNoVGVybS5uZXh0KHRoaXMuZmlsdGVyQ3JpdGVyaWEpO1xuICAgICAgdGhpcy5zZWFyY2hRdWVyeSA9IHRoaXMuZmlsdGVyQ3JpdGVyaWE7XG4gICAgICB0aGlzLmxvYWQubmV4dCgpO1xuICAgIH1cbiAgfVxuXG4gIHJlc3VsdChzZWxlY3RlZEl0ZW1zOiBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXSkge1xuICAgIHRoaXMucmVzdWx0RW1pdHRlci5lbWl0KHNlbGVjdGVkSXRlbXMpO1xuICB9XG5cbiAgYXN5bmMgYWdncmVnYXRlKG1vczogSU1hbmFnZWRPYmplY3RbXSk6IFByb21pc2U8SVNlbGVjdE1vZGFsT2JqZWN0W10+IHtcbiAgICBjb25zdCByZXBvc2l0b3J5VHlwZSA9IHRoaXMucmVwb3NpdG9yeVR5cGU7XG4gICAgY29uc3Qgc2VsZWN0ZWRJdGVtczogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10gPSB0aGlzLnNlbGVjdGVkO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgbW9zLm1hcChhc3luYyByZXBvc2l0b3J5RW50cnkgPT4ge1xuICAgICAgICBjb25zdCBvcHRpb25zOiBJU2VsZWN0TW9kYWxPcHRpb25bXSA9IHRoaXMuZ2V0U2VsZWN0TW9kYWxPcHRpb25zKFxuICAgICAgICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZmV0Y2hBbGxJdGVtc0Zyb21MaXN0KHJlcG9zaXRvcnlFbnRyeS52ZXJzaW9ucyksXG4gICAgICAgICAgc2VsZWN0ZWRJdGVtcyxcbiAgICAgICAgICByZXBvc2l0b3J5RW50cnkgYXMgUmVwb3NpdG9yeUNhdGVnb3J5LFxuICAgICAgICAgIHJlcG9zaXRvcnlUeXBlXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHNlbGVjdE1vZGFsT2JqZWN0ID0gdGhpcy5nZXRTZWxlY3RNb2RhbE9iamVjdChcbiAgICAgICAgICByZXBvc2l0b3J5RW50cnkgYXMgUmVwb3NpdG9yeUNhdGVnb3J5LFxuICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gc2VsZWN0TW9kYWxPYmplY3Q7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRTZWxlY3RNb2RhbE9wdGlvbnMoXG4gICAgdmVyc2lvbnM6IFJlcG9zaXRvcnlCaW5hcnlbXSxcbiAgICBzZWxlY3RlZEl0ZW1zOiBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXSxcbiAgICByZXBvc2l0b3J5RW50cnk6IFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGVcbiAgKTogSVNlbGVjdE1vZGFsT3B0aW9uW10ge1xuICAgIGNvbnN0IHNlbGVjdE1vZGFsT3B0aW9uczogSVNlbGVjdE1vZGFsT3B0aW9uW10gPSBbXTtcbiAgICB2ZXJzaW9ucy5mb3JFYWNoKHJlcG9zaXRvcnlCaW5hcnkgPT4ge1xuICAgICAgY29uc3QgaXNTZWxlY3RlZDogYm9vbGVhbiA9IHRoaXMuaXNCaW5hcnlSZXBvc2l0b3J5U2VsZWN0ZWQoXG4gICAgICAgIHNlbGVjdGVkSXRlbXMsXG4gICAgICAgIHJlcG9zaXRvcnlFbnRyeSxcbiAgICAgICAgcmVwb3NpdG9yeUJpbmFyeSxcbiAgICAgICAgcmVwb3NpdG9yeVR5cGVcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHsgdmVyc2lvbiB9ID0gcmVwb3NpdG9yeUJpbmFyeVtgJHtyZXBvc2l0b3J5VHlwZX1gXTtcbiAgICAgIGNvbnN0IGJvZHlWYWx1ZSA9XG4gICAgICAgIHZlcnNpb24gfHwgYCgke3RoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGdldHRleHQoJ25vdCBzcGVjaWZpZWRgdmVyc2lvbmAnKSl9KWA7XG4gICAgICBjb25zdCBib2R5Q2xhc3MgPSB2ZXJzaW9uID8gJycgOiAndGV4dC1tdXRlZCc7XG4gICAgICBzZWxlY3RNb2RhbE9wdGlvbnMucHVzaCh7XG4gICAgICAgIGJvZHk6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB2YWx1ZTogYm9keVZhbHVlLFxuICAgICAgICAgICAgY2xhc3M6IGJvZHlDbGFzc1xuICAgICAgICAgIH1cbiAgICAgICAgXSxcbiAgICAgICAgb2JqOiB7XG4gICAgICAgICAgaWQ6IHJlcG9zaXRvcnlCaW5hcnkuaWQsXG4gICAgICAgICAgbmFtZTogcmVwb3NpdG9yeUVudHJ5Lm5hbWUsXG4gICAgICAgICAgdmVyc2lvbixcbiAgICAgICAgICAuLi4oZ2V0KHJlcG9zaXRvcnlCaW5hcnksICdjOHlfUGF0Y2guZGVwZW5kZW5jeScpICYmIHtcbiAgICAgICAgICAgIGRlcGVuZGVuY3k6IGdldChyZXBvc2l0b3J5QmluYXJ5LCAnYzh5X1BhdGNoLmRlcGVuZGVuY3knKVxuICAgICAgICAgIH0pLFxuICAgICAgICAgIC4uLihnZXQocmVwb3NpdG9yeUJpbmFyeSwgJ2M4eV9QYXRjaCcpICYmIHsgaXNQYXRjaDogdHJ1ZSB9KSxcbiAgICAgICAgICB1cmw6IHJlcG9zaXRvcnlCaW5hcnlbYCR7cmVwb3NpdG9yeVR5cGV9YF0udXJsLFxuICAgICAgICAgIHNvZnR3YXJlVHlwZTogcmVwb3NpdG9yeUVudHJ5LnNvZnR3YXJlVHlwZVxuICAgICAgICB9LFxuICAgICAgICBzZWxlY3RlZDogaXNTZWxlY3RlZFxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHNlbGVjdE1vZGFsT3B0aW9ucztcbiAgfVxuXG4gIGlzQmluYXJ5UmVwb3NpdG9yeVNlbGVjdGVkKFxuICAgIHNlbGVjdGVkSXRlbXM6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdLFxuICAgIHJlcG9zaXRvcnlFbnRyeTogUmVwb3NpdG9yeUNhdGVnb3J5LFxuICAgIHJlcG9zaXRvcnlCaW5hcnk6IFJlcG9zaXRvcnlCaW5hcnksXG4gICAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSBzZWxlY3RlZEl0ZW1zXG4gICAgICA/IHNlbGVjdGVkSXRlbXMuZmlsdGVyKFxuICAgICAgICAgIHJlcG9zaXRvcnlGcmFnbWVudCA9PlxuICAgICAgICAgICAgcmVwb3NpdG9yeUZyYWdtZW50Lm5hbWUgPT09IHJlcG9zaXRvcnlFbnRyeS5uYW1lICYmXG4gICAgICAgICAgICByZXBvc2l0b3J5RnJhZ21lbnQudmVyc2lvbiA9PT0gcmVwb3NpdG9yeUJpbmFyeVtgJHtyZXBvc2l0b3J5VHlwZX1gXS52ZXJzaW9uXG4gICAgICAgICkubGVuZ3RoID4gMFxuICAgICAgOiBmYWxzZTtcblxuICAgIHJldHVybiBpc1NlbGVjdGVkO1xuICB9XG5cbiAgZ2V0U2VsZWN0TW9kYWxPYmplY3QoXG4gICAgcmVwb3NpdG9yeUVudHJ5OiBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgb3B0aW9uczogSVNlbGVjdE1vZGFsT3B0aW9uW11cbiAgKTogSVNlbGVjdE1vZGFsT2JqZWN0IHtcbiAgICBjb25zdCBsYWJlbCA9XG4gICAgICBvcHRpb25zLmxlbmd0aCA9PT0gMVxuICAgICAgICA/IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KHRoaXMuYmFkZ2VUZW1wbGF0ZXNbJz0xJ10sIHsgY291bnQ6IG9wdGlvbnMubGVuZ3RoIH0pXG4gICAgICAgIDogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQodGhpcy5iYWRnZVRlbXBsYXRlcy5vdGhlciwgeyBjb3VudDogb3B0aW9ucy5sZW5ndGggfSk7XG5cbiAgICBjb25zdCBzZWxlY3RNb2RhbE9iamVjdDogSVNlbGVjdE1vZGFsT2JqZWN0ID0ge1xuICAgICAgZ3JvdXBJZDogcmVwb3NpdG9yeUVudHJ5LmlkLFxuICAgICAgYm9keTogW1xuICAgICAgICB7IHZhbHVlOiByZXBvc2l0b3J5RW50cnkubmFtZSwgY2xhc3M6ICd0ZXh0LXRydW5jYXRlJyB9LFxuICAgICAgICB7IHZhbHVlOiByZXBvc2l0b3J5RW50cnkuZGVzY3JpcHRpb24sIGNsYXNzOiAndGV4dC10cnVuY2F0ZSB0ZXh0LW11dGVkJyB9XG4gICAgICBdLFxuICAgICAgYWRkaXRpb25hbEluZm9ybWF0aW9uOiB7IHZhbHVlOiBsYWJlbCwgY2xhc3M6ICdsYWJlbCBsYWJlbC1pbmZvJyB9LFxuICAgICAgb3B0aW9uc1xuICAgIH07XG5cbiAgICByZXR1cm4gc2VsZWN0TW9kYWxPYmplY3Q7XG4gIH1cbn1cbiJdfQ==