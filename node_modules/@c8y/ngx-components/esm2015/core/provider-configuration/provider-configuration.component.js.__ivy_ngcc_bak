import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { ActivatedRoute } from '@angular/router';
import { ɵdefineHiddenProp } from '@ngx-formly/core';
import { find, forOwn, get, mapValues, pick } from 'lodash-es';
import { BehaviorSubject, combineLatest, from, merge, of, Subject } from 'rxjs';
import { catchError, map, shareReplay, switchMap, tap } from 'rxjs/operators';
import { AlertService } from '../alert/alert.service';
import { Permissions, Status } from '../common/index';
import { C8yJSONSchema } from '../dynamic-forms/json-schema/c8y-json-schema.service';
import { ModalService } from '../modal/modal.service';
import { ProviderConfigurationService } from './service/provider-configuration.service';
import { ProviderDefinitionsService } from './service/provider-definitions.service';
export class ProviderConfigurationComponent {
    constructor(permissions, activatedRoute, modalService, alertService, providerDefinitionsService, providerConfigurationService, jsonschema) {
        this.permissions = permissions;
        this.activatedRoute = activatedRoute;
        this.modalService = modalService;
        this.alertService = alertService;
        this.providerDefinitionsService = providerDefinitionsService;
        this.providerConfigurationService = providerConfigurationService;
        this.jsonschema = jsonschema;
        this.layout$ = this.activatedRoute.data.pipe(map((config) => config.layout), tap((layout) => (this.layout = layout)), tap((layout) => {
            this.options.formState.disabled = !this.permissions.hasAllRoles(layout.saveRoles || []);
            this.beforeSaveHook = layout.beforeSaveHook;
        }));
        this.allRoles$ = this.layout$.pipe(map((layout) => [
            ...(layout.deleteRoles || []),
            ...(layout.saveRoles || [])
        ]));
        this.changeProvider$ = new BehaviorSubject(null);
        this.providerInput$ = new BehaviorSubject('');
        this.form = new FormGroup({});
        this.fields = [];
        this.options = {
            formState: {
                disabled: false
            }
        };
        this.reload$ = new BehaviorSubject(null);
        this.updatedConfiguration$ = new Subject();
    }
    ngOnInit() {
        const allProviders$ = from(this.providerDefinitionsService.list()).pipe(map(result => result.data), shareReplay(1));
        this.providers$ = combineLatest(allProviders$, this.providerInput$).pipe(map(([providers, input]) => input
            ? providers.filter(el => el.displayName.toLowerCase().indexOf(input.toLowerCase()) >= 0)
            : providers), shareReplay(1));
        this.configuration$ = merge(this.updatedConfiguration$, this.reload$.pipe(switchMap(() => from(this.providerConfigurationService.detail()).pipe(catchError(() => of({})))), map(result => result.data))).pipe(map(this.removeEncryptedValues), shareReplay(1));
        this.selectedProvider$ = combineLatest(allProviders$, this.configuration$, this.changeProvider$).pipe(tap(([_, configuration, newProvider]) => (this.model = newProvider
            ? pick(this.model, 'sms.senderName', 'sms.senderAddress')
            : configuration)), map(([providers, configuration, newProvider]) => newProvider ||
            find(providers, (provider) => get(configuration, 'provider') === provider.id)), tap((provider) => {
            if (provider) {
                const config = this.jsonschema.toFieldConfig(get(provider, 'schema'));
                if (config.fieldGroup) {
                    config.fieldGroup.forEach((fieldConfig) => {
                        ɵdefineHiddenProp(fieldConfig, '_keyPath', {
                            key: fieldConfig.key,
                            path: [fieldConfig.key]
                        });
                        fieldConfig.expressionProperties = {
                            'templateOptions.disabled': 'formState.disabled'
                        };
                    });
                }
                this.fields = [config];
                this.form = new FormGroup({});
            }
        }), shareReplay(1));
    }
    saveProviderConfiguration() {
        return __awaiter(this, void 0, void 0, function* () {
            const modelToSave = !!this.beforeSaveHook
                ? yield this.beforeSaveHook(this.model, this.fields)
                : this.model;
            forOwn(modelToSave, (value, key) => {
                if (Array.isArray(value)) {
                    modelToSave[key] = value.filter(item => !!item || item === 0);
                }
            });
            try {
                const res = yield this.providerConfigurationService.update(modelToSave);
                this.changeProvider$.next(null);
                this.updatedConfiguration$.next(res.data);
                this.alertService.success(this.layout.configurationUpdatedSuccessMsg);
                this.form.markAsPristine();
            }
            catch (err) {
                this.alertService.addServerFailure(err);
            }
        });
    }
    deleteProviderConfiguration() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.modalService.confirm(this.layout.deleteConfigurationModalTitle, this.layout.deleteConfigurationModalBody, Status.DANGER, {
                    ok: this.layout.deleteConfigurationModalOkBtnLabel,
                    cancel: this.layout.deleteConfigurationModalCancelBtnLabel
                });
                yield this.providerConfigurationService.delete();
                this.reload$.next();
                this.alertService.success(this.layout.configurationDeletedSuccessMsg);
            }
            catch (err) {
                if (err) {
                    this.alertService.addServerFailure(err);
                }
            }
        });
    }
    removeEncryptedValues(configuration) {
        return mapValues(configuration, value => (value === '<<Encrypted>>' ? undefined : value));
    }
}
ProviderConfigurationComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-sms-gateway',
                template: "<c8y-title>\n  {{ (layout$ | async)?.pageTitle | translate }}\n</c8y-title>\n\n<div class=\"row\">\n  <div class=\"col-md-8 col-xs-12\">\n    <form class=\"card card--fullpage\" (ngSubmit)=\"saveProviderConfiguration()\">\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\">\n          {{ (layout$ | async)?.cardTitle | translate }}\n        </h4>\n      </div>\n      <div class=\"inner-scroll\">\n        <div class=\"card-block\">\n          <p *ngIf=\"!!(layout$ | async)?.description\" class=\"m-b-8\">\n            {{ (layout$ | async)?.description | translate }}\n          </p>\n          <c8y-form-group>\n            <label for=\"providerName\">{{ (layout$ | async)?.providerName | translate }}</label>\n            <c8y-typeahead\n              [disabled]=\"!permissions.hasAllRoles((layout$ | async)?.saveRoles || [])\"\n              [ngModel]=\"selectedProvider$ | async\"\n              [displayProperty]=\"'displayName'\"\n              name=\"providerName\"\n              placeholder=\"{{ (layout$ | async)?.providerNamePlaceholder | translate }}\"\n              (onSearch)=\"providerInput$.next($event)\"\n              [allowFreeEntries]=\"false\"\n              [required]=\"true\"\n              [container]=\"'body'\"\n            >\n              <c8y-li\n                *ngFor=\"let provider of providers$ | async\"\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"changeProvider$.next(provider); providerInput$.next('')\"\n                [active]=\"(selectedProvider$ | async) === provider\"\n              >\n                <c8y-highlight\n                  [text]=\"provider.displayName || '--'\"\n                  [pattern]=\"providerInput$ | async\"\n                ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <c8y-messages\n              ><c8y-message\n                name=\"notExisting\"\n                [text]=\"(layout$ | async)?.providerNameNoMatchesHint | translate\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n          <formly-form\n            *ngIf=\"selectedProvider$ | async\"\n            [form]=\"form\"\n            [fields]=\"fields\"\n            [model]=\"model\"\n            [options]=\"options\"\n          ></formly-form>\n        </div>\n      </div>\n      <div class=\"card-footer separator\" *c8yIfAllowed=\"allRoles$ | async; allowAny\">\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.deleteRoles\"\n          class=\"btn btn-default\"\n          type=\"button\"\n          (click)=\"deleteProviderConfiguration()\"\n          [disabled]=\"\n            !(configuration$ | async)?.provider && !(configuration$ | async)?.providerName\n          \"\n          title=\"{{ (layout$ | async)?.deleteBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.deleteBtnLabel | translate }}\n        </button>\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.saveRoles\"\n          class=\"btn btn-primary\"\n          type=\"submit\"\n          [disabled]=\"form.invalid || form.pristine\"\n          title=\"{{ (layout$ | async)?.saveBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.saveBtnLabel | translate }}\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n",
                providers: [ProviderConfigurationService, ProviderDefinitionsService]
            },] }
];
ProviderConfigurationComponent.ctorParameters = () => [
    { type: Permissions },
    { type: ActivatedRoute },
    { type: ModalService },
    { type: AlertService },
    { type: ProviderDefinitionsService },
    { type: ProviderConfigurationService },
    { type: C8yJSONSchema }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24vcHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVqRCxPQUFPLEVBQXdDLGlCQUFpQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDM0YsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQU90RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN4RixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQU9wRixNQUFNLE9B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QU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLDhCQUE4QixDQUFDLENBQUM7YUFDdkU7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDWixJQUFJLEdBQUcsRUFBRTtvQkFDUCxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUN6QzthQUNGO1FBQ0gsQ0FBQztLQUFBO0lBRU8scUJBQXFCLENBQUMsYUFBaUM7UUFDN0QsT0FBTyxTQUFTLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssZUFBZSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDNUYsQ0FBQzs7O1lBbkxGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsaUJBQWlCO2dCQUMzQixteUdBQXNEO2dCQUN0RCxTQUFTLEVBQUUsQ0FBQyw0QkFBNEIsRUFBRSwwQkFBMEIsQ0FBQzthQUN0RTs7O1lBaEJRLFdBQVc7WUFQWCxjQUFjO1lBU2QsWUFBWTtZQUhaLFlBQVk7WUFXWiwwQkFBMEI7WUFEMUIsNEJBQTRCO1lBUjVCLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IElSZXN1bHQgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZywgRm9ybWx5Rm9ybU9wdGlvbnMsIMm1ZGVmaW5lSGlkZGVuUHJvcCB9IGZyb20gJ0BuZ3gtZm9ybWx5L2NvcmUnO1xuaW1wb3J0IHsgZmluZCwgZm9yT3duLCBnZXQsIG1hcFZhbHVlcywgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIGZyb20sIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi9hbGVydC9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBTdGF0dXMgfSBmcm9tICcuLi9jb21tb24vaW5kZXgnO1xuaW1wb3J0IHsgQzh5SlNPTlNjaGVtYSB9IGZyb20gJy4uL2R5bmFtaWMtZm9ybXMvanNvbi1zY2hlbWEvYzh5LWpzb24tc2NoZW1hLnNlcnZpY2UnO1xuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kYWwvbW9kYWwuc2VydmljZSc7XG5pbXBvcnQge1xuICBEeW5hbWljUHJvdmlkZXJDb25maWcsXG4gIER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZ1xufSBmcm9tICcuL21vZGVsL2R5bmFtaWMtcHJvdmlkZXItY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IFByb3ZpZGVyRGVmaW5pdGlvbiB9IGZyb20gJy4vbW9kZWwvcHJvdmlkZXItZGVmaW5pdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBQcm92aWRlclByb3BlcnRpZXMgfSBmcm9tICcuL21vZGVsL3Byb3ZpZGVyLXByb3BlcnRpZXMubW9kZWwnO1xuaW1wb3J0IHsgUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vc2VydmljZS9wcm92aWRlci1jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvcHJvdmlkZXItZGVmaW5pdGlvbnMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zbXMtZ2F0ZXdheScsXG4gIHRlbXBsYXRlVXJsOiAnLi9wcm92aWRlci1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSwgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIFByb3ZpZGVyQ29uZmlndXJhdGlvbkNvbXBvbmVudCB7XG4gIGxheW91dCQ6IE9ic2VydmFibGU8RHluYW1pY1Byb3ZpZGVyTGF5b3V0Q29uZmlnPiA9IHRoaXMuYWN0aXZhdGVkUm91dGUuZGF0YS5waXBlKFxuICAgIG1hcCgoY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWcpID0+IGNvbmZpZy5sYXlvdXQpLFxuICAgIHRhcCgobGF5b3V0OiBEeW5hbWljUHJvdmlkZXJMYXlvdXRDb25maWcpID0+ICh0aGlzLmxheW91dCA9IGxheW91dCkpLFxuICAgIHRhcCgobGF5b3V0OiBEeW5hbWljUHJvdmlkZXJMYXlvdXRDb25maWcpID0+IHtcbiAgICAgIHRoaXMub3B0aW9ucy5mb3JtU3RhdGUuZGlzYWJsZWQgPSAhdGhpcy5wZXJtaXNzaW9ucy5oYXNBbGxSb2xlcyhsYXlvdXQuc2F2ZVJvbGVzIHx8IFtdKTtcbiAgICAgIHRoaXMuYmVmb3JlU2F2ZUhvb2sgPSBsYXlvdXQuYmVmb3JlU2F2ZUhvb2s7XG4gICAgfSlcbiAgKTtcblxuICBhbGxSb2xlcyQ6IE9ic2VydmFibGU8c3RyaW5nW10+ID0gdGhpcy5sYXlvdXQkLnBpcGUoXG4gICAgbWFwKChsYXlvdXQ6IER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZykgPT4gW1xuICAgICAgLi4uKGxheW91dC5kZWxldGVSb2xlcyB8fCBbXSksXG4gICAgICAuLi4obGF5b3V0LnNhdmVSb2xlcyB8fCBbXSlcbiAgICBdKVxuICApO1xuXG4gIHByb3ZpZGVycyQ6IE9ic2VydmFibGU8UHJvdmlkZXJEZWZpbml0aW9uW10+O1xuICBzZWxlY3RlZFByb3ZpZGVyJDogT2JzZXJ2YWJsZTxQcm92aWRlckRlZmluaXRpb24+O1xuICBjaGFuZ2VQcm92aWRlciQ6IFN1YmplY3Q8UHJvdmlkZXJEZWZpbml0aW9uPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIGNvbmZpZ3VyYXRpb24kOiBPYnNlcnZhYmxlPFByb3ZpZGVyUHJvcGVydGllcz47XG4gIHByb3ZpZGVySW5wdXQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+KCcnKTtcblxuICBmb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gIG1vZGVsOiBQcm92aWRlclByb3BlcnRpZXM7XG4gIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdO1xuICBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucyA9IHtcbiAgICBmb3JtU3RhdGU6IHtcbiAgICAgIGRpc2FibGVkOiBmYWxzZVxuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIHJlbG9hZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHZvaWQ+KG51bGwpO1xuICBwcml2YXRlIHVwZGF0ZWRDb25maWd1cmF0aW9uJCA9IG5ldyBTdWJqZWN0PFByb3ZpZGVyUHJvcGVydGllcz4oKTtcbiAgcHJpdmF0ZSBsYXlvdXQ6IER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZztcbiAgcHJpdmF0ZSBiZWZvcmVTYXZlSG9vazogKFxuICAgIG1vZGVsOiBQcm92aWRlclByb3BlcnRpZXMsXG4gICAgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdXG4gICkgPT4gUHJvbWlzZTxQcm92aWRlclByb3BlcnRpZXM+IHwgUHJvdmlkZXJQcm9wZXJ0aWVzO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwZXJtaXNzaW9uczogUGVybWlzc2lvbnMsXG4gICAgcHJpdmF0ZSBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2U6IFByb3ZpZGVyRGVmaW5pdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZTogUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGpzb25zY2hlbWE6IEM4eUpTT05TY2hlbWFcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGFsbFByb3ZpZGVycyQ6IE9ic2VydmFibGU8UHJvdmlkZXJEZWZpbml0aW9uW10+ID0gZnJvbShcbiAgICAgIHRoaXMucHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UubGlzdCgpXG4gICAgKS5waXBlKFxuICAgICAgbWFwKHJlc3VsdCA9PiByZXN1bHQuZGF0YSksXG4gICAgICBzaGFyZVJlcGxheSgxKVxuICAgICk7XG5cbiAgICB0aGlzLnByb3ZpZGVycyQgPSBjb21iaW5lTGF0ZXN0KGFsbFByb3ZpZGVycyQsIHRoaXMucHJvdmlkZXJJbnB1dCQpLnBpcGUoXG4gICAgICBtYXAoKFtwcm92aWRlcnMsIGlucHV0XTogW1Byb3ZpZGVyRGVmaW5pdGlvbltdLCBzdHJpbmddKSA9PlxuICAgICAgICBpbnB1dFxuICAgICAgICAgID8gcHJvdmlkZXJzLmZpbHRlcihlbCA9PiBlbC5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoaW5wdXQudG9Mb3dlckNhc2UoKSkgPj0gMClcbiAgICAgICAgICA6IHByb3ZpZGVyc1xuICAgICAgKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcblxuICAgIHRoaXMuY29uZmlndXJhdGlvbiQgPSBtZXJnZShcbiAgICAgIHRoaXMudXBkYXRlZENvbmZpZ3VyYXRpb24kLFxuICAgICAgdGhpcy5yZWxvYWQkLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgIGZyb20odGhpcy5wcm92aWRlckNvbmZpZ3VyYXRpb25TZXJ2aWNlLmRldGFpbCgpKS5waXBlKGNhdGNoRXJyb3IoKCkgPT4gb2Yoe30gYXMgYW55KSkpXG4gICAgICAgICksXG4gICAgICAgIG1hcChyZXN1bHQgPT4gcmVzdWx0LmRhdGEpXG4gICAgICApXG4gICAgKS5waXBlKG1hcCh0aGlzLnJlbW92ZUVuY3J5cHRlZFZhbHVlcyksIHNoYXJlUmVwbGF5KDEpKTtcblxuICAgIHRoaXMuc2VsZWN0ZWRQcm92aWRlciQgPSBjb21iaW5lTGF0ZXN0KFxuICAgICAgYWxsUHJvdmlkZXJzJCxcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbiQsXG4gICAgICB0aGlzLmNoYW5nZVByb3ZpZGVyJFxuICAgICkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKFtfLCBjb25maWd1cmF0aW9uLCBuZXdQcm92aWRlcl06IFtcbiAgICAgICAgICBQcm92aWRlckRlZmluaXRpb25bXSxcbiAgICAgICAgICBQcm92aWRlclByb3BlcnRpZXMsXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uXG4gICAgICAgIF0pID0+XG4gICAgICAgICAgKHRoaXMubW9kZWwgPSBuZXdQcm92aWRlclxuICAgICAgICAgICAgPyBwaWNrKHRoaXMubW9kZWwsICdzbXMuc2VuZGVyTmFtZScsICdzbXMuc2VuZGVyQWRkcmVzcycpXG4gICAgICAgICAgICA6IGNvbmZpZ3VyYXRpb24pXG4gICAgICApLFxuICAgICAgbWFwKFxuICAgICAgICAoW3Byb3ZpZGVycywgY29uZmlndXJhdGlvbiwgbmV3UHJvdmlkZXJdOiBbXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uW10sXG4gICAgICAgICAgUHJvdmlkZXJQcm9wZXJ0aWVzLFxuICAgICAgICAgIFByb3ZpZGVyRGVmaW5pdGlvblxuICAgICAgICBdKSA9PlxuICAgICAgICAgIG5ld1Byb3ZpZGVyIHx8XG4gICAgICAgICAgZmluZChcbiAgICAgICAgICAgIHByb3ZpZGVycyxcbiAgICAgICAgICAgIChwcm92aWRlcjogUHJvdmlkZXJEZWZpbml0aW9uKSA9PiBnZXQoY29uZmlndXJhdGlvbiwgJ3Byb3ZpZGVyJykgPT09IHByb3ZpZGVyLmlkXG4gICAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRhcCgocHJvdmlkZXI6IFByb3ZpZGVyRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICBpZiAocHJvdmlkZXIpIHtcbiAgICAgICAgICBjb25zdCBjb25maWc6IEZvcm1seUZpZWxkQ29uZmlnID0gdGhpcy5qc29uc2NoZW1hLnRvRmllbGRDb25maWcoZ2V0KHByb3ZpZGVyLCAnc2NoZW1hJykpO1xuICAgICAgICAgIGlmIChjb25maWcuZmllbGRHcm91cCkge1xuICAgICAgICAgICAgY29uZmlnLmZpZWxkR3JvdXAuZm9yRWFjaCgoZmllbGRDb25maWc6IEZvcm1seUZpZWxkQ29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgIMm1ZGVmaW5lSGlkZGVuUHJvcChmaWVsZENvbmZpZywgJ19rZXlQYXRoJywge1xuICAgICAgICAgICAgICAgIGtleTogZmllbGRDb25maWcua2V5LFxuICAgICAgICAgICAgICAgIHBhdGg6IFtmaWVsZENvbmZpZy5rZXldXG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIGZpZWxkQ29uZmlnLmV4cHJlc3Npb25Qcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgICAgICd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnOiAnZm9ybVN0YXRlLmRpc2FibGVkJ1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuZmllbGRzID0gW2NvbmZpZ107XG4gICAgICAgICAgdGhpcy5mb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVByb3ZpZGVyQ29uZmlndXJhdGlvbigpIHtcbiAgICBjb25zdCBtb2RlbFRvU2F2ZTogUHJvdmlkZXJQcm9wZXJ0aWVzID0gISF0aGlzLmJlZm9yZVNhdmVIb29rXG4gICAgICA/IGF3YWl0IHRoaXMuYmVmb3JlU2F2ZUhvb2sodGhpcy5tb2RlbCwgdGhpcy5maWVsZHMpXG4gICAgICA6IHRoaXMubW9kZWw7XG5cbiAgICBmb3JPd24obW9kZWxUb1NhdmUsICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIG1vZGVsVG9TYXZlW2tleV0gPSB2YWx1ZS5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0gfHwgaXRlbSA9PT0gMCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzOiBJUmVzdWx0PFByb3ZpZGVyUHJvcGVydGllcz4gPSBhd2FpdCB0aGlzLnByb3ZpZGVyQ29uZmlndXJhdGlvblNlcnZpY2UudXBkYXRlKFxuICAgICAgICBtb2RlbFRvU2F2ZVxuICAgICAgKTtcbiAgICAgIHRoaXMuY2hhbmdlUHJvdmlkZXIkLm5leHQobnVsbCk7XG4gICAgICB0aGlzLnVwZGF0ZWRDb25maWd1cmF0aW9uJC5uZXh0KHJlcy5kYXRhKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYXlvdXQuY29uZmlndXJhdGlvblVwZGF0ZWRTdWNjZXNzTXNnKTtcbiAgICAgIHRoaXMuZm9ybS5tYXJrQXNQcmlzdGluZSgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVByb3ZpZGVyQ29uZmlndXJhdGlvbigpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5tb2RhbFNlcnZpY2UuY29uZmlybShcbiAgICAgICAgdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsVGl0bGUsXG4gICAgICAgIHRoaXMubGF5b3V0LmRlbGV0ZUNvbmZpZ3VyYXRpb25Nb2RhbEJvZHksXG4gICAgICAgIFN0YXR1cy5EQU5HRVIsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsT2tCdG5MYWJlbCxcbiAgICAgICAgICBjYW5jZWw6IHRoaXMubGF5b3V0LmRlbGV0ZUNvbmZpZ3VyYXRpb25Nb2RhbENhbmNlbEJ0bkxhYmVsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyQ29uZmlndXJhdGlvblNlcnZpY2UuZGVsZXRlKCk7XG4gICAgICB0aGlzLnJlbG9hZCQubmV4dCgpO1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxheW91dC5jb25maWd1cmF0aW9uRGVsZXRlZFN1Y2Nlc3NNc2cpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFbmNyeXB0ZWRWYWx1ZXMoY29uZmlndXJhdGlvbjogUHJvdmlkZXJQcm9wZXJ0aWVzKTogUHJvdmlkZXJQcm9wZXJ0aWVzIHtcbiAgICByZXR1cm4gbWFwVmFsdWVzKGNvbmZpZ3VyYXRpb24sIHZhbHVlID0+ICh2YWx1ZSA9PT0gJzw8RW5jcnlwdGVkPj4nID8gdW5kZWZpbmVkIDogdmFsdWUpKTtcbiAgfVxufVxuIl19