import { Injectable, InjectionToken, Injector } from '@angular/core';
import { Router } from '@angular/router';
import { ViewContext } from './router.models';
import { ContextRouteService } from './context-route.service';
import { Subject } from 'rxjs';
import { startWith, switchMap } from 'rxjs/operators';
import { fromFactories } from '../common/extension-hooks';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./context-route.service";
/**
 * A hook to use for Multi Provider extension.
 * @deprecated: Use HOOK_ROUTE
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from './context-route.service';
export const HOOK_ONCE_ROUTE = new InjectionToken('RouteFactory');
/**
 * A hook to use for Multi Provider extension.
 */
export const HOOK_ROUTE = new InjectionToken('HookRoute');
/**
 * A service which defines routes
 */
export class RouterService {
    constructor(injector, router, contextRouteService) {
        this.injector = injector;
        this.router = router;
        this.contextRouteService = contextRouteService;
        this.refreshTrigger = new Subject();
        this.state = new Map();
        this.factories = [];
        this.refreshTrigger
            .pipe(startWith(1), switchMap(() => fromFactories([
            () => this.injector.get(HOOK_ROUTE, []),
            () => this.getComponentsViaDeprecatedHook(),
            () => this.factories
        ], router, false)))
            .subscribe((routes) => {
            const toAddRoutes = routes.filter(route => {
                const path = `${route.context || ''}${route.path}`;
                const isAlreadyAdded = this.state.has(path);
                if (!isAlreadyAdded) {
                    this.state.set(path, route);
                }
                return !isAlreadyAdded;
            });
            this.addRoute(toAddRoutes);
        });
    }
    /**
     * Refresh the current context
     */
    refresh() {
        this.refreshTrigger.next(1);
        this.contextRouteService.refreshContext();
    }
    /**
     * Add a new route to the router configuration or a context.
     * @param route The route to add
     */
    addRoute(route) {
        this.addRoutes(Array.isArray(route) ? route : [route]);
    }
    /**
     * Determines if the given MO is an group or an device and returns
     * the correct href to link correctly to that MO.
     * @param groupOrDevice The MO of a group or the device.
     * @param prefix How should the link be prefixed.
     */
    getHref(groupOrDevice, prefix = '#/') {
        if (groupOrDevice.c8y_IsDeviceGroup || groupOrDevice.c8y_IsDynamicGroup) {
            return `${prefix}${ViewContext.Group.replace(':id', groupOrDevice.id)}`;
        }
        return `${prefix}${ViewContext.Device.replace(':id', groupOrDevice.id)}`;
    }
    getComponentsViaDeprecatedHook() {
        const componentsViaDeprecatedHook = this.injector.get(HOOK_ONCE_ROUTE, []);
        if (componentsViaDeprecatedHook &&
            componentsViaDeprecatedHook.length &&
            __MODE__ !== 'production') {
            console.warn('HOOK_ONCE_ROUTE is now deprecated. Use HOOK_ROUTE instead.');
        }
        return componentsViaDeprecatedHook;
    }
    addRoutes(routes) {
        const emptyRoute = this.router.config.find(r => r.path === '**');
        this.router.resetConfig([
            ...this.router.config.filter(r => r.path !== '**'),
            ...routes.map((r) => this.convertRoute(this.router.config, r)),
            emptyRoute
        ].filter(Boolean));
    }
    convertRoute(initialConfig, route) {
        if (route.context) {
            initialConfig.forEach((r) => {
                if (r.data && r.data.context === route.context) {
                    r.children = [route, ...(r.children || [])];
                }
            });
            return;
        }
        return route;
    }
}
RouterService.ɵfac = function RouterService_Factory(t) { return new (t || RouterService)(ɵngcc0.ɵɵinject(ɵngcc0.Injector), ɵngcc0.ɵɵinject(ɵngcc1.Router), ɵngcc0.ɵɵinject(ɵngcc2.ContextRouteService)); };
RouterService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RouterService_Factory() { return new RouterService(i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.ContextRouteService)); }, token: RouterService, providedIn: "root" });
RouterService.ctorParameters = () => [
    { type: Injector },
    { type: Router },
    { type: ContextRouteService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(RouterService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc0.Injector }, { type: ɵngcc1.Router }, { type: ɵngcc2.ContextRouteService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvcm91dGVyL3JvdXRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUF1QixXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFvQyxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM1RjtBQUdHO0FBQ21DO0FBbUJ0QztBQUNBO0FBQ0E7QUFDQSxHQUFHOzs7O0FBQ0gsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLElBQUksY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRWxFO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLElBQUksY0FBYyxDQUFlLFdBQVcsQ0FBQyxDQUFDO0FBRXhFO0FBQ0E7QUFDQSxHQUFHO0FBSUgsTUFBTSxPQUFPLGFBQWE7QUFBRyxJQU8zQixZQUNVLFFBQWtCLEVBQ25CLE1BQWMsRUFDYixtQkFBd0M7QUFDakQsUUFIUyxhQUFRLEdBQVIsUUFBUSxDQUFVO0FBQUMsUUFDcEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQ2Qsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtBQUNwRCxRQVRXLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUMxQyxRQUFXLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBaUIs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WUFBTSxDQUFDLENBQUMsQ0FBQztBQUNULFlBQU0sT0FBTztBQUNiLFNBQUs7QUFDTCxRQUFJLE9BQU8sS0FBSyxDQUFDO0FBQ2pCLElBQUUsQ0FBQztBQUNIOzJNQUFDO0FBQ0QsMFBBNUdLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBR2lDLFlBaERSLFFBQVE7ZUE4QzNDLGZBOUMrQyxZQUN4QyxNQUFNO0dBNkNILEVBQUUsTUFBTSxjQUNuQix6QkE5Q2tCLFlBRVYsbUJBQW1CO0FBQUc7Ozs7Ozt3SUFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgUm91dGVGYWN0b3J5LCBSb3V0ZSwgVmlld0NvbnRleHQgfSBmcm9tICcuL3JvdXRlci5tb2RlbHMnO1xuaW1wb3J0IHsgQ29udGV4dFJvdXRlU2VydmljZSB9IGZyb20gJy4vY29udGV4dC1yb3V0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFeHRlbnNpb25GYWN0b3J5LCBFeHRlbnNpb25Qb2ludCwgZnJvbUZhY3RvcmllcyB9IGZyb20gJy4uL2NvbW1vbi9leHRlbnNpb24taG9va3MnO1xuXG5kZWNsYXJlIGNvbnN0IF9fTU9ERV9fOiBzdHJpbmc7XG5cbi8qKlxuICogQW4gZXh0ZW5zaW9uIEhPT0sgY2FuIHVzZSBlaXRoZXIgYSBwdXJlIHZhbHVlOlxuICogYGBgdHlwZXNjcmlwdFxuICogIHsgcHJvdmlkZTogSE9PS19YLCB1c2VWYWx1ZTogeyAuLi5ob29rVmFsdWUgfSwgbXVsdGk6IHRydWUgfVxuICogYGBgXG4gKlxuICogT3IgYW4gYXJyYXkgdG8gZGlyZWN0bHkgcmVnaXN0ZXIgbXVsdGlwbGU6XG4gKiBgYGB0eXBlc2NyaXB0XG4gKiAgeyBwcm92aWRlOiBIT09LX1gsIHVzZVZhbHVlOiBbeyAuLi5ob29rVmFsdWVzIH1dLCBtdWx0aTogdHJ1ZSB9XG4gKiBgYGBcbiAqXG4gKiBPciBhbiBFeHRlbnNpb25GYWN0b3J5IHdoaWNoIGFsbG93cyB0byBkZWZpbmUgYSBnZXQoKSBmdW5jdGlvbi4gVGhpcyBmdW5jdGlvblxuICogZ2V0cyBjYWxsZWQgb24gZWFjaCBuYXZpZ2F0aW9uIHdpdGggdGhlIGN1cnJlbnQgcm91dGUgYW5kIGNhbiByZXR1cm4gdmFsdWVzXG4gKiBhc3luYyAob2JzZXJ2YWJsZSBvciBwcm9taXNlKS5cbiAqIGBgYHR5cGVzY3JpcHRcbiAqICB7IHByb3ZpZGU6IEhPT0tfWCwgdXNlRmFjdG9yeTogeyBnZXQ6IChyb3V0ZSkgPT4gZG9Tb21ldGhpbmdBc3luYyhyb3V0ZSkgfSwgbXVsdGk6IHRydWUgfVxuICogYGBgXG4gKi9cbmV4cG9ydCB0eXBlIFJvdXRlRXh0ZW5zaW9uID0gUm91dGUgfCBSb3V0ZVtdIHwgRXh0ZW5zaW9uRmFjdG9yeTxSb3V0ZT47XG5cbi8qKlxuICogQSBob29rIHRvIHVzZSBmb3IgTXVsdGkgUHJvdmlkZXIgZXh0ZW5zaW9uLlxuICogQGRlcHJlY2F0ZWQ6IFVzZSBIT09LX1JPVVRFXG4gKi9cbmV4cG9ydCBjb25zdCBIT09LX09OQ0VfUk9VVEUgPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ1JvdXRlRmFjdG9yeScpO1xuXG4vKipcbiAqIEEgaG9vayB0byB1c2UgZm9yIE11bHRpIFByb3ZpZGVyIGV4dGVuc2lvbi5cbiAqL1xuZXhwb3J0IGNvbnN0IEhPT0tfUk9VVEUgPSBuZXcgSW5qZWN0aW9uVG9rZW48Um91dGVGYWN0b3J5PignSG9va1JvdXRlJyk7XG5cbi8qKlxuICogQSBzZXJ2aWNlIHdoaWNoIGRlZmluZXMgcm91dGVzXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFJvdXRlclNlcnZpY2UgaW1wbGVtZW50cyBFeHRlbnNpb25Qb2ludDxSb3V0ZUV4dGVuc2lvbj4ge1xuICBpdGVtcyQ6IE9ic2VydmFibGU8Um91dGVbXT47XG4gIHJlYWRvbmx5IHJlZnJlc2hUcmlnZ2VyID0gbmV3IFN1YmplY3QoKTtcbiAgcmVhZG9ubHkgc3RhdGUgPSBuZXcgTWFwPHN0cmluZywgUm91dGU+KCk7XG5cbiAgZmFjdG9yaWVzOiBSb3V0ZUV4dGVuc2lvbltdID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHVibGljIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgY29udGV4dFJvdXRlU2VydmljZTogQ29udGV4dFJvdXRlU2VydmljZVxuICApIHtcbiAgICB0aGlzLnJlZnJlc2hUcmlnZ2VyXG4gICAgICAucGlwZShcbiAgICAgICAgc3RhcnRXaXRoKDEpLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICBmcm9tRmFjdG9yaWVzKFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAoKSA9PiB0aGlzLmluamVjdG9yLmdldChIT09LX1JPVVRFLCBbXSksXG4gICAgICAgICAgICAgICgpID0+IHRoaXMuZ2V0Q29tcG9uZW50c1ZpYURlcHJlY2F0ZWRIb29rKCksXG4gICAgICAgICAgICAgICgpID0+IHRoaXMuZmFjdG9yaWVzXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcm91dGVyLFxuICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHJvdXRlczogUm91dGVbXSkgPT4ge1xuICAgICAgICBjb25zdCB0b0FkZFJvdXRlcyA9IHJvdXRlcy5maWx0ZXIocm91dGUgPT4ge1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBgJHtyb3V0ZS5jb250ZXh0IHx8ICcnfSR7cm91dGUucGF0aH1gO1xuICAgICAgICAgIGNvbnN0IGlzQWxyZWFkeUFkZGVkID0gdGhpcy5zdGF0ZS5oYXMocGF0aCk7XG4gICAgICAgICAgaWYgKCFpc0FscmVhZHlBZGRlZCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZXQocGF0aCwgcm91dGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gIWlzQWxyZWFkeUFkZGVkO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hZGRSb3V0ZSh0b0FkZFJvdXRlcyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZyZXNoIHRoZSBjdXJyZW50IGNvbnRleHRcbiAgICovXG4gIHJlZnJlc2goKSB7XG4gICAgdGhpcy5yZWZyZXNoVHJpZ2dlci5uZXh0KDEpO1xuICAgIHRoaXMuY29udGV4dFJvdXRlU2VydmljZS5yZWZyZXNoQ29udGV4dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIG5ldyByb3V0ZSB0byB0aGUgcm91dGVyIGNvbmZpZ3VyYXRpb24gb3IgYSBjb250ZXh0LlxuICAgKiBAcGFyYW0gcm91dGUgVGhlIHJvdXRlIHRvIGFkZFxuICAgKi9cbiAgYWRkUm91dGUocm91dGU6IFJvdXRlIHwgUm91dGVbXSkge1xuICAgIHRoaXMuYWRkUm91dGVzKEFycmF5LmlzQXJyYXkocm91dGUpID8gcm91dGUgOiBbcm91dGVdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIHRoZSBnaXZlbiBNTyBpcyBhbiBncm91cCBvciBhbiBkZXZpY2UgYW5kIHJldHVybnNcbiAgICogdGhlIGNvcnJlY3QgaHJlZiB0byBsaW5rIGNvcnJlY3RseSB0byB0aGF0IE1PLlxuICAgKiBAcGFyYW0gZ3JvdXBPckRldmljZSBUaGUgTU8gb2YgYSBncm91cCBvciB0aGUgZGV2aWNlLlxuICAgKiBAcGFyYW0gcHJlZml4IEhvdyBzaG91bGQgdGhlIGxpbmsgYmUgcHJlZml4ZWQuXG4gICAqL1xuICBnZXRIcmVmKGdyb3VwT3JEZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBwcmVmaXggPSAnIy8nKTogc3RyaW5nIHtcbiAgICBpZiAoZ3JvdXBPckRldmljZS5jOHlfSXNEZXZpY2VHcm91cCB8fCBncm91cE9yRGV2aWNlLmM4eV9Jc0R5bmFtaWNHcm91cCkge1xuICAgICAgcmV0dXJuIGAke3ByZWZpeH0ke1ZpZXdDb250ZXh0Lkdyb3VwLnJlcGxhY2UoJzppZCcsIGdyb3VwT3JEZXZpY2UuaWQpfWA7XG4gICAgfVxuICAgIHJldHVybiBgJHtwcmVmaXh9JHtWaWV3Q29udGV4dC5EZXZpY2UucmVwbGFjZSgnOmlkJywgZ3JvdXBPckRldmljZS5pZCl9YDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50c1ZpYURlcHJlY2F0ZWRIb29rKCkge1xuICAgIGNvbnN0IGNvbXBvbmVudHNWaWFEZXByZWNhdGVkSG9vazogUm91dGVGYWN0b3J5W10gPSB0aGlzLmluamVjdG9yLmdldChcbiAgICAgIEhPT0tfT05DRV9ST1VURSxcbiAgICAgIFtdXG4gICAgKSBhcyBSb3V0ZUZhY3RvcnlbXTtcbiAgICBpZiAoXG4gICAgICBjb21wb25lbnRzVmlhRGVwcmVjYXRlZEhvb2sgJiZcbiAgICAgIGNvbXBvbmVudHNWaWFEZXByZWNhdGVkSG9vay5sZW5ndGggJiZcbiAgICAgIF9fTU9ERV9fICE9PSAncHJvZHVjdGlvbidcbiAgICApIHtcbiAgICAgIGNvbnNvbGUud2FybignSE9PS19PTkNFX1JPVVRFIGlzIG5vdyBkZXByZWNhdGVkLiBVc2UgSE9PS19ST1VURSBpbnN0ZWFkLicpO1xuICAgIH1cblxuICAgIHJldHVybiBjb21wb25lbnRzVmlhRGVwcmVjYXRlZEhvb2s7XG4gIH1cblxuICBwcml2YXRlIGFkZFJvdXRlcyhyb3V0ZXMpIHtcbiAgICBjb25zdCBlbXB0eVJvdXRlID0gdGhpcy5yb3V0ZXIuY29uZmlnLmZpbmQociA9PiByLnBhdGggPT09ICcqKicpO1xuICAgIHRoaXMucm91dGVyLnJlc2V0Q29uZmlnKFxuICAgICAgW1xuICAgICAgICAuLi50aGlzLnJvdXRlci5jb25maWcuZmlsdGVyKHIgPT4gci5wYXRoICE9PSAnKionKSxcbiAgICAgICAgLi4ucm91dGVzLm1hcCgocjogUm91dGUpID0+IHRoaXMuY29udmVydFJvdXRlKHRoaXMucm91dGVyLmNvbmZpZywgcikpLFxuICAgICAgICBlbXB0eVJvdXRlXG4gICAgICBdLmZpbHRlcihCb29sZWFuKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRSb3V0ZShpbml0aWFsQ29uZmlnLCByb3V0ZTogUm91dGUpIHtcbiAgICBpZiAocm91dGUuY29udGV4dCkge1xuICAgICAgaW5pdGlhbENvbmZpZy5mb3JFYWNoKChyOiBSb3V0ZSkgPT4ge1xuICAgICAgICBpZiAoci5kYXRhICYmIHIuZGF0YS5jb250ZXh0ID09PSByb3V0ZS5jb250ZXh0KSB7XG4gICAgICAgICAgci5jaGlsZHJlbiA9IFtyb3V0ZSwgLi4uKHIuY2hpbGRyZW4gfHwgW10pXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiByb3V0ZTtcbiAgfVxufVxuIl19