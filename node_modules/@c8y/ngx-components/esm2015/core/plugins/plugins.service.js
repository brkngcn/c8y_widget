import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService } from '@c8y/ngx-components/api';
import { AppStateService } from '../common/ui-state.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components/api';
import * as ɵngcc2 from '../common/ui-state.service';
export class PluginsService {
    constructor(applicationService, appState) {
        this.applicationService = applicationService;
        this.appState = appState;
    }
    listPackages() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.list({ pageSize: 2000 });
            return data.filter((app) => app.exports || (app.manifest && app.manifest.exports));
        });
    }
    listVersions(forPackage) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.binary(forPackage).listPlugins();
            return data
                .map(plugin => (Object.assign(Object.assign({}, plugin.pluginPackage), { version: plugin.pluginName })))
                .filter(plugin => plugin.exports);
        });
    }
    listInstalled(forApp, flat = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const app = yield this.getApplication(forApp);
            const c8yJson = yield this.getCumulocityJsonFile(app);
            if (flat) {
                let flatList = [];
                for (const key in c8yJson.imports) {
                    if (c8yJson.imports.hasOwnProperty(key)) {
                        flatList = [
                            ...flatList,
                            ...c8yJson.imports[key].map(imp => /@/.test(key) ? `${key}/${imp}` : `${key}@latest/${imp}`)
                        ];
                    }
                }
                return flatList;
            }
            return c8yJson.imports;
        });
    }
    addByName(addTo, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('//').pop();
            const contextPath = pluginName.split('//').shift();
            const pkg = {
                contextPath
            };
            return this.add(addTo, pkg, name);
        });
    }
    removeByName(removeFrom, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('/').pop();
            const contextPath = /@latest/.test(pluginName)
                ? pluginName.split('@').shift()
                : pluginName.split('/').shift();
            const pkg = {
                contextPath
            };
            return this.remove(removeFrom, pkg, name);
        });
    }
    add(addToApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(addToApp, fromPackage, name, true);
        });
    }
    remove(removeFromApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(removeFromApp, fromPackage, name, false);
        });
    }
    updateRemotesInCumulocityJson(app, remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.getCumulocityJsonFile(app);
            return this.applicationService.storeAppManifest(app, Object.assign(Object.assign({}, c8yJson), { remotes }));
        });
    }
    addOrRemove(addToApp, fromPackage, name, add = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const application = yield this.getApplication(addToApp);
            const pkg = yield this.getApplication(fromPackage);
            const c8yJson = yield this.getCumulocityJsonFile(application);
            // TODO: Versions?!!
            const pkgImport = new Set(c8yJson.imports[pkg.contextPath]);
            if (add) {
                pkgImport.add(name);
            }
            else {
                pkgImport.delete(name);
            }
            c8yJson.imports[pkg.contextPath] = Array.from(pkgImport);
            yield this.applicationService.storeAppManifest(application, c8yJson);
            return c8yJson;
        });
    }
    getCumulocityJsonFile(app) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.applicationService.getAppManifest(app);
            if (!c8yJson.imports) {
                c8yJson.imports = {};
            }
            return c8yJson;
        });
    }
    getApplication(app) {
        return __awaiter(this, void 0, void 0, function* () {
            if (typeof app !== 'number' && app.contextPath) {
                return app;
            }
            const { data } = yield this.applicationService.detail(app);
            return data;
        });
    }
}
PluginsService.ɵfac = function PluginsService_Factory(t) { return new (t || PluginsService)(ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService), ɵngcc0.ɵɵinject(ɵngcc2.AppStateService)); };
PluginsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: PluginsService, factory: PluginsService.ɵfac });
PluginsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: AppStateService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(PluginsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.ApplicationService }, { type: ɵngcc2.AppStateService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2lucy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL3BsdWdpbnMvcGx1Z2lucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7OztBQU03RCxNQUFNLE9BQU8sY0FBYztBQUMzQixJQUFFLFlBQ1Usa0JBQXNDLEVBQ3RDLFFBQXlCO0FBQ2xDLFFBRlMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUFDLFFBQ3ZDLGFBQVEsR0FBUixRQUFRLENBQWlCO0FBQ3JDLElBQUssQ0FBQztBQUNOLElBQ1EsWUFBWTtBQUNwQjtBQUE4RCxZQUExRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7QUFDNUUsWUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztBQUM1RixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDUSxZQUFZLENBQUMsVUFBbUI7QUFDeEM7QUFBOEQsWUFBMUQsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUNwRixZQUFJLE9BQU8sSUFBSTtBQUNmLGlCQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGlDQUFN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OztxSEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zLCBJQXBwbGljYXRpb24sIElJZGVudGlmaWVkIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VpLXN0YXRlLnNlcnZpY2UnO1xuXG50eXBlIEFwcGxpY2F0aW9uID0gSUlkZW50aWZpZWQgfCBJQXBwbGljYXRpb24gfCBudW1iZXIgfCBzdHJpbmc7XG50eXBlIFBhY2thZ2UgPSBBcHBsaWNhdGlvbjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBsdWdpbnNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFN0YXRlOiBBcHBTdGF0ZVNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIGxpc3RQYWNrYWdlcygpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3QoeyBwYWdlU2l6ZTogMjAwMCB9KTtcbiAgICByZXR1cm4gZGF0YS5maWx0ZXIoKGFwcDogYW55KSA9PiBhcHAuZXhwb3J0cyB8fCAoYXBwLm1hbmlmZXN0ICYmIGFwcC5tYW5pZmVzdC5leHBvcnRzKSk7XG4gIH1cblxuICBhc3luYyBsaXN0VmVyc2lvbnMoZm9yUGFja2FnZTogUGFja2FnZSkge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuYmluYXJ5KGZvclBhY2thZ2UpLmxpc3RQbHVnaW5zKCk7XG4gICAgcmV0dXJuIGRhdGFcbiAgICAgIC5tYXAocGx1Z2luID0+ICh7IC4uLnBsdWdpbi5wbHVnaW5QYWNrYWdlLCB2ZXJzaW9uOiBwbHVnaW4ucGx1Z2luTmFtZSB9KSlcbiAgICAgIC5maWx0ZXIocGx1Z2luID0+IHBsdWdpbi5leHBvcnRzKTtcbiAgfVxuXG4gIGFzeW5jIGxpc3RJbnN0YWxsZWQoZm9yQXBwOiBBcHBsaWNhdGlvbiwgZmxhdCA9IHRydWUpIHtcbiAgICBjb25zdCBhcHAgPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGZvckFwcCk7XG4gICAgY29uc3QgYzh5SnNvbiA9IGF3YWl0IHRoaXMuZ2V0Q3VtdWxvY2l0eUpzb25GaWxlKGFwcCk7XG4gICAgaWYgKGZsYXQpIHtcbiAgICAgIGxldCBmbGF0TGlzdCA9IFtdO1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gYzh5SnNvbi5pbXBvcnRzKSB7XG4gICAgICAgIGlmIChjOHlKc29uLmltcG9ydHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIGZsYXRMaXN0ID0gW1xuICAgICAgICAgICAgLi4uZmxhdExpc3QsXG4gICAgICAgICAgICAuLi5jOHlKc29uLmltcG9ydHNba2V5XS5tYXAoaW1wID0+XG4gICAgICAgICAgICAgIC9ALy50ZXN0KGtleSkgPyBgJHtrZXl9LyR7aW1wfWAgOiBgJHtrZXl9QGxhdGVzdC8ke2ltcH1gXG4gICAgICAgICAgICApXG4gICAgICAgICAgXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZsYXRMaXN0O1xuICAgIH1cbiAgICByZXR1cm4gYzh5SnNvbi5pbXBvcnRzO1xuICB9XG5cbiAgYXN5bmMgYWRkQnlOYW1lKGFkZFRvOiBBcHBsaWNhdGlvbiwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbmFtZSA9IHBsdWdpbk5hbWUuc3BsaXQoJy8vJykucG9wKCk7XG4gICAgY29uc3QgY29udGV4dFBhdGggPSBwbHVnaW5OYW1lLnNwbGl0KCcvLycpLnNoaWZ0KCk7XG4gICAgY29uc3QgcGtnID0ge1xuICAgICAgY29udGV4dFBhdGhcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmFkZChhZGRUbywgcGtnLCBuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUJ5TmFtZShyZW1vdmVGcm9tOiBBcHBsaWNhdGlvbiwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbmFtZSA9IHBsdWdpbk5hbWUuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBjb250ZXh0UGF0aCA9IC9AbGF0ZXN0Ly50ZXN0KHBsdWdpbk5hbWUpXG4gICAgICA/IHBsdWdpbk5hbWUuc3BsaXQoJ0AnKS5zaGlmdCgpXG4gICAgICA6IHBsdWdpbk5hbWUuc3BsaXQoJy8nKS5zaGlmdCgpO1xuXG4gICAgY29uc3QgcGtnID0ge1xuICAgICAgY29udGV4dFBhdGhcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLnJlbW92ZShyZW1vdmVGcm9tLCBwa2csIG5hbWUpO1xuICB9XG5cbiAgYXN5bmMgYWRkKGFkZFRvQXBwOiBBcHBsaWNhdGlvbiwgZnJvbVBhY2thZ2U6IFBhY2thZ2UsIG5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmFkZE9yUmVtb3ZlKGFkZFRvQXBwLCBmcm9tUGFja2FnZSwgbmFtZSwgdHJ1ZSk7XG4gIH1cblxuICBhc3luYyByZW1vdmUocmVtb3ZlRnJvbUFwcDogQXBwbGljYXRpb24sIGZyb21QYWNrYWdlOiBQYWNrYWdlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRPclJlbW92ZShyZW1vdmVGcm9tQXBwLCBmcm9tUGFja2FnZSwgbmFtZSwgZmFsc2UpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUmVtb3Rlc0luQ3VtdWxvY2l0eUpzb24oYXBwOiBJQXBwbGljYXRpb24sIHJlbW90ZXM6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucykge1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHApO1xuICAgIHJldHVybiB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5zdG9yZUFwcE1hbmlmZXN0KGFwcCwgeyAuLi5jOHlKc29uLCByZW1vdGVzIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhZGRPclJlbW92ZShhZGRUb0FwcDogQXBwbGljYXRpb24sIGZyb21QYWNrYWdlOiBQYWNrYWdlLCBuYW1lOiBzdHJpbmcsIGFkZCA9IHRydWUpIHtcbiAgICBjb25zdCBhcHBsaWNhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0QXBwbGljYXRpb24oYWRkVG9BcHApO1xuICAgIGNvbnN0IHBrZyA9IGF3YWl0IHRoaXMuZ2V0QXBwbGljYXRpb24oZnJvbVBhY2thZ2UpO1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHBsaWNhdGlvbik7XG5cbiAgICAvLyBUT0RPOiBWZXJzaW9ucz8hIVxuICAgIGNvbnN0IHBrZ0ltcG9ydCA9IG5ldyBTZXQoYzh5SnNvbi5pbXBvcnRzW3BrZy5jb250ZXh0UGF0aF0pO1xuICAgIGlmIChhZGQpIHtcbiAgICAgIHBrZ0ltcG9ydC5hZGQobmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBrZ0ltcG9ydC5kZWxldGUobmFtZSk7XG4gICAgfVxuICAgIGM4eUpzb24uaW1wb3J0c1twa2cuY29udGV4dFBhdGhdID0gQXJyYXkuZnJvbShwa2dJbXBvcnQpO1xuXG4gICAgYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2Uuc3RvcmVBcHBNYW5pZmVzdChhcHBsaWNhdGlvbiwgYzh5SnNvbik7XG4gICAgcmV0dXJuIGM4eUpzb247XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEN1bXVsb2NpdHlKc29uRmlsZShhcHA6IElBcHBsaWNhdGlvbikge1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5nZXRBcHBNYW5pZmVzdChhcHApO1xuICAgIGlmICghYzh5SnNvbi5pbXBvcnRzKSB7XG4gICAgICBjOHlKc29uLmltcG9ydHMgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIGM4eUpzb247XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEFwcGxpY2F0aW9uKGFwcDogQXBwbGljYXRpb24pOiBQcm9taXNlPElBcHBsaWNhdGlvbj4ge1xuICAgIGlmICh0eXBlb2YgYXBwICE9PSAnbnVtYmVyJyAmJiAoYXBwIGFzIElBcHBsaWNhdGlvbikuY29udGV4dFBhdGgpIHtcbiAgICAgIHJldHVybiBhcHAgYXMgSUFwcGxpY2F0aW9uO1xuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmRldGFpbChhcHApO1xuICAgIHJldHVybiBkYXRhO1xuICB9XG59XG4iXX0=