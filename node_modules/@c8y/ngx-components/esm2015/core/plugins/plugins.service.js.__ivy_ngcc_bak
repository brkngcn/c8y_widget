import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService } from '@c8y/ngx-components/api';
import { AppStateService } from '../common/ui-state.service';
export class PluginsService {
    constructor(applicationService, appState) {
        this.applicationService = applicationService;
        this.appState = appState;
    }
    listPackages() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.list({ pageSize: 2000 });
            return data.filter((app) => app.exports || (app.manifest && app.manifest.exports));
        });
    }
    listVersions(forPackage) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.binary(forPackage).listPlugins();
            return data
                .map(plugin => (Object.assign(Object.assign({}, plugin.pluginPackage), { version: plugin.pluginName })))
                .filter(plugin => plugin.exports);
        });
    }
    listInstalled(forApp, flat = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const app = yield this.getApplication(forApp);
            const c8yJson = yield this.getCumulocityJsonFile(app);
            if (flat) {
                let flatList = [];
                for (const key in c8yJson.imports) {
                    if (c8yJson.imports.hasOwnProperty(key)) {
                        flatList = [
                            ...flatList,
                            ...c8yJson.imports[key].map(imp => /@/.test(key) ? `${key}/${imp}` : `${key}@latest/${imp}`)
                        ];
                    }
                }
                return flatList;
            }
            return c8yJson.imports;
        });
    }
    addByName(addTo, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('//').pop();
            const contextPath = pluginName.split('//').shift();
            const pkg = {
                contextPath
            };
            return this.add(addTo, pkg, name);
        });
    }
    removeByName(removeFrom, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('/').pop();
            const contextPath = /@latest/.test(pluginName)
                ? pluginName.split('@').shift()
                : pluginName.split('/').shift();
            const pkg = {
                contextPath
            };
            return this.remove(removeFrom, pkg, name);
        });
    }
    add(addToApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(addToApp, fromPackage, name, true);
        });
    }
    remove(removeFromApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(removeFromApp, fromPackage, name, false);
        });
    }
    updateRemotesInCumulocityJson(app, remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.getCumulocityJsonFile(app);
            return this.applicationService.storeAppManifest(app, Object.assign(Object.assign({}, c8yJson), { remotes }));
        });
    }
    addOrRemove(addToApp, fromPackage, name, add = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const application = yield this.getApplication(addToApp);
            const pkg = yield this.getApplication(fromPackage);
            const c8yJson = yield this.getCumulocityJsonFile(application);
            // TODO: Versions?!!
            const pkgImport = new Set(c8yJson.imports[pkg.contextPath]);
            if (add) {
                pkgImport.add(name);
            }
            else {
                pkgImport.delete(name);
            }
            c8yJson.imports[pkg.contextPath] = Array.from(pkgImport);
            yield this.applicationService.storeAppManifest(application, c8yJson);
            return c8yJson;
        });
    }
    getCumulocityJsonFile(app) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.applicationService.getAppManifest(app);
            if (!c8yJson.imports) {
                c8yJson.imports = {};
            }
            return c8yJson;
        });
    }
    getApplication(app) {
        return __awaiter(this, void 0, void 0, function* () {
            if (typeof app !== 'number' && app.contextPath) {
                return app;
            }
            const { data } = yield this.applicationService.detail(app);
            return data;
        });
    }
}
PluginsService.decorators = [
    { type: Injectable }
];
PluginsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: AppStateService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2lucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9wbHVnaW5zL3BsdWdpbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFNN0QsTUFBTSxPQUFPLGNBQWM7SUFDekIsWUFDVSxrQkFBc0MsRUFDdEMsUUFBeUI7UUFEekIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUNoQyxDQUFDO0lBRUUsWUFBWTs7WUFDaEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3hFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzFGLENBQUM7S0FBQTtJQUVLLFlBQVksQ0FBQyxVQUFtQjs7WUFDcEMsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoRixPQUFPLElBQUk7aUJBQ1IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsaUNBQU0sTUFBTSxDQUFDLGFBQWEsS0FBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLFVBQVUsSUFBRyxDQUFDO2lCQUN4RSxN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QUFHLEVBQUUsQ0FBQzthQUN0QjtZQUNELE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7S0FBQTtJQUVhLGNBQWMsQ0FBQyxHQUFnQjs7WUFDM0MsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUssR0FBb0IsQ0FBQyxXQUFXLEVBQUU7Z0JBQ2hFLE9BQU8sR0FBbUIsQ0FBQzthQUM1QjtZQUNELE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0tBQUE7OztZQXpHRixVQUFVOzs7WUFORixrQkFBa0I7WUFDbEIsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucywgSUFwcGxpY2F0aW9uLCBJSWRlbnRpZmllZCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFwcGxpY2F0aW9uU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvYXBpJztcbmltcG9ydCB7IEFwcFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlJztcblxudHlwZSBBcHBsaWNhdGlvbiA9IElJZGVudGlmaWVkIHwgSUFwcGxpY2F0aW9uIHwgbnVtYmVyIHwgc3RyaW5nO1xudHlwZSBQYWNrYWdlID0gQXBwbGljYXRpb247XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQbHVnaW5zU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYXBwbGljYXRpb25TZXJ2aWNlOiBBcHBsaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBTdGF0ZTogQXBwU3RhdGVTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBsaXN0UGFja2FnZXMoKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0KHsgcGFnZVNpemU6IDIwMDAgfSk7XG4gICAgcmV0dXJuIGRhdGEuZmlsdGVyKChhcHA6IGFueSkgPT4gYXBwLmV4cG9ydHMgfHwgKGFwcC5tYW5pZmVzdCAmJiBhcHAubWFuaWZlc3QuZXhwb3J0cykpO1xuICB9XG5cbiAgYXN5bmMgbGlzdFZlcnNpb25zKGZvclBhY2thZ2U6IFBhY2thZ2UpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmJpbmFyeShmb3JQYWNrYWdlKS5saXN0UGx1Z2lucygpO1xuICAgIHJldHVybiBkYXRhXG4gICAgICAubWFwKHBsdWdpbiA9PiAoeyAuLi5wbHVnaW4ucGx1Z2luUGFja2FnZSwgdmVyc2lvbjogcGx1Z2luLnBsdWdpbk5hbWUgfSkpXG4gICAgICAuZmlsdGVyKHBsdWdpbiA9PiBwbHVnaW4uZXhwb3J0cyk7XG4gIH1cblxuICBhc3luYyBsaXN0SW5zdGFsbGVkKGZvckFwcDogQXBwbGljYXRpb24sIGZsYXQgPSB0cnVlKSB7XG4gICAgY29uc3QgYXBwID0gYXdhaXQgdGhpcy5nZXRBcHBsaWNhdGlvbihmb3JBcHApO1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHApO1xuICAgIGlmIChmbGF0KSB7XG4gICAgICBsZXQgZmxhdExpc3QgPSBbXTtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGM4eUpzb24uaW1wb3J0cykge1xuICAgICAgICBpZiAoYzh5SnNvbi5pbXBvcnRzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICBmbGF0TGlzdCA9IFtcbiAgICAgICAgICAgIC4uLmZsYXRMaXN0LFxuICAgICAgICAgICAgLi4uYzh5SnNvbi5pbXBvcnRzW2tleV0ubWFwKGltcCA9PlxuICAgICAgICAgICAgICAvQC8udGVzdChrZXkpID8gYCR7a2V5fS8ke2ltcH1gIDogYCR7a2V5fUBsYXRlc3QvJHtpbXB9YFxuICAgICAgICAgICAgKVxuICAgICAgICAgIF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmbGF0TGlzdDtcbiAgICB9XG4gICAgcmV0dXJuIGM4eUpzb24uaW1wb3J0cztcbiAgfVxuXG4gIGFzeW5jIGFkZEJ5TmFtZShhZGRUbzogQXBwbGljYXRpb24sIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IG5hbWUgPSBwbHVnaW5OYW1lLnNwbGl0KCcvLycpLnBvcCgpO1xuICAgIGNvbnN0IGNvbnRleHRQYXRoID0gcGx1Z2luTmFtZS5zcGxpdCgnLy8nKS5zaGlmdCgpO1xuICAgIGNvbnN0IHBrZyA9IHtcbiAgICAgIGNvbnRleHRQYXRoXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5hZGQoYWRkVG8sIHBrZywgbmFtZSk7XG4gIH1cblxuICBhc3luYyByZW1vdmVCeU5hbWUocmVtb3ZlRnJvbTogQXBwbGljYXRpb24sIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IG5hbWUgPSBwbHVnaW5OYW1lLnNwbGl0KCcvJykucG9wKCk7XG4gICAgY29uc3QgY29udGV4dFBhdGggPSAvQGxhdGVzdC8udGVzdChwbHVnaW5OYW1lKVxuICAgICAgPyBwbHVnaW5OYW1lLnNwbGl0KCdAJykuc2hpZnQoKVxuICAgICAgOiBwbHVnaW5OYW1lLnNwbGl0KCcvJykuc2hpZnQoKTtcblxuICAgIGNvbnN0IHBrZyA9IHtcbiAgICAgIGNvbnRleHRQYXRoXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5yZW1vdmUocmVtb3ZlRnJvbSwgcGtnLCBuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIGFkZChhZGRUb0FwcDogQXBwbGljYXRpb24sIGZyb21QYWNrYWdlOiBQYWNrYWdlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRPclJlbW92ZShhZGRUb0FwcCwgZnJvbVBhY2thZ2UsIG5hbWUsIHRydWUpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKHJlbW92ZUZyb21BcHA6IEFwcGxpY2F0aW9uLCBmcm9tUGFja2FnZTogUGFja2FnZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkT3JSZW1vdmUocmVtb3ZlRnJvbUFwcCwgZnJvbVBhY2thZ2UsIG5hbWUsIGZhbHNlKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVJlbW90ZXNJbkN1bXVsb2NpdHlKc29uKGFwcDogSUFwcGxpY2F0aW9uLCByZW1vdGVzOiBBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnMpIHtcbiAgICBjb25zdCBjOHlKc29uID0gYXdhaXQgdGhpcy5nZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwKTtcbiAgICByZXR1cm4gdGhpcy5hcHBsaWNhdGlvblNlcnZpY2Uuc3RvcmVBcHBNYW5pZmVzdChhcHAsIHsgLi4uYzh5SnNvbiwgcmVtb3RlcyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYWRkT3JSZW1vdmUoYWRkVG9BcHA6IEFwcGxpY2F0aW9uLCBmcm9tUGFja2FnZTogUGFja2FnZSwgbmFtZTogc3RyaW5nLCBhZGQgPSB0cnVlKSB7XG4gICAgY29uc3QgYXBwbGljYXRpb24gPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGFkZFRvQXBwKTtcbiAgICBjb25zdCBwa2cgPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGZyb21QYWNrYWdlKTtcbiAgICBjb25zdCBjOHlKc29uID0gYXdhaXQgdGhpcy5nZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwbGljYXRpb24pO1xuXG4gICAgLy8gVE9ETzogVmVyc2lvbnM/ISFcbiAgICBjb25zdCBwa2dJbXBvcnQgPSBuZXcgU2V0KGM4eUpzb24uaW1wb3J0c1twa2cuY29udGV4dFBhdGhdKTtcbiAgICBpZiAoYWRkKSB7XG4gICAgICBwa2dJbXBvcnQuYWRkKG5hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwa2dJbXBvcnQuZGVsZXRlKG5hbWUpO1xuICAgIH1cbiAgICBjOHlKc29uLmltcG9ydHNbcGtnLmNvbnRleHRQYXRoXSA9IEFycmF5LmZyb20ocGtnSW1wb3J0KTtcblxuICAgIGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLnN0b3JlQXBwTWFuaWZlc3QoYXBwbGljYXRpb24sIGM4eUpzb24pO1xuICAgIHJldHVybiBjOHlKc29uO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwOiBJQXBwbGljYXRpb24pIHtcbiAgICBjb25zdCBjOHlKc29uID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZ2V0QXBwTWFuaWZlc3QoYXBwKTtcbiAgICBpZiAoIWM4eUpzb24uaW1wb3J0cykge1xuICAgICAgYzh5SnNvbi5pbXBvcnRzID0ge307XG4gICAgfVxuICAgIHJldHVybiBjOHlKc29uO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRBcHBsaWNhdGlvbihhcHA6IEFwcGxpY2F0aW9uKTogUHJvbWlzZTxJQXBwbGljYXRpb24+IHtcbiAgICBpZiAodHlwZW9mIGFwcCAhPT0gJ251bWJlcicgJiYgKGFwcCBhcyBJQXBwbGljYXRpb24pLmNvbnRleHRQYXRoKSB7XG4gICAgICByZXR1cm4gYXBwIGFzIElBcHBsaWNhdGlvbjtcbiAgICB9XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5kZXRhaWwoYXBwKTtcbiAgICByZXR1cm4gZGF0YTtcbiAgfVxufVxuIl19