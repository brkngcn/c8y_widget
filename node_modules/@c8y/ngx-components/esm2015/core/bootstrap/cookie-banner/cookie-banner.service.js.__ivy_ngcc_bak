import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { OptionsService } from '../../common/options.service';
import { gettext } from '../../i18n/gettext';
import * as i0 from "@angular/core";
import * as i1 from "../../common/options.service";
/**
 * This service is handling the cookie banner and cookie preferences related logic.
 */
export class CookieBannerService {
    constructor(options) {
        this.options = options;
        this.STORAGE_KEY = 'acceptCookieNotice';
        this.COOKIE_BANNER = 'cookieBanner';
        this.PREVIEW_COOKIE_BANNER = 'previewCookieBanner';
        this.IS_PREVIEW = 'preview';
        this.COOKIE_PREFERENCES_CONFIG = 'cookiePreferences';
        this.isCookieBannerShowed$ = new Subject();
        this.cookieDescriptions = {
            required: gettext("These cookies are required to enable core site functionality. They perform a task or operation without which a site's functionality would not be possible."),
            functional: gettext('These cookies are used to track site usage and to process my personal data to measure and improve usability and performance. We will neither forward this data to any third party nor use this data for direct marketing purposes. I recognize that I can opt in and out of these cookies at any time.'),
            marketing: gettext('These cookies are used to target advertising to a user.')
        };
    }
    /**
     * Returns Cookie preferences configuration.
     * @returns {object} Return an object with cookie preferences configuration defined in application options.
     */
    getCookiePreferencesConfig() {
        return this.options.get(this.COOKIE_PREFERENCES_CONFIG);
    }
    /**
     * Returns Cookie banner configuration.
     * @returns {object} Return an object with cookie banner configuration defined in application options.
     */
    getCookieBannerSettings() {
        let cookieSettings;
        if (this.isPreviewMode()) {
            cookieSettings = this.options.get(this.PREVIEW_COOKIE_BANNER);
            if (cookieSettings) {
                return cookieSettings;
            }
        }
        cookieSettings = this.options.get(this.COOKIE_BANNER) || {};
        return cookieSettings;
    }
    /**
     * Converts the cookie preferences to boolean. Sets the cookie preferences configuration in local storage.
     * @param {object} cookiePreferences Object with cookie preferences configuration
     */
    setCookies(cookiePreferences) {
        const cookiesToSet = Object.assign({}, cookiePreferences);
        Object.entries(cookiesToSet).forEach(([cookieName, cookieValue]) => {
            cookiesToSet[cookieName] = typeof cookieValue === 'string' ? true : cookieValue;
        });
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cookiesToSet));
    }
    /**
     * Verifies that cookie banner should be shown.
     * @returns {boolean} Returns if the cookie banner should be shown.
     */
    shouldShowCookieBanner() {
        const settings = this.getCookieBannerSettings();
        const shouldShowDefault = !!settings.cookieBannerText && !this.getUserCookiePreferences();
        if (this.isPreviewMode()) {
            return !(settings && settings.cookieBannerDisabled);
        }
        return shouldShowDefault;
    }
    /**
     * Gets the cookie preferences configuration from local storage.
     * @returns {object} Object with cookie preferences configuration.
     */
    getUserCookiePreferences() {
        return JSON.parse(localStorage.getItem(this.STORAGE_KEY));
    }
    /**
     * Verifies that cookie preferences configuration is defined.
     * @returns {boolean} Returns if the cookie preferences configuration is defined.
     */
    isConfigCookiePreferencesDefined() {
        return !!this.getCookiePreferencesConfig();
    }
    /**
     * Verifies that functional cookies are enabled.
     * @returns {boolean} True when functional cookies are enabled.
     */
    isFunctionalCookieEnabled() {
        const { functional } = this.getUserCookiePreferences() || {};
        return functional === true;
    }
    /**
     * Description of cookies.
     * @param {'required' | 'functional' | 'marketing'} cookieType Takes one of the following options: 'required', 'functional', 'marketing'.
     * @returns {string} The default cookie description, if not explicitly defined in application options.
     */
    getCookieDescription(cookieType) {
        const cookieBannerConfigSettings = this.getCookiePreferencesConfig();
        return typeof cookieBannerConfigSettings[cookieType] === 'string'
            ? cookieBannerConfigSettings[cookieType]
            : this.cookieDescriptions[cookieType];
    }
    /**
     * Transforms cookie preferences configuration object to an array of cookie preferences objects. Each object in returned array contains cookie 'name', 'value' and 'isReadonly' property.
     * @param {object} cookiePreferences.
     * @returns {Array} Array shows if the cookie is Readonly.
     */
    transformCookiePreferencesToList(cookiePreferences) {
        return Object.entries(cookiePreferences).map(([name, value]) => {
            const isReadonly = name === 'required';
            return { name, value, isReadonly };
        });
    }
    /**
     * Transforms an array of cookie preferences objects to cookie preferences configuration object.
     * @param {Array} cookiePreferencesList Array of cookie preferences.
     * @returns {object} An object with cookie preferences configuration.
     */
    transformCookiePreferencesListToCookiePreferences(cookiePreferencesList) {
        return cookiePreferencesList.reduce((cookiePref, cookie) => {
            const key = cookie.name;
            cookiePref[key] = cookie.value;
            return cookiePref;
        }, {});
    }
    isPreviewMode() {
        // params from url are automatically resolved during bootstrap as string options, see: packages/cli/src/app-bootstrap/options.ts
        return this.options.get(this.IS_PREVIEW, false, true);
    }
}
CookieBannerService.ɵprov = i0.ɵɵdefineInjectable({ factory: function CookieBannerService_Factory() { return new CookieBannerService(i0.ɵɵinject(i1.OptionsService)); }, token: CookieBannerService, providedIn: "root" });
CookieBannerService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
CookieBannerService.ctorParameters = () => [
    { type: OptionsService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29va2llLWJhbm5lci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vY29yZS9ib290c3RyYXAvY29va2llLWJhbm5lci9jb29raWUtYmFubmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7OztBQUc3Qzs7R0FFRztBQUlILE1BQU0sT0FBTyxtQkFBbUI7SUFrQjlCLFlBQW9CLE9BQXVCO1FBQXZCLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBakJsQyxnQkFBVyxHQUFXLG9CQUFvQixDQUFDO1FBQzNDLGtCQUFhLEdBQUcsY0FBYyxDQUFDO1FBQy9CLDBCQUFxQixHQUFHLHFCQUFxQixDQUFDO1FBQzlDLGVBQVUsR0FBRyxTQUFTLENBQUM7UUFDdkIsOEJBQXlCLEdBQUcsbUJBQW1CLENBQUM7UUFDekQsMEJBQXFCLEdBQXFCLElBQUksT0FBTyxFQUFFLENBQUM7UUFFeEQsdUJBQWtCLEdBQUc7WUFDbkIsUUFBUSxFQUFFLE9BQU8sQ0FDZiw0SkFBNEosQ0FDN0o7WUFDRCxVQUFVLEVBQUUsT0FBTyxDQUNqQix3U0FBd1MsQ0FDelM7WUFDRCxTQUFTLEVBQUUsT0FBTyxDQUFDLHlEQUF5RCxDQUFDO1NBQzlFLENBQUM7SUFFNEMsQ0FBQztJQUUvQzs7O09BR0c7SUFDSCwwQkFBMEI7UUFDeEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsdUJBQXVCO1FBQ3JCLElBQUksY0FBb0Ms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RCxDQUMvQyxxQkFBK0I7UUFFL0IsT0FBTyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUE2QixFQUFFLE1BQWMsRUFBRSxFQUFFO1lBQ3BGLE1BQU0sR0FBRyxHQUFXLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDL0IsT0FBTyxVQUFVLENBQUM7UUFDcEIsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsQ0FBQztJQUVPLGFBQWE7UUFDbkIsZ0lBQWdJO1FBQ2hJLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEQsQ0FBQzs7OztZQTNJRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQVRRLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4uLy4uL2NvbW1vbi9vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uLy4uL2kxOG4vZ2V0dGV4dCc7XG5pbXBvcnQgeyBDb29raWUsIENvb2tpZUJhbm5lclNldHRpbmdzLCBDb29raWVQcmVmZXJlbmNlcyB9IGZyb20gJy4vY29va2llLWJhbm5lci5tb2RlbCc7XG5cbi8qKlxuICogVGhpcyBzZXJ2aWNlIGlzIGhhbmRsaW5nIHRoZSBjb29raWUgYmFubmVyIGFuZCBjb29raWUgcHJlZmVyZW5jZXMgcmVsYXRlZCBsb2dpYy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ29va2llQmFubmVyU2VydmljZSB7XG4gIHJlYWRvbmx5IFNUT1JBR0VfS0VZOiBzdHJpbmcgPSAnYWNjZXB0Q29va2llTm90aWNlJztcbiAgcmVhZG9ubHkgQ09PS0lFX0JBTk5FUiA9ICdjb29raWVCYW5uZXInO1xuICByZWFkb25seSBQUkVWSUVXX0NPT0tJRV9CQU5ORVIgPSAncHJldmlld0Nvb2tpZUJhbm5lcic7XG4gIHJlYWRvbmx5IElTX1BSRVZJRVcgPSAncHJldmlldyc7XG4gIHJlYWRvbmx5IENPT0tJRV9QUkVGRVJFTkNFU19DT05GSUcgPSAnY29va2llUHJlZmVyZW5jZXMnO1xuICBpc0Nvb2tpZUJhbm5lclNob3dlZCQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvb2tpZURlc2NyaXB0aW9ucyA9IHtcbiAgICByZXF1aXJlZDogZ2V0dGV4dChcbiAgICAgIFwiVGhlc2UgY29va2llcyBhcmUgcmVxdWlyZWQgdG8gZW5hYmxlIGNvcmUgc2l0ZSBmdW5jdGlvbmFsaXR5LiBUaGV5IHBlcmZvcm0gYSB0YXNrIG9yIG9wZXJhdGlvbiB3aXRob3V0IHdoaWNoIGEgc2l0ZSdzIGZ1bmN0aW9uYWxpdHkgd291bGQgbm90IGJlIHBvc3NpYmxlLlwiXG4gICAgKSxcbiAgICBmdW5jdGlvbmFsOiBnZXR0ZXh0KFxuICAgICAgJ1RoZXNlIGNvb2tpZXMgYXJlIHVzZWQgdG8gdHJhY2sgc2l0ZSB1c2FnZSBhbmQgdG8gcHJvY2VzcyBteSBwZXJzb25hbCBkYXRhIHRvIG1lYXN1cmUgYW5kIGltcHJvdmUgdXNhYmlsaXR5IGFuZCBwZXJmb3JtYW5jZS4gV2Ugd2lsbCBuZWl0aGVyIGZvcndhcmQgdGhpcyBkYXRhIHRvIGFueSB0aGlyZCBwYXJ0eSBub3IgdXNlIHRoaXMgZGF0YSBmb3IgZGlyZWN0IG1hcmtldGluZyBwdXJwb3Nlcy4gSSByZWNvZ25pemUgdGhhdCBJIGNhbiBvcHQgaW4gYW5kIG91dCBvZiB0aGVzZSBjb29raWVzIGF0IGFueSB0aW1lLidcbiAgICApLFxuICAgIG1hcmtldGluZzogZ2V0dGV4dCgnVGhlc2UgY29va2llcyBhcmUgdXNlZCB0byB0YXJnZXQgYWR2ZXJ0aXNpbmcgdG8gYSB1c2VyLicpXG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zU2VydmljZSkge31cblxuICAvKipcbiAgICogUmV0dXJucyBDb29raWUgcHJlZmVyZW5jZXMgY29uZmlndXJhdGlvbi5cbiAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJuIGFuIG9iamVjdCB3aXRoIGNvb2tpZSBwcmVmZXJlbmNlcyBjb25maWd1cmF0aW9uIGRlZmluZWQgaW4gYXBwbGljYXRpb24gb3B0aW9ucy5cbiAgICovXG4gIGdldENvb2tpZVByZWZlcmVuY2VzQ29uZmlnKCk6IENvb2tpZVByZWZlcmVuY2VzIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmdldCh0aGlzLkNPT0tJRV9QUkVGRVJFTkNFU19DT05GSUcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgQ29va2llIGJhbm5lciBjb25maWd1cmF0aW9uLlxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm4gYW4gb2JqZWN0IHdpdGggY29va2llIGJhbm5lciBjb25maWd1cmF0aW9uIGRlZmluZWQgaW4gYXBwbGljYXRpb24gb3B0aW9ucy5cbiAgICovXG4gIGdldENvb2tpZUJhbm5lclNldHRpbmdzKCk6IENvb2tpZUJhbm5lclNldHRpbmdzIHtcbiAgICBsZXQgY29va2llU2V0dGluZ3M6IENvb2tpZUJhbm5lclNldHRpbmdzO1xuICAgIGlmICh0aGlzLmlzUHJldmlld01vZGUoKSkge1xuICAgICAgY29va2llU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnMuZ2V0KHRoaXMuUFJFVklFV19DT09LSUVfQkFOTkVSKTtcbiAgICAgIGlmIChjb29raWVTZXR0aW5ncykge1xuICAgICAgICByZXR1cm4gY29va2llU2V0dGluZ3M7XG4gICAgICB9XG4gICAgfVxuICAgIGNvb2tpZVNldHRpbmdzID0gdGhpcy5vcHRpb25zLmdldCh0aGlzLkNPT0tJRV9CQU5ORVIpIHx8IHt9O1xuICAgIHJldHVybiBjb29raWVTZXR0aW5ncztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgY29va2llIHByZWZlcmVuY2VzIHRvIGJvb2xlYW4uIFNldHMgdGhlIGNvb2tpZSBwcmVmZXJlbmNlcyBjb25maWd1cmF0aW9uIGluIGxvY2FsIHN0b3JhZ2UuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb29raWVQcmVmZXJlbmNlcyBPYmplY3Qgd2l0aCBjb29raWUgcHJlZmVyZW5jZXMgY29uZmlndXJhdGlvblxuICAgKi9cbiAgc2V0Q29va2llcyhjb29raWVQcmVmZXJlbmNlczogQ29va2llUHJlZmVyZW5jZXMpIHtcbiAgICBjb25zdCBjb29raWVzVG9TZXQgPSB7IC4uLmNvb2tpZVByZWZlcmVuY2VzIH07XG4gICAgT2JqZWN0LmVudHJpZXMoY29va2llc1RvU2V0KS5mb3JFYWNoKChbY29va2llTmFtZSwgY29va2llVmFsdWVdKSA9PiB7XG4gICAgICBjb29raWVzVG9TZXRbY29va2llTmFtZV0gPSB0eXBlb2YgY29va2llVmFsdWUgPT09ICdzdHJpbmcnID8gdHJ1ZSA6IGNvb2tpZVZhbHVlO1xuICAgIH0pO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuU1RPUkFHRV9LRVksIEpTT04uc3RyaW5naWZ5KGNvb2tpZXNUb1NldCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWVzIHRoYXQgY29va2llIGJhbm5lciBzaG91bGQgYmUgc2hvd24uXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGlmIHRoZSBjb29raWUgYmFubmVyIHNob3VsZCBiZSBzaG93bi5cbiAgICovXG4gIHNob3VsZFNob3dDb29raWVCYW5uZXIoKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmdldENvb2tpZUJhbm5lclNldHRpbmdzKCk7XG4gICAgY29uc3Qgc2hvdWxkU2hvd0RlZmF1bHQgPSAhIXNldHRpbmdzLmNvb2tpZUJhbm5lclRleHQgJiYgIXRoaXMuZ2V0VXNlckNvb2tpZVByZWZlcmVuY2VzKCk7XG4gICAgaWYgKHRoaXMuaXNQcmV2aWV3TW9kZSgpKSB7XG4gICAgICByZXR1cm4gIShzZXR0aW5ncyAmJiBzZXR0aW5ncy5jb29raWVCYW5uZXJEaXNhYmxlZCk7XG4gICAgfVxuICAgIHJldHVybiBzaG91bGRTaG93RGVmYXVsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBjb29raWUgcHJlZmVyZW5jZXMgY29uZmlndXJhdGlvbiBmcm9tIGxvY2FsIHN0b3JhZ2UuXG4gICAqIEByZXR1cm5zIHtvYmplY3R9IE9iamVjdCB3aXRoIGNvb2tpZSBwcmVmZXJlbmNlcyBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgZ2V0VXNlckNvb2tpZVByZWZlcmVuY2VzKCk6IENvb2tpZVByZWZlcmVuY2VzIHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLlNUT1JBR0VfS0VZKSk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpZXMgdGhhdCBjb29raWUgcHJlZmVyZW5jZXMgY29uZmlndXJhdGlvbiBpcyBkZWZpbmVkLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBpZiB0aGUgY29va2llIHByZWZlcmVuY2VzIGNvbmZpZ3VyYXRpb24gaXMgZGVmaW5lZC5cbiAgICovXG4gIGlzQ29uZmlnQ29va2llUHJlZmVyZW5jZXNEZWZpbmVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMuZ2V0Q29va2llUHJlZmVyZW5jZXNDb25maWcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmllcyB0aGF0IGZ1bmN0aW9uYWwgY29va2llcyBhcmUgZW5hYmxlZC5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgd2hlbiBmdW5jdGlvbmFsIGNvb2tpZXMgYXJlIGVuYWJsZWQuXG4gICAqL1xuICBpc0Z1bmN0aW9uYWxDb29raWVFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgZnVuY3Rpb25hbCB9OiBDb29raWVQcmVmZXJlbmNlcyA9IHRoaXMuZ2V0VXNlckNvb2tpZVByZWZlcmVuY2VzKCkgfHwge307XG4gICAgcmV0dXJuIGZ1bmN0aW9uYWwgPT09IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogRGVzY3JpcHRpb24gb2YgY29va2llcy5cbiAgICogQHBhcmFtIHsncmVxdWlyZWQnIHwgJ2Z1bmN0aW9uYWwnIHwgJ21hcmtldGluZyd9IGNvb2tpZVR5cGUgVGFrZXMgb25lIG9mIHRoZSBmb2xsb3dpbmcgb3B0aW9uczogJ3JlcXVpcmVkJywgJ2Z1bmN0aW9uYWwnLCAnbWFya2V0aW5nJy5cbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgY29va2llIGRlc2NyaXB0aW9uLCBpZiBub3QgZXhwbGljaXRseSBkZWZpbmVkIGluIGFwcGxpY2F0aW9uIG9wdGlvbnMuXG4gICAqL1xuICBnZXRDb29raWVEZXNjcmlwdGlvbihjb29raWVUeXBlOiAncmVxdWlyZWQnIHwgJ2Z1bmN0aW9uYWwnIHwgJ21hcmtldGluZycpOiBzdHJpbmcge1xuICAgIGNvbnN0IGNvb2tpZUJhbm5lckNvbmZpZ1NldHRpbmdzID0gdGhpcy5nZXRDb29raWVQcmVmZXJlbmNlc0NvbmZpZygpO1xuICAgIHJldHVybiB0eXBlb2YgY29va2llQmFubmVyQ29uZmlnU2V0dGluZ3NbY29va2llVHlwZV0gPT09ICdzdHJpbmcnXG4gICAgICA/IGNvb2tpZUJhbm5lckNvbmZpZ1NldHRpbmdzW2Nvb2tpZVR5cGVdXG4gICAgICA6IHRoaXMuY29va2llRGVzY3JpcHRpb25zW2Nvb2tpZVR5cGVdO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgY29va2llIHByZWZlcmVuY2VzIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRvIGFuIGFycmF5IG9mIGNvb2tpZSBwcmVmZXJlbmNlcyBvYmplY3RzLiBFYWNoIG9iamVjdCBpbiByZXR1cm5lZCBhcnJheSBjb250YWlucyBjb29raWUgJ25hbWUnLCAndmFsdWUnIGFuZCAnaXNSZWFkb25seScgcHJvcGVydHkuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb29raWVQcmVmZXJlbmNlcy5cbiAgICogQHJldHVybnMge0FycmF5fSBBcnJheSBzaG93cyBpZiB0aGUgY29va2llIGlzIFJlYWRvbmx5LlxuICAgKi9cbiAgdHJhbnNmb3JtQ29va2llUHJlZmVyZW5jZXNUb0xpc3QoY29va2llUHJlZmVyZW5jZXM6IENvb2tpZVByZWZlcmVuY2VzKTogQ29va2llW10ge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhjb29raWVQcmVmZXJlbmNlcykubWFwKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICBjb25zdCBpc1JlYWRvbmx5ID0gbmFtZSA9PT0gJ3JlcXVpcmVkJztcbiAgICAgIHJldHVybiB7IG5hbWUsIHZhbHVlLCBpc1JlYWRvbmx5IH07XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtcyBhbiBhcnJheSBvZiBjb29raWUgcHJlZmVyZW5jZXMgb2JqZWN0cyB0byBjb29raWUgcHJlZmVyZW5jZXMgY29uZmlndXJhdGlvbiBvYmplY3QuXG4gICAqIEBwYXJhbSB7QXJyYXl9IGNvb2tpZVByZWZlcmVuY2VzTGlzdCBBcnJheSBvZiBjb29raWUgcHJlZmVyZW5jZXMuXG4gICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIG9iamVjdCB3aXRoIGNvb2tpZSBwcmVmZXJlbmNlcyBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgdHJhbnNmb3JtQ29va2llUHJlZmVyZW5jZXNMaXN0VG9Db29raWVQcmVmZXJlbmNlcyhcbiAgICBjb29raWVQcmVmZXJlbmNlc0xpc3Q6IENvb2tpZVtdXG4gICk6IENvb2tpZVByZWZlcmVuY2VzIHtcbiAgICByZXR1cm4gY29va2llUHJlZmVyZW5jZXNMaXN0LnJlZHVjZSgoY29va2llUHJlZjogQ29va2llUHJlZmVyZW5jZXMsIGNvb2tpZTogQ29va2llKSA9PiB7XG4gICAgICBjb25zdCBrZXk6IHN0cmluZyA9IGNvb2tpZS5uYW1lO1xuICAgICAgY29va2llUHJlZltrZXldID0gY29va2llLnZhbHVlO1xuICAgICAgcmV0dXJuIGNvb2tpZVByZWY7XG4gICAgfSwge30pO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ByZXZpZXdNb2RlKCk6IGJvb2xlYW4ge1xuICAgIC8vIHBhcmFtcyBmcm9tIHVybCBhcmUgYXV0b21hdGljYWxseSByZXNvbHZlZCBkdXJpbmcgYm9vdHN0cmFwIGFzIHN0cmluZyBvcHRpb25zLCBzZWU6IHBhY2thZ2VzL2NsaS9zcmMvYXBwLWJvb3RzdHJhcC9vcHRpb25zLnRzXG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5nZXQodGhpcy5JU19QUkVWSUVXLCBmYWxzZSwgdHJ1ZSk7XG4gIH1cbn1cbiJdfQ==