import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { uniq } from 'lodash-es';
import { BehaviorSubject, Observable, of } from 'rxjs';
import { startWith } from 'rxjs/operators';
import { AlertService } from '../alert/alert.service';
import { Permissions } from '../common/permissions.service';
import { OptionsService } from '../common/options.service';
import { AppStateService } from '../common/ui-state.service';
import { gettext } from '../i18n/gettext';
import { Steppers } from '../stepper/stepper.model';
import { StepperService } from '../stepper/stepper.service';
import { NEEDED_ROLE_FOR_SETUP, SetupState } from './setup.model';
import { BootstrapComponent } from '../bootstrap/bootstrap.component';
/**
 * This component is the parent of each setup and can be injected
 * into setup steps to control them.
 */
export class SetupComponent {
    constructor(options, stepperService, appState, alert, permissions, bootstrapComponent) {
        this.options = options;
        this.stepperService = stepperService;
        this.appState = appState;
        this.alert = alert;
        this.permissions = permissions;
        this.bootstrapComponent = bootstrapComponent;
        /**
         * A subject which can be used to exchange data between
         * steps.
         */
        this.data$ = new BehaviorSubject({});
        /**
         * The current state. SetupState.START shows an application overview
         * while SetupState.WIZARD shows the steps.
         */
        this.currentSetupState = SetupState.START;
        /**
         * Emits when the setup is done. You can add certain operations before completing the setup that needed to be awaited. Return
         * true if everything is fine, otherwise false.
         * ```typescript
         * const asyncOperation = delay(2000);
         * this.setup.completed$ = this.setup.completed$.pipe(asyncOperation, map(() => true));
         * ``
         * Note: Remember that a step can be viewed multiple times. The step needs to ensure, to only add a completed operation ones.
         */
        this.completed$ = new Observable().pipe(startWith(true));
        /**
         * @ignore
         */
        this.stepperId = Steppers.SETUP;
        /**
         * @ignore
         */
        this.setupState = SetupState;
        /**
         * @ignore
         */
        this.properties = [];
        /**
         * @ignore
         */
        this.canSkip = false;
        /**
         * @ignore
         */
        this.hasRole = false;
        /**
         * @ignore
         */
        this.isOwner = true;
        this.RELOAD_APP_TIMEOUT = 2000;
    }
    /**
     * Mark a step as completed. If the step is required, this is needed to fulfill
     * the setup.
     * @param stepIndex The index of the step you want to mark as completed
     * @param isCompleted Defaults to true to mark it as completed but can be set to false to invalidate the step.
     */
    stepCompleted(stepIndex, isCompleted = true) {
        const step = this.getByIndex(stepIndex);
        step.completed = isCompleted;
    }
    /**
     * Returns a step by it index position in the wizard.
     * @param stepIndex The step index that you want to receive.
     * @returns An indexed step definition.
     */
    getByIndex(stepIndex) {
        return this.steps.find(({ index }) => index === stepIndex);
    }
    /**
     * @ignore
     */
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.steps = (yield this.stepperService.getById$(this.stepperId).toPromise()).map((step, index) => (Object.assign(Object.assign({}, step), { index, completed: false })));
            if (!this.options.forceSetup) {
                const doneSetup = this.options.setup || [];
                this.steps = this.steps.filter(step => doneSetup.indexOf(step.setupId) === -1);
            }
            this.isOwner = this.appState.isOwnerOfApplication();
            this.canSkip = !this.hasRequiredSteps(this.steps);
            this.hasRole = this.permissions.hasRole(NEEDED_ROLE_FOR_SETUP);
            this.properties = [
                {
                    label: gettext('Description'),
                    key: 'description'
                },
                {
                    label: gettext('Keywords'),
                    key: 'keywords'
                },
                {
                    label: gettext('Source'),
                    key: 'repository'
                },
                {
                    label: gettext('Version'),
                    key: 'version'
                },
                {
                    label: gettext('Author'),
                    key: 'author'
                },
                {
                    label: gettext('Required platform version'),
                    key: 'requiredPlatformVersion'
                }
            ];
        });
    }
    /**
     * Skips the current setup wizard
     */
    skip() {
        this.bootstrapComponent.isSetupNeeded$ = of(false);
    }
    /**
     * Starts the wizards (or finish the setup if no steps are found)
     */
    start() {
        this.currentSetupState = SetupState.WIZARD;
    }
    /**
     * Cancels the wizards and goes back to the start view.
     */
    cancel() {
        this.currentSetupState = SetupState.START;
    }
    /**
     * Finish the wizard and will start the application.
     */
    finish() {
        this.currentSetupState = SetupState.FINALIZING;
        this.completed$.subscribe((status) => __awaiter(this, void 0, void 0, function* () {
            if (status) {
                this.finalize();
            }
            else {
                this.currentSetupState = SetupState.WIZARD;
            }
        }));
    }
    finalize() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const doneSetup = this.steps.filter(value => value.setupId).map(value => value.setupId);
                const currentConfig = this.appState.currentApplicationConfig.value;
                yield this.appState.updateApplicationConfig({
                    setup: uniq([...(currentConfig.setupDone || []), ...doneSetup])
                });
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
                this.currentSetupState = SetupState.WIZARD;
            }
            finally {
                this.currentSetupState = SetupState.RELOADING;
                // To ensure proper setup, we reload the app when setup is ready.
                setTimeout(() => this.reloadApp(), this.RELOAD_APP_TIMEOUT);
            }
        });
    }
    /**
     * Verifies every step and checks if all required are completed.
     * Updates the icons to reflect the state of the steps (error, warning, done).
     * @returns Returns true if no error was found.
     */
    verify() {
        this.steps.forEach((step, index) => {
            if (this.steps.length - 1 !== index) {
                step.state = this.getState(step);
            }
        });
        return !!this.steps.find(step => step.state !== 'error');
    }
    reloadApp() {
        const removeUrlParams = location.href.split('?')[0];
        const removedHash = removeUrlParams.split('#')[0];
        location.href = removedHash;
    }
    hasRequiredSteps(notCompletedSetupSteps) {
        return notCompletedSetupSteps.some(step => step.required);
    }
    getState(step) {
        if (!step.completed && step.required) {
            return 'error';
        }
        if (!step.completed && !step.required) {
            return 'warning';
        }
        return 'done';
    }
}
SetupComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-setup',
                template: "<c8y-title>\n  {{ options.name | humanizeAppName | async }}\n</c8y-title>\n\n<div\n  class=\"card content-fullpage fadeInRightBig animated\"\n  *ngIf=\"currentSetupState !== setupState.START\"\n>\n  <c8y-stepper-outlet\n    [showDefaultButtons]=\"false\"\n    [steps]=\"steps\"\n    class=\"d-contents\"\n  ></c8y-stepper-outlet>\n</div>\n\n<div\n  class=\"card content-fullpage d-flex d-col fadeInUpBig animated\"\n  *ngIf=\"currentSetupState === setupState.START\"\n>\n  <div class=\"inner-scroll flex-grow\">\n    <div class=\"card-block\">\n      <div class=\"row\">\n        <div class=\"col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3 p-t-24\">\n          <svg class=\"p-t-32\" viewBox=\"0 0 360 190\" style=\"max-width: 450px; margin: auto\">\n            <g\n              id=\"ecosystem-welcome-illustration\"\n              stroke=\"none\"\n              stroke-width=\"1\"\n              fill=\"none\"\n              fill-rule=\"evenodd\"\n            >\n              <g id=\"medium-img\">\n                <g id=\"M---Nothing-found---illustration\" transform=\"translate(27.000000, 0.000000)\">\n                  <path\n                    d=\"M41.9882163,184.153177 C24.3512964,165.028818 14.796713,138.637202 18.0717117,113.128248 C21.3467105,87.6192947 38.0071399,63.7138452 61.8485298,52.9453596 C71.0829585,49.0513414 80.8096047,46.3893689 90.76767,45.0308169 C98.489456,43.8098001 118.605159,43.8098001 134.379236,43.8098001 C145.406066,43.8098001 181.235754,38.969866 207.015103,16.5355211 C213.745375,10.6511027 239.269332,-7.69357146 271.478495,5.11974949 C293.036399,13.6962892 308.780431,29.0693321 312.911736,38.3078689 C331.314825,79.4105311 320.017582,129.634042 291.233648,164.558065 C285.720232,171.251591 279.470694,177.592051 271.70384,181.608167 C268.726702,182.834918 265.624451,183.747258 262.449715,184.32971 L41.9882163,184.153177 Z\"\n                    id=\"Path\"\n                    fill=\"#CDE6F9\"\n                    fill-rule=\"nonzero\"\n                  ></path>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    cx=\"28.1633729\"\n                    cy=\"162.880435\"\n                    rx=\"2.68222598\"\n                    ry=\"2.68115941\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    cx=\"65.7145367\"\n                    cy=\"65.6884059\"\n                    rx=\"4.02333899\"\n                    ry=\"3.35144928\"\n                  ></ellipse>\n                  <g\n                    id=\"Group\"\n                    opacity=\"0.8\"\n                    transform=\"translate(8.046677, 16.757247)\"\n                    fill=\"#7BCAEF\"\n                    fill-rule=\"nonzero\"\n                  >\n                    <path\n                      d=\"M12.8344513,8.04347826 L2.50788129,8.04347826 C1.90488763,8.22105727 1.25665804,7.99364432 0.892621563,7.47681021 C0.528585083,6.95997611 0.528585083,6.26707703 0.892621563,5.75024293 C1.25665804,5.23340882 1.90488763,5.00599587 2.50788129,5.18357488 L12.8344513,5.18357488 C13.437445,5.00599587 14.0856746,5.23340882 14.4497111,5.75024293 C14.8137476,6.26707703 14.8137476,6.95997611 14.4497111,7.47681021 C14.0856746,7.99364432 13.437445,8.22105727 12.8344513,8.04347826 Z\"\n                      id=\"Path\"\n                    ></path>\n                    <path\n                      d=\"M7.64166184,13.2866345 C6.82691795,13.2866345 6.16643754,12.6197478 6.16643754,11.7971014 L6.16643754,1.37037037 C6.35002101,0.734836286 6.92699763,0.297906603 7.58265287,0.297906603 C8.2383081,0.297906603 8.81528471,0.734836286 8.99888356,1.37037037 L8.99888356,11.7971014 C9.00133839,12.5753731 8.40999101,13.2243764 7.64166184,13.2866345 Z\"\n                      id=\"Path\"\n                    ></path>\n                  </g>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    cx=\"2.68222598\"\n                    cy=\"90.4891305\"\n                    rx=\"2.68222598\"\n                    ry=\"2.68115941\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    cx=\"257.493695\"\n                    cy=\"157.518116\"\n                    rx=\"2.68222598\"\n                    ry=\"2.68115941\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#14629F\"\n                    fill-rule=\"nonzero\"\n                    cx=\"299.738754\"\n                    cy=\"155.507247\"\n                    rx=\"2.01166949\"\n                    ry=\"2.01086957\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    fill=\"#96CAF3\"\n                    fill-rule=\"nonzero\"\n                    cx=\"260.175921\"\n                    cy=\"59.6557971\"\n                    rx=\"2.68222598\"\n                    ry=\"2.68115941\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    stroke=\"#5FAEEC\"\n                    stroke-width=\"2\"\n                    stroke-linecap=\"round\"\n                    stroke-linejoin=\"round\"\n                    cx=\"329.913796\"\n                    cy=\"111.938406\"\n                    rx=\"2.68222598\"\n                    ry=\"2.68115941\"\n                  ></ellipse>\n                  <ellipse\n                    id=\"Oval\"\n                    stroke=\"#96CAF3\"\n                    cx=\"95.2190226\"\n                    cy=\"144.782609\"\n                    rx=\"4.02333899\"\n                    ry=\"3.35144928\"\n                  ></ellipse>\n                  <g\n                    id=\"Group\"\n                    opacity=\"0.6\"\n                    transform=\"translate(273.587050, 121.322464)\"\n                    fill=\"#14629F\"\n                    fill-rule=\"nonzero\"\n                  >\n                    <path\n                      d=\"M12.1263437,8.01368761 L1.79977363,8.01368761 C1.17034461,7.82832349 0.737612147,7.24575058 0.737612147,6.5837359 C0.737612147,5.92172124 1.17034461,5.33914833 1.79977363,5.15378421 L12.1263437,5.15378421 C12.7293374,4.97620521 13.3775669,5.20361817 13.7416034,5.72045226 C14.1056399,6.23728637 14.1056399,6.93018545 13.7416034,7.44701956 C13.3775669,7.96385365 12.7293374,8.19126661 12.1263437,8.01368761 L12.1263437,8.01368761 Z\"\n                      id=\"Path\"\n                    ></path>\n                    <path\n                      d=\"M6.94830642,13.2419485 C6.13356254,13.2419485 5.47308212,12.5750618 5.47308212,11.7524155 L5.47308212,1.32568438 C5.6566656,0.690150295 6.23364221,0.253220612 6.88929744,0.253220612 C7.54495269,0.253220612 8.1219293,0.690150295 8.30552815,1.32568438 L8.30552815,11.7524155 C8.30798297,12.5306871 7.71663558,13.1796904 6.94830642,13.2419485 Z\"\n                      id=\"Path\"\n                    ></path>\n                  </g>\n                  <rect\n                    id=\"Rectangle\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    x=\"107.28904\"\n                    y=\"128.025362\"\n                    width=\"109.971265\"\n                    height=\"48.2608695\"\n                  ></rect>\n                  <polygon\n                    id=\"Path\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    points=\"205.744516 91.8297102 121.555988 91.8297102 107.28904 129.365942 217.260306 129.365942\"\n                  ></polygon>\n                  <polygon\n                    id=\"Path\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    points=\"93.8779095 114.917472 103.478057 98.5326086 118.017943 121.471417 107.035845 128.025362\"\n                  ></polygon>\n                  <polygon\n                    id=\"Path\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                    points=\"209.213627 123.316736 216.813268 129.365942 232.012548 114.683402 221.373051 98.5326086\"\n                  ></polygon>\n                  <polygon\n                    id=\"Path\"\n                    fill=\"#96CAF3\"\n                    fill-rule=\"nonzero\"\n                    points=\"214.884986 105.235507 111.648803 105.235507 107.28904 129.365942 217.260306 129.365942\"\n                  ></polygon>\n                  <path\n                    d=\"M91.6761446,30.3423163 C92.3222173,30.3423163 92.8459628,30.8537275 92.8459628,31.4845853 C92.8459628,32.1154431 92.3222173,32.6268545 91.6761446,32.6268545 C91.0300718,32.6268545 90.5063264,32.1154431 90.5063264,31.4845853 C90.5289441,30.8631053 91.0396757,30.3644014 91.6761446,30.3423163 Z M91.8662401,24.6309708 C92.4940745,24.6065819 93.1037929,24.8394323 93.5480901,25.2732662 C93.9923872,25.7071004 94.2308535,26.30246 94.2058764,26.9155089 L94.2058764,27.5152002 L89.5266036,27.5152002 L89.5266036,26.9155089 C89.4960305,26.2895723 89.7404154,25.6806341 90.1983788,25.2416359 C90.6563421,24.8026375 91.2843716,24.5752894 91.924731,24.6166924 L91.8662401,24.6309708 Z M91.8662401,23.4744232 C90.9292048,23.466734 90.0282593,23.8268063 89.3656519,24.4738094 C88.7030445,25.1208125 88.3342881,26.0005407 88.3421627,26.9155089 L88.3421627,27.5152002 L87.1723446,27.5152002 L87.1723446,35.5253623 L96.5601355,35.5253623 L96.5601355,27.5009219 L95.3903173,27.5009219 L95.3903173,26.9012306 C95.3981063,25.9961621 95.037351,25.1251451 94.3874206,24.4798095 C93.7374901,23.8344738 92.8516283,23.4676871 91.924731,23.460145 L91.8662401,23.4744232 Z\"\n                    id=\"Shape\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                  ></path>\n                  <path\n                    d=\"M254.811469,24.8007247 L248.113249,12.7355072 L241.400339,24.8007247 L254.811469,24.8007247 Z M248.7155,22.7874058 L247.466929,22.7874058 L247.466929,21.6411367 L248.671434,21.6411367 L248.7155,22.7874058 Z M248.7155,20.5095632 L247.466929,20.5095632 L247.466929,17.5704117 L248.671434,17.5704117 L248.7155,20.5095632 Z\"\n                    id=\"Shape\"\n                    fill=\"#5FAEEC\"\n                    fill-rule=\"nonzero\"\n                  ></path>\n                  <line\n                    x1=\"201.166949\"\n                    y1=\"40.8876812\"\n                    x2=\"187.755818\"\n                    y2=\"60.9963769\"\n                    id=\"Path\"\n                    stroke=\"#5FAEEC\"\n                    stroke-width=\"2\"\n                    stroke-linecap=\"round\"\n                    stroke-linejoin=\"round\"\n                  ></line>\n                  <line\n                    x1=\"165.969438\"\n                    y1=\"31.5036231\"\n                    x2=\"165.285471\"\n                    y2=\"55.6340579\"\n                    id=\"Path\"\n                    stroke=\"#5FAEEC\"\n                    stroke-width=\"2\"\n                    stroke-linecap=\"round\"\n                    stroke-linejoin=\"round\"\n                  ></line>\n                  <line\n                    x1=\"130.08796\"\n                    y1=\"44.9094203\"\n                    x2=\"146.181316\"\n                    y2=\"63.6775362\"\n                    id=\"Path\"\n                    stroke=\"#5FAEEC\"\n                    stroke-width=\"2\"\n                    stroke-linecap=\"round\"\n                    stroke-linejoin=\"round\"\n                  ></line>\n                </g>\n                <polygon\n                  id=\"Fill-56\"\n                  fill=\"#A5D1FE\"\n                  fill-rule=\"nonzero\"\n                  points=\"0 185 335 185 335 175 0 175\"\n                ></polygon>\n              </g>\n            </g>\n          </svg>\n          <h1\n            class=\"p-t-16 p-b-16 text-center text-medium\"\n            ngNonBindable\n            translate\n            [translateParams]=\"{ appName: options.name | humanizeAppName | async }\"\n          >\n            Welcome to {{ appName }}\n          </h1>\n          <p class=\"lead text-normal\" translate *ngIf=\"hasRole\">\n            This application (or any plugin that you added recently) has pre-requirements that needs\n            to be configured first. This wizard will guide you through the steps that are necessary\n            to get your application up and running.\n          </p>\n          <div class=\"flex-grow\" *ngIf=\"properties.length > 0\">\n            <c8y-properties-list\n              icon=\"info\"\n              [properties]=\"properties\"\n              [data]=\"options\"\n              [title]=\"'Application properties' | translate\"\n            ></c8y-properties-list>\n          </div>\n          <div class=\"alert alert-danger m-32\" *ngIf=\"!hasRole\">\n            <strong translate>No permission</strong>\n            <div translate>\n              You don't have sufficient rights to setup this application. Please contact an\n              application administrator to setup the required steps.\n            </div>\n          </div>\n          <div class=\"alert alert-danger m-32\" *ngIf=\"!isOwner\">\n            <strong translate>Not the owner</strong>\n            <div translate>\n              The current application is not owned by this tenant. Please clone the application\n              before running the setup.\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"card-footer separator d-flex j-c-center\">\n    <button\n      class=\"btn\"\n      (click)=\"skip()\"\n      translate\n      *ngIf=\"canSkip\"\n      [title]=\"\n        'You can skip the setup now. It will be shown again as soon as you restart the application.'\n          | translate\n      \"\n    >\n      Skip\n    </button>\n\n    <button\n      class=\"btn btn-primary\"\n      (click)=\"start()\"\n      translate\n      [disabled]=\"!hasRole || !isOwner\"\n      [title]=\"'Start the setup wizard.' | translate\"\n    >\n      Start\n    </button>\n  </div>\n</div>\n"
            },] }
];
SetupComponent.ctorParameters = () => [
    { type: OptionsService },
    { type: StepperService },
    { type: AppStateService },
    { type: AlertService },
    { type: Permissions },
    { type: BootstrapComponent }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9zZXR1cC9zZXR1cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUFlLFFBQVEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsVUFBVSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRXRFOzs7R0FHRztBQUtILE1BQU0sT0FBTyxjQUFjO0lBb0R6QixZQUNTLE9BQXVCLEVBQ3RCLGNBQThCLEVBQzlCLFFBQXlCLEVBQ3pCLEtBQW1CLEVBQ25CLFdBQXdCLEVBQ3hCLGtCQUFzQztRQUx2QyxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUN0QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBekRoRDs7O1dBR0c7UUFDSCxVQUFLLEdBQUcsSUFBSSxlQUFlLENBQU0sRUFBRSxDQUFDLENBQUM7UUFLckM7OztXQUdHO1FBQ0gsc0JBQWlCLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUNyQzs7Ozs7Ozs7V0FRRztRQUNILGVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM3RDs7V0FFRztRQUNNLGNBQVMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQ3BDOztXQUVHO1FBQ0gsZUFBVSxHQUFHLFVBQVUsQ0FBQztRQUN4Qjs7V0FFRztRQUNILGVBQVUsR0FBRyxFQUFFLENBQUM7UUFDaEI7O1dBRUc7UUFDSCxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCOztXQUVHO1FBQ0gsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQjs7V0FFRztRQUNILFlBQU8sR0FBRyxJQUFJLENBQUM7UUFFRSx1QkFBa0IsR0FBRyxJQUFJLENBQUM7SUFTeEMsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsYUFBYSxDQUFDLFNBQVMsRUFBRSxXQUFXLEdBQUcsSUFBSTtRQUN6QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxTQUFTLEdBQUcsV0FBVyxDQUFDO0lBQy9CLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsVUFBVSxDQUFDLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDRyxRQUFROztZQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FDL0UsQ0FBQyxJQUFlLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxpQ0FDdkIsSUFBSSxLQUNQLEtBQUssRUFDTCxTQUFTLEVBQUUsS0FBSyxJQUNoQixDQUNILENBQUM7WUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUU7Z0JBQzVCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDaEY7WUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUNwRCxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLFVBQVUsR0FBRztnQkFDaEI7b0JBQ0UsS0FBSyxFQUFFLE9BQU8sQ0FBQyxhQUFhLENBQUM7b0JBQzdCLEdBQUcsRUFBRSxhQUFhO2lCQUNuQjtnQkFDRDtvQkFDRSxLQUFLLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQztvQkFDMUIsR0FBRyxFQUFFLFVBQVU7aUJBQ2hCO2dCQUNEO29CQUNFLEtBQUssRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDO29CQUN4QixHQUFHLEVBQUUsWUFBWTtpQkFDbEI7Z0JBQ0Q7b0JBQ0UsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUM7b0JBQ3pCLEdBQUcsRUFBRSxTQUFTO2lCQUNmO2dCQUNEO29CQUNFLEtBQUssRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDO29CQUN4QixHQUFHLEVBQUUsUUFBUTtpQkFDZDtnQkFDRDtvQkFDRSxLQUFLLEVBQUUsT0FBTyxDQUFDLDJCQUEyQixDQUFDO29CQUMzQyxHQUFHLEVBQUUseUJBQXlCO2lCQUMvQjthQUNGLENBQUM7UUFDSixDQUFDO0tBQUE7SUFFRDs7T0FFRztJQUNILElBQUk7UUFDRixJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTTtRQUNKLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDO0lBQzVDLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU07UUFDSixJQUFJLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQztRQUMvQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFNLE1BQU0sRUFBQyxFQUFFO1lBQ3ZDLElBQUksTUFBTSxFQUFFO2dCQUNWLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNqQjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQzthQUM1QztRQUNILENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUssUUFBUTs7WUFDWixJQUFJO2dCQUNGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDeEYsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUM7Z0JBQ25FLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQztvQkFDMUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEdBQUcsU0FBUyxDQUFDLENBQUM7aUJBQ2hFLENBQUMsQ0FBQzthQUNKO1lBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7YUFDNUM7b0JBQVM7Z0JBQ1IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7Z0JBQzlDLGlFQUFpRTtnQkFDakUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUM3RDtRQUNILENBQUM7S0FBQTtJQUVEOzs7O09BSUc7SUFDSCxNQUFNO1FBQ0osSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDakMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDbEM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxPQUFPLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRU8sU0FBUztRQUNmLE1BQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sV0FBVyxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsUUFBUSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7SUFDOUIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLHNCQUFtQztRQUMxRCxPQUFPLHNCQUFzQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU8sUUFBUSxDQUFDLElBQWlCO1FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDcEMsT0FBTyxPQUFPLENBQUM7U0FDaEI7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDckMsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7WUF6TkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxXQUFXO2dCQUNyQixpdGNBQXFDO2FBQ3RDOzs7WUFmUSxjQUFjO1lBSWQsY0FBYztZQUhkLGVBQWU7WUFIZixZQUFZO1lBQ1osV0FBVztZQU9YLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB1bmlxIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJy4uL2FsZXJ0L2FsZXJ0LnNlcnZpY2UnO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tICcuLi9jb21tb24vcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VpLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uL2kxOG4vZ2V0dGV4dCc7XG5pbXBvcnQgeyBJbmRleGVkU3RlcCwgU3RlcHBlcnMgfSBmcm9tICcuLi9zdGVwcGVyL3N0ZXBwZXIubW9kZWwnO1xuaW1wb3J0IHsgU3RlcHBlclNlcnZpY2UgfSBmcm9tICcuLi9zdGVwcGVyL3N0ZXBwZXIuc2VydmljZSc7XG5pbXBvcnQgeyBORUVERURfUk9MRV9GT1JfU0VUVVAsIFNldHVwU3RhdGUsIFNldHVwU3RlcCB9IGZyb20gJy4vc2V0dXAubW9kZWwnO1xuaW1wb3J0IHsgQm9vdHN0cmFwQ29tcG9uZW50IH0gZnJvbSAnLi4vYm9vdHN0cmFwL2Jvb3RzdHJhcC5jb21wb25lbnQnO1xuXG4vKipcbiAqIFRoaXMgY29tcG9uZW50IGlzIHRoZSBwYXJlbnQgb2YgZWFjaCBzZXR1cCBhbmQgY2FuIGJlIGluamVjdGVkXG4gKiBpbnRvIHNldHVwIHN0ZXBzIHRvIGNvbnRyb2wgdGhlbS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNldHVwJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3NldHVwLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTZXR1cENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIC8qKlxuICAgKiBBIHN1YmplY3Qgd2hpY2ggY2FuIGJlIHVzZWQgdG8gZXhjaGFuZ2UgZGF0YSBiZXR3ZWVuXG4gICAqIHN0ZXBzLlxuICAgKi9cbiAgZGF0YSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe30pO1xuICAvKipcbiAgICogQWxsIGN1cnJlbnQgc2hvd24gc2V0dXAgc3RlcHMuXG4gICAqL1xuICBzdGVwczogU2V0dXBTdGVwW107XG4gIC8qKlxuICAgKiBUaGUgY3VycmVudCBzdGF0ZS4gU2V0dXBTdGF0ZS5TVEFSVCBzaG93cyBhbiBhcHBsaWNhdGlvbiBvdmVydmlld1xuICAgKiB3aGlsZSBTZXR1cFN0YXRlLldJWkFSRCBzaG93cyB0aGUgc3RlcHMuXG4gICAqL1xuICBjdXJyZW50U2V0dXBTdGF0ZSA9IFNldHVwU3RhdGUuU1RBUlQ7XG4gIC8qKlxuICAgKiBFbWl0cyB3aGVuIHRoZSBzZXR1cCBpcyBkb25lLiBZb3UgY2FuIGFkZCBjZXJ0YWluIG9wZXJhdGlvbnMgYmVmb3JlIGNvbXBsZXRpbmcgdGhlIHNldHVwIHRoYXQgbmVlZGVkIHRvIGJlIGF3YWl0ZWQuIFJldHVyblxuICAgKiB0cnVlIGlmIGV2ZXJ5dGhpbmcgaXMgZmluZSwgb3RoZXJ3aXNlIGZhbHNlLlxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIGNvbnN0IGFzeW5jT3BlcmF0aW9uID0gZGVsYXkoMjAwMCk7XG4gICAqIHRoaXMuc2V0dXAuY29tcGxldGVkJCA9IHRoaXMuc2V0dXAuY29tcGxldGVkJC5waXBlKGFzeW5jT3BlcmF0aW9uLCBtYXAoKCkgPT4gdHJ1ZSkpO1xuICAgKiBgYFxuICAgKiBOb3RlOiBSZW1lbWJlciB0aGF0IGEgc3RlcCBjYW4gYmUgdmlld2VkIG11bHRpcGxlIHRpbWVzLiBUaGUgc3RlcCBuZWVkcyB0byBlbnN1cmUsIHRvIG9ubHkgYWRkIGEgY29tcGxldGVkIG9wZXJhdGlvbiBvbmVzLlxuICAgKi9cbiAgY29tcGxldGVkJCA9IG5ldyBPYnNlcnZhYmxlPGJvb2xlYW4+KCkucGlwZShzdGFydFdpdGgodHJ1ZSkpO1xuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgcmVhZG9ubHkgc3RlcHBlcklkID0gU3RlcHBlcnMuU0VUVVA7XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBzZXR1cFN0YXRlID0gU2V0dXBTdGF0ZTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHByb3BlcnRpZXMgPSBbXTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGNhblNraXAgPSBmYWxzZTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGhhc1JvbGUgPSBmYWxzZTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGlzT3duZXIgPSB0cnVlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgUkVMT0FEX0FQUF9USU1FT1VUID0gMjAwMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgb3B0aW9uczogT3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBzdGVwcGVyU2VydmljZTogU3RlcHBlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBTdGF0ZTogQXBwU3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyxcbiAgICBwcml2YXRlIGJvb3RzdHJhcENvbXBvbmVudDogQm9vdHN0cmFwQ29tcG9uZW50XG4gICkge31cblxuICAvKipcbiAgICogTWFyayBhIHN0ZXAgYXMgY29tcGxldGVkLiBJZiB0aGUgc3RlcCBpcyByZXF1aXJlZCwgdGhpcyBpcyBuZWVkZWQgdG8gZnVsZmlsbFxuICAgKiB0aGUgc2V0dXAuXG4gICAqIEBwYXJhbSBzdGVwSW5kZXggVGhlIGluZGV4IG9mIHRoZSBzdGVwIHlvdSB3YW50IHRvIG1hcmsgYXMgY29tcGxldGVkXG4gICAqIEBwYXJhbSBpc0NvbXBsZXRlZCBEZWZhdWx0cyB0byB0cnVlIHRvIG1hcmsgaXQgYXMgY29tcGxldGVkIGJ1dCBjYW4gYmUgc2V0IHRvIGZhbHNlIHRvIGludmFsaWRhdGUgdGhlIHN0ZXAuXG4gICAqL1xuICBzdGVwQ29tcGxldGVkKHN0ZXBJbmRleCwgaXNDb21wbGV0ZWQgPSB0cnVlKSB7XG4gICAgY29uc3Qgc3RlcCA9IHRoaXMuZ2V0QnlJbmRleChzdGVwSW5kZXgpO1xuICAgIHN0ZXAuY29tcGxldGVkID0gaXNDb21wbGV0ZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIHN0ZXAgYnkgaXQgaW5kZXggcG9zaXRpb24gaW4gdGhlIHdpemFyZC5cbiAgICogQHBhcmFtIHN0ZXBJbmRleCBUaGUgc3RlcCBpbmRleCB0aGF0IHlvdSB3YW50IHRvIHJlY2VpdmUuXG4gICAqIEByZXR1cm5zIEFuIGluZGV4ZWQgc3RlcCBkZWZpbml0aW9uLlxuICAgKi9cbiAgZ2V0QnlJbmRleChzdGVwSW5kZXgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGVwcy5maW5kKCh7IGluZGV4IH0pID0+IGluZGV4ID09PSBzdGVwSW5kZXgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc3RlcHMgPSAoYXdhaXQgdGhpcy5zdGVwcGVyU2VydmljZS5nZXRCeUlkJCh0aGlzLnN0ZXBwZXJJZCkudG9Qcm9taXNlKCkpLm1hcChcbiAgICAgIChzdGVwOiBTZXR1cFN0ZXAsIGluZGV4KSA9PiAoe1xuICAgICAgICAuLi5zdGVwLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgY29tcGxldGVkOiBmYWxzZVxuICAgICAgfSlcbiAgICApO1xuXG4gICAgaWYgKCF0aGlzLm9wdGlvbnMuZm9yY2VTZXR1cCkge1xuICAgICAgY29uc3QgZG9uZVNldHVwID0gdGhpcy5vcHRpb25zLnNldHVwIHx8IFtdO1xuICAgICAgdGhpcy5zdGVwcyA9IHRoaXMuc3RlcHMuZmlsdGVyKHN0ZXAgPT4gZG9uZVNldHVwLmluZGV4T2Yoc3RlcC5zZXR1cElkKSA9PT0gLTEpO1xuICAgIH1cblxuICAgIHRoaXMuaXNPd25lciA9IHRoaXMuYXBwU3RhdGUuaXNPd25lck9mQXBwbGljYXRpb24oKTtcbiAgICB0aGlzLmNhblNraXAgPSAhdGhpcy5oYXNSZXF1aXJlZFN0ZXBzKHRoaXMuc3RlcHMpO1xuICAgIHRoaXMuaGFzUm9sZSA9IHRoaXMucGVybWlzc2lvbnMuaGFzUm9sZShORUVERURfUk9MRV9GT1JfU0VUVVApO1xuICAgIHRoaXMucHJvcGVydGllcyA9IFtcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0Rlc2NyaXB0aW9uJyksXG4gICAgICAgIGtleTogJ2Rlc2NyaXB0aW9uJ1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0tleXdvcmRzJyksXG4gICAgICAgIGtleTogJ2tleXdvcmRzJ1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ1NvdXJjZScpLFxuICAgICAgICBrZXk6ICdyZXBvc2l0b3J5J1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ1ZlcnNpb24nKSxcbiAgICAgICAga2V5OiAndmVyc2lvbidcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdBdXRob3InKSxcbiAgICAgICAga2V5OiAnYXV0aG9yJ1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ1JlcXVpcmVkIHBsYXRmb3JtIHZlcnNpb24nKSxcbiAgICAgICAga2V5OiAncmVxdWlyZWRQbGF0Zm9ybVZlcnNpb24nXG4gICAgICB9XG4gICAgXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTa2lwcyB0aGUgY3VycmVudCBzZXR1cCB3aXphcmRcbiAgICovXG4gIHNraXAoKSB7XG4gICAgdGhpcy5ib290c3RyYXBDb21wb25lbnQuaXNTZXR1cE5lZWRlZCQgPSBvZihmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIHRoZSB3aXphcmRzIChvciBmaW5pc2ggdGhlIHNldHVwIGlmIG5vIHN0ZXBzIGFyZSBmb3VuZClcbiAgICovXG4gIHN0YXJ0KCkge1xuICAgIHRoaXMuY3VycmVudFNldHVwU3RhdGUgPSBTZXR1cFN0YXRlLldJWkFSRDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxzIHRoZSB3aXphcmRzIGFuZCBnb2VzIGJhY2sgdG8gdGhlIHN0YXJ0IHZpZXcuXG4gICAqL1xuICBjYW5jZWwoKSB7XG4gICAgdGhpcy5jdXJyZW50U2V0dXBTdGF0ZSA9IFNldHVwU3RhdGUuU1RBUlQ7XG4gIH1cblxuICAvKipcbiAgICogRmluaXNoIHRoZSB3aXphcmQgYW5kIHdpbGwgc3RhcnQgdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgZmluaXNoKCkge1xuICAgIHRoaXMuY3VycmVudFNldHVwU3RhdGUgPSBTZXR1cFN0YXRlLkZJTkFMSVpJTkc7XG4gICAgdGhpcy5jb21wbGV0ZWQkLnN1YnNjcmliZShhc3luYyBzdGF0dXMgPT4ge1xuICAgICAgaWYgKHN0YXR1cykge1xuICAgICAgICB0aGlzLmZpbmFsaXplKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmN1cnJlbnRTZXR1cFN0YXRlID0gU2V0dXBTdGF0ZS5XSVpBUkQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5hbGl6ZSgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZG9uZVNldHVwID0gdGhpcy5zdGVwcy5maWx0ZXIodmFsdWUgPT4gdmFsdWUuc2V0dXBJZCkubWFwKHZhbHVlID0+IHZhbHVlLnNldHVwSWQpO1xuICAgICAgY29uc3QgY3VycmVudENvbmZpZyA9IHRoaXMuYXBwU3RhdGUuY3VycmVudEFwcGxpY2F0aW9uQ29uZmlnLnZhbHVlO1xuICAgICAgYXdhaXQgdGhpcy5hcHBTdGF0ZS51cGRhdGVBcHBsaWNhdGlvbkNvbmZpZyh7XG4gICAgICAgIHNldHVwOiB1bmlxKFsuLi4oY3VycmVudENvbmZpZy5zZXR1cERvbmUgfHwgW10pLCAuLi5kb25lU2V0dXBdKVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgICB0aGlzLmN1cnJlbnRTZXR1cFN0YXRlID0gU2V0dXBTdGF0ZS5XSVpBUkQ7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuY3VycmVudFNldHVwU3RhdGUgPSBTZXR1cFN0YXRlLlJFTE9BRElORztcbiAgICAgIC8vIFRvIGVuc3VyZSBwcm9wZXIgc2V0dXAsIHdlIHJlbG9hZCB0aGUgYXBwIHdoZW4gc2V0dXAgaXMgcmVhZHkuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucmVsb2FkQXBwKCksIHRoaXMuUkVMT0FEX0FQUF9USU1FT1VUKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpZXMgZXZlcnkgc3RlcCBhbmQgY2hlY2tzIGlmIGFsbCByZXF1aXJlZCBhcmUgY29tcGxldGVkLlxuICAgKiBVcGRhdGVzIHRoZSBpY29ucyB0byByZWZsZWN0IHRoZSBzdGF0ZSBvZiB0aGUgc3RlcHMgKGVycm9yLCB3YXJuaW5nLCBkb25lKS5cbiAgICogQHJldHVybnMgUmV0dXJucyB0cnVlIGlmIG5vIGVycm9yIHdhcyBmb3VuZC5cbiAgICovXG4gIHZlcmlmeSgpIHtcbiAgICB0aGlzLnN0ZXBzLmZvckVhY2goKHN0ZXAsIGluZGV4KSA9PiB7XG4gICAgICBpZiAodGhpcy5zdGVwcy5sZW5ndGggLSAxICE9PSBpbmRleCkge1xuICAgICAgICBzdGVwLnN0YXRlID0gdGhpcy5nZXRTdGF0ZShzdGVwKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gISF0aGlzLnN0ZXBzLmZpbmQoc3RlcCA9PiBzdGVwLnN0YXRlICE9PSAnZXJyb3InKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVsb2FkQXBwKCkge1xuICAgIGNvbnN0IHJlbW92ZVVybFBhcmFtcyA9IGxvY2F0aW9uLmhyZWYuc3BsaXQoJz8nKVswXTtcbiAgICBjb25zdCByZW1vdmVkSGFzaCA9IHJlbW92ZVVybFBhcmFtcy5zcGxpdCgnIycpWzBdO1xuICAgIGxvY2F0aW9uLmhyZWYgPSByZW1vdmVkSGFzaDtcbiAgfVxuXG4gIHByaXZhdGUgaGFzUmVxdWlyZWRTdGVwcyhub3RDb21wbGV0ZWRTZXR1cFN0ZXBzOiBTZXR1cFN0ZXBbXSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBub3RDb21wbGV0ZWRTZXR1cFN0ZXBzLnNvbWUoc3RlcCA9PiBzdGVwLnJlcXVpcmVkKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RhdGUoc3RlcDogSW5kZXhlZFN0ZXApIHtcbiAgICBpZiAoIXN0ZXAuY29tcGxldGVkICYmIHN0ZXAucmVxdWlyZWQpIHtcbiAgICAgIHJldHVybiAnZXJyb3InO1xuICAgIH1cbiAgICBpZiAoIXN0ZXAuY29tcGxldGVkICYmICFzdGVwLnJlcXVpcmVkKSB7XG4gICAgICByZXR1cm4gJ3dhcm5pbmcnO1xuICAgIH1cbiAgICByZXR1cm4gJ2RvbmUnO1xuICB9XG59XG4iXX0=