import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
import { NEVER } from 'rxjs';
import { distinctUntilChanged, map, switchMap, tap } from 'rxjs/operators';
import { AppStateService } from '../common/ui-state.service';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/inventory/InventoryService";
import * as i2 from "@c8y/ngx-components/api";
import * as i3 from "../common/ui-state.service";
/**
 * AssetTypesService is being used to manage a cache of all existing asset types.
 * This service is injected in the AssetOverviewNavigationFactory class, which will trigger
 * the initialization of the cache as the contstructor is called.
 */
export class AssetTypesService {
    constructor(inventory, apiService, appStateService) {
        this.inventory = inventory;
        this.apiService = apiService;
        this.appStateService = appStateService;
        this.ASSET_TYPE_GROUP_QUERY = {
            __filter: {
                __and: [{ __has: 'c8y_IsAssetType' }, { name: 'group' }]
            }
        };
        this.assetTypesCache = {};
        this.DEFAULT_GROUP_ICON = 'c8y-group';
        this.DEFAULT_GROUP_ICON_OPEN = 'c8y-group-open';
        this.appStateService.currentUser
            .pipe(map(user => user === null || user === void 0 ? void 0 : user.id), distinctUntilChanged(), switchMap(userId => {
            if (userId) {
                this.initAssetTypesCache();
                return this.subscribeForAssetTypeUpdates();
            }
            else {
                this.assetTypesCache = {};
                return NEVER;
            }
        }))
            .subscribe();
    }
    /**
     * Queries available asset types and adds every asset type to the local cache.
     * @returns void.
     */
    initAssetTypesCache() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.inventory.list({
                fragmentType: 'c8y_IsAssetType',
                withChildren: false,
                pageSize: 2000
            });
            data.forEach(assetType => this.addAssetType(assetType));
            return;
        });
    }
    /**
     * Returns an asset type from the cache based on the unique name property.
     * @param name Name of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeByName(name) {
        if (!this.assetTypesCache.hasOwnProperty(name)) {
            return undefined;
        }
        return this.assetTypesCache[name];
    }
    /**
     * Returns an asset type from the cache based on the id.
     * @param assetTypeId Id of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeById(assetTypeId) {
        if (!assetTypeId) {
            return;
        }
        return Object.values(this.assetTypesCache).find((assetType) => assetType.id === assetTypeId);
    }
    /**
     * Extracts an icon from an asset type.
     * @param type Type of the asset type.
     * @param open Determines whether the method should return an alternative icon showing the open state.
     * Defaults to false.
     * @returns Returns an icon for a given asset type.
     */
    getIcon(type, open = false) {
        var _a, _b;
        const assetType = this.getAssetTypeByName(type);
        const icon = ((_b = (_a = assetType === null || assetType === void 0 ? void 0 : assetType.c8y_IsAssetType) === null || _a === void 0 ? void 0 : _a.icon) === null || _b === void 0 ? void 0 : _b.name) || this.getDefaultGroupIcon(open);
        return icon;
    }
    getDefaultGroupIcon(open = false) {
        return open ? this.DEFAULT_GROUP_ICON_OPEN : this.DEFAULT_GROUP_ICON;
    }
    /**
     * Checks if the default asset type 'group' already exists and if it doesn't it will be created.
     * @returns void.
     */
    createAssetTypeGroupIfNotExists() {
        return __awaiter(this, void 0, void 0, function* () {
            const managedObjects = (yield this.inventory.listQuery(this.ASSET_TYPE_GROUP_QUERY)).data;
            if (managedObjects.length > 0) {
                return;
            }
            // if default group asset type doesn't exit create it
            yield this.createDefaultAssetTypeGroup();
        });
    }
    /**
     * create the default asset type group in the Inventory.
     */
    createDefaultAssetTypeGroup() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.inventory.create({
                label: 'Group',
                name: 'group',
                description: 'Default group asset type',
                c8y_IsAssetType: {
                    icon: 'folder',
                    propertyIds: [],
                    allowedAssetTypeIds: [],
                    isNoneChildAssetsAllowed: 'false'
                }
            });
        });
    }
    /**
     * Add an asset type to the local cache.
     * @param assetType Asset type which should be added to the cache.
     * @returns void.
     */
    addAssetType(assetType) {
        if (!assetType) {
            console.error('Asset type must not be null');
            return;
        }
        this.assetTypesCache[assetType.name] = assetType;
    }
    /**
     * Delete an asset type from the local cache based on the given asset type id.
     * @param assetTypeId Id of the asset type which should be deleted.
     * @returns void.
     */
    deleteAssetType(assetTypeId) {
        if (!assetTypeId) {
            console.error('Asset type ID must not be null');
            return;
        }
        const assetType = this.getAssetTypeById(assetTypeId);
        if (assetType) {
            delete this.assetTypesCache[assetType.name];
        }
    }
    /**
     * Update an asset type in the local cache.
     * @param assetType Asset type which should be updated in the cache.
     * @returns void.
     */
    updateAssetType(assetType) {
        if (!assetType) {
            console.error('Asset type must not be null');
            return;
        }
        const cachedAssetType = this.getAssetTypeById(assetType.id);
        if (cachedAssetType) {
            this.assetTypesCache[cachedAssetType.name] = Object.assign(cachedAssetType, assetType);
        }
    }
    /**
     * Subscribes to api PUT, POST and DELETE requests interceptor to update local asset types cache.
     * If a new asset type has been created it will be added to the local cache. If an asset
     * type has been deleted it will be removed from the local cache.
     */
    subscribeForAssetTypeUpdates() {
        return this.apiService
            .hookResponse(c => this.checkIfInventoryMoApiCall(c))
            .pipe(tap((call) => {
            var _a;
            if (!call && !call.method) {
                return;
            }
            const bodyToParse = (_a = call.options) === null || _a === void 0 ? void 0 : _a.body;
            if (bodyToParse) {
                try {
                    const mo = JSON.parse(bodyToParse);
                    if (call.method === 'DELETE') {
                        this.deleteAssetType(mo.id);
                        return;
                    }
                    if (!mo.hasOwnProperty('c8y_IsAssetType')) {
                        return;
                    }
                    if (call.method === 'PUT') {
                        this.updateAssetType(mo);
                        return;
                    }
                    this.addAssetType(mo);
                }
                catch (error) {
                    // do nothing
                }
            }
        }));
    }
    /**
     * Managed objects inventory api filter, allowing only PUT, POST and DELETE methods.
     * @param call Api call to filter.
     * @returns Returns true if api call meets the required criteria.
     */
    checkIfInventoryMoApiCall(call) {
        if (!call) {
            return false;
        }
        const hasRequiredMethod = call.method === 'POST' || call.method === 'DELETE' || call.method === 'PUT';
        const hasRequiredUrl = call.url.includes('managedObjects');
        return hasRequiredMethod && hasRequiredUrl;
    }
}
AssetTypesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AssetTypesService_Factory() { return new AssetTypesService(i0.ɵɵinject(i1.InventoryService), i0.ɵɵinject(i2.ApiService), i0.ɵɵinject(i3.AppStateService)); }, token: AssetTypesService, providedIn: "root" });
AssetTypesService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
AssetTypesService.ctorParameters = () => [
    { type: InventoryService },
    { type: ApiService },
    { type: AppStateService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtdHlwZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvYXNzZXQtdHlwZXMvYXNzZXQtdHlwZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWtCLGdCQUFnQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQy9ELE9BQU8sRUFBVyxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7Ozs7QUFFN0Q7Ozs7R0FJRztBQUVILE1BQU0sT0FBTyxpQkFBaUI7SUFXNUIsWUFDVSxTQUEyQixFQUMzQixVQUFzQixFQUN0QixlQUFnQztRQUZoQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQWJ6QiwyQkFBc0IsR0FBRztZQUN4QyxRQUFRLEVBQUU7Z0JBQ1IsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQzthQUN6RDtTQUNGLENBQUM7UUFFTSxvQkFBZSxHQUFXLEVBQUUsQ0FBQztRQUNwQix1QkFBa0IsR0FBRyxXQUFXLENBQUM7UUFDakMsNEJBQXVCLEdBQUcsZ0JBQWdCLENBQUM7UUFPMUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXO2FBQzdCLElBQUksQ0FDSCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLGFB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QU0sS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxRQUFRLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUM7UUFDOUUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMzRCxPQUFPLGlCQUFpQixJQUFJLGNBQWMsQ0FBQztJQUM3QyxDQUFDOzs7O1lBbk9GLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7OztZQVhULGdCQUFnQjtZQUN2QixVQUFVO1lBR25CLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFwaUNhbGwsIEFwaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2FwaSc7XG5pbXBvcnQgeyBORVZFUiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5cbi8qKlxuICogQXNzZXRUeXBlc1NlcnZpY2UgaXMgYmVpbmcgdXNlZCB0byBtYW5hZ2UgYSBjYWNoZSBvZiBhbGwgZXhpc3RpbmcgYXNzZXQgdHlwZXMuXG4gKiBUaGlzIHNlcnZpY2UgaXMgaW5qZWN0ZWQgaW4gdGhlIEFzc2V0T3ZlcnZpZXdOYXZpZ2F0aW9uRmFjdG9yeSBjbGFzcywgd2hpY2ggd2lsbCB0cmlnZ2VyXG4gKiB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNhY2hlIGFzIHRoZSBjb250c3RydWN0b3IgaXMgY2FsbGVkLlxuICovXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEFzc2V0VHlwZXNTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBBU1NFVF9UWVBFX0dST1VQX1FVRVJZID0ge1xuICAgIF9fZmlsdGVyOiB7XG4gICAgICBfX2FuZDogW3sgX19oYXM6ICdjOHlfSXNBc3NldFR5cGUnIH0sIHsgbmFtZTogJ2dyb3VwJyB9XVxuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGFzc2V0VHlwZXNDYWNoZTogb2JqZWN0ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9HUk9VUF9JQ09OID0gJ2M4eS1ncm91cCc7XG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9HUk9VUF9JQ09OX09QRU4gPSAnYzh5LWdyb3VwLW9wZW4nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW52ZW50b3J5OiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBpU2VydmljZTogQXBpU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFN0YXRlU2VydmljZTogQXBwU3RhdGVTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuYXBwU3RhdGVTZXJ2aWNlLmN1cnJlbnRVc2VyXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHVzZXIgPT4gdXNlcj8uaWQpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBzd2l0Y2hNYXAodXNlcklkID0+IHtcbiAgICAgICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRBc3NldFR5cGVzQ2FjaGUoKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZUZvckFzc2V0VHlwZVVwZGF0ZXMoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hc3NldFR5cGVzQ2FjaGUgPSB7fTtcbiAgICAgICAgICAgIHJldHVybiBORVZFUjtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogUXVlcmllcyBhdmFpbGFibGUgYXNzZXQgdHlwZXMgYW5kIGFkZHMgZXZlcnkgYXNzZXQgdHlwZSB0byB0aGUgbG9jYWwgY2FjaGUuXG4gICAqIEByZXR1cm5zIHZvaWQuXG4gICAqL1xuICBhc3luYyBpbml0QXNzZXRUeXBlc0NhY2hlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdCh7XG4gICAgICBmcmFnbWVudFR5cGU6ICdjOHlfSXNBc3NldFR5cGUnLFxuICAgICAgd2l0aENoaWxkcmVuOiBmYWxzZSxcbiAgICAgIHBhZ2VTaXplOiAyMDAwXG4gICAgfSk7XG4gICAgZGF0YS5mb3JFYWNoKGFzc2V0VHlwZSA9PiB0aGlzLmFkZEFzc2V0VHlwZShhc3NldFR5cGUpKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGNhY2hlIGJhc2VkIG9uIHRoZSB1bmlxdWUgbmFtZSBwcm9wZXJ0eS5cbiAgICogQHBhcmFtIG5hbWUgTmFtZSBvZiB0aGUgYXNzZXQgdHlwZS5cbiAgICogQHJldHVybnMgSU1hbmFnZWRPYmplY3Qgd2hpY2ggcmVwcmVzZW50cyB0aGUgYXNzZXQgdHlwZS5cbiAgICovXG4gIGdldEFzc2V0VHlwZUJ5TmFtZShuYW1lOiBzdHJpbmcpOiBJTWFuYWdlZE9iamVjdCB7XG4gICAgaWYgKCF0aGlzLmFzc2V0VHlwZXNDYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5hc3NldFR5cGVzQ2FjaGVbbmFtZV07XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGNhY2hlIGJhc2VkIG9uIHRoZSBpZC5cbiAgICogQHBhcmFtIGFzc2V0VHlwZUlkIElkIG9mIHRoZSBhc3NldCB0eXBlLlxuICAgKiBAcmV0dXJucyBJTWFuYWdlZE9iamVjdCB3aGljaCByZXByZXNlbnRzIHRoZSBhc3NldCB0eXBlLlxuICAgKi9cbiAgZ2V0QXNzZXRUeXBlQnlJZChhc3NldFR5cGVJZDogc3RyaW5nKTogSU1hbmFnZWRPYmplY3Qge1xuICAgIGlmICghYXNzZXRUeXBlSWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLmFzc2V0VHlwZXNDYWNoZSkuZmluZChcbiAgICAgIChhc3NldFR5cGU6IElNYW5hZ2VkT2JqZWN0KSA9PiBhc3NldFR5cGUuaWQgPT09IGFzc2V0VHlwZUlkXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0cyBhbiBpY29uIGZyb20gYW4gYXNzZXQgdHlwZS5cbiAgICogQHBhcmFtIHR5cGUgVHlwZSBvZiB0aGUgYXNzZXQgdHlwZS5cbiAgICogQHBhcmFtIG9wZW4gRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBtZXRob2Qgc2hvdWxkIHJldHVybiBhbiBhbHRlcm5hdGl2ZSBpY29uIHNob3dpbmcgdGhlIG9wZW4gc3RhdGUuXG4gICAqIERlZmF1bHRzIHRvIGZhbHNlLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGFuIGljb24gZm9yIGEgZ2l2ZW4gYXNzZXQgdHlwZS5cbiAgICovXG4gIGdldEljb24odHlwZTogc3RyaW5nLCBvcGVuOiBib29sZWFuID0gZmFsc2UpOiBzdHJpbmcge1xuICAgIGNvbnN0IGFzc2V0VHlwZSA9IHRoaXMuZ2V0QXNzZXRUeXBlQnlOYW1lKHR5cGUpO1xuICAgIGNvbnN0IGljb24gPSBhc3NldFR5cGU/LmM4eV9Jc0Fzc2V0VHlwZT8uaWNvbj8ubmFtZSB8fCB0aGlzLmdldERlZmF1bHRHcm91cEljb24ob3Blbik7XG4gICAgcmV0dXJuIGljb247XG4gIH1cblxuICBwcml2YXRlIGdldERlZmF1bHRHcm91cEljb24ob3BlbjogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgcmV0dXJuIG9wZW4gPyB0aGlzLkRFRkFVTFRfR1JPVVBfSUNPTl9PUEVOIDogdGhpcy5ERUZBVUxUX0dST1VQX0lDT047XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIHRoZSBkZWZhdWx0IGFzc2V0IHR5cGUgJ2dyb3VwJyBhbHJlYWR5IGV4aXN0cyBhbmQgaWYgaXQgZG9lc24ndCBpdCB3aWxsIGJlIGNyZWF0ZWQuXG4gICAqIEByZXR1cm5zIHZvaWQuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUFzc2V0VHlwZUdyb3VwSWZOb3RFeGlzdHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgbWFuYWdlZE9iamVjdHMgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdFF1ZXJ5KHRoaXMuQVNTRVRfVFlQRV9HUk9VUF9RVUVSWSkpLmRhdGE7XG5cbiAgICBpZiAobWFuYWdlZE9iamVjdHMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGlmIGRlZmF1bHQgZ3JvdXAgYXNzZXQgdHlwZSBkb2Vzbid0IGV4aXQgY3JlYXRlIGl0XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVEZWZhdWx0QXNzZXRUeXBlR3JvdXAoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjcmVhdGUgdGhlIGRlZmF1bHQgYXNzZXQgdHlwZSBncm91cCBpbiB0aGUgSW52ZW50b3J5LlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVEZWZhdWx0QXNzZXRUeXBlR3JvdXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY3JlYXRlKHtcbiAgICAgIGxhYmVsOiAnR3JvdXAnLFxuICAgICAgbmFtZTogJ2dyb3VwJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnRGVmYXVsdCBncm91cCBhc3NldCB0eXBlJyxcbiAgICAgIGM4eV9Jc0Fzc2V0VHlwZToge1xuICAgICAgICBpY29uOiAnZm9sZGVyJyxcbiAgICAgICAgcHJvcGVydHlJZHM6IFtdLFxuICAgICAgICBhbGxvd2VkQXNzZXRUeXBlSWRzOiBbXSxcbiAgICAgICAgaXNOb25lQ2hpbGRBc3NldHNBbGxvd2VkOiAnZmFsc2UnXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFuIGFzc2V0IHR5cGUgdG8gdGhlIGxvY2FsIGNhY2hlLlxuICAgKiBAcGFyYW0gYXNzZXRUeXBlIEFzc2V0IHR5cGUgd2hpY2ggc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSBjYWNoZS5cbiAgICogQHJldHVybnMgdm9pZC5cbiAgICovXG4gIHByaXZhdGUgYWRkQXNzZXRUeXBlKGFzc2V0VHlwZTogSU1hbmFnZWRPYmplY3QpOiB2b2lkIHtcbiAgICBpZiAoIWFzc2V0VHlwZSkge1xuICAgICAgY29uc29sZS5lcnJvcignQXNzZXQgdHlwZSBtdXN0IG5vdCBiZSBudWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hc3NldFR5cGVzQ2FjaGVbYXNzZXRUeXBlLm5hbWVdID0gYXNzZXRUeXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGxvY2FsIGNhY2hlIGJhc2VkIG9uIHRoZSBnaXZlbiBhc3NldCB0eXBlIGlkLlxuICAgKiBAcGFyYW0gYXNzZXRUeXBlSWQgSWQgb2YgdGhlIGFzc2V0IHR5cGUgd2hpY2ggc2hvdWxkIGJlIGRlbGV0ZWQuXG4gICAqIEByZXR1cm5zIHZvaWQuXG4gICAqL1xuICBwcml2YXRlIGRlbGV0ZUFzc2V0VHlwZShhc3NldFR5cGVJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCFhc3NldFR5cGVJZCkge1xuICAgICAgY29uc29sZS5lcnJvcignQXNzZXQgdHlwZSBJRCBtdXN0IG5vdCBiZSBudWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYXNzZXRUeXBlID0gdGhpcy5nZXRBc3NldFR5cGVCeUlkKGFzc2V0VHlwZUlkKTtcbiAgICBpZiAoYXNzZXRUeXBlKSB7XG4gICAgICBkZWxldGUgdGhpcy5hc3NldFR5cGVzQ2FjaGVbYXNzZXRUeXBlLm5hbWVdO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogVXBkYXRlIGFuIGFzc2V0IHR5cGUgaW4gdGhlIGxvY2FsIGNhY2hlLlxuICAgKiBAcGFyYW0gYXNzZXRUeXBlIEFzc2V0IHR5cGUgd2hpY2ggc2hvdWxkIGJlIHVwZGF0ZWQgaW4gdGhlIGNhY2hlLlxuICAgKiBAcmV0dXJucyB2b2lkLlxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVBc3NldFR5cGUoYXNzZXRUeXBlOiBJTWFuYWdlZE9iamVjdCk6IHZvaWQge1xuICAgIGlmICghYXNzZXRUeXBlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdBc3NldCB0eXBlIG11c3Qgbm90IGJlIG51bGwnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjYWNoZWRBc3NldFR5cGUgPSB0aGlzLmdldEFzc2V0VHlwZUJ5SWQoYXNzZXRUeXBlLmlkKTtcbiAgICBpZiAoY2FjaGVkQXNzZXRUeXBlKSB7XG4gICAgICB0aGlzLmFzc2V0VHlwZXNDYWNoZVtjYWNoZWRBc3NldFR5cGUubmFtZV0gPSBPYmplY3QuYXNzaWduKGNhY2hlZEFzc2V0VHlwZSwgYXNzZXRUeXBlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlcyB0byBhcGkgUFVULCBQT1NUIGFuZCBERUxFVEUgcmVxdWVzdHMgaW50ZXJjZXB0b3IgdG8gdXBkYXRlIGxvY2FsIGFzc2V0IHR5cGVzIGNhY2hlLlxuICAgKiBJZiBhIG5ldyBhc3NldCB0eXBlIGhhcyBiZWVuIGNyZWF0ZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgbG9jYWwgY2FjaGUuIElmIGFuIGFzc2V0XG4gICAqIHR5cGUgaGFzIGJlZW4gZGVsZXRlZCBpdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgbG9jYWwgY2FjaGUuXG4gICAqL1xuICBwcml2YXRlIHN1YnNjcmliZUZvckFzc2V0VHlwZVVwZGF0ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZVxuICAgICAgLmhvb2tSZXNwb25zZShjID0+IHRoaXMuY2hlY2tJZkludmVudG9yeU1vQXBpQ2FsbChjKSlcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKGNhbGw6IEFwaUNhbGwpID0+IHtcbiAgICAgICAgICBpZiAoIWNhbGwgJiYgIWNhbGwubWV0aG9kKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGJvZHlUb1BhcnNlID0gY2FsbC5vcHRpb25zPy5ib2R5O1xuICAgICAgICAgIGlmIChib2R5VG9QYXJzZSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3QgbW86IElNYW5hZ2VkT2JqZWN0ID0gSlNPTi5wYXJzZShib2R5VG9QYXJzZSBhcyBzdHJpbmcpO1xuXG4gICAgICAgICAgICAgIGlmIChjYWxsLm1ldGhvZCA9PT0gJ0RFTEVURScpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUFzc2V0VHlwZShtby5pZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKCFtby5oYXNPd25Qcm9wZXJ0eSgnYzh5X0lzQXNzZXRUeXBlJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAoY2FsbC5tZXRob2QgPT09ICdQVVQnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBc3NldFR5cGUobW8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHRoaXMuYWRkQXNzZXRUeXBlKG1vKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hbmFnZWQgb2JqZWN0cyBpbnZlbnRvcnkgYXBpIGZpbHRlciwgYWxsb3dpbmcgb25seSBQVVQsIFBPU1QgYW5kIERFTEVURSBtZXRob2RzLlxuICAgKiBAcGFyYW0gY2FsbCBBcGkgY2FsbCB0byBmaWx0ZXIuXG4gICAqIEByZXR1cm5zIFJldHVybnMgdHJ1ZSBpZiBhcGkgY2FsbCBtZWV0cyB0aGUgcmVxdWlyZWQgY3JpdGVyaWEuXG4gICAqL1xuICBwcml2YXRlIGNoZWNrSWZJbnZlbnRvcnlNb0FwaUNhbGwoY2FsbDogQXBpQ2FsbCk6IGJvb2xlYW4ge1xuICAgIGlmICghY2FsbCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc1JlcXVpcmVkTWV0aG9kID1cbiAgICAgIGNhbGwubWV0aG9kID09PSAnUE9TVCcgfHwgY2FsbC5tZXRob2QgPT09ICdERUxFVEUnIHx8IGNhbGwubWV0aG9kID09PSAnUFVUJztcbiAgICBjb25zdCBoYXNSZXF1aXJlZFVybCA9IGNhbGwudXJsLmluY2x1ZGVzKCdtYW5hZ2VkT2JqZWN0cycpO1xuICAgIHJldHVybiBoYXNSZXF1aXJlZE1ldGhvZCAmJiBoYXNSZXF1aXJlZFVybDtcbiAgfVxufVxuIl19