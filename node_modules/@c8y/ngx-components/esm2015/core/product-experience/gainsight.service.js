import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { camelCase } from 'lodash-es';
import { BehaviorSubject, combineLatest, fromEvent } from 'rxjs';
import { delay, filter, map, take } from 'rxjs/operators';
import { CookieBannerService } from '../bootstrap/cookie-banner/cookie-banner.service';
import { OptionsService } from '../common/options.service';
import { AppStateService } from '../common/ui-state.service';
import { UserPreferencesService } from '../common/user-preferences/user-preferences.service';
import * as i0 from "@angular/core";
import * as i1 from "../common/ui-state.service";
import * as i2 from "../common/options.service";
import * as i3 from "../bootstrap/cookie-banner/cookie-banner.service";
import * as i4 from "../common/user-preferences/user-preferences.service";
import * as i5 from "@ngx-translate/core";
/**
 * A service to manage the Gainsight integration. It allows to load the
 * tag and
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../common/ui-state.service';
import * as ɵngcc2 from '../common/options.service';
import * as ɵngcc3 from '../bootstrap/cookie-banner/cookie-banner.service';
import * as ɵngcc4 from '../common/user-preferences/user-preferences.service';
import * as ɵngcc5 from '@ngx-translate/core';
export class GainsightService {
    constructor(appState, options, cookieBannerService, userPreferencesService, translateService) {
        this.appState = appState;
        this.options = options;
        this.cookieBannerService = cookieBannerService;
        this.userPreferencesService = userPreferencesService;
        this.translateService = translateService;
        /**
         * A subject that emits the tag function as soon as a new tag is set.
         */
        this.tagFunction$ = new BehaviorSubject(null);
        this.USER_PREFERENCES_KEY = 'gainsightEnabled';
        this.GAINSIGHT_URL = 'web-sdk.aptrinsic.com/api/aptrinsic.js?a=';
        this.GAINSIGHT_GLOBAL_SCOPE = 'aptrinsic';
        this.SCRIPT_EXECUTION_WAIT_TIME = 500;
        this.OPTIONS_KEY_CATEGORY = 'gainsight';
        this.OPTIONS_KEY_NAME = 'api.key';
        this.isScriptLoaded = false;
    }
    isGainsightDisabledInUserPreferences() {
        return __awaiter(this, void 0, void 0, function* () {
            const userGainsightPref = yield this.userPreferencesService
                .get(this.USER_PREFERENCES_KEY)
                .toPromise();
            return userGainsightPref === false;
        });
    }
    setFunctionalCookie(value) {
        const cookies = this.cookieBannerService.getUserCookiePreferences();
        if (cookies) {
            Object.keys(cookies).forEach(cookieName => {
                if (cookieName === 'functional') {
                    cookies[cookieName] = value;
                    return;
                }
            });
            localStorage.setItem('acceptCookieNotice', JSON.stringify(cookies));
        }
    }
    getGainsightKey() {
        return __awaiter(this, void 0, void 0, function* () {
            this.gainsightKey =
                this.options.gainsightKey ||
                    (yield this.options.getSystemOption(this.OPTIONS_KEY_CATEGORY, this.OPTIONS_KEY_NAME));
            return this.gainsightKey;
        });
    }
    /**
     * Returns the tag global function which can be used to identify user
     * or add special events.
     */
    get tagFunction() {
        return window[this.GAINSIGHT_GLOBAL_SCOPE];
    }
    /**
     * Load the script tag and calls the identify function to start the tracking.
     * @param currentTenant The current tenant.
     * @param identify If set to false, only the tag is loaded.
     */
    loadTag(currentTenant, identify = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const scriptTag = document.createElement('script');
            const key = yield this.getGainsightKey();
            if (key && !this.isScriptLoaded) {
                this.loadScriptTag(scriptTag, key);
                combineLatest(this.appState.currentUser, fromEvent(scriptTag, 'load'), this.appState.state$.pipe(filter(({ versions }) => versions.backend), map(({ versions }) => versions), take(1)))
                    .pipe(delay(this.SCRIPT_EXECUTION_WAIT_TIME), filter(([user, scriptEvent]) => !!(scriptEvent && user)))
                    .subscribe(([user, scriptEvent, versions]) => {
                    const instanceId = this.getInstanceIdFromUrl();
                    if (identify) {
                        this.identify(user, currentTenant, instanceId, versions.ui.ngx, versions.backend);
                    }
                    this.isScriptLoaded = true;
                    this.tagFunction$.next(this.tagFunction);
                });
            }
        });
    }
    /**
     * Identifies the user/account at Gainsight.
     * @param user The user which is given to Gainsight.
     * @param tenant The tenant which is given to Gainsight.
     * @param versionUI The UI version used.
     * @param versionBE The BE version used.
     */
    identify(user, tenant, instanceId, versionUI, versionBE) {
        const windowRef = window;
        const { id: userId, email, userName, firstName, lastName } = user;
        const { name, customProperties, domainName } = tenant;
        const { externalReference } = customProperties || {};
        windowRef[this.GAINSIGHT_GLOBAL_SCOPE]('identify', {
            id: `${userId}_${name}_${instanceId}`,
            email,
            userName,
            firstName,
            lastName,
            domainName,
            versionUI,
            versionBE,
            userLanguage: this.translateService.currentLang,
            instanceId,
            externalReference
        }, {
            id: `${name}_${instanceId}`,
            instanceId
        });
    }
    triggerEvent(eventName, props) {
        if (this.tagFunction && eventName) {
            eventName = this.prepareEventName(eventName);
            this.tagFunction('track', eventName, props);
        }
    }
    translateToEnglish(textToTranslate) {
        const { currentLang } = this.translateService;
        if (currentLang === 'en') {
            return textToTranslate;
        }
        if (currentLang && currentLang !== this.cachedLanguage) {
            this.cachedRevertedTranslations = undefined;
        }
        if (!this.cachedRevertedTranslations) {
            this.cachedLanguage = currentLang;
            this.cachedRevertedTranslations = this.getRevertedTranslations(currentLang);
        }
        return this.getEnTranslation(textToTranslate, this.cachedRevertedTranslations);
    }
    /**
     * Checks if the Gainsight's tag should be loaded.
     * The decision to load Gainsight will depend on custom properties and functional cookies.
     * @param customProperties Tenant's customProperties.
     */
    shouldLoadGainsightTag(customProperties) {
        return (this.cookieBannerService.isConfigCookiePreferencesDefined() &&
            this.cookieBannerService.isFunctionalCookieEnabled() &&
            !this.isGainsightDisabled(customProperties) &&
            !this.isCustomBranding());
    }
    canEditProductExperienceSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            const currentTenant = this.appState.currentTenant.value;
            const { customProperties } = currentTenant;
            const gainsightKey = !!this.gainsightKey || !!(yield this.getGainsightKey());
            return (gainsightKey &&
                this.cookieBannerService.isConfigCookiePreferencesDefined() &&
                !this.isGainsightDisabled(customProperties) &&
                !!this.cookieBannerService.getUserCookiePreferences() &&
                !this.isCustomBranding());
        });
    }
    prepareEventName(baseEventName) {
        return baseEventName
            .split(':')
            .map(eventNamePart => camelCase(removeTranslationContext(eventNamePart)))
            .join(':');
        function removeTranslationContext(eventNamePart) {
            return eventNamePart.replace(/`[\w\W]*`/g, '');
        }
    }
    isGainsightDisabled(customProperties) {
        const gainsightEnabled = customProperties && customProperties.gainsightEnabled;
        return gainsightEnabled === false;
    }
    isCustomBranding() {
        const brandingCssVars = this.options.get('brandingCssVars') || {};
        return !!brandingCssVars['brand-logo-img'];
    }
    loadScriptTag(scriptTag, key) {
        try {
            const windowRef = window;
            const firstTag = document.getElementsByTagName('script')[0];
            const protocol = location.protocol;
            const gainsightGlobalScope = this.GAINSIGHT_GLOBAL_SCOPE;
            scriptTag.src = `${protocol}//${this.GAINSIGHT_URL}${key}`;
            (windowRef[this.GAINSIGHT_GLOBAL_SCOPE] =
                windowRef[this.GAINSIGHT_GLOBAL_SCOPE] ||
                    // tslint:disable-next-line:only-arrow-functions
                    function () {
                        (windowRef[gainsightGlobalScope].q = windowRef[gainsightGlobalScope].q || []).push(arguments);
                    }),
                (windowRef[gainsightGlobalScope].p = key);
            scriptTag.async = true;
            firstTag.parentNode.insertBefore(scriptTag, firstTag);
        }
        catch (ex) {
            console.warn('Failed to load Gainsight PX', ex);
        }
    }
    getInstanceIdFromUrl() {
        const hostName = location.hostname;
        return hostName.substring(hostName.indexOf('.') + 1);
    }
    /**
     * Reverses the translation object.
     *
     * **Example**
     * { Add widget: "Widget hinzufügen" }
     *
     * will be changed to:
     *
     * { Widget hinzufügen: "Add widget" }
     *
     * @param currentLang Language whose translated values are to be placed in the object key.
     * @returns Returns an inverted object where the keys have been swapped with the values.
     */
    getRevertedTranslations(currentLang) {
        const translations = this.translateService.store.translations[currentLang];
        const swappedKeysWithValues = {};
        Object.keys(translations).forEach(key => {
            swappedKeysWithValues[translations[key]] = key;
        });
        return swappedKeysWithValues;
    }
    /**Translates string back into English.
     * If the current application language is set to English, the string passed as an argument is returned.
     * @param textToTranslate string to translate.
     * @returns Returns the string translated into English.
     */
    getEnTranslation(textToTranslate, translations) {
        let enTranslation = translations[textToTranslate];
        if (!enTranslation) {
            return textToTranslate;
        }
        /** remove translation context */
        const regex = /\`(.*?)\`/;
        enTranslation = enTranslation.replace(regex, '');
        return enTranslation;
    }
}
GainsightService.ɵfac = function GainsightService_Factory(t) { return new (t || GainsightService)(ɵngcc0.ɵɵinject(ɵngcc1.AppStateService), ɵngcc0.ɵɵinject(ɵngcc2.OptionsService), ɵngcc0.ɵɵinject(ɵngcc3.CookieBannerService), ɵngcc0.ɵɵinject(ɵngcc4.UserPreferencesService), ɵngcc0.ɵɵinject(ɵngcc5.TranslateService)); };
GainsightService.ɵprov = i0.ɵɵdefineInjectable({ factory: function GainsightService_Factory() { return new GainsightService(i0.ɵɵinject(i1.AppStateService), i0.ɵɵinject(i2.OptionsService), i0.ɵɵinject(i3.CookieBannerService), i0.ɵɵinject(i4.UserPreferencesService), i0.ɵɵinject(i5.TranslateService)); }, token: GainsightService, providedIn: "root" });
GainsightService.ctorParameters = () => [
    { type: AppStateService },
    { type: OptionsService },
    { type: CookieBannerService },
    { type: UserPreferencesService },
    { type: TranslateService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(GainsightService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AppStateService }, { type: ɵngcc2.OptionsService }, { type: ɵngcc3.CookieBannerService }, { type: ɵngcc4.UserPreferencesService }, { type: ɵngcc5.TranslateService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FpbnNpZ2h0LnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvcHJvZHVjdC1leHBlcmllbmNlL2dhaW5zaWdodC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUN2RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQzdGO0FBRWdDO0FBQ3RCO0FBS0o7QUFFa0M7QUFFSDtBQVhyQztBQUNBO0FBQ0E7QUFDQSxHQUFHOzs7Ozs7O0FBSUgsTUFBTSxPQUFPLGdCQUFnQjtBQUM3QixJQWdCRSxZQUNVLFFBQXlCLEVBQ3pCLE9BQXVCLEVBQ3ZCLG1CQUF3QyxFQUN4QyxzQkFBOEMsRUFDOUMsZ0JBQWtDO0FBQzNDLFFBTFMsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7QUFBQyxRQUMxQixZQUFPLEdBQVAsT0FBTyxDQUFnQjtBQUFDLFFBQ3hCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7QUFBQyxRQUN6QywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO0FBQUMsUUFDL0MscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUM5QyxRQXRCRTtBQUNGO0FBRUEsV0FESztBQUNMLFFBQUUsaUJBQVksR0FBRyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMzQyxRQUNXLHlCQUFvQixHQUFHLGtCQUFrQixDQUFDO0FBQ3JELFFBQW1CLGtCQUFhLEdBQUcsMkNBQTJDLENBQUM7QUFDL0UsUUFBbUIsMkJBQXNCLEdBQUcsV0FBVyxDQUFDO0FBQ3hELFFBQW1CLCtCQUEwQixHQUFHLEdBQUcsQ0FBQztBQUNwRCxRQUFtQix5QkFBb0IsR0FBRyxXQUFXLENBQUM7QUFDdEQsUUFBbUIscUJBQWdCLEdBQUcsU0FBUyxDQUFDO0FBQ2hELFFBQVUsbUJBQWMsR0FBWSxLQUFLLENBQUM7QUFDMUMsSUFVSyxDQUFDO0FBQ04sSUFDUSxvQ0FBb0M7QUFDNUM7QUFBOEQsWUFBMUQsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0I7QUFDL0QsaUJBQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztBQUNyQyxpQkFBTyxTQUFTLEVBQUUsQ0FBQztBQUNuQixZQUFJLE9BQU8saUJBQWlCLEtBQUssS0FBSyxDQUFDO0FBQ3ZDLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNFLG1CQUFtQixDQUFDLEtBQWM7QUFDcEMsUUFBSSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztBQUN4RSxRQUFJLElBQUksT0FBTyxFQUFFO0FBQ2pCLFlBQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7QUFDaEQsZ0JBQVEsSUFBSSxVQUFVLEtBQUssWUFBWSxFQUFFO0FBQ3pDLG9CQUFVLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxLQUFLLENBQUM7QUFDdEMsb0JBQVUsT0FBTztBQUNqQixpQkFBUztBQUNULFlBQU0sQ0FBQyxDQUFDLENBQUM7QUFDVCxZQUFNLFlBQVksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQzFFLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNRLGVBQWU7QUFDdkI7QUFFRyxZQUZDLElBQUksQ0FBQyxZQUFZO0FBQ3JCLGdCQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWTtBQUMvQixvQkFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7QUFDN0YsWUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDN0IsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0UsT0FBQztBQUNMLElBQUUsSUFBSSxXQUFXO0FBQ2pCLFFBQUksT0FBUSxNQUFjLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDeEQsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUVKLE9BREs7QUFDTCxJQUFRLE9BQU8sQ0FBQyxhQUFhLEVBQUUsUUFBUSxHQUFHLElBQUk7QUFDOUM7QUFDTSxZQURGLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkQsWUFBSSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztBQUM3QyxZQUNJLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUNyQyxnQkFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN6QyxnQkFBTSxhQUFhLENBQ1gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQ3pCLFNBQVMsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQzVCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDdkIsTUFBTSxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUMxQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFDL0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNSLENBQ0Y7QUFDUCxxQkFBUyxJQUFJLENBQ0gsS0FBSyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxFQUN0QyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQ3pEO0FBQ1QscUJBQVMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxFQUFFLEVBQUU7QUFDckQsb0JBQVUsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7QUFDekQsb0JBQVUsSUFBSSxRQUFRLEVBQUU7QUFDeEIsd0JBQVksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDOUYscUJBQVc7QUFDWCxvQkFBVSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztBQUNyQyxvQkFBVSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDbkQsZ0JBQVEsQ0FBQyxDQUFDLENBQUM7QUFDWCxhQUFLO0FBQ0wsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFDRTtBQUNFO0FBRUosT0FEQztBQUNMLElBQUUsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVUsRUFBRSxTQUFVO0FBQzNELFFBQUksTUFBTSxTQUFTLEdBQUcsTUFBYSxDQUFDO0FBQ3BDLFFBQUksTUFBTSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ3RFLFFBQUksTUFBTSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFDMUQsUUFBSSxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxnQkFBZ0IsSUFBSSxFQUFFLENBQUM7QUFDekQsUUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQ3BDLFVBQVUsRUFDVjtBQUNOLFlBQVEsRUFBRSxFQUFFLEdBQUcsTUFBTSxJQUFJLElBQUksSUFBSSxVQUFVLEVBQUU7QUFDN0MsWUFBUSxLQUFLO0FBQ2IsWUFBUSxRQUFRO0FBQ2hCLFlBQVEsU0FBUztBQUNqQixZQUFRLFFBQVE7QUFDaEIsWUFBUSxVQUFVO0FBQ2xCLFlBQVEsU0FBUztBQUNqQixZQUFRLFNBQVM7QUFDakIsWUFBUSxZQUFZLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVc7QUFDdkQsWUFBUSxVQUFVO0FBQ2xCLFlBQVEsaUJBQWlCO0FBQ3pCLFNBQU8sRUFDRDtBQUNOLFlBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxJQUFJLFVBQVUsRUFBRTtBQUNuQyxZQUFRLFVBQVU7QUFDbEIsU0FBTyxDQUNGLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSCxJQUNFLFlBQVksQ0FBQyxTQUFpQixFQUFFLEtBQWM7QUFDaEQsUUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksU0FBUyxFQUFFO0FBQ3ZDLFlBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNuRCxZQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNsRCxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDRSxrQkFBa0IsQ0FBQyxlQUF1QjtBQUFJLFFBQzVDLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7QUFDbEQsUUFDSSxJQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUU7QUFDOUIsWUFBTSxPQUFPLGVBQWUsQ0FBQztBQUM3QixTQUFLO0FBQ0wsUUFDSSxJQUFJLFdBQVcsSUFBSSxXQUFXLEtBQUssSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUM1RCxZQUFNLElBQUksQ0FBQywwQkFBMEIsR0FBRyxTQUFTLENBQUM7QUFDbEQsU0FBSztBQUNMLFFBQ0ksSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRTtBQUMxQyxZQUFNLElBQUksQ0FBQyxjQUFjLEdBQUcsV0FBVyxDQUFDO0FBQ3hDLFlBQU0sSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNsRixTQUFLO0FBQ0wsUUFDSSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDbkYsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUVKLE9BREs7QUFDTCxJQUFFLHNCQUFzQixDQUFDLGdCQUFtQztBQUFJLFFBQzVELE9BQU8sQ0FDTCxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0NBQWdDLEVBQUU7QUFDakUsWUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMseUJBQXlCLEVBQUU7QUFDMUQsWUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNqRCxZQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQ3pCLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSCxJQUNRLGdDQUFnQztBQUFLO0FBQ0QsWUFBeEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDO0FBQzVELFlBQUksTUFBTSxFQUFFLGdCQUFnQixFQUFFLEdBQUcsYUFBYSxDQUFDO0FBQy9DLFlBQ0ksTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQztBQUNqRixZQUNJLE9BQU8sQ0FDTCxZQUFZO0FBQ2xCLGdCQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQ0FBZ0MsRUFBRTtBQUNqRSxnQkFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNqRCxnQkFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLHdCQUF3QixFQUFFO0FBQzNELGdCQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQ3pCLENBQUM7QUFDTixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDVSxnQkFBZ0IsQ0FBQyxhQUFxQjtBQUFJLFFBQ2hELE9BQU8sYUFBYTtBQUN4QixhQUFLLEtBQUssQ0FBQyxHQUFHLENBQUM7QUFDZixhQUFLLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0FBQzdFLGFBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2YsUUFDSSxTQUFTLHdCQUF3QixDQUFDLGFBQXFCO0FBQUksWUFDekQsT0FBTyxhQUFhLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNyRCxRQUFJLENBQUM7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNVLG1CQUFtQixDQUFDLGdCQUFtQztBQUNqRSxRQUFJLE1BQU0sZ0JBQWdCLEdBQUcsZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUM7QUFDbkYsUUFBSSxPQUFPLGdCQUFnQixLQUFLLEtBQUssQ0FBQztBQUN0QyxJQUFFLENBQUM7QUFDSCxJQUNVLGdCQUFnQjtBQUFLLFFBQzNCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3RFLFFBQUksT0FBTyxDQUFDLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDL0MsSUFBRSxDQUFDO0FBQ0gsSUFDVSxhQUFhLENBQUMsU0FBNEIsRUFBRSxHQUFXO0FBQ2pFLFFBQUksSUFBSTtBQUNSLFlBQU0sTUFBTSxTQUFTLEdBQUcsTUFBYSxDQUFDO0FBQ3RDLFlBQU0sTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xFLFlBQU0sTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQztBQUN6QyxZQUFNLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDO0FBQy9ELFlBQU0sU0FBUyxDQUFDLEdBQUcsR0FBRyxHQUFHLFFBQVEsS0FBSyxJQUFJLENBQUMsYUFBYSxHQUFHLEdBQUcsRUFBRSxDQUFDO0FBQ2pFLFlBQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDO0FBQzdDLGdCQUFRLFNBQVMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUM7QUFDOUMsb0JBQVEsZ0RBQWdEO0FBQ3hELG9CQUFRO0FBQ1Asd0JBQVMsQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDaEYsU0FBUyxDQUNWLENBQUM7QUFDWixvQkFBUSxDQUFDLENBQUM7QUFDVixnQkFBUSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNsRCxZQUFNLFNBQVMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQzdCLFlBQU0sUUFBUSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzVELFNBQUs7QUFBQyxRQUFBLE9BQU8sRUFBRSxFQUFFO0FBQ2pCLFlBQU0sT0FBTyxDQUFDLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUN0RCxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDVSxvQkFBb0I7QUFDOUIsUUFBSSxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDO0FBQ3ZDLFFBQUksT0FBTyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDekQsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUNFO0FBRUg7QUFBTztBQUVIO0FBQU87QUFFSDtBQUFPO0FBQ0U7QUFFSixPQURYO0FBQ0wsSUFBVSx1QkFBdUIsQ0FBQyxXQUFtQjtBQUFJLFFBQ3JELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQy9FLFFBQ0ksTUFBTSxxQkFBcUIsR0FBRyxFQUFFLENBQUM7QUFDckMsUUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUM1QyxZQUFNLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQztBQUNyRCxRQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ1AsUUFBSSxPQUFPLHFCQUFxQixDQUFDO0FBQ2pDLElBQUUsQ0FBQztBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFFSixPQURLO0FBQ0wsSUFBVSxnQkFBZ0IsQ0FBQyxlQUF1QixFQUFFLFlBQXVDO0FBQUksUUFDM0YsSUFBSSxhQUFhLEdBQUcsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3RELFFBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtBQUN4QixZQUFNLE9BQU8sZUFBZSxDQUFDO0FBQzdCLFNBQUs7QUFDTCxRQUFJLGlDQUFpQztBQUNyQyxRQUFJLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQztBQUM5QixRQUFJLGFBQWEsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNyRCxRQUNJLE9BQU8sYUFBYSxDQUFDO0FBQ3pCLElBQUUsQ0FBQztBQUNIOzZUQUFDO0FBQ0QsK1ZBalJLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBS0YsWUFaRCxlQUFlO1FBUXRCLFVBQVUsRUFBRSxNQUFNLDFCQVJRLFlBRG5CLGNBQWM7VUFVdEIsVkFWMEIsWUFEbEIsbUJBQW1CO0FBQUksWUFHdkIsc0JBQXNCO0FBQUksWUFQMUIsZ0JBQWdCO0FBQUc7Ozs7OzttT0FBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSUN1c3RvbVByb3BlcnRpZXMgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBjYW1lbENhc2UgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlbGF5LCBmaWx0ZXIsIG1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvb2tpZUJhbm5lclNlcnZpY2UgfSBmcm9tICcuLi9ib290c3RyYXAvY29va2llLWJhbm5lci9jb29raWUtYmFubmVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3B0aW9uc1NlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IEFwcFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdXNlci1wcmVmZXJlbmNlcy91c2VyLXByZWZlcmVuY2VzLnNlcnZpY2UnO1xuXG4vKipcbiAqIEEgc2VydmljZSB0byBtYW5hZ2UgdGhlIEdhaW5zaWdodCBpbnRlZ3JhdGlvbi4gSXQgYWxsb3dzIHRvIGxvYWQgdGhlXG4gKiB0YWcgYW5kXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEdhaW5zaWdodFNlcnZpY2Uge1xuICAvKipcbiAgICogQSBzdWJqZWN0IHRoYXQgZW1pdHMgdGhlIHRhZyBmdW5jdGlvbiBhcyBzb29uIGFzIGEgbmV3IHRhZyBpcyBzZXQuXG4gICAqL1xuICB0YWdGdW5jdGlvbiQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuXG4gIHJlYWRvbmx5IFVTRVJfUFJFRkVSRU5DRVNfS0VZID0gJ2dhaW5zaWdodEVuYWJsZWQnO1xuICBwcml2YXRlIHJlYWRvbmx5IEdBSU5TSUdIVF9VUkwgPSAnd2ViLXNkay5hcHRyaW5zaWMuY29tL2FwaS9hcHRyaW5zaWMuanM/YT0nO1xuICBwcml2YXRlIHJlYWRvbmx5IEdBSU5TSUdIVF9HTE9CQUxfU0NPUEUgPSAnYXB0cmluc2ljJztcbiAgcHJpdmF0ZSByZWFkb25seSBTQ1JJUFRfRVhFQ1VUSU9OX1dBSVRfVElNRSA9IDUwMDtcbiAgcHJpdmF0ZSByZWFkb25seSBPUFRJT05TX0tFWV9DQVRFR09SWSA9ICdnYWluc2lnaHQnO1xuICBwcml2YXRlIHJlYWRvbmx5IE9QVElPTlNfS0VZX05BTUUgPSAnYXBpLmtleSc7XG4gIHByaXZhdGUgaXNTY3JpcHRMb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBnYWluc2lnaHRLZXk6IHN0cmluZztcbiAgcHJpdmF0ZSBjYWNoZWRSZXZlcnRlZFRyYW5zbGF0aW9uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcHJpdmF0ZSBjYWNoZWRMYW5ndWFnZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZSxcbiAgICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgY29va2llQmFubmVyU2VydmljZTogQ29va2llQmFubmVyU2VydmljZSxcbiAgICBwcml2YXRlIHVzZXJQcmVmZXJlbmNlc1NlcnZpY2U6IFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBpc0dhaW5zaWdodERpc2FibGVkSW5Vc2VyUHJlZmVyZW5jZXMoKSB7XG4gICAgY29uc3QgdXNlckdhaW5zaWdodFByZWYgPSBhd2FpdCB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2VcbiAgICAgIC5nZXQodGhpcy5VU0VSX1BSRUZFUkVOQ0VTX0tFWSlcbiAgICAgIC50b1Byb21pc2UoKTtcbiAgICByZXR1cm4gdXNlckdhaW5zaWdodFByZWYgPT09IGZhbHNlO1xuICB9XG5cbiAgc2V0RnVuY3Rpb25hbENvb2tpZSh2YWx1ZTogYm9vbGVhbikge1xuICAgIGNvbnN0IGNvb2tpZXMgPSB0aGlzLmNvb2tpZUJhbm5lclNlcnZpY2UuZ2V0VXNlckNvb2tpZVByZWZlcmVuY2VzKCk7XG4gICAgaWYgKGNvb2tpZXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKGNvb2tpZXMpLmZvckVhY2goY29va2llTmFtZSA9PiB7XG4gICAgICAgIGlmIChjb29raWVOYW1lID09PSAnZnVuY3Rpb25hbCcpIHtcbiAgICAgICAgICBjb29raWVzW2Nvb2tpZU5hbWVdID0gdmFsdWU7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdhY2NlcHRDb29raWVOb3RpY2UnLCBKU09OLnN0cmluZ2lmeShjb29raWVzKSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0R2FpbnNpZ2h0S2V5KCkge1xuICAgIHRoaXMuZ2FpbnNpZ2h0S2V5ID1cbiAgICAgIHRoaXMub3B0aW9ucy5nYWluc2lnaHRLZXkgfHxcbiAgICAgIChhd2FpdCB0aGlzLm9wdGlvbnMuZ2V0U3lzdGVtT3B0aW9uKHRoaXMuT1BUSU9OU19LRVlfQ0FURUdPUlksIHRoaXMuT1BUSU9OU19LRVlfTkFNRSkpO1xuICAgIHJldHVybiB0aGlzLmdhaW5zaWdodEtleTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB0YWcgZ2xvYmFsIGZ1bmN0aW9uIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGlkZW50aWZ5IHVzZXJcbiAgICogb3IgYWRkIHNwZWNpYWwgZXZlbnRzLlxuICAgKi9cbiAgZ2V0IHRhZ0Z1bmN0aW9uKCkge1xuICAgIHJldHVybiAod2luZG93IGFzIGFueSlbdGhpcy5HQUlOU0lHSFRfR0xPQkFMX1NDT1BFXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkIHRoZSBzY3JpcHQgdGFnIGFuZCBjYWxscyB0aGUgaWRlbnRpZnkgZnVuY3Rpb24gdG8gc3RhcnQgdGhlIHRyYWNraW5nLlxuICAgKiBAcGFyYW0gY3VycmVudFRlbmFudCBUaGUgY3VycmVudCB0ZW5hbnQuXG4gICAqIEBwYXJhbSBpZGVudGlmeSBJZiBzZXQgdG8gZmFsc2UsIG9ubHkgdGhlIHRhZyBpcyBsb2FkZWQuXG4gICAqL1xuICBhc3luYyBsb2FkVGFnKGN1cnJlbnRUZW5hbnQsIGlkZW50aWZ5ID0gdHJ1ZSkge1xuICAgIGNvbnN0IHNjcmlwdFRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIGNvbnN0IGtleSA9IGF3YWl0IHRoaXMuZ2V0R2FpbnNpZ2h0S2V5KCk7XG5cbiAgICBpZiAoa2V5ICYmICF0aGlzLmlzU2NyaXB0TG9hZGVkKSB7XG4gICAgICB0aGlzLmxvYWRTY3JpcHRUYWcoc2NyaXB0VGFnLCBrZXkpO1xuICAgICAgY29tYmluZUxhdGVzdChcbiAgICAgICAgdGhpcy5hcHBTdGF0ZS5jdXJyZW50VXNlcixcbiAgICAgICAgZnJvbUV2ZW50KHNjcmlwdFRhZywgJ2xvYWQnKSxcbiAgICAgICAgdGhpcy5hcHBTdGF0ZS5zdGF0ZSQucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKHsgdmVyc2lvbnMgfSkgPT4gdmVyc2lvbnMuYmFja2VuZCksXG4gICAgICAgICAgbWFwKCh7IHZlcnNpb25zIH0pID0+IHZlcnNpb25zKSxcbiAgICAgICAgICB0YWtlKDEpXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZGVsYXkodGhpcy5TQ1JJUFRfRVhFQ1VUSU9OX1dBSVRfVElNRSksXG4gICAgICAgICAgZmlsdGVyKChbdXNlciwgc2NyaXB0RXZlbnRdKSA9PiAhIShzY3JpcHRFdmVudCAmJiB1c2VyKSlcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKChbdXNlciwgc2NyaXB0RXZlbnQsIHZlcnNpb25zXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGluc3RhbmNlSWQgPSB0aGlzLmdldEluc3RhbmNlSWRGcm9tVXJsKCk7XG4gICAgICAgICAgaWYgKGlkZW50aWZ5KSB7XG4gICAgICAgICAgICB0aGlzLmlkZW50aWZ5KHVzZXIsIGN1cnJlbnRUZW5hbnQsIGluc3RhbmNlSWQsIHZlcnNpb25zLnVpLm5neCwgdmVyc2lvbnMuYmFja2VuZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuaXNTY3JpcHRMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMudGFnRnVuY3Rpb24kLm5leHQodGhpcy50YWdGdW5jdGlvbik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJZGVudGlmaWVzIHRoZSB1c2VyL2FjY291bnQgYXQgR2FpbnNpZ2h0LlxuICAgKiBAcGFyYW0gdXNlciBUaGUgdXNlciB3aGljaCBpcyBnaXZlbiB0byBHYWluc2lnaHQuXG4gICAqIEBwYXJhbSB0ZW5hbnQgVGhlIHRlbmFudCB3aGljaCBpcyBnaXZlbiB0byBHYWluc2lnaHQuXG4gICAqIEBwYXJhbSB2ZXJzaW9uVUkgVGhlIFVJIHZlcnNpb24gdXNlZC5cbiAgICogQHBhcmFtIHZlcnNpb25CRSBUaGUgQkUgdmVyc2lvbiB1c2VkLlxuICAgKi9cbiAgaWRlbnRpZnkodXNlciwgdGVuYW50LCBpbnN0YW5jZUlkLCB2ZXJzaW9uVUk/LCB2ZXJzaW9uQkU/KSB7XG4gICAgY29uc3Qgd2luZG93UmVmID0gd2luZG93IGFzIGFueTtcbiAgICBjb25zdCB7IGlkOiB1c2VySWQsIGVtYWlsLCB1c2VyTmFtZSwgZmlyc3ROYW1lLCBsYXN0TmFtZSB9ID0gdXNlcjtcbiAgICBjb25zdCB7IG5hbWUsIGN1c3RvbVByb3BlcnRpZXMsIGRvbWFpbk5hbWUgfSA9IHRlbmFudDtcbiAgICBjb25zdCB7IGV4dGVybmFsUmVmZXJlbmNlIH0gPSBjdXN0b21Qcm9wZXJ0aWVzIHx8IHt9O1xuICAgIHdpbmRvd1JlZlt0aGlzLkdBSU5TSUdIVF9HTE9CQUxfU0NPUEVdKFxuICAgICAgJ2lkZW50aWZ5JyxcbiAgICAgIHtcbiAgICAgICAgaWQ6IGAke3VzZXJJZH1fJHtuYW1lfV8ke2luc3RhbmNlSWR9YCxcbiAgICAgICAgZW1haWwsXG4gICAgICAgIHVzZXJOYW1lLFxuICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lLFxuICAgICAgICBkb21haW5OYW1lLFxuICAgICAgICB2ZXJzaW9uVUksXG4gICAgICAgIHZlcnNpb25CRSxcbiAgICAgICAgdXNlckxhbmd1YWdlOiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuY3VycmVudExhbmcsXG4gICAgICAgIGluc3RhbmNlSWQsXG4gICAgICAgIGV4dGVybmFsUmVmZXJlbmNlXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBpZDogYCR7bmFtZX1fJHtpbnN0YW5jZUlkfWAsXG4gICAgICAgIGluc3RhbmNlSWRcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgdHJpZ2dlckV2ZW50KGV2ZW50TmFtZTogc3RyaW5nLCBwcm9wcz86IG9iamVjdCkge1xuICAgIGlmICh0aGlzLnRhZ0Z1bmN0aW9uICYmIGV2ZW50TmFtZSkge1xuICAgICAgZXZlbnROYW1lID0gdGhpcy5wcmVwYXJlRXZlbnROYW1lKGV2ZW50TmFtZSk7XG4gICAgICB0aGlzLnRhZ0Z1bmN0aW9uKCd0cmFjaycsIGV2ZW50TmFtZSwgcHJvcHMpO1xuICAgIH1cbiAgfVxuXG4gIHRyYW5zbGF0ZVRvRW5nbGlzaCh0ZXh0VG9UcmFuc2xhdGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBjdXJyZW50TGFuZyB9ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuXG4gICAgaWYgKGN1cnJlbnRMYW5nID09PSAnZW4nKSB7XG4gICAgICByZXR1cm4gdGV4dFRvVHJhbnNsYXRlO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50TGFuZyAmJiBjdXJyZW50TGFuZyAhPT0gdGhpcy5jYWNoZWRMYW5ndWFnZSkge1xuICAgICAgdGhpcy5jYWNoZWRSZXZlcnRlZFRyYW5zbGF0aW9ucyA9IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY2FjaGVkUmV2ZXJ0ZWRUcmFuc2xhdGlvbnMpIHtcbiAgICAgIHRoaXMuY2FjaGVkTGFuZ3VhZ2UgPSBjdXJyZW50TGFuZztcbiAgICAgIHRoaXMuY2FjaGVkUmV2ZXJ0ZWRUcmFuc2xhdGlvbnMgPSB0aGlzLmdldFJldmVydGVkVHJhbnNsYXRpb25zKGN1cnJlbnRMYW5nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5nZXRFblRyYW5zbGF0aW9uKHRleHRUb1RyYW5zbGF0ZSwgdGhpcy5jYWNoZWRSZXZlcnRlZFRyYW5zbGF0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIHRoZSBHYWluc2lnaHQncyB0YWcgc2hvdWxkIGJlIGxvYWRlZC5cbiAgICogVGhlIGRlY2lzaW9uIHRvIGxvYWQgR2FpbnNpZ2h0IHdpbGwgZGVwZW5kIG9uIGN1c3RvbSBwcm9wZXJ0aWVzIGFuZCBmdW5jdGlvbmFsIGNvb2tpZXMuXG4gICAqIEBwYXJhbSBjdXN0b21Qcm9wZXJ0aWVzIFRlbmFudCdzIGN1c3RvbVByb3BlcnRpZXMuXG4gICAqL1xuICBzaG91bGRMb2FkR2FpbnNpZ2h0VGFnKGN1c3RvbVByb3BlcnRpZXM6IElDdXN0b21Qcm9wZXJ0aWVzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuY29va2llQmFubmVyU2VydmljZS5pc0NvbmZpZ0Nvb2tpZVByZWZlcmVuY2VzRGVmaW5lZCgpICYmXG4gICAgICB0aGlzLmNvb2tpZUJhbm5lclNlcnZpY2UuaXNGdW5jdGlvbmFsQ29va2llRW5hYmxlZCgpICYmXG4gICAgICAhdGhpcy5pc0dhaW5zaWdodERpc2FibGVkKGN1c3RvbVByb3BlcnRpZXMpICYmXG4gICAgICAhdGhpcy5pc0N1c3RvbUJyYW5kaW5nKClcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgY2FuRWRpdFByb2R1Y3RFeHBlcmllbmNlU2V0dGluZ3MoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgY3VycmVudFRlbmFudCA9IHRoaXMuYXBwU3RhdGUuY3VycmVudFRlbmFudC52YWx1ZTtcbiAgICBjb25zdCB7IGN1c3RvbVByb3BlcnRpZXMgfSA9IGN1cnJlbnRUZW5hbnQ7XG5cbiAgICBjb25zdCBnYWluc2lnaHRLZXkgPSAhIXRoaXMuZ2FpbnNpZ2h0S2V5IHx8ICEhKGF3YWl0IHRoaXMuZ2V0R2FpbnNpZ2h0S2V5KCkpO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIGdhaW5zaWdodEtleSAmJlxuICAgICAgdGhpcy5jb29raWVCYW5uZXJTZXJ2aWNlLmlzQ29uZmlnQ29va2llUHJlZmVyZW5jZXNEZWZpbmVkKCkgJiZcbiAgICAgICF0aGlzLmlzR2FpbnNpZ2h0RGlzYWJsZWQoY3VzdG9tUHJvcGVydGllcykgJiZcbiAgICAgICEhdGhpcy5jb29raWVCYW5uZXJTZXJ2aWNlLmdldFVzZXJDb29raWVQcmVmZXJlbmNlcygpICYmXG4gICAgICAhdGhpcy5pc0N1c3RvbUJyYW5kaW5nKClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRXZlbnROYW1lKGJhc2VFdmVudE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJhc2VFdmVudE5hbWVcbiAgICAuc3BsaXQoJzonKVxuICAgIC5tYXAoZXZlbnROYW1lUGFydCA9PiBjYW1lbENhc2UocmVtb3ZlVHJhbnNsYXRpb25Db250ZXh0KGV2ZW50TmFtZVBhcnQpKSlcbiAgICAuam9pbignOicpO1xuXG4gICAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNsYXRpb25Db250ZXh0KGV2ZW50TmFtZVBhcnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICByZXR1cm4gZXZlbnROYW1lUGFydC5yZXBsYWNlKC9gW1xcd1xcV10qYC9nLCAnJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc0dhaW5zaWdodERpc2FibGVkKGN1c3RvbVByb3BlcnRpZXM6IElDdXN0b21Qcm9wZXJ0aWVzKSB7XG4gICAgY29uc3QgZ2FpbnNpZ2h0RW5hYmxlZCA9IGN1c3RvbVByb3BlcnRpZXMgJiYgY3VzdG9tUHJvcGVydGllcy5nYWluc2lnaHRFbmFibGVkO1xuICAgIHJldHVybiBnYWluc2lnaHRFbmFibGVkID09PSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgaXNDdXN0b21CcmFuZGluZygpOiBib29sZWFuIHtcbiAgICBjb25zdCBicmFuZGluZ0Nzc1ZhcnMgPSB0aGlzLm9wdGlvbnMuZ2V0KCdicmFuZGluZ0Nzc1ZhcnMnKSB8fCB7fTtcbiAgICByZXR1cm4gISFicmFuZGluZ0Nzc1ZhcnNbJ2JyYW5kLWxvZ28taW1nJ107XG4gIH1cblxuICBwcml2YXRlIGxvYWRTY3JpcHRUYWcoc2NyaXB0VGFnOiBIVE1MU2NyaXB0RWxlbWVudCwga2V5OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2luZG93UmVmID0gd2luZG93IGFzIGFueTtcbiAgICAgIGNvbnN0IGZpcnN0VGFnID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpWzBdO1xuICAgICAgY29uc3QgcHJvdG9jb2wgPSBsb2NhdGlvbi5wcm90b2NvbDtcbiAgICAgIGNvbnN0IGdhaW5zaWdodEdsb2JhbFNjb3BlID0gdGhpcy5HQUlOU0lHSFRfR0xPQkFMX1NDT1BFO1xuICAgICAgc2NyaXB0VGFnLnNyYyA9IGAke3Byb3RvY29sfS8vJHt0aGlzLkdBSU5TSUdIVF9VUkx9JHtrZXl9YDtcbiAgICAgICh3aW5kb3dSZWZbdGhpcy5HQUlOU0lHSFRfR0xPQkFMX1NDT1BFXSA9XG4gICAgICAgIHdpbmRvd1JlZlt0aGlzLkdBSU5TSUdIVF9HTE9CQUxfU0NPUEVdIHx8XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgICBmdW5jdGlvbigpIHtcbiAgICAgICAgICAod2luZG93UmVmW2dhaW5zaWdodEdsb2JhbFNjb3BlXS5xID0gd2luZG93UmVmW2dhaW5zaWdodEdsb2JhbFNjb3BlXS5xIHx8IFtdKS5wdXNoKFxuICAgICAgICAgICAgYXJndW1lbnRzXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgICh3aW5kb3dSZWZbZ2FpbnNpZ2h0R2xvYmFsU2NvcGVdLnAgPSBrZXkpO1xuICAgICAgc2NyaXB0VGFnLmFzeW5jID0gdHJ1ZTtcbiAgICAgIGZpcnN0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdFRhZywgZmlyc3RUYWcpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBsb2FkIEdhaW5zaWdodCBQWCcsIGV4KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEluc3RhbmNlSWRGcm9tVXJsKCkge1xuICAgIGNvbnN0IGhvc3ROYW1lID0gbG9jYXRpb24uaG9zdG5hbWU7XG4gICAgcmV0dXJuIGhvc3ROYW1lLnN1YnN0cmluZyhob3N0TmFtZS5pbmRleE9mKCcuJykgKyAxKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZlcnNlcyB0aGUgdHJhbnNsYXRpb24gb2JqZWN0LlxuICAgKlxuICAgKiAqKkV4YW1wbGUqKlxuICAgKiB7IEFkZCB3aWRnZXQ6IFwiV2lkZ2V0IGhpbnp1ZsO8Z2VuXCIgfVxuICAgKlxuICAgKiB3aWxsIGJlIGNoYW5nZWQgdG86XG4gICAqXG4gICAqIHsgV2lkZ2V0IGhpbnp1ZsO8Z2VuOiBcIkFkZCB3aWRnZXRcIiB9XG4gICAqXG4gICAqIEBwYXJhbSBjdXJyZW50TGFuZyBMYW5ndWFnZSB3aG9zZSB0cmFuc2xhdGVkIHZhbHVlcyBhcmUgdG8gYmUgcGxhY2VkIGluIHRoZSBvYmplY3Qga2V5LlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGFuIGludmVydGVkIG9iamVjdCB3aGVyZSB0aGUga2V5cyBoYXZlIGJlZW4gc3dhcHBlZCB3aXRoIHRoZSB2YWx1ZXMuXG4gICAqL1xuICBwcml2YXRlIGdldFJldmVydGVkVHJhbnNsYXRpb25zKGN1cnJlbnRMYW5nOiBzdHJpbmcpOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9IHtcbiAgICBjb25zdCB0cmFuc2xhdGlvbnMgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2Uuc3RvcmUudHJhbnNsYXRpb25zW2N1cnJlbnRMYW5nXTtcblxuICAgIGNvbnN0IHN3YXBwZWRLZXlzV2l0aFZhbHVlcyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKHRyYW5zbGF0aW9ucykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgc3dhcHBlZEtleXNXaXRoVmFsdWVzW3RyYW5zbGF0aW9uc1trZXldXSA9IGtleTtcbiAgICB9KTtcbiAgICByZXR1cm4gc3dhcHBlZEtleXNXaXRoVmFsdWVzO1xuICB9XG5cbiAgLyoqVHJhbnNsYXRlcyBzdHJpbmcgYmFjayBpbnRvIEVuZ2xpc2guXG4gICAqIElmIHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIGxhbmd1YWdlIGlzIHNldCB0byBFbmdsaXNoLCB0aGUgc3RyaW5nIHBhc3NlZCBhcyBhbiBhcmd1bWVudCBpcyByZXR1cm5lZC5cbiAgICogQHBhcmFtIHRleHRUb1RyYW5zbGF0ZSBzdHJpbmcgdG8gdHJhbnNsYXRlLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHRoZSBzdHJpbmcgdHJhbnNsYXRlZCBpbnRvIEVuZ2xpc2guXG4gICAqL1xuICBwcml2YXRlIGdldEVuVHJhbnNsYXRpb24odGV4dFRvVHJhbnNsYXRlOiBzdHJpbmcsIHRyYW5zbGF0aW9uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSk6IHN0cmluZyB7XG4gICAgbGV0IGVuVHJhbnNsYXRpb24gPSB0cmFuc2xhdGlvbnNbdGV4dFRvVHJhbnNsYXRlXTtcbiAgICBpZiAoIWVuVHJhbnNsYXRpb24pIHtcbiAgICAgIHJldHVybiB0ZXh0VG9UcmFuc2xhdGU7XG4gICAgfVxuICAgIC8qKiByZW1vdmUgdHJhbnNsYXRpb24gY29udGV4dCAqL1xuICAgIGNvbnN0IHJlZ2V4ID0gL1xcYCguKj8pXFxgLztcbiAgICBlblRyYW5zbGF0aW9uID0gZW5UcmFuc2xhdGlvbi5yZXBsYWNlKHJlZ2V4LCAnJyk7XG5cbiAgICByZXR1cm4gZW5UcmFuc2xhdGlvbjtcbiAgfVxufVxuIl19