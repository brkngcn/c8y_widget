import { ChangeDetectionStrategy, ChangeDetectorRef, Component } from '@angular/core';
import { FieldType } from '@ngx-formly/core';
import { TranslateService } from '@ngx-translate/core';
import { pick, get } from 'lodash-es';
import { defer, isObservable, of, pipe } from 'rxjs';
import { map, startWith, switchMap, tap } from 'rxjs/operators';
import { gettext } from '../../i18n';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@ngx-translate/core';
import * as ɵngcc2 from '../../select/typeahead.component';
import * as ɵngcc3 from '@angular/forms';
import * as ɵngcc4 from '@ngx-formly/core';
import * as ɵngcc5 from '../../common/forOf.directive';
import * as ɵngcc6 from '../../list-group/list-item.component';
import * as ɵngcc7 from '../../search/highlight.component';
import * as ɵngcc8 from '@angular/common';
import * as ɵngcc9 from '../../i18n/c8y-translate.directive';
import * as ɵngcc10 from '../../common/loading.component';

function TypeaheadTypeComponent_c8y_li_2_Template(rf, ctx) { if (rf & 1) {
    const _r7 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "c8y-li", 4);
    ɵngcc0.ɵɵlistener("click", function TypeaheadTypeComponent_c8y_li_2_Template_c8y_li_click_0_listener() { const restoredCtx = ɵngcc0.ɵɵrestoreView(_r7); const opt_r5 = restoredCtx.$implicit; const ctx_r6 = ɵngcc0.ɵɵnextContext(); ctx_r6.selectOption(opt_r5); return ctx_r6.setPipe(""); });
    ɵngcc0.ɵɵelement(1, "c8y-highlight", 5);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const opt_r5 = ctx.$implicit;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("text", opt_r5[ctx_r0.labelProp])("pattern", ctx_r0.pattern);
} }
function TypeaheadTypeComponent_ng_template_3_c8y_li_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-li", 7);
    ɵngcc0.ɵɵelementStart(1, "p");
    ɵngcc0.ɵɵelementStart(2, "strong", 8);
    ɵngcc0.ɵɵtext(3, "No match found.");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} }
function TypeaheadTypeComponent_ng_template_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtemplate(0, TypeaheadTypeComponent_ng_template_3_c8y_li_0_Template, 4, 0, "c8y-li", 6);
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.pattern.length > 0 && !ctx_r2.match);
} }
function TypeaheadTypeComponent_ng_template_5_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-li", 9);
    ɵngcc0.ɵɵelement(1, "c8y-loading");
    ɵngcc0.ɵɵelementEnd();
} }
export class TypeaheadTypeComponent extends FieldType {
    constructor(cdRef, translateService) {
        super();
        this.cdRef = cdRef;
        this.translateService = translateService;
        this.match = false;
        this.placeholder$ = defer(() => { var _a; return of((_a = this.to) === null || _a === void 0 ? void 0 : _a.placeholder); }).pipe(switchMap(placeholder => placeholder
            ? of(placeholder)
            : this.defaultPlaceholder$.pipe(startWith(this.translateService.instant(gettext('Start typing to search'))))));
        this.defaultPlaceholder$ = defer(() => { var _a, _b, _c; return isObservable((_a = this.to) === null || _a === void 0 ? void 0 : _a.c8yForOptions) ? (_b = this.to) === null || _b === void 0 ? void 0 : _b.c8yForOptions : of((_c = this.to) === null || _c === void 0 ? void 0 : _c.c8yForOptions); }).pipe(map(({ data }) => get(data[0], this.labelProp || 'name')), map(example => {
            return !!example
                ? this.translateService.instant(gettext('Start typing to search, for example, {{ example }}'), { example })
                : this.translateService.instant(gettext('No items'));
        }));
        this.excludeLabelProp = false;
    }
    ngOnInit() {
        if (this.to) {
            if (this.to.excludeDisplayProperty) {
                this.excludeLabelProp = this.to.excludeDisplayProperty;
            }
            if (this.to.displayProperty) {
                this.setPipe('');
                this.labelProp = this.to.displayProperty;
                this.valueProps = this.to.valueProperties;
            }
            else {
                console.error('To correctly use the typeahead select you need to specify displayProperty: string within templateOptions!');
            }
        }
    }
    selectOption(opt) {
        if (this.valueProps && this.valueProps.length > 0) {
            const pickList = this.excludeLabelProp
                ? this.valueProps
                : [...this.valueProps, this.labelProp];
            this.formControl.setValue(pick(opt, pickList));
            this.selected = { [this.labelProp]: opt[this.labelProp] };
        }
        else {
            this.formControl.setValue(opt);
        }
    }
    setPipe(filterStr) {
        this.pattern = filterStr;
        this.filterPipe = pipe(map((data) => {
            return data.filter((el) => el[this.labelProp] &&
                el[this.labelProp].toLowerCase().indexOf(filterStr.toLowerCase()) > -1);
        }), tap(data => {
            this.match = data.length > 0;
            this.cdRef.detectChanges();
        }));
    }
}
TypeaheadTypeComponent.ɵfac = function TypeaheadTypeComponent_Factory(t) { return new (t || TypeaheadTypeComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.TranslateService)); };
TypeaheadTypeComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: TypeaheadTypeComponent, selectors: [["c8y-typeahead-type"]], features: [ɵngcc0.ɵɵInheritDefinitionFeature], decls: 7, vars: 18, consts: [[3, "required", "placeholder", "displayProperty", "selected", "allowFreeEntries", "container", "disabled", "formControl", "formlyAttributes", "onSearch"], ["class", "p-l-8 p-r-8 c8y-list__item--link", 3, "click", 4, "c8yFor", "c8yForOf", "c8yForLoadMore", "c8yForPipe", "c8yForNotFound", "c8yForLoadingTemplate"], ["notFoundTemplate", ""], ["loading", ""], [1, "p-l-8", "p-r-8", "c8y-list__item--link", 3, "click"], [3, "text", "pattern"], ["class", "bg-gray-lighter p-8", 4, "ngIf"], [1, "bg-gray-lighter", "p-8"], ["translate", ""], [1, "text-center", "p-t-8", "p-relative"]], template: function TypeaheadTypeComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-typeahead", 0);
        ɵngcc0.ɵɵlistener("onSearch", function TypeaheadTypeComponent_Template_c8y_typeahead_onSearch_0_listener($event) { return ctx.setPipe($event); });
        ɵngcc0.ɵɵpipe(1, "async");
        ɵngcc0.ɵɵtemplate(2, TypeaheadTypeComponent_c8y_li_2_Template, 2, 2, "c8y-li", 1);
        ɵngcc0.ɵɵtemplate(3, TypeaheadTypeComponent_ng_template_3_Template, 1, 1, "ng-template", null, 2, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵtemplate(5, TypeaheadTypeComponent_ng_template_5_Template, 2, 0, "ng-template", null, 3, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        const _r1 = ɵngcc0.ɵɵreference(4);
        const _r3 = ɵngcc0.ɵɵreference(6);
        ɵngcc0.ɵɵclassProp("is-invalid", ctx.showError);
        ɵngcc0.ɵɵproperty("required", (ctx.to == null ? null : ctx.to.required) || false)("placeholder", ɵngcc0.ɵɵpipeBind1(1, 16, ctx.placeholder$))("displayProperty", ctx.to == null ? null : ctx.to.displayProperty)("selected", ctx.selected)("allowFreeEntries", (ctx.to == null ? null : ctx.to.allowFreeEntries) || false)("container", (ctx.to == null ? null : ctx.to.container) || "")("disabled", ctx.to == null ? null : ctx.to.disabled)("formControl", ctx.formControl)("formlyAttributes", ctx.field);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("c8yForOf", ctx.to == null ? null : ctx.to.c8yForOptions)("c8yForLoadMore", (ctx.to == null ? null : ctx.to.loadMore) || "auto")("c8yForPipe", ctx.filterPipe)("c8yForNotFound", _r1)("c8yForLoadingTemplate", _r3);
    } }, directives: [ɵngcc2.TypeaheadComponent, ɵngcc3.RequiredValidator, ɵngcc3.NgControlStatus, ɵngcc3.FormControlDirective, ɵngcc4.FormlyAttributes, ɵngcc5.ForOfDirective, ɵngcc6.ListItemComponent, ɵngcc7.HighlightComponent, ɵngcc8.NgIf, ɵngcc9.C8yTranslateDirective, ɵngcc10.LoadingComponent], pipes: [ɵngcc8.AsyncPipe], encapsulation: 2, changeDetection: 0 });
TypeaheadTypeComponent.CONFIG = {
    types: [{ name: 'typeahead', component: TypeaheadTypeComponent }]
};
TypeaheadTypeComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: TranslateService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(TypeaheadTypeComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-typeahead-type',
                template: "<c8y-typeahead\n  [required]=\"to?.required || false\"\n  [placeholder]=\"placeholder$ | async\"\n  [displayProperty]=\"to?.displayProperty\"\n  [selected]=\"selected\"\n  [allowFreeEntries]=\"to?.allowFreeEntries || false\"\n  [container]=\"to?.container || ''\"\n  [disabled]=\"to?.disabled\"\n  (onSearch)=\"setPipe($event)\"\n  [formControl]=\"formControl\"\n  [class.is-invalid]=\"showError\"\n  [formlyAttributes]=\"field\">\n\n  <c8y-li *c8yFor=\"let opt of to?.c8yForOptions; loadMore: to?.loadMore || 'auto'; pipe: filterPipe; notFound: notFoundTemplate; loadingTemplate: loading;\"\n          (click)=\"selectOption(opt); setPipe('')\"\n          class=\"p-l-8 p-r-8 c8y-list__item--link\">\n    <c8y-highlight [text]=\"opt[labelProp]\" [pattern]=\"pattern\"></c8y-highlight>\n  </c8y-li>\n  <ng-template #notFoundTemplate>\n    <c8y-li class=\"bg-gray-lighter p-8\" *ngIf=\"pattern.length > 0 && !match\">\n      <p><strong translate>No match found.</strong></p>\n    </c8y-li>\n  </ng-template>\n  <ng-template #loading>\n    <c8y-li class=\"text-center p-t-8 p-relative\">\n      <c8y-loading></c8y-loading>\n    </c8y-li>\n  </ng-template>\n</c8y-typeahead>\n",
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc1.TranslateService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZWFoZWFkLnR5cGUuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9jb3JlL2R5bmFtaWMtZm9ybXMvdHlwZWFoZWFkL3R5cGVhaGVhZC50eXBlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBRTlGLE9BQU8sRUFBZ0IsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBaUIsTUFBTSxNQUFNLENBQUM7QUFDcEUsT0FBTyxFQUFjLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxZQUFZLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU9yQyxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsU0FBUztBQUFHLElBc0N0RCxZQUFvQixLQUF3QixFQUFVLGdCQUFrQztBQUMxRixRQUFJLEtBQUssRUFBRSxDQUFDO0FBQ1osUUFGc0IsVUFBSyxHQUFMLEtBQUssQ0FBbUI7QUFBQyxRQUFTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQTdCekYsVUFBSyxHQUFZLEtBQUssQ0FBQztBQUN6QixRQUNFLGlCQUFZLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxXQUFDLE9BQUEsRUFBRSxDQUFDLE1BQUEsSUFBSSxDQUFDLEVBQUUsMENBQUUsV0FBVyxDQUFDLENBQUEsRUFBQSxDQUFD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QixpQkFBaUI7S0FVakQsUUFBUSxFQUFFLGZBVjJDLFlBRzlDLGdCQUFnQjtBQUFHO0NBT0ksa0JBQzlCOzs7O28rQkFBOEMsa0JBQzlDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNLGNBQ2hEOzs7cUhBVjZCO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IENvbmZpZ09wdGlvbiwgRmllbGRUeXBlIH0gZnJvbSAnQG5neC1mb3JtbHkvY29yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBwaWNrLCBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgZGVmZXIsIGlzT2JzZXJ2YWJsZSwgb2YsIHBpcGUsIFVuYXJ5RnVuY3Rpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi8uLi9pMThuJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXR5cGVhaGVhZC10eXBlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3R5cGVhaGVhZC50eXBlLmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgVHlwZWFoZWFkVHlwZUNvbXBvbmVudCBleHRlbmRzIEZpZWxkVHlwZSBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIHN0YXRpYyByZWFkb25seSBDT05GSUc6IENvbmZpZ09wdGlvbiA9IHtcbiAgICB0eXBlczogW3sgbmFtZTogJ3R5cGVhaGVhZCcsIGNvbXBvbmVudDogVHlwZWFoZWFkVHlwZUNvbXBvbmVudCB9XVxuICB9O1xuXG4gIGZpbHRlclBpcGU6IFVuYXJ5RnVuY3Rpb248dW5rbm93biwgdW5rbm93bj47XG4gIHBhdHRlcm46IHN0cmluZztcbiAgc2VsZWN0ZWQ6IElJZGVudGlmaWVkO1xuICBsYWJlbFByb3A6IHN0cmluZztcbiAgbWF0Y2g6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwbGFjZWhvbGRlciQgPSBkZWZlcigoKSA9PiBvZih0aGlzLnRvPy5wbGFjZWhvbGRlcikpLnBpcGUoXG4gICAgc3dpdGNoTWFwKHBsYWNlaG9sZGVyID0+XG4gICAgICBwbGFjZWhvbGRlclxuICAgICAgICA/IG9mKHBsYWNlaG9sZGVyKVxuICAgICAgICA6IHRoaXMuZGVmYXVsdFBsYWNlaG9sZGVyJC5waXBlKFxuICAgICAgICAgICAgc3RhcnRXaXRoKHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGdldHRleHQoJ1N0YXJ0IHR5cGluZyB0byBzZWFyY2gnKSkpXG4gICAgICAgICAgKVxuICAgIClcbiAgKTtcblxuICBkZWZhdWx0UGxhY2Vob2xkZXIkID0gZGVmZXIoKCkgPT5cbiAgICBpc09ic2VydmFibGUodGhpcy50bz8uYzh5Rm9yT3B0aW9ucykgPyB0aGlzLnRvPy5jOHlGb3JPcHRpb25zIDogb2YodGhpcy50bz8uYzh5Rm9yT3B0aW9ucylcbiAgKS5waXBlKFxuICAgIG1hcCgoeyBkYXRhIH0pID0+IGdldChkYXRhWzBdLCB0aGlzLmxhYmVsUHJvcCB8fCAnbmFtZScpKSxcbiAgICBtYXAoZXhhbXBsZSA9PiB7XG4gICAgICByZXR1cm4gISFleGFtcGxlXG4gICAgICAgID8gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgICAgICBnZXR0ZXh0KCdTdGFydCB0eXBpbmcgdG8gc2VhcmNoLCBmb3IgZXhhbXBsZSwge3sgZXhhbXBsZSB9fScpLFxuICAgICAgICAgICAgeyBleGFtcGxlIH1cbiAgICAgICAgICApXG4gICAgICAgIDogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoZ2V0dGV4dCgnTm8gaXRlbXMnKSk7XG4gICAgfSlcbiAgKTtcblxuICBwcml2YXRlIHZhbHVlUHJvcHM6IHN0cmluZ1tdO1xuICBwcml2YXRlIGV4Y2x1ZGVMYWJlbFByb3A6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLnRvKSB7XG4gICAgICBpZiAodGhpcy50by5leGNsdWRlRGlzcGxheVByb3BlcnR5KSB7XG4gICAgICAgIHRoaXMuZXhjbHVkZUxhYmVsUHJvcCA9IHRoaXMudG8uZXhjbHVkZURpc3BsYXlQcm9wZXJ0eTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMudG8uZGlzcGxheVByb3BlcnR5KSB7XG4gICAgICAgIHRoaXMuc2V0UGlwZSgnJyk7XG4gICAgICAgIHRoaXMubGFiZWxQcm9wID0gdGhpcy50by5kaXNwbGF5UHJvcGVydHk7XG4gICAgICAgIHRoaXMudmFsdWVQcm9wcyA9IHRoaXMudG8udmFsdWVQcm9wZXJ0aWVzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAnVG8gY29ycmVjdGx5IHVzZSB0aGUgdHlwZWFoZWFkIHNlbGVjdCB5b3UgbmVlZCB0byBzcGVjaWZ5IGRpc3BsYXlQcm9wZXJ0eTogc3RyaW5nIHdpdGhpbiB0ZW1wbGF0ZU9wdGlvbnMhJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNlbGVjdE9wdGlvbihvcHQpIHtcbiAgICBpZiAodGhpcy52YWx1ZVByb3BzICYmIHRoaXMudmFsdWVQcm9wcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBwaWNrTGlzdDogc3RyaW5nW10gPSB0aGlzLmV4Y2x1ZGVMYWJlbFByb3BcbiAgICAgICAgPyB0aGlzLnZhbHVlUHJvcHNcbiAgICAgICAgOiBbLi4udGhpcy52YWx1ZVByb3BzLCB0aGlzLmxhYmVsUHJvcF07XG4gICAgICB0aGlzLmZvcm1Db250cm9sLnNldFZhbHVlKHBpY2sob3B0LCBwaWNrTGlzdCkpO1xuICAgICAgdGhpcy5zZWxlY3RlZCA9IHsgW3RoaXMubGFiZWxQcm9wXTogb3B0W3RoaXMubGFiZWxQcm9wXSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZvcm1Db250cm9sLnNldFZhbHVlKG9wdCk7XG4gICAgfVxuICB9XG5cbiAgc2V0UGlwZShmaWx0ZXJTdHI6IHN0cmluZykge1xuICAgIHRoaXMucGF0dGVybiA9IGZpbHRlclN0cjtcbiAgICB0aGlzLmZpbHRlclBpcGUgPSBwaXBlKFxuICAgICAgbWFwKChkYXRhOiBhbnlbXSkgPT4ge1xuICAgICAgICByZXR1cm4gZGF0YS5maWx0ZXIoXG4gICAgICAgICAgKGVsOiBhbnkpID0+XG4gICAgICAgICAgICBlbFt0aGlzLmxhYmVsUHJvcF0gJiZcbiAgICAgICAgICAgIGVsW3RoaXMubGFiZWxQcm9wXS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoZmlsdGVyU3RyLnRvTG93ZXJDYXNlKCkpID4gLTFcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgdGFwKGRhdGEgPT4ge1xuICAgICAgICB0aGlzLm1hdGNoID0gZGF0YS5sZW5ndGggPiAwO1xuICAgICAgICB0aGlzLmNkUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuIl19