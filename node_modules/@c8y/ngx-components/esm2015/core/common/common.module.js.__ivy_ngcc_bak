import { ScrollingModule } from '@angular/cdk/scrolling';
import { CommonModule as NgCommonModule } from '@angular/common';
import { APP_INITIALIZER, InjectionToken, NgModule } from '@angular/core';
import { DataModule } from '@c8y/ngx-components/api';
import { TooltipModule } from 'ngx-bootstrap/tooltip';
import { distinctUntilChanged, filter, map, startWith, switchMap } from 'rxjs/operators';
import { I18nModule } from '../i18n/i18n.module';
import { TranslateService } from '../i18n/translate.service';
import { BytesPipe } from './bytes.pipe';
import { DatePipe } from './date.pipe';
import { DropdownDirectionDirective } from './dropdown-direction.directive';
import { EmptyStateComponent } from './empty-state/empty-state.component';
import { FilesService } from './files.service';
import { ForOfDirective } from './forOf.directive';
import { HumanizeAppNamePipe } from './humanize-app-name.pipe';
import { HumanizePipe } from './humanize.pipe';
import { IconDirective, ICONS } from './icon.directive';
import { IfAllowedDirective } from './if-allowed.directive';
import { LoadMoreComponent } from './load-more.component';
import { LoadingComponent } from './loading.component';
import { MapFunctionPipe } from './map-function.pipe';
import { NumberPipe } from './number.pipe';
import { OperationResultComponent } from './operation-result.component';
import { HOOK_OPTIONS, OptionsService } from './options.service';
import { OutletDirective } from './outlet.directive';
import { Permissions } from './permissions.service';
import { ProgressBarComponent } from './progress-bar.component';
import { ShortenUserNamePipe } from './shorten-user-name.pipe';
import { ShowIfFilterPipe } from './show-if-filter.pipe';
import { TenantUiService } from './tenant-ui.service';
import { TextareaAutoresizeDirective } from './textarea-autoresize.directive';
import { AppStateService } from './ui-state.service';
import { UserPreferencesService } from './user-preferences/user-preferences.service';
import { VirtualScrollWindowDirective } from './virtual-scroll/virtual-scroll-window.directive';
import { VirtualScrollerWrapperComponent } from './virtual-scroll/virtual-scroller-wrapper.component';
import { ZipService } from './zip.service';
export function initializeServices(translateService, state, userPreferences) {
    const initialize = () => {
        const queryStringLanguage = translateService.queryStringLang();
        const firstLanguage = translateService.firstSupportedLanguage();
        /*
          The ?lang parameter will prevent the user preference language from being activated
        */
        if (queryStringLanguage && translateService.getSupported(queryStringLanguage)) {
            translateService.switchToLanguage(queryStringLanguage);
        }
        else {
            state.currentUser
                .pipe(map(user => user && user.userName), filter(u => !!u), distinctUntilChanged(), switchMap(() => userPreferences.get('language')), startWith(firstLanguage), filter(lang => !!lang), distinctUntilChanged())
                .subscribe(lang => {
                translateService.switchToLanguage(lang);
            });
        }
    };
    return initialize;
}
export const ICON_LIST = new InjectionToken('iconList');
/**
 * Commonly used directives, data access and translation. This module is the shared
 * module across all core components. It should be imported by default.
 *
 * @exports IconDirective A directive to set a c8y icon with [c8yIcon]="'rocket'".
 * @exports OutletDirective A directive which allows to set DOM or Angular templates (used for upgrade).
 * @exports I18nModule Translation module.
 * @exports NgCommonModule Angular common module.
 * @exports DataModule The data layer to allow DI with @c8y/client
 * @exports HumanizeAppNamePipe Humanize an application name (e.g. in the app switcher)
 * @exports HumanizePipe Humanize a word. E.g. `device management` gets `Device management`
 * @exports ShortenUserNamePipe Allows a short name. E.g. `Foo Bar` gets `F. Bar`
 * @exports ForOfDirective A forOf directive like ngFor but with load-more function
 * @exports LoadMoreComponent A component to load more data from a certain data-source
 * @exports ProgressBarComponent Displays either defined or undefined progress.
 * @exports DropdownDirectionDirective Determines if a dropdown opens to the bottom or to the top.
 * @exports TextareaAutoresizeDirective resizes a textarea height as the user inputs.
 * @exports OperationResultComponent displays an animated svg for success and error operations.
 */
export class CommonModule {
    static providers() {
        return [
            ...DataModule.providers(),
            // TODO: maybe we can think of a way to remove this C8Y_APP global
            { provide: HOOK_OPTIONS, useValue: window.C8Y_APP || {}, multi: true },
            {
                provide: APP_INITIALIZER,
                useFactory: initializeServices,
                deps: [TranslateService, AppStateService, UserPreferencesService],
                multi: true
            },
            { provide: ICON_LIST, useValue: ICONS, multi: false },
            ...I18nModule.providers(),
            UserPreferencesService,
            OptionsService,
            AppStateService,
            Permissions,
            TenantUiService,
            HumanizePipe,
            HumanizeAppNamePipe,
            ShortenUserNamePipe,
            MapFunctionPipe,
            DatePipe,
            ZipService,
            FilesService,
            BytesPipe
        ];
    }
    static forRoot() {
        return {
            ngModule: CommonModule,
            providers: CommonModule.providers()
        };
    }
}
CommonModule.decorators = [
    { type: NgModule, args: [{
                imports: [NgCommonModule, I18nModule, TooltipModule, ScrollingModule],
                exports: [
                    EmptyStateComponent,
                    IconDirective,
                    OutletDirective,
                    I18nModule,
                    NgCommonModule,
                    HumanizeAppNamePipe,
                    HumanizePipe,
                    IfAllowedDirective,
                    ShortenUserNamePipe,
                    ForOfDirective,
                    LoadMoreComponent,
                    MapFunctionPipe,
                    ProgressBarComponent,
                    DatePipe,
                    NumberPipe,
                    LoadingComponent,
                    DropdownDirectionDirective,
                    TextareaAutoresizeDirective,
                    OperationResultComponent,
                    VirtualScrollerWrapperComponent,
                    VirtualScrollWindowDirective,
                    BytesPipe,
                    ShowIfFilterPipe
                ],
                declarations: [
                    EmptyStateComponent,
                    IconDirective,
                    OutletDirective,
                    HumanizePipe,
                    HumanizeAppNamePipe,
                    IfAllowedDirective,
                    ShortenUserNamePipe,
                    ForOfDirective,
                    LoadMoreComponent,
                    MapFunctionPipe,
                    ProgressBarComponent,
                    DatePipe,
                    NumberPipe,
                    LoadingComponent,
                    DropdownDirectionDirective,
                    TextareaAutoresizeDirective,
                    OperationResultComponent,
                    VirtualScrollerWrapperComponent,
                    VirtualScrollWindowDirective,
                    BytesPipe,
                    ShowIfFilterPipe
                ],
                entryComponents: [LoadMoreComponent, LoadingComponent, VirtualScrollerWrapperComponent]
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLm1vZHVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvY29tbW9uL2NvbW1vbi5tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLElBQUksY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakUsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDNUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0Ms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b0JBQ2QsaUJBQWlCO29CQUNqQixlQUFlO29CQUNmLG9CQUFvQjtvQkFDcEIsUUFBUTtvQkFDUixVQUFVO29CQUNWLGdCQUFnQjtvQkFDaEIsMEJBQTBCO29CQUMxQiwyQkFBMkI7b0JBQzNCLHdCQUF3QjtvQkFDeEIsK0JBQStCO29CQUMvQiw0QkFBNEI7b0JBQzVCLFNBQVM7b0JBQ1QsZ0JBQWdCO2lCQUNqQjtnQkFDRCxZQUFZLEVBQUU7b0JBQ1osbUJBQW1CO29CQUNuQixhQUFhO29CQUNiLGVBQWU7b0JBQ2YsWUFBWTtvQkFDWixtQkFBbUI7b0JBQ25CLGtCQUFrQjtvQkFDbEIsbUJBQW1CO29CQUNuQixjQUFjO29CQUNkLGlCQUFpQjtvQkFDakIsZUFBZTtvQkFDZixvQkFBb0I7b0JBQ3BCLFFBQVE7b0JBQ1IsVUFBVTtvQkFDVixnQkFBZ0I7b0JBQ2hCLDBCQUEwQjtvQkFDMUIsMkJBQTJCO29CQUMzQix3QkFBd0I7b0JBQ3hCLCtCQUErQjtvQkFDL0IsNEJBQTRCO29CQUM1QixTQUFTO29CQUNULGdCQUFnQjtpQkFDakI7Z0JBQ0QsZUFBZSxFQUFFLENBQUMsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsK0JBQStCLENBQUM7YUFDeEYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY3JvbGxpbmdNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9jZGsvc2Nyb2xsaW5nJztcbmltcG9ydCB7IENvbW1vbk1vZHVsZSBhcyBOZ0NvbW1vbk1vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBBUFBfSU5JVElBTElaRVIsIEluamVjdGlvblRva2VuLCBOZ01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRGF0YU1vZHVsZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvYXBpJztcbmltcG9ydCB7IFRvb2x0aXBNb2R1bGUgfSBmcm9tICduZ3gtYm9vdHN0cmFwL3Rvb2x0aXAnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBzdGFydFdpdGgsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEkxOG5Nb2R1bGUgfSBmcm9tICcuLi9pMThuL2kxOG4ubW9kdWxlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9pMThuL3RyYW5zbGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IEJ5dGVzUGlwZSB9IGZyb20gJy4vYnl0ZXMucGlwZSc7XG5pbXBvcnQgeyBEYXRlUGlwZSB9IGZyb20gJy4vZGF0ZS5waXBlJztcbmltcG9ydCB7IERyb3Bkb3duRGlyZWN0aW9uRGlyZWN0aXZlIH0gZnJvbSAnLi9kcm9wZG93bi1kaXJlY3Rpb24uZGlyZWN0aXZlJztcbmltcG9ydCB7IEVtcHR5U3RhdGVDb21wb25lbnQgfSBmcm9tICcuL2VtcHR5LXN0YXRlL2VtcHR5LXN0YXRlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBGaWxlc1NlcnZpY2UgfSBmcm9tICcuL2ZpbGVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9yT2ZEaXJlY3RpdmUgfSBmcm9tICcuL2Zvck9mLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBIdW1hbml6ZUFwcE5hbWVQaXBlIH0gZnJvbSAnLi9odW1hbml6ZS1hcHAtbmFtZS5waXBlJztcbmltcG9ydCB7IEh1bWFuaXplUGlwZSB9IGZyb20gJy4vaHVtYW5pemUucGlwZSc7XG5pbXBvcnQgeyBJY29uRGlyZWN0aXZlLCBJQ09OUyB9IGZyb20gJy4vaWNvbi5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgSWZBbGxvd2VkRGlyZWN0aXZlIH0gZnJvbSAnLi9pZi1hbGxvd2VkLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBMb2FkTW9yZUNvbXBvbmVudCB9IGZyb20gJy4vbG9hZC1tb3JlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkaW5nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBNYXBGdW5jdGlvblBpcGUgfSBmcm9tICcuL21hcC1mdW5jdGlvbi5waXBlJztcbmltcG9ydCB7IE51bWJlclBpcGUgfSBmcm9tICcuL251bWJlci5waXBlJztcbmltcG9ydCB7IE9wZXJhdGlvblJlc3VsdENvbXBvbmVudCB9IGZyb20gJy4vb3BlcmF0aW9uLXJlc3VsdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSE9PS19PUFRJT05TLCBPcHRpb25zU2VydmljZSB9IGZyb20gJy4vb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IE91dGxldERpcmVjdGl2ZSB9IGZyb20gJy4vb3V0bGV0LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gJy4vcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBQcm9ncmVzc0JhckNvbXBvbmVudCB9IGZyb20gJy4vcHJvZ3Jlc3MtYmFyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTaG9ydGVuVXNlck5hbWVQaXBlIH0gZnJvbSAnLi9zaG9ydGVuLXVzZXItbmFtZS5waXBlJztcbmltcG9ydCB7IFNob3dJZkZpbHRlclBpcGUgfSBmcm9tICcuL3Nob3ctaWYtZmlsdGVyLnBpcGUnO1xuaW1wb3J0IHsgVGVuYW50VWlTZXJ2aWNlIH0gZnJvbSAnLi90ZW5hbnQtdWkuc2VydmljZSc7XG5pbXBvcnQgeyBUZXh0YXJlYUF1dG9yZXNpemVEaXJlY3RpdmUgfSBmcm9tICcuL3RleHRhcmVhLWF1dG9yZXNpemUuZGlyZWN0aXZlJztcbmltcG9ydCB7IEFwcFN0YXRlU2VydmljZSB9IGZyb20gJy4vdWktc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlIH0gZnJvbSAnLi91c2VyLXByZWZlcmVuY2VzL3VzZXItcHJlZmVyZW5jZXMuc2VydmljZSc7XG5pbXBvcnQgeyBWaXJ0dWFsU2Nyb2xsV2luZG93RGlyZWN0aXZlIH0gZnJvbSAnLi92aXJ0dWFsLXNjcm9sbC92aXJ0dWFsLXNjcm9sbC13aW5kb3cuZGlyZWN0aXZlJztcbmltcG9ydCB7IFZpcnR1YWxTY3JvbGxlcldyYXBwZXJDb21wb25lbnQgfSBmcm9tICcuL3ZpcnR1YWwtc2Nyb2xsL3ZpcnR1YWwtc2Nyb2xsZXItd3JhcHBlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgWmlwU2VydmljZSB9IGZyb20gJy4vemlwLnNlcnZpY2UnO1xuXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZVNlcnZpY2VzKFxuICB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICBzdGF0ZTogQXBwU3RhdGVTZXJ2aWNlLFxuICB1c2VyUHJlZmVyZW5jZXM6IFVzZXJQcmVmZXJlbmNlc1NlcnZpY2Vcbikge1xuICBjb25zdCBpbml0aWFsaXplID0gKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXJ5U3RyaW5nTGFuZ3VhZ2UgPSB0cmFuc2xhdGVTZXJ2aWNlLnF1ZXJ5U3RyaW5nTGFuZygpO1xuICAgIGNvbnN0IGZpcnN0TGFuZ3VhZ2UgPSB0cmFuc2xhdGVTZXJ2aWNlLmZpcnN0U3VwcG9ydGVkTGFuZ3VhZ2UoKTtcblxuICAgIC8qXG4gICAgICBUaGUgP2xhbmcgcGFyYW1ldGVyIHdpbGwgcHJldmVudCB0aGUgdXNlciBwcmVmZXJlbmNlIGxhbmd1YWdlIGZyb20gYmVpbmcgYWN0aXZhdGVkXG4gICAgKi9cbiAgICBpZiAocXVlcnlTdHJpbmdMYW5ndWFnZSAmJiB0cmFuc2xhdGVTZXJ2aWNlLmdldFN1cHBvcnRlZChxdWVyeVN0cmluZ0xhbmd1YWdlKSkge1xuICAgICAgdHJhbnNsYXRlU2VydmljZS5zd2l0Y2hUb0xhbmd1YWdlKHF1ZXJ5U3RyaW5nTGFuZ3VhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGF0ZS5jdXJyZW50VXNlclxuICAgICAgICAucGlwZShcbiAgICAgICAgICBtYXAodXNlciA9PiB1c2VyICYmIHVzZXIudXNlck5hbWUpLFxuICAgICAgICAgIGZpbHRlcih1ID0+ICEhdSksXG4gICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdXNlclByZWZlcmVuY2VzLmdldCgnbGFuZ3VhZ2UnKSksXG4gICAgICAgICAgc3RhcnRXaXRoKGZpcnN0TGFuZ3VhZ2UpLFxuICAgICAgICAgIGZpbHRlcihsYW5nID0+ICEhbGFuZyksXG4gICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUobGFuZyA9PiB7XG4gICAgICAgICAgdHJhbnNsYXRlU2VydmljZS5zd2l0Y2hUb0xhbmd1YWdlKGxhbmcpO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH07XG4gIHJldHVybiBpbml0aWFsaXplO1xufVxuXG5leHBvcnQgY29uc3QgSUNPTl9MSVNUID0gbmV3IEluamVjdGlvblRva2VuKCdpY29uTGlzdCcpO1xuXG4vKipcbiAqIENvbW1vbmx5IHVzZWQgZGlyZWN0aXZlcywgZGF0YSBhY2Nlc3MgYW5kIHRyYW5zbGF0aW9uLiBUaGlzIG1vZHVsZSBpcyB0aGUgc2hhcmVkXG4gKiBtb2R1bGUgYWNyb3NzIGFsbCBjb3JlIGNvbXBvbmVudHMuIEl0IHNob3VsZCBiZSBpbXBvcnRlZCBieSBkZWZhdWx0LlxuICpcbiAqIEBleHBvcnRzIEljb25EaXJlY3RpdmUgQSBkaXJlY3RpdmUgdG8gc2V0IGEgYzh5IGljb24gd2l0aCBbYzh5SWNvbl09XCIncm9ja2V0J1wiLlxuICogQGV4cG9ydHMgT3V0bGV0RGlyZWN0aXZlIEEgZGlyZWN0aXZlIHdoaWNoIGFsbG93cyB0byBzZXQgRE9NIG9yIEFuZ3VsYXIgdGVtcGxhdGVzICh1c2VkIGZvciB1cGdyYWRlKS5cbiAqIEBleHBvcnRzIEkxOG5Nb2R1bGUgVHJhbnNsYXRpb24gbW9kdWxlLlxuICogQGV4cG9ydHMgTmdDb21tb25Nb2R1bGUgQW5ndWxhciBjb21tb24gbW9kdWxlLlxuICogQGV4cG9ydHMgRGF0YU1vZHVsZSBUaGUgZGF0YSBsYXllciB0byBhbGxvdyBESSB3aXRoIEBjOHkvY2xpZW50XG4gKiBAZXhwb3J0cyBIdW1hbml6ZUFwcE5hbWVQaXBlIEh1bWFuaXplIGFuIGFwcGxpY2F0aW9uIG5hbWUgKGUuZy4gaW4gdGhlIGFwcCBzd2l0Y2hlcilcbiAqIEBleHBvcnRzIEh1bWFuaXplUGlwZSBIdW1hbml6ZSBhIHdvcmQuIEUuZy4gYGRldmljZSBtYW5hZ2VtZW50YCBnZXRzIGBEZXZpY2UgbWFuYWdlbWVudGBcbiAqIEBleHBvcnRzIFNob3J0ZW5Vc2VyTmFtZVBpcGUgQWxsb3dzIGEgc2hvcnQgbmFtZS4gRS5nLiBgRm9vIEJhcmAgZ2V0cyBgRi4gQmFyYFxuICogQGV4cG9ydHMgRm9yT2ZEaXJlY3RpdmUgQSBmb3JPZiBkaXJlY3RpdmUgbGlrZSBuZ0ZvciBidXQgd2l0aCBsb2FkLW1vcmUgZnVuY3Rpb25cbiAqIEBleHBvcnRzIExvYWRNb3JlQ29tcG9uZW50IEEgY29tcG9uZW50IHRvIGxvYWQgbW9yZSBkYXRhIGZyb20gYSBjZXJ0YWluIGRhdGEtc291cmNlXG4gKiBAZXhwb3J0cyBQcm9ncmVzc0JhckNvbXBvbmVudCBEaXNwbGF5cyBlaXRoZXIgZGVmaW5lZCBvciB1bmRlZmluZWQgcHJvZ3Jlc3MuXG4gKiBAZXhwb3J0cyBEcm9wZG93bkRpcmVjdGlvbkRpcmVjdGl2ZSBEZXRlcm1pbmVzIGlmIGEgZHJvcGRvd24gb3BlbnMgdG8gdGhlIGJvdHRvbSBvciB0byB0aGUgdG9wLlxuICogQGV4cG9ydHMgVGV4dGFyZWFBdXRvcmVzaXplRGlyZWN0aXZlIHJlc2l6ZXMgYSB0ZXh0YXJlYSBoZWlnaHQgYXMgdGhlIHVzZXIgaW5wdXRzLlxuICogQGV4cG9ydHMgT3BlcmF0aW9uUmVzdWx0Q29tcG9uZW50IGRpc3BsYXlzIGFuIGFuaW1hdGVkIHN2ZyBmb3Igc3VjY2VzcyBhbmQgZXJyb3Igb3BlcmF0aW9ucy5cbiAqL1xuQE5nTW9kdWxlKHtcbiAgaW1wb3J0czogW05nQ29tbW9uTW9kdWxlLCBJMThuTW9kdWxlLCBUb29sdGlwTW9kdWxlLCBTY3JvbGxpbmdNb2R1bGVdLFxuICBleHBvcnRzOiBbXG4gICAgRW1wdHlTdGF0ZUNvbXBvbmVudCxcbiAgICBJY29uRGlyZWN0aXZlLFxuICAgIE91dGxldERpcmVjdGl2ZSxcbiAgICBJMThuTW9kdWxlLFxuICAgIE5nQ29tbW9uTW9kdWxlLFxuICAgIEh1bWFuaXplQXBwTmFtZVBpcGUsXG4gICAgSHVtYW5pemVQaXBlLFxuICAgIElmQWxsb3dlZERpcmVjdGl2ZSxcbiAgICBTaG9ydGVuVXNlck5hbWVQaXBlLFxuICAgIEZvck9mRGlyZWN0aXZlLFxuICAgIExvYWRNb3JlQ29tcG9uZW50LFxuICAgIE1hcEZ1bmN0aW9uUGlwZSxcbiAgICBQcm9ncmVzc0JhckNvbXBvbmVudCxcbiAgICBEYXRlUGlwZSxcbiAgICBOdW1iZXJQaXBlLFxuICAgIExvYWRpbmdDb21wb25lbnQsXG4gICAgRHJvcGRvd25EaXJlY3Rpb25EaXJlY3RpdmUsXG4gICAgVGV4dGFyZWFBdXRvcmVzaXplRGlyZWN0aXZlLFxuICAgIE9wZXJhdGlvblJlc3VsdENvbXBvbmVudCxcbiAgICBWaXJ0dWFsU2Nyb2xsZXJXcmFwcGVyQ29tcG9uZW50LFxuICAgIFZpcnR1YWxTY3JvbGxXaW5kb3dEaXJlY3RpdmUsXG4gICAgQnl0ZXNQaXBlLFxuICAgIFNob3dJZkZpbHRlclBpcGVcbiAgXSxcbiAgZGVjbGFyYXRpb25zOiBbXG4gICAgRW1wdHlTdGF0ZUNvbXBvbmVudCxcbiAgICBJY29uRGlyZWN0aXZlLFxuICAgIE91dGxldERpcmVjdGl2ZSxcbiAgICBIdW1hbml6ZVBpcGUsXG4gICAgSHVtYW5pemVBcHBOYW1lUGlwZSxcbiAgICBJZkFsbG93ZWREaXJlY3RpdmUsXG4gICAgU2hvcnRlblVzZXJOYW1lUGlwZSxcbiAgICBGb3JPZkRpcmVjdGl2ZSxcbiAgICBMb2FkTW9yZUNvbXBvbmVudCxcbiAgICBNYXBGdW5jdGlvblBpcGUsXG4gICAgUHJvZ3Jlc3NCYXJDb21wb25lbnQsXG4gICAgRGF0ZVBpcGUsXG4gICAgTnVtYmVyUGlwZSxcbiAgICBMb2FkaW5nQ29tcG9uZW50LFxuICAgIERyb3Bkb3duRGlyZWN0aW9uRGlyZWN0aXZlLFxuICAgIFRleHRhcmVhQXV0b3Jlc2l6ZURpcmVjdGl2ZSxcbiAgICBPcGVyYXRpb25SZXN1bHRDb21wb25lbnQsXG4gICAgVmlydHVhbFNjcm9sbGVyV3JhcHBlckNvbXBvbmVudCxcbiAgICBWaXJ0dWFsU2Nyb2xsV2luZG93RGlyZWN0aXZlLFxuICAgIEJ5dGVzUGlwZSxcbiAgICBTaG93SWZGaWx0ZXJQaXBlXG4gIF0sXG4gIGVudHJ5Q29tcG9uZW50czogW0xvYWRNb3JlQ29tcG9uZW50LCBMb2FkaW5nQ29tcG9uZW50LCBWaXJ0dWFsU2Nyb2xsZXJXcmFwcGVyQ29tcG9uZW50XVxufSlcbmV4cG9ydCBjbGFzcyBDb21tb25Nb2R1bGUge1xuICBzdGF0aWMgcHJvdmlkZXJzKCkge1xuICAgIHJldHVybiBbXG4gICAgICAuLi5EYXRhTW9kdWxlLnByb3ZpZGVycygpLFxuICAgICAgLy8gVE9ETzogbWF5YmUgd2UgY2FuIHRoaW5rIG9mIGEgd2F5IHRvIHJlbW92ZSB0aGlzIEM4WV9BUFAgZ2xvYmFsXG4gICAgICB7IHByb3ZpZGU6IEhPT0tfT1BUSU9OUywgdXNlVmFsdWU6ICh3aW5kb3cgYXMgYW55KS5DOFlfQVBQIHx8IHt9LCBtdWx0aTogdHJ1ZSB9LFxuICAgICAge1xuICAgICAgICBwcm92aWRlOiBBUFBfSU5JVElBTElaRVIsXG4gICAgICAgIHVzZUZhY3Rvcnk6IGluaXRpYWxpemVTZXJ2aWNlcyxcbiAgICAgICAgZGVwczogW1RyYW5zbGF0ZVNlcnZpY2UsIEFwcFN0YXRlU2VydmljZSwgVXNlclByZWZlcmVuY2VzU2VydmljZV0sXG4gICAgICAgIG11bHRpOiB0cnVlXG4gICAgICB9LFxuICAgICAgeyBwcm92aWRlOiBJQ09OX0xJU1QsIHVzZVZhbHVlOiBJQ09OUywgbXVsdGk6IGZhbHNlIH0sXG4gICAgICAuLi5JMThuTW9kdWxlLnByb3ZpZGVycygpLFxuICAgICAgVXNlclByZWZlcmVuY2VzU2VydmljZSxcbiAgICAgIE9wdGlvbnNTZXJ2aWNlLFxuICAgICAgQXBwU3RhdGVTZXJ2aWNlLFxuICAgICAgUGVybWlzc2lvbnMsXG4gICAgICBUZW5hbnRVaVNlcnZpY2UsXG4gICAgICBIdW1hbml6ZVBpcGUsXG4gICAgICBIdW1hbml6ZUFwcE5hbWVQaXBlLFxuICAgICAgU2hvcnRlblVzZXJOYW1lUGlwZSxcbiAgICAgIE1hcEZ1bmN0aW9uUGlwZSxcbiAgICAgIERhdGVQaXBlLFxuICAgICAgWmlwU2VydmljZSxcbiAgICAgIEZpbGVzU2VydmljZSxcbiAgICAgIEJ5dGVzUGlwZVxuICAgIF07XG4gIH1cblxuICBzdGF0aWMgZm9yUm9vdCgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmdNb2R1bGU6IENvbW1vbk1vZHVsZSxcbiAgICAgIHByb3ZpZGVyczogQ29tbW9uTW9kdWxlLnByb3ZpZGVycygpXG4gICAgfTtcbiAgfVxufVxuIl19