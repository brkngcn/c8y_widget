import { __awaiter } from "tslib";
import { ChangeDetectorRef, Component, ElementRef, EventEmitter, HostBinding, Input, Output } from '@angular/core';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';
import * as ɵngcc2 from '../i18n/c8y-translate.directive';
import * as ɵngcc3 from './icon.directive';
import * as ɵngcc4 from '../i18n/c8y-translate.pipe';

function LoadMoreComponent_button_0_ng_container_2_span_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "span", 6);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r7 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("innerHTML", ɵngcc0.ɵɵpipeBind1(1, 1, ctx_r7.loadNextLabel), ɵngcc0.ɵɵsanitizeHtml);
} }
const _c0 = function (a0) { return { pageNo: a0 }; };
function LoadMoreComponent_button_0_ng_container_2_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 7);
    ɵngcc0.ɵɵdisableBindings();
    ɵngcc0.ɵɵtext(1, " Load page {{ pageNo }}");
    ɵngcc0.ɵɵenableBindings();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r9 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction1(1, _c0, ctx_r9.paging.currentPage + 1));
} }
function LoadMoreComponent_button_0_ng_container_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_button_0_ng_container_2_span_1_Template, 2, 3, "span", 4);
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_2_ng_template_2_Template, 2, 3, "ng-template", null, 5, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const _r8 = ɵngcc0.ɵɵreference(3);
    const ctx_r5 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r5.loadNextLabel)("ngIfElse", _r8);
} }
function LoadMoreComponent_button_0_ng_container_3_span_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "span", 6);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r10 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("innerHTML", ɵngcc0.ɵɵpipeBind1(1, 1, ctx_r10.loadingLabel), ɵngcc0.ɵɵsanitizeHtml);
} }
function LoadMoreComponent_button_0_ng_container_3_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 7);
    ɵngcc0.ɵɵdisableBindings();
    ɵngcc0.ɵɵtext(1, " Page {{ pageNo }} is loading\u2026 ");
    ɵngcc0.ɵɵenableBindings();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r12 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction1(1, _c0, ctx_r12.paging.currentPage + 1));
} }
function LoadMoreComponent_button_0_ng_container_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_button_0_ng_container_3_span_1_Template, 2, 3, "span", 4);
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_3_ng_template_2_Template, 2, 3, "ng-template", null, 8, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const _r11 = ɵngcc0.ɵɵreference(3);
    const ctx_r6 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r6.loadingLabel)("ngIfElse", _r11);
} }
const _c1 = function (a0) { return { "btn-pending": a0 }; };
function LoadMoreComponent_button_0_Template(rf, ctx) { if (rf & 1) {
    const _r14 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 3);
    ɵngcc0.ɵɵlistener("click", function LoadMoreComponent_button_0_Template_button_click_0_listener($event) { ɵngcc0.ɵɵrestoreView(_r14); const ctx_r13 = ɵngcc0.ɵɵnextContext(); return ctx_r13.loadMore($event); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_2_Template, 4, 2, "ng-container", 1);
    ɵngcc0.ɵɵtemplate(3, LoadMoreComponent_button_0_ng_container_3_Template, 4, 2, "ng-container", 1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵstyleProp("visibility", ctx_r0.hidden ? "hidden" : "visible")("height", ctx_r0.hidden ? "1px" : null);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 8, "Load more"));
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(10, _c1, ctx_r0.isLoading));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r0.isLoading);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.isLoading);
} }
function LoadMoreComponent_ng_container_1_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
function LoadMoreComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_1_ng_container_1_Template, 1, 0, "ng-container", 9);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    const _r2 = ɵngcc0.ɵɵreference(3);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx_r1.noMoreDataHint || _r2);
} }
function LoadMoreComponent_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 10);
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵelement(2, "i", 11);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 2, "Last record"));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("c8yIcon", "circle");
} }
function LoadMoreComponent_ng_container_4_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
function LoadMoreComponent_ng_container_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_4_ng_container_1_Template, 1, 0, "ng-container", 9);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r4 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx_r4.loadingTemplate);
} }
export class LoadMoreComponent {
    constructor(element, cdRef) {
        this.element = element;
        this.cdRef = cdRef;
        this.useIntersection = true;
        this.hidden = false;
        this.class = 'c8y-list__item p-0';
        this.maxIterations = 10;
        this.hideNoMoreDataHint = false;
        this.onLoad = new EventEmitter();
        this.isLoading = false;
        this.counter = 0;
        this.hasNoMoreData = false;
        this.LOAD_SAME_PAGE_THRESHOLD = 50;
        this.destroyed = false;
    }
    get hostClass() {
        return this.hidden || (!this.hasMore && !this.hasNoMoreData) ? '' : this.class;
    }
    get hasMore() {
        return (this.paging && (this.paging.totalPages > this.paging.currentPage || !!this.paging.nextPage));
    }
    ngAfterContentInit() {
        this.destroyed = false;
        if (this.useIntersection && 'IntersectionObserver' in window) {
            this.intersectionObserver = new IntersectionObserver(event => this.buttonInView(event[0]), {
                root: this.container ? this.container.nativeElement : null
            });
            this.intersectionObserver.observe(this.element.nativeElement);
        }
        this.hasNoMoreData = this.shouldShowNoMoreDataHint();
    }
    ngOnDestroy() {
        this.destroyed = true;
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
            this.intersectionObserver.unobserve(this.element.nativeElement);
            clearTimeout(this.loadUntilIntersected);
        }
    }
    loadMore(event) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.destroyed) {
                this.isLoading = true;
                this.cdRef.detectChanges();
                if (event) {
                    event.stopPropagation();
                }
                if (this.hasMore) {
                    const result = yield this.paging.next();
                    this.paging = result.paging;
                    this.onLoad.emit(result.data);
                    this.intersectionLoading();
                    this.hasNoMoreData = this.shouldShowNoMoreDataHint();
                }
                else {
                    this.counter = 0;
                    this.isLoading = false;
                }
                this.cdRef.detectChanges();
            }
        });
    }
    intersectionLoading() {
        if (this.useIntersection && this.hasMore && this.loadUntilIntersected !== null) {
            this.loadUntilIntersected = setTimeout(() => this.loadMore(), this.getLoadingThreshold());
            this.useIntersection = this.shouldSwitchMode();
        }
        else {
            this.isLoading = false;
            this.loadUntilIntersected = undefined;
            this.cdRef.detectChanges();
        }
    }
    getLoadingThreshold() {
        return this.LOAD_SAME_PAGE_THRESHOLD * this.counter++;
    }
    shouldShowNoMoreDataHint() {
        return (this.counter !== 0 || this.noMoreDataHint) && !this.hasMore && !this.hidden;
    }
    shouldSwitchMode() {
        return this.counter < this.maxIterations || this.hidden;
    }
    buttonInView(event) {
        if (event.isIntersecting) {
            this.loadMore();
        }
        else if (this.loadUntilIntersected) {
            clearTimeout(this.loadUntilIntersected);
            this.loadUntilIntersected = null;
            this.isLoading = false;
            this.cdRef.detectChanges();
        }
        else {
            // avoiding a race condition when timeout is faster
            // cleared then set
            this.loadUntilIntersected = null;
        }
    }
}
LoadMoreComponent.ɵfac = function LoadMoreComponent_Factory(t) { return new (t || LoadMoreComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef)); };
LoadMoreComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: LoadMoreComponent, selectors: [["c8y-load-more"]], hostVars: 2, hostBindings: function LoadMoreComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassMap(ctx.hostClass);
    } }, inputs: { useIntersection: "useIntersection", hidden: "hidden", class: "class", maxIterations: "maxIterations", hideNoMoreDataHint: "hideNoMoreDataHint", paging: "paging", container: "container", noMoreDataHint: "noMoreDataHint", loadingTemplate: "loadingTemplate", loadNextLabel: "loadNextLabel", loadingLabel: "loadingLabel" }, outputs: { onLoad: "onLoad" }, decls: 5, vars: 3, consts: [["class", "btn btn-default btn-block text-center", 3, "ngClass", "visibility", "height", "title", "click", 4, "ngIf"], [4, "ngIf"], ["finishHint", ""], [1, "btn", "btn-default", "btn-block", "text-center", 3, "ngClass", "title", "click"], [3, "innerHTML", 4, "ngIf", "ngIfElse"], ["loadPage", ""], [3, "innerHTML"], ["translate", "", 3, "translateParams"], ["loading", ""], [4, "ngTemplateOutlet"], [1, "legend", "form-block", "center", "last-record", 3, "title"], [3, "c8yIcon"]], template: function LoadMoreComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, LoadMoreComponent_button_0_Template, 4, 12, "button", 0);
        ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_1_Template, 2, 1, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_ng_template_2_Template, 3, 4, "ng-template", null, 2, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵtemplate(4, LoadMoreComponent_ng_container_4_Template, 2, 1, "ng-container", 1);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", ctx.hasMore && !(ctx.loadingTemplate && ctx.isLoading));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.hasNoMoreData && !ctx.hideNoMoreDataHint && !ctx.isLoading);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("ngIf", ctx.loadingTemplate && ctx.isLoading);
    } }, directives: [ɵngcc1.NgIf, ɵngcc1.NgClass, ɵngcc2.C8yTranslateDirective, ɵngcc1.NgTemplateOutlet, ɵngcc3.IconDirective], pipes: [ɵngcc4.C8yTranslatePipe], encapsulation: 2 });
LoadMoreComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ChangeDetectorRef }
];
LoadMoreComponent.propDecorators = {
    paging: [{ type: Input }],
    useIntersection: [{ type: Input }],
    hidden: [{ type: Input }],
    container: [{ type: Input }],
    class: [{ type: Input }],
    maxIterations: [{ type: Input }],
    noMoreDataHint: [{ type: Input }],
    loadingTemplate: [{ type: Input }],
    hideNoMoreDataHint: [{ type: Input }],
    loadNextLabel: [{ type: Input }],
    loadingLabel: [{ type: Input }],
    onLoad: [{ type: Output }],
    hostClass: [{ type: HostBinding, args: ['class',] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(LoadMoreComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-load-more',
                template: "<button\n  class=\"btn btn-default btn-block text-center\"\n  (click)=\"loadMore($event)\"\n  [ngClass]=\"{ 'btn-pending': isLoading }\"\n  *ngIf=\"hasMore && !(loadingTemplate && isLoading)\"\n  [style.visibility]=\"hidden ? 'hidden' : 'visible'\"\n  [style.height]=\"hidden ? '1px' : null\"\n  title=\"{{ 'Load more' | translate }}\"\n>\n  <ng-container *ngIf=\"!isLoading\">\n    <span *ngIf=\"loadNextLabel; else loadPage\" [innerHTML]=\"loadNextLabel | translate\"></span>\n    <ng-template #loadPage>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Load page {{ pageNo }}</span\n      >\n    </ng-template>\n  </ng-container>\n  <ng-container *ngIf=\"isLoading\">\n    <span *ngIf=\"loadingLabel; else loading\" [innerHTML]=\"loadingLabel | translate\"></span>\n    <ng-template #loading>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Page {{ pageNo }} is loading\u2026\n      </span>\n    </ng-template>\n  </ng-container>\n</button>\n\n<ng-container *ngIf=\"hasNoMoreData && !hideNoMoreDataHint && !isLoading\">\n  <ng-container *ngTemplateOutlet=\"noMoreDataHint || finishHint\"></ng-container>\n</ng-container>\n\n<ng-template #finishHint>\n  <div class=\"legend form-block center last-record\" title=\"{{ 'Last record' | translate }}\">\n    <i [c8yIcon]=\"'circle'\"></i>\n  </div>\n</ng-template>\n\n<ng-container *ngIf=\"loadingTemplate && isLoading\">\n  <ng-container *ngTemplateOutlet=\"loadingTemplate\"></ng-container>\n</ng-container>\n"
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.ChangeDetectorRef }]; }, { useIntersection: [{
            type: Input
        }], hidden: [{
            type: Input
        }], class: [{
            type: Input
        }], maxIterations: [{
            type: Input
        }], hideNoMoreDataHint: [{
            type: Input
        }], onLoad: [{
            type: Output
        }], hostClass: [{
            type: HostBinding,
            args: ['class']
        }], paging: [{
            type: Input
        }], container: [{
            type: Input
        }], noMoreDataHint: [{
            type: Input
        }], loadingTemplate: [{
            type: Input
        }], loadNextLabel: [{
            type: Input
        }], loadingLabel: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1tb3JlLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vbG9hZC1tb3JlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixXQUFXLEVBQ1gsS0FBSyxFQUNMLE1BQU0sRUFFUCxNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU92QixNQUFNLE9BQU8saUJBQWlCO0FBQzlCLElBNENFLFlBQW9CLE9BQW1CLEVBQVUsS0FBd0I7QUFBSSxRQUF6RCxZQUFPLEdBQVAsT0FBTyxDQUFZO0FBQUMsUUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFtQjtBQUFDLFFBekMxRSxvQkFBZSxHQUFHLElBQUksQ0FBQztBQUN6QixRQUNFLFdBQU0sR0FBRyxLQUFLLENBQUM7QUFDakIsUUFHRSxVQUFLLEdBQVcsb0JBQW9CLENBQUM7QUFDdkMsUUFDRSxrQkFBYSxHQUFHLEVBQUUsQ0FBQztBQUNyQixRQUtFLHVCQUFrQixHQUFZLEtBQUssQ0FBQztBQUN0QyxRQUtFLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO0FBQzNDLFFBQ0UsY0FBUyxHQUFHLEtBQUssQ0FBQztBQUNwQixRQUFFLFlBQU8sR0FBRyxDQUFDLENBQUM7QUFDZCxRQUFFLGtCQUFhLEdBQUcsS0FBSyxDQUFDO0FBQ3hCLFFBQ21CLDZCQUF3QixHQUFHLEVBQUUsQ0FBQztBQUNqRCxRQUNVLGNBQVMsR0FBRyxLQUFLLENBQUM7QUFDNUIsSUFZOEUsQ0FBQztBQUMvRSxJQVpFLElBQ0ksU0FBUztBQUNmLFFBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxJ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ICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdEJpbmRpbmcsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIFRlbXBsYXRlUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSUlkZW50aWZpZWQsIFBhZ2luZyB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWxvYWQtbW9yZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9sb2FkLW1vcmUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIExvYWRNb3JlQ29tcG9uZW50IHtcbiAgQElucHV0KClcbiAgcGFnaW5nOiBQYWdpbmc8YW55PjtcbiAgQElucHV0KClcbiAgdXNlSW50ZXJzZWN0aW9uID0gdHJ1ZTtcbiAgQElucHV0KClcbiAgaGlkZGVuID0gZmFsc2U7XG4gIEBJbnB1dCgpXG4gIGNvbnRhaW5lcjogRWxlbWVudFJlZjtcbiAgQElucHV0KClcbiAgY2xhc3M6IHN0cmluZyA9ICdjOHktbGlzdF9faXRlbSBwLTAnO1xuICBASW5wdXQoKVxuICBtYXhJdGVyYXRpb25zID0gMTA7XG4gIEBJbnB1dCgpXG4gIG5vTW9yZURhdGFIaW50OiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBASW5wdXQoKVxuICBsb2FkaW5nVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XG4gIEBJbnB1dCgpXG4gIGhpZGVOb01vcmVEYXRhSGludDogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBsb2FkTmV4dExhYmVsOiBzdHJpbmc7XG4gIEBJbnB1dCgpXG4gIGxvYWRpbmdMYWJlbDogc3RyaW5nO1xuICBAT3V0cHV0KClcbiAgb25Mb2FkID0gbmV3IEV2ZW50RW1pdHRlcjxJSWRlbnRpZmllZD4oKTtcblxuICBpc0xvYWRpbmcgPSBmYWxzZTtcbiAgY291bnRlciA9IDA7XG4gIGhhc05vTW9yZURhdGEgPSBmYWxzZTtcbiAgcHJpdmF0ZSBsb2FkVW50aWxJbnRlcnNlY3RlZDtcbiAgcHJpdmF0ZSByZWFkb25seSBMT0FEX1NBTUVfUEFHRV9USFJFU0hPTEQgPSA1MDtcbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXI7XG4gIHByaXZhdGUgZGVzdHJveWVkID0gZmFsc2U7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXG4gIGdldCBob3N0Q2xhc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlkZGVuIHx8ICghdGhpcy5oYXNNb3JlICYmICF0aGlzLmhhc05vTW9yZURhdGEpID8gJycgOiB0aGlzLmNsYXNzO1xuICB9XG5cbiAgZ2V0IGhhc01vcmUoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMucGFnaW5nICYmICh0aGlzLnBhZ2luZy50b3RhbFBhZ2VzID4gdGhpcy5wYWdpbmcuY3VycmVudFBhZ2UgfHwgISF0aGlzLnBhZ2luZy5uZXh0UGFnZSlcbiAgICApO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmLCBwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge31cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy51c2VJbnRlcnNlY3Rpb24gJiYgJ0ludGVyc2VjdGlvbk9ic2VydmVyJyBpbiB3aW5kb3cpIHtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoZXZlbnQgPT4gdGhpcy5idXR0b25JblZpZXcoZXZlbnRbMF0pLCB7XG4gICAgICAgIHJvb3Q6IHRoaXMuY29udGFpbmVyID8gdGhpcy5jb250YWluZXIubmF0aXZlRWxlbWVudCA6IG51bGxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5vYnNlcnZlKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50KTtcbiAgICB9XG4gICAgdGhpcy5oYXNOb01vcmVEYXRhID0gdGhpcy5zaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlcikge1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLnVub2JzZXJ2ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZE1vcmUoZXZlbnQ/KSB7XG4gICAgaWYgKCF0aGlzLmRlc3Ryb3llZCkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICBpZiAoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5oYXNNb3JlKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucGFnaW5nLm5leHQoKTtcbiAgICAgICAgdGhpcy5wYWdpbmcgPSByZXN1bHQucGFnaW5nO1xuICAgICAgICB0aGlzLm9uTG9hZC5lbWl0KHJlc3VsdC5kYXRhKTtcbiAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25Mb2FkaW5nKCk7XG4gICAgICAgIHRoaXMuaGFzTm9Nb3JlRGF0YSA9IHRoaXMuc2hvdWxkU2hvd05vTW9yZURhdGFIaW50KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNvdW50ZXIgPSAwO1xuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25Mb2FkaW5nKCkge1xuICAgIGlmICh0aGlzLnVzZUludGVyc2VjdGlvbiAmJiB0aGlzLmhhc01vcmUgJiYgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5sb2FkTW9yZSgpLCB0aGlzLmdldExvYWRpbmdUaHJlc2hvbGQoKSk7XG4gICAgICB0aGlzLnVzZUludGVyc2VjdGlvbiA9IHRoaXMuc2hvdWxkU3dpdGNoTW9kZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9hZGluZ1RocmVzaG9sZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLkxPQURfU0FNRV9QQUdFX1RIUkVTSE9MRCAqIHRoaXMuY291bnRlcisrO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNvdW50ZXIgIT09IDAgfHwgdGhpcy5ub01vcmVEYXRhSGludCkgJiYgIXRoaXMuaGFzTW9yZSAmJiAhdGhpcy5oaWRkZW47XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFN3aXRjaE1vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY291bnRlciA8IHRoaXMubWF4SXRlcmF0aW9ucyB8fCB0aGlzLmhpZGRlbjtcbiAgfVxuXG4gIHByaXZhdGUgYnV0dG9uSW5WaWV3KGV2ZW50KSB7XG4gICAgaWYgKGV2ZW50LmlzSW50ZXJzZWN0aW5nKSB7XG4gICAgICB0aGlzLmxvYWRNb3JlKCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCk7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gbnVsbDtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmNkUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYXZvaWRpbmcgYSByYWNlIGNvbmRpdGlvbiB3aGVuIHRpbWVvdXQgaXMgZmFzdGVyXG4gICAgICAvLyBjbGVhcmVkIHRoZW4gc2V0XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==