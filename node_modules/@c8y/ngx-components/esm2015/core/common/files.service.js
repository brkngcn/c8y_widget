import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryBinaryService, SystemOptionsService } from '@c8y/client';
import { every, first, flatten, get, isNaN, isUndefined, keys, map, uniq } from 'lodash-es';
import { saveAs } from 'file-saver';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/system-options/SystemOptionsService";
import * as i2 from "@c8y/client/lib/src/inventory/InventoryBinaryService";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
export var GENERIC_FILE_TYPE;
(function (GENERIC_FILE_TYPE) {
    GENERIC_FILE_TYPE["ARCHIVE"] = "archive";
    GENERIC_FILE_TYPE["AUDIO"] = "audio";
    GENERIC_FILE_TYPE["CODE"] = "code";
    GENERIC_FILE_TYPE["EXCEL"] = "excel";
    GENERIC_FILE_TYPE["IMAGE"] = "image";
    GENERIC_FILE_TYPE["PDF"] = "pdf";
    GENERIC_FILE_TYPE["POWERPOINT"] = "powerpoint";
    GENERIC_FILE_TYPE["TEXT"] = "text";
    GENERIC_FILE_TYPE["VIDEO"] = "video";
    GENERIC_FILE_TYPE["WORD"] = "word";
    GENERIC_FILE_TYPE["EPL"] = "epl";
})(GENERIC_FILE_TYPE || (GENERIC_FILE_TYPE = {}));
export class FilesService {
    constructor(systemOptionsService, inventoryBinaryService) {
        this.systemOptionsService = systemOptionsService;
        this.inventoryBinaryService = inventoryBinaryService;
        this.DEFAULT_BYTES_LIMIT = 52428800;
        this.FILENAME_MAX_LENGTH = 128;
        this.fileTypeExtensionsMap = {
            [GENERIC_FILE_TYPE.ARCHIVE]: {
                exts: ['7z', 'apk', 'cab', 'gz', 'iso', 'jar', 'rar', 'tar', 'zip']
            },
            [GENERIC_FILE_TYPE.AUDIO]: {
                exts: ['3gp', 'aiff', 'aac', 'amr', 'm4a', 'm4p', 'mp3', 'oga', 'ogg', 'raw', 'wav', 'wma']
            },
            [GENERIC_FILE_TYPE.CODE]: {
                exts: ['aspx', 'exe', 'htm', 'html', 'jad', 'js', 'json', 'jsp', 'php', 'xml']
            },
            [GENERIC_FILE_TYPE.EXCEL]: {
                exts: ['xls', 'xlsx']
            },
            [GENERIC_FILE_TYPE.IMAGE]: {
                exts: ['bmp', 'gif', 'jpeg', 'jpg', 'png', 'tiff', 'svg', 'ico']
            },
            [GENERIC_FILE_TYPE.PDF]: {
                exts: ['pdf']
            },
            [GENERIC_FILE_TYPE.POWERPOINT]: {
                exts: ['ppt', 'pptx']
            },
            [GENERIC_FILE_TYPE.TEXT]: {
                exts: ['txt']
            },
            [GENERIC_FILE_TYPE.VIDEO]: {
                exts: ['asf', 'avi', 'flv', 'mov', 'mp4', 'ogv', 'qt', 'rm', 'rmvb', 'wmv', '3gp']
            },
            [GENERIC_FILE_TYPE.WORD]: {
                exts: ['doc', 'docx']
            },
            [GENERIC_FILE_TYPE.EPL]: {
                exts: ['mon']
            }
        };
        this.fileSizeLimitCfg = {
            systemOption: {
                category: 'files',
                key: 'max.size'
            },
            defaultBytesLimit: this.DEFAULT_BYTES_LIMIT,
            actualBytesLimit: undefined
        };
    }
    /**
     * Checks if files have valid size.
     * @param files Files to check.
     * @returns Returns true if each file has the correct size.
     */
    haveValidSizes(files) {
        return __awaiter(this, void 0, void 0, function* () {
            const limit = yield this.loadBytesSizeLimit();
            return every(files, (f) => {
                return this.size(f) <= limit;
            });
        });
    }
    /**
     * Checks the system file size limit, if not available returns the default value.
     * Default limit: [DEFAULT_BYTES_LIMIT]{@link DEFAULT_BYTES_LIMIT}
     * @returns Returns promise with the limit value.
     */
    loadBytesSizeLimit() {
        return __awaiter(this, void 0, void 0, function* () {
            let bytesLimit = this.DEFAULT_BYTES_LIMIT;
            if (this.fileSizeLimitCfg.actualBytesLimit) {
                return this.fileSizeLimitCfg.actualBytesLimit;
            }
            const { systemOption } = this.fileSizeLimitCfg;
            try {
                const { data: { value: actualBytesLimit } } = yield this.systemOptionsService.detail(systemOption);
                if (!actualBytesLimit) {
                    return bytesLimit;
                }
                const parsedActualBytesLimit = parseInt(actualBytesLimit, 10);
                if (isNaN(parsedActualBytesLimit)) {
                    return bytesLimit;
                }
                this.fileSizeLimitCfg.actualBytesLimit = parsedActualBytesLimit;
                bytesLimit = parsedActualBytesLimit;
            }
            catch (error) {
                // do nothing
            }
            return bytesLimit;
        });
    }
    /**
     * Checks the size of the file
     * @param file File to check.
     * @returns Returns size of the file in bytes.
     */
    size(file) {
        const fileLength = get(file, 'length') || get(file, 'size');
        const attachments = get(file, '_attachments');
        const attachmentsObj = get(attachments, first(keys(attachments)));
        return isUndefined(fileLength) ? get(attachmentsObj, 'length') : fileLength;
    }
    /**
     * Checks whether files have allowed extensions.
     * If the accept parameter is not specified, all extensions are accepted.
     * @param files Files to check.
     * @param accept String of comma separated file extensions and generic types ([GENERIC_FILE_TYPE]{@link GENERIC_FILE_TYPE}), e.g. .zip,.7z,excel.
     * @returns  Returns true if each file has allowed extension.
     */
    haveValidExtensions(files, accept) {
        if (!accept) {
            return true;
        }
        const filesArray = files.item
            ? Array.from(files)
            : Array.isArray(files)
                ? files
                : [files];
        const filesExts = filesArray.map((file) => { var _a; return (_a = this.getFileExtension(file)) === null || _a === void 0 ? void 0 : _a.toLowerCase(); });
        const allowedExts = this.extractFileExtensions(accept);
        return filesExts.every(ext => allowedExts.includes(ext));
    }
    /**
     * Checks if each file has a valid filename length.
     * @param files Files to check.
     * @returns Returns true if each file has a valid filename length.
     */
    checkMaxLength(files) {
        return every(files, (f) => {
            return this.FILENAME_MAX_LENGTH > f.name.length;
        });
    }
    /**
     * Extracts the file extension.
     * @param file File from which the extension should be extracted.
     * @returns Returns the file extension or undefined if the file has no extension.
     */
    getFileExtension(file) {
        const fileNameAndFileExt = file.name.split('.');
        if (fileNameAndFileExt.length === 1) {
            // no file ext
            return undefined;
        }
        return fileNameAndFileExt.pop();
    }
    /**
     * List of file extensions.
     * @returns Returns list of file extensions.
     */
    getFileExtensions() {
        return uniq(flatten(map(this.fileTypeExtensionsMap, ({ exts }) => exts)));
    }
    /**
     * The list of generic file types.
     * @returns Returns the list of generic file types.
     */
    getGenericFileTypes() {
        return Object.keys(this.fileTypeExtensionsMap);
    }
    /**
     * @ignore
     */
    mapGenericFileTypesToExtensions(genericFileTypes = []) {
        const fileExts = genericFileTypes.map(gT => {
            const { exts } = this.fileTypeExtensionsMap[gT];
            return exts;
        });
        return uniq(flatten(fileExts));
    }
    /**
     * Extracts a list of file extensions from a string.
     * Can accept generic file types check: [GENERIC_FILE_TYPE]{@link GENERIC_FILE_TYPE}.
     *
     * @param str String from which the file extensions are extracted (comma separated values).
     * Accepted string format:
     * * ".zip,.iso",
     * * "zip,ISO",
     * * "archive".
     * Important: generic types cannot contain a dot. All values with a dot are treated as a normal extension.
     * @returns Returns a list of the file extensions.
     */
    extractFileExtensions(str) {
        if (!str) {
            return [];
        }
        const types = str.split(',').map(t => t.toLowerCase().trim());
        const genericTypes = types.filter((t) => this.isGenericType(t));
        const defaultFileExts = types.filter((t) => !this.isGenericType(t));
        const allTypes = [
            ...this.mapGenericFileTypesToExtensions(genericTypes),
            ...defaultFileExts
        ].map(t => t.replace('.', ''));
        return uniq(allTypes);
    }
    /**
     * Converts a file to a base64 image string.
     *
     * @param file The file to convert to base 64.
     * @returns The image string in base64 format.
     */
    toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    /**
     * Allows to get a File representation of an managed object binary. Can be used
     * to convert this file toBase64 to show it to the end-user.
     * @param binary The binary managed object
     * @returns The file representation.
     */
    getFile(binary) {
        return __awaiter(this, void 0, void 0, function* () {
            const res = yield this.inventoryBinaryService.download(binary.id);
            const arrayBuffer = yield res.arrayBuffer();
            return new File([arrayBuffer], binary.name, { type: binary.contentType });
        });
    }
    /**
     * Allows to download a file (opens the browser download prompt).
     * @param binary The binary managed object.
     */
    download(binary) {
        return __awaiter(this, void 0, void 0, function* () {
            const file = yield this.getFile(binary);
            saveAs(file);
        });
    }
    isGenericType(type) {
        return Object.values(GENERIC_FILE_TYPE).includes(type);
    }
}
FilesService.ɵfac = function FilesService_Factory(t) { return new (t || FilesService)(ɵngcc0.ɵɵinject(ɵngcc1.SystemOptionsService), ɵngcc0.ɵɵinject(ɵngcc1.InventoryBinaryService)); };
FilesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FilesService_Factory() { return new FilesService(i0.ɵɵinject(i1.SystemOptionsService), i0.ɵɵinject(i2.InventoryBinaryService)); }, token: FilesService, providedIn: "root" });
FilesService.ctorParameters = () => [
    { type: SystemOptionsService },
    { type: InventoryBinaryService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(FilesService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc1.SystemOptionsService }, { type: ɵngcc1.InventoryBinaryService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZXMuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vZmlsZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQXdCLHNCQUFzQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM1RixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3BDO0FBRUk7QUFJQzs7O0FBTEwsTUFBTSxDQUFOLElBQVksaUJBWVg7QUFaRCxXQUFZLGlCQUFpQjtBQUM1QixJQUFDLHdDQUFtQixDQUFBO0FBQUMsSUFDcEIsb0NBQWUsQ0FBQTtBQUFDLElBQ2hCLGtDQUFhLENBQUE7QUFBQyxJQUNkLG9DQUFlLENBQUE7QUFBQyxJQUNoQixvQ0FBZSxDQUFBO0FBQUMsSUFDaEIsZ0NBQVcsQ0FBQTtBQUFDLElBQ1osOENBQXlCLENBQUE7QUFBQyxJQUMxQixrQ0FBYSxDQUFBO0FBQUMsSUFDZCxvQ0FBZSxDQUFBO0FBQUMsSUFDaEIsa0NBQWEsQ0FBQTtBQUFDLElBQ2QsZ0NBQVcsQ0FBQTtBQUNiLENBQUMsRUFaVyxpQkFBaUIsS0FBakIsaUJBQWlCLFFBWTVCO0FBRUQsTUFBTSxPQUFPLFlBQVk7QUFDekIsSUFnREUsWUFDVSxvQkFBMEMsRUFDMUMsc0JBQThDO0FBQ3ZELFFBRlMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtBQUFDLFFBQzNDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7QUFDMUQsUUFuRFcsd0JBQW1CLEdBQUcsUUFBUSxDQUFDO0FBQzFDLFFBQVcsd0JBQW1C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LENBQUMsQ0FBQztBQUNQLElBQUUsQ0FBQztBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFDRTtBQUVKLE9BREc7QUFDTCxJQUFRLE9BQU8sQ0FBQyxNQUE0QjtBQUFJO0FBQ0QsWUFBM0MsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0RSxZQUFJLE1BQU0sV0FBVyxHQUFHLE1BQU0sR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ2hELFlBQUksT0FBTyxJQUFJLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDOUUsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0UsT0FBQztBQUNMLElBQVEsUUFBUSxDQUFDLE1BQTRCO0FBQzdDO0FBQ2lCLFlBRGIsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzVDLFlBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ2pCLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNVLGFBQWEsQ0FBQyxJQUFZO0FBQ3BDLFFBQUksT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsUUFBUSxDQUFDLElBQXlCLENBQUMsQ0FBQztBQUNoRixJQUFFLENBQUM7QUFDSDt1TEFBQztBQUNELDZPQWhRSztBQUFDO0VBREwsVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLG5DQUVWLFlBbkJ1QyxvQkFBb0I7S0FpQjNDLEVBQUUsUEFqQjZDLFlBQWhELHNCQUFzQjtBQUFHOzs7OzhIQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdEJpbmFyeSwgSW52ZW50b3J5QmluYXJ5U2VydmljZSwgU3lzdGVtT3B0aW9uc1NlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBldmVyeSwgZmlyc3QsIGZsYXR0ZW4sIGdldCwgaXNOYU4sIGlzVW5kZWZpbmVkLCBrZXlzLCBtYXAsIHVuaXEgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgc2F2ZUFzIH0gZnJvbSAnZmlsZS1zYXZlcic7XG5cbmV4cG9ydCBlbnVtIEdFTkVSSUNfRklMRV9UWVBFIHtcbiAgQVJDSElWRSA9ICdhcmNoaXZlJyxcbiAgQVVESU8gPSAnYXVkaW8nLFxuICBDT0RFID0gJ2NvZGUnLFxuICBFWENFTCA9ICdleGNlbCcsXG4gIElNQUdFID0gJ2ltYWdlJyxcbiAgUERGID0gJ3BkZicsXG4gIFBPV0VSUE9JTlQgPSAncG93ZXJwb2ludCcsXG4gIFRFWFQgPSAndGV4dCcsXG4gIFZJREVPID0gJ3ZpZGVvJyxcbiAgV09SRCA9ICd3b3JkJyxcbiAgRVBMID0gJ2VwbCdcbn1cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRmlsZXNTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgREVGQVVMVF9CWVRFU19MSU1JVCA9IDUyNDI4ODAwO1xuICByZWFkb25seSBGSUxFTkFNRV9NQVhfTEVOR1RIID0gMTI4O1xuXG4gIGZpbGVUeXBlRXh0ZW5zaW9uc01hcDogeyBba2V5OiBzdHJpbmddOiB7IGV4dHM6IHN0cmluZ1tdIH0gfSA9IHtcbiAgICBbR0VORVJJQ19GSUxFX1RZUEUuQVJDSElWRV06IHtcbiAgICAgIGV4dHM6IFsnN3onLCAnYXBrJywgJ2NhYicsICdneicsICdpc28nLCAnamFyJywgJ3JhcicsICd0YXInLCAnemlwJ11cbiAgICB9LFxuICAgIFtHRU5FUklDX0ZJTEVfVFlQRS5BVURJT106IHtcbiAgICAgIGV4dHM6IFsnM2dwJywgJ2FpZmYnLCAnYWFjJywgJ2FtcicsICdtNGEnLCAnbTRwJywgJ21wMycsICdvZ2EnLCAnb2dnJywgJ3JhdycsICd3YXYnLCAnd21hJ11cbiAgICB9LFxuICAgIFtHRU5FUklDX0ZJTEVfVFlQRS5DT0RFXToge1xuICAgICAgZXh0czogWydhc3B4JywgJ2V4ZScsICdodG0nLCAnaHRtbCcsICdqYWQnLCAnanMnLCAnanNvbicsICdqc3AnLCAncGhwJywgJ3htbCddXG4gICAgfSxcbiAgICBbR0VORVJJQ19GSUxFX1RZUEUuRVhDRUxdOiB7XG4gICAgICBleHRzOiBbJ3hscycsICd4bHN4J11cbiAgICB9LFxuICAgIFtHRU5FUklDX0ZJTEVfVFlQRS5JTUFHRV06IHtcbiAgICAgIGV4dHM6IFsnYm1wJywgJ2dpZicsICdqcGVnJywgJ2pwZycsICdwbmcnLCAndGlmZicsICdzdmcnLCAnaWNvJ11cbiAgICB9LFxuICAgIFtHRU5FUklDX0ZJTEVfVFlQRS5QREZdOiB7XG4gICAgICBleHRzOiBbJ3BkZiddXG4gICAgfSxcbiAgICBbR0VORVJJQ19GSUxFX1RZUEUuUE9XRVJQT0lOVF06IHtcbiAgICAgIGV4dHM6IFsncHB0JywgJ3BwdHgnXVxuICAgIH0sXG4gICAgW0dFTkVSSUNfRklMRV9UWVBFLlRFWFRdOiB7XG4gICAgICBleHRzOiBbJ3R4dCddXG4gICAgfSxcbiAgICBbR0VORVJJQ19GSUxFX1RZUEUuVklERU9dOiB7XG4gICAgICBleHRzOiBbJ2FzZicsICdhdmknLCAnZmx2JywgJ21vdicsICdtcDQnLCAnb2d2JywgJ3F0JywgJ3JtJywgJ3JtdmInLCAnd212JywgJzNncCddXG4gICAgfSxcbiAgICBbR0VORVJJQ19GSUxFX1RZUEUuV09SRF06IHtcbiAgICAgIGV4dHM6IFsnZG9jJywgJ2RvY3gnXVxuICAgIH0sXG4gICAgW0dFTkVSSUNfRklMRV9UWVBFLkVQTF06IHtcbiAgICAgIGV4dHM6IFsnbW9uJ11cbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBmaWxlU2l6ZUxpbWl0Q2ZnID0ge1xuICAgIHN5c3RlbU9wdGlvbjoge1xuICAgICAgY2F0ZWdvcnk6ICdmaWxlcycsXG4gICAgICBrZXk6ICdtYXguc2l6ZSdcbiAgICB9LFxuICAgIGRlZmF1bHRCeXRlc0xpbWl0OiB0aGlzLkRFRkFVTFRfQllURVNfTElNSVQsXG4gICAgYWN0dWFsQnl0ZXNMaW1pdDogdW5kZWZpbmVkXG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBzeXN0ZW1PcHRpb25zU2VydmljZTogU3lzdGVtT3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlCaW5hcnlTZXJ2aWNlOiBJbnZlbnRvcnlCaW5hcnlTZXJ2aWNlXG4gICkge31cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGZpbGVzIGhhdmUgdmFsaWQgc2l6ZS5cbiAgICogQHBhcmFtIGZpbGVzIEZpbGVzIHRvIGNoZWNrLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHRydWUgaWYgZWFjaCBmaWxlIGhhcyB0aGUgY29ycmVjdCBzaXplLlxuICAgKi9cbiAgYXN5bmMgaGF2ZVZhbGlkU2l6ZXMoZmlsZXM6IEZpbGVMaXN0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgbGltaXQgPSBhd2FpdCB0aGlzLmxvYWRCeXRlc1NpemVMaW1pdCgpO1xuXG4gICAgcmV0dXJuIGV2ZXJ5KGZpbGVzLCAoZjogRmlsZSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuc2l6ZShmKSA8PSBsaW1pdDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgdGhlIHN5c3RlbSBmaWxlIHNpemUgbGltaXQsIGlmIG5vdCBhdmFpbGFibGUgcmV0dXJucyB0aGUgZGVmYXVsdCB2YWx1ZS5cbiAgICogRGVmYXVsdCBsaW1pdDogW0RFRkFVTFRfQllURVNfTElNSVRde0BsaW5rIERFRkFVTFRfQllURVNfTElNSVR9XG4gICAqIEByZXR1cm5zIFJldHVybnMgcHJvbWlzZSB3aXRoIHRoZSBsaW1pdCB2YWx1ZS5cbiAgICovXG4gIGFzeW5jIGxvYWRCeXRlc1NpemVMaW1pdCgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGxldCBieXRlc0xpbWl0ID0gdGhpcy5ERUZBVUxUX0JZVEVTX0xJTUlUO1xuICAgIGlmICh0aGlzLmZpbGVTaXplTGltaXRDZmcuYWN0dWFsQnl0ZXNMaW1pdCkge1xuICAgICAgcmV0dXJuIHRoaXMuZmlsZVNpemVMaW1pdENmZy5hY3R1YWxCeXRlc0xpbWl0O1xuICAgIH1cbiAgICBjb25zdCB7IHN5c3RlbU9wdGlvbiB9ID0gdGhpcy5maWxlU2l6ZUxpbWl0Q2ZnO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgZGF0YTogeyB2YWx1ZTogYWN0dWFsQnl0ZXNMaW1pdCB9XG4gICAgICB9ID0gYXdhaXQgdGhpcy5zeXN0ZW1PcHRpb25zU2VydmljZS5kZXRhaWwoc3lzdGVtT3B0aW9uKTtcblxuICAgICAgaWYgKCFhY3R1YWxCeXRlc0xpbWl0KSB7XG4gICAgICAgIHJldHVybiBieXRlc0xpbWl0O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXJzZWRBY3R1YWxCeXRlc0xpbWl0ID0gcGFyc2VJbnQoYWN0dWFsQnl0ZXNMaW1pdCwgMTApO1xuICAgICAgaWYgKGlzTmFOKHBhcnNlZEFjdHVhbEJ5dGVzTGltaXQpKSB7XG4gICAgICAgIHJldHVybiBieXRlc0xpbWl0O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmZpbGVTaXplTGltaXRDZmcuYWN0dWFsQnl0ZXNMaW1pdCA9IHBhcnNlZEFjdHVhbEJ5dGVzTGltaXQ7XG4gICAgICBieXRlc0xpbWl0ID0gcGFyc2VkQWN0dWFsQnl0ZXNMaW1pdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gZG8gbm90aGluZ1xuICAgIH1cbiAgICByZXR1cm4gYnl0ZXNMaW1pdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgdGhlIHNpemUgb2YgdGhlIGZpbGVcbiAgICogQHBhcmFtIGZpbGUgRmlsZSB0byBjaGVjay5cbiAgICogQHJldHVybnMgUmV0dXJucyBzaXplIG9mIHRoZSBmaWxlIGluIGJ5dGVzLlxuICAgKi9cbiAgc2l6ZShmaWxlOiBGaWxlIHwgSU1hbmFnZWRPYmplY3RCaW5hcnkpOiBudW1iZXIge1xuICAgIGNvbnN0IGZpbGVMZW5ndGggPSBnZXQoZmlsZSwgJ2xlbmd0aCcpIHx8IGdldChmaWxlLCAnc2l6ZScpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gZ2V0KGZpbGUsICdfYXR0YWNobWVudHMnKTtcbiAgICBjb25zdCBhdHRhY2htZW50c09iaiA9IGdldChhdHRhY2htZW50cywgZmlyc3Qoa2V5cyhhdHRhY2htZW50cykpKTtcbiAgICByZXR1cm4gaXNVbmRlZmluZWQoZmlsZUxlbmd0aCkgPyBnZXQoYXR0YWNobWVudHNPYmosICdsZW5ndGgnKSA6IGZpbGVMZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIHdoZXRoZXIgZmlsZXMgaGF2ZSBhbGxvd2VkIGV4dGVuc2lvbnMuXG4gICAqIElmIHRoZSBhY2NlcHQgcGFyYW1ldGVyIGlzIG5vdCBzcGVjaWZpZWQsIGFsbCBleHRlbnNpb25zIGFyZSBhY2NlcHRlZC5cbiAgICogQHBhcmFtIGZpbGVzIEZpbGVzIHRvIGNoZWNrLlxuICAgKiBAcGFyYW0gYWNjZXB0IFN0cmluZyBvZiBjb21tYSBzZXBhcmF0ZWQgZmlsZSBleHRlbnNpb25zIGFuZCBnZW5lcmljIHR5cGVzIChbR0VORVJJQ19GSUxFX1RZUEVde0BsaW5rIEdFTkVSSUNfRklMRV9UWVBFfSksIGUuZy4gLnppcCwuN3osZXhjZWwuXG4gICAqIEByZXR1cm5zICBSZXR1cm5zIHRydWUgaWYgZWFjaCBmaWxlIGhhcyBhbGxvd2VkIGV4dGVuc2lvbi5cbiAgICovXG4gIGhhdmVWYWxpZEV4dGVuc2lvbnMoZmlsZXM6IEZpbGVMaXN0IHwgRmlsZSB8IEZpbGVbXSwgYWNjZXB0OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoIWFjY2VwdCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IGZpbGVzQXJyYXkgPSAoZmlsZXMgYXMgRmlsZUxpc3QpLml0ZW1cbiAgICAgID8gQXJyYXkuZnJvbShmaWxlcyBhcyBGaWxlTGlzdClcbiAgICAgIDogQXJyYXkuaXNBcnJheShmaWxlcylcbiAgICAgID8gZmlsZXNcbiAgICAgIDogW2ZpbGVzXTtcblxuICAgIGNvbnN0IGZpbGVzRXh0cyA9IGZpbGVzQXJyYXkubWFwKChmaWxlOiBGaWxlKSA9PiB0aGlzLmdldEZpbGVFeHRlbnNpb24oZmlsZSk/LnRvTG93ZXJDYXNlKCkpO1xuICAgIGNvbnN0IGFsbG93ZWRFeHRzID0gdGhpcy5leHRyYWN0RmlsZUV4dGVuc2lvbnMoYWNjZXB0KTtcbiAgICByZXR1cm4gZmlsZXNFeHRzLmV2ZXJ5KGV4dCA9PiBhbGxvd2VkRXh0cy5pbmNsdWRlcyhleHQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgZWFjaCBmaWxlIGhhcyBhIHZhbGlkIGZpbGVuYW1lIGxlbmd0aC5cbiAgICogQHBhcmFtIGZpbGVzIEZpbGVzIHRvIGNoZWNrLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHRydWUgaWYgZWFjaCBmaWxlIGhhcyBhIHZhbGlkIGZpbGVuYW1lIGxlbmd0aC5cbiAgICovXG4gIGNoZWNrTWF4TGVuZ3RoKGZpbGVzOiBGaWxlTGlzdCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBldmVyeShmaWxlcywgKGY6IEZpbGUpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLkZJTEVOQU1FX01BWF9MRU5HVEggPiBmLm5hbWUubGVuZ3RoO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIHRoZSBmaWxlIGV4dGVuc2lvbi5cbiAgICogQHBhcmFtIGZpbGUgRmlsZSBmcm9tIHdoaWNoIHRoZSBleHRlbnNpb24gc2hvdWxkIGJlIGV4dHJhY3RlZC5cbiAgICogQHJldHVybnMgUmV0dXJucyB0aGUgZmlsZSBleHRlbnNpb24gb3IgdW5kZWZpbmVkIGlmIHRoZSBmaWxlIGhhcyBubyBleHRlbnNpb24uXG4gICAqL1xuICBnZXRGaWxlRXh0ZW5zaW9uKGZpbGU6IEZpbGUpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGZpbGVOYW1lQW5kRmlsZUV4dCA9IGZpbGUubmFtZS5zcGxpdCgnLicpO1xuICAgIGlmIChmaWxlTmFtZUFuZEZpbGVFeHQubGVuZ3RoID09PSAxKSB7XG4gICAgICAvLyBubyBmaWxlIGV4dFxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIGZpbGVOYW1lQW5kRmlsZUV4dC5wb3AoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0IG9mIGZpbGUgZXh0ZW5zaW9ucy5cbiAgICogQHJldHVybnMgUmV0dXJucyBsaXN0IG9mIGZpbGUgZXh0ZW5zaW9ucy5cbiAgICovXG4gIGdldEZpbGVFeHRlbnNpb25zKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdW5pcShmbGF0dGVuKG1hcCh0aGlzLmZpbGVUeXBlRXh0ZW5zaW9uc01hcCwgKHsgZXh0cyB9KSA9PiBleHRzKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBsaXN0IG9mIGdlbmVyaWMgZmlsZSB0eXBlcy5cbiAgICogQHJldHVybnMgUmV0dXJucyB0aGUgbGlzdCBvZiBnZW5lcmljIGZpbGUgdHlwZXMuXG4gICAqL1xuICBnZXRHZW5lcmljRmlsZVR5cGVzKCk6IEdFTkVSSUNfRklMRV9UWVBFW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmZpbGVUeXBlRXh0ZW5zaW9uc01hcCkgYXMgR0VORVJJQ19GSUxFX1RZUEVbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBtYXBHZW5lcmljRmlsZVR5cGVzVG9FeHRlbnNpb25zKGdlbmVyaWNGaWxlVHlwZXM6IEdFTkVSSUNfRklMRV9UWVBFW10gPSBbXSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBmaWxlRXh0cyA9IGdlbmVyaWNGaWxlVHlwZXMubWFwKGdUID0+IHtcbiAgICAgIGNvbnN0IHsgZXh0cyB9ID0gdGhpcy5maWxlVHlwZUV4dGVuc2lvbnNNYXBbZ1RdO1xuICAgICAgcmV0dXJuIGV4dHM7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdW5pcShmbGF0dGVuKGZpbGVFeHRzKSk7XG4gIH1cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGEgbGlzdCBvZiBmaWxlIGV4dGVuc2lvbnMgZnJvbSBhIHN0cmluZy5cbiAgICogQ2FuIGFjY2VwdCBnZW5lcmljIGZpbGUgdHlwZXMgY2hlY2s6IFtHRU5FUklDX0ZJTEVfVFlQRV17QGxpbmsgR0VORVJJQ19GSUxFX1RZUEV9LlxuICAgKlxuICAgKiBAcGFyYW0gc3RyIFN0cmluZyBmcm9tIHdoaWNoIHRoZSBmaWxlIGV4dGVuc2lvbnMgYXJlIGV4dHJhY3RlZCAoY29tbWEgc2VwYXJhdGVkIHZhbHVlcykuXG4gICAqIEFjY2VwdGVkIHN0cmluZyBmb3JtYXQ6XG4gICAqICogXCIuemlwLC5pc29cIixcbiAgICogKiBcInppcCxJU09cIixcbiAgICogKiBcImFyY2hpdmVcIi5cbiAgICogSW1wb3J0YW50OiBnZW5lcmljIHR5cGVzIGNhbm5vdCBjb250YWluIGEgZG90LiBBbGwgdmFsdWVzIHdpdGggYSBkb3QgYXJlIHRyZWF0ZWQgYXMgYSBub3JtYWwgZXh0ZW5zaW9uLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGEgbGlzdCBvZiB0aGUgZmlsZSBleHRlbnNpb25zLlxuICAgKi9cbiAgZXh0cmFjdEZpbGVFeHRlbnNpb25zKHN0cjogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGlmICghc3RyKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IHR5cGVzID0gc3RyLnNwbGl0KCcsJykubWFwKHQgPT4gdC50b0xvd2VyQ2FzZSgpLnRyaW0oKSk7XG5cbiAgICBjb25zdCBnZW5lcmljVHlwZXMgPSB0eXBlcy5maWx0ZXIoKHQ6IHN0cmluZykgPT4gdGhpcy5pc0dlbmVyaWNUeXBlKHQpKTtcbiAgICBjb25zdCBkZWZhdWx0RmlsZUV4dHMgPSB0eXBlcy5maWx0ZXIoKHQ6IHN0cmluZykgPT4gIXRoaXMuaXNHZW5lcmljVHlwZSh0KSk7XG5cbiAgICBjb25zdCBhbGxUeXBlcyA9IFtcbiAgICAgIC4uLnRoaXMubWFwR2VuZXJpY0ZpbGVUeXBlc1RvRXh0ZW5zaW9ucyhnZW5lcmljVHlwZXMgYXMgR0VORVJJQ19GSUxFX1RZUEVbXSksXG4gICAgICAuLi5kZWZhdWx0RmlsZUV4dHNcbiAgICBdLm1hcCh0ID0+IHQucmVwbGFjZSgnLicsICcnKSk7XG5cbiAgICByZXR1cm4gdW5pcShhbGxUeXBlcyk7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydHMgYSBmaWxlIHRvIGEgYmFzZTY0IGltYWdlIHN0cmluZy5cbiAgICpcbiAgICogQHBhcmFtIGZpbGUgVGhlIGZpbGUgdG8gY29udmVydCB0byBiYXNlIDY0LlxuICAgKiBAcmV0dXJucyBUaGUgaW1hZ2Ugc3RyaW5nIGluIGJhc2U2NCBmb3JtYXQuXG4gICAqL1xuICB0b0Jhc2U2NChmaWxlOiBGaWxlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXNvbHZlKHJlYWRlci5yZXN1bHQpO1xuICAgICAgcmVhZGVyLm9uZXJyb3IgPSBlcnJvciA9PiByZWplY3QoZXJyb3IpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byBnZXQgYSBGaWxlIHJlcHJlc2VudGF0aW9uIG9mIGFuIG1hbmFnZWQgb2JqZWN0IGJpbmFyeS4gQ2FuIGJlIHVzZWRcbiAgICogdG8gY29udmVydCB0aGlzIGZpbGUgdG9CYXNlNjQgdG8gc2hvdyBpdCB0byB0aGUgZW5kLXVzZXIuXG4gICAqIEBwYXJhbSBiaW5hcnkgVGhlIGJpbmFyeSBtYW5hZ2VkIG9iamVjdFxuICAgKiBAcmV0dXJucyBUaGUgZmlsZSByZXByZXNlbnRhdGlvbi5cbiAgICovXG4gIGFzeW5jIGdldEZpbGUoYmluYXJ5OiBJTWFuYWdlZE9iamVjdEJpbmFyeSk6IFByb21pc2U8RmlsZT4ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5U2VydmljZS5kb3dubG9hZChiaW5hcnkuaWQpO1xuICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgcmVzLmFycmF5QnVmZmVyKCk7XG4gICAgcmV0dXJuIG5ldyBGaWxlKFthcnJheUJ1ZmZlcl0sIGJpbmFyeS5uYW1lLCB7IHR5cGU6IGJpbmFyeS5jb250ZW50VHlwZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gZG93bmxvYWQgYSBmaWxlIChvcGVucyB0aGUgYnJvd3NlciBkb3dubG9hZCBwcm9tcHQpLlxuICAgKiBAcGFyYW0gYmluYXJ5IFRoZSBiaW5hcnkgbWFuYWdlZCBvYmplY3QuXG4gICAqL1xuICBhc3luYyBkb3dubG9hZChiaW5hcnk6IElNYW5hZ2VkT2JqZWN0QmluYXJ5KSB7XG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0RmlsZShiaW5hcnkpO1xuICAgIHNhdmVBcyhmaWxlKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNHZW5lcmljVHlwZSh0eXBlOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhHRU5FUklDX0ZJTEVfVFlQRSkuaW5jbHVkZXModHlwZSBhcyBHRU5FUklDX0ZJTEVfVFlQRSk7XG4gIH1cbn1cbiJdfQ==