import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { ApplicationService } from '@c8y/client';
import { get, includes, orderBy } from 'lodash-es';
import { combineLatest } from 'rxjs';
import { first } from 'rxjs/operators';
import { AppStateService } from '../../common/ui-state.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../common/ui-state.service';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from 'ngx-bootstrap/dropdown';
import * as ɵngcc4 from '../../common/icon.directive';
import * as ɵngcc5 from '@angular/common';
import * as ɵngcc6 from '../../product-experience/product-experience.directive';
import * as ɵngcc7 from './app-icon.component';
import * as ɵngcc8 from '../../i18n/c8y-translate.pipe';
import * as ɵngcc9 from '../../common/humanize-app-name.pipe';

const _c0 = function (a0) { return { applicationName: a0 }; };
function AppSwitcherComponent_div_4_div_1_a_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "a", 10);
    ɵngcc0.ɵɵpipe(1, "async");
    ɵngcc0.ɵɵpipe(2, "humanizeAppName");
    ɵngcc0.ɵɵelement(3, "c8y-app-icon", 11);
    ɵngcc0.ɵɵelementStart(4, "span", 12);
    ɵngcc0.ɵɵtext(5);
    ɵngcc0.ɵɵpipe(6, "async");
    ɵngcc0.ɵɵpipe(7, "humanizeAppName");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const app_r4 = ctx.$implicit;
    const ctx_r3 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 8, ɵngcc0.ɵɵpipeBind1(2, 10, app_r4.name)));
    ɵngcc0.ɵɵproperty("href", ctx_r3.getHref(app_r4), ɵngcc0.ɵɵsanitizeUrl)("actionName", "appSwitched")("actionData", ɵngcc0.ɵɵpureFunction1(16, _c0, app_r4 && app_r4.name));
    ɵngcc0.ɵɵadvance(3);
    ɵngcc0.ɵɵproperty("app", app_r4)("name", app_r4.name)("contextPath", app_r4.contextPath);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(6, 12, ɵngcc0.ɵɵpipeBind1(7, 14, app_r4)));
} }
function AppSwitcherComponent_div_4_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 8);
    ɵngcc0.ɵɵtemplate(1, AppSwitcherComponent_div_4_div_1_a_1_Template, 8, 18, "a", 9);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r1.oneCloudApps);
} }
function AppSwitcherComponent_div_4_a_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "a", 13);
    ɵngcc0.ɵɵpipe(1, "async");
    ɵngcc0.ɵɵpipe(2, "humanizeAppName");
    ɵngcc0.ɵɵelement(3, "c8y-app-icon", 11);
    ɵngcc0.ɵɵelementStart(4, "span", 12);
    ɵngcc0.ɵɵtext(5);
    ɵngcc0.ɵɵpipe(6, "async");
    ɵngcc0.ɵɵpipe(7, "humanizeAppName");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const app_r5 = ctx.$implicit;
    const ctx_r2 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 9, ɵngcc0.ɵɵpipeBind1(2, 11, app_r5.name)));
    ɵngcc0.ɵɵproperty("ngClass", ctx_r2.isActive(app_r5) ? "active" : "")("href", ctx_r2.getHref(app_r5), ɵngcc0.ɵɵsanitizeUrl)("actionName", "appSwitched")("actionData", ɵngcc0.ɵɵpureFunction1(17, _c0, app_r5 && app_r5.name));
    ɵngcc0.ɵɵadvance(3);
    ɵngcc0.ɵɵproperty("app", app_r5)("name", app_r5.name)("contextPath", app_r5.contextPath);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(6, 13, ɵngcc0.ɵɵpipeBind1(7, 15, app_r5)));
} }
function AppSwitcherComponent_div_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 4);
    ɵngcc0.ɵɵtemplate(1, AppSwitcherComponent_div_4_div_1_Template, 2, 1, "div", 5);
    ɵngcc0.ɵɵelementStart(2, "div", 6);
    ɵngcc0.ɵɵtemplate(3, AppSwitcherComponent_div_4_a_3_Template, 8, 19, "a", 7);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.oneCloudApps && ctx_r0.oneCloudApps.length > 0);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r0.apps);
} }
export class AppSwitcherComponent {
    constructor(ui, applications) {
        this.ui = ui;
        this.applications = applications;
        const { currentUser, currentTenant } = this.ui;
        combineLatest(currentUser, currentTenant)
            .pipe(first())
            .subscribe(([user, tenant]) => {
            this.tenant = tenant;
            this.listAppsForUser(user);
        });
    }
    get hideCloudApps() {
        return false; // this should be configurable from outside
    }
    isActive(app) {
        return app.contextPath === this.ui.state.app.contextPath;
    }
    getHref(app) {
        return this.applications.getHref(app);
    }
    listAppsForUser(user) {
        return __awaiter(this, void 0, void 0, function* () {
            if (user) {
                const { data } = yield this.applications.listByUser(user, { pageSize: 1000 });
                this.apps = this.orderApps(this.filterApps(data));
            }
        });
    }
    filterApps(apps) {
        apps = this.filterVisible(apps);
        apps = this.filterCloud(apps);
        apps = this.filterDuplicates(apps);
        return apps;
    }
    filterVisible(apps) {
        const visibleApplicationTypes = ['HOSTED', 'EXTERNAL'];
        return apps.filter(app => includes(visibleApplicationTypes, app.type) &&
            !app.noAppSwitcher &&
            !get(app, 'manifest.noAppSwitcher'));
    }
    filterCloud(apps) {
        const { hideCloudApps } = this;
        const filterFn = app => !!app.cloud;
        if (!hideCloudApps) {
            this.oneCloudApps = this.orderApps(apps.filter(filterFn));
        }
        return apps.filter(app => !filterFn(app));
    }
    filterDuplicates(apps) {
        // Filter out apps that have duplicate contextpaths and are not own owned but the current tenant;
        const filterFn = app => !apps.some(otherApp => app !== otherApp &&
            (app.contextPath && app.contextPath === otherApp.contextPath) &&
            app.owner.tenant.id !== this.tenant.name);
        return apps.filter(filterFn);
    }
    orderApps(apps) {
        return orderBy(apps, ({ name }) => name.toLowerCase());
    }
}
AppSwitcherComponent.ɵfac = function AppSwitcherComponent_Factory(t) { return new (t || AppSwitcherComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AppStateService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.ApplicationService)); };
AppSwitcherComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: AppSwitcherComponent, selectors: [["c8y-app-switcher"]], decls: 5, vars: 3, consts: [["dropdown", "", 1, "app-switcher-dropdown"], ["id", "appSwitcherDropdown", "dropdownToggle", "", 1, "main-header-button", "c8y-dropdown", "dropdown-toggle", 3, "title"], ["c8yIcon", "th", 1, "icon-2x"], ["class", "app-switcher-dropdown-menu dropdown-menu", "aria-labelledby", "appSwitcherDropdown", 4, "dropdownMenu"], ["aria-labelledby", "appSwitcherDropdown", 1, "app-switcher-dropdown-menu", "dropdown-menu"], ["class", "app-switcher-sagcloud", 4, "ngIf"], [1, "app-switcher"], ["class", "appLink", "c8yProductExperience", "", 3, "title", "ngClass", "href", "actionName", "actionData", 4, "ngFor", "ngForOf"], [1, "app-switcher-sagcloud"], ["class", "appLink", "c8yProductExperience", "", 3, "title", "href", "actionName", "actionData", 4, "ngFor", "ngForOf"], ["c8yProductExperience", "", 1, "appLink", 3, "title", "href", "actionName", "actionData"], [3, "app", "name", "contextPath"], [1, "text-truncate-wrap"], ["c8yProductExperience", "", 1, "appLink", 3, "title", "ngClass", "href", "actionName", "actionData"]], template: function AppSwitcherComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵelementStart(1, "button", 1);
        ɵngcc0.ɵɵpipe(2, "translate");
        ɵngcc0.ɵɵelement(3, "i", 2);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵtemplate(4, AppSwitcherComponent_div_4_Template, 4, 2, "div", 3);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(2, 1, "Application switcher"));
    } }, directives: [ɵngcc3.BsDropdownDirective, ɵngcc3.BsDropdownToggleDirective, ɵngcc4.IconDirective, ɵngcc3.BsDropdownMenuDirective, ɵngcc5.NgIf, ɵngcc5.NgForOf, ɵngcc6.ProductExperienceDirective, ɵngcc7.AppIconComponent, ɵngcc5.NgClass], pipes: [ɵngcc8.C8yTranslatePipe, ɵngcc5.AsyncPipe, ɵngcc9.HumanizeAppNamePipe], encapsulation: 2 });
AppSwitcherComponent.ctorParameters = () => [
    { type: AppStateService },
    { type: ApplicationService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AppSwitcherComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-app-switcher',
                template: "<div class=\"app-switcher-dropdown\" dropdown>\n  <button\n    class=\"main-header-button c8y-dropdown dropdown-toggle\"\n    id=\"appSwitcherDropdown\"\n    dropdownToggle\n    title=\"{{ 'Application switcher' | translate }}\"\n  >\n    <i c8yIcon=\"th\" class=\"icon-2x\"></i>\n  </button>\n  <div\n    *dropdownMenu\n    class=\"app-switcher-dropdown-menu dropdown-menu\"\n    aria-labelledby=\"appSwitcherDropdown\"\n  >\n    <div class=\"app-switcher-sagcloud\" *ngIf=\"oneCloudApps && oneCloudApps.length > 0\">\n      <a\n        title=\"{{ app.name | humanizeAppName | async }}\"\n        class=\"appLink\"\n        *ngFor=\"let app of oneCloudApps\"\n        [href]=\"getHref(app)\"\n        c8yProductExperience\n        [actionName]=\"'appSwitched'\"\n        [actionData]=\"{ applicationName: app && app.name }\"\n      >\n        <c8y-app-icon [app]=\"app\" [name]=\"app.name\" [contextPath]=\"app.contextPath\"></c8y-app-icon>\n        <span class=\"text-truncate-wrap\">{{ app | humanizeAppName | async }}</span>\n      </a>\n    </div>\n    <div class=\"app-switcher\">\n      <a\n        title=\"{{ app.name | humanizeAppName | async }}\"\n        class=\"appLink\"\n        [ngClass]=\"isActive(app) ? 'active' : ''\"\n        *ngFor=\"let app of apps\"\n        [href]=\"getHref(app)\"\n        c8yProductExperience\n        [actionName]=\"'appSwitched'\"\n        [actionData]=\"{ applicationName: app && app.name }\"\n      >\n        <c8y-app-icon [app]=\"app\" [name]=\"app.name\" [contextPath]=\"app.contextPath\"></c8y-app-icon>\n        <span class=\"text-truncate-wrap\">{{ app | humanizeAppName | async }}</span>\n      </a>\n    </div>\n  </div>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.AppStateService }, { type: ɵngcc2.ApplicationService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLXN3aXRjaGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vY29yZS9oZWFkZXIvYXBwbGljYXRpb24vYXBwLXN3aXRjaGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsa0JBQWtCLEVBQXVDLE1BQU0sYUFBYSxDQUFDO0FBQ3RGLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUtoRSxNQUFNLE9BQU8sb0JBQW9CO0FBQ2pDLElBUUUsWUFBb0IsRUFBbUIsRUFBVSxZQUFnQztBQUNuRixRQURzQixPQUFFLEdBQUYsRUFBRSxDQUFpQjtBQUFDLFFBQVMsaUJBQVksR0FBWixZQUFZLENBQW9CO0FBQUMsUUFDaEYsTUFBTSxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQ25ELFFBQUksYUFBYSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUM7QUFDN0MsYUFBTyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDcEIsYUFBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFO0FBQ3BDLFlBQVEsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7QUFDN0IsWUFBUSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ25DLFFBQU0sQ0FBQyxDQUFDLENBQUM7QUFDVCxJQUFFLENBQUM7QUFDSCxJQWJFLElBQVksYUFBYTtBQUFLLFFBQzVCLE9BQU8sS0FBSyxDQUFDLENBQUMsMkNBQTJDO0FBQzdELElBQUUsQ0FBQztBQUNILElBV0UsUUFBUSxDQUFDLEdBQWlCO0FBQzVCLFFBQUksT0FBTyxHQUFHLENBQUMsV0FBVyxLQUFLLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7QUFDN0QsSUFBRSxDQUFDO0FBQ0gsSUFDRSxPQUFPLENBQUMsR0FBaUI7QUFDM0IsUUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFDLElBQUUsQ0FBQztBQUNILElBQ2dCLGVBQWUsQ0FBQyxJQUFrQjtBQUNsRDtBQUM4QyxZQUQxQyxJQUFJLElBQUksRUFBRTtBQUNkLGdCQUFNLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ3BGLGdCQUFNLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDeEQsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNVLFVBQVUsQ0FBQyxJQUFJO0FBQ3pCLFFBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEMsUUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNsQyxRQUFJLElBQUksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkMsUUFBSSxPQUFPLElBQUksQ0FBQztBQUNoQixJQUFFLENBQUM7QUFDSCxJQUNVLGFBQWEsQ0FBQyxJQUFJO0FBQzVCLFFBQUksTUFBTSx1QkFBdUIsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUMzRCxRQUFJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FDaEIsR0FBRyxDQUFDLEVBQUUsQ0FDSixRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQztBQUNuRCxZQUFRLENBQUMsR0FBRyxDQUFDLGFBQWE7QUFDMUIsWUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsd0JBQXdCLENBQUMsQ0FDdEMsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNILElBQ1UsV0FBVyxDQUFDLElBQUk7QUFDMUIsUUFBSSxNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ25DLFFBQUksTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQztBQUN4QyxRQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7QUFDeEIsWUFBTSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLFNBQUs7QUFDTCxRQUFJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDOUMsSUFBRSxDQUFDO0FBQ0gsSUFDVSxnQkFBZ0IsQ0FBQyxJQUFJO0FBQy9CLFFBQUksaUdBQWlHO0FBQ3JHLFFBQUksTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FDckIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNSLFFBQVEsQ0FBQyxFQUFFLENBQ1QsR0FBRyxLQUFLLFFBQVE7QUFDMUIsWUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDLFdBQVcsS0FBSyxRQUFRLENBQUMsV0FBVyxDQUFDO0FBQ3ZFLFlBQVUsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUMzQyxDQUFDO0FBQ1IsUUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakMsSUFBRSxDQUFDO0FBQ0gsSUFDVSxTQUFTLENBQUMsSUFBSTtBQUN4QixRQUFJLE9BQU8sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQzNELElBQUUsQ0FBQztBQUNIO2dEQS9FQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLGtCQUFrQixrQkFDNUI7Ozs7Ozs7Ozs7cUJBQTRDO01BQzdDO3dWQUNJO0FBQUM7QUFDVSxZQU5QLGVBQWU7QUFBSSxZQUpuQixrQkFBa0I7QUFBRzs7Ozs7OztxSEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIElBcHBsaWNhdGlvbiwgSUN1cnJlbnRUZW5hbnQsIElVc2VyIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0LCBpbmNsdWRlcywgb3JkZXJCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaXJzdCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcFN0YXRlU2VydmljZSB9IGZyb20gJy4uLy4uL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlJztcbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hcHAtc3dpdGNoZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vYXBwLXN3aXRjaGVyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBTd2l0Y2hlckNvbXBvbmVudCB7XG4gIG9uZUNsb3VkQXBwcz86IEFycmF5PElBcHBsaWNhdGlvbiAmIHsgW2tleTogc3RyaW5nXTogYW55IH0+O1xuICBhcHBzOiBBcnJheTxJQXBwbGljYXRpb24gJiB7IFtrZXk6IHN0cmluZ106IGFueSB9PjtcbiAgb3BlbjogYm9vbGVhbjtcblxuICBwcml2YXRlIGdldCBoaWRlQ2xvdWRBcHBzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBmYWxzZTsgLy8gdGhpcyBzaG91bGQgYmUgY29uZmlndXJhYmxlIGZyb20gb3V0c2lkZVxuICB9XG4gIHByaXZhdGUgdGVuYW50OiBJQ3VycmVudFRlbmFudDtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB1aTogQXBwU3RhdGVTZXJ2aWNlLCBwcml2YXRlIGFwcGxpY2F0aW9uczogQXBwbGljYXRpb25TZXJ2aWNlKSB7XG4gICAgY29uc3QgeyBjdXJyZW50VXNlciwgY3VycmVudFRlbmFudCB9ID0gdGhpcy51aTtcbiAgICBjb21iaW5lTGF0ZXN0KGN1cnJlbnRVc2VyLCBjdXJyZW50VGVuYW50KVxuICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFt1c2VyLCB0ZW5hbnRdKSA9PiB7XG4gICAgICAgIHRoaXMudGVuYW50ID0gdGVuYW50O1xuICAgICAgICB0aGlzLmxpc3RBcHBzRm9yVXNlcih1c2VyKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaXNBY3RpdmUoYXBwOiBJQXBwbGljYXRpb24pIHtcbiAgICByZXR1cm4gYXBwLmNvbnRleHRQYXRoID09PSB0aGlzLnVpLnN0YXRlLmFwcC5jb250ZXh0UGF0aDtcbiAgfVxuXG4gIGdldEhyZWYoYXBwOiBJQXBwbGljYXRpb24pIHtcbiAgICByZXR1cm4gdGhpcy5hcHBsaWNhdGlvbnMuZ2V0SHJlZihhcHApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsaXN0QXBwc0ZvclVzZXIodXNlcjogSVVzZXIgfCBudWxsKSB7XG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvbnMubGlzdEJ5VXNlcih1c2VyLCB7IHBhZ2VTaXplOiAxMDAwIH0pO1xuICAgICAgdGhpcy5hcHBzID0gdGhpcy5vcmRlckFwcHModGhpcy5maWx0ZXJBcHBzKGRhdGEpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpbHRlckFwcHMoYXBwcykge1xuICAgIGFwcHMgPSB0aGlzLmZpbHRlclZpc2libGUoYXBwcyk7XG4gICAgYXBwcyA9IHRoaXMuZmlsdGVyQ2xvdWQoYXBwcyk7XG4gICAgYXBwcyA9IHRoaXMuZmlsdGVyRHVwbGljYXRlcyhhcHBzKTtcbiAgICByZXR1cm4gYXBwcztcbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyVmlzaWJsZShhcHBzKSB7XG4gICAgY29uc3QgdmlzaWJsZUFwcGxpY2F0aW9uVHlwZXMgPSBbJ0hPU1RFRCcsICdFWFRFUk5BTCddO1xuICAgIHJldHVybiBhcHBzLmZpbHRlcihcbiAgICAgIGFwcCA9PlxuICAgICAgICBpbmNsdWRlcyh2aXNpYmxlQXBwbGljYXRpb25UeXBlcywgYXBwLnR5cGUpICYmXG4gICAgICAgICFhcHAubm9BcHBTd2l0Y2hlciAmJlxuICAgICAgICAhZ2V0KGFwcCwgJ21hbmlmZXN0Lm5vQXBwU3dpdGNoZXInKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGZpbHRlckNsb3VkKGFwcHMpIHtcbiAgICBjb25zdCB7IGhpZGVDbG91ZEFwcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgZmlsdGVyRm4gPSBhcHAgPT4gISFhcHAuY2xvdWQ7XG4gICAgaWYgKCFoaWRlQ2xvdWRBcHBzKSB7XG4gICAgICB0aGlzLm9uZUNsb3VkQXBwcyA9IHRoaXMub3JkZXJBcHBzKGFwcHMuZmlsdGVyKGZpbHRlckZuKSk7XG4gICAgfVxuICAgIHJldHVybiBhcHBzLmZpbHRlcihhcHAgPT4gIWZpbHRlckZuKGFwcCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBmaWx0ZXJEdXBsaWNhdGVzKGFwcHMpIHtcbiAgICAvLyBGaWx0ZXIgb3V0IGFwcHMgdGhhdCBoYXZlIGR1cGxpY2F0ZSBjb250ZXh0cGF0aHMgYW5kIGFyZSBub3Qgb3duIG93bmVkIGJ1dCB0aGUgY3VycmVudCB0ZW5hbnQ7XG4gICAgY29uc3QgZmlsdGVyRm4gPSBhcHAgPT5cbiAgICAgICFhcHBzLnNvbWUoXG4gICAgICAgIG90aGVyQXBwID0+XG4gICAgICAgICAgYXBwICE9PSBvdGhlckFwcCAmJlxuICAgICAgICAgIChhcHAuY29udGV4dFBhdGggJiYgYXBwLmNvbnRleHRQYXRoID09PSBvdGhlckFwcC5jb250ZXh0UGF0aCkgJiZcbiAgICAgICAgICBhcHAub3duZXIudGVuYW50LmlkICE9PSB0aGlzLnRlbmFudC5uYW1lXG4gICAgICApO1xuICAgIHJldHVybiBhcHBzLmZpbHRlcihmaWx0ZXJGbik7XG4gIH1cblxuICBwcml2YXRlIG9yZGVyQXBwcyhhcHBzKSB7XG4gICAgcmV0dXJuIG9yZGVyQnkoYXBwcywgKHsgbmFtZSB9KSA9PiBuYW1lLnRvTG93ZXJDYXNlKCkpO1xuICB9XG59XG4iXX0=