import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, MeasurementService } from '@c8y/client';
import { AppStateService, ColorService, MAX_PAGE_SIZE } from '@c8y/ngx-components';
import { get, sortBy, uniq } from 'lodash-es';
import { filter } from 'rxjs/operators';
import { DATAPOINT_LIBRARY_FRAGMENT } from './datapoint-selection.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/inventory/InventoryService";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "@c8y/client/lib/src/measurement/MeasurementService";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components';
export class DatapointLibraryService {
    constructor(inventory, appState, measurements, color) {
        this.inventory = inventory;
        this.appState = appState;
        this.measurements = measurements;
        this.color = color;
        this.appState.currentUser.pipe(filter(user => !user)).subscribe(() => {
            this.cache = undefined;
        });
    }
    getAllDatapointLibraryEntriesCached(forceCacheRenew = false) {
        return __awaiter(this, void 0, void 0, function* () {
            if (forceCacheRenew) {
                this.cache = undefined;
            }
            if (!this.cache) {
                this.cache = this.getAllDatapointLibraryEntries();
            }
            return this.cache;
        });
    }
    getFirstDatapointLibraryPage() {
        return __awaiter(this, void 0, void 0, function* () {
            const filterObj = {
                currentPage: 1,
                pageSize: 50,
                fragmentType: DATAPOINT_LIBRARY_FRAGMENT,
                withTotalPages: true
            };
            return (yield this.inventory.list(filterObj));
        });
    }
    getAllDatapointLibraryItemsCached() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.cache) {
                this.cache = this.getAllDatapointLibraryEntries();
            }
            const res = yield this.cache;
            return res.map(tmp => tmp[DATAPOINT_LIBRARY_FRAGMENT]);
        });
    }
    updateDatapoints(datapoints, skipUpdatingTarget = false) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!Array.isArray(datapoints)) {
                return datapoints;
            }
            const currentTargetsPromise = !skipUpdatingTarget ? this.getCurrentVersionOfTargetsFromDatapoints(datapoints) : Promise.resolve([]);
            const [currentTemplates, currentTargets] = yield Promise.all([
                this.getCurrentTemplatesFromDatapoints(datapoints),
                currentTargetsPromise
            ]);
            const currentTemplateVersions = currentTemplates
                .map(tmp => this.mapDatapointLibraryEntry(tmp))
                .filter(tmp => !!tmp);
            for (const datapoint of datapoints) {
                const { fragment, series, __active, __target, color, label, __template } = datapoint;
                const foundCurrentTemplateVersion = currentTemplateVersions.find(tmp => tmp.__template === datapoint.__template);
                if (foundCurrentTemplateVersion) {
                    Object.assign(datapoint, foundCurrentTemplateVersion);
                    Object.assign(datapoint, {
                        fragment,
                        series,
                        __active,
                        __target,
                        color,
                        label,
                        __template
                    });
                }
                const foundCurrentTarget = currentTargets.find(target => target.id === (__target === null || __target === void 0 ? void 0 : __target.id));
                if (foundCurrentTarget) {
                    const { id, name } = foundCurrentTarget;
                    datapoint.__target = { id, name };
                }
            }
            return datapoints;
        });
    }
    getDatapointsOfAsset(parentReference, ignoreDatapointTemplates) {
        return __awaiter(this, void 0, void 0, function* () {
            const [kpiResponse, details] = yield Promise.all([
                (ignoreDatapointTemplates
                    ? Promise.resolve(null)
                    : this.inventory.assetKPIsList(parentReference, { pageSize: MAX_PAGE_SIZE })),
                this.inventory.getMeasurementsAndSeries(parentReference)
            ]);
            const kpis = kpiResponse && kpiResponse.data ? kpiResponse.data : [];
            const sortedDetails = sortBy(details, ['fragment', 'series']);
            return yield this.combineFragmentSeriesTuplesWithDetails(sortedDetails, parentReference, kpis);
        });
    }
    /**
     * Requests the last measurement with the given fragment and series to extract it's unit.
     * If the source attribute is provided, it will check the last measurement for this specific source.
     * @returns found unit or an empty string instead
     */
    guessUnitOfDatapoint(fragment, series, source) {
        return __awaiter(this, void 0, void 0, function* () {
            const measurementfilter = {
                valueFragmentSeries: series,
                valueFragmentType: fragment,
                pageSize: 1,
                revert: true,
                dateFrom: '1970-01-01'
            };
            if (source === null || source === void 0 ? void 0 : source.id) {
                measurementfilter.source = source === null || source === void 0 ? void 0 : source.id;
            }
            try {
                const { data: lastMeasurements } = yield this.measurements.list(measurementfilter);
                const measurement = lastMeasurements[0];
                if (measurement) {
                    const pathToUnit = `${fragment}.${series}.unit`;
                    const unit = get(measurement, pathToUnit);
                    if ((unit === null || unit === void 0 ? void 0 : unit.length) && typeof unit === 'string') {
                        return unit;
                    }
                }
            }
            catch (_a) {
                // nothing to do
            }
            return '';
        });
    }
    combineFragmentSeriesTuplesWithDetails(tuples, target, kpis) {
        return __awaiter(this, void 0, void 0, function* () {
            const datapoints = tuples.map(tuple => {
                var _a;
                const foundDatapointLibraryEntry = kpis.find(kpi => kpi[DATAPOINT_LIBRARY_FRAGMENT] &&
                    kpi[DATAPOINT_LIBRARY_FRAGMENT].fragment === tuple.fragment &&
                    kpi[DATAPOINT_LIBRARY_FRAGMENT].series === tuple.series);
                const datapoint = this.mapDatapointLibraryEntry(foundDatapointLibraryEntry) || tuple;
                if (!datapoint.label) {
                    datapoint.label = `${datapoint.fragment} → ${datapoint.series}`;
                }
                if (!((_a = datapoint.unit) === null || _a === void 0 ? void 0 : _a.length)) {
                    datapoint.unit = '';
                }
                datapoint.__target = target;
                return datapoint;
            });
            yield this.assignColorToDatapoints(datapoints);
            return datapoints;
        });
    }
    assignColorToDatapoints(datapoints) {
        return __awaiter(this, void 0, void 0, function* () {
            const datapointsWithoutColor = datapoints.filter(datapoint => !datapoint.color);
            yield Promise.all(datapointsWithoutColor.map(datapoint => this.color.generateColorForDatapoint(datapoint.fragment, datapoint.series).then(color => (datapoint.color = color))));
        });
    }
    getAllDatapointLibraryEntries() {
        return __awaiter(this, void 0, void 0, function* () {
            const entries = new Array();
            const filterObj = {
                currentPage: 1,
                pageSize: MAX_PAGE_SIZE,
                fragmentType: DATAPOINT_LIBRARY_FRAGMENT
            };
            let res = yield this.inventory.list(filterObj);
            while (res.data.length) {
                entries.push(...res.data);
                if (res.data.length < res.paging.pageSize) {
                    break;
                }
                res = yield res.paging.next();
            }
            return entries;
        });
    }
    mapDatapointLibraryEntry(entry) {
        if (!entry || !entry[DATAPOINT_LIBRARY_FRAGMENT]) {
            return null;
        }
        const datapoint = entry[DATAPOINT_LIBRARY_FRAGMENT];
        datapoint.__template = entry.id;
        return datapoint;
    }
    getCurrentTemplatesFromDatapoints(datapoints) {
        return __awaiter(this, void 0, void 0, function* () {
            const datapointsWithTemplateId = datapoints.filter(dp => !!dp.__template);
            const usedTemplateIds = datapointsWithTemplateId.map(dp => dp.__template);
            return yield this.getMOsByIds(usedTemplateIds);
        });
    }
    getCurrentVersionOfTargetsFromDatapoints(datapoints) {
        return __awaiter(this, void 0, void 0, function* () {
            const datapointsWithTarget = datapoints.filter(dp => { var _a; return !!((_a = dp.__target) === null || _a === void 0 ? void 0 : _a.id); });
            const usedTargetIds = datapointsWithTarget.map(dp => dp.__target.id);
            return yield this.getMOsByIds(usedTargetIds);
        });
    }
    getMOsByIds(ids) {
        return __awaiter(this, void 0, void 0, function* () {
            const uniqManagedObjectIds = uniq(ids);
            if (!uniqManagedObjectIds.length) {
                return [];
            }
            try {
                const { data: managedObjects } = yield this.inventory.list({
                    ids: uniqManagedObjectIds.join(),
                    pageSize: MAX_PAGE_SIZE
                });
                return managedObjects;
            }
            catch (_a) {
                // Fail silently in case we are not able to talk to the inventory API.
                // Should only be reached in case of an server side error.
                // instead of failing, pretend like we didn't receive any items.
                console.warn(`Failed to get the current version of the following managedObjects: ${uniqManagedObjectIds.join()}.`);
                return [];
            }
        });
    }
}
DatapointLibraryService.ɵfac = function DatapointLibraryService_Factory(t) { return new (t || DatapointLibraryService)(ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc2.AppStateService), ɵngcc0.ɵɵinject(ɵngcc1.MeasurementService), ɵngcc0.ɵɵinject(ɵngcc2.ColorService)); };
DatapointLibraryService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DatapointLibraryService_Factory() { return new DatapointLibraryService(i0.ɵɵinject(i1.InventoryService), i0.ɵɵinject(i2.AppStateService), i0.ɵɵinject(i3.MeasurementService), i0.ɵɵinject(i2.ColorService)); }, token: DatapointLibraryService, providedIn: "root" });
DatapointLibraryService.ctorParameters = () => [
    { type: InventoryService },
    { type: AppStateService },
    { type: MeasurementService },
    { type: ColorService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DatapointLibraryService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc1.InventoryService }, { type: ɵngcc2.AppStateService }, { type: ɵngcc1.MeasurementService }, { type: ɵngcc2.ColorService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXBvaW50LWxpYnJhcnkuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGF0YXBvaW50LXNlbGVjdG9yL2RhdGFwb2ludC1saWJyYXJ5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUdMLGdCQUFnQixFQUVoQixrQkFBa0IsRUFDbkIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkYsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQ0wsMEJBQTBCLEVBRzNCLE1BQU0sNkJBQTZCLENBQUM7QUFDckM7QUFFQTtBQUMrQjtBQUVwQjs7OztBQUhYLE1BQU0sT0FBTyx1QkFBdUI7QUFDcEMsSUFDRSxZQUNVLFNBQTJCLEVBQzNCLFFBQXlCLEVBQ3pCLFlBQWdDLEVBQ2hDLEtBQW1CO0FBQzVCLFFBSlMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7QUFBQyxRQUM1QixhQUFRLEdBQVIsUUFBUSxDQUFpQjtBQUFDLFFBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFvQjtBQUFDLFFBQ2pDLFVBQUssR0FBTCxLQUFLLENBQWM7QUFDL0IsUUFDSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7QUFDekUsWUFBTSxJQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQztBQUM3QixRQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ1AsSUFBRSxDQUFDO0FB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RUFBRSxhQUFhO0FBQy9CLGlCQUFPLENBQUMsQ0FBQztBQUNULGdCQUFNLE9BQU8sY0FBYyxDQUFDO0FBQzVCLGFBQUs7QUFBQyxZQUFBLFdBQU07QUFDWixnQkFBTSxzRUFBc0U7QUFDNUUsZ0JBQU0sMERBQTBEO0FBQ2hFLGdCQUFNLGdFQUFnRTtBQUN0RSxnQkFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLHNFQUFzRSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDekgsZ0JBQU0sT0FBTyxFQUFFLENBQUM7QUFDaEIsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVILEtBRkc7QUFDSDsrUkFBQztBQUNELGdWQTFPSztBQUFDO0VBREwsVUFBVSxTQUFDLEVBQUUsdkJBRUUsWUFmZCxnQkFBZ0I7Q0FhTSxFQUFFLE1BQU0sRUFBRSxYQVpoQyxZQUdPLGVBQWU7QUFBSSxZQUYxQixrQkFBa0I7QUFDakIsWUFDdUIsWUFBWTtBQUFHOzs7O3VMQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBJSWRlbnRpZmllZCxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElSZXN1bHRMaXN0LFxuICBNZWFzdXJlbWVudFNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlLCBDb2xvclNlcnZpY2UsIE1BWF9QQUdFX1NJWkUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGdldCwgc29ydEJ5LCB1bmlxIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIERBVEFQT0lOVF9MSUJSQVJZX0ZSQUdNRU5ULFxuICBLUElEZXRhaWxzLFxuICBNYW5hZ2VkT2JqZWN0S1BJXG59IGZyb20gJy4vZGF0YXBvaW50LXNlbGVjdGlvbi5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRGF0YXBvaW50TGlicmFyeVNlcnZpY2Uge1xuICBwcm90ZWN0ZWQgY2FjaGU6IFByb21pc2U8TWFuYWdlZE9iamVjdEtQSVtdPjtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBTdGF0ZTogQXBwU3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgbWVhc3VyZW1lbnRzOiBNZWFzdXJlbWVudFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb2xvcjogQ29sb3JTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuYXBwU3RhdGUuY3VycmVudFVzZXIucGlwZShmaWx0ZXIodXNlciA9PiAhdXNlcikpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmNhY2hlID0gdW5kZWZpbmVkO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWxsRGF0YXBvaW50TGlicmFyeUVudHJpZXNDYWNoZWQoZm9yY2VDYWNoZVJlbmV3ID0gZmFsc2UpOiBQcm9taXNlPE1hbmFnZWRPYmplY3RLUElbXT4ge1xuICAgIGlmIChmb3JjZUNhY2hlUmVuZXcpIHtcbiAgICAgIHRoaXMuY2FjaGUgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmICghdGhpcy5jYWNoZSkge1xuICAgICAgdGhpcy5jYWNoZSA9IHRoaXMuZ2V0QWxsRGF0YXBvaW50TGlicmFyeUVudHJpZXMoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY2FjaGU7XG4gIH1cblxuICBhc3luYyBnZXRGaXJzdERhdGFwb2ludExpYnJhcnlQYWdlKCk6IFByb21pc2U8SVJlc3VsdExpc3Q8TWFuYWdlZE9iamVjdEtQST4+IHtcbiAgICBjb25zdCBmaWx0ZXJPYmogPSB7XG4gICAgICBjdXJyZW50UGFnZTogMSxcbiAgICAgIHBhZ2VTaXplOiA1MCxcbiAgICAgIGZyYWdtZW50VHlwZTogREFUQVBPSU5UX0xJQlJBUllfRlJBR01FTlQsXG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgIH07XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmludmVudG9yeS5saXN0KGZpbHRlck9iaikpIGFzIElSZXN1bHRMaXN0PE1hbmFnZWRPYmplY3RLUEk+O1xuICB9XG5cbiAgYXN5bmMgZ2V0QWxsRGF0YXBvaW50TGlicmFyeUl0ZW1zQ2FjaGVkKCk6IFByb21pc2U8S1BJRGV0YWlsc1tdPiB7XG4gICAgaWYgKCF0aGlzLmNhY2hlKSB7XG4gICAgICB0aGlzLmNhY2hlID0gdGhpcy5nZXRBbGxEYXRhcG9pbnRMaWJyYXJ5RW50cmllcygpO1xuICAgIH1cbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNhY2hlO1xuICAgIHJldHVybiByZXMubWFwKHRtcCA9PiB0bXBbREFUQVBPSU5UX0xJQlJBUllfRlJBR01FTlRdKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZURhdGFwb2ludHMoZGF0YXBvaW50czogS1BJRGV0YWlsc1tdLCBza2lwVXBkYXRpbmdUYXJnZXQgPSBmYWxzZSk6IFByb21pc2U8S1BJRGV0YWlsc1tdPiB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGFwb2ludHMpKSB7XG4gICAgICByZXR1cm4gZGF0YXBvaW50cztcbiAgICB9XG4gICAgY29uc3QgY3VycmVudFRhcmdldHNQcm9taXNlOiBQcm9taXNlPElNYW5hZ2VkT2JqZWN0W10+ID0gIXNraXBVcGRhdGluZ1RhcmdldCA/IHRoaXMuZ2V0Q3VycmVudFZlcnNpb25PZlRhcmdldHNGcm9tRGF0YXBvaW50cyhkYXRhcG9pbnRzKSA6IFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgY29uc3QgW2N1cnJlbnRUZW1wbGF0ZXMsIGN1cnJlbnRUYXJnZXRzIF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLmdldEN1cnJlbnRUZW1wbGF0ZXNGcm9tRGF0YXBvaW50cyhkYXRhcG9pbnRzKSxcbiAgICAgIGN1cnJlbnRUYXJnZXRzUHJvbWlzZVxuICAgIF0pO1xuICAgIGNvbnN0IGN1cnJlbnRUZW1wbGF0ZVZlcnNpb25zID0gY3VycmVudFRlbXBsYXRlc1xuICAgICAgLm1hcCh0bXAgPT4gdGhpcy5tYXBEYXRhcG9pbnRMaWJyYXJ5RW50cnkodG1wIGFzIE1hbmFnZWRPYmplY3RLUEkpKVxuICAgICAgLmZpbHRlcih0bXAgPT4gISF0bXApO1xuICAgIGZvciAoY29uc3QgZGF0YXBvaW50IG9mIGRhdGFwb2ludHMpIHtcbiAgICAgIGNvbnN0IHsgZnJhZ21lbnQsIHNlcmllcywgX19hY3RpdmUsIF9fdGFyZ2V0LCBjb2xvciwgbGFiZWwsIF9fdGVtcGxhdGUgfSA9IGRhdGFwb2ludDtcbiAgICAgIGNvbnN0IGZvdW5kQ3VycmVudFRlbXBsYXRlVmVyc2lvbiA9IGN1cnJlbnRUZW1wbGF0ZVZlcnNpb25zLmZpbmQoXG4gICAgICAgIHRtcCA9PiB0bXAuX190ZW1wbGF0ZSA9PT0gZGF0YXBvaW50Ll9fdGVtcGxhdGVcbiAgICAgICk7XG4gICAgICBpZiAoZm91bmRDdXJyZW50VGVtcGxhdGVWZXJzaW9uKSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZGF0YXBvaW50LCBmb3VuZEN1cnJlbnRUZW1wbGF0ZVZlcnNpb24pO1xuICAgICAgICBPYmplY3QuYXNzaWduKGRhdGFwb2ludCwge1xuICAgICAgICAgIGZyYWdtZW50LFxuICAgICAgICAgIHNlcmllcyxcbiAgICAgICAgICBfX2FjdGl2ZSxcbiAgICAgICAgICBfX3RhcmdldCxcbiAgICAgICAgICBjb2xvcixcbiAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICBfX3RlbXBsYXRlXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmb3VuZEN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0cy5maW5kKHRhcmdldCA9PiB0YXJnZXQuaWQgPT09IF9fdGFyZ2V0Py5pZCk7XG4gICAgICBpZiAoZm91bmRDdXJyZW50VGFyZ2V0KSB7XG4gICAgICAgIGNvbnN0IHsgaWQsIG5hbWUgfSA9IGZvdW5kQ3VycmVudFRhcmdldDtcbiAgICAgICAgZGF0YXBvaW50Ll9fdGFyZ2V0ID0geyBpZCwgbmFtZSB9O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGF0YXBvaW50cztcbiAgfVxuXG4gIGFzeW5jIGdldERhdGFwb2ludHNPZkFzc2V0KFxuICAgIHBhcmVudFJlZmVyZW5jZTogSUlkZW50aWZpZWQsXG4gICAgaWdub3JlRGF0YXBvaW50VGVtcGxhdGVzPzogYm9vbGVhblxuICApOiBQcm9taXNlPEtQSURldGFpbHNbXT4ge1xuICAgIGNvbnN0IFtrcGlSZXNwb25zZSwgZGV0YWlsc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAoaWdub3JlRGF0YXBvaW50VGVtcGxhdGVzXG4gICAgICAgID8gUHJvbWlzZS5yZXNvbHZlKG51bGwpXG4gICAgICAgIDogdGhpcy5pbnZlbnRvcnkuYXNzZXRLUElzTGlzdChwYXJlbnRSZWZlcmVuY2UsIHsgcGFnZVNpemU6IE1BWF9QQUdFX1NJWkUgfSkpIGFzIFByb21pc2U8XG4gICAgICAgIElSZXN1bHRMaXN0PE1hbmFnZWRPYmplY3RLUEk+XG4gICAgICA+LFxuICAgICAgdGhpcy5pbnZlbnRvcnkuZ2V0TWVhc3VyZW1lbnRzQW5kU2VyaWVzKHBhcmVudFJlZmVyZW5jZSlcbiAgICBdKTtcbiAgICBjb25zdCBrcGlzID0ga3BpUmVzcG9uc2UgJiYga3BpUmVzcG9uc2UuZGF0YSA/IGtwaVJlc3BvbnNlLmRhdGEgOiBbXTtcbiAgICBjb25zdCBzb3J0ZWREZXRhaWxzID0gc29ydEJ5KGRldGFpbHMsIFsnZnJhZ21lbnQnLCAnc2VyaWVzJ10pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY29tYmluZUZyYWdtZW50U2VyaWVzVHVwbGVzV2l0aERldGFpbHMoc29ydGVkRGV0YWlscywgcGFyZW50UmVmZXJlbmNlLCBrcGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0cyB0aGUgbGFzdCBtZWFzdXJlbWVudCB3aXRoIHRoZSBnaXZlbiBmcmFnbWVudCBhbmQgc2VyaWVzIHRvIGV4dHJhY3QgaXQncyB1bml0LlxuICAgKiBJZiB0aGUgc291cmNlIGF0dHJpYnV0ZSBpcyBwcm92aWRlZCwgaXQgd2lsbCBjaGVjayB0aGUgbGFzdCBtZWFzdXJlbWVudCBmb3IgdGhpcyBzcGVjaWZpYyBzb3VyY2UuXG4gICAqIEByZXR1cm5zIGZvdW5kIHVuaXQgb3IgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWRcbiAgICovXG4gIGFzeW5jIGd1ZXNzVW5pdE9mRGF0YXBvaW50KFxuICAgIGZyYWdtZW50OiBzdHJpbmcsXG4gICAgc2VyaWVzOiBzdHJpbmcsXG4gICAgc291cmNlPzogSUlkZW50aWZpZWRcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBtZWFzdXJlbWVudGZpbHRlcjogYW55ID0ge1xuICAgICAgdmFsdWVGcmFnbWVudFNlcmllczogc2VyaWVzLFxuICAgICAgdmFsdWVGcmFnbWVudFR5cGU6IGZyYWdtZW50LFxuICAgICAgcGFnZVNpemU6IDEsXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBkYXRlRnJvbTogJzE5NzAtMDEtMDEnXG4gICAgfTtcbiAgICBpZiAoc291cmNlPy5pZCkge1xuICAgICAgbWVhc3VyZW1lbnRmaWx0ZXIuc291cmNlID0gc291cmNlPy5pZDtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YTogbGFzdE1lYXN1cmVtZW50cyB9ID0gYXdhaXQgdGhpcy5tZWFzdXJlbWVudHMubGlzdChtZWFzdXJlbWVudGZpbHRlcik7XG4gICAgICBjb25zdCBtZWFzdXJlbWVudCA9IGxhc3RNZWFzdXJlbWVudHNbMF07XG4gICAgICBpZiAobWVhc3VyZW1lbnQpIHtcbiAgICAgICAgY29uc3QgcGF0aFRvVW5pdCA9IGAke2ZyYWdtZW50fS4ke3Nlcmllc30udW5pdGA7XG4gICAgICAgIGNvbnN0IHVuaXQgPSBnZXQobWVhc3VyZW1lbnQsIHBhdGhUb1VuaXQpO1xuICAgICAgICBpZiAodW5pdD8ubGVuZ3RoICYmIHR5cGVvZiB1bml0ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHJldHVybiB1bml0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBub3RoaW5nIHRvIGRvXG4gICAgfVxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBjb21iaW5lRnJhZ21lbnRTZXJpZXNUdXBsZXNXaXRoRGV0YWlscyhcbiAgICB0dXBsZXM6IEFycmF5PHsgZnJhZ21lbnQ6IHN0cmluZzsgc2VyaWVzOiBzdHJpbmcgfT4sXG4gICAgdGFyZ2V0OiBJSWRlbnRpZmllZCxcbiAgICBrcGlzOiBNYW5hZ2VkT2JqZWN0S1BJW11cbiAgKSB7XG4gICAgY29uc3QgZGF0YXBvaW50cyA9IHR1cGxlcy5tYXAodHVwbGUgPT4ge1xuICAgICAgY29uc3QgZm91bmREYXRhcG9pbnRMaWJyYXJ5RW50cnkgPSBrcGlzLmZpbmQoXG4gICAgICAgIGtwaSA9PlxuICAgICAgICAgIGtwaVtEQVRBUE9JTlRfTElCUkFSWV9GUkFHTUVOVF0gJiZcbiAgICAgICAgICBrcGlbREFUQVBPSU5UX0xJQlJBUllfRlJBR01FTlRdLmZyYWdtZW50ID09PSB0dXBsZS5mcmFnbWVudCAmJlxuICAgICAgICAgIGtwaVtEQVRBUE9JTlRfTElCUkFSWV9GUkFHTUVOVF0uc2VyaWVzID09PSB0dXBsZS5zZXJpZXNcbiAgICAgICk7XG4gICAgICBjb25zdCBkYXRhcG9pbnQ6IEtQSURldGFpbHMgPVxuICAgICAgICB0aGlzLm1hcERhdGFwb2ludExpYnJhcnlFbnRyeShmb3VuZERhdGFwb2ludExpYnJhcnlFbnRyeSkgfHwgdHVwbGU7XG4gICAgICBpZiAoIWRhdGFwb2ludC5sYWJlbCkge1xuICAgICAgICBkYXRhcG9pbnQubGFiZWwgPSBgJHtkYXRhcG9pbnQuZnJhZ21lbnR9IOKGkiAke2RhdGFwb2ludC5zZXJpZXN9YDtcbiAgICAgIH1cbiAgICAgIGlmICghZGF0YXBvaW50LnVuaXQ/Lmxlbmd0aCkge1xuICAgICAgICBkYXRhcG9pbnQudW5pdCA9ICcnO1xuICAgICAgfVxuICAgICAgZGF0YXBvaW50Ll9fdGFyZ2V0ID0gdGFyZ2V0O1xuICAgICAgcmV0dXJuIGRhdGFwb2ludDtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmFzc2lnbkNvbG9yVG9EYXRhcG9pbnRzKGRhdGFwb2ludHMpO1xuICAgIHJldHVybiBkYXRhcG9pbnRzO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIGFzc2lnbkNvbG9yVG9EYXRhcG9pbnRzKGRhdGFwb2ludHM6IEtQSURldGFpbHNbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGRhdGFwb2ludHNXaXRob3V0Q29sb3IgPSBkYXRhcG9pbnRzLmZpbHRlcihkYXRhcG9pbnQgPT4gIWRhdGFwb2ludC5jb2xvcik7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBkYXRhcG9pbnRzV2l0aG91dENvbG9yLm1hcChkYXRhcG9pbnQgPT5cbiAgICAgICAgdGhpcy5jb2xvci5nZW5lcmF0ZUNvbG9yRm9yRGF0YXBvaW50KGRhdGFwb2ludC5mcmFnbWVudCwgZGF0YXBvaW50LnNlcmllcykudGhlbihjb2xvciA9PiAoZGF0YXBvaW50LmNvbG9yID0gY29sb3IpKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0QWxsRGF0YXBvaW50TGlicmFyeUVudHJpZXMoKTogUHJvbWlzZTxNYW5hZ2VkT2JqZWN0S1BJW10+IHtcbiAgICBjb25zdCBlbnRyaWVzID0gbmV3IEFycmF5PE1hbmFnZWRPYmplY3RLUEk+KCk7XG4gICAgY29uc3QgZmlsdGVyT2JqID0ge1xuICAgICAgY3VycmVudFBhZ2U6IDEsXG4gICAgICBwYWdlU2l6ZTogTUFYX1BBR0VfU0laRSxcbiAgICAgIGZyYWdtZW50VHlwZTogREFUQVBPSU5UX0xJQlJBUllfRlJBR01FTlRcbiAgICB9O1xuICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLmludmVudG9yeS5saXN0KGZpbHRlck9iaik7XG4gICAgd2hpbGUgKHJlcy5kYXRhLmxlbmd0aCkge1xuICAgICAgZW50cmllcy5wdXNoKC4uLihyZXMuZGF0YSBhcyBNYW5hZ2VkT2JqZWN0S1BJW10pKTtcbiAgICAgIGlmIChyZXMuZGF0YS5sZW5ndGggPCByZXMucGFnaW5nLnBhZ2VTaXplKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgcmVzID0gYXdhaXQgcmVzLnBhZ2luZy5uZXh0KCk7XG4gICAgfVxuICAgIHJldHVybiBlbnRyaWVzO1xuICB9XG5cbiAgcHJvdGVjdGVkIG1hcERhdGFwb2ludExpYnJhcnlFbnRyeShlbnRyeTogTWFuYWdlZE9iamVjdEtQSSk6IEtQSURldGFpbHMge1xuICAgIGlmICghZW50cnkgfHwgIWVudHJ5W0RBVEFQT0lOVF9MSUJSQVJZX0ZSQUdNRU5UXSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YXBvaW50ID0gZW50cnlbREFUQVBPSU5UX0xJQlJBUllfRlJBR01FTlRdO1xuICAgIGRhdGFwb2ludC5fX3RlbXBsYXRlID0gZW50cnkuaWQ7XG4gICAgcmV0dXJuIGRhdGFwb2ludDtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBnZXRDdXJyZW50VGVtcGxhdGVzRnJvbURhdGFwb2ludHMoXG4gICAgZGF0YXBvaW50czogS1BJRGV0YWlsc1tdXG4gICk6IFByb21pc2U8SU1hbmFnZWRPYmplY3RbXT4ge1xuICAgIGNvbnN0IGRhdGFwb2ludHNXaXRoVGVtcGxhdGVJZCA9IGRhdGFwb2ludHMuZmlsdGVyKGRwID0+ICEhZHAuX190ZW1wbGF0ZSk7XG4gICAgY29uc3QgdXNlZFRlbXBsYXRlSWRzID0gZGF0YXBvaW50c1dpdGhUZW1wbGF0ZUlkLm1hcChkcCA9PiBkcC5fX3RlbXBsYXRlKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRNT3NCeUlkcyh1c2VkVGVtcGxhdGVJZHMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIGdldEN1cnJlbnRWZXJzaW9uT2ZUYXJnZXRzRnJvbURhdGFwb2ludHMoXG4gICAgZGF0YXBvaW50czogS1BJRGV0YWlsc1tdXG4gICk6IFByb21pc2U8SU1hbmFnZWRPYmplY3RbXT4ge1xuICAgIGNvbnN0IGRhdGFwb2ludHNXaXRoVGFyZ2V0ID0gZGF0YXBvaW50cy5maWx0ZXIoZHAgPT4gISFkcC5fX3RhcmdldD8uaWQpO1xuICAgIGNvbnN0IHVzZWRUYXJnZXRJZHMgPSBkYXRhcG9pbnRzV2l0aFRhcmdldC5tYXAoZHAgPT4gZHAuX190YXJnZXQuaWQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE1Pc0J5SWRzKHVzZWRUYXJnZXRJZHMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIGdldE1Pc0J5SWRzKGlkczogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPik6IFByb21pc2U8SU1hbmFnZWRPYmplY3RbXT4ge1xuICAgIGNvbnN0IHVuaXFNYW5hZ2VkT2JqZWN0SWRzID0gdW5pcShpZHMpO1xuICAgIGlmICghdW5pcU1hbmFnZWRPYmplY3RJZHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGE6IG1hbmFnZWRPYmplY3RzIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeS5saXN0KHtcbiAgICAgICAgaWRzOiB1bmlxTWFuYWdlZE9iamVjdElkcy5qb2luKCksXG4gICAgICAgIHBhZ2VTaXplOiBNQVhfUEFHRV9TSVpFXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBtYW5hZ2VkT2JqZWN0cztcbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIEZhaWwgc2lsZW50bHkgaW4gY2FzZSB3ZSBhcmUgbm90IGFibGUgdG8gdGFsayB0byB0aGUgaW52ZW50b3J5IEFQSS5cbiAgICAgIC8vIFNob3VsZCBvbmx5IGJlIHJlYWNoZWQgaW4gY2FzZSBvZiBhbiBzZXJ2ZXIgc2lkZSBlcnJvci5cbiAgICAgIC8vIGluc3RlYWQgb2YgZmFpbGluZywgcHJldGVuZCBsaWtlIHdlIGRpZG4ndCByZWNlaXZlIGFueSBpdGVtcy5cbiAgICAgIGNvbnNvbGUud2FybihgRmFpbGVkIHRvIGdldCB0aGUgY3VycmVudCB2ZXJzaW9uIG9mIHRoZSBmb2xsb3dpbmcgbWFuYWdlZE9iamVjdHM6ICR7dW5pcU1hbmFnZWRPYmplY3RJZHMuam9pbigpfS5gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==