import { __awaiter } from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ApplicationService } from '@c8y/client';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { distinctUntilKeyChanged, map, tap } from 'rxjs/operators';
import { APP_STATE } from '../../../ecosystem.constants';
import { EcosystemService } from '../../../ecosystem.service';
import { ApplicationPropertiesFormComponent } from '../../../shared/application-properties-form.component';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-bootstrap/modal';
import * as ɵngcc2 from '../../../ecosystem.service';
import * as ɵngcc3 from '@c8y/client';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from '@c8y/ngx-components';
import * as ɵngcc6 from '../../../shared/application-properties-form.component';
import * as ɵngcc7 from '@angular/forms';

function DuplicateApplicationPropertiesComponent_p_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "p", 6);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(2, 1, "Provide application details"), "\n");
} }
function DuplicateApplicationPropertiesComponent_ng_container_1_label_1_Template(rf, ctx) { if (rf & 1) {
    const _r6 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "label", 9);
    ɵngcc0.ɵɵelementStart(1, "input", 10);
    ɵngcc0.ɵɵlistener("ngModelChange", function DuplicateApplicationPropertiesComponent_ng_container_1_label_1_Template_input_ngModelChange_1_listener($event) { ɵngcc0.ɵɵrestoreView(_r6); const ctx_r5 = ɵngcc0.ɵɵnextContext(2); return ctx_r5.disableForm = $event; })("change", function DuplicateApplicationPropertiesComponent_ng_container_1_label_1_Template_input_change_1_listener() { ɵngcc0.ɵɵrestoreView(_r6); const ctx_r7 = ɵngcc0.ɵɵnextContext(2); return ctx_r7.getAppConfig(); });
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelement(2, "span");
    ɵngcc0.ɵɵtext(3);
    ɵngcc0.ɵɵpipe(4, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r4 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngModel", ctx_r4.disableForm);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(4, 2, "Overrule subscribed application"), " ");
} }
function DuplicateApplicationPropertiesComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, DuplicateApplicationPropertiesComponent_ng_container_1_label_1_Template, 5, 4, "label", 7);
    ɵngcc0.ɵɵpipe(2, "async");
    ɵngcc0.ɵɵelement(3, "c8y-application-properties-form", 8);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ɵngcc0.ɵɵpipeBind1(2, 3, ctx_r1.isSubscribedApp$));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("application", ctx_r1.newAppConfig)("disabled", ctx_r1.disableForm);
} }
function DuplicateApplicationPropertiesComponent_c8y_progress_bar_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-progress-bar", 11);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵproperty("message", ɵngcc0.ɵɵpipeBind1(1, 1, "Duplicating\u2026"));
} }
function DuplicateApplicationPropertiesComponent_button_4_Template(rf, ctx) { if (rf & 1) {
    const _r9 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 12);
    ɵngcc0.ɵɵlistener("click", function DuplicateApplicationPropertiesComponent_button_4_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r9); const ctx_r8 = ɵngcc0.ɵɵnextContext(); return ctx_r8.back(); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 3, "Back"));
    ɵngcc0.ɵɵproperty("disabled", ctx_r3.inProgress);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(3, 5, "Back"), " ");
} }
export class DuplicateApplicationPropertiesComponent {
    constructor(bsModalRef, ecosystemService, applicationService) {
        this.bsModalRef = bsModalRef;
        this.ecosystemService = ecosystemService;
        this.applicationService = applicationService;
        this.isFirstStep = false;
        this.duplicatedApp = new EventEmitter();
        this.disableForm = false;
        this.inProgress = false;
    }
    ngOnInit() {
        this.isSubscribedApp$ = this.selectedApp.pipe(distinctUntilKeyChanged('id'), map(app => (app ? this.ecosystemService.getAppState(app) === APP_STATE.SUBSCRIBED : true)), tap(isSubscribed => {
            this.disableForm = isSubscribed;
            this.getAppConfig();
        }));
        this.getAppConfig();
    }
    duplicateApp() {
        return __awaiter(this, void 0, void 0, function* () {
            const formGroupValue = this.applicationPropertiesForm.formGroup.getRawValue();
            this.inProgress = true;
            const clonedApp = (yield this.applicationService.clone(this.selectedApp.value)).data;
            Object.assign(clonedApp, formGroupValue);
            delete clonedApp.type;
            yield this.updateApp(clonedApp);
            this.inProgress = false;
        });
    }
    cancel() {
        this.bsModalRef.hide();
    }
    back() {
        this.stepper.previous();
    }
    getAppConfig() {
        if (this.disableForm) {
            const { name, key, contextPath } = this.selectedApp.value;
            this.newAppConfig = { name, key, contextPath };
        }
        else {
            this.newAppConfig = this.ecosystemService.getUniqueAppConfig(this.selectedApp.value, this.existingApps);
        }
    }
    updateApp(clonedAppConfig) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { data: app } = yield this.ecosystemService.updateApp(clonedAppConfig, true);
                const manifest = yield this.getAppManifest(app);
                if (manifest) {
                    yield this.updateManifest(app, manifest);
                }
                this.duplicatedApp.emit(app);
                this.stepper.next();
            }
            catch (err) {
                this.inProgress = false;
            }
        });
    }
    updateManifest(app, manifest) {
        return __awaiter(this, void 0, void 0, function* () {
            const keysToUpdate = ['name', 'key', 'contextPath'];
            const someKeyDiffers = keysToUpdate.some(key => app[key] !== manifest[key]);
            if (someKeyDiffers) {
                keysToUpdate.forEach(key => {
                    manifest[key] = app[key];
                });
                yield this.applicationService.storeAppManifest(app, manifest);
            }
        });
    }
    getAppManifest(app) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!(app === null || app === void 0 ? void 0 : app.contextPath)) {
                return;
            }
            try {
                const manifest = yield this.applicationService.getAppManifest(app);
                return manifest;
            }
            catch (ex) {
                return;
            }
        });
    }
}
DuplicateApplicationPropertiesComponent.ɵfac = function DuplicateApplicationPropertiesComponent_Factory(t) { return new (t || DuplicateApplicationPropertiesComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BsModalRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.EcosystemService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.ApplicationService)); };
DuplicateApplicationPropertiesComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: DuplicateApplicationPropertiesComponent, selectors: [["c8y-duplicate-application-properties"]], viewQuery: function DuplicateApplicationPropertiesComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(ApplicationPropertiesFormComponent, 5);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.applicationPropertiesForm = _t.first);
    } }, inputs: { isFirstStep: "isFirstStep", stepper: "stepper", existingApps: "existingApps", selectedApp: "selectedApp" }, outputs: { duplicatedApp: "duplicatedApp" }, decls: 13, vars: 17, consts: [["class", "p-16 text-center text-medium separator-bottom sticky-top bg-white fit-w", 4, "ngIf"], [4, "ngIf"], ["class", "text-center d-block", 3, "message", 4, "ngIf"], ["class", "btn btn-default", "type", "button", 3, "disabled", "title", "click", 4, "ngIf"], [1, "btn", "btn-default", 3, "title", "click"], ["type", "button", 1, "btn", "btn-primary", 3, "disabled", "title", "click"], [1, "p-16", "text-center", "text-medium", "separator-bottom", "sticky-top", "bg-white", "fit-w"], ["class", "c8y-switch", 4, "ngIf"], [1, "d-block", "fit-w", 3, "application", "disabled"], [1, "c8y-switch"], ["type", "checkbox", 3, "ngModel", "ngModelChange", "change"], [1, "text-center", "d-block", 3, "message"], ["type", "button", 1, "btn", "btn-default", 3, "disabled", "title", "click"]], template: function DuplicateApplicationPropertiesComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, DuplicateApplicationPropertiesComponent_p_0_Template, 3, 3, "p", 0);
        ɵngcc0.ɵɵtemplate(1, DuplicateApplicationPropertiesComponent_ng_container_1_Template, 4, 5, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(2, DuplicateApplicationPropertiesComponent_c8y_progress_bar_2_Template, 2, 3, "c8y-progress-bar", 2);
        ɵngcc0.ɵɵelementStart(3, "c8y-wizard-footer");
        ɵngcc0.ɵɵtemplate(4, DuplicateApplicationPropertiesComponent_button_4_Template, 4, 7, "button", 3);
        ɵngcc0.ɵɵelementStart(5, "button", 4);
        ɵngcc0.ɵɵlistener("click", function DuplicateApplicationPropertiesComponent_Template_button_click_5_listener() { return ctx.cancel(); });
        ɵngcc0.ɵɵpipe(6, "translate");
        ɵngcc0.ɵɵtext(7);
        ɵngcc0.ɵɵpipe(8, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(9, "button", 5);
        ɵngcc0.ɵɵlistener("click", function DuplicateApplicationPropertiesComponent_Template_button_click_9_listener() { return ctx.duplicateApp(); });
        ɵngcc0.ɵɵpipe(10, "translate");
        ɵngcc0.ɵɵtext(11);
        ɵngcc0.ɵɵpipe(12, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", !ctx.inProgress);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.inProgress);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.inProgress);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isFirstStep);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(6, 9, "Cancel"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(8, 11, "Cancel"), " ");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(10, 13, "Duplicate"));
        ɵngcc0.ɵɵproperty("disabled", ctx.inProgress);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(12, 15, "Duplicate"), " ");
    } }, directives: [ɵngcc4.NgIf, ɵngcc5.WizardFooterComponent, ɵngcc6.ApplicationPropertiesFormComponent, ɵngcc7.CheckboxControlValueAccessor, ɵngcc7.NgControlStatus, ɵngcc7.NgModel, ɵngcc5.ProgressBarComponent], pipes: [ɵngcc5.C8yTranslatePipe, ɵngcc4.AsyncPipe], encapsulation: 2 });
DuplicateApplicationPropertiesComponent.ctorParameters = () => [
    { type: BsModalRef },
    { type: EcosystemService },
    { type: ApplicationService }
];
DuplicateApplicationPropertiesComponent.propDecorators = {
    stepper: [{ type: Input }],
    existingApps: [{ type: Input }],
    selectedApp: [{ type: Input }],
    isFirstStep: [{ type: Input }],
    duplicatedApp: [{ type: Output }],
    applicationPropertiesForm: [{ type: ViewChild, args: [ApplicationPropertiesFormComponent,] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DuplicateApplicationPropertiesComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-duplicate-application-properties',
                template: "<p\n  class=\"p-16 text-center text-medium separator-bottom sticky-top bg-white fit-w\"\n  *ngIf=\"!inProgress\"\n>\n  {{ 'Provide application details' | translate }}\n</p>\n\n<ng-container *ngIf=\"!inProgress\">\n  <label class=\"c8y-switch\" *ngIf=\"isSubscribedApp$ | async\">\n    <input type=\"checkbox\" [(ngModel)]=\"disableForm\" (change)=\"getAppConfig()\" />\n    <span></span> {{ 'Overrule subscribed application' | translate }}\n  </label>\n\n  <c8y-application-properties-form\n    [application]=\"newAppConfig\"\n    class=\"d-block fit-w\"\n    [disabled]=\"disableForm\"\n  ></c8y-application-properties-form>\n</ng-container>\n<c8y-progress-bar\n  *ngIf=\"inProgress\"\n  [message]=\"'Duplicating\u2026' | translate\"\n  class=\"text-center d-block\"\n></c8y-progress-bar>\n\n<c8y-wizard-footer>\n  <button\n    *ngIf=\"!isFirstStep\"\n    (click)=\"back()\"\n    [disabled]=\"inProgress\"\n    class=\"btn btn-default\"\n    type=\"button\"\n    title=\"{{ 'Back' | translate }}\"\n  >\n    {{ 'Back' | translate }}\n  </button>\n  <button (click)=\"cancel()\" class=\"btn btn-default\" title=\"{{ 'Cancel' | translate }}\">\n    {{ 'Cancel' | translate }}\n  </button>\n  <button\n    (click)=\"duplicateApp()\"\n    [disabled]=\"inProgress\"\n    class=\"btn btn-primary\"\n    type=\"button\"\n    title=\"{{ 'Duplicate' | translate }}\"\n  >\n    {{ 'Duplicate' | translate }}\n  </button>\n</c8y-wizard-footer>\n"
            }]
    }], function () { return [{ type: ɵngcc1.BsModalRef }, { type: ɵngcc2.EcosystemService }, { type: ɵngcc3.ApplicationService }]; }, { isFirstStep: [{
            type: Input
        }], duplicatedApp: [{
            type: Output
        }], stepper: [{
            type: Input
        }], existingApps: [{
            type: Input
        }], selectedApp: [{
            type: Input
        }], applicationPropertiesForm: [{
            type: ViewChild,
            args: [ApplicationPropertiesFormComponent]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVwbGljYXRlLWFwcGxpY2F0aW9uLXByb3BlcnRpZXMuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9lY29zeXN0ZW0vYXBwbGljYXRpb25zL2R1cGxpY2F0ZS1hcHBsaWNhdGlvbi9kdXBsaWNhdGUtYXBwbGljYXRpb24tcHJvcGVydGllcy9kdXBsaWNhdGUtYXBwbGljYXRpb24tcHJvcGVydGllcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxrQkFBa0IsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFFL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWpELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLHVEQUF1RCxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBTTNHLE1BQU0sT0FBTyx1Q0FBdUM7QUFDcEQsSUFhRSxZQUNVLFVBQXNCLEVBQ3RCLGdCQUFrQyxFQUNsQyxrQkFBc0M7QUFDL0MsUUFIUyxlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsUUFDdkIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUFDLFFBQ25DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFDbEQsUUFkVyxnQkFBVyxHQUFZLEtBQUssQ0FBQztBQUN4QyxRQUFZ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QzNCLGdCQUFNLE9BQU87QUFDYixhQUFLO0FBQ0wsWUFBSSxJQUFJO0FBQ1IsZ0JBQU0sTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3pFLGdCQUFNLE9BQU8sUUFBUSxDQUFDO0FBQ3RCLGFBQUs7QUFBQyxZQUFBLE9BQU8sRUFBRSxFQUFFO0FBQ2pCLGdCQUFNLE9BQU87QUFDYixhQUFLO0FBQ0wsUUFBRSxDQUFDO0FBRUgsS0FGRztBQUNIO21FQXpHQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLHNDQUFzQyxrQkFDaEQ7Ozs7Ozt3eUJBQWdFLGNBQ2pFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7K1JBQ0k7QUFBQztBQUNVLFlBWlAsVUFBVTtBQUFJLFlBSWQsZ0JBQWdCO0FBQUksWUFOcEIsa0JBQWtCO0FBQUc7QUFBRztBQUNMLHNCQWF6QixLQUFLO0FBQUssMkJBQ1YsS0FBSztBQUFLLDBCQUNWLEtBQUs7QUFBSywwQkFDVixLQUFLO0FBQUssNEJBQ1YsTUFBTTtBQUFLLHdDQUNYLFNBQVMsU0FBQyxrQ0FBa0M7QUFDM0M7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIElBcHBsaWNhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEM4eVN0ZXBwZXIgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEJzTW9kYWxSZWYgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQsIG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQVBQX1NUQVRFIH0gZnJvbSAnLi4vLi4vLi4vZWNvc3lzdGVtLmNvbnN0YW50cyc7XG5pbXBvcnQgeyBFY29zeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vZWNvc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9hcHBsaWNhdGlvbi1wcm9wZXJ0aWVzLWZvcm0uY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWR1cGxpY2F0ZS1hcHBsaWNhdGlvbi1wcm9wZXJ0aWVzJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2R1cGxpY2F0ZS1hcHBsaWNhdGlvbi1wcm9wZXJ0aWVzLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBEdXBsaWNhdGVBcHBsaWNhdGlvblByb3BlcnRpZXNDb21wb25lbnQge1xuICBASW5wdXQoKSBzdGVwcGVyOiBDOHlTdGVwcGVyO1xuICBASW5wdXQoKSBleGlzdGluZ0FwcHM6IElBcHBsaWNhdGlvbltdO1xuICBASW5wdXQoKSBzZWxlY3RlZEFwcDogQmVoYXZpb3JTdWJqZWN0PElBcHBsaWNhdGlvbj47XG4gIEBJbnB1dCgpIGlzRmlyc3RTdGVwOiBib29sZWFuID0gZmFsc2U7XG4gIEBPdXRwdXQoKSBkdXBsaWNhdGVkQXBwID0gbmV3IEV2ZW50RW1pdHRlcjxJQXBwbGljYXRpb24+KCk7XG4gIEBWaWV3Q2hpbGQoQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudClcbiAgYXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybTogQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudDtcbiAgbmV3QXBwQ29uZmlnOiBJQXBwbGljYXRpb247XG4gIGRpc2FibGVGb3JtID0gZmFsc2U7XG4gIGlzU3Vic2NyaWJlZEFwcCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgaW5Qcm9ncmVzczogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYnNNb2RhbFJlZjogQnNNb2RhbFJlZixcbiAgICBwcml2YXRlIGVjb3N5c3RlbVNlcnZpY2U6IEVjb3N5c3RlbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZVxuICApIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pc1N1YnNjcmliZWRBcHAkID0gdGhpcy5zZWxlY3RlZEFwcC5waXBlKFxuICAgICAgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQoJ2lkJyksXG4gICAgICBtYXAoYXBwID0+IChhcHAgPyB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuZ2V0QXBwU3RhdGUoYXBwKSA9PT0gQVBQX1NUQVRFLlNVQlNDUklCRUQgOiB0cnVlKSksXG4gICAgICB0YXAoaXNTdWJzY3JpYmVkID0+IHtcbiAgICAgICAgdGhpcy5kaXNhYmxlRm9ybSA9IGlzU3Vic2NyaWJlZDtcbiAgICAgICAgdGhpcy5nZXRBcHBDb25maWcoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICB0aGlzLmdldEFwcENvbmZpZygpO1xuICB9XG5cbiAgYXN5bmMgZHVwbGljYXRlQXBwKCkge1xuICAgIGNvbnN0IGZvcm1Hcm91cFZhbHVlID0gdGhpcy5hcHBsaWNhdGlvblByb3BlcnRpZXNGb3JtLmZvcm1Hcm91cC5nZXRSYXdWYWx1ZSgpO1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgY29uc3QgY2xvbmVkQXBwID0gKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmNsb25lKHRoaXMuc2VsZWN0ZWRBcHAudmFsdWUpKS5kYXRhO1xuXG4gICAgT2JqZWN0LmFzc2lnbihjbG9uZWRBcHAsIGZvcm1Hcm91cFZhbHVlKTtcbiAgICBkZWxldGUgY2xvbmVkQXBwLnR5cGU7XG5cbiAgICBhd2FpdCB0aGlzLnVwZGF0ZUFwcChjbG9uZWRBcHApO1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMuYnNNb2RhbFJlZi5oaWRlKCk7XG4gIH1cblxuICBiYWNrKCkge1xuICAgIHRoaXMuc3RlcHBlci5wcmV2aW91cygpO1xuICB9XG5cbiAgZ2V0QXBwQ29uZmlnKCkge1xuICAgIGlmICh0aGlzLmRpc2FibGVGb3JtKSB7XG4gICAgICBjb25zdCB7IG5hbWUsIGtleSwgY29udGV4dFBhdGggfSA9IHRoaXMuc2VsZWN0ZWRBcHAudmFsdWU7XG4gICAgICB0aGlzLm5ld0FwcENvbmZpZyA9IHsgbmFtZSwga2V5LCBjb250ZXh0UGF0aCB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm5ld0FwcENvbmZpZyA9IHRoaXMuZWNvc3lzdGVtU2VydmljZS5nZXRVbmlxdWVBcHBDb25maWcoXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRBcHAudmFsdWUsXG4gICAgICAgIHRoaXMuZXhpc3RpbmdBcHBzXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlQXBwKGNsb25lZEFwcENvbmZpZzogUGFydGlhbDxJQXBwbGljYXRpb24+KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YTogYXBwIH0gPSBhd2FpdCB0aGlzLmVjb3N5c3RlbVNlcnZpY2UudXBkYXRlQXBwKGNsb25lZEFwcENvbmZpZywgdHJ1ZSk7XG4gICAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IHRoaXMuZ2V0QXBwTWFuaWZlc3QoYXBwKTtcbiAgICAgIGlmIChtYW5pZmVzdCkge1xuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZU1hbmlmZXN0KGFwcCwgbWFuaWZlc3QpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmR1cGxpY2F0ZWRBcHAuZW1pdChhcHApO1xuICAgICAgdGhpcy5zdGVwcGVyLm5leHQoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlTWFuaWZlc3QoYXBwOiBJQXBwbGljYXRpb24sIG1hbmlmZXN0OiBhbnkpIHtcbiAgICBjb25zdCBrZXlzVG9VcGRhdGU6IEFycmF5PGtleW9mIElBcHBsaWNhdGlvbj4gPSBbJ25hbWUnLCAna2V5JywgJ2NvbnRleHRQYXRoJ107XG4gICAgY29uc3Qgc29tZUtleURpZmZlcnMgPSBrZXlzVG9VcGRhdGUuc29tZShrZXkgPT4gYXBwW2tleV0gIT09IG1hbmlmZXN0W2tleV0pO1xuICAgIGlmIChzb21lS2V5RGlmZmVycykge1xuICAgICAga2V5c1RvVXBkYXRlLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgbWFuaWZlc3Rba2V5XSA9IGFwcFtrZXldO1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5zdG9yZUFwcE1hbmlmZXN0KGFwcCwgbWFuaWZlc3QpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QXBwTWFuaWZlc3QoYXBwOiBJQXBwbGljYXRpb24pIHtcbiAgICBpZiAoIWFwcD8uY29udGV4dFBhdGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZ2V0QXBwTWFuaWZlc3QoYXBwKTtcbiAgICAgIHJldHVybiBtYW5pZmVzdDtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxufVxuIl19