import { __awaiter } from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { Router } from '@angular/router';
import { ApplicationService } from '@c8y/client';
import { AlertService, gettext, WizardService } from '@c8y/ngx-components';
import { BehaviorSubject } from 'rxjs';
import { EcosystemService } from './../ecosystem.service';
export class ApplicationCardComponent {
    constructor(applicationService, ecosystemService, alertService, router, wizardService) {
        this.applicationService = applicationService;
        this.ecosystemService = ecosystemService;
        this.alertService = alertService;
        this.router = router;
        this.wizardService = wizardService;
        this.canEdit = true;
        this.onAppDeleted = new EventEmitter();
        this.onAppCloned = new EventEmitter();
        this.CANNOT_DELETE_HINT = gettext(`Subscribed or current applications can't be deleted. Delete the application on the parent tenant or unsubscribe it from the current.`);
    }
    get openButtonTitle() {
        return !this.disableOpenInBrowser ?
            gettext('Open') :
            gettext('This application is overridden.');
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.appState = this.ecosystemService.getAppState(this.app);
            const contextPath = this.app.contextPath;
            this.canOpenInBrowser = this.ecosystemService.canOpenAppInBrowser(this.app);
            this.disableOpenInBrowser =
                this.canOpenInBrowser && (yield this.ecosystemService.isOverwrittenByCustomApp(this.app));
            this.canDelete = yield this.ecosystemService.canDeleteApp(this.app);
            this.isPackage = this.ecosystemService.isPackage(this.app);
            this.isFeature = this.ecosystemService.isFeature(this.app);
            this.isMicroservice = this.ecosystemService.isMicroservice(this.app);
            this.isExternal = this.ecosystemService.isExternal(this.app);
            this.canClone = !this.isMicroservice;
        });
    }
    detail() {
        this.isMicroservice
            ? this.router.navigateByUrl(`/microservices/${this.app.id}`)
            : this.router.navigateByUrl(`/ecosystem/application/${this.app.id}`);
    }
    openApp() {
        window.open(this.applicationService.getHref(this.app));
    }
    delete() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.ecosystemService.deleteApp(this.app);
                this.onAppDeleted.emit();
            }
            catch (ex) {
                if (ex) {
                    this.alertService.addServerFailure(ex);
                }
            }
        });
    }
    clone() {
        return __awaiter(this, void 0, void 0, function* () {
            const wizardConfig = {
                headerText: 'Add Application',
                headerIcon: 'c8y-atom'
            };
            const initialState = {
                wizardConfig,
                componentInitialState: {
                    selectedApp: new BehaviorSubject(this.app)
                },
                id: 'duplicateApplication'
            };
            const modalOptions = { initialState };
            const modalRef = this.wizardService.show(modalOptions);
            modalRef.content.onClose.subscribe(() => {
                this.onAppCloned.next();
            });
        });
    }
}
ApplicationCardComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-application-card',
                template: "<div class=\"card pointer card--d-col\">\n  <div (click)=\"detail()\" class=\"card-block text-center card-column-40\">\n    <div class=\"card-appicon\">\n      <c8y-app-icon\n        *ngIf=\"!isPackage && !isFeature && !isMicroservice && !isExternal\"\n        [app]=\"app\"\n        [contextPath]=\"app.contextPath\"\n        [name]=\"app.name\"\n      ></c8y-app-icon>\n      <i *ngIf=\"isPackage\" c8yIcon=\"big-parcel\"></i>\n      <i *ngIf=\"isFeature\" c8yIcon=\"tab\"></i>\n      <i *ngIf=\"isMicroservice\" c8yIcon=\"microchip\"></i>\n      <i *ngIf=\"isExternal\" c8yIcon=\"globe1\"></i>\n    </div>\n    <p class=\"e2e-appCardName text-medium\" title=\"{{ app | humanizeAppName | async }}\">\n      {{ app | humanizeAppName | async }}\n    </p>\n    <small *ngIf=\"app.manifest?.version && (isPackage || isMicroservice)\" class=\"text-muted\">\n      <em>{{ app.manifest.version }}</em>\n    </small>\n  </div>\n  <div (click)=\"detail()\" class=\"card-block p-0 no-min-height card--d-col card-column-80 flex-grow\">\n    <div class=\"card-block no-min-height p-t-0 p-b-0 card-column-80\">\n      <div *ngIf=\"app.description\" class=\"text-center-grid\">\n        <div class=\"p-b-8 card-hidden-grid\"></div>\n        <p class=\"small l-h-tight p-b-8 p-l-0 p-r-0\">{{ app.description | translate }}</p>\n      </div>\n    </div>\n    <div class=\"card-block no-min-height p-t-0 p-b-0 card-column-20 text-center-grid\">\n      <span [ngClass]=\"appState.class\" class=\"label\">{{ appState.label | translate }}</span>\n    </div>\n    <div class=\"card-footer no-min-height p-t-0 p-b-0 card-column-20 text-center-grid\">\n      <div class=\"p-b-16 card-hidden-list\"></div>\n      <button\n        (click)=\"openApp(); $event.stopPropagation()\"\n        *ngIf=\"canOpenInBrowser\"\n        [disabled]=\"disableOpenInBrowser\"\n        class=\"btn btn-xs btn-default\"\n        [title]=\"openButtonTitle | translate\"\n      >\n        <i c8yIcon=\"external-link\" class=\"m-r-4\"></i>\n        {{ 'Open' | translate }}\n      </button>\n      <div class=\"p-b-32 card-hidden-list\"></div>\n    </div>\n  </div>\n\n  <div *ngIf=\"canEdit || canOpenInBrowser || canDelete\" class=\"card-actions m-t-0\">\n    <div class=\"dropdown\" dropdown>\n      <button\n        class=\"dropdown-toggle c8y-dropdown\"\n        dropdownToggle\n        title=\"{{ 'Settings' | translate }}\"\n      >\n        <i c8yIcon=\"ellipsis-v\"></i>\n      </button>\n      <ul *dropdownMenu class=\"dropdown-menu dropdown-menu-right\">\n        <li *ngIf=\"canEdit\">\n          <button (click)=\"detail()\" title=\"{{ 'Edit' | translate }}\">\n            <i c8yIcon=\"pencil\" class=\"m-r-4\"></i>\n            {{ 'Edit' | translate }}\n          </button>\n        </li>\n        <ng-container *c8yIfAllowed=\"['ROLE_APPLICATION_MANAGEMENT_ADMIN']\">\n          <li>\n            <button\n              (click)=\"delete()\"\n              href=\"\"\n              title=\"{{ canDelete ? 'Delete' : (CANNOT_DELETE_HINT | translate) }}\"\n              [disabled]=\"!canDelete\"\n            >\n              <i c8yIcon=\"trash\" class=\"m-r-4\"></i>\n              {{ 'Delete' | translate }}\n            </button>\n          </li>\n          <li *ngIf=\"canClone\">\n            <button\n              (click)=\"clone()\"\n              href=\"\"\n              [title]=\"'Clone application' | translate\"\n            >\n              <i c8yIcon=\"copy\" class=\"m-r-4\"></i>\n              {{ 'Clone application' | translate }}\n            </button>\n          </li>\n        </ng-container>\n      </ul>\n    </div>\n  </div>\n</div>\n"
            },] }
];
ApplicationCardComponent.ctorParameters = () => [
    { type: ApplicationService },
    { type: EcosystemService },
    { type: AlertService },
    { type: Router },
    { type: WizardService }
];
ApplicationCardComponent.propDecorators = {
    app: [{ type: Input }],
    canEdit: [{ type: Input }],
    onAppDeleted: [{ type: Output }],
    onAppCloned: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tY2FyZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9lY29zeXN0ZW0vc2hhcmVkL2FwcGxpY2F0aW9uLWNhcmQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsa0JBQWtCLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQy9ELE9BQU8sRUFDTCxZQUFZLEVBQ1osT0FBTyxFQUlQLGFBQWEsRUFDZCxNQUFNLHFCQUFxQixDQUFDO0FBRTdCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFHdkMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFNMUQsTUFBTSxPQUFPLHdCQUF3QjtJQXNCbkMsWUFDVSxrQkFBc0MsRUFDdEMsZ0JBQWtDLEVBQ2xDLFlBQTBCLEVBQzFCLE1BQWMsRUFDZCxhQUE0QjtRQUo1Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBekI3QixZQUFPLEdBQVksSUFBSSxDQUFDO1FBQ3ZCLGlCQUFZLEdBQXVCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEQsZ0JBQVcsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQWdCdEQsdUJBQWtCLEdBQUcsT0FBTyxDQUFDLHNJQUFzSSxDQUFDLENBQUM7SUFRM0ssQ0FBQztJQWRKLElBQUksZUFBZTtRQUNqQixPQUFPLENBQUMsSUFBSSxD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RSxDQUFDO1lBRXJFLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3ZELFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3RDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDMUIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO0tBQUE7OztZQXpGRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHNCQUFzQjtnQkFDaEMseWpIQUFnRDthQUNqRDs7O1lBbEJRLGtCQUFrQjtZQWFsQixnQkFBZ0I7WUFYdkIsWUFBWTtZQUhMLE1BQU07WUFRYixhQUFhOzs7a0JBYVosS0FBSztzQkFDTCxLQUFLOzJCQUNMLE1BQU07MEJBQ04sTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIElBcHBsaWNhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7XG4gIEFsZXJ0U2VydmljZSxcbiAgZ2V0dGV4dCxcbiAgV2l6YXJkLFxuICBXaXphcmRDb21wb25lbnQsXG4gIFdpemFyZENvbmZpZyxcbiAgV2l6YXJkU2VydmljZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IE1vZGFsT3B0aW9ucyB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEdXBsaWNhdGVBcHBsaWNhdGlvbkNvbXBvbmVudCB9IGZyb20gJy4uL2FwcGxpY2F0aW9ucy9kdXBsaWNhdGUtYXBwbGljYXRpb24vZHVwbGljYXRlLWFwcGxpY2F0aW9uLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblN0YXRlIH0gZnJvbSAnLi8uLi9lY29zeXN0ZW0ubW9kZWwnO1xuaW1wb3J0IHsgRWNvc3lzdGVtU2VydmljZSB9IGZyb20gJy4vLi4vZWNvc3lzdGVtLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktYXBwbGljYXRpb24tY2FyZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9hcHBsaWNhdGlvbi1jYXJkLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvbkNhcmRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBASW5wdXQoKSBhcHA6IElBcHBsaWNhdGlvbjtcbiAgQElucHV0KCkgY2FuRWRpdDogYm9vbGVhbiA9IHRydWU7XG4gIEBPdXRwdXQoKSBvbkFwcERlbGV0ZWQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIG9uQXBwQ2xvbmVkOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGFwcFN0YXRlOiBBcHBsaWNhdGlvblN0YXRlO1xuICBjYW5PcGVuSW5Ccm93c2VyOiBib29sZWFuO1xuICBkaXNhYmxlT3BlbkluQnJvd3NlcjogYm9vbGVhbjtcbiAgY2FuRGVsZXRlOiBib29sZWFuO1xuICBpc1BhY2thZ2U6IGJvb2xlYW47XG4gIGlzRmVhdHVyZTogYm9vbGVhbjtcbiAgaXNFeHRlcm5hbDogYm9vbGVhbjtcbiAgaXNNaWNyb3NlcnZpY2U6IGJvb2xlYW47XG4gIGNhbkNsb25lOiBib29sZWFuO1xuICBnZXQgb3BlbkJ1dHRvblRpdGxlKCkge1xuICAgIHJldHVybiAhdGhpcy5kaXNhYmxlT3BlbkluQnJvd3NlciA/XG4gICAgICBnZXR0ZXh0KCdPcGVuJykgOlxuICAgICAgZ2V0dGV4dCgnVGhpcyBhcHBsaWNhdGlvbiBpcyBvdmVycmlkZGVuLicpO1xuICB9XG5cbiAgcmVhZG9ubHkgQ0FOTk9UX0RFTEVURV9ISU5UID0gZ2V0dGV4dChgU3Vic2NyaWJlZCBvciBjdXJyZW50IGFwcGxpY2F0aW9ucyBjYW4ndCBiZSBkZWxldGVkLiBEZWxldGUgdGhlIGFwcGxpY2F0aW9uIG9uIHRoZSBwYXJlbnQgdGVuYW50IG9yIHVuc3Vic2NyaWJlIGl0IGZyb20gdGhlIGN1cnJlbnQuYCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGVjb3N5c3RlbVNlcnZpY2U6IEVjb3N5c3RlbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgd2l6YXJkU2VydmljZTogV2l6YXJkU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5hcHBTdGF0ZSA9IHRoaXMuZWNvc3lzdGVtU2VydmljZS5nZXRBcHBTdGF0ZSh0aGlzLmFwcCk7XG4gICAgY29uc3QgY29udGV4dFBhdGggPSB0aGlzLmFwcC5jb250ZXh0UGF0aDtcbiAgICB0aGlzLmNhbk9wZW5JbkJyb3dzZXIgPSB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuY2FuT3BlbkFwcEluQnJvd3Nlcih0aGlzLmFwcCk7XG4gICAgdGhpcy5kaXNhYmxlT3BlbkluQnJvd3NlciA9XG4gICAgICB0aGlzLmNhbk9wZW5JbkJyb3dzZXIgJiYgKGF3YWl0IHRoaXMuZWNvc3lzdGVtU2VydmljZS5pc092ZXJ3cml0dGVuQnlDdXN0b21BcHAodGhpcy5hcHApKTtcbiAgICB0aGlzLmNhbkRlbGV0ZSA9IGF3YWl0IHRoaXMuZWNvc3lzdGVtU2VydmljZS5jYW5EZWxldGVBcHAodGhpcy5hcHApO1xuICAgIHRoaXMuaXNQYWNrYWdlID0gdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmlzUGFja2FnZSh0aGlzLmFwcCk7XG4gICAgdGhpcy5pc0ZlYXR1cmUgPSB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuaXNGZWF0dXJlKHRoaXMuYXBwKTtcbiAgICB0aGlzLmlzTWljcm9zZXJ2aWNlID0gdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmlzTWljcm9zZXJ2aWNlKHRoaXMuYXBwKTtcbiAgICB0aGlzLmlzRXh0ZXJuYWwgPSB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuaXNFeHRlcm5hbCh0aGlzLmFwcCk7XG4gICAgdGhpcy5jYW5DbG9uZSA9ICF0aGlzLmlzTWljcm9zZXJ2aWNlO1xuICB9XG5cbiAgZGV0YWlsKCkge1xuICAgIHRoaXMuaXNNaWNyb3NlcnZpY2VcbiAgICAgID8gdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChgL21pY3Jvc2VydmljZXMvJHt0aGlzLmFwcC5pZH1gKVxuICAgICAgOiB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKGAvZWNvc3lzdGVtL2FwcGxpY2F0aW9uLyR7dGhpcy5hcHAuaWR9YCk7XG4gIH1cblxuICBvcGVuQXBwKCkge1xuICAgIHdpbmRvdy5vcGVuKHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmdldEhyZWYodGhpcy5hcHApKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZSgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmRlbGV0ZUFwcCh0aGlzLmFwcCk7XG4gICAgICB0aGlzLm9uQXBwRGVsZXRlZC5lbWl0KCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGlmIChleCkge1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBjbG9uZSgpIHtcbiAgICBjb25zdCB3aXphcmRDb25maWc6IFdpemFyZENvbmZpZyA9IHtcbiAgICAgIGhlYWRlclRleHQ6ICdBZGQgQXBwbGljYXRpb24nLFxuICAgICAgaGVhZGVySWNvbjogJ2M4eS1hdG9tJ1xuICAgIH07XG5cbiAgICBjb25zdCBpbml0aWFsU3RhdGU6IFdpemFyZDxEdXBsaWNhdGVBcHBsaWNhdGlvbkNvbXBvbmVudD4gPSB7XG4gICAgICB3aXphcmRDb25maWcsXG4gICAgICBjb21wb25lbnRJbml0aWFsU3RhdGU6IHtcbiAgICAgICAgc2VsZWN0ZWRBcHA6IG5ldyBCZWhhdmlvclN1YmplY3QodGhpcy5hcHApXG4gICAgICB9LFxuICAgICAgaWQ6ICdkdXBsaWNhdGVBcHBsaWNhdGlvbidcbiAgICB9O1xuXG4gICAgY29uc3QgbW9kYWxPcHRpb25zOiBNb2RhbE9wdGlvbnM8V2l6YXJkQ29tcG9uZW50PiA9IHsgaW5pdGlhbFN0YXRlIH07XG5cbiAgICBjb25zdCBtb2RhbFJlZiA9IHRoaXMud2l6YXJkU2VydmljZS5zaG93KG1vZGFsT3B0aW9ucyk7XG4gICAgbW9kYWxSZWYuY29udGVudC5vbkNsb3NlLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLm9uQXBwQ2xvbmVkLm5leHQoKTtcbiAgICB9KTtcbiAgfVxufVxuIl19