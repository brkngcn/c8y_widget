import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { FetchClient } from '@c8y/client';
import { AlertService, AppStateService } from '@c8y/ngx-components';
import { isActilityConnection, isSigfoxConnection, ConnectionType } from './multiple-lns-connector.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/core/FetchClient";
import * as i2 from "@c8y/ngx-components";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components';
export class MultipleLnsConnectorService {
    constructor(client, appStateService, alertService) {
        this.client = client;
        this.appStateService = appStateService;
        this.alertService = alertService;
        this.headers = { 'Content-Type': 'application/json' };
    }
    list(connectionType) {
        return __awaiter(this, void 0, void 0, function* () {
            const url = `${this.getBaseUrlByType(connectionType)}/lns-connection`;
            const options = {
                method: 'GET',
                headers: this.headers
            };
            return this.client.fetch(url, options);
        });
    }
    /**
     * Saves the connection.
     * @param connection The connection to be saved.
     * @param originalName The original name of the connection, required to perform an update.
     */
    save(connection, originalName = null) {
        return __awaiter(this, void 0, void 0, function* () {
            if (originalName) {
                return this.update(connection, originalName);
            }
            return this.create(connection);
        });
    }
    detail(connectionType, connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = connectionName.toLocaleLowerCase();
            const url = `${this.getBaseUrlByType(connectionType)}/lns-connection/${encodeURIComponent(String(name))}`;
            const options = {
                method: 'GET',
                headers: this.headers
            };
            const res = yield this.client.fetch(url, options);
            if (res.status === 200) {
                return yield res.json();
            }
            return null;
        });
    }
    exists(connectionType, connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const connection = yield this.detail(connectionType, connectionName);
            return connection !== null;
        });
    }
    create(connection) {
        return __awaiter(this, void 0, void 0, function* () {
            connection.name = connection.name.toLocaleLowerCase();
            const url = `${this.getBaseUrlByConnection(connection)}/lns-connection`;
            const options = {
                method: 'POST',
                headers: this.headers,
                body: JSON.stringify(connection)
            };
            return this.client.fetch(url, options);
        });
    }
    update(connection, originalName) {
        return __awaiter(this, void 0, void 0, function* () {
            connection.name = connection.name.toLocaleLowerCase();
            const url = `${this.getBaseUrlByConnection(connection)}/lns-connection/${encodeURIComponent(String(originalName))}`;
            const options = {
                method: 'PUT',
                headers: this.headers,
                body: JSON.stringify(connection)
            };
            return this.client.fetch(url, options);
        });
    }
    getBaseUrlByConnection(connection) {
        return isSigfoxConnection(connection)
            ? 'service/sigfox-agent'
            : isActilityConnection(connection)
                ? 'service/actility'
                : '';
    }
    getBaseUrlByType(connectionType) {
        return (connectionType === ConnectionType.SIGFOX)
            ? 'service/sigfox-agent'
            : (connectionType === ConnectionType.ACTILITY)
                ? 'service/actility'
                : '';
    }
    delete(connection) {
        return __awaiter(this, void 0, void 0, function* () {
            const url = `${this.getBaseUrlByConnection(connection)}/lns-connection`;
            const options = {
                method: 'DELETE'
            };
            return this.client.fetch(`${url}/${encodeURIComponent(String(connection.name))}`, options);
        });
    }
    getApplication(name) {
        const { references } = this.appStateService.currentTenant.value.applications;
        return references.find(({ application }) => application.name === name).application;
    }
    download(url) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const options = {
                    method: 'GET'
                };
                return this.client.fetch(url, options);
            }
            catch (e) {
                this.alertService.addServerFailure(e);
            }
        });
    }
}
MultipleLnsConnectorService.ɵfac = function MultipleLnsConnectorService_Factory(t) { return new (t || MultipleLnsConnectorService)(ɵngcc0.ɵɵinject(ɵngcc1.FetchClient), ɵngcc0.ɵɵinject(ɵngcc2.AppStateService), ɵngcc0.ɵɵinject(ɵngcc2.AlertService)); };
MultipleLnsConnectorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function MultipleLnsConnectorService_Factory() { return new MultipleLnsConnectorService(i0.ɵɵinject(i1.FetchClient), i0.ɵɵinject(i2.AppStateService), i0.ɵɵinject(i2.AlertService)); }, token: MultipleLnsConnectorService, providedIn: "root" });
MultipleLnsConnectorService.ctorParameters = () => [
    { type: FetchClient },
    { type: AppStateService },
    { type: AlertService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(MultipleLnsConnectorService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.FetchClient }, { type: ɵngcc2.AppStateService }, { type: ɵngcc2.AlertService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlwbGUtbG5zLWNvbm5lY3Rvci5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm90b2NvbC1scHdhbi9tdWx0aXBsZS1sbnMtY29ubmVjdG9ycy9tdWx0aXBsZS1sbnMtY29ubmVjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBK0MsTUFBTSxhQUFhLENBQUM7QUFDdkYsT0FBTyxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRSxPQUFPLEVBQXNCLG9CQUFvQixFQUFFLGtCQUFrQixFQUFvQixjQUFjLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNoSjtBQUdDO0FBRWM7Ozs7QUFEZixNQUFNLE9BQU8sMkJBQTJCO0FBQ3hDLElBQ0UsWUFDVSxNQUFtQixFQUNuQixlQUFnQyxFQUNoQyxZQUEwQjtBQUNuQyxRQUhTLFdBQU0sR0FBTixNQUFNLENBQWE7QUFBQyxRQUNwQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7QUFBQyxRQUNqQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUN0QyxRQUNJLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztBQUMxRCxJQUFFLENBQUM7QUFDSCxJQUNRLElBQUksQ0FBQyxjQUE4QjtBQUMzQztBQUE4RCxZQUExRCxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUM7QUFDMUUsWUFBSSxNQUFNLE9BQU8sR0FBa0I7QUFDbkMsZ0JBQU0sTUFBTSxFQUFFLEtBQUs7QUFDbkIsZ0JBQU0sT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO0FBQzNCLGFBQUssQ0FBQztBQUNOLFlBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0MsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFFSixPQURLO0FBQ0wsSUFBUSxJQUFJLENBQUMsVUFBaUQsRUFBRSxlQUF1QixJQUFJO0FBQzNGO0FBQ3NDLFlBRGxDLElBQUksWUFBWSxFQUFFO0FBQ3RCLGdCQUFNLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDbkQsYUFBSztBQUNMLFlBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ25DLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNRLE1BQU0sQ0FDVixjQUE4QixFQUM5QixjQUFzQjtBQUN2QjtBQUNDLFlBQUEsTUFBTSxJQUFJLEdBQUcsY0FBYyxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFDcEQsWUFBSSxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsbUJBQW1CLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDOUcsWUFBSSxNQUFNLE9BQU8sR0FBa0I7QUFDbkMsZ0JBQU0sTUFBTSxFQUFFLEtBQUs7QUFDbkIsZ0JBQU0sT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO0FBQzNCLGFBQUssQ0FBQztBQUNOLFlBQUksTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDdEQsWUFBSSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO0FBQzVCLGdCQUFNLE9BQU8sTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDOUIsYUFBSztBQUNMLFlBQUksT0FBTyxJQUFJLENBQUM7QUFDaEIsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EsTUFBTSxDQUFDLGNBQThCLEVBQUUsY0FBc0I7QUFBSTtBQUM3QixZQUF4QyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3pFLFlBQUksT0FBTyxVQUFVLEtBQUssSUFBSSxDQUFDO0FBQy9CLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNRLE1BQU0sQ0FBQyxVQUFpRDtBQUNoRTtBQUNHLFlBREMsVUFBVSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFDMUQsWUFBSSxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUM7QUFDNUUsWUFBSSxNQUFNLE9BQU8sR0FBa0I7QUFDbkMsZ0JBQU0sTUFBTSxFQUFFLE1BQU07QUFDcEIsZ0JBQU0sT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO0FBQzNCLGdCQUFNLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxhQUFLLENBQUM7QUFDTixZQUFJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzNDLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNRLE1BQU0sQ0FBQyxVQUFpRCxFQUFFLFlBQW9CO0FBQ3RGO0FBQ0csWUFEQyxVQUFVLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztBQUMxRCxZQUFJLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUN4SCxZQUFJLE1BQU0sT0FBTyxHQUFrQjtBQUNuQyxnQkFBTSxNQUFNLEVBQUUsS0FBSztBQUNuQixnQkFBTSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87QUFDM0IsZ0JBQU0sSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO0FBQ3RDLGFBQUssQ0FBQztBQUNOLFlBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0MsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ0Usc0JBQXNCLENBQUMsVUFBaUQ7QUFDMUUsUUFBSSxPQUFPLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztBQUN6QyxZQUFNLENBQUMsQ0FBQyxzQkFBc0I7QUFDOUIsWUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDO0FBQ3hDLGdCQUFNLENBQUMsQ0FBQyxrQkFBa0I7QUFDMUIsZ0JBQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUNYLElBQUUsQ0FBQztBQUNILElBQ0UsZ0JBQWdCLENBQUMsY0FBOEI7QUFDakQsUUFBSSxPQUFPLENBQUMsY0FBYyxLQUFLLGNBQWMsQ0FBQyxNQUFNLENBQUM7QUFDckQsWUFBTSxDQUFDLENBQUMsc0JBQXNCO0FBQzlCLFlBQU0sQ0FBQyxDQUFDLENBQUMsY0FBYyxLQUFLLGNBQWMsQ0FBQyxRQUFRLENBQUM7QUFDcEQsZ0JBQU0sQ0FBQyxDQUFDLGtCQUFrQjtBQUMxQixnQkFBTSxDQUFDLENBQUMsRUFBRSxDQUFDO0FBQ1gsSUFBRSxDQUFDO0FBQ0gsSUFDUSxNQUFNLENBQUMsVUFBaUQ7QUFDaEU7QUFBOEQsWUFBMUQsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDO0FBQzVFLFlBQUksTUFBTSxPQUFPLEdBQWtCO0FBQ25DLGdCQUFNLE1BQU0sRUFBRSxRQUFRO0FBQ3RCLGFBQUssQ0FBQztBQUNOLFlBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUMvRixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDRSxjQUFjLENBQUMsSUFBWTtBQUFJLFFBQzdCLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDO0FBQ2pGLFFBQUksT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUM7QUFDdkYsSUFBRSxDQUFDO0FBQ0gsSUFDUSxRQUFRLENBQUMsR0FBVztBQUFJO0FBRUwsWUFEdkIsSUFBSTtBQUNSLGdCQUFNLE1BQU0sT0FBTyxHQUFrQjtBQUNyQyxvQkFBUSxNQUFNLEVBQUUsS0FBSztBQUNyQixpQkFBTyxDQUFDO0FBQ1IsZ0JBQU0sT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDN0MsYUFBSztBQUFDLFlBQUEsT0FBTyxDQUFDLEVBQUU7QUFDaEIsZ0JBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1QyxhQUFLO0FBQ0wsUUFBRSxDQUFDO0FBRUgsS0FGRztBQUNIOzBQQUFDO0FBQ0QsdVRBbkhLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBSUksWUFSUCxXQUFXO1lBS2xCLFVBQVUsRUFBRSxNQUFNLDlCQUxJLFlBQ0QsZUFBZTthQUtyQyxiQUx5QyxZQUFqQyxZQUFZO0FBQUc7Ozs7Ozs2SUFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRmV0Y2hDbGllbnQsIElBcHBsaWNhdGlvbiwgSUZldGNoT3B0aW9ucywgSUZldGNoUmVzcG9uc2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIEFwcFN0YXRlU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgQWN0aWxpdHlDb25uZWN0aW9uLCBpc0FjdGlsaXR5Q29ubmVjdGlvbiwgaXNTaWdmb3hDb25uZWN0aW9uLCBTaWdmb3hDb25uZWN0aW9uLCBDb25uZWN0aW9uVHlwZSB9IGZyb20gJy4vbXVsdGlwbGUtbG5zLWNvbm5lY3Rvci5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE11bHRpcGxlTG5zQ29ubmVjdG9yU2VydmljZSB7XG4gIHByaXZhdGUgaGVhZGVyczogYW55O1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNsaWVudDogRmV0Y2hDbGllbnQsXG4gICAgcHJpdmF0ZSBhcHBTdGF0ZVNlcnZpY2U6IEFwcFN0YXRlU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuaGVhZGVycyA9IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9O1xuICB9XG5cbiAgYXN5bmMgbGlzdChjb25uZWN0aW9uVHlwZTogQ29ubmVjdGlvblR5cGUpIHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldEJhc2VVcmxCeVR5cGUoY29ubmVjdGlvblR5cGUpfS9sbnMtY29ubmVjdGlvbmA7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnNcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaCh1cmwsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNhdmVzIHRoZSBjb25uZWN0aW9uLlxuICAgKiBAcGFyYW0gY29ubmVjdGlvbiBUaGUgY29ubmVjdGlvbiB0byBiZSBzYXZlZC5cbiAgICogQHBhcmFtIG9yaWdpbmFsTmFtZSBUaGUgb3JpZ2luYWwgbmFtZSBvZiB0aGUgY29ubmVjdGlvbiwgcmVxdWlyZWQgdG8gcGVyZm9ybSBhbiB1cGRhdGUuXG4gICAqL1xuICBhc3luYyBzYXZlKGNvbm5lY3Rpb246IEFjdGlsaXR5Q29ubmVjdGlvbiB8IFNpZ2ZveENvbm5lY3Rpb24sIG9yaWdpbmFsTmFtZTogc3RyaW5nID0gbnVsbCkge1xuICAgIGlmIChvcmlnaW5hbE5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnVwZGF0ZShjb25uZWN0aW9uLCBvcmlnaW5hbE5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jcmVhdGUoY29ubmVjdGlvbik7XG4gIH1cblxuICBhc3luYyBkZXRhaWwoXG4gICAgY29ubmVjdGlvblR5cGU6IENvbm5lY3Rpb25UeXBlLFxuICAgIGNvbm5lY3Rpb25OYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxBY3RpbGl0eUNvbm5lY3Rpb24gfCBTaWdmb3hDb25uZWN0aW9uIHwgbnVsbD4ge1xuICAgIGNvbnN0IG5hbWUgPSBjb25uZWN0aW9uTmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0QmFzZVVybEJ5VHlwZShjb25uZWN0aW9uVHlwZSl9L2xucy1jb25uZWN0aW9uLyR7ZW5jb2RlVVJJQ29tcG9uZW50KFN0cmluZyhuYW1lKSl9YDtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyc1xuICAgIH07XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICByZXR1cm4gYXdhaXQgcmVzLmpzb24oKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBhc3luYyBleGlzdHMoY29ubmVjdGlvblR5cGU6IENvbm5lY3Rpb25UeXBlLCBjb25uZWN0aW9uTmFtZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGV0YWlsKGNvbm5lY3Rpb25UeXBlLCBjb25uZWN0aW9uTmFtZSk7XG4gICAgcmV0dXJuIGNvbm5lY3Rpb24gIT09IG51bGw7XG4gIH1cblxuICBhc3luYyBjcmVhdGUoY29ubmVjdGlvbjogQWN0aWxpdHlDb25uZWN0aW9uIHwgU2lnZm94Q29ubmVjdGlvbikge1xuICAgIGNvbm5lY3Rpb24ubmFtZSA9IGNvbm5lY3Rpb24ubmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0QmFzZVVybEJ5Q29ubmVjdGlvbihjb25uZWN0aW9uKX0vbG5zLWNvbm5lY3Rpb25gO1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGNvbm5lY3Rpb24pXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZShjb25uZWN0aW9uOiBBY3RpbGl0eUNvbm5lY3Rpb24gfCBTaWdmb3hDb25uZWN0aW9uLCBvcmlnaW5hbE5hbWU6IHN0cmluZykge1xuICAgIGNvbm5lY3Rpb24ubmFtZSA9IGNvbm5lY3Rpb24ubmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0QmFzZVVybEJ5Q29ubmVjdGlvbihjb25uZWN0aW9uKX0vbG5zLWNvbm5lY3Rpb24vJHtlbmNvZGVVUklDb21wb25lbnQoU3RyaW5nKG9yaWdpbmFsTmFtZSkpfWA7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShjb25uZWN0aW9uKVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LmZldGNoKHVybCwgb3B0aW9ucyk7XG4gIH1cblxuICBnZXRCYXNlVXJsQnlDb25uZWN0aW9uKGNvbm5lY3Rpb246IEFjdGlsaXR5Q29ubmVjdGlvbiB8IFNpZ2ZveENvbm5lY3Rpb24pIHtcbiAgICByZXR1cm4gaXNTaWdmb3hDb25uZWN0aW9uKGNvbm5lY3Rpb24pXG4gICAgICA/ICdzZXJ2aWNlL3NpZ2ZveC1hZ2VudCdcbiAgICAgIDogaXNBY3RpbGl0eUNvbm5lY3Rpb24oY29ubmVjdGlvbilcbiAgICAgID8gJ3NlcnZpY2UvYWN0aWxpdHknXG4gICAgICA6ICcnO1xuICB9XG5cbiAgZ2V0QmFzZVVybEJ5VHlwZShjb25uZWN0aW9uVHlwZTogQ29ubmVjdGlvblR5cGUpIHtcbiAgICByZXR1cm4gKGNvbm5lY3Rpb25UeXBlID09PSBDb25uZWN0aW9uVHlwZS5TSUdGT1gpXG4gICAgICA/ICdzZXJ2aWNlL3NpZ2ZveC1hZ2VudCdcbiAgICAgIDogKGNvbm5lY3Rpb25UeXBlID09PSBDb25uZWN0aW9uVHlwZS5BQ1RJTElUWSlcbiAgICAgID8gJ3NlcnZpY2UvYWN0aWxpdHknXG4gICAgICA6ICcnO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGNvbm5lY3Rpb246IEFjdGlsaXR5Q29ubmVjdGlvbiB8IFNpZ2ZveENvbm5lY3Rpb24pIHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldEJhc2VVcmxCeUNvbm5lY3Rpb24oY29ubmVjdGlvbil9L2xucy1jb25uZWN0aW9uYDtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnREVMRVRFJ1xuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LmZldGNoKGAke3VybH0vJHtlbmNvZGVVUklDb21wb25lbnQoU3RyaW5nKGNvbm5lY3Rpb24ubmFtZSkpfWAsIG9wdGlvbnMpO1xuICB9XG5cbiAgZ2V0QXBwbGljYXRpb24obmFtZTogc3RyaW5nKTogUGFydGlhbDxJQXBwbGljYXRpb24+IHtcbiAgICBjb25zdCB7IHJlZmVyZW5jZXMgfSA9IHRoaXMuYXBwU3RhdGVTZXJ2aWNlLmN1cnJlbnRUZW5hbnQudmFsdWUuYXBwbGljYXRpb25zO1xuICAgIHJldHVybiByZWZlcmVuY2VzLmZpbmQoKHsgYXBwbGljYXRpb24gfSkgPT4gYXBwbGljYXRpb24ubmFtZSA9PT0gbmFtZSkuYXBwbGljYXRpb247XG4gIH1cblxuICBhc3luYyBkb3dubG9hZCh1cmw6IHN0cmluZyk6IFByb21pc2U8SUZldGNoUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJ1xuICAgICAgfTtcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZSk7XG4gICAgfVxuICB9XG59XG4iXX0=