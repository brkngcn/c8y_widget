import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, FetchClient, IdentityService } from '@c8y/client';
import { get, orderBy } from 'lodash-es';
import { MultipleLnsConnectorService } from './multiple-lns-connectors';
import { ConnectionType } from './multiple-lns-connectors/multiple-lns-connector.model';
export class LpwanSetDeviceProtocolService {
    constructor(inventoryService, client, identityService, lnsService) {
        this.inventoryService = inventoryService;
        this.client = client;
        this.identityService = identityService;
        this.lnsService = lnsService;
        this.supportedDevicesCfgs = [
            {
                name: 'lora',
                match: device => get(device, 'c8y_LpwanDevice.lpwanDeviceType') === 'Lora',
                protocolTypes: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['c8y_LoriotEUI', 'c8y_Serial'],
                connectionType: ConnectionType.ACTILITY
            },
            {
                name: 'sigfox',
                match: device => get(device, 'c8y_LpwanDevice.serviceProvider') === 'Sigfox',
                protocolTypes: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['com.sigfox.deviceId'],
                connectionType: ConnectionType.SIGFOX
            }
        ];
        this.header = { 'Content-Type': 'application/json' };
    }
    refreshCache(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const externalId = yield this.getExternalId(device);
            if (externalId) {
                const url = `${this.getMicroserviceUrl(device)}/refreshCache/${externalId}`;
                const options = {
                    method: 'POST',
                    headers: this.header,
                    body: JSON.stringify({})
                };
                return this.client.fetch(url, options);
            }
        });
    }
    getMicroserviceUrl(device) {
        const { serviceProvider } = device.c8y_LpwanDevice;
        let serviceName = serviceProvider.toLowerCase();
        if (serviceProvider === 'Sigfox') {
            serviceName = 'sigfox-agent';
        }
        return `/service/${serviceName}`;
    }
    isSupportedDevice(device) {
        return this.supportedDevicesCfgs.some(({ match }) => match(device));
    }
    getCurrentProtocol(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const lpwanDevice = device.c8y_LpwanDevice;
            let protocolId;
            if (lpwanDevice.typeExternalId) {
                const externalId = (yield this.identityService.detail(lpwanDevice.typeExternalId)).data;
                protocolId = externalId.managedObject.id;
            }
            if (!protocolId && lpwanDevice.type) {
                protocolId = lpwanDevice.type.split('/')[2];
            }
            if (!protocolId) {
                return null;
            }
            return (yield this.inventoryService.detail(protocolId)).data;
        });
    }
    applyProtocol(device, selectedProtocol) {
        return __awaiter(this, void 0, void 0, function* () {
            const [protocolExternalId] = (yield this.identityService.list(selectedProtocol.id)).data;
            const { externalId, type } = protocolExternalId;
            device.c8y_LpwanDevice.typeExternalId = { externalId, type };
            device.c8y_LpwanDevice.type = 'inventory/managedObjects/' + selectedProtocol.id;
            device.type = selectedProtocol.name;
            return this.inventoryService.update(device);
        });
    }
    getAvailableProtocols(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                __filter: {
                    type: { __in: this.getProtocolTypesMatchingDevice(device) }
                },
                __orderby: [{ name: 1 }]
            };
            return this.inventoryService.listQuery(query, { withTotalPages: true, pageSize: 5 });
        });
    }
    getAvailableConnections(device) {
        return __awaiter(this, void 0, void 0, function* () {
            let list;
            const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
            const response = yield this.lnsService.list(matchingCfg.connectionType);
            if (response && response.status === 200) {
                list = yield response.json();
                list = orderBy(list, ['name'], ['asc']);
                return { res: response, data: list };
            }
        });
    }
    getProtocolTypesMatchingDevice(device) {
        const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
        return matchingCfg ? matchingCfg.protocolTypes : [];
    }
    getExternalId(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
            const externalIds = (yield this.identityService.list(device.id)).data;
            const externalId = externalIds.find(({ type }) => matchingCfg.externalIdTypes.includes(type));
            return externalId ? externalId.externalId : null;
        });
    }
}
LpwanSetDeviceProtocolService.decorators = [
    { type: Injectable }
];
LpwanSetDeviceProtocolService.ctorParameters = () => [
    { type: InventoryService },
    { type: FetchClient },
    { type: IdentityService },
    { type: MultipleLnsConnectorService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHB3YW4tc2V0LWRldmljZS1wcm90b2NvbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvdG9jb2wtbHB3YW4vbHB3YW4tc2V0LWRldmljZS1wcm90b2NvbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFFTCxnQkFBZ0IsRUFFaEIsV0FBVyxFQUVYLGVBQWUsRUFDaEIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekMsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEUsT0FBTyxFQUFzQixjQUFjLEVBQW9CLE1BQU0sd0RBQXdELENBQUM7QUFHOUgsTUFBTSxPQUFPLDZCQUE2QjtJQW9CeEMsWUFDVSxnQkFBa0MsRUFDbEMsTUFBbUIsRUFDbkIsZUFBZ0MsRUFDaEMsVUFBdUM7UUFIdkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQ25CLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQXZCakQseUJBQW9CLEdBQUc7WUFDckI7Z0JBQ0UsSUFBSSxFQUFFLE1BQU07Z0JBQ1osS0FBSyxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxpQ0FBaUMsQ0FBQyxLQUFLLE1BQU07Z0JBQzFFLGFBQWEsRUFBRSxDQUFDLHdCQUF3QixFQUFFLG9CQUFvQixFQUFFLHFCQUFxQixDQUFDO2dCQUN0RixlQUFlLEVBQUUsQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDO2dCQUNoRCxjQUFjLEVBQUUsY0FBYyxDQUFDLFFBQVE7YUFDeEM7WUFDRDtnQkFDRSxJQUFJLEVBQUUsUUFBUTtn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QUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJUmVzdWx0TGlzdCxcbiAgRmV0Y2hDbGllbnQsXG4gIElGZXRjaE9wdGlvbnMsXG4gIElkZW50aXR5U2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBnZXQsIG9yZGVyQnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgTXVsdGlwbGVMbnNDb25uZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi9tdWx0aXBsZS1sbnMtY29ubmVjdG9ycyc7XG5pbXBvcnQgeyBBY3RpbGl0eUNvbm5lY3Rpb24sIENvbm5lY3Rpb25UeXBlLCBTaWdmb3hDb25uZWN0aW9uIH0gZnJvbSAnLi9tdWx0aXBsZS1sbnMtY29ubmVjdG9ycy9tdWx0aXBsZS1sbnMtY29ubmVjdG9yLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExwd2FuU2V0RGV2aWNlUHJvdG9jb2xTZXJ2aWNlIHtcbiAgc3VwcG9ydGVkRGV2aWNlc0NmZ3MgPSBbXG4gICAge1xuICAgICAgbmFtZTogJ2xvcmEnLFxuICAgICAgbWF0Y2g6IGRldmljZSA9PiBnZXQoZGV2aWNlLCAnYzh5X0xwd2FuRGV2aWNlLmxwd2FuRGV2aWNlVHlwZScpID09PSAnTG9yYScsXG4gICAgICBwcm90b2NvbFR5cGVzOiBbJ2M4eV9BY3RpbGl0eURldmljZVR5cGUnLCAnYzh5X0xvcmFEZXZpY2VUeXBlJywgJ2M4eV9McHdhbkRldmljZVR5cGUnXSxcbiAgICAgIGV4dGVybmFsSWRUeXBlczogWydjOHlfTG9yaW90RVVJJywgJ2M4eV9TZXJpYWwnXSxcbiAgICAgIGNvbm5lY3Rpb25UeXBlOiBDb25uZWN0aW9uVHlwZS5BQ1RJTElUWVxuICAgIH0sXG4gICAge1xuICAgICAgbmFtZTogJ3NpZ2ZveCcsXG4gICAgICBtYXRjaDogZGV2aWNlID0+IGdldChkZXZpY2UsICdjOHlfTHB3YW5EZXZpY2Uuc2VydmljZVByb3ZpZGVyJykgPT09ICdTaWdmb3gnLFxuICAgICAgcHJvdG9jb2xUeXBlczogWydjOHlfU2lnZm94RGV2aWNlVHlwZScsICdjOHlfTHB3YW5EZXZpY2VUeXBlJ10sXG4gICAgICBleHRlcm5hbElkVHlwZXM6IFsnY29tLnNpZ2ZveC5kZXZpY2VJZCddLFxuICAgICAgY29ubmVjdGlvblR5cGU6IENvbm5lY3Rpb25UeXBlLlNJR0ZPWFxuICAgIH1cbiAgXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGhlYWRlcjogYW55ID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCxcbiAgICBwcml2YXRlIGlkZW50aXR5U2VydmljZTogSWRlbnRpdHlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG5zU2VydmljZTogTXVsdGlwbGVMbnNDb25uZWN0b3JTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyByZWZyZXNoQ2FjaGUoZGV2aWNlKSB7XG4gICAgY29uc3QgZXh0ZXJuYWxJZCA9IGF3YWl0IHRoaXMuZ2V0RXh0ZXJuYWxJZChkZXZpY2UpO1xuICAgIGlmIChleHRlcm5hbElkKSB7XG4gICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldE1pY3Jvc2VydmljZVVybChkZXZpY2UpfS9yZWZyZXNoQ2FjaGUvJHtleHRlcm5hbElkfWA7XG4gICAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXIsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHt9KVxuICAgICAgfTtcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIGdldE1pY3Jvc2VydmljZVVybChkZXZpY2UpIHtcbiAgICBjb25zdCB7IHNlcnZpY2VQcm92aWRlciB9ID0gZGV2aWNlLmM4eV9McHdhbkRldmljZTtcblxuICAgIGxldCBzZXJ2aWNlTmFtZSA9IHNlcnZpY2VQcm92aWRlci50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChzZXJ2aWNlUHJvdmlkZXIgPT09ICdTaWdmb3gnKSB7XG4gICAgICBzZXJ2aWNlTmFtZSA9ICdzaWdmb3gtYWdlbnQnO1xuICAgIH1cblxuICAgIHJldHVybiBgL3NlcnZpY2UvJHtzZXJ2aWNlTmFtZX1gO1xuICB9XG5cbiAgaXNTdXBwb3J0ZWREZXZpY2UoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnN1cHBvcnRlZERldmljZXNDZmdzLnNvbWUoKHsgbWF0Y2ggfSkgPT4gbWF0Y2goZGV2aWNlKSk7XG4gIH1cblxuICBhc3luYyBnZXRDdXJyZW50UHJvdG9jb2woZGV2aWNlOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IGxwd2FuRGV2aWNlID0gZGV2aWNlLmM4eV9McHdhbkRldmljZTtcbiAgICBsZXQgcHJvdG9jb2xJZDtcblxuICAgIGlmIChscHdhbkRldmljZS50eXBlRXh0ZXJuYWxJZCkge1xuICAgICAgY29uc3QgZXh0ZXJuYWxJZCA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5kZXRhaWwobHB3YW5EZXZpY2UudHlwZUV4dGVybmFsSWQpKS5kYXRhO1xuICAgICAgcHJvdG9jb2xJZCA9IGV4dGVybmFsSWQubWFuYWdlZE9iamVjdC5pZDtcbiAgICB9XG5cbiAgICBpZiAoIXByb3RvY29sSWQgJiYgbHB3YW5EZXZpY2UudHlwZSkge1xuICAgICAgcHJvdG9jb2xJZCA9IGxwd2FuRGV2aWNlLnR5cGUuc3BsaXQoJy8nKVsyXTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3RvY29sSWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChwcm90b2NvbElkKSkuZGF0YTtcbiAgfVxuXG4gIGFzeW5jIGFwcGx5UHJvdG9jb2woZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgc2VsZWN0ZWRQcm90b2NvbDogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBbcHJvdG9jb2xFeHRlcm5hbElkXSA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5saXN0KHNlbGVjdGVkUHJvdG9jb2wuaWQpKS5kYXRhO1xuICAgIGNvbnN0IHsgZXh0ZXJuYWxJZCwgdHlwZSB9ID0gcHJvdG9jb2xFeHRlcm5hbElkO1xuICAgIGRldmljZS5jOHlfTHB3YW5EZXZpY2UudHlwZUV4dGVybmFsSWQgPSB7IGV4dGVybmFsSWQsIHR5cGUgfTtcbiAgICBkZXZpY2UuYzh5X0xwd2FuRGV2aWNlLnR5cGUgPSAnaW52ZW50b3J5L21hbmFnZWRPYmplY3RzLycgKyBzZWxlY3RlZFByb3RvY29sLmlkO1xuICAgIGRldmljZS50eXBlID0gc2VsZWN0ZWRQcm90b2NvbC5uYW1lO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UudXBkYXRlKGRldmljZSk7XG4gIH1cblxuICBhc3luYyBnZXRBdmFpbGFibGVQcm90b2NvbHMoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICB0eXBlOiB7IF9faW46IHRoaXMuZ2V0UHJvdG9jb2xUeXBlc01hdGNoaW5nRGV2aWNlKGRldmljZSkgfVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIHsgd2l0aFRvdGFsUGFnZXM6IHRydWUsIHBhZ2VTaXplOiA1IH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0QXZhaWxhYmxlQ29ubmVjdGlvbnMoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IFByb21pc2U8SVJlc3VsdExpc3Q8QWN0aWxpdHlDb25uZWN0aW9uIHwgU2lnZm94Q29ubmVjdGlvbj4+IHtcbiAgICBsZXQgbGlzdDtcbiAgICBjb25zdCBtYXRjaGluZ0NmZyA9IHRoaXMuc3VwcG9ydGVkRGV2aWNlc0NmZ3MuZmluZCgoeyBtYXRjaCB9KSA9PiBtYXRjaChkZXZpY2UpKTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubG5zU2VydmljZS5saXN0KG1hdGNoaW5nQ2ZnLmNvbm5lY3Rpb25UeXBlKTtcbiAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGxpc3QgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICBsaXN0ID0gb3JkZXJCeShsaXN0LCBbJ25hbWUnXSwgWydhc2MnXSk7XG4gICAgICByZXR1cm4ge3JlczogcmVzcG9uc2UgLCBkYXRhOiBsaXN0IH07XG4gICAgfVxuXG4gIH1cblxuICBwcml2YXRlIGdldFByb3RvY29sVHlwZXNNYXRjaGluZ0RldmljZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogc3RyaW5nW10ge1xuICAgIGNvbnN0IG1hdGNoaW5nQ2ZnID0gdGhpcy5zdXBwb3J0ZWREZXZpY2VzQ2Zncy5maW5kKCh7IG1hdGNoIH0pID0+IG1hdGNoKGRldmljZSkpO1xuICAgIHJldHVybiBtYXRjaGluZ0NmZyA/IG1hdGNoaW5nQ2ZnLnByb3RvY29sVHlwZXMgOiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0RXh0ZXJuYWxJZChkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBtYXRjaGluZ0NmZyA9IHRoaXMuc3VwcG9ydGVkRGV2aWNlc0NmZ3MuZmluZCgoeyBtYXRjaCB9KSA9PiBtYXRjaChkZXZpY2UpKTtcbiAgICBjb25zdCBleHRlcm5hbElkcyA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5saXN0KGRldmljZS5pZCkpLmRhdGE7XG4gICAgY29uc3QgZXh0ZXJuYWxJZCA9IGV4dGVybmFsSWRzLmZpbmQoKHsgdHlwZSB9KSA9PiBtYXRjaGluZ0NmZy5leHRlcm5hbElkVHlwZXMuaW5jbHVkZXModHlwZSkpO1xuICAgIHJldHVybiBleHRlcm5hbElkID8gZXh0ZXJuYWxJZC5leHRlcm5hbElkIDogbnVsbDtcbiAgfVxufVxuIl19