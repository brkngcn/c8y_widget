import { Injectable } from '@angular/core';
import { UserPreferencesService } from '@c8y/ngx-components';
import { isNil, omitBy, isEmpty } from 'lodash-es';
import { combineLatest, of } from 'rxjs';
import { concatMap, map } from 'rxjs/operators';
import { DeviceGridService } from './device-grid.service';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "./device-grid.service";
export class DeviceGridConfigMapperService {
    constructor(userPreferencesService, deviceGridService) {
        this.userPreferencesService = userPreferencesService;
        this.deviceGridService = deviceGridService;
    }
    getMappedGridConfig(key) {
        key = key || this.deviceGridService.GRID_CONFIG_DEFAULT_STORAGE_KEY;
        const legacyAllDevicesGridKey = 'all-devices-columns-meta_';
        const legacyAllDevicesGridFilterKey = 'all-devices-columns-config';
        return combineLatest([
            this.userPreferencesService.get(legacyAllDevicesGridKey),
            this.userPreferencesService.get(legacyAllDevicesGridFilterKey)
        ]).pipe(map(([legacyConfig, legacyFilterConfig]) => this.mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig)), concatMap(mappedLegacyConfig => {
            if (mappedLegacyConfig) {
                return Promise.all([
                    this.userPreferencesService.set(legacyAllDevicesGridKey, null),
                    this.userPreferencesService.set(legacyAllDevicesGridFilterKey, null)
                ]).then(() => mappedLegacyConfig);
            }
            else {
                return of(null);
            }
        }), concatMap(mappedLegacyConfig => mappedLegacyConfig
            ? this.userPreferencesService.set(key, mappedLegacyConfig).then(() => mappedLegacyConfig)
            : this.userPreferencesService.get(key)), map(config => config || {
            columns: [],
            pagination: {
                pageSize: this.deviceGridService.DEFAULT_PAGE_SIZE,
                currentPage: 1
            }
        }));
    }
    mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig) {
        if (Array.isArray(legacyConfig) || !isEmpty(legacyFilterConfig)) {
            return {
                columns: this.getConfigColumns(legacyConfig, legacyFilterConfig),
                pagination: {
                    pageSize: this.deviceGridService.DEFAULT_PAGE_SIZE,
                    currentPage: 1
                }
            };
        }
    }
    getConfigColumns(legacyConfig, legacyFilterConfig) {
        const legacyFilterConfigArray = legacyFilterConfig
            ? Object.keys(legacyFilterConfig).map(key => ({
                key,
                filter: {
                    externalFilterQuery: legacyFilterConfig[key].filtering
                },
                sorting: legacyFilterConfig[key].sorting
            }))
            : [];
        const config = this.mergeLegacyConfigs(legacyConfig ||
            this.deviceGridService.getDefaultColumns().map(column => ({ key: column.name })), legacyFilterConfigArray);
        return config
            .filter(column => column.key !== 'removalColumn')
            .map(this.mapLegacyColumnConfig.bind(this));
    }
    mergeLegacyConfigs(columnConfig, filterConfig) {
        return columnConfig.map(column => (Object.assign(Object.assign({}, filterConfig.find(item => item.key === column.key)), column)));
    }
    mapLegacyColumnConfig(legacy) {
        const { active, key, custom, headerName, fragmentPath, filter, sorting } = legacy;
        const sortOrder = sorting ? this.migrateSortOrder(sorting) : '';
        return omitBy({
            visible: active !== null && active !== void 0 ? active : true,
            name: DeviceGridConfigMapperService.deviceGridLegacyKeyToName[key] || key,
            sortOrder,
            custom,
            header: custom ? headerName : null,
            path: fragmentPath,
            filter
        }, isNil);
    }
    migrateSortOrder(sorting) {
        switch (sorting.order) {
            case 0:
                return '';
            case -1:
                return 'desc';
            case 1:
                return 'asc';
        }
    }
}
DeviceGridConfigMapperService.deviceGridLegacyKeyToName = {
    status: 'status',
    name: 'name',
    model: 'model',
    serialNumber: 'serialNumber',
    group: 'group',
    registrationDate: 'registrationDate',
    systemId: 'systemId',
    imei: 'imei',
    alarms: 'alarms'
};
DeviceGridConfigMapperService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DeviceGridConfigMapperService_Factory() { return new DeviceGridConfigMapperService(i0.ɵɵinject(i1.UserPreferencesService), i0.ɵɵinject(i2.DeviceGridService)); }, token: DeviceGridConfigMapperService, providedIn: "root" });
DeviceGridConfigMapperService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
DeviceGridConfigMapperService.ctorParameters = () => [
    { type: UserPreferencesService },
    { type: DeviceGridService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWdyaWQtY29uZmlnLW1hcHBlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2aWNlLWdyaWQvZGV2aWNlLWdyaWQtY29uZmlnLW1hcHBlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFrQyxzQkFBc0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzdGLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuRCxPQUFPLEVBQUUsYUFBYSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7O0FBc0IxRCxNQUFNLE9BQU8sNkJBQTZCO0lBYXhDLFlBQ1Usc0JBQThDLEVBQzlDLGlCQUFvQztRQURwQywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7SUFDM0MsQ0FBQztJQUVKLG1CQUFtQixDQUFDLEdBQVk7UUFDOUIsR0FBRyxHQUFHLEdBQUcsSUFBSyxJQUFJLENBQUMsaUJBQXlCLENBQUMsK0JBQStCLENBQUM7UUFDN0UsTUFBTSx1QkFBdUIsR0FBRywyQkFBMkIsQ0FBQztRQUM1RCxNQUFNLDZCQUE2QixHQUFHLDRCQUE0QixDQUFDO1FBQ25FLE9BQU8sYUFBYSxDQUFDO1lBQ25CLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUM7WUFDeEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQztTQUMvRCxDQUFDLENBQUMsSUFBSSxDQUNMLEdB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QUFDO1NBQ2hCO0lBQ0gsQ0FBQzs7QUFsSU0sdURBQXlCLEdBQUc7SUFDakMsTUFBTSxFQUFFLFFBQVE7SUFDaEIsSUFBSSxFQUFFLE1BQU07SUFDWixLQUFLLEVBQUUsT0FBTztJQUNkLFlBQVksRUFBRSxjQUFjO0lBQzVCLEtBQUssRUFBRSxPQUFPO0lBQ2QsZ0JBQWdCLEVBQUUsa0JBQWtCO0lBQ3BDLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLElBQUksRUFBRSxNQUFNO0lBQ1osTUFBTSxFQUFFLFFBQVE7Q0FDakIsQ0FBQzs7O1lBZEgsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUF6QndDLHNCQUFzQjtZQUl0RCxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDdXN0b21Db2x1bW5Db25maWcsIEdyaWRDb25maWcsIFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGlzTmlsLCBvbWl0QnksIGlzRW1wdHkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbmNhdE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGV2aWNlR3JpZFNlcnZpY2UgfSBmcm9tICcuL2RldmljZS1ncmlkLnNlcnZpY2UnO1xuXG5pbnRlcmZhY2UgTGVnYWN5Q29sdW1uQ29uZmlnIHtcbiAga2V5OiBzdHJpbmc7XG4gIGhlYWRlck5hbWU6IHN0cmluZztcbiAgYWN0aXZlOiBib29sZWFuO1xuICBjdXN0b206IGJvb2xlYW47XG4gIGZyYWdtZW50UGF0aDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgTGVnYWN5Q29sdW1uRmlsdGVyQ29uZmlnIHtcbiAgW2tleTogc3RyaW5nXToge1xuICAgIGZpbHRlcmluZzogb2JqZWN0O1xuICAgIHNvcnRpbmc6IHtcbiAgICAgIG9yZGVyOiBudW1iZXI7XG4gICAgfTtcbiAgfTtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRGV2aWNlR3JpZENvbmZpZ01hcHBlclNlcnZpY2Uge1xuICBzdGF0aWMgZGV2aWNlR3JpZExlZ2FjeUtleVRvTmFtZSA9IHtcbiAgICBzdGF0dXM6ICdzdGF0dXMnLFxuICAgIG5hbWU6ICduYW1lJyxcbiAgICBtb2RlbDogJ21vZGVsJyxcbiAgICBzZXJpYWxOdW1iZXI6ICdzZXJpYWxOdW1iZXInLFxuICAgIGdyb3VwOiAnZ3JvdXAnLFxuICAgIHJlZ2lzdHJhdGlvbkRhdGU6ICdyZWdpc3RyYXRpb25EYXRlJyxcbiAgICBzeXN0ZW1JZDogJ3N5c3RlbUlkJyxcbiAgICBpbWVpOiAnaW1laScsXG4gICAgYWxhcm1zOiAnYWxhcm1zJ1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdXNlclByZWZlcmVuY2VzU2VydmljZTogVXNlclByZWZlcmVuY2VzU2VydmljZSxcbiAgICBwcml2YXRlIGRldmljZUdyaWRTZXJ2aWNlOiBEZXZpY2VHcmlkU2VydmljZVxuICApIHt9XG5cbiAgZ2V0TWFwcGVkR3JpZENvbmZpZyhrZXk/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEdyaWRDb25maWc+IHtcbiAgICBrZXkgPSBrZXkgfHwgKHRoaXMuZGV2aWNlR3JpZFNlcnZpY2UgYXMgYW55KS5HUklEX0NPTkZJR19ERUZBVUxUX1NUT1JBR0VfS0VZO1xuICAgIGNvbnN0IGxlZ2FjeUFsbERldmljZXNHcmlkS2V5ID0gJ2FsbC1kZXZpY2VzLWNvbHVtbnMtbWV0YV8nO1xuICAgIGNvbnN0IGxlZ2FjeUFsbERldmljZXNHcmlkRmlsdGVyS2V5ID0gJ2FsbC1kZXZpY2VzLWNvbHVtbnMtY29uZmlnJztcbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2UuZ2V0KGxlZ2FjeUFsbERldmljZXNHcmlkS2V5KSxcbiAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5nZXQobGVnYWN5QWxsRGV2aWNlc0dyaWRGaWx0ZXJLZXkpXG4gICAgXSkucGlwZShcbiAgICAgIG1hcCgoW2xlZ2FjeUNvbmZpZywgbGVnYWN5RmlsdGVyQ29uZmlnXSkgPT5cbiAgICAgICAgdGhpcy5tYXBMZWdhY3lUb0RldmljZUdyaWRDb25maWcobGVnYWN5Q29uZmlnLCBsZWdhY3lGaWx0ZXJDb25maWcpXG4gICAgICApLFxuICAgICAgY29uY2F0TWFwKG1hcHBlZExlZ2FjeUNvbmZpZyA9PiB7XG4gICAgICAgIGlmIChtYXBwZWRMZWdhY3lDb25maWcpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLnNldChsZWdhY3lBbGxEZXZpY2VzR3JpZEtleSwgbnVsbCksXG4gICAgICAgICAgICB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2Uuc2V0KGxlZ2FjeUFsbERldmljZXNHcmlkRmlsdGVyS2V5LCBudWxsKVxuICAgICAgICAgIF0pLnRoZW4oKCkgPT4gbWFwcGVkTGVnYWN5Q29uZmlnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgY29uY2F0TWFwKG1hcHBlZExlZ2FjeUNvbmZpZyA9PlxuICAgICAgICBtYXBwZWRMZWdhY3lDb25maWdcbiAgICAgICAgICA/IHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5zZXQoa2V5LCBtYXBwZWRMZWdhY3lDb25maWcpLnRoZW4oKCkgPT4gbWFwcGVkTGVnYWN5Q29uZmlnKVxuICAgICAgICAgIDogdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLmdldChrZXkpXG4gICAgICApLFxuICAgICAgbWFwKFxuICAgICAgICBjb25maWcgPT5cbiAgICAgICAgICBjb25maWcgfHwge1xuICAgICAgICAgICAgY29sdW1uczogW10sXG4gICAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICAgIHBhZ2VTaXplOiAodGhpcy5kZXZpY2VHcmlkU2VydmljZSBhcyBhbnkpLkRFRkFVTFRfUEFHRV9TSVpFLFxuICAgICAgICAgICAgICBjdXJyZW50UGFnZTogMVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgbWFwTGVnYWN5VG9EZXZpY2VHcmlkQ29uZmlnKFxuICAgIGxlZ2FjeUNvbmZpZzogTGVnYWN5Q29sdW1uQ29uZmlnW10sXG4gICAgbGVnYWN5RmlsdGVyQ29uZmlnOiBMZWdhY3lDb2x1bW5GaWx0ZXJDb25maWdcbiAgKTogR3JpZENvbmZpZyB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkobGVnYWN5Q29uZmlnKSB8fCAhaXNFbXB0eShsZWdhY3lGaWx0ZXJDb25maWcpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb2x1bW5zOiB0aGlzLmdldENvbmZpZ0NvbHVtbnMobGVnYWN5Q29uZmlnLCBsZWdhY3lGaWx0ZXJDb25maWcpLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgcGFnZVNpemU6ICh0aGlzLmRldmljZUdyaWRTZXJ2aWNlIGFzIGFueSkuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgY3VycmVudFBhZ2U6IDFcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBnZXRDb25maWdDb2x1bW5zKFxuICAgIGxlZ2FjeUNvbmZpZzogTGVnYWN5Q29sdW1uQ29uZmlnW10sXG4gICAgbGVnYWN5RmlsdGVyQ29uZmlnOiBMZWdhY3lDb2x1bW5GaWx0ZXJDb25maWdcbiAgKSB7XG4gICAgY29uc3QgbGVnYWN5RmlsdGVyQ29uZmlnQXJyYXkgPSBsZWdhY3lGaWx0ZXJDb25maWdcbiAgICAgID8gT2JqZWN0LmtleXMobGVnYWN5RmlsdGVyQ29uZmlnKS5tYXAoa2V5ID0+ICh7XG4gICAgICAgICAga2V5LFxuICAgICAgICAgIGZpbHRlcjoge1xuICAgICAgICAgICAgZXh0ZXJuYWxGaWx0ZXJRdWVyeTogbGVnYWN5RmlsdGVyQ29uZmlnW2tleV0uZmlsdGVyaW5nXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzb3J0aW5nOiBsZWdhY3lGaWx0ZXJDb25maWdba2V5XS5zb3J0aW5nXG4gICAgICAgIH0pKVxuICAgICAgOiBbXTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMubWVyZ2VMZWdhY3lDb25maWdzKFxuICAgICAgbGVnYWN5Q29uZmlnIHx8XG4gICAgICAgIHRoaXMuZGV2aWNlR3JpZFNlcnZpY2UuZ2V0RGVmYXVsdENvbHVtbnMoKS5tYXAoY29sdW1uID0+ICh7IGtleTogY29sdW1uLm5hbWUgfSkpLFxuICAgICAgbGVnYWN5RmlsdGVyQ29uZmlnQXJyYXlcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbmZpZ1xuICAgICAgLmZpbHRlcihjb2x1bW4gPT4gY29sdW1uLmtleSAhPT0gJ3JlbW92YWxDb2x1bW4nKVxuICAgICAgLm1hcCh0aGlzLm1hcExlZ2FjeUNvbHVtbkNvbmZpZy5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG1lcmdlTGVnYWN5Q29uZmlncyhjb2x1bW5Db25maWcsIGZpbHRlckNvbmZpZykge1xuICAgIHJldHVybiBjb2x1bW5Db25maWcubWFwKGNvbHVtbiA9PiAoe1xuICAgICAgLi4uZmlsdGVyQ29uZmlnLmZpbmQoaXRlbSA9PiBpdGVtLmtleSA9PT0gY29sdW1uLmtleSksXG4gICAgICAuLi5jb2x1bW5cbiAgICB9KSk7XG4gIH1cblxuICBtYXBMZWdhY3lDb2x1bW5Db25maWcobGVnYWN5KTogQ3VzdG9tQ29sdW1uQ29uZmlnIHtcbiAgICBjb25zdCB7IGFjdGl2ZSwga2V5LCBjdXN0b20sIGhlYWRlck5hbWUsIGZyYWdtZW50UGF0aCwgZmlsdGVyLCBzb3J0aW5nIH0gPSBsZWdhY3k7XG4gICAgY29uc3Qgc29ydE9yZGVyID0gc29ydGluZyA/IHRoaXMubWlncmF0ZVNvcnRPcmRlcihzb3J0aW5nKSA6ICcnO1xuXG4gICAgcmV0dXJuIG9taXRCeShcbiAgICAgIHtcbiAgICAgICAgdmlzaWJsZTogYWN0aXZlID8/IHRydWUsXG4gICAgICAgIG5hbWU6IERldmljZUdyaWRDb25maWdNYXBwZXJTZXJ2aWNlLmRldmljZUdyaWRMZWdhY3lLZXlUb05hbWVba2V5XSB8fCBrZXksXG4gICAgICAgIHNvcnRPcmRlcixcbiAgICAgICAgY3VzdG9tLFxuICAgICAgICBoZWFkZXI6IGN1c3RvbSA/IGhlYWRlck5hbWUgOiBudWxsLFxuICAgICAgICBwYXRoOiBmcmFnbWVudFBhdGgsXG4gICAgICAgIGZpbHRlclxuICAgICAgfSxcbiAgICAgIGlzTmlsXG4gICAgKTtcbiAgfVxuXG4gIG1pZ3JhdGVTb3J0T3JkZXIoc29ydGluZykge1xuICAgIHN3aXRjaCAoc29ydGluZy5vcmRlcikge1xuICAgICAgY2FzZSAwOlxuICAgICAgICByZXR1cm4gJyc7XG4gICAgICBjYXNlIC0xOlxuICAgICAgICByZXR1cm4gJ2Rlc2MnO1xuICAgICAgY2FzZSAxOlxuICAgICAgICByZXR1cm4gJ2FzYyc7XG4gICAgfVxuICB9XG59XG4iXX0=