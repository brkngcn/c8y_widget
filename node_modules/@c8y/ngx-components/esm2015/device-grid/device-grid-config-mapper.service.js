import { Injectable } from '@angular/core';
import { UserPreferencesService } from '@c8y/ngx-components';
import { isNil, omitBy, isEmpty } from 'lodash-es';
import { combineLatest, of } from 'rxjs';
import { concatMap, map } from 'rxjs/operators';
import { DeviceGridService } from './device-grid.service';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "./device-grid.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from './device-grid.service';
export class DeviceGridConfigMapperService {
    constructor(userPreferencesService, deviceGridService) {
        this.userPreferencesService = userPreferencesService;
        this.deviceGridService = deviceGridService;
    }
    getMappedGridConfig(key) {
        key = key || this.deviceGridService.GRID_CONFIG_DEFAULT_STORAGE_KEY;
        const legacyAllDevicesGridKey = 'all-devices-columns-meta_';
        const legacyAllDevicesGridFilterKey = 'all-devices-columns-config';
        return combineLatest([
            this.userPreferencesService.get(legacyAllDevicesGridKey),
            this.userPreferencesService.get(legacyAllDevicesGridFilterKey)
        ]).pipe(map(([legacyConfig, legacyFilterConfig]) => this.mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig)), concatMap(mappedLegacyConfig => {
            if (mappedLegacyConfig) {
                return Promise.all([
                    this.userPreferencesService.set(legacyAllDevicesGridKey, null),
                    this.userPreferencesService.set(legacyAllDevicesGridFilterKey, null)
                ]).then(() => mappedLegacyConfig);
            }
            else {
                return of(null);
            }
        }), concatMap(mappedLegacyConfig => mappedLegacyConfig
            ? this.userPreferencesService.set(key, mappedLegacyConfig).then(() => mappedLegacyConfig)
            : this.userPreferencesService.get(key)), map(config => config || {
            columns: [],
            pagination: {
                pageSize: this.deviceGridService.DEFAULT_PAGE_SIZE,
                currentPage: 1
            }
        }));
    }
    mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig) {
        if (Array.isArray(legacyConfig) || !isEmpty(legacyFilterConfig)) {
            return {
                columns: this.getConfigColumns(legacyConfig, legacyFilterConfig),
                pagination: {
                    pageSize: this.deviceGridService.DEFAULT_PAGE_SIZE,
                    currentPage: 1
                }
            };
        }
    }
    getConfigColumns(legacyConfig, legacyFilterConfig) {
        const legacyFilterConfigArray = legacyFilterConfig
            ? Object.keys(legacyFilterConfig).map(key => ({
                key,
                filter: {
                    externalFilterQuery: legacyFilterConfig[key].filtering
                },
                sorting: legacyFilterConfig[key].sorting
            }))
            : [];
        const config = this.mergeLegacyConfigs(legacyConfig ||
            this.deviceGridService.getDefaultColumns().map(column => ({ key: column.name })), legacyFilterConfigArray);
        return config
            .filter(column => column.key !== 'removalColumn')
            .map(this.mapLegacyColumnConfig.bind(this));
    }
    mergeLegacyConfigs(columnConfig, filterConfig) {
        return columnConfig.map(column => (Object.assign(Object.assign({}, filterConfig.find(item => item.key === column.key)), column)));
    }
    mapLegacyColumnConfig(legacy) {
        const { active, key, custom, headerName, fragmentPath, filter, sorting } = legacy;
        const sortOrder = sorting ? this.migrateSortOrder(sorting) : '';
        return omitBy({
            visible: active !== null && active !== void 0 ? active : true,
            name: DeviceGridConfigMapperService.deviceGridLegacyKeyToName[key] || key,
            sortOrder,
            custom,
            header: custom ? headerName : null,
            path: fragmentPath,
            filter
        }, isNil);
    }
    migrateSortOrder(sorting) {
        switch (sorting.order) {
            case 0:
                return '';
            case -1:
                return 'desc';
            case 1:
                return 'asc';
        }
    }
}
DeviceGridConfigMapperService.ɵfac = function DeviceGridConfigMapperService_Factory(t) { return new (t || DeviceGridConfigMapperService)(ɵngcc0.ɵɵinject(ɵngcc1.UserPreferencesService), ɵngcc0.ɵɵinject(ɵngcc2.DeviceGridService)); };
DeviceGridConfigMapperService.deviceGridLegacyKeyToName = {
    status: 'status',
    name: 'name',
    model: 'model',
    serialNumber: 'serialNumber',
    group: 'group',
    registrationDate: 'registrationDate',
    systemId: 'systemId',
    imei: 'imei',
    alarms: 'alarms'
};
DeviceGridConfigMapperService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DeviceGridConfigMapperService_Factory() { return new DeviceGridConfigMapperService(i0.ɵɵinject(i1.UserPreferencesService), i0.ɵɵinject(i2.DeviceGridService)); }, token: DeviceGridConfigMapperService, providedIn: "root" });
DeviceGridConfigMapperService.ctorParameters = () => [
    { type: UserPreferencesService },
    { type: DeviceGridService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DeviceGridConfigMapperService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.UserPreferencesService }, { type: ɵngcc2.DeviceGridService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWdyaWQtY29uZmlnLW1hcHBlci5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZXZpY2UtZ3JpZC9kZXZpY2UtZ3JpZC1jb25maWctbWFwcGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWtDLHNCQUFzQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQ7QUFFSztBQUVNOzs7O0FBaUJYLE1BQU0sT0FBTyw2QkFBNkI7QUFDMUMsSUFZRSxZQUNVLHNCQUE4QyxFQUM5QyxpQkFBb0M7QUFDN0MsUUFGUywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO0FBQUMsUUFDL0Msc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtBQUNoRCxJQUFLLENBQUM7QUFDTixJQUNFLG1CQUFtQixDQUFDLEdBQVk7QUFBSSxRQUNsQyxHQUFHLEdBQUcsR0FBRyxJQUFLLElBQUksQ0FBQyxpQkFBeUIsQ0FBQywrQkFBK0IsQ0FBQztBQUNqRixRQUFJLE1BQU0sdUJBQXVCLEdBQUcsMkJBQTJCLENBQUM7QUFDaEUsUUFBSSxNQUFNLDZCQUE2QixHQUFHLDRCQUE0QixDQUFDO0FBQ3ZFLFFBQUksT0FBTyxhQUFhLENBQUM7QUFDekIsWUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDO0FBQzlELFlBQU0sSUFBSSxDQUFDLHNCQUFzQixD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cm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEN1c3RvbUNvbHVtbkNvbmZpZywgR3JpZENvbmZpZywgVXNlclByZWZlcmVuY2VzU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgaXNOaWwsIG9taXRCeSwgaXNFbXB0eSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEZXZpY2VHcmlkU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLWdyaWQuc2VydmljZSc7XG5cbmludGVyZmFjZSBMZWdhY3lDb2x1bW5Db25maWcge1xuICBrZXk6IHN0cmluZztcbiAgaGVhZGVyTmFtZTogc3RyaW5nO1xuICBhY3RpdmU6IGJvb2xlYW47XG4gIGN1c3RvbTogYm9vbGVhbjtcbiAgZnJhZ21lbnRQYXRoOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBMZWdhY3lDb2x1bW5GaWx0ZXJDb25maWcge1xuICBba2V5OiBzdHJpbmddOiB7XG4gICAgZmlsdGVyaW5nOiBvYmplY3Q7XG4gICAgc29ydGluZzoge1xuICAgICAgb3JkZXI6IG51bWJlcjtcbiAgICB9O1xuICB9O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBEZXZpY2VHcmlkQ29uZmlnTWFwcGVyU2VydmljZSB7XG4gIHN0YXRpYyBkZXZpY2VHcmlkTGVnYWN5S2V5VG9OYW1lID0ge1xuICAgIHN0YXR1czogJ3N0YXR1cycsXG4gICAgbmFtZTogJ25hbWUnLFxuICAgIG1vZGVsOiAnbW9kZWwnLFxuICAgIHNlcmlhbE51bWJlcjogJ3NlcmlhbE51bWJlcicsXG4gICAgZ3JvdXA6ICdncm91cCcsXG4gICAgcmVnaXN0cmF0aW9uRGF0ZTogJ3JlZ2lzdHJhdGlvbkRhdGUnLFxuICAgIHN5c3RlbUlkOiAnc3lzdGVtSWQnLFxuICAgIGltZWk6ICdpbWVpJyxcbiAgICBhbGFybXM6ICdhbGFybXMnXG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB1c2VyUHJlZmVyZW5jZXNTZXJ2aWNlOiBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGV2aWNlR3JpZFNlcnZpY2U6IERldmljZUdyaWRTZXJ2aWNlXG4gICkge31cblxuICBnZXRNYXBwZWRHcmlkQ29uZmlnKGtleT86IHN0cmluZyk6IE9ic2VydmFibGU8R3JpZENvbmZpZz4ge1xuICAgIGtleSA9IGtleSB8fCAodGhpcy5kZXZpY2VHcmlkU2VydmljZSBhcyBhbnkpLkdSSURfQ09ORklHX0RFRkFVTFRfU1RPUkFHRV9LRVk7XG4gICAgY29uc3QgbGVnYWN5QWxsRGV2aWNlc0dyaWRLZXkgPSAnYWxsLWRldmljZXMtY29sdW1ucy1tZXRhXyc7XG4gICAgY29uc3QgbGVnYWN5QWxsRGV2aWNlc0dyaWRGaWx0ZXJLZXkgPSAnYWxsLWRldmljZXMtY29sdW1ucy1jb25maWcnO1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5nZXQobGVnYWN5QWxsRGV2aWNlc0dyaWRLZXkpLFxuICAgICAgdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLmdldChsZWdhY3lBbGxEZXZpY2VzR3JpZEZpbHRlcktleSlcbiAgICBdKS5waXBlKFxuICAgICAgbWFwKChbbGVnYWN5Q29uZmlnLCBsZWdhY3lGaWx0ZXJDb25maWddKSA9PlxuICAgICAgICB0aGlzLm1hcExlZ2FjeVRvRGV2aWNlR3JpZENvbmZpZyhsZWdhY3lDb25maWcsIGxlZ2FjeUZpbHRlckNvbmZpZylcbiAgICAgICksXG4gICAgICBjb25jYXRNYXAobWFwcGVkTGVnYWN5Q29uZmlnID0+IHtcbiAgICAgICAgaWYgKG1hcHBlZExlZ2FjeUNvbmZpZykge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2Uuc2V0KGxlZ2FjeUFsbERldmljZXNHcmlkS2V5LCBudWxsKSxcbiAgICAgICAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5zZXQobGVnYWN5QWxsRGV2aWNlc0dyaWRGaWx0ZXJLZXksIG51bGwpXG4gICAgICAgICAgXSkudGhlbigoKSA9PiBtYXBwZWRMZWdhY3lDb25maWcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBjb25jYXRNYXAobWFwcGVkTGVnYWN5Q29uZmlnID0+XG4gICAgICAgIG1hcHBlZExlZ2FjeUNvbmZpZ1xuICAgICAgICAgID8gdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLnNldChrZXksIG1hcHBlZExlZ2FjeUNvbmZpZykudGhlbigoKSA9PiBtYXBwZWRMZWdhY3lDb25maWcpXG4gICAgICAgICAgOiB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2UuZ2V0KGtleSlcbiAgICAgICksXG4gICAgICBtYXAoXG4gICAgICAgIGNvbmZpZyA9PlxuICAgICAgICAgIGNvbmZpZyB8fCB7XG4gICAgICAgICAgICBjb2x1bW5zOiBbXSxcbiAgICAgICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICAgICAgcGFnZVNpemU6ICh0aGlzLmRldmljZUdyaWRTZXJ2aWNlIGFzIGFueSkuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBtYXBMZWdhY3lUb0RldmljZUdyaWRDb25maWcoXG4gICAgbGVnYWN5Q29uZmlnOiBMZWdhY3lDb2x1bW5Db25maWdbXSxcbiAgICBsZWdhY3lGaWx0ZXJDb25maWc6IExlZ2FjeUNvbHVtbkZpbHRlckNvbmZpZ1xuICApOiBHcmlkQ29uZmlnIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShsZWdhY3lDb25maWcpIHx8ICFpc0VtcHR5KGxlZ2FjeUZpbHRlckNvbmZpZykpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbHVtbnM6IHRoaXMuZ2V0Q29uZmlnQ29sdW1ucyhsZWdhY3lDb25maWcsIGxlZ2FjeUZpbHRlckNvbmZpZyksXG4gICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICBwYWdlU2l6ZTogKHRoaXMuZGV2aWNlR3JpZFNlcnZpY2UgYXMgYW55KS5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICBjdXJyZW50UGFnZTogMVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIGdldENvbmZpZ0NvbHVtbnMoXG4gICAgbGVnYWN5Q29uZmlnOiBMZWdhY3lDb2x1bW5Db25maWdbXSxcbiAgICBsZWdhY3lGaWx0ZXJDb25maWc6IExlZ2FjeUNvbHVtbkZpbHRlckNvbmZpZ1xuICApIHtcbiAgICBjb25zdCBsZWdhY3lGaWx0ZXJDb25maWdBcnJheSA9IGxlZ2FjeUZpbHRlckNvbmZpZ1xuICAgICAgPyBPYmplY3Qua2V5cyhsZWdhY3lGaWx0ZXJDb25maWcpLm1hcChrZXkgPT4gKHtcbiAgICAgICAgICBrZXksXG4gICAgICAgICAgZmlsdGVyOiB7XG4gICAgICAgICAgICBleHRlcm5hbEZpbHRlclF1ZXJ5OiBsZWdhY3lGaWx0ZXJDb25maWdba2V5XS5maWx0ZXJpbmdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNvcnRpbmc6IGxlZ2FjeUZpbHRlckNvbmZpZ1trZXldLnNvcnRpbmdcbiAgICAgICAgfSkpXG4gICAgICA6IFtdO1xuXG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5tZXJnZUxlZ2FjeUNvbmZpZ3MoXG4gICAgICBsZWdhY3lDb25maWcgfHxcbiAgICAgICAgdGhpcy5kZXZpY2VHcmlkU2VydmljZS5nZXREZWZhdWx0Q29sdW1ucygpLm1hcChjb2x1bW4gPT4gKHsga2V5OiBjb2x1bW4ubmFtZSB9KSksXG4gICAgICBsZWdhY3lGaWx0ZXJDb25maWdBcnJheVxuICAgICk7XG5cbiAgICByZXR1cm4gY29uZmlnXG4gICAgICAuZmlsdGVyKGNvbHVtbiA9PiBjb2x1bW4ua2V5ICE9PSAncmVtb3ZhbENvbHVtbicpXG4gICAgICAubWFwKHRoaXMubWFwTGVnYWN5Q29sdW1uQ29uZmlnLmJpbmQodGhpcykpO1xuICB9XG5cbiAgbWVyZ2VMZWdhY3lDb25maWdzKGNvbHVtbkNvbmZpZywgZmlsdGVyQ29uZmlnKSB7XG4gICAgcmV0dXJuIGNvbHVtbkNvbmZpZy5tYXAoY29sdW1uID0+ICh7XG4gICAgICAuLi5maWx0ZXJDb25maWcuZmluZChpdGVtID0+IGl0ZW0ua2V5ID09PSBjb2x1bW4ua2V5KSxcbiAgICAgIC4uLmNvbHVtblxuICAgIH0pKTtcbiAgfVxuXG4gIG1hcExlZ2FjeUNvbHVtbkNvbmZpZyhsZWdhY3kpOiBDdXN0b21Db2x1bW5Db25maWcge1xuICAgIGNvbnN0IHsgYWN0aXZlLCBrZXksIGN1c3RvbSwgaGVhZGVyTmFtZSwgZnJhZ21lbnRQYXRoLCBmaWx0ZXIsIHNvcnRpbmcgfSA9IGxlZ2FjeTtcbiAgICBjb25zdCBzb3J0T3JkZXIgPSBzb3J0aW5nID8gdGhpcy5taWdyYXRlU29ydE9yZGVyKHNvcnRpbmcpIDogJyc7XG5cbiAgICByZXR1cm4gb21pdEJ5KFxuICAgICAge1xuICAgICAgICB2aXNpYmxlOiBhY3RpdmUgPz8gdHJ1ZSxcbiAgICAgICAgbmFtZTogRGV2aWNlR3JpZENvbmZpZ01hcHBlclNlcnZpY2UuZGV2aWNlR3JpZExlZ2FjeUtleVRvTmFtZVtrZXldIHx8IGtleSxcbiAgICAgICAgc29ydE9yZGVyLFxuICAgICAgICBjdXN0b20sXG4gICAgICAgIGhlYWRlcjogY3VzdG9tID8gaGVhZGVyTmFtZSA6IG51bGwsXG4gICAgICAgIHBhdGg6IGZyYWdtZW50UGF0aCxcbiAgICAgICAgZmlsdGVyXG4gICAgICB9LFxuICAgICAgaXNOaWxcbiAgICApO1xuICB9XG5cbiAgbWlncmF0ZVNvcnRPcmRlcihzb3J0aW5nKSB7XG4gICAgc3dpdGNoIChzb3J0aW5nLm9yZGVyKSB7XG4gICAgICBjYXNlIDA6XG4gICAgICAgIHJldHVybiAnJztcbiAgICAgIGNhc2UgLTE6XG4gICAgICAgIHJldHVybiAnZGVzYyc7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIHJldHVybiAnYXNjJztcbiAgICB9XG4gIH1cbn1cbiJdfQ==