import { Injectable } from '@angular/core';
import { ApplicationService, GrantType, SystemOptionsService, TenantLoginOptionsService, TenantLoginOptionType, TenantOptionsService, UserManagementSource, TenantService } from '@c8y/client';
import { catchError, map } from 'rxjs/operators';
import { forkJoin, from, of } from 'rxjs';
import { defaults, omit } from 'lodash-es';
import { TenantUiService } from '@c8y/ngx-components';
import { TypedOption } from './typed-option';
export class AuthConfigurationService {
    constructor(tenantLoginOptionsService, tenantOptionsService, systemOptionsService, applicationService, tenantUiService, tenantService) {
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.tenantOptionsService = tenantOptionsService;
        this.systemOptionsService = systemOptionsService;
        this.applicationService = applicationService;
        this.tenantUiService = tenantUiService;
        this.tenantService = tenantService;
        this.systemOptionsWithDefaultValue = [
            new TypedOption('password', 'limit.validity', 'number', null),
            new TypedOption('password', 'enforce.strength', 'boolean', false),
            new TypedOption('two-factor-authentication', 'tenant-scope-settings.enabled', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enabled', 'boolean', false),
            // note: this definition is inconsistent with backend and is overridden in getSystemOptions$
            new TypedOption('two-factor-authentication', 'enforced', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enforced.group', 'string', '')
        ];
        this.tenantOptionsWithDefaultValue = [
            new TypedOption('password', 'limit.validity', 'number', 0),
            new TypedOption('password', 'strength.validity', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enabled', 'boolean', false),
            new TypedOption('two-factor-authentication', 'token.validity', 'number', 43200),
            new TypedOption('two-factor-authentication', 'pin.validity', 'number', 30),
            new TypedOption('two-factor-authentication', 'enforced', 'boolean', false),
            new TypedOption('two-factor-authentication', 'strategy', 'string', 'SMS'),
            new TypedOption('oauth.internal', 'basic-token.lifespan.seconds', 'number', null)
        ];
    }
    getAuthConfiguration$() {
        const loginOptions$ = this.getLoginOptions$();
        return forkJoin({
            loginOptions: loginOptions$,
            tenantOptions: this.getTenantOptions$(),
            systemOptions: this.getSystemOptions$(),
            smsGatewayAvailable: this.isSmsApplicationAvailable$(),
            preferredLoginOptionType: this.getPreferredLoginOptionType$(loginOptions$)
        });
    }
    save(newAuthConfiguration, previousAuthConfiguration) {
        const tenantOptions = this.prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration);
        const updateTenantOptions = tenantOptions.map(tenantOption => this.tenantOptionsService.create(tenantOption));
        const basicLoginOption = this.prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration);
        const oauthInternalLoginOption = this.prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration);
        return Promise.all([
            this.saveOrUpdateLoginOption(basicLoginOption),
            this.saveOrUpdateLoginOption(oauthInternalLoginOption),
            updateTenantOptions
        ]);
    }
    saveOrUpdateLoginOption(loginOption) {
        return loginOption.id
            ? this.tenantLoginOptionsService.update(loginOption)
            : this.tenantLoginOptionsService.create(loginOption);
    }
    prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let basicLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption.authenticationRestrictions =
            this.authenticationRestriction(newAuthConfiguration);
        basicLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption = this.removeReadOnlyFields(basicLoginOption);
        return basicLoginOption;
    }
    prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let oauthInternalLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        const sessionConfiguration = this.sessionConfiguration(newAuthConfiguration);
        sessionConfiguration !== null
            ? (oauthInternalLoginOption.sessionConfiguration = sessionConfiguration)
            : delete oauthInternalLoginOption.sessionConfiguration;
        oauthInternalLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        oauthInternalLoginOption = this.removeReadOnlyFields(oauthInternalLoginOption);
        return oauthInternalLoginOption;
    }
    originalLoginOptionWithDefaults(previousAuthConfiguration, loginOptionType) {
        return defaults({}, previousAuthConfiguration.loginOptions.find(loginOption => loginOption.type === loginOptionType), this.getDefaultLoginOption(loginOptionType));
    }
    sessionConfiguration(authConfiguration) {
        return authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration;
    }
    authenticationRestriction(authConfiguration) {
        const authenticationRestrictions = authConfiguration.loginOptions.find(this.tenantUiService.isBasic).authenticationRestrictions;
        return {
            trustedUserAgents: authenticationRestrictions.trustedUserAgents.filter(value => value),
            forbiddenUserAgents: authenticationRestrictions.forbiddenUserAgents.filter(value => value),
            forbiddenClients: authenticationRestrictions.forbiddenClients.filter(value => value)
        };
    }
    visibleOnLoginPage(authConfiguration, loginOptionType) {
        return authConfiguration.preferredLoginOptionType === loginOptionType;
    }
    removeReadOnlyFields(tenantLoginOption) {
        return omit(tenantLoginOption, [
            'self',
            'strengthValidity',
            'tfaStrategy',
            'greenMinLength',
            'enforceStrength',
            'strengthValidity',
            '_type'
        ]);
    }
    prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration) {
        const getValue = (authCfg, tenantOption) => authCfg.tenantOptions[tenantOption.category][tenantOption.key];
        const hasChanged = tenantOption => getValue(newAuthConfiguration, tenantOption) !==
            getValue(previousAuthConfiguration, tenantOption);
        return this.tenantOptionsWithDefaultValue
            .filter(tenantOption => getValue(newAuthConfiguration, tenantOption) !== null)
            .filter(tenantOption => hasChanged(tenantOption))
            .map(tenantOption => ({
            category: tenantOption.category,
            key: tenantOption.key,
            value: getValue(newAuthConfiguration, tenantOption).toString()
        }));
    }
    getLoginOptions$() {
        return from(this.tenantLoginOptionsService.listForCurrentTenant()).pipe(map(res => res.data), map(loginOptions => this.addDefaultLoginOptions(loginOptions)));
    }
    getPreferredLoginOptionType$(loginOptions$) {
        return loginOptions$.pipe(map(loginOptions => {
            return this.tenantUiService.getPreferredLoginOption(loginOptions).type;
        }));
    }
    addDefaultLoginOptions(loginOptions) {
        if (!loginOptions.find(this.tenantUiService.isBasic)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.BASIC));
        }
        if (!loginOptions.find(this.tenantUiService.isOauthInternal)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.OAUTH2_INTERNAL));
        }
        return loginOptions;
    }
    getTenantOptions$() {
        return forkJoin(this.tenantOptionsWithDefaultValue.map((option) => from(this.tenantOptionsService.detail(option)).pipe(map(res => {
            option.apply(res.data);
            return option;
        }), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    getSystemOptions$() {
        return forkJoin(this.systemOptionsWithDefaultValue.map((option) => {
            const fixedOption = this.fixTfaEnforcedSystemOption(option);
            if (fixedOption) {
                return fixedOption;
            }
            return from(this.systemOptionsService.detail(option)).pipe(map(res => {
                option.apply(res.data);
                return option;
            }), catchError(() => of(option)));
        })).pipe(map(options => this.getOptionsObject(options)));
    }
    /**
     * Returns an observable with fixed `two-factor-authentication.enforced` system option or null.
     * This method fixes problem with inconsistent value. System option `two-factor-authentication.enforced` is list of tenants when UI using boolean value.
     * This part will be removed after implementing new endpoint in MTM-50490.
     */
    fixTfaEnforcedSystemOption(option) {
        if (option.category === 'two-factor-authentication' && option.key === 'enforced') {
            return from(this.tenantService.getTfaSettings(this.tenantUiService.currentTenant)).pipe(map(tfaSettings => {
                option.value = tfaSettings.enforcedOnSystemLevel.toString();
                return option;
            }));
        }
        return null;
    }
    isSmsApplicationAvailable$() {
        return from(this.applicationService.isAvailable('sms-gateway')).pipe(map(res => res.data));
    }
    getOptionsObject(options) {
        return options.reduce((optionsObject, option) => {
            optionsObject[option.category] = optionsObject[option.category] || {};
            optionsObject[option.category][option.key] = option.getValue();
            return optionsObject;
        }, {});
    }
    getDefaultLoginOption(tenantLoginOptionType) {
        return {
            userManagementSource: UserManagementSource.INTERNAL,
            grantType: GrantType.PASSWORD,
            providerName: 'Cumulocity',
            visibleOnLoginPage: false,
            type: tenantLoginOptionType
        };
    }
}
AuthConfigurationService.decorators = [
    { type: Injectable }
];
AuthConfigurationService.ctorParameters = () => [
    { type: TenantLoginOptionsService },
    { type: TenantOptionsService },
    { type: SystemOptionsService },
    { type: ApplicationService },
    { type: TenantUiService },
    { type: TenantService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9hdXRoLWNvbmZpZ3VyYXRpb24vYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFNBQVMsRUFJVCxvQkFBb0IsRUFDcEIseUJBQXlCLEVBQ3pCLHFCQUFxQixFQUNyQixvQkFBb0IsRUFDcEIsb0JBQW9CLEVBQ3BCLGFBQWEsRUFDZCxNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzdDLE1BQU0sT0FBTyx3QkFBd0I7SUF1Qm5DLFlBQ1UseUJBQW9ELEVBQ3BELG9CQUEwQyxFQUMxQyxvQkFBMEMsRUFDMUMsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLGFBQTRCO1FBTDVCLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBM0I5QixrQ0FBNkIsR0FBa0I7WUFDckQsSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUM7WUFDN0QsSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFLGtCQUFrQixFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDakUsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsK0JBQStCLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQztZQUMvRixJQUFJLFdBQVcsQ0FBQywyQkFBMkIsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQztZQUN6RSw0RkFBNEY7WUFDNUYsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDMUUsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQztTQUM3RSxDQUFDO1FBRU0sa0NBQTZCLEdBQWtCO1lBQ3JELElBQUksV0FBVyxDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQzFELElBQUksV0FBVyxDQUFDLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDO1lBQ2xFLElBQUksV0FBVyxDQUFDLDJCQUEyQixFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDO1lBQ3pFLElBQUksV0FBVyxDQUFDLDJCQUEyQixFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUM7WUFDL0UsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUM7WUFDMUUsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDMUUsSUFBSSxXQUFXLENBQUMsMkJBQTJCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUM7WUFDekUsSUFBSSxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsOEJBQThCLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQztTQUNsRixDQUFDO0lBU0MsQ0FBQztJQUVKLHFCQUFxQjtRQUNuQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM5QyxPQUFPLFFBQVEsQ0FBQztZQUNkLFlBQVksRUFBRSxhQUFhO1lBQzNCLGFBQWEsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDdkMsYUFBYSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUN2QyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsMEJBQTBCLEVBQUU7WUFDdEQsd0JBQXdCLEVBQUUsSUFBSSxDQUFDLDRCQUE0QixDQUFDLGFBQWEsQ0FBQztTQUMzRSxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLG9CQUF1QyxFQUFFLHlCQUE0QztRQUN4RixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQzdDLG9CQUFvQixFQUNwQix5QkFBeUIsQ0FDMUIsQ0FBQztRQUNGLE1BQU0sbUJBQW1CLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FDM0MsWUFBWSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUMvRCxDQUFDO1FBQ0YsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQ25ELG9CQUFvQixFQUNwQix5QkFBeUIsQ0FDMUIsQ0FBQztRQUNGLE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLCtCQUErQixDQUNuRSxvQkFBb0IsRUFDcEIseUJBQXlCLENBQzFCLENBQUM7UUFFRixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDakIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDO1lBQzlDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx3QkFBd0IsQ0FBQztZQUN0RCxtQkFBbUI7U0FDcEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHVCQUF1QixDQUM3QixXQUErQjtRQUUvQixPQUFPLFdBQVcsQ0FBQyxFQUFFO1lBQ25CLENBQUMsQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztZQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sdUJBQXVCLENBQzdCLG9CQUF1QyxFQUN2Qyx5QkFBNEM7UUFFNUMsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsK0JBQStCLENBQ3pELHlCQUF5QixFQUN6QixxQkFBcUIsQ0FBQyxLQUFLLENBQzVCLENBQUM7UUFDRixnQkFBZ0IsQ0FBQywwQkFBMEI7WUFDekMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDdkQsZ0JBQWdCLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUMzRCxvQkFBb0IsRUFDcEIscUJBQXFCLENBQUMsS0FBSyxDQUM1QixDQUFDO1FBQ0YsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDL0QsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0lBRU8sK0JBQStCLENBQ3JDLG9CQUF1QyxFQUN2Qyx5QkFBNEM7UUFFNUMsSUFBSSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsK0JBQStCLENBQ2pFLHlCQUF5QixFQUN6QixxQkFBcUIsQ0FBQyxlQUFlLENBQ3RDLENBQUM7UUFDRixNQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzdFLG9CQUFvQixLQUFLLElBQUk7WUFDM0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7WUFDeEUsQ0FBQyxDQUFDLE9BQU8sd0JBQXdCLENBQUMsb0JBQW9CLENBQUM7UUFDekQsd0JBQXdCLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUNuRSxvQkFBb0IsRUFDcEIscUJBQXFCLENBQUMsZUFBZSxDQUN0QyxDQUFDO1FBQ0Ysd0JBQXdCLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDL0UsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDO0lBRU8sK0JBQStCLENBQ3JDLHlCQUE0QyxFQUM1QyxlQUFzQztRQUV0QyxPQUFPLFFBQVEsQ0FDYixFQUFFLEVBQ0YseUJBQXlCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FDekMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLGVBQWUsQ0FDcEQsRUFDRCxJQUFJLENBQUMscUJBQXFCLENBQUMsZUFBZSxDQUFDLENBQzVDLENBQUM7SUFDSixDQUFDO0lBRU8sb0JBQW9CLENBQUMsaUJBQW9DO1FBQy9ELE9BQU8saUJBQWlCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQzthQUM3RSxvQkFBb0IsQ0FBQztJQUMxQixDQUFDO0lBRU8seUJBQXlCLENBQUMsaUJBQW9DO1FBQ3BFLE1BQU0sMEJBQTBCLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FDcEUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQzdCLENBQUMsMEJBQTBCLENBQUM7UUFDN0IsT0FBTztZQUNMLGlCQUFpQixFQUFFLDBCQUEwQixDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQztZQUN0RixtQkFBbUIsRUFBRSwwQkFBMEIsQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUM7WUFDMUYsZ0JBQWdCLEVBQUUsMEJBQTBCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDO1NBQ3JGLENBQUM7SUFDSixDQUFDO0lBRU8sa0JBQWtCLENBQ3hCLGlCQUFvQyxFQUNwQyxlQUFzQztRQUV0QyxPQUFPLGlCQUFpQixDQUFDLHdCQUF3QixLQUFLLGVBQWUsQ0FBQztJQUN4RSxDQUFDO0lBRU8sb0JBQW9CLENBQUMsaUJBQXFDO1FBQ2hFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzdCLE1BQU07WUFDTixrQkFBa0I7WUFDbEIsYUFBYTtZQUNiLGdCQUFnQjtZQUNoQixpQkFBaUI7WUFDakIsa0JBQWtCO1lBQ2xCLE9BQU87U0FDUixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sb0JBQW9CLENBQzFCLG9CQUF1QyxFQUN2Qyx5QkFBNEM7UUFFNUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLEVBQUUsQ0FDekMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxFQUFFLENBQ2hDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUM7WUFDNUMsUUFBUSxDQUFDLHlCQUF5QixFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXBELE9BQU8sSUFBSSxDQUFDLDZCQUE2QjthQUN0QyxNQUFNLENBQUUsWUFBWSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUUsWUFBWSxDQUFDLEtBQUssSUFBSSxDQUFDO2FBQzlFLE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUNoRCxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3BCLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUTtZQUMvQixHQUFHLEVBQUUsWUFBWSxDQUFDLEdBQUc7WUFDckIsS0FBSyxFQUFFLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUMsQ0FBQyxRQUFRLEVBQUU7U0FDL0QsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNyRSxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQ3BCLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUMvRCxDQUFDO0lBQ0osQ0FBQztJQUVPLDRCQUE0QixDQUFDLGFBQStDO1FBQ2xGLE9BQU8sYUFBYSxDQUFDLElBQUksQ0FDdkIsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDekUsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxZQUFrQztRQUMvRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3BELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDNUU7UUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQzVELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7U0FDdEY7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLE9BQU8sUUFBUSxDQUNiLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFtQixFQUFFLEVBQUUsQ0FDN0QsSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ2pELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNSLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZCLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDN0IsQ0FDRixDQUNGLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixPQUFPLFFBQVEsQ0FDYixJQUFJLENBQUMsNkJBQTZCLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBbUIsRUFBRSxFQUFFO1lBQzdELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM1RCxJQUFJLFdBQVcsRUFBRTtnQkFDZixPQUFPLFdBQVcsQ0FBQzthQUNwQjtZQUVELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ3hELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDUixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkIsT0FBTyxNQUFNLENBQUM7WUFDaEIsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUM3QixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLDBCQUEwQixDQUFDLE1BQW1CO1FBQ3BELElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSywyQkFBMkIsSUFBSSxNQUFNLENBQUMsR0FBRyxLQUFLLFVBQVUsRUFBRTtZQUNoRixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNyRixHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ2hCLE1BQU0sQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLHFCQUFxQixDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUM1RCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO1NBQ0g7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTywwQkFBMEI7UUFDaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM3RixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsT0FBc0I7UUFDN0MsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsYUFBYSxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzlDLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdEUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQy9ELE9BQU8sYUFBYSxDQUFDO1FBQ3ZCLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxxQkFBNEM7UUFDeEUsT0FBTztZQUNMLG9CQUFvQixFQUFFLG9CQUFvQixDQUFDLFFBQVE7WUFDbkQsU0FBUyxFQUFFLFNBQVMsQ0FBQyxRQUFRO1lBQzdCLFlBQVksRUFBRSxZQUFZO1lBQzFCLGtCQUFrQixFQUFFLEtBQUs7WUFDekIsSUFBSSxFQUFFLHFCQUFxQjtTQUM1QixDQUFDO0lBQ0osQ0FBQzs7O1lBclJGLFVBQVU7OztZQWJULHlCQUF5QjtZQUV6QixvQkFBb0I7WUFIcEIsb0JBQW9CO1lBTHBCLGtCQUFrQjtZQWdCWCxlQUFlO1lBTnRCLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBBcHBsaWNhdGlvblNlcnZpY2UsXG4gIEdyYW50VHlwZSwgSUF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zLFxuICBJUmVzdWx0LCBJU2Vzc2lvbkNvbmZpZ3VyYXRpb24sXG4gIElUZW5hbnRMb2dpbk9wdGlvbixcbiAgSVRlbmFudE9wdGlvbixcbiAgU3lzdGVtT3B0aW9uc1NlcnZpY2UsXG4gIFRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UsXG4gIFRlbmFudExvZ2luT3B0aW9uVHlwZSxcbiAgVGVuYW50T3B0aW9uc1NlcnZpY2UsXG4gIFVzZXJNYW5hZ2VtZW50U291cmNlLFxuICBUZW5hbnRTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVmYXVsdHMsIG9taXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQXV0aENvbmZpZ3VyYXRpb24sIE9wdGlvbnMgfSBmcm9tICcuL2F1dGgtY29uZmlndXJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBUZW5hbnRVaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFR5cGVkT3B0aW9uIH0gZnJvbSAnLi90eXBlZC1vcHRpb24nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aENvbmZpZ3VyYXRpb25TZXJ2aWNlIHtcblxuICBwcml2YXRlIHN5c3RlbU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlOiBUeXBlZE9wdGlvbltdID0gW1xuICAgIG5ldyBUeXBlZE9wdGlvbigncGFzc3dvcmQnLCAnbGltaXQudmFsaWRpdHknLCAnbnVtYmVyJywgbnVsbCksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdwYXNzd29yZCcsICdlbmZvcmNlLnN0cmVuZ3RoJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ3RlbmFudC1zY29wZS1zZXR0aW5ncy5lbmFibGVkJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ2VuYWJsZWQnLCAnYm9vbGVhbicsIGZhbHNlKSxcbiAgICAvLyBub3RlOiB0aGlzIGRlZmluaXRpb24gaXMgaW5jb25zaXN0ZW50IHdpdGggYmFja2VuZCBhbmQgaXMgb3ZlcnJpZGRlbiBpbiBnZXRTeXN0ZW1PcHRpb25zJFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZCcsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZC5ncm91cCcsICdzdHJpbmcnLCAnJylcbiAgXTtcblxuICBwcml2YXRlIHRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlOiBUeXBlZE9wdGlvbltdID0gW1xuICAgIG5ldyBUeXBlZE9wdGlvbigncGFzc3dvcmQnLCAnbGltaXQudmFsaWRpdHknLCAnbnVtYmVyJywgMCksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdwYXNzd29yZCcsICdzdHJlbmd0aC52YWxpZGl0eScsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmFibGVkJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ3Rva2VuLnZhbGlkaXR5JywgJ251bWJlcicsIDQzMjAwKSwgLy8gMzAgZGF5c1xuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdwaW4udmFsaWRpdHknLCAnbnVtYmVyJywgMzApLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZCcsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdzdHJhdGVneScsICdzdHJpbmcnLCAnU01TJyksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdvYXV0aC5pbnRlcm5hbCcsICdiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJywgJ251bWJlcicsIG51bGwpXG4gIF07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0ZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50T3B0aW9uc1NlcnZpY2U6IFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3lzdGVtT3B0aW9uc1NlcnZpY2U6IFN5c3RlbU9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwbGljYXRpb25TZXJ2aWNlOiBBcHBsaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRVaVNlcnZpY2U6IFRlbmFudFVpU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudFNlcnZpY2U6IFRlbmFudFNlcnZpY2VcbiAgKSB7fVxuXG4gIGdldEF1dGhDb25maWd1cmF0aW9uJCgpOiBPYnNlcnZhYmxlPEF1dGhDb25maWd1cmF0aW9uPiB7XG4gICAgY29uc3QgbG9naW5PcHRpb25zJCA9IHRoaXMuZ2V0TG9naW5PcHRpb25zJCgpO1xuICAgIHJldHVybiBmb3JrSm9pbih7XG4gICAgICBsb2dpbk9wdGlvbnM6IGxvZ2luT3B0aW9ucyQsXG4gICAgICB0ZW5hbnRPcHRpb25zOiB0aGlzLmdldFRlbmFudE9wdGlvbnMkKCksXG4gICAgICBzeXN0ZW1PcHRpb25zOiB0aGlzLmdldFN5c3RlbU9wdGlvbnMkKCksXG4gICAgICBzbXNHYXRld2F5QXZhaWxhYmxlOiB0aGlzLmlzU21zQXBwbGljYXRpb25BdmFpbGFibGUkKCksXG4gICAgICBwcmVmZXJyZWRMb2dpbk9wdGlvblR5cGU6IHRoaXMuZ2V0UHJlZmVycmVkTG9naW5PcHRpb25UeXBlJChsb2dpbk9wdGlvbnMkKVxuICAgIH0pO1xuICB9XG5cbiAgc2F2ZShuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uKSB7XG4gICAgY29uc3QgdGVuYW50T3B0aW9ucyA9IHRoaXMucHJlcGFyZVRlbmFudE9wdGlvbnMoXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb25cbiAgICApO1xuICAgIGNvbnN0IHVwZGF0ZVRlbmFudE9wdGlvbnMgPSB0ZW5hbnRPcHRpb25zLm1hcChcbiAgICAgIHRlbmFudE9wdGlvbiA9PiB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmNyZWF0ZSh0ZW5hbnRPcHRpb24pXG4gICAgKTtcbiAgICBjb25zdCBiYXNpY0xvZ2luT3B0aW9uID0gdGhpcy5wcmVwYXJlQmFzaWNMb2dpbk9wdGlvbihcbiAgICAgIG5ld0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvblxuICAgICk7XG4gICAgY29uc3Qgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uID0gdGhpcy5wcmVwYXJlT2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uXG4gICAgKTtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnNhdmVPclVwZGF0ZUxvZ2luT3B0aW9uKGJhc2ljTG9naW5PcHRpb24pLFxuICAgICAgdGhpcy5zYXZlT3JVcGRhdGVMb2dpbk9wdGlvbihvYXV0aEludGVybmFsTG9naW5PcHRpb24pLFxuICAgICAgdXBkYXRlVGVuYW50T3B0aW9uc1xuICAgIF0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzYXZlT3JVcGRhdGVMb2dpbk9wdGlvbihcbiAgICBsb2dpbk9wdGlvbjogSVRlbmFudExvZ2luT3B0aW9uXG4gICk6IFByb21pc2U8SVJlc3VsdDxJVGVuYW50TG9naW5PcHRpb24+PiB7XG4gICAgcmV0dXJuIGxvZ2luT3B0aW9uLmlkXG4gICAgICA/IHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS51cGRhdGUobG9naW5PcHRpb24pXG4gICAgICA6IHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS5jcmVhdGUobG9naW5PcHRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlQmFzaWNMb2dpbk9wdGlvbihcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICBsZXQgYmFzaWNMb2dpbk9wdGlvbiA9IHRoaXMub3JpZ2luYWxMb2dpbk9wdGlvbldpdGhEZWZhdWx0cyhcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUNcbiAgICApO1xuICAgIGJhc2ljTG9naW5PcHRpb24uYXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMgPVxuICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblJlc3RyaWN0aW9uKG5ld0F1dGhDb25maWd1cmF0aW9uKTtcbiAgICBiYXNpY0xvZ2luT3B0aW9uLnZpc2libGVPbkxvZ2luUGFnZSA9IHRoaXMudmlzaWJsZU9uTG9naW5QYWdlKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUNcbiAgICApO1xuICAgIGJhc2ljTG9naW5PcHRpb24gPSB0aGlzLnJlbW92ZVJlYWRPbmx5RmllbGRzKGJhc2ljTG9naW5PcHRpb24pO1xuICAgIHJldHVybiBiYXNpY0xvZ2luT3B0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlT2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uKFxuICAgIG5ld0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvblxuICApOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIGxldCBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLm9yaWdpbmFsTG9naW5PcHRpb25XaXRoRGVmYXVsdHMoXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTFxuICAgICk7XG4gICAgY29uc3Qgc2Vzc2lvbkNvbmZpZ3VyYXRpb24gPSB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uKG5ld0F1dGhDb25maWd1cmF0aW9uKTtcbiAgICBzZXNzaW9uQ29uZmlndXJhdGlvbiAhPT0gbnVsbFxuICAgICAgPyAob2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnNlc3Npb25Db25maWd1cmF0aW9uID0gc2Vzc2lvbkNvbmZpZ3VyYXRpb24pXG4gICAgICA6IGRlbGV0ZSBvYXV0aEludGVybmFsTG9naW5PcHRpb24uc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gICAgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnZpc2libGVPbkxvZ2luUGFnZSA9IHRoaXMudmlzaWJsZU9uTG9naW5QYWdlKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuT0FVVEgyX0lOVEVSTkFMXG4gICAgKTtcbiAgICBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLnJlbW92ZVJlYWRPbmx5RmllbGRzKG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbik7XG4gICAgcmV0dXJuIG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgb3JpZ2luYWxMb2dpbk9wdGlvbldpdGhEZWZhdWx0cyhcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBsb2dpbk9wdGlvblR5cGU6IFRlbmFudExvZ2luT3B0aW9uVHlwZVxuICApOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIHJldHVybiBkZWZhdWx0cyhcbiAgICAgIHt9LFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbi5sb2dpbk9wdGlvbnMuZmluZChcbiAgICAgICAgbG9naW5PcHRpb24gPT4gbG9naW5PcHRpb24udHlwZSA9PT0gbG9naW5PcHRpb25UeXBlXG4gICAgICApLFxuICAgICAgdGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24obG9naW5PcHRpb25UeXBlKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNlc3Npb25Db25maWd1cmF0aW9uKGF1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbik6IElTZXNzaW9uQ29uZmlndXJhdGlvbiB7XG4gICAgcmV0dXJuIGF1dGhDb25maWd1cmF0aW9uLmxvZ2luT3B0aW9ucy5maW5kKHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbClcbiAgICAgIC5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgYXV0aGVudGljYXRpb25SZXN0cmljdGlvbihhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24pOiBJQXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMge1xuICAgIGNvbnN0IGF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zID0gYXV0aENvbmZpZ3VyYXRpb24ubG9naW5PcHRpb25zLmZpbmQoXG4gICAgICB0aGlzLnRlbmFudFVpU2VydmljZS5pc0Jhc2ljXG4gICAgKS5hdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucztcbiAgICByZXR1cm4ge1xuICAgICAgdHJ1c3RlZFVzZXJBZ2VudHM6IGF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zLnRydXN0ZWRVc2VyQWdlbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSksXG4gICAgICBmb3JiaWRkZW5Vc2VyQWdlbnRzOiBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucy5mb3JiaWRkZW5Vc2VyQWdlbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSksXG4gICAgICBmb3JiaWRkZW5DbGllbnRzOiBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucy5mb3JiaWRkZW5DbGllbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSlcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB2aXNpYmxlT25Mb2dpblBhZ2UoXG4gICAgYXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLFxuICAgIGxvZ2luT3B0aW9uVHlwZTogVGVuYW50TG9naW5PcHRpb25UeXBlXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBhdXRoQ29uZmlndXJhdGlvbi5wcmVmZXJyZWRMb2dpbk9wdGlvblR5cGUgPT09IGxvZ2luT3B0aW9uVHlwZTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlUmVhZE9ubHlGaWVsZHModGVuYW50TG9naW5PcHRpb246IElUZW5hbnRMb2dpbk9wdGlvbik6IElUZW5hbnRMb2dpbk9wdGlvbiB7XG4gICAgcmV0dXJuIG9taXQodGVuYW50TG9naW5PcHRpb24sIFtcbiAgICAgICdzZWxmJyxcbiAgICAgICdzdHJlbmd0aFZhbGlkaXR5JyxcbiAgICAgICd0ZmFTdHJhdGVneScsXG4gICAgICAnZ3JlZW5NaW5MZW5ndGgnLFxuICAgICAgJ2VuZm9yY2VTdHJlbmd0aCcsXG4gICAgICAnc3RyZW5ndGhWYWxpZGl0eScsXG4gICAgICAnX3R5cGUnXG4gICAgXSk7XG4gIH1cblxuICBwcml2YXRlIHByZXBhcmVUZW5hbnRPcHRpb25zKFxuICAgIG5ld0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvblxuICApOiBJVGVuYW50T3B0aW9uW10ge1xuICAgIGNvbnN0IGdldFZhbHVlID0gKGF1dGhDZmcsIHRlbmFudE9wdGlvbikgPT5cbiAgICAgIGF1dGhDZmcudGVuYW50T3B0aW9uc1t0ZW5hbnRPcHRpb24uY2F0ZWdvcnldW3RlbmFudE9wdGlvbi5rZXldO1xuICAgIGNvbnN0IGhhc0NoYW5nZWQgPSB0ZW5hbnRPcHRpb24gPT5cbiAgICAgIGdldFZhbHVlKG5ld0F1dGhDb25maWd1cmF0aW9uLCB0ZW5hbnRPcHRpb24pICE9PVxuICAgICAgZ2V0VmFsdWUocHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKTtcblxuICAgIHJldHVybiB0aGlzLnRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlXG4gICAgICAuZmlsdGVyKCB0ZW5hbnRPcHRpb24gPT4gZ2V0VmFsdWUobmV3QXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbikgIT09IG51bGwpXG4gICAgICAuZmlsdGVyKHRlbmFudE9wdGlvbiA9PiBoYXNDaGFuZ2VkKHRlbmFudE9wdGlvbikpXG4gICAgICAubWFwKHRlbmFudE9wdGlvbiA9PiAoe1xuICAgICAgICBjYXRlZ29yeTogdGVuYW50T3B0aW9uLmNhdGVnb3J5LFxuICAgICAgICBrZXk6IHRlbmFudE9wdGlvbi5rZXksXG4gICAgICAgIHZhbHVlOiBnZXRWYWx1ZShuZXdBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKS50b1N0cmluZygpXG4gICAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGdldExvZ2luT3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS5saXN0Rm9yQ3VycmVudFRlbmFudCgpKS5waXBlKFxuICAgICAgbWFwKHJlcyA9PiByZXMuZGF0YSksXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+IHRoaXMuYWRkRGVmYXVsdExvZ2luT3B0aW9ucyhsb2dpbk9wdGlvbnMpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFByZWZlcnJlZExvZ2luT3B0aW9uVHlwZSQobG9naW5PcHRpb25zJDogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT4pOiBPYnNlcnZhYmxlPFRlbmFudExvZ2luT3B0aW9uVHlwZT4ge1xuICAgIHJldHVybiBsb2dpbk9wdGlvbnMkLnBpcGUoXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVuYW50VWlTZXJ2aWNlLmdldFByZWZlcnJlZExvZ2luT3B0aW9uKGxvZ2luT3B0aW9ucykudHlwZTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRGVmYXVsdExvZ2luT3B0aW9ucyhsb2dpbk9wdGlvbnM6IElUZW5hbnRMb2dpbk9wdGlvbltdKSB7XG4gICAgaWYgKCFsb2dpbk9wdGlvbnMuZmluZCh0aGlzLnRlbmFudFVpU2VydmljZS5pc0Jhc2ljKSkge1xuICAgICAgbG9naW5PcHRpb25zLnB1c2godGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24oVGVuYW50TG9naW5PcHRpb25UeXBlLkJBU0lDKSk7XG4gICAgfVxuICAgIGlmICghbG9naW5PcHRpb25zLmZpbmQodGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNPYXV0aEludGVybmFsKSkge1xuICAgICAgbG9naW5PcHRpb25zLnB1c2godGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24oVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTCkpO1xuICAgIH1cbiAgICByZXR1cm4gbG9naW5PcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUZW5hbnRPcHRpb25zJCgpOiBPYnNlcnZhYmxlPE9wdGlvbnM+IHtcbiAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICB0aGlzLnRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlLm1hcCgob3B0aW9uOiBUeXBlZE9wdGlvbikgPT5cbiAgICAgICAgZnJvbSh0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRldGFpbChvcHRpb24pKS5waXBlKFxuICAgICAgICAgIG1hcChyZXMgPT4ge1xuICAgICAgICAgICAgb3B0aW9uLmFwcGx5KHJlcy5kYXRhKTtcbiAgICAgICAgICAgIHJldHVybiBvcHRpb247XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihvcHRpb24pKVxuICAgICAgICApXG4gICAgICApXG4gICAgKS5waXBlKG1hcChvcHRpb25zID0+IHRoaXMuZ2V0T3B0aW9uc09iamVjdChvcHRpb25zKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTeXN0ZW1PcHRpb25zJCgpOiBPYnNlcnZhYmxlPE9wdGlvbnM+IHtcbiAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICB0aGlzLnN5c3RlbU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlLm1hcCgob3B0aW9uOiBUeXBlZE9wdGlvbikgPT4ge1xuICAgICAgICBjb25zdCBmaXhlZE9wdGlvbiA9IHRoaXMuZml4VGZhRW5mb3JjZWRTeXN0ZW1PcHRpb24ob3B0aW9uKTtcbiAgICAgICAgaWYgKGZpeGVkT3B0aW9uKSB7XG4gICAgICAgICAgcmV0dXJuIGZpeGVkT3B0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zeXN0ZW1PcHRpb25zU2VydmljZS5kZXRhaWwob3B0aW9uKSkucGlwZShcbiAgICAgICAgICBtYXAocmVzID0+IHtcbiAgICAgICAgICAgIG9wdGlvbi5hcHBseShyZXMuZGF0YSk7XG4gICAgICAgICAgICByZXR1cm4gb3B0aW9uO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yob3B0aW9uKSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKS5waXBlKG1hcChvcHRpb25zID0+IHRoaXMuZ2V0T3B0aW9uc09iamVjdChvcHRpb25zKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gb2JzZXJ2YWJsZSB3aXRoIGZpeGVkIGB0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uLmVuZm9yY2VkYCBzeXN0ZW0gb3B0aW9uIG9yIG51bGwuXG4gICAqIFRoaXMgbWV0aG9kIGZpeGVzIHByb2JsZW0gd2l0aCBpbmNvbnNpc3RlbnQgdmFsdWUuIFN5c3RlbSBvcHRpb24gYHR3by1mYWN0b3ItYXV0aGVudGljYXRpb24uZW5mb3JjZWRgIGlzIGxpc3Qgb2YgdGVuYW50cyB3aGVuIFVJIHVzaW5nIGJvb2xlYW4gdmFsdWUuXG4gICAqIFRoaXMgcGFydCB3aWxsIGJlIHJlbW92ZWQgYWZ0ZXIgaW1wbGVtZW50aW5nIG5ldyBlbmRwb2ludCBpbiBNVE0tNTA0OTAuXG4gICAqL1xuICBwcml2YXRlIGZpeFRmYUVuZm9yY2VkU3lzdGVtT3B0aW9uKG9wdGlvbjogVHlwZWRPcHRpb24pOiBPYnNlcnZhYmxlPFR5cGVkT3B0aW9uPiB7XG4gICAgaWYgKG9wdGlvbi5jYXRlZ29yeSA9PT0gJ3R3by1mYWN0b3ItYXV0aGVudGljYXRpb24nICYmIG9wdGlvbi5rZXkgPT09ICdlbmZvcmNlZCcpIHtcbiAgICAgIHJldHVybiBmcm9tKHRoaXMudGVuYW50U2VydmljZS5nZXRUZmFTZXR0aW5ncyh0aGlzLnRlbmFudFVpU2VydmljZS5jdXJyZW50VGVuYW50KSkucGlwZShcbiAgICAgICAgbWFwKHRmYVNldHRpbmdzID0+IHtcbiAgICAgICAgICBvcHRpb24udmFsdWUgPSB0ZmFTZXR0aW5ncy5lbmZvcmNlZE9uU3lzdGVtTGV2ZWwudG9TdHJpbmcoKTtcbiAgICAgICAgICByZXR1cm4gb3B0aW9uO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIGlzU21zQXBwbGljYXRpb25BdmFpbGFibGUkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmlzQXZhaWxhYmxlKCdzbXMtZ2F0ZXdheScpKS5waXBlKG1hcChyZXMgPT4gcmVzLmRhdGEpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3B0aW9uc09iamVjdChvcHRpb25zOiBUeXBlZE9wdGlvbltdKSB7XG4gICAgcmV0dXJuIG9wdGlvbnMucmVkdWNlKChvcHRpb25zT2JqZWN0LCBvcHRpb24pID0+IHtcbiAgICAgIG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XSA9IG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XSB8fCB7fTtcbiAgICAgIG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XVtvcHRpb24ua2V5XSA9IG9wdGlvbi5nZXRWYWx1ZSgpO1xuICAgICAgcmV0dXJuIG9wdGlvbnNPYmplY3Q7XG4gICAgfSwge30pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZWZhdWx0TG9naW5PcHRpb24odGVuYW50TG9naW5PcHRpb25UeXBlOiBUZW5hbnRMb2dpbk9wdGlvblR5cGUpOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyTWFuYWdlbWVudFNvdXJjZTogVXNlck1hbmFnZW1lbnRTb3VyY2UuSU5URVJOQUwsXG4gICAgICBncmFudFR5cGU6IEdyYW50VHlwZS5QQVNTV09SRCxcbiAgICAgIHByb3ZpZGVyTmFtZTogJ0N1bXVsb2NpdHknLFxuICAgICAgdmlzaWJsZU9uTG9naW5QYWdlOiBmYWxzZSxcbiAgICAgIHR5cGU6IHRlbmFudExvZ2luT3B0aW9uVHlwZVxuICAgIH07XG4gIH1cbn1cbiJdfQ==