import { Component, Input } from '@angular/core';
import { TenantLoginOptionType } from '@c8y/client';
import { ControlContainer, NgForm } from '@angular/forms';
import { defaults, cloneDeep, isFinite } from 'lodash-es';
import { gettext, TenantUiService } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
export class SessionConfigurationComponent {
    constructor(tenantUiService, translateService) {
        this.tenantUiService = tenantUiService;
        this.translateService = translateService;
        this.tenantLoginOptionTypeEnum = TenantLoginOptionType;
        this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE = gettext('The value must be greater than "Token lifespan" and not less than {{ minAbsoluteTimeout }}.');
        this.RENEWAL_TIMEOUT_VALIDATION_MESSAGE = gettext('The value must be less than "Token lifespan".');
        this.MAX_TOKEN_LIFESPAN_VALIDATION_MESSAGE = gettext('The value must be less than "Session absolute timeout".');
        this.MIN_TOKEN_LIFESPAN_VALIDATION_MESSAGE = gettext('The value must be greater than "Session renewal timeout".');
        this.USER_AGENT_VALIDATION_REQUIRED_POPOVER = gettext('If selected, then every request needs to use the same "User-Agent" header as the first request which initiated the session.');
        this.MIN_ABSOLUTE_TIMEOUT = 15 * 60;
        this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE = this.translateService.instant(this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE, { minAbsoluteTimeout: this.MIN_ABSOLUTE_TIMEOUT });
    }
    ngOnChanges(changes) {
        if (changes.authConfiguration && changes.authConfiguration.currentValue) {
            const oauthInternal = changes.authConfiguration.currentValue.loginOptions.find(this.tenantUiService.isOauthInternal) || {};
            this.originalSessionConfiguration = cloneDeep(oauthInternal.sessionConfiguration);
            this.sessionConfiguration = oauthInternal.sessionConfiguration;
            this.previousTokenLifespan = this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'];
        }
    }
    get renewalTimeoutSeconds() {
        const sessionConfiguration = this.sessionConfiguration;
        return this.convertToSeconds(sessionConfiguration.renewalTimeoutMillis);
    }
    set renewalTimeoutSeconds(value) {
        this.sessionConfiguration.renewalTimeoutMillis = this.convertToMillis(value);
    }
    get absoluteTimeoutSeconds() {
        const sessionConfiguration = this.sessionConfiguration;
        return this.convertToSeconds(sessionConfiguration.absoluteTimeoutMillis);
    }
    set absoluteTimeoutSeconds(value) {
        this.sessionConfiguration.absoluteTimeoutMillis = this.convertToMillis(value);
    }
    get maximumNumberOfParallelSessions() {
        return this.sessionConfiguration.maximumNumberOfParallelSessions;
    }
    set maximumNumberOfParallelSessions(value) {
        this.sessionConfiguration.maximumNumberOfParallelSessions = value;
    }
    get userAgentValidationRequired() {
        return this.sessionConfiguration.userAgentValidationRequired;
    }
    set userAgentValidationRequired(value) {
        this.sessionConfiguration.userAgentValidationRequired = value;
    }
    get basicTokenLifespan() {
        return this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'];
    }
    set basicTokenLifespan(value) {
        this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'] = value;
    }
    get useSessionConfiguration() {
        return !!this.sessionConfiguration;
    }
    set useSessionConfiguration(value) {
        this.sessionConfiguration = value ? defaults({}, this.originalSessionConfiguration, {
            absoluteTimeoutMillis: 1209600000,
            renewalTimeoutMillis: 86400000,
            maximumNumberOfParallelSessions: 5,
            userAgentValidationRequired: false
        }) : null;
        this.basicTokenLifespan = this.previousTokenLifespan || 172800; // 2 days
    }
    get absoluteTimeoutConstraints() {
        return {
            min: Math.max(this.MIN_ABSOLUTE_TIMEOUT, this.basicTokenLifespan + 1)
        };
    }
    get renewalTimeoutConstraints() {
        return {
            min: this.MIN_ABSOLUTE_TIMEOUT / 2,
            max: this.basicTokenLifespan ? this.basicTokenLifespan - 1 : null
        };
    }
    get basicTokenLifespanConstraints() {
        return {
            min: this.renewalTimeoutSeconds ? this.renewalTimeoutSeconds + 1 : null,
            max: this.absoluteTimeoutSeconds ? this.absoluteTimeoutSeconds - 1 : null
        };
    }
    get sessionConfiguration() {
        return this.authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration;
    }
    set sessionConfiguration(value) {
        this.authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration = value;
    }
    convertToMillis(seconds) {
        return isFinite(seconds) ? seconds * 1000 : null;
    }
    convertToSeconds(milliseconds) {
        return isFinite(milliseconds) ? Math.ceil(milliseconds / 1000) : null;
    }
}
SessionConfigurationComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-session-configuration',
                template: "<div class=\"card-block separator-top overflow-auto\" *ngIf=\"authConfiguration.preferredLoginOptionType === tenantLoginOptionTypeEnum.OAUTH2_INTERNAL\">\n  <div class=\"col-sm-2\">\n    <h4 class=\"text-right\">{{ 'OAI-Secure session configuration' | translate }}</h4>\n  </div>\n\n  <div class=\"col-sm-9\">\n    <div class=\"row\">\n      <div class=\"col-sm-6\">\n        <c8y-form-group>\n          <label class=\"c8y-switch\" title=\"{{ 'Use session configuration' | translate }}\">\n            <input\n              type=\"checkbox\"\n              name=\"useSessionConfiguration\"\n              [(ngModel)]=\"useSessionConfiguration\"\n            />\n            <span></span>\n            <span>{{ 'Use session configuration' | translate }}</span>\n          </label>\n        </c8y-form-group>\n      </div>\n    </div>\n\n    <fieldset *ngIf=\"sessionConfiguration\">\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label class=\"c8y-switch\" title=\"{{ 'User agent validation required' | translate }}\">\n              <input\n                type=\"checkbox\"\n                name=\"userAgentValidationRequired\"\n                [(ngModel)]=\"userAgentValidationRequired\"\n              />\n              <span></span>\n              <span>{{ 'User agent validation required' | translate }}</span>\n              <button\n                class=\"btn btn-clean\"\n                popover=\"{{ USER_AGENT_VALIDATION_REQUIRED_POPOVER | translate }}\"\n                placement=\"right\"\n                [outsideClick]=\"true\"\n                container=\"body\"\n              >\n                <i [c8yIcon]=\"'question-circle-o'\" class=\"text-info\"></i>\n              </button>\n            </label>\n          </c8y-form-group>\n        </div>\n      </div>\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Session absolute timeout' | translate }}\">{{ 'Session absolute timeout' | translate }}\n            </label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"absoluteTimeoutSeconds\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"absoluteTimeoutSeconds\"\n                [required]=\"useSessionConfiguration\"\n                [min]=\"absoluteTimeoutConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"min\"\n                text=\"{{ ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Session renewal timeout' | translate }}\">{{ 'Session renewal timeout' | translate }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"renewalTimeoutSeconds\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"renewalTimeoutSeconds\"\n                [required]=\"useSessionConfiguration\"\n                [max]=\"renewalTimeoutConstraints.max\"\n                [min]=\"renewalTimeoutConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"max\"\n                text=\"{{ RENEWAL_TIMEOUT_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Maximum parallel sessions per user' | translate }}\">{{\n              'Maximum parallel sessions per user' | translate\n            }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"maximumNumberOfParallelSessions\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"maximumNumberOfParallelSessions\"\n                [required]=\"useSessionConfiguration\"\n                [min]=\"1\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>sessions</span>\n            </div>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Token lifespan' | translate }}\">{{\n              'Token lifespan' | translate\n            }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"basicTokenLifespan\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"basicTokenLifespan\"\n                [required]=\"useSessionConfiguration\"\n                [max]=\"basicTokenLifespanConstraints.max\"\n                [min]=\"basicTokenLifespanConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"max\"\n                text=\"{{ MAX_TOKEN_LIFESPAN_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n              <c8y-message\n                name=\"min\"\n                text=\"{{ MIN_TOKEN_LIFESPAN_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n      </div>\n    </fieldset>\n  </div>\n</div>\n",
                viewProviders: [{ provide: ControlContainer, useExisting: NgForm }]
            },] }
];
SessionConfigurationComponent.ctorParameters = () => [
    { type: TenantUiService },
    { type: TranslateService }
];
SessionConfigurationComponent.propDecorators = {
    authConfiguration: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2F1dGgtY29uZmlndXJhdGlvbi9zZXNzaW9uLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUNoRSxPQUFPLEVBQXlCLHFCQUFxQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDMUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQU92RCxNQUFNLE9BQU8sNkJBQTZCO0lBbUJ4QyxZQUFvQixlQUFnQyxFQUNoQyxnQkFBa0M7UUFEbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFqQnRELDhCQUF5QixHQUFHLHFCQUFxQixDQUFDO1FBQ2xELHdDQUFtQyxHQUFHLE9BQU8sQ0FBQyw2RkFBNkYsQ0FBQyxDQUFDO1FBQzdJLHVDQUFrQyxHQUFHLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1FBQzlGLDBDQUFxQyxHQUFHLE9BQU8sQ0FDN0MseURBQXlELENBQzFELENBQUM7UUFDRiwwQ0FBcUMsR0FBRyxPQUFPLENBQzdDLDJEQUEyRCxDQUM1RCxDQUFDO1FBRUYsMkNBQXNDLEdBQUcsT0FBTyxDQUFDLDZIQUE2SCxDQUFDLENBQUM7UUFFeEsseUJBQW9CLEdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQU03QyxJ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RCxJQUFJLG9CQUFvQixDQUFDLEtBQTRCO1FBQ25ELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDO2FBQzNFLG9CQUFvQixHQUFHLEtBQUssQ0FBQztJQUNsQyxDQUFDO0lBRU8sZUFBZSxDQUFDLE9BQWU7UUFDckMsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNuRCxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsWUFBb0I7UUFDM0MsT0FBTyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDeEUsQ0FBQzs7O1lBdElGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsMkJBQTJCO2dCQUNyQyxnMExBQXFEO2dCQUNyRCxhQUFhLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLENBQUM7YUFDcEU7OztZQVJpQixlQUFlO1lBRXhCLGdCQUFnQjs7O2dDQVF0QixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSVNlc3Npb25Db25maWd1cmF0aW9uLCBUZW5hbnRMb2dpbk9wdGlvblR5cGUgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBDb250cm9sQ29udGFpbmVyLCBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBkZWZhdWx0cywgY2xvbmVEZWVwLCBpc0Zpbml0ZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBnZXR0ZXh0LCBUZW5hbnRVaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEF1dGhDb25maWd1cmF0aW9uIH0gZnJvbSAnLi9hdXRoLWNvbmZpZ3VyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktc2Vzc2lvbi1jb25maWd1cmF0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3Nlc3Npb24tY29uZmlndXJhdGlvbi5jb21wb25lbnQuaHRtbCcsXG4gIHZpZXdQcm92aWRlcnM6IFt7IHByb3ZpZGU6IENvbnRyb2xDb250YWluZXIsIHVzZUV4aXN0aW5nOiBOZ0Zvcm0gfV1cbn0pXG5leHBvcnQgY2xhc3MgU2Vzc2lvbkNvbmZpZ3VyYXRpb25Db21wb25lbnQge1xuICBASW5wdXQoKVxuICBhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb247XG4gIHRlbmFudExvZ2luT3B0aW9uVHlwZUVudW0gPSBUZW5hbnRMb2dpbk9wdGlvblR5cGU7XG4gIEFCU09MVVRFX1RJTUVPVVRfVkFMSURBVElPTl9NRVNTQUdFID0gZ2V0dGV4dCgnVGhlIHZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIFwiVG9rZW4gbGlmZXNwYW5cIiBhbmQgbm90IGxlc3MgdGhhbiB7eyBtaW5BYnNvbHV0ZVRpbWVvdXQgfX0uJyk7XG4gIFJFTkVXQUxfVElNRU9VVF9WQUxJREFUSU9OX01FU1NBR0UgPSBnZXR0ZXh0KCdUaGUgdmFsdWUgbXVzdCBiZSBsZXNzIHRoYW4gXCJUb2tlbiBsaWZlc3BhblwiLicpO1xuICBNQVhfVE9LRU5fTElGRVNQQU5fVkFMSURBVElPTl9NRVNTQUdFID0gZ2V0dGV4dChcbiAgICAnVGhlIHZhbHVlIG11c3QgYmUgbGVzcyB0aGFuIFwiU2Vzc2lvbiBhYnNvbHV0ZSB0aW1lb3V0XCIuJ1xuICApO1xuICBNSU5fVE9LRU5fTElGRVNQQU5fVkFMSURBVElPTl9NRVNTQUdFID0gZ2V0dGV4dChcbiAgICAnVGhlIHZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIFwiU2Vzc2lvbiByZW5ld2FsIHRpbWVvdXRcIi4nXG4gICk7XG5cbiAgVVNFUl9BR0VOVF9WQUxJREFUSU9OX1JFUVVJUkVEX1BPUE9WRVIgPSBnZXR0ZXh0KCdJZiBzZWxlY3RlZCwgdGhlbiBldmVyeSByZXF1ZXN0IG5lZWRzIHRvIHVzZSB0aGUgc2FtZSBcIlVzZXItQWdlbnRcIiBoZWFkZXIgYXMgdGhlIGZpcnN0IHJlcXVlc3Qgd2hpY2ggaW5pdGlhdGVkIHRoZSBzZXNzaW9uLicpO1xuXG4gIHByaXZhdGUgTUlOX0FCU09MVVRFX1RJTUVPVVQ6IG51bWJlciA9IDE1ICogNjA7XG4gIHByaXZhdGUgb3JpZ2luYWxTZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgcHJpdmF0ZSBwcmV2aW91c1Rva2VuTGlmZXNwYW47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0ZW5hbnRVaVNlcnZpY2U6IFRlbmFudFVpU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgdGhpcy5BQlNPTFVURV9USU1FT1VUX1ZBTElEQVRJT05fTUVTU0FHRSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgdGhpcy5BQlNPTFVURV9USU1FT1VUX1ZBTElEQVRJT05fTUVTU0FHRSwgeyBtaW5BYnNvbHV0ZVRpbWVvdXQ6IHRoaXMuTUlOX0FCU09MVVRFX1RJTUVPVVQgfSApO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLmF1dGhDb25maWd1cmF0aW9uICYmIGNoYW5nZXMuYXV0aENvbmZpZ3VyYXRpb24uY3VycmVudFZhbHVlKSB7XG4gICAgICBjb25zdCBvYXV0aEludGVybmFsID1cbiAgICAgICAgY2hhbmdlcy5hdXRoQ29uZmlndXJhdGlvbi5jdXJyZW50VmFsdWUubG9naW5PcHRpb25zLmZpbmQoXG4gICAgICAgICAgdGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNPYXV0aEludGVybmFsXG4gICAgICAgICkgfHwge307XG4gICAgICB0aGlzLm9yaWdpbmFsU2Vzc2lvbkNvbmZpZ3VyYXRpb24gPSBjbG9uZURlZXAob2F1dGhJbnRlcm5hbC5zZXNzaW9uQ29uZmlndXJhdGlvbik7XG4gICAgICB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uID0gb2F1dGhJbnRlcm5hbC5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgICAgIHRoaXMucHJldmlvdXNUb2tlbkxpZmVzcGFuID0gdGhpcy5hdXRoQ29uZmlndXJhdGlvbi50ZW5hbnRPcHRpb25zWydvYXV0aC5pbnRlcm5hbCddWydiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJ107XG4gICAgfVxuICB9XG5cbiAgZ2V0IHJlbmV3YWxUaW1lb3V0U2Vjb25kcygpOiBudW1iZXIge1xuICAgIGNvbnN0IHNlc3Npb25Db25maWd1cmF0aW9uID0gdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgICByZXR1cm4gdGhpcy5jb252ZXJ0VG9TZWNvbmRzKHNlc3Npb25Db25maWd1cmF0aW9uLnJlbmV3YWxUaW1lb3V0TWlsbGlzKTtcbiAgfVxuXG4gIHNldCByZW5ld2FsVGltZW91dFNlY29uZHModmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb24ucmVuZXdhbFRpbWVvdXRNaWxsaXMgPSB0aGlzLmNvbnZlcnRUb01pbGxpcyh2YWx1ZSk7XG4gIH1cblxuICBnZXQgYWJzb2x1dGVUaW1lb3V0U2Vjb25kcygpOiBudW1iZXIge1xuICAgIGNvbnN0IHNlc3Npb25Db25maWd1cmF0aW9uID0gdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgICByZXR1cm4gdGhpcy5jb252ZXJ0VG9TZWNvbmRzKHNlc3Npb25Db25maWd1cmF0aW9uLmFic29sdXRlVGltZW91dE1pbGxpcyk7XG4gIH1cblxuICBzZXQgYWJzb2x1dGVUaW1lb3V0U2Vjb25kcyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbi5hYnNvbHV0ZVRpbWVvdXRNaWxsaXMgPSB0aGlzLmNvbnZlcnRUb01pbGxpcyh2YWx1ZSk7XG4gIH1cblxuICBnZXQgbWF4aW11bU51bWJlck9mUGFyYWxsZWxTZXNzaW9ucygpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uLm1heGltdW1OdW1iZXJPZlBhcmFsbGVsU2Vzc2lvbnM7XG4gIH1cblxuICBzZXQgbWF4aW11bU51bWJlck9mUGFyYWxsZWxTZXNzaW9ucyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbi5tYXhpbXVtTnVtYmVyT2ZQYXJhbGxlbFNlc3Npb25zID0gdmFsdWU7XG4gIH1cblxuICBnZXQgdXNlckFnZW50VmFsaWRhdGlvblJlcXVpcmVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uLnVzZXJBZ2VudFZhbGlkYXRpb25SZXF1aXJlZDtcbiAgfVxuXG4gIHNldCB1c2VyQWdlbnRWYWxpZGF0aW9uUmVxdWlyZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uLnVzZXJBZ2VudFZhbGlkYXRpb25SZXF1aXJlZCA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGJhc2ljVG9rZW5MaWZlc3BhbigpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoQ29uZmlndXJhdGlvbi50ZW5hbnRPcHRpb25zWydvYXV0aC5pbnRlcm5hbCddWydiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJ107XG4gIH1cblxuICBzZXQgYmFzaWNUb2tlbkxpZmVzcGFuKHZhbHVlKSB7XG4gICAgdGhpcy5hdXRoQ29uZmlndXJhdGlvbi50ZW5hbnRPcHRpb25zWydvYXV0aC5pbnRlcm5hbCddWydiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJ10gPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCB1c2VTZXNzaW9uQ29uZmlndXJhdGlvbigpIHtcbiAgICByZXR1cm4gISF0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uO1xuICB9XG5cbiAgc2V0IHVzZVNlc3Npb25Db25maWd1cmF0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbiA9IHZhbHVlID8gZGVmYXVsdHMoe30sIHRoaXMub3JpZ2luYWxTZXNzaW9uQ29uZmlndXJhdGlvbiwge1xuICAgICAgYWJzb2x1dGVUaW1lb3V0TWlsbGlzOiAxMjA5NjAwMDAwLCAvLyAxNCBkYXlzXG4gICAgICByZW5ld2FsVGltZW91dE1pbGxpczogODY0MDAwMDAsIC8vIDEgZGF5XG4gICAgICBtYXhpbXVtTnVtYmVyT2ZQYXJhbGxlbFNlc3Npb25zOiA1LFxuICAgICAgdXNlckFnZW50VmFsaWRhdGlvblJlcXVpcmVkOiBmYWxzZVxuICAgIH0pIDogbnVsbDtcbiAgICB0aGlzLmJhc2ljVG9rZW5MaWZlc3BhbiA9IHRoaXMucHJldmlvdXNUb2tlbkxpZmVzcGFuIHx8IDE3MjgwMDsgLy8gMiBkYXlzXG4gIH1cblxuICBnZXQgYWJzb2x1dGVUaW1lb3V0Q29uc3RyYWludHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1pbjogTWF0aC5tYXgodGhpcy5NSU5fQUJTT0xVVEVfVElNRU9VVCwgdGhpcy5iYXNpY1Rva2VuTGlmZXNwYW4gKyAxKVxuICAgIH07XG4gIH1cblxuICBnZXQgcmVuZXdhbFRpbWVvdXRDb25zdHJhaW50cygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbWluOiB0aGlzLk1JTl9BQlNPTFVURV9USU1FT1VUIC8gMixcbiAgICAgIG1heDogdGhpcy5iYXNpY1Rva2VuTGlmZXNwYW4gPyB0aGlzLmJhc2ljVG9rZW5MaWZlc3BhbiAtIDEgOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIGdldCBiYXNpY1Rva2VuTGlmZXNwYW5Db25zdHJhaW50cygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbWluOiB0aGlzLnJlbmV3YWxUaW1lb3V0U2Vjb25kcyA/IHRoaXMucmVuZXdhbFRpbWVvdXRTZWNvbmRzICsgMSA6IG51bGwsXG4gICAgICBtYXg6IHRoaXMuYWJzb2x1dGVUaW1lb3V0U2Vjb25kcyA/IHRoaXMuYWJzb2x1dGVUaW1lb3V0U2Vjb25kcyAtIDEgOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIGdldCBzZXNzaW9uQ29uZmlndXJhdGlvbigpOiBJU2Vzc2lvbkNvbmZpZ3VyYXRpb24ge1xuICAgIHJldHVybiB0aGlzLmF1dGhDb25maWd1cmF0aW9uLmxvZ2luT3B0aW9ucy5maW5kKHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbClcbiAgICAgIC5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgfVxuXG4gIHNldCBzZXNzaW9uQ29uZmlndXJhdGlvbih2YWx1ZTogSVNlc3Npb25Db25maWd1cmF0aW9uKSB7XG4gICAgdGhpcy5hdXRoQ29uZmlndXJhdGlvbi5sb2dpbk9wdGlvbnMuZmluZCh0aGlzLnRlbmFudFVpU2VydmljZS5pc09hdXRoSW50ZXJuYWwpXG4gICAgICAuc2Vzc2lvbkNvbmZpZ3VyYXRpb24gPSB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydFRvTWlsbGlzKHNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGlzRmluaXRlKHNlY29uZHMpID8gc2Vjb25kcyAqIDEwMDAgOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9TZWNvbmRzKG1pbGxpc2Vjb25kczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gaXNGaW5pdGUobWlsbGlzZWNvbmRzKSA/IE1hdGguY2VpbChtaWxsaXNlY29uZHMgLyAxMDAwKSA6IG51bGw7XG4gIH1cbn1cbiJdfQ==