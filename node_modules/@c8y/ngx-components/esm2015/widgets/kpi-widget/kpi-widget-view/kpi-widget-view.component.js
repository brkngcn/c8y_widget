import { __awaiter } from "tslib";
import { Component, Input, Optional } from '@angular/core';
import { MeasurementRealtimeService } from '@c8y/ngx-components';
import { DatapointLibraryService } from '@c8y/ngx-components/datapoint-selector';
import { combineLatest, from, NEVER } from 'rxjs';
import { distinctUntilChanged, filter, map, pairwise, startWith, tap } from 'rxjs/operators';
import { ContextDashboardComponent } from '@c8y/ngx-components/context-dashboard';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@c8y/ngx-components/datapoint-selector';
import * as ɵngcc3 from '@c8y/ngx-components/context-dashboard';
import * as ɵngcc4 from '@angular/common';

function KpiWidgetViewComponent_div_0_div_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 11);
    ɵngcc0.ɵɵelement(1, "i", 12);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const lastState_r3 = ɵngcc0.ɵɵnextContext().ngIf;
    const ctx_r4 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("ngClass", lastState_r3.colorClass);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("c8yIcon", ctx_r4.config.icon);
} }
const _c0 = function (a0) { return { transform: a0 }; };
function KpiWidgetViewComponent_div_0_div_12_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 13);
    ɵngcc0.ɵɵelement(1, "i", 14);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵpipe(3, "number");
    ɵngcc0.ɵɵpipe(4, "date");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const previousValue_r8 = ctx.ngIf;
    const lastState_r3 = ɵngcc0.ɵɵnextContext().ngIf;
    const ctx_r5 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("title", ɵngcc0.ɵɵpipeBind1(2, 2, "Previous value") + ": " + ɵngcc0.ɵɵpipeBind2(3, 4, previousValue_r8.value, "1." + (ctx_r5.config.numberOfDecimalPlaces || "0") + "-" + (ctx_r5.config.numberOfDecimalPlaces || "0")) + " (" + ɵngcc0.ɵɵpipeBind2(4, 7, previousValue_r8.date, "medium") + ")")("ngStyle", ɵngcc0.ɵɵpureFunction1(10, _c0, "rotate(" + lastState_r3.trend + ")"));
} }
function KpiWidgetViewComponent_div_0_p_14_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "p", 15);
    ɵngcc0.ɵɵelement(1, "i", 16);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "date");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const lastState_r3 = ɵngcc0.ɵɵnextContext().ngIf;
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind2(3, 1, lastState_r3.latestMeasurement.date, "medium"), " ");
} }
const _c1 = function (a0) { return { "font-size": a0 }; };
function KpiWidgetViewComponent_div_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 2);
    ɵngcc0.ɵɵelementStart(1, "div", 3);
    ɵngcc0.ɵɵtemplate(2, KpiWidgetViewComponent_div_0_div_2_Template, 2, 2, "div", 4);
    ɵngcc0.ɵɵelementStart(3, "div", 5);
    ɵngcc0.ɵɵelementStart(4, "span", 6);
    ɵngcc0.ɵɵpipe(5, "translate");
    ɵngcc0.ɵɵpipe(6, "translate");
    ɵngcc0.ɵɵpipe(7, "number");
    ɵngcc0.ɵɵtext(8);
    ɵngcc0.ɵɵpipe(9, "number");
    ɵngcc0.ɵɵelementStart(10, "small", 7);
    ɵngcc0.ɵɵtext(11);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(12, KpiWidgetViewComponent_div_0_div_12_Template, 5, 12, "div", 8);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(13, "div", 9);
    ɵngcc0.ɵɵtemplate(14, KpiWidgetViewComponent_div_0_p_14_Template, 4, 4, "p", 10);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const lastState_r3 = ctx.ngIf;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.config.icon && ctx_r0.config.showIcon);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵpropertyInterpolate3("title", "", lastState_r3.colorClass === "text-danger" ? ɵngcc0.ɵɵpipeBind1(5, 10, "Within red range:") : lastState_r3.colorClass === "text-warning" ? ɵngcc0.ɵɵpipeBind1(6, 12, "Within yellow range:") : "", " ", ɵngcc0.ɵɵpipeBind2(7, 14, lastState_r3.latestMeasurement.value, "1." + (ctx_r0.config.numberOfDecimalPlaces || "0") + "-" + (ctx_r0.config.numberOfDecimalPlaces || "0")), " ", lastState_r3.unit || "", "");
    ɵngcc0.ɵɵproperty("ngClass", lastState_r3.colorClass)("ngStyle", ɵngcc0.ɵɵpureFunction1(20, _c1, (ctx_r0.config.fontSize || "36") + "px"));
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind2(9, 17, lastState_r3.latestMeasurement.value, "1." + (ctx_r0.config.numberOfDecimalPlaces || "0") + "-" + (ctx_r0.config.numberOfDecimalPlaces || "0")), " ");
    ɵngcc0.ɵɵadvance(3);
    ɵngcc0.ɵɵtextInterpolate(lastState_r3.unit || "");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", (ctx_r0.config == null ? null : ctx_r0.config.showTrend) && lastState_r3.previousValue);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.config == null ? null : ctx_r0.config.showTimestamp);
} }
function KpiWidgetViewComponent_ng_template_2_c8y_ui_empty_state_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-ui-empty-state", 20);
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵpipe(2, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵproperty("icon", "line-chart")("title", ɵngcc0.ɵɵpipeBind1(1, 4, "No measurement to display."))("subtitle", ɵngcc0.ɵɵpipeBind1(2, 6, "Waiting for measurements to be created."))("horizontal", true);
} }
function KpiWidgetViewComponent_ng_template_2_c8y_loading_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-loading");
} }
function KpiWidgetViewComponent_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 17);
    ɵngcc0.ɵɵtemplate(1, KpiWidgetViewComponent_ng_template_2_c8y_ui_empty_state_1_Template, 3, 8, "c8y-ui-empty-state", 18);
    ɵngcc0.ɵɵtemplate(2, KpiWidgetViewComponent_ng_template_2_c8y_loading_2_Template, 1, 0, "c8y-loading", 19);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.noDataInitiallyInDB);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r2.noDataInitiallyInDB);
} }
var ColorClass;
(function (ColorClass) {
    ColorClass["danger"] = "text-danger";
    ColorClass["warning"] = "text-warning";
    ColorClass["unknown"] = "";
})(ColorClass || (ColorClass = {}));
export class KpiWidgetViewComponent {
    constructor(measurementRealtime, datapointLib, dashboard) {
        this.measurementRealtime = measurementRealtime;
        this.datapointLib = datapointLib;
        this.dashboard = dashboard;
        this.config = { datapoints: [] };
        this.state$ = NEVER;
        // used to differentiate between loading state and empty state
        this.noDataInitiallyInDB = false;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            const datapoints = this.config.datapoints || [];
            const datapoint = datapoints.find(tmp => tmp.__active);
            if (!datapoint) {
                return;
            }
            this.state$ = this.setupObservable(datapoint);
        });
    }
    setupObservable(datapoint) {
        this.assignContextFromContextDashboard(datapoint);
        const latestMeasurement$ = this.getLatestMeasurement$(datapoint);
        const lastTwoValues$ = this.getLastTwoValuesOfObservable$(latestMeasurement$);
        const previousValue$ = lastTwoValues$.pipe(map(res => res[0]), startWith(undefined));
        const datapointUpdate$ = this.getDatapointLibraryEntry$(datapoint);
        const combineMeasurementAndDatapointLibEntry$ = combineLatest([
            latestMeasurement$,
            datapointUpdate$
        ]);
        const unit$ = combineMeasurementAndDatapointLibEntry$.pipe(map(([latestMeasurementValue, currentDatapoint]) => currentDatapoint.unit || latestMeasurementValue.unit || ''), startWith(''), distinctUntilChanged());
        return combineLatest([
            latestMeasurement$,
            previousValue$,
            this.getTrendOfLatestMeasurements$(lastTwoValues$),
            unit$,
            this.getColorClass$(combineMeasurementAndDatapointLibEntry$)
        ]).pipe(map(([latestMeasurement, previousValue, trend, unit, colorClass]) => {
            return {
                latestMeasurement,
                previousValue,
                trend,
                unit,
                colorClass
            };
        }));
    }
    getLatestMeasurement$(datapoint) {
        return this.measurementRealtime
            .latestValueOfSpecificMeasurement$(datapoint.fragment, datapoint.series, datapoint.__target, 
        // we only need the last two values in case we want to show a trend
        this.config.showTrend ? 2 : 1, 
        // null will be emitted in case no measurement was found initially
        true)
            .pipe(tap(measurement => {
            if (!measurement) {
                this.noDataInitiallyInDB = true;
            }
        }), filter(measurement => !!measurement), map(measurement => {
            return {
                unit: measurement[datapoint.fragment][datapoint.series].unit,
                value: measurement[datapoint.fragment][datapoint.series].value,
                date: measurement.time
            };
        }));
    }
    getDatapointLibraryEntry$(datapoint) {
        return from(this.datapointLib.updateDatapoints([datapoint], true)).pipe(map(tmp => tmp[0]), filter(tmp => !!tmp), startWith(datapoint));
    }
    getColorClass$(measurementAndDatapointCombination$) {
        return measurementAndDatapointCombination$.pipe(map(([latestMeasurementValue, currentDatapoint]) => {
            if (this.inRangeOf(currentDatapoint, latestMeasurementValue.value, 'redRangeMin', 'redRangeMax')) {
                return ColorClass.danger;
            }
            if (this.inRangeOf(currentDatapoint, latestMeasurementValue.value, 'yellowRangeMin', 'yellowRangeMax')) {
                return ColorClass.warning;
            }
            return ColorClass.unknown;
        }), startWith(ColorClass.unknown), distinctUntilChanged());
    }
    getLastTwoValuesOfObservable$(input$) {
        return input$.pipe(pairwise());
    }
    getTrendOfLatestMeasurements$(latestMeasurement$) {
        return latestMeasurement$.pipe(map(res => {
            if (res.length === 2) {
                const oldValue = res[0].value;
                const newValue = res[1].value;
                if (oldValue < newValue) {
                    return '45deg';
                }
                if (oldValue > newValue) {
                    return '135deg';
                }
            }
            return '90deg';
        }), startWith('90deg'), distinctUntilChanged());
    }
    inRangeOf(datapoint, measurementValue, minAttribute, maxAttribute) {
        if (typeof datapoint[minAttribute] === 'number' &&
            typeof datapoint[maxAttribute] === 'number') {
            if (measurementValue >= datapoint[minAttribute] &&
                measurementValue < datapoint[maxAttribute]) {
                return true;
            }
        }
        return false;
    }
    assignContextFromContextDashboard(datapoint) {
        var _a, _b;
        if (!((_a = this.dashboard) === null || _a === void 0 ? void 0 : _a.isDeviceTypeDashboard)) {
            return;
        }
        const context = (_b = this.dashboard) === null || _b === void 0 ? void 0 : _b.context;
        if (context === null || context === void 0 ? void 0 : context.id) {
            const { name, id } = context;
            datapoint.__target = { name, id };
        }
    }
}
KpiWidgetViewComponent.ɵfac = function KpiWidgetViewComponent_Factory(t) { return new (t || KpiWidgetViewComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.MeasurementRealtimeService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.DatapointLibraryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.ContextDashboardComponent, 8)); };
KpiWidgetViewComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: KpiWidgetViewComponent, selectors: [["c8y-kpi-widget-view"]], inputs: { config: "config" }, features: [ɵngcc0.ɵɵProvidersFeature([MeasurementRealtimeService])], decls: 4, vars: 4, consts: [["class", "kpi-widget__container d-flex d-col fit-h fit-w a-i-center j-c-center", 4, "ngIf", "ngIfElse"], ["noMeasurementFound", ""], [1, "kpi-widget__container", "d-flex", "d-col", "fit-h", "fit-w", "a-i-center", "j-c-center"], [1, "d-flex", "a-i-center", "j-c-center", "fit-w"], ["class", "m-r-16 flex-no-shrink text-muted", 3, "ngClass", 4, "ngIf"], [1, "text-truncate"], [1, "text-truncate", "text-medium", 3, "ngClass", "ngStyle", "title"], [1, "text-regular"], ["class", "dot dot-info dot-30 m-l-16 flex-no-shrink", 4, "ngIf"], [1, "d-flex", "j-c-center"], ["class", "icon-flex text-center text-muted small", 4, "ngIf"], [1, "m-r-16", "flex-no-shrink", "text-muted", 3, "ngClass"], [1, "icon-32", 3, "c8yIcon"], [1, "dot", "dot-info", "dot-30", "m-l-16", "flex-no-shrink"], ["c8yIcon", "arrow-dotted-up", 1, "icon-20", 3, "title", "ngStyle"], [1, "icon-flex", "text-center", "text-muted", "small"], ["c8yIcon", "calendar"], [1, "d-flex", "fit-h", "fit-w", "j-c-center", "a-i-center"], ["class", "fit-w", 3, "icon", "title", "subtitle", "horizontal", 4, "ngIf"], [4, "ngIf"], [1, "fit-w", 3, "icon", "title", "subtitle", "horizontal"]], template: function KpiWidgetViewComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, KpiWidgetViewComponent_div_0_Template, 15, 22, "div", 0);
        ɵngcc0.ɵɵpipe(1, "async");
        ɵngcc0.ɵɵtemplate(2, KpiWidgetViewComponent_ng_template_2_Template, 3, 2, "ng-template", null, 1, ɵngcc0.ɵɵtemplateRefExtractor);
    } if (rf & 2) {
        const _r1 = ɵngcc0.ɵɵreference(3);
        ɵngcc0.ɵɵproperty("ngIf", ɵngcc0.ɵɵpipeBind1(1, 2, ctx.state$))("ngIfElse", _r1);
    } }, directives: [ɵngcc4.NgIf, ɵngcc4.NgClass, ɵngcc4.NgStyle, ɵngcc1.IconDirective, ɵngcc1.EmptyStateComponent, ɵngcc1.LoadingComponent], pipes: [ɵngcc4.AsyncPipe, ɵngcc1.C8yTranslatePipe, ɵngcc4.DecimalPipe, ɵngcc4.DatePipe], encapsulation: 2 });
KpiWidgetViewComponent.ctorParameters = () => [
    { type: MeasurementRealtimeService },
    { type: DatapointLibraryService },
    { type: ContextDashboardComponent, decorators: [{ type: Optional }] }
];
KpiWidgetViewComponent.propDecorators = {
    config: [{ type: Input }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(KpiWidgetViewComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-kpi-widget-view',
                template: "<div\n  class=\"kpi-widget__container d-flex d-col fit-h fit-w a-i-center j-c-center\"\n  *ngIf=\"state$ | async as lastState; else noMeasurementFound\"\n>\n  <div class=\"d-flex a-i-center j-c-center fit-w\">\n    <div\n      class=\"m-r-16 flex-no-shrink text-muted\"\n      [ngClass]=\"lastState.colorClass\"\n      *ngIf=\"config.icon && config.showIcon\"\n    >\n      <i class=\"icon-32\" [c8yIcon]=\"config.icon\"></i>\n    </div>\n    <div class=\"text-truncate\">\n      <span\n        class=\"text-truncate text-medium\"\n        [ngClass]=\"lastState.colorClass\"\n        [ngStyle]=\"{ 'font-size': (config.fontSize || '36') + 'px' }\"\n        title=\"{{\n          lastState.colorClass === 'text-danger'\n            ? ('Within red range:' | translate)\n            : lastState.colorClass === 'text-warning'\n            ? ('Within yellow range:' | translate)\n            : ''\n        }} {{\n          lastState.latestMeasurement.value\n            | number\n              : '1.' +\n                  (config.numberOfDecimalPlaces || '0') +\n                  '-' +\n                  (config.numberOfDecimalPlaces || '0')\n        }} {{ lastState.unit || '' }}\"\n      >\n        {{\n          lastState.latestMeasurement.value\n            | number\n              : '1.' +\n                  (config.numberOfDecimalPlaces || '0') +\n                  '-' +\n                  (config.numberOfDecimalPlaces || '0')\n        }}\n        <small class=\"text-regular\">{{ lastState.unit || '' }}</small>\n      </span>\n    </div>\n    <div\n      class=\"dot dot-info dot-30 m-l-16 flex-no-shrink\"\n      *ngIf=\"config?.showTrend && lastState.previousValue as previousValue\"\n    >\n      <i\n        class=\"icon-20\"\n        [title]=\"\n          ('Previous value' | translate) +\n          ': ' +\n          (previousValue.value\n            | number\n              : '1.' +\n                  (config.numberOfDecimalPlaces || '0') +\n                  '-' +\n                  (config.numberOfDecimalPlaces || '0')) +\n          ' (' +\n          (previousValue.date | date: 'medium') +\n          ')'\n        \"\n        c8yIcon=\"arrow-dotted-up\"\n        [ngStyle]=\"{ transform: 'rotate(' + lastState.trend + ')' }\"\n      ></i>\n    </div>\n  </div>\n  <div class=\"d-flex j-c-center\">\n    <p *ngIf=\"config?.showTimestamp\" class=\"icon-flex text-center text-muted small\">\n      <i c8yIcon=\"calendar\"></i>\n      {{ lastState.latestMeasurement.date | date: 'medium' }}\n    </p>\n  </div>\n</div>\n\n<ng-template #noMeasurementFound>\n  <div class=\"d-flex fit-h fit-w j-c-center a-i-center\">\n    <c8y-ui-empty-state\n      *ngIf=\"noDataInitiallyInDB\"\n      class=\"fit-w\"\n      [icon]=\"'line-chart'\"\n      [title]=\"'No measurement to display.' | translate\"\n      [subtitle]=\"'Waiting for measurements to be created.' | translate\"\n      [horizontal]=\"true\"\n    ></c8y-ui-empty-state>\n    <c8y-loading *ngIf=\"!noDataInitiallyInDB\"></c8y-loading>\n  </div>\n</ng-template>\n",
                providers: [MeasurementRealtimeService]
            }]
    }], function () { return [{ type: ɵngcc1.MeasurementRealtimeService }, { type: ɵngcc2.DatapointLibraryService }, { type: ɵngcc3.ContextDashboardComponent, decorators: [{
                type: Optional
            }] }]; }, { config: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3BpLXdpZGdldC12aWV3LmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vd2lkZ2V0cy9rcGktd2lkZ2V0L2twaS13aWRnZXQtdmlldy9rcGktd2lkZ2V0LXZpZXcuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBVSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakUsT0FBTyxFQUFFLHVCQUF1QixFQUFjLE1BQU0sd0NBQXdDLENBQUM7QUFDN0YsT0FBTyxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0YsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sdUNBQXVDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFTbEYsSUFBSyxVQUlKO0FBSkQsV0FBSyxVQUFVO0FBQ2QsSUFBQyxvQ0FBc0IsQ0FBQTtBQUFDLElBQ3ZCLHNDQUF3QixDQUFBO0FBQUMsSUFDekIsMEJBQVksQ0FBQTtBQUNkLENBQUMsRUFKSSxVQUFVLEtBQVYsVUFBVSxRQUlkO0FBT0QsTUFBTSxPQUFPLHNCQUFzQjtBQUFHLElBYXBDLFlBQ1UsbUJBQStDLEVBQy9DLFlBQXFDLEVBQ3pCLFNBQW9DO0FBQ3pELFFBSFMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtBQUFDLFFBQ2hELGlCQUFZLEdBQVosWUFBWSxDQUF5QjtBQUFD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QUksT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLEVBQUUsRUFBRTtBQUNyQixZQUFNLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEdBQUcsT0FBTyxDQUFDO0FBQ25DLFlBQU0sU0FBUyxDQUFDLFFBQVEsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztBQUN4QyxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0g7a0RBak5DLFNBQVMsU0FBQyxrQkFDVCxRQUFRLEVBQUUscUJBQXFCLGtCQUMvQjs7Ozs7Ozs7NFBBR0c7QUFBQztBQUFnRCxZQXhCN0MsMEJBQTBCO0FBQUksWUFDOUIsdUJBQXVCO0FBQUksWUFHM0IseUJBQXlCLHVCQW9DN0IsUUFBUTtBQUFNO0FBQUc7QUFDbkIscUJBaEJBLEtBQUs7QUFBSTs7Ozs7OE9BSnFDLGtCQUMvQyxTQUFTLEVBQUUsQ0FBQywwQkFBMEIsQ0FBQyxjQUN4Qzs7Ozs7OztvQkFFYTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWVhc3VyZW1lbnRSZWFsdGltZVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IERhdGFwb2ludExpYnJhcnlTZXJ2aWNlLCBLUElEZXRhaWxzIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9kYXRhcG9pbnQtc2VsZWN0b3InO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgZnJvbSwgTkVWRVIsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgcGFpcndpc2UsIHN0YXJ0V2l0aCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udGV4dERhc2hib2FyZENvbXBvbmVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvY29udGV4dC1kYXNoYm9hcmQnO1xuaW1wb3J0IHsgS3BpV2lkZ2V0Q29uZmlnIH0gZnJvbSAnLi4va3BpLXdpZGdldC5tb2RlbCc7XG5cbmludGVyZmFjZSBNZWFzdXJlbWVudFZhbHVlIHtcbiAgdW5pdD86IHN0cmluZztcbiAgdmFsdWU6IG51bWJlcjtcbiAgZGF0ZTogc3RyaW5nO1xufVxuXG5lbnVtIENvbG9yQ2xhc3Mge1xuICBkYW5nZXIgPSAndGV4dC1kYW5nZXInLFxuICB3YXJuaW5nID0gJ3RleHQtd2FybmluZycsXG4gIHVua25vd24gPSAnJ1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHkta3BpLXdpZGdldC12aWV3JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2twaS13aWRnZXQtdmlldy5jb21wb25lbnQuaHRtbCcsXG4gIHByb3ZpZGVyczogW01lYXN1cmVtZW50UmVhbHRpbWVTZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBLcGlXaWRnZXRWaWV3Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgY29uZmlnOiBLcGlXaWRnZXRDb25maWcgPSB7IGRhdGFwb2ludHM6IFtdIH07XG4gIHN0YXRlJDogT2JzZXJ2YWJsZTx7XG4gICAgbGF0ZXN0TWVhc3VyZW1lbnQ6IE1lYXN1cmVtZW50VmFsdWU7XG4gICAgcHJldmlvdXNWYWx1ZTogTWVhc3VyZW1lbnRWYWx1ZTtcbiAgICB0cmVuZDogc3RyaW5nO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgICBjb2xvckNsYXNzOiBDb2xvckNsYXNzO1xuICB9PiA9IE5FVkVSO1xuXG4gIC8vIHVzZWQgdG8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIGxvYWRpbmcgc3RhdGUgYW5kIGVtcHR5IHN0YXRlXG4gIG5vRGF0YUluaXRpYWxseUluREIgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1lYXN1cmVtZW50UmVhbHRpbWU6IE1lYXN1cmVtZW50UmVhbHRpbWVTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGF0YXBvaW50TGliOiBEYXRhcG9pbnRMaWJyYXJ5U2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGRhc2hib2FyZDogQ29udGV4dERhc2hib2FyZENvbXBvbmVudFxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgY29uc3QgZGF0YXBvaW50cyA9IHRoaXMuY29uZmlnLmRhdGFwb2ludHMgfHwgW107XG4gICAgY29uc3QgZGF0YXBvaW50OiBLUElEZXRhaWxzID0gZGF0YXBvaW50cy5maW5kKHRtcCA9PiB0bXAuX19hY3RpdmUpO1xuICAgIGlmICghZGF0YXBvaW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zdGF0ZSQgPSB0aGlzLnNldHVwT2JzZXJ2YWJsZShkYXRhcG9pbnQpO1xuICB9XG5cbiAgc2V0dXBPYnNlcnZhYmxlKGRhdGFwb2ludDogS1BJRGV0YWlscyk6IE9ic2VydmFibGU8e1xuICAgIGxhdGVzdE1lYXN1cmVtZW50OiBNZWFzdXJlbWVudFZhbHVlO1xuICAgIHByZXZpb3VzVmFsdWU6IGFueTtcbiAgICB0cmVuZDogc3RyaW5nO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgICBjb2xvckNsYXNzOiBDb2xvckNsYXNzO1xuICB9PiB7XG4gICAgdGhpcy5hc3NpZ25Db250ZXh0RnJvbUNvbnRleHREYXNoYm9hcmQoZGF0YXBvaW50KTtcbiAgICBjb25zdCBsYXRlc3RNZWFzdXJlbWVudCQgPSB0aGlzLmdldExhdGVzdE1lYXN1cmVtZW50JChkYXRhcG9pbnQpO1xuICAgIGNvbnN0IGxhc3RUd29WYWx1ZXMkID0gdGhpcy5nZXRMYXN0VHdvVmFsdWVzT2ZPYnNlcnZhYmxlJChsYXRlc3RNZWFzdXJlbWVudCQpO1xuXG4gICAgY29uc3QgcHJldmlvdXNWYWx1ZSQgPSBsYXN0VHdvVmFsdWVzJC5waXBlKFxuICAgICAgbWFwKHJlcyA9PiByZXNbMF0pLFxuICAgICAgc3RhcnRXaXRoKHVuZGVmaW5lZCBhcyBhbnkpXG4gICAgKTtcblxuICAgIGNvbnN0IGRhdGFwb2ludFVwZGF0ZSQgPSB0aGlzLmdldERhdGFwb2ludExpYnJhcnlFbnRyeSQoZGF0YXBvaW50KTtcblxuICAgIGNvbnN0IGNvbWJpbmVNZWFzdXJlbWVudEFuZERhdGFwb2ludExpYkVudHJ5JCA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgbGF0ZXN0TWVhc3VyZW1lbnQkLFxuICAgICAgZGF0YXBvaW50VXBkYXRlJFxuICAgIF0pO1xuXG4gICAgY29uc3QgdW5pdCQgPSBjb21iaW5lTWVhc3VyZW1lbnRBbmREYXRhcG9pbnRMaWJFbnRyeSQucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKFtsYXRlc3RNZWFzdXJlbWVudFZhbHVlLCBjdXJyZW50RGF0YXBvaW50XSkgPT5cbiAgICAgICAgICBjdXJyZW50RGF0YXBvaW50LnVuaXQgfHwgbGF0ZXN0TWVhc3VyZW1lbnRWYWx1ZS51bml0IHx8ICcnXG4gICAgICApLFxuICAgICAgc3RhcnRXaXRoKCcnKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgbGF0ZXN0TWVhc3VyZW1lbnQkLFxuICAgICAgcHJldmlvdXNWYWx1ZSQsXG4gICAgICB0aGlzLmdldFRyZW5kT2ZMYXRlc3RNZWFzdXJlbWVudHMkKGxhc3RUd29WYWx1ZXMkKSxcbiAgICAgIHVuaXQkLFxuICAgICAgdGhpcy5nZXRDb2xvckNsYXNzJChjb21iaW5lTWVhc3VyZW1lbnRBbmREYXRhcG9pbnRMaWJFbnRyeSQpXG4gICAgXSkucGlwZShcbiAgICAgIG1hcCgoW2xhdGVzdE1lYXN1cmVtZW50LCBwcmV2aW91c1ZhbHVlLCB0cmVuZCwgdW5pdCwgY29sb3JDbGFzc10pID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBsYXRlc3RNZWFzdXJlbWVudCxcbiAgICAgICAgICBwcmV2aW91c1ZhbHVlLFxuICAgICAgICAgIHRyZW5kLFxuICAgICAgICAgIHVuaXQsXG4gICAgICAgICAgY29sb3JDbGFzc1xuICAgICAgICB9O1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMYXRlc3RNZWFzdXJlbWVudCQoZGF0YXBvaW50OiBLUElEZXRhaWxzKTogT2JzZXJ2YWJsZTxNZWFzdXJlbWVudFZhbHVlPiB7XG4gICAgcmV0dXJuIHRoaXMubWVhc3VyZW1lbnRSZWFsdGltZVxuICAgICAgLmxhdGVzdFZhbHVlT2ZTcGVjaWZpY01lYXN1cmVtZW50JChcbiAgICAgICAgZGF0YXBvaW50LmZyYWdtZW50LFxuICAgICAgICBkYXRhcG9pbnQuc2VyaWVzLFxuICAgICAgICBkYXRhcG9pbnQuX190YXJnZXQsXG4gICAgICAgIC8vIHdlIG9ubHkgbmVlZCB0aGUgbGFzdCB0d28gdmFsdWVzIGluIGNhc2Ugd2Ugd2FudCB0byBzaG93IGEgdHJlbmRcbiAgICAgICAgdGhpcy5jb25maWcuc2hvd1RyZW5kID8gMiA6IDEsXG4gICAgICAgIC8vIG51bGwgd2lsbCBiZSBlbWl0dGVkIGluIGNhc2Ugbm8gbWVhc3VyZW1lbnQgd2FzIGZvdW5kIGluaXRpYWxseVxuICAgICAgICB0cnVlXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKG1lYXN1cmVtZW50ID0+IHtcbiAgICAgICAgICBpZiAoIW1lYXN1cmVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLm5vRGF0YUluaXRpYWxseUluREIgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcihtZWFzdXJlbWVudCA9PiAhIW1lYXN1cmVtZW50KSxcbiAgICAgICAgbWFwKG1lYXN1cmVtZW50ID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdW5pdDogbWVhc3VyZW1lbnRbZGF0YXBvaW50LmZyYWdtZW50XVtkYXRhcG9pbnQuc2VyaWVzXS51bml0LFxuICAgICAgICAgICAgdmFsdWU6IG1lYXN1cmVtZW50W2RhdGFwb2ludC5mcmFnbWVudF1bZGF0YXBvaW50LnNlcmllc10udmFsdWUsXG4gICAgICAgICAgICBkYXRlOiBtZWFzdXJlbWVudC50aW1lIGFzIHN0cmluZ1xuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXRhcG9pbnRMaWJyYXJ5RW50cnkkKGRhdGFwb2ludDogS1BJRGV0YWlscyk6IE9ic2VydmFibGU8S1BJRGV0YWlscz4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMuZGF0YXBvaW50TGliLnVwZGF0ZURhdGFwb2ludHMoW2RhdGFwb2ludF0sIHRydWUpKS5waXBlKFxuICAgICAgbWFwKHRtcCA9PiB0bXBbMF0pLFxuICAgICAgZmlsdGVyKHRtcCA9PiAhIXRtcCksXG4gICAgICBzdGFydFdpdGgoZGF0YXBvaW50KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldENvbG9yQ2xhc3MkKFxuICAgIG1lYXN1cmVtZW50QW5kRGF0YXBvaW50Q29tYmluYXRpb24kOiBPYnNlcnZhYmxlPFtNZWFzdXJlbWVudFZhbHVlLCBLUElEZXRhaWxzXT5cbiAgKTogT2JzZXJ2YWJsZTxDb2xvckNsYXNzPiB7XG4gICAgcmV0dXJuIG1lYXN1cmVtZW50QW5kRGF0YXBvaW50Q29tYmluYXRpb24kLnBpcGUoXG4gICAgICBtYXAoKFtsYXRlc3RNZWFzdXJlbWVudFZhbHVlLCBjdXJyZW50RGF0YXBvaW50XSkgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy5pblJhbmdlT2YoXG4gICAgICAgICAgICBjdXJyZW50RGF0YXBvaW50LFxuICAgICAgICAgICAgbGF0ZXN0TWVhc3VyZW1lbnRWYWx1ZS52YWx1ZSxcbiAgICAgICAgICAgICdyZWRSYW5nZU1pbicsXG4gICAgICAgICAgICAncmVkUmFuZ2VNYXgnXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gQ29sb3JDbGFzcy5kYW5nZXI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy5pblJhbmdlT2YoXG4gICAgICAgICAgICBjdXJyZW50RGF0YXBvaW50LFxuICAgICAgICAgICAgbGF0ZXN0TWVhc3VyZW1lbnRWYWx1ZS52YWx1ZSxcbiAgICAgICAgICAgICd5ZWxsb3dSYW5nZU1pbicsXG4gICAgICAgICAgICAneWVsbG93UmFuZ2VNYXgnXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gQ29sb3JDbGFzcy53YXJuaW5nO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIENvbG9yQ2xhc3MudW5rbm93bjtcbiAgICAgIH0pLFxuICAgICAgc3RhcnRXaXRoKENvbG9yQ2xhc3MudW5rbm93biksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFzdFR3b1ZhbHVlc09mT2JzZXJ2YWJsZSQ8VD4oaW5wdXQkOiBPYnNlcnZhYmxlPFQ+KTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgICByZXR1cm4gaW5wdXQkLnBpcGUocGFpcndpc2UoKSk7XG4gIH1cblxuICBwcml2YXRlIGdldFRyZW5kT2ZMYXRlc3RNZWFzdXJlbWVudHMkKGxhdGVzdE1lYXN1cmVtZW50JDogT2JzZXJ2YWJsZTxNZWFzdXJlbWVudFZhbHVlW10+KSB7XG4gICAgcmV0dXJuIGxhdGVzdE1lYXN1cmVtZW50JC5waXBlKFxuICAgICAgbWFwKHJlcyA9PiB7XG4gICAgICAgIGlmIChyZXMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSByZXNbMF0udmFsdWU7XG4gICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSByZXNbMV0udmFsdWU7XG4gICAgICAgICAgaWYgKG9sZFZhbHVlIDwgbmV3VmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybiAnNDVkZWcnO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAob2xkVmFsdWUgPiBuZXdWYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuICcxMzVkZWcnO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJzkwZGVnJztcbiAgICAgIH0pLFxuICAgICAgc3RhcnRXaXRoKCc5MGRlZycpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGluUmFuZ2VPZihcbiAgICBkYXRhcG9pbnQ6IEtQSURldGFpbHMsXG4gICAgbWVhc3VyZW1lbnRWYWx1ZTogbnVtYmVyLFxuICAgIG1pbkF0dHJpYnV0ZTogc3RyaW5nLFxuICAgIG1heEF0dHJpYnV0ZTogc3RyaW5nXG4gICk6IGJvb2xlYW4ge1xuICAgIGlmIChcbiAgICAgIHR5cGVvZiBkYXRhcG9pbnRbbWluQXR0cmlidXRlXSA9PT0gJ251bWJlcicgJiZcbiAgICAgIHR5cGVvZiBkYXRhcG9pbnRbbWF4QXR0cmlidXRlXSA9PT0gJ251bWJlcidcbiAgICApIHtcbiAgICAgIGlmIChcbiAgICAgICAgbWVhc3VyZW1lbnRWYWx1ZSA+PSBkYXRhcG9pbnRbbWluQXR0cmlidXRlXSAmJlxuICAgICAgICBtZWFzdXJlbWVudFZhbHVlIDwgZGF0YXBvaW50W21heEF0dHJpYnV0ZV1cbiAgICAgICkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3NpZ25Db250ZXh0RnJvbUNvbnRleHREYXNoYm9hcmQoZGF0YXBvaW50OiBLUElEZXRhaWxzKSB7XG4gICAgaWYgKCF0aGlzLmRhc2hib2FyZD8uaXNEZXZpY2VUeXBlRGFzaGJvYXJkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmRhc2hib2FyZD8uY29udGV4dDtcbiAgICBpZiAoY29udGV4dD8uaWQpIHtcbiAgICAgIGNvbnN0IHsgbmFtZSwgaWQgfSA9IGNvbnRleHQ7XG4gICAgICBkYXRhcG9pbnQuX190YXJnZXQgPSB7IG5hbWUsIGlkIH07XG4gICAgfVxuICB9XG59XG4iXX0=