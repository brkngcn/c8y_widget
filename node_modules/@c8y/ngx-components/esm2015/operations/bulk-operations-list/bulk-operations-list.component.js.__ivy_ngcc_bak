import { Component, ViewChild, ViewChildren } from '@angular/core';
import { DatePickerComponent, OperationBulkRealtimeService } from '@c8y/ngx-components';
import { BulkOperationsService } from '@c8y/ngx-components/operations/bulk-operations-service';
import { flatten } from 'lodash-es';
import { BehaviorSubject, combineLatest, pipe } from 'rxjs';
import { map, shareReplay, switchMap, tap, withLatestFrom } from 'rxjs/operators';
import { BulkOperationListItemComponent, BULK_OPERATION_STATUS_OPTIONS } from '@c8y/ngx-components/operations/bulk-operation-list-item';
import { BulkOperationModalsService } from './modals/bulk-operation-modals.service';
export class BulkOperationsListComponent {
    constructor(realtime, bulkOperationsService, bulkOperationModalsService) {
        this.realtime = realtime;
        this.bulkOperationsService = bulkOperationsService;
        this.bulkOperationModalsService = bulkOperationModalsService;
        this.bulkTypes = [];
        this.selectedTypeFilters = this.getTypeFilters();
        this.bulkOperationStatusOptions = BULK_OPERATION_STATUS_OPTIONS;
        this.refreshLoading = false;
        this.statusFilter$ = new BehaviorSubject(null);
        this.typeFilter$ = new BehaviorSubject(null);
        this.timeFilter$ = new BehaviorSubject(null);
        this.reload$ = new BehaviorSubject(null);
        this.bulkOperations$ = combineLatest(this.statusFilter$, this.timeFilter$, this.typeFilter$, this.reload$).pipe(tap(() => {
            this.refreshLoading = true;
        }), switchMap(([statusFilters, timeFilters]) => this.filter(statusFilters, timeFilters)), withLatestFrom(this.typeFilter$), map(([result, typeFilter]) => {
            this.filterPipe = pipe(map((data) => this.filterByType(data, typeFilter)));
            return Object.assign(Object.assign({}, result), { data: this.filterByType(result.data, typeFilter) });
        }), tap(() => {
            this.refreshLoading = false;
        }), shareReplay(1));
        this.allFilterFragments = this.flattenFilterFragments(this.getTypeFilters());
    }
    ngOnInit() {
        this.bulkTypes = this.bulkOperationsService.getBulkTypes();
    }
    filterByType(bulkOperations, typeFilter) {
        const flattenedFragments = this.flattenFilterFragments(typeFilter);
        if (
        // return data unfiltered if no filters selected...
        !flattenedFragments.length ||
            // ...or when all filters are selected
            this.allFilterFragments.every(fragment => flattenedFragments.includes(fragment))) {
            return bulkOperations;
        }
        const filteredData = bulkOperations.filter(item => {
            return Object.keys(item.operationPrototype).some(key => flattenedFragments.includes(key));
        });
        return filteredData;
    }
    resetFilter() {
        this.statusFilter$.next(null);
        this.timeFilter$.next(null);
        this.typeFilter$.next(null);
        this.datePicker.clearFilter();
        this.selectedTypeFilters = this.getTypeFilters();
        this.statusFilter.reset();
    }
    isFilterApplied() {
        var _a, _b;
        return (!!((_a = this.statusFilter$.getValue()) === null || _a === void 0 ? void 0 : _a.length) ||
            !!((_b = this.typeFilter$.getValue()) === null || _b === void 0 ? void 0 : _b.length) ||
            !!this.timeFilter$.getValue());
    }
    filter(statusFilters, timeFilter) {
        const status = statusFilters && statusFilters.length > 0
            ? {
                generalStatus: flatten(statusFilters.map(statusFilter => statusFilter.generalStatuses))
            }
            : {};
        const time = timeFilter
            ? Object.assign(Object.assign({}, (timeFilter.dateFrom && {
                dateFrom: timeFilter.dateFrom.toISOString()
            })), (timeFilter.dateTo && {
                dateTo: timeFilter.dateTo.toISOString()
            })) : {};
        return this.getBulkOperations(Object.assign(Object.assign({}, status), time));
    }
    getBulkOperations(filter) {
        return this.bulkOperationsService.getBulkOperations(filter);
    }
    getTypeFilters() {
        return this.bulkOperationsService.getBulkTypes();
    }
    addBulkOperation() {
        this.bulkOperationModalsService.showNewBulkOperationModal();
    }
    openFailedOperation(failedParentId) {
        this.listItems.forEach(item => {
            if (item.bulkOperation.id === failedParentId) {
                item.listItem.collapsed = false;
                item.listItem.element.nativeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }
    compareOperations(operationA, operationB) {
        return new Date(operationA.startDate).getTime() - new Date(operationB.startDate).getTime();
    }
    flattenFilterFragments(filters) {
        return (filters || []).reduce((flattened, current) => flattened.concat(current.fragments), []);
    }
}
BulkOperationsListComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-bulk-operations',
                template: "<c8y-title> {{ 'Device control' | translate }}</c8y-title>\n<c8y-action-bar-item *ngIf=\"bulkTypes?.length\" itemClass=\"navbar-form\" [placement]=\"'left'\">\n  <label translate class=\"hidden-sm\">Type</label>\n  <c8y-select\n    style=\"width: 180px\"\n    [items]=\"bulkTypes\"\n    [selected]=\"selectedTypeFilters\"\n    [disableApplyOnNoSelection]=\"true\"\n    (onChange)=\"selectedTypeFilters = $event; typeFilter$.next(selectedTypeFilters)\"\n  >\n  </c8y-select>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'left'\" itemClass=\"navbar-form\">\n  <c8y-status-filter\n    #statusFilter\n    [options]=\"bulkOperationStatusOptions\"\n    (onFilterChanged)=\"statusFilter$.next($event)\"\n  ></c8y-status-filter>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'left'\" itemClass=\"navbar-form\">\n  <c8y-date-picker (onDateSelected)=\"timeFilter$.next($event)\"></c8y-date-picker>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <c8y-realtime-btn [service]=\"realtime\"></c8y-realtime-btn>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button\n    *ngIf=\"bulkTypes?.length\"\n    class=\"btn btn-link d-flex a-i-center\"\n    (click)=\"addBulkOperation()\"\n    title=\"{{ 'Add bulk operation' | translate }}\"\n  >\n    <i c8yIcon=\"plus-circle\" class=\"m-r-4\"></i>\n    <span class=\"text-truncate\">\n      {{ 'Add bulk operation' | translate }}\n    </span>\n  </button>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button\n    class=\"btn btn-link d-flex a-i-center\"\n    title=\"{{ 'Reload' | translate }}\"\n    (click)=\"reload$.next()\"\n  >\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'icon-spin': refreshLoading }\" class=\"m-r-4\"></i>\n    <span class=\"text-truncate\">\n      {{ 'Reload' | translate }}\n    </span>\n  </button>\n</c8y-action-bar-item>\n\n<!-- Empty state -->\n<c8y-ui-empty-state\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && !isFilterApplied()\"\n  icon=\"c8y-energy\"\n  [title]=\"'No items to display' | translate\"\n  [subtitle]=\"'Bulk operations will be displayed here' | translate\"\n>\n  <button\n    type=\"button\"\n    *ngIf=\"bulkTypes?.length\"\n    title=\"{{ 'Add bulk operation' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"addBulkOperation()\"\n    translate\n  >\n    Add bulk operation\n  </button>\n</c8y-ui-empty-state>\n\n<!-- No results empty state -->\n<c8y-ui-empty-state\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && isFilterApplied()\"\n  icon=\"search\"\n  [title]=\"'No results to display.' | translate\"\n  [subtitle]=\"'Adjust or reset the filter.' | translate\"\n>\n  <button\n    type=\"button\"\n    title=\"{{ 'Reset filter' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"resetFilter()\"\n    translate\n  >\n    Reset filter\n  </button>\n</c8y-ui-empty-state>\n\n<!-- Detailed list of operations + load more button -->\n<c8y-list-group\n  class=\"m-b-24\"\n  [ngClass]=\"{ 'dd-low': (bulkOperations$ | async)?.data.length < 10 }\"\n>\n  <div\n    class=\"page-sticky-header hidden-xs c8y-list__item--double-actions c8y-list__item\"\n    *ngIf=\"(bulkOperations$ | async)?.data.length\"\n  >\n    <div class=\"c8y-list__item__block\">\n      <div class=\"c8y-list__item__icon\">\n        <i class=\"p-l-32 p-r-40\"></i>\n      </div>\n      <div class=\"c8y-list__item__body\">\n        <div class=\"content-flex-57\">\n          <div class=\"col-5\">\n            {{ 'Operation' | translate }}\n          </div>\n          <div class=\"flex-grow\">\n            {{ 'Progress' | translate }}\n          </div>\n          <div class=\"col-4\">\n            {{ 'Status' | translate }}\n          </div>\n        </div>\n      </div>\n      <div class=\"c8y-list__item__actions\"></div>\n    </div>\n  </div>\n  <div\n    class=\"d-contents\"\n    *c8yFor=\"\n      let bulkOperation of bulkOperations$ | async;\n      let i = index;\n      realtime: realtime;\n      pipe: filterPipe;\n      comparator: compareOperations.bind(this);\n      loadMore: 'auto'\n    \"\n  >\n    <c8y-bulk-operation-list-item\n      [bulkOperation]=\"bulkOperation\"\n      (reload)=\"reload$.next()\"\n      (showFailedOperation)=\"openFailedOperation($event)\"\n      class=\"d-contents\"\n    >\n    </c8y-bulk-operation-list-item>\n  </div>\n</c8y-list-group>\n",
                providers: [OperationBulkRealtimeService]
            },] }
];
BulkOperationsListComponent.ctorParameters = () => [
    { type: OperationBulkRealtimeService },
    { type: BulkOperationsService },
    { type: BulkOperationModalsService }
];
BulkOperationsListComponent.propDecorators = {
    listItems: [{ type: ViewChildren, args: [BulkOperationListItemComponent,] }],
    statusFilter: [{ type: ViewChild, args: ['statusFilter', { static: true },] }],
    datePicker: [{ type: ViewChild, args: [DatePickerComponent, { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLWxpc3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vb3BlcmF0aW9ucy9idWxrLW9wZXJhdGlvbnMtbGlzdC9idWxrLW9wZXJhdGlvbnMtbGlzdC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBcUIsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV0RixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN4RixPQUFPLEVBQ0wscUJBQXFCLEVBRXRCLE1BQU0sd0RBQXdELENBQUM7QUFFaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRixPQUFPLEVBRUwsOEJBQThCLEVBQzlCLDZCQUE2QixFQUM5QixNQUFNLHlEQUF5RCxDQUFDO0FBRWpFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBTXBGLE1BQU0sT0FBTywyQkFBMkI7SUF1Q3RDLFlBQ1MsUUFBc0MsRUFDckMscUJBQTRDLEVBQzVDLDBCQUFzRDtRQUZ2RCxhQUFRLEdBQVIsUUFBUSxDQUE4QjtRQUNyQywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQzVDLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7UUF6Q2hFLGNBQVMsR0FBb0IsRUFBRSxDQUFDO1FBQ2hDLHdCQUFtQixHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUM1QywrQkFBMEIsR0FBOEIsNkJBQTZCLENBQUM7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QUFDOzs7WUE1SUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxxQkFBcUI7Z0JBQy9CLDZ6SUFBb0Q7Z0JBQ3BELFNBQVMsRUFBRSxDQUFDLDRCQUE0QixDQUFDO2FBQzFDOzs7WUFwQjZCLDRCQUE0QjtZQUV4RCxxQkFBcUI7WUFhZCwwQkFBMEI7Ozt3QkFpQmhDLFlBQVksU0FBQyw4QkFBOEI7MkJBRTNDLFNBQVMsU0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3lCQUMxQyxTQUFTLFNBQUMsbUJBQW1CLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFF1ZXJ5TGlzdCwgVmlld0NoaWxkLCBWaWV3Q2hpbGRyZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElPcGVyYXRpb25CdWxrLCBJUmVzdWx0TGlzdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IERhdGVQaWNrZXJDb21wb25lbnQsIE9wZXJhdGlvbkJ1bGtSZWFsdGltZVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7XG4gIEJ1bGtPcGVyYXRpb25zU2VydmljZSxcbiAgT3BlcmF0aW9uVHlwZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UnO1xuaW1wb3J0IHsgU3RhdHVzRmlsdGVyQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL3N0YXR1cy1maWx0ZXInO1xuaW1wb3J0IHsgZmxhdHRlbiB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIHBpcGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCwgdGFwLCB3aXRoTGF0ZXN0RnJvbSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIE9wZXJhdGlvblN0YXR1c09wdGlvbnNNYXAsXG4gIEJ1bGtPcGVyYXRpb25MaXN0SXRlbUNvbXBvbmVudCxcbiAgQlVMS19PUEVSQVRJT05fU1RBVFVTX09QVElPTlNcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9uLWxpc3QtaXRlbSc7XG5pbXBvcnQgeyBTdGF0dXNPcHRpb24gfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvc2hhcmVkJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25Nb2RhbHNTZXJ2aWNlIH0gZnJvbSAnLi9tb2RhbHMvYnVsay1vcGVyYXRpb24tbW9kYWxzLnNlcnZpY2UnO1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWJ1bGstb3BlcmF0aW9ucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9idWxrLW9wZXJhdGlvbnMtbGlzdC5jb21wb25lbnQuaHRtbCcsXG4gIHByb3ZpZGVyczogW09wZXJhdGlvbkJ1bGtSZWFsdGltZVNlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25zTGlzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdID0gW107XG4gIHNlbGVjdGVkVHlwZUZpbHRlcnMgPSB0aGlzLmdldFR5cGVGaWx0ZXJzKCk7XG4gIGJ1bGtPcGVyYXRpb25TdGF0dXNPcHRpb25zOiBPcGVyYXRpb25TdGF0dXNPcHRpb25zTWFwID0gQlVMS19PUEVSQVRJT05fU1RBVFVTX09QVElPTlM7XG5cbiAgZmlsdGVyUGlwZTtcbiAgcmVmcmVzaExvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgc3RhdHVzRmlsdGVyJDogQmVoYXZpb3JTdWJqZWN0PFN0YXR1c09wdGlvbltdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHR5cGVGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8T3BlcmF0aW9uVHlwZVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHRpbWVGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8YW55PiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHJlbG9hZCQ6IEJlaGF2aW9yU3ViamVjdDx2b2lkPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIEBWaWV3Q2hpbGRyZW4oQnVsa09wZXJhdGlvbkxpc3RJdGVtQ29tcG9uZW50KVxuICBsaXN0SXRlbXM6IFF1ZXJ5TGlzdDxCdWxrT3BlcmF0aW9uTGlzdEl0ZW1Db21wb25lbnQ+O1xuICBAVmlld0NoaWxkKCdzdGF0dXNGaWx0ZXInLCB7IHN0YXRpYzogdHJ1ZSB9KSBzdGF0dXNGaWx0ZXI6IFN0YXR1c0ZpbHRlckNvbXBvbmVudDtcbiAgQFZpZXdDaGlsZChEYXRlUGlja2VyQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KSBkYXRlUGlja2VyOiBEYXRlUGlja2VyQ29tcG9uZW50O1xuXG4gIGJ1bGtPcGVyYXRpb25zJDogT2JzZXJ2YWJsZTxJUmVzdWx0TGlzdDxJT3BlcmF0aW9uQnVsaz4+ID0gY29tYmluZUxhdGVzdChcbiAgICB0aGlzLnN0YXR1c0ZpbHRlciQsXG4gICAgdGhpcy50aW1lRmlsdGVyJCxcbiAgICB0aGlzLnR5cGVGaWx0ZXIkLFxuICAgIHRoaXMucmVsb2FkJFxuICApLnBpcGUoXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMucmVmcmVzaExvYWRpbmcgPSB0cnVlO1xuICAgIH0pLFxuICAgIHN3aXRjaE1hcCgoW3N0YXR1c0ZpbHRlcnMsIHRpbWVGaWx0ZXJzXSkgPT4gdGhpcy5maWx0ZXIoc3RhdHVzRmlsdGVycywgdGltZUZpbHRlcnMpKSxcbiAgICB3aXRoTGF0ZXN0RnJvbSh0aGlzLnR5cGVGaWx0ZXIkKSxcbiAgICBtYXAoKFtyZXN1bHQsIHR5cGVGaWx0ZXJdOiBbSVJlc3VsdExpc3Q8SU9wZXJhdGlvbkJ1bGs+LCBPcGVyYXRpb25UeXBlW11dKSA9PiB7XG4gICAgICB0aGlzLmZpbHRlclBpcGUgPSBwaXBlKG1hcCgoZGF0YTogW10pID0+IHRoaXMuZmlsdGVyQnlUeXBlKGRhdGEsIHR5cGVGaWx0ZXIpKSk7XG4gICAgICByZXR1cm4geyAuLi5yZXN1bHQsIGRhdGE6IHRoaXMuZmlsdGVyQnlUeXBlKHJlc3VsdC5kYXRhLCB0eXBlRmlsdGVyKSB9O1xuICAgIH0pLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnJlZnJlc2hMb2FkaW5nID0gZmFsc2U7XG4gICAgfSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcblxuICBwcml2YXRlIGFsbEZpbHRlckZyYWdtZW50czogc3RyaW5nW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWx0aW1lOiBPcGVyYXRpb25CdWxrUmVhbHRpbWVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnVsa09wZXJhdGlvbnNTZXJ2aWNlOiBCdWxrT3BlcmF0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBidWxrT3BlcmF0aW9uTW9kYWxzU2VydmljZTogQnVsa09wZXJhdGlvbk1vZGFsc1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5hbGxGaWx0ZXJGcmFnbWVudHMgPSB0aGlzLmZsYXR0ZW5GaWx0ZXJGcmFnbWVudHModGhpcy5nZXRUeXBlRmlsdGVycygpKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gdGhpcy5idWxrT3BlcmF0aW9uc1NlcnZpY2UuZ2V0QnVsa1R5cGVzKCk7XG4gIH1cblxuICBmaWx0ZXJCeVR5cGUoYnVsa09wZXJhdGlvbnM6IElPcGVyYXRpb25CdWxrW10sIHR5cGVGaWx0ZXIpIHtcbiAgICBjb25zdCBmbGF0dGVuZWRGcmFnbWVudHM6IHN0cmluZ1tdID0gdGhpcy5mbGF0dGVuRmlsdGVyRnJhZ21lbnRzKHR5cGVGaWx0ZXIpO1xuICAgIGlmIChcbiAgICAgIC8vIHJldHVybiBkYXRhIHVuZmlsdGVyZWQgaWYgbm8gZmlsdGVycyBzZWxlY3RlZC4uLlxuICAgICAgIWZsYXR0ZW5lZEZyYWdtZW50cy5sZW5ndGggfHxcbiAgICAgIC8vIC4uLm9yIHdoZW4gYWxsIGZpbHRlcnMgYXJlIHNlbGVjdGVkXG4gICAgICB0aGlzLmFsbEZpbHRlckZyYWdtZW50cy5ldmVyeShmcmFnbWVudCA9PiBmbGF0dGVuZWRGcmFnbWVudHMuaW5jbHVkZXMoZnJhZ21lbnQpKVxuICAgICkge1xuICAgICAgcmV0dXJuIGJ1bGtPcGVyYXRpb25zO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbHRlcmVkRGF0YSA9IGJ1bGtPcGVyYXRpb25zLmZpbHRlcihpdGVtID0+IHtcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhpdGVtLm9wZXJhdGlvblByb3RvdHlwZSkuc29tZShrZXkgPT4gZmxhdHRlbmVkRnJhZ21lbnRzLmluY2x1ZGVzKGtleSkpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZpbHRlcmVkRGF0YTtcbiAgfVxuXG4gIHJlc2V0RmlsdGVyKCkge1xuICAgIHRoaXMuc3RhdHVzRmlsdGVyJC5uZXh0KG51bGwpO1xuICAgIHRoaXMudGltZUZpbHRlciQubmV4dChudWxsKTtcbiAgICB0aGlzLnR5cGVGaWx0ZXIkLm5leHQobnVsbCk7XG5cbiAgICB0aGlzLmRhdGVQaWNrZXIuY2xlYXJGaWx0ZXIoKTtcbiAgICB0aGlzLnNlbGVjdGVkVHlwZUZpbHRlcnMgPSB0aGlzLmdldFR5cGVGaWx0ZXJzKCk7XG4gICAgdGhpcy5zdGF0dXNGaWx0ZXIucmVzZXQoKTtcbiAgfVxuXG4gIGlzRmlsdGVyQXBwbGllZCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgISF0aGlzLnN0YXR1c0ZpbHRlciQuZ2V0VmFsdWUoKT8ubGVuZ3RoIHx8XG4gICAgICAhIXRoaXMudHlwZUZpbHRlciQuZ2V0VmFsdWUoKT8ubGVuZ3RoIHx8XG4gICAgICAhIXRoaXMudGltZUZpbHRlciQuZ2V0VmFsdWUoKVxuICAgICk7XG4gIH1cblxuICBmaWx0ZXIoc3RhdHVzRmlsdGVycywgdGltZUZpbHRlcikge1xuICAgIGNvbnN0IHN0YXR1cyA9XG4gICAgICBzdGF0dXNGaWx0ZXJzICYmIHN0YXR1c0ZpbHRlcnMubGVuZ3RoID4gMFxuICAgICAgICA/IHtcbiAgICAgICAgICAgIGdlbmVyYWxTdGF0dXM6IGZsYXR0ZW4oc3RhdHVzRmlsdGVycy5tYXAoc3RhdHVzRmlsdGVyID0+IHN0YXR1c0ZpbHRlci5nZW5lcmFsU3RhdHVzZXMpKVxuICAgICAgICAgIH1cbiAgICAgICAgOiB7fTtcblxuICAgIGNvbnN0IHRpbWUgPSB0aW1lRmlsdGVyXG4gICAgICA/IHtcbiAgICAgICAgICAuLi4odGltZUZpbHRlci5kYXRlRnJvbSAmJiB7XG4gICAgICAgICAgICBkYXRlRnJvbTogdGltZUZpbHRlci5kYXRlRnJvbS50b0lTT1N0cmluZygpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgLi4uKHRpbWVGaWx0ZXIuZGF0ZVRvICYmIHtcbiAgICAgICAgICAgIGRhdGVUbzogdGltZUZpbHRlci5kYXRlVG8udG9JU09TdHJpbmcoKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIDoge307XG4gICAgcmV0dXJuIHRoaXMuZ2V0QnVsa09wZXJhdGlvbnMoeyAuLi5zdGF0dXMsIC4uLnRpbWUgfSk7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9ucyhmaWx0ZXI/KSB7XG4gICAgcmV0dXJuIHRoaXMuYnVsa09wZXJhdGlvbnNTZXJ2aWNlLmdldEJ1bGtPcGVyYXRpb25zKGZpbHRlcik7XG4gIH1cblxuICBnZXRUeXBlRmlsdGVycygpIHtcbiAgICByZXR1cm4gdGhpcy5idWxrT3BlcmF0aW9uc1NlcnZpY2UuZ2V0QnVsa1R5cGVzKCk7XG4gIH1cblxuICBhZGRCdWxrT3BlcmF0aW9uKCkge1xuICAgIHRoaXMuYnVsa09wZXJhdGlvbk1vZGFsc1NlcnZpY2Uuc2hvd05ld0J1bGtPcGVyYXRpb25Nb2RhbCgpO1xuICB9XG5cbiAgb3BlbkZhaWxlZE9wZXJhdGlvbihmYWlsZWRQYXJlbnRJZCkge1xuICAgIHRoaXMubGlzdEl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAoaXRlbS5idWxrT3BlcmF0aW9uLmlkID09PSBmYWlsZWRQYXJlbnRJZCkge1xuICAgICAgICBpdGVtLmxpc3RJdGVtLmNvbGxhcHNlZCA9IGZhbHNlO1xuICAgICAgICBpdGVtLmxpc3RJdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudC5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiAnc21vb3RoJywgYmxvY2s6ICdjZW50ZXInIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY29tcGFyZU9wZXJhdGlvbnMob3BlcmF0aW9uQTogSU9wZXJhdGlvbkJ1bGssIG9wZXJhdGlvbkI6IElPcGVyYXRpb25CdWxrKTogbnVtYmVyIHtcbiAgICByZXR1cm4gbmV3IERhdGUob3BlcmF0aW9uQS5zdGFydERhdGUpLmdldFRpbWUoKSAtIG5ldyBEYXRlKG9wZXJhdGlvbkIuc3RhcnREYXRlKS5nZXRUaW1lKCk7XG4gIH1cblxuICBwcml2YXRlIGZsYXR0ZW5GaWx0ZXJGcmFnbWVudHMoZmlsdGVyczogT3BlcmF0aW9uVHlwZVtdKTogc3RyaW5nW10ge1xuICAgIHJldHVybiAoZmlsdGVycyB8fCBbXSkucmVkdWNlKChmbGF0dGVuZWQsIGN1cnJlbnQpID0+IGZsYXR0ZW5lZC5jb25jYXQoY3VycmVudC5mcmFnbWVudHMpLCBbXSk7XG4gIH1cbn1cbiJdfQ==