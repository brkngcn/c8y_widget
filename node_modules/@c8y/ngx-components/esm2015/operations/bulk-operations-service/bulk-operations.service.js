import { __awaiter } from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { InventoryService, OperationBulkService, OperationService } from '@c8y/client';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@angular/common';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return __awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
}
BulkOperationsService.ɵfac = function BulkOperationsService_Factory(t) { return new (t || BulkOperationsService)(ɵngcc0.ɵɵinject(ɵngcc1.OperationBulkService), ɵngcc0.ɵɵinject(ɵngcc1.OperationService), ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc2.Location), ɵngcc0.ɵɵinject(HOOK_LIST_BULK_TYPE, 8)); };
BulkOperationsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: BulkOperationsService, factory: BulkOperationsService.ɵfac });
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: Location },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(BulkOperationsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.OperationBulkService }, { type: ɵngcc1.OperationService }, { type: ɵngcc1.InventoryService }, { type: ɵngcc2.Location }, { type: Array, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HOOK_LIST_BULK_TYPE]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UvYnVsay1vcGVyYXRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFHTCxnQkFBZ0IsRUFJaEIsb0JBQW9CLEVBQ3BCLGdCQUFnQixFQUNqQixNQUFNLGFBQWEsQ0FBQzs7OztBQU1yQixNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsOEJBQThCLENBQUM7QUFDdEQsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxjQUFjLENBQ25ELGdCQUFnQixDQUNqQixDQUFDO0FBR0YsTUFBTSxPQUFPLHFCQUFxQjtBQUNsQyxJQUtFLFlBQ1Usb0JBQTBDLEVBQzFDLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsUUFBa0IsRUFFZSxTQUFpRDtBQUMzRixRQU5TLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7QUFBQyxRQUMzQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUFDLFFBQ25DLGFBQVEsR0FBUixRQUFRLENBQVU7QUFBQyxRQVRwQixpQkFBWSxHQUFXLEVBQUUsQ0FBQztBQUNyQyxRQUFFLGVBQVUsR0FBeUIsSUFBSSxPQUFPLEVBQWUsQ0FBQztBQUNoRSxRQVdJLElBQUksQ0FBQyxTQUFTLEdBQUcs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Z0JBQVEsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDdEIsZ0JBQVEsT0FBTyxJQUFJLENBQUM7QUFDcEIsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxRQUNJLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNIO2lEQTNIQyxVQUFVOzZJQUNUO0FBQUM7QUFDVSxZQWZYLG9CQUFvQjtBQUNwQixZQUFBLGdCQUFnQjtBQUNmLFlBTkQsZ0JBQWdCO0FBQ2hCLFlBVE8sUUFBUTtBQUFJLFlBc0NtQyxLQUFLLHVCQUF4RCxRQUFRLFlBQUksTUFBTSxTQUFDLG1CQUFtQjtBQUFROzs7Ozs7OztrQ0FBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZsYXR0ZW4sIGhhcywgaXNVbmRlZmluZWQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBJZFJlZmVyZW5jZSxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElPcGVyYXRpb24sXG4gIElPcGVyYXRpb25CdWxrLFxuICBJUmVzdWx0LFxuICBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgT3BlcmF0aW9uU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbmltcG9ydCB7IE9wZXJhdGlvbkRldGFpbHMgfSBmcm9tICcuL29wZXJhdGlvbi1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7IE9wZXJhdGlvblR5cGUgfSBmcm9tICcuL29wZXJhdGlvbi10eXBlLm1vZGVsJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9idWxrLW9wZXJhdGlvbi5tb2RlbCc7XG5cbmV4cG9ydCBjb25zdCBiYXNlVXJsID0gJ2RldmljZWNvbnRyb2wvYnVsay9jcmVhdGlvbi8nO1xuZXhwb3J0IGNvbnN0IEhPT0tfTElTVF9CVUxLX1RZUEUgPSBuZXcgSW5qZWN0aW9uVG9rZW48T3BlcmF0aW9uVHlwZSB8IE9wZXJhdGlvblR5cGVbXT4oXG4gICdMSVNUX0JVTEtfVFlQRSdcbik7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCdWxrT3BlcmF0aW9uc1NlcnZpY2Uge1xuICByZWFkb25seSBERF9MT1dfQ09VTlQ6IG51bWJlciA9IDEwO1xuICBmaXJtd2FyZUlkOiBTdWJqZWN0PElkUmVmZXJlbmNlPiA9IG5ldyBTdWJqZWN0PElkUmVmZXJlbmNlPigpO1xuXG4gIHByaXZhdGUgYnVsa1R5cGVzOiBPcGVyYXRpb25UeXBlW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25CdWxrU2VydmljZTogT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbixcblxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSE9PS19MSVNUX0JVTEtfVFlQRSkgYnVsa1R5cGVzOiBBcnJheTxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPlxuICApIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGZsYXR0ZW4oYnVsa1R5cGVzKTtcblxuICAgIHRoaXMuYnVsa1R5cGVzID0gdGhpcy5idWxrVHlwZXMubWFwKHR5cGUgPT4ge1xuICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUuc2VsZWN0ZWQpKSB7XG4gICAgICAgIHR5cGUuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0eXBlO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbnMoY3VzdG9tRmlsdGVyID0ge30pIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIHdpdGhEZWxldGVkOiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgLi4uY3VzdG9tRmlsdGVyXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25CeUlkKGJ1bGtPcGVyYXRpb25JZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGV0YWlsKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICBjcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuY3JlYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZGVsZXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZWxldGUoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIHVwZGF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS51cGRhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRPcGVyYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdDxJT3BlcmF0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuZGV0YWlsKGlkKTtcbiAgfVxuXG4gIHJldHVyblRvQnVsa09wZXJhdGlvbk92ZXJ2aWV3KCkge1xuICAgIHRoaXMubG9jYXRpb24uYmFjaygpO1xuICB9XG5cbiAgc2V0QnVsa1R5cGVzKGxpc3Q6IE9wZXJhdGlvblR5cGVbXSkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gbGlzdDtcbiAgfVxuXG4gIGdldEJ1bGtUeXBlcygpOiBPcGVyYXRpb25UeXBlW10ge1xuICAgIHJldHVybiB0aGlzLmJ1bGtUeXBlcztcbiAgfVxuXG4gIHNldEZpcm13YXJlSWQoaWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgdGhpcy5maXJtd2FyZUlkLm5leHQoaWQpO1xuICB9XG5cbiAgY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlEYXRhU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+ID0ge1xuICAgICAgbmFtZTogJ0J1bGsgb3BlcmF0aW9ucyBncm91cCcsXG4gICAgICB0eXBlOiAnYzh5X0R5bmFtaWNHcm91cCcsXG4gICAgICBjOHlfSXNEeW5hbWljR3JvdXA6IHsgaW52aXNpYmxlOiB7fSB9LFxuICAgICAgYzh5X0RldmljZVF1ZXJ5U3RyaW5nOiBkZXZpY2VRdWVyeURhdGFTdHJpbmdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZHluYW1pY0dyb3VwKTtcbiAgfVxuXG4gIGFzeW5jIHNjaGVkdWxlQnVsa09wZXJhdGlvbihkZXZpY2VRdWVyeVN0cmluZzogc3RyaW5nLCBkZXRhaWxzOiBPcGVyYXRpb25EZXRhaWxzKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwID0gYXdhaXQgdGhpcy5jcmVhdGVHcm91cChkZXZpY2VRdWVyeVN0cmluZyk7XG5cbiAgICBjb25zdCBidWxrT3BlcmF0aW9uOiBJT3BlcmF0aW9uQnVsayA9IHtcbiAgICAgIGdyb3VwSWQ6IGR5bmFtaWNHcm91cC5kYXRhLmlkLFxuICAgICAgb3BlcmF0aW9uUHJvdG90eXBlOiBkZXRhaWxzLnByb3RvdHlwZSxcbiAgICAgIGNyZWF0aW9uUmFtcDogZGV0YWlscy5zY2hlZHVsZS5kZWxheUluU2Vjb25kcyxcbiAgICAgIHN0YXJ0RGF0ZTogZGV0YWlscy5zY2hlZHVsZS5zY2hlZHVsZWREYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICBub3RlOiBkZXRhaWxzLm5vdGVcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0U2luZ2xlT3BlcmF0aW9uc0J5U3RhdHVzKHN0YXR1cywgYnVsa09wZXJhdGlvbklkKSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICBidWxrT3BlcmF0aW9uSWQsXG4gICAgICBzdGF0dXM6IChzdGF0dXMgJiYgc3RhdHVzLnRvVXBwZXJDYXNlKCkpIHx8ICcnXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgdXBkYXRlU2luZ2xlT3BlcmF0aW9uKHBhcnRpYWxVcGRhdGVPYmplY3Q6IFBhcnRpYWw8SU9wZXJhdGlvbj4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLnVwZGF0ZShwYXJ0aWFsVXBkYXRlT2JqZWN0KTtcbiAgfVxuXG4gIHJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogQnVsa09wZXJhdGlvblR5cGUge1xuICAgIGxldCB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcblxuICAgIHRoaXMuYnVsa1R5cGVzLnNvbWUodCA9PiB7XG4gICAgICBpZiAodC5mcmFnbWVudHMuc29tZShmcmFnbWVudCA9PiBoYXMob3BlcmF0aW9uLCBmcmFnbWVudCkpKSB7XG4gICAgICAgIHR5cGUgPSB0LnR5cGU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHR5cGU7XG4gIH1cbn1cbiJdfQ==