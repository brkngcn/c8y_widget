import { __awaiter } from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { InventoryService, OperationBulkService, OperationService } from '@c8y/client';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return __awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
}
BulkOperationsService.decorators = [
    { type: Injectable }
];
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: Location },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBR0wsZ0JBQWdCLEVBSWhCLG9CQUFvQixFQUNwQixnQkFBZ0IsRUFDakIsTUFBTSxhQUFhLENBQUM7QUFNckIsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUNuRCxnQkFBZ0IsQ0FDakIsQ0FBQztBQUdGLE1BQU0sT0FBTyxxQkFBcUI7SUFNaEMsWUFDVSxvQkFBMEMsRUFDMUMsZ0JBQWtDLEVBQ2xDLGdCQUFrQyxFQUNsQyxRQUFrQixFQUVlLFNBQWlEO1FBTGxGLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFUbkIsaUJBQVksR0FBVyxFQUFFLENBQUM7UUFDbkMsZUFBVSxHQUF5QixJQUFJLE9BQU8sRUFBZSxDQUFDO1FBWTVELElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FB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UUFDakQsTUFBTSxNQUFNLEdBQUc7WUFDYixjQUFjLEVBQUUsSUFBSTtZQUNwQixlQUFlO1lBQ2YsTUFBTSxFQUFFLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUU7U0FDL0MsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQscUJBQXFCLENBQUMsbUJBQXdDO1FBQzVELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCx5QkFBeUIsQ0FBQyxTQUFxQjtRQUM3QyxJQUFJLElBQXVCLENBQUM7UUFFNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDdEIsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUMsRUFBRTtnQkFDMUQsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2QsT0FBTyxJQUFJLENBQUM7YUFDYjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7WUExSEYsVUFBVTs7O1lBYlQsb0JBQW9CO1lBQ3BCLGdCQUFnQjtZQUxoQixnQkFBZ0I7WUFSVCxRQUFRO1lBc0N1QyxLQUFLLHVCQUF4RCxRQUFRLFlBQUksTUFBTSxTQUFDLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmbGF0dGVuLCBoYXMsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtcbiAgSWRSZWZlcmVuY2UsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJT3BlcmF0aW9uQnVsayxcbiAgSVJlc3VsdCxcbiAgT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gIE9wZXJhdGlvblNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzIH0gZnJvbSAnLi9vcGVyYXRpb24tZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9vcGVyYXRpb24tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24ubW9kZWwnO1xuXG5leHBvcnQgY29uc3QgYmFzZVVybCA9ICdkZXZpY2Vjb250cm9sL2J1bGsvY3JlYXRpb24vJztcbmV4cG9ydCBjb25zdCBIT09LX0xJU1RfQlVMS19UWVBFID0gbmV3IEluamVjdGlvblRva2VuPE9wZXJhdGlvblR5cGUgfCBPcGVyYXRpb25UeXBlW10+KFxuICAnTElTVF9CVUxLX1RZUEUnXG4pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvbnNTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgRERfTE9XX0NPVU5UOiBudW1iZXIgPSAxMDtcbiAgZmlybXdhcmVJZDogU3ViamVjdDxJZFJlZmVyZW5jZT4gPSBuZXcgU3ViamVjdDxJZFJlZmVyZW5jZT4oKTtcblxuICBwcml2YXRlIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgb3BlcmF0aW9uQnVsa1NlcnZpY2U6IE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24sXG5cbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhPT0tfTElTVF9CVUxLX1RZUEUpIGJ1bGtUeXBlczogQXJyYXk8T3BlcmF0aW9uVHlwZSB8IE9wZXJhdGlvblR5cGVbXT5cbiAgKSB7XG4gICAgdGhpcy5idWxrVHlwZXMgPSBmbGF0dGVuKGJ1bGtUeXBlcyk7XG5cbiAgICB0aGlzLmJ1bGtUeXBlcyA9IHRoaXMuYnVsa1R5cGVzLm1hcCh0eXBlID0+IHtcbiAgICAgIGlmIChpc1VuZGVmaW5lZCh0eXBlLnNlbGVjdGVkKSkge1xuICAgICAgICB0eXBlLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHlwZTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25zKGN1c3RvbUZpbHRlciA9IHt9KSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICB3aXRoRGVsZXRlZDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiA1MCxcbiAgICAgIC4uLmN1c3RvbUZpbHRlclxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5saXN0KGZpbHRlcik7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9uQnlJZChidWxrT3BlcmF0aW9uSWQ6IHN0cmluZyB8IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmRldGFpbChidWxrT3BlcmF0aW9uSWQpO1xuICB9XG5cbiAgY3JlYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uOiBQYXJ0aWFsPElPcGVyYXRpb25CdWxrPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmNyZWF0ZShidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGRlbGV0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbklkKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGVsZXRlKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICB1cGRhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UudXBkYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0T3BlcmF0aW9uKGlkOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHQ8SU9wZXJhdGlvbj4+IHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmRldGFpbChpZCk7XG4gIH1cblxuICByZXR1cm5Ub0J1bGtPcGVyYXRpb25PdmVydmlldygpIHtcbiAgICB0aGlzLmxvY2F0aW9uLmJhY2soKTtcbiAgfVxuXG4gIHNldEJ1bGtUeXBlcyhsaXN0OiBPcGVyYXRpb25UeXBlW10pIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGxpc3Q7XG4gIH1cblxuICBnZXRCdWxrVHlwZXMoKTogT3BlcmF0aW9uVHlwZVtdIHtcbiAgICByZXR1cm4gdGhpcy5idWxrVHlwZXM7XG4gIH1cblxuICBzZXRGaXJtd2FyZUlkKGlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHRoaXMuZmlybXdhcmVJZC5uZXh0KGlkKTtcbiAgfVxuXG4gIGNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5RGF0YVN0cmluZzogc3RyaW5nKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHtcbiAgICAgIG5hbWU6ICdCdWxrIG9wZXJhdGlvbnMgZ3JvdXAnLFxuICAgICAgdHlwZTogJ2M4eV9EeW5hbWljR3JvdXAnLFxuICAgICAgYzh5X0lzRHluYW1pY0dyb3VwOiB7IGludmlzaWJsZToge30gfSxcbiAgICAgIGM4eV9EZXZpY2VRdWVyeVN0cmluZzogZGV2aWNlUXVlcnlEYXRhU3RyaW5nXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGR5bmFtaWNHcm91cCk7XG4gIH1cblxuICBhc3luYyBzY2hlZHVsZUJ1bGtPcGVyYXRpb24oZGV2aWNlUXVlcnlTdHJpbmc6IHN0cmluZywgZGV0YWlsczogT3BlcmF0aW9uRGV0YWlscykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cCA9IGF3YWl0IHRoaXMuY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlTdHJpbmcpO1xuXG4gICAgY29uc3QgYnVsa09wZXJhdGlvbjogSU9wZXJhdGlvbkJ1bGsgPSB7XG4gICAgICBncm91cElkOiBkeW5hbWljR3JvdXAuZGF0YS5pZCxcbiAgICAgIG9wZXJhdGlvblByb3RvdHlwZTogZGV0YWlscy5wcm90b3R5cGUsXG4gICAgICBjcmVhdGlvblJhbXA6IGRldGFpbHMuc2NoZWR1bGUuZGVsYXlJblNlY29uZHMsXG4gICAgICBzdGFydERhdGU6IGRldGFpbHMuc2NoZWR1bGUuc2NoZWR1bGVkRGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgbm90ZTogZGV0YWlscy5ub3RlXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldFNpbmdsZU9wZXJhdGlvbnNCeVN0YXR1cyhzdGF0dXMsIGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgYnVsa09wZXJhdGlvbklkLFxuICAgICAgc3RhdHVzOiAoc3RhdHVzICYmIHN0YXR1cy50b1VwcGVyQ2FzZSgpKSB8fCAnJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIHVwZGF0ZVNpbmdsZU9wZXJhdGlvbihwYXJ0aWFsVXBkYXRlT2JqZWN0OiBQYXJ0aWFsPElPcGVyYXRpb24+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS51cGRhdGUocGFydGlhbFVwZGF0ZU9iamVjdCk7XG4gIH1cblxuICByZXRyaWV2ZUJ1bGtPcGVyYXRpb25UeXBlKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IEJ1bGtPcGVyYXRpb25UeXBlIHtcbiAgICBsZXQgdHlwZTogQnVsa09wZXJhdGlvblR5cGU7XG5cbiAgICB0aGlzLmJ1bGtUeXBlcy5zb21lKHQgPT4ge1xuICAgICAgaWYgKHQuZnJhZ21lbnRzLnNvbWUoZnJhZ21lbnQgPT4gaGFzKG9wZXJhdGlvbiwgZnJhZ21lbnQpKSkge1xuICAgICAgICB0eXBlID0gdC50eXBlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB0eXBlO1xuICB9XG59XG4iXX0=