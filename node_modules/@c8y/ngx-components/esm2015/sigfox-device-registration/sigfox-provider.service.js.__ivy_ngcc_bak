import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService, FetchClient, InventoryService, TenantOptionsService } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import { gettext } from '@c8y/ngx-components';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/core/FetchClient";
import * as i2 from "@c8y/client/lib/src/inventory/InventoryService";
import * as i3 from "@c8y/client/lib/src/tenant-options/TenantOptionsService";
import * as i4 from "@ngx-translate/core";
import * as i5 from "@c8y/client/lib/src/application/ApplicationService";
export var ErrorName;
(function (ErrorName) {
    ErrorName["NoDeviceProtocolsError"] = "NoDeviceProtocolsError";
    ErrorName["NoConnectivitySettingsError"] = "NoConnectivitySettingsError";
    ErrorName["ContractError"] = "ContractError";
    ErrorName["NoContractsError"] = "NoContractsError";
    ErrorName["RegistrationError"] = "RegistrationError";
    ErrorName["DeviceProtocolsFetchError"] = "DeviceProtocolsFetchError";
})(ErrorName || (ErrorName = {}));
export class SigfoxProviderService {
    constructor(client, inventoryService, tenantOptions, translateService, applicationService) {
        this.client = client;
        this.inventoryService = inventoryService;
        this.tenantOptions = tenantOptions;
        this.translateService = translateService;
        this.applicationService = applicationService;
        this.baseUrl = '/service/sigfox-agent/';
        this.registrationUrl = `${this.baseUrl}newDeviceRequest`;
        this.contractsUrl = `${this.baseUrl}contract`;
        this.header = { 'Content-Type': 'application/json' };
    }
    getConnections() {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.header
            };
            const res = yield this.client.fetch(`${this.baseUrl}lns-connection`, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    yield this.throwNoConnectivitySettingsError();
                }
            }
            else {
                yield this.throwNoConnectivitySettingsError();
            }
            return { res, data };
        });
    }
    /**
     * Gets contracts from Sigfox platform.
     * @param connectionName The name of connection for which contracts will be retrieved
     * @returns The result list with contract, or throws an error with exception.
     */
    getContracts(connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.header,
                params: {
                    sigfoxConnectionName: connectionName
                }
            };
            const res = yield this.client.fetch(this.contractsUrl, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoContractsError();
                }
            }
            else {
                this.throwContractError(data);
            }
            return { res, data };
        });
    }
    createDevice(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'POST',
                headers: this.header,
                body: JSON.stringify(device)
            };
            const res = yield this.client.fetch(this.registrationUrl, options);
            const data = yield res.json();
            if (res.status !== 201) {
                this.throwRegistrationError(data);
            }
            return { res, data };
        });
    }
    getAvailableProtocols(filter = { withTotalPages: true }) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                __filter: {
                    __and: [
                        { __has: 'c8y_IsDeviceType' },
                        {
                            type: { __in: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'] }
                        }
                    ]
                },
                __orderby: [{ name: 1 }]
            };
            const { res, data } = yield this.inventoryService.listQuery(query, filter);
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoDeviceProtocolsError();
                }
            }
            else {
                this.throwDeviceProtocolsFetchError();
            }
            return { res, data };
        });
    }
    hasConnectivitySettings() {
        return __awaiter(this, void 0, void 0, function* () {
            const option = {
                category: 'sigfox-agent',
                key: 'provider.token'
            };
            try {
                yield this.tenantOptions.detail(option);
                return true;
            }
            catch (e) {
                yield this.throwNoConnectivitySettingsError();
            }
        });
    }
    throwNoConnectivitySettingsError() {
        return __awaiter(this, void 0, void 0, function* () {
            const error = new Error();
            error.name = ErrorName.NoConnectivitySettingsError;
            const hasAdminRight = (yield this.applicationService.isAvailable('administration')).data;
            if (hasAdminRight) {
                error.message = this.translateService.instant(gettext(`Connectivity settings are not configured. Configure them in the Administration app under <a href="{{ link }}">Settings</a>.`), {
                    link: '/apps/administration/index.html#/connectivitySettings/sigfox_provider_settings'
                });
            }
            else {
                error.message = gettext('Connectivity settings are not configured. Contact the administrator.');
            }
            throw error;
        });
    }
    throwRegistrationError(data) {
        const error = new Error();
        error.name = ErrorName.RegistrationError;
        error.message = data.message;
        throw error;
    }
    throwDeviceProtocolsFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProtocolsFetchError;
        error.message = gettext('Could not load device protocols.');
        throw error;
    }
    throwNoDeviceProtocolsError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProtocolsError;
        error.message = this.translateService.instant(gettext(`No device protocols configured. Create a Sigfox device protocol in <a href="{{ link }}">Device protocols</a>.`), {
            link: '/apps/devicemanagement/#/deviceprotocols'
        });
        throw error;
    }
    throwContractError(data) {
        const error = new Error();
        error.name = ErrorName.ContractError;
        error.message = data.message;
        throw error;
    }
    throwNoContractsError() {
        const error = new Error();
        error.name = ErrorName.NoContractsError;
        error.message = gettext('No contracts found. New contracts must be created via the Sigfox platform.');
        throw error;
    }
}
SigfoxProviderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SigfoxProviderService_Factory() { return new SigfoxProviderService(i0.ɵɵinject(i1.FetchClient), i0.ɵɵinject(i2.InventoryService), i0.ɵɵinject(i3.TenantOptionsService), i0.ɵɵinject(i4.TranslateService), i0.ɵɵinject(i5.ApplicationService)); }, token: SigfoxProviderService, providedIn: "root" });
SigfoxProviderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
SigfoxProviderService.ctorParameters = () => [
    { type: FetchClient },
    { type: InventoryService },
    { type: TenantOptionsService },
    { type: TranslateService },
    { type: ApplicationService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnZm94LXByb3ZpZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zaWdmb3gtZGV2aWNlLXJlZ2lzdHJhdGlvbi9zaWdmb3gtcHJvdmlkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFdBQVcsRUFHWCxnQkFBZ0IsRUFJaEIsb0JBQW9CLEVBQ3JCLE1BQU0sYUFBYSxDQUFDO0FBRXJCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7OztBQUU5QyxNQUFNLENBQU4sSUFBWSxTQU9YO0FBUEQsV0FBWSxTQUFTO0lBQ25CLDhEQUFpRCxDQUFBO0lBQ2pELHdFQUEyRCxDQUFBO0lBQzNELDRDQUErQixDQUFBO0lBQy9CLGtEQUFxQyxDQUFBO0lBQ3JDLG9EQUF1QyxDQUFBO0lBQ3ZDLG9FQUF1RCxDQUFBO0FBQ3pELENBQUMsRUFQVyxTQUFTLEtBQVQsU0FBUyxRQU9wQjtBQUtELE1BQU0sT0FBTyxxQkFBcUI7SUFNaEMsWUFDVSxNQUFtQixFQUNuQixnQkFBa0MsRUFDbEMsYUFBbUMsRUFDbkMsZ0JBQWtDLEVBQ2xDLGtCQUFzQztRQUp0QyxXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQ25DLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQVYvQixZQUFPLEdBQVcsd0JBQXdCLENBQUM7UUFDM0Msb0JBQWUsR0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLGtCQUFrQixDQUFDO1FBQzVELGlCQUFZLEdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxVQUFVLENBQUM7UUFDakQsV0FBTSxHQUFRLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFRbkUsQ0FBQztJQUNFLGNBQWM7O1lBQ2xCLE1BQU0sT0FBTyxHQUFrQjtnQkFDN0IsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNO2FBQ3JCLENBQUM7WUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUUsTUFBTSxJQUFJLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFOUIsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtnQkFDdEIsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtvQkFDdkIsTUFBTSxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztpQkFDN0M7YUFDRjtpQkFBTTtnQkFDTCxNQUFNLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO2FBQy9DO1lBQ0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUN2QixDQUFDO0tBQUE7SUFFRDs7OztPQUlHO0lBQ0csWUFBWSxDQUFDLGNBQXNCOztZQUN2QyxNQUFNLE9BQU8sR0FBa0I7Z0JBQzdCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTTtnQkFDcEIsTUFBTSxFQUFFO29CQUNOLG9CQUFvQixFQUFFLGNBQWM7aUJBQ3JDO2FBQ0YsQ0FBQztZQUNGLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVoRSxNQUFNLElBQUksR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUU5QixJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO2dCQUN0QixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUNyQixJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztpQkFDOUI7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDL0I7WUFDRCxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3ZCLENBQUM7S0FBQTtJQUVLLFlBQVksQ0FBQyxNQUFvQjs7WUFDckMsTUFBTSxPQUFPLEdBQWtCO2dCQUM3QixNQUFNLEVBQUUsTUFBTTtnQkFDZCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQzthQUM3QixDQUFDO1lBQ0YsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ25FLE1BQU0sSUFBSSxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRTlCLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNuQztZQUNELE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDdkIsQ0FBQztLQUFBO0lBRUsscUJBQXFCLENBQ3pCLFNBQWlCLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRTs7WUFFekMsTUFBTSxLQUFLLEdBQUc7Z0JBQ1osUUFBUSxFQUFFO29CQUNSLEtBQUssRUFBRTt3QkFDTCxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRTt3QkFDN0I7NEJBQ0UsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsc0JBQXNCLEVBQUUscUJBQXFCLENBQUMsRUFBRTt5QkFDaEU7cUJBQ0Y7aUJBQ0Y7Z0JBQ0QsU0FBUyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUM7YUFDekIsQ0FBQztZQUNGLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztZQUUzRSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO2dCQUN0QixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUNyQixJQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztpQkFDcEM7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQzthQUN2QztZQUVELE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDdkIsQ0FBQztLQUFBO0lBRUssdUJBQXVCOztZQUMzQixNQUFNLE1BQU0sR0FBa0I7Z0JBQzVCLFFBQVEsRUFBRSxjQUFjO2dCQUN4QixHQUFHLEVBQUUsZ0JBQWdCO2FBQ3RCLENBQUM7WUFDRixJQUFJO2dCQUNGLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3hDLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixNQUFNLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO2FBQy9DO1FBQ0gsQ0FBQztLQUFBO0lBRWEsZ0NBQWdDOztZQUM1QyxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLDJCQUEyQixDQUFDO1lBQ25ELE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDekYsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDM0MsT0FBTyxDQUNMLDZIQUE2SCxDQUM5SCxFQUNEO29CQUNFLElBQUksRUFBRSxnRkFBZ0Y7aUJBQ3ZGLENBQ0YsQ0FBQzthQUNIO2lCQUFNO2dCQUNMLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUNyQixzRUFBc0UsQ0FDdkUsQ0FBQzthQUNIO1lBRUQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0tBQUE7SUFFTyxzQkFBc0IsQ0FBQyxJQUF5QjtRQUN0RCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixDQUFDO1FBQ3pDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUM3QixNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7SUFFTyw4QkFBOEI7UUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUMxQixLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQztRQUNqRCxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQzVELE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztJQUVPLDJCQUEyQjtRQUNqQyxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLHNCQUFzQixDQUFDO1FBQzlDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDM0MsT0FBTyxDQUNMLCtHQUErRyxDQUNoSCxFQUNEO1lBQ0UsSUFBSSxFQUFFLDBDQUEwQztTQUNqRCxDQUNGLENBQUM7UUFDRixNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUF5QjtRQUNsRCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQztRQUNyQyxLQUFLLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDN0IsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0lBRU8scUJBQXFCO1FBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFDMUIsS0FBSyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7UUFDeEMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQ3JCLDRFQUE0RSxDQUM3RSxDQUFDO1FBQ0YsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDOzs7O1lBcExGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBeEJDLFdBQVc7WUFHWCxnQkFBZ0I7WUFJaEIsb0JBQW9CO1lBR2IsZ0JBQWdCO1lBWHZCLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEFwcGxpY2F0aW9uU2VydmljZSxcbiAgRmV0Y2hDbGllbnQsXG4gIElGZXRjaE9wdGlvbnMsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJUmVzdWx0LFxuICBJUmVzdWx0TGlzdCxcbiAgSVRlbmFudE9wdGlvbixcbiAgVGVuYW50T3B0aW9uc1NlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgU2lnZm94RGV2aWNlIH0gZnJvbSAnLi9zaWdmb3gtZGV2aWNlLXJlZ2lzdHJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbmV4cG9ydCBlbnVtIEVycm9yTmFtZSB7XG4gIE5vRGV2aWNlUHJvdG9jb2xzRXJyb3IgPSAnTm9EZXZpY2VQcm90b2NvbHNFcnJvcicsXG4gIE5vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvciA9ICdOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3InLFxuICBDb250cmFjdEVycm9yID0gJ0NvbnRyYWN0RXJyb3InLFxuICBOb0NvbnRyYWN0c0Vycm9yID0gJ05vQ29udHJhY3RzRXJyb3InLFxuICBSZWdpc3RyYXRpb25FcnJvciA9ICdSZWdpc3RyYXRpb25FcnJvcicsXG4gIERldmljZVByb3RvY29sc0ZldGNoRXJyb3IgPSAnRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcidcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgU2lnZm94UHJvdmlkZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBiYXNlVXJsOiBzdHJpbmcgPSAnL3NlcnZpY2Uvc2lnZm94LWFnZW50Lyc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVnaXN0cmF0aW9uVXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9bmV3RGV2aWNlUmVxdWVzdGA7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29udHJhY3RzVXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9Y29udHJhY3RgO1xuICBwcml2YXRlIHJlYWRvbmx5IGhlYWRlcjogYW55ID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvbnM6IFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlXG4gICkge31cbiAgYXN5bmMgZ2V0Q29ubmVjdGlvbnMoKSB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlclxuICAgIH07XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5iYXNlVXJsfWxucy1jb25uZWN0aW9uYCwgb3B0aW9ucyk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgIGF3YWl0IHRoaXMudGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy50aHJvd05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGNvbnRyYWN0cyBmcm9tIFNpZ2ZveCBwbGF0Zm9ybS5cbiAgICogQHBhcmFtIGNvbm5lY3Rpb25OYW1lIFRoZSBuYW1lIG9mIGNvbm5lY3Rpb24gZm9yIHdoaWNoIGNvbnRyYWN0cyB3aWxsIGJlIHJldHJpZXZlZFxuICAgKiBAcmV0dXJucyBUaGUgcmVzdWx0IGxpc3Qgd2l0aCBjb250cmFjdCwgb3IgdGhyb3dzIGFuIGVycm9yIHdpdGggZXhjZXB0aW9uLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29udHJhY3RzKGNvbm5lY3Rpb25OYW1lOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHRMaXN0PGFueT4+IHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyLFxuICAgICAgcGFyYW1zOiB7XG4gICAgICAgIHNpZ2ZveENvbm5lY3Rpb25OYW1lOiBjb25uZWN0aW9uTmFtZVxuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godGhpcy5jb250cmFjdHNVcmwsIG9wdGlvbnMpO1xuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy50aHJvd05vQ29udHJhY3RzRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aHJvd0NvbnRyYWN0RXJyb3IoZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlRGV2aWNlKGRldmljZTogU2lnZm94RGV2aWNlKTogUHJvbWlzZTxJUmVzdWx0PFNpZ2ZveERldmljZT4+IHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcixcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGRldmljZSlcbiAgICB9O1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKHRoaXMucmVnaXN0cmF0aW9uVXJsLCBvcHRpb25zKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDEpIHtcbiAgICAgIHRoaXMudGhyb3dSZWdpc3RyYXRpb25FcnJvcihkYXRhKTtcbiAgICB9XG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cblxuICBhc3luYyBnZXRBdmFpbGFibGVQcm90b2NvbHMoXG4gICAgZmlsdGVyOiBvYmplY3QgPSB7IHdpdGhUb3RhbFBhZ2VzOiB0cnVlIH1cbiAgKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIF9fYW5kOiBbXG4gICAgICAgICAgeyBfX2hhczogJ2M4eV9Jc0RldmljZVR5cGUnIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogeyBfX2luOiBbJ2M4eV9TaWdmb3hEZXZpY2VUeXBlJywgJ2M4eV9McHdhbkRldmljZVR5cGUnXSB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyBuYW1lOiAxIH1dXG4gICAgfTtcbiAgICBjb25zdCB7IHJlcywgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3RRdWVyeShxdWVyeSwgZmlsdGVyKTtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnRocm93Tm9EZXZpY2VQcm90b2NvbHNFcnJvcigpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRocm93RGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcigpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgYXN5bmMgaGFzQ29ubmVjdGl2aXR5U2V0dGluZ3MoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgb3B0aW9uOiBJVGVuYW50T3B0aW9uID0ge1xuICAgICAgY2F0ZWdvcnk6ICdzaWdmb3gtYWdlbnQnLFxuICAgICAga2V5OiAncHJvdmlkZXIudG9rZW4nXG4gICAgfTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy50ZW5hbnRPcHRpb25zLmRldGFpbChvcHRpb24pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy50aHJvd05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcjtcbiAgICBjb25zdCBoYXNBZG1pblJpZ2h0ID0gKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmlzQXZhaWxhYmxlKCdhZG1pbmlzdHJhdGlvbicpKS5kYXRhO1xuICAgIGlmIChoYXNBZG1pblJpZ2h0KSB7XG4gICAgICBlcnJvci5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgYENvbm5lY3Rpdml0eSBzZXR0aW5ncyBhcmUgbm90IGNvbmZpZ3VyZWQuIENvbmZpZ3VyZSB0aGVtIGluIHRoZSBBZG1pbmlzdHJhdGlvbiBhcHAgdW5kZXIgPGEgaHJlZj1cInt7IGxpbmsgfX1cIj5TZXR0aW5nczwvYT4uYFxuICAgICAgICApLFxuICAgICAgICB7XG4gICAgICAgICAgbGluazogJy9hcHBzL2FkbWluaXN0cmF0aW9uL2luZGV4Lmh0bWwjL2Nvbm5lY3Rpdml0eVNldHRpbmdzL3NpZ2ZveF9wcm92aWRlcl9zZXR0aW5ncydcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXJyb3IubWVzc2FnZSA9IGdldHRleHQoXG4gICAgICAgICdDb25uZWN0aXZpdHkgc2V0dGluZ3MgYXJlIG5vdCBjb25maWd1cmVkLiBDb250YWN0IHRoZSBhZG1pbmlzdHJhdG9yLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93UmVnaXN0cmF0aW9uRXJyb3IoZGF0YTogeyBtZXNzYWdlOiBzdHJpbmcgfSkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5SZWdpc3RyYXRpb25FcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZGF0YS5tZXNzYWdlO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd0RldmljZVByb3RvY29sc0ZldGNoRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLkRldmljZVByb3RvY29sc0ZldGNoRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGdldHRleHQoJ0NvdWxkIG5vdCBsb2FkIGRldmljZSBwcm90b2NvbHMuJyk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93Tm9EZXZpY2VQcm90b2NvbHNFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuTm9EZXZpY2VQcm90b2NvbHNFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICBnZXR0ZXh0KFxuICAgICAgICBgTm8gZGV2aWNlIHByb3RvY29scyBjb25maWd1cmVkLiBDcmVhdGUgYSBTaWdmb3ggZGV2aWNlIHByb3RvY29sIGluIDxhIGhyZWY9XCJ7eyBsaW5rIH19XCI+RGV2aWNlIHByb3RvY29sczwvYT4uYFxuICAgICAgKSxcbiAgICAgIHtcbiAgICAgICAgbGluazogJy9hcHBzL2RldmljZW1hbmFnZW1lbnQvIy9kZXZpY2Vwcm90b2NvbHMnXG4gICAgICB9XG4gICAgKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dDb250cmFjdEVycm9yKGRhdGE6IHsgbWVzc2FnZTogc3RyaW5nIH0pIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuQ29udHJhY3RFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZGF0YS5tZXNzYWdlO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vQ29udHJhY3RzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vQ29udHJhY3RzRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGdldHRleHQoXG4gICAgICAnTm8gY29udHJhY3RzIGZvdW5kLiBOZXcgY29udHJhY3RzIG11c3QgYmUgY3JlYXRlZCB2aWEgdGhlIFNpZ2ZveCBwbGF0Zm9ybS4nXG4gICAgKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuIl19