import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService, FetchClient, InventoryService, TenantOptionsService } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import { gettext } from '@c8y/ngx-components';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/core/FetchClient";
import * as i2 from "@c8y/client/lib/src/inventory/InventoryService";
import * as i3 from "@c8y/client/lib/src/tenant-options/TenantOptionsService";
import * as i4 from "@ngx-translate/core";
import * as i5 from "@c8y/client/lib/src/application/ApplicationService";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@ngx-translate/core';
export var ErrorName;
(function (ErrorName) {
    ErrorName["NoDeviceProtocolsError"] = "NoDeviceProtocolsError";
    ErrorName["NoConnectivitySettingsError"] = "NoConnectivitySettingsError";
    ErrorName["ContractError"] = "ContractError";
    ErrorName["NoContractsError"] = "NoContractsError";
    ErrorName["RegistrationError"] = "RegistrationError";
    ErrorName["DeviceProtocolsFetchError"] = "DeviceProtocolsFetchError";
})(ErrorName || (ErrorName = {}));
export class SigfoxProviderService {
    constructor(client, inventoryService, tenantOptions, translateService, applicationService) {
        this.client = client;
        this.inventoryService = inventoryService;
        this.tenantOptions = tenantOptions;
        this.translateService = translateService;
        this.applicationService = applicationService;
        this.baseUrl = '/service/sigfox-agent/';
        this.registrationUrl = `${this.baseUrl}newDeviceRequest`;
        this.contractsUrl = `${this.baseUrl}contract`;
        this.header = { 'Content-Type': 'application/json' };
    }
    getConnections() {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.header
            };
            const res = yield this.client.fetch(`${this.baseUrl}lns-connection`, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    yield this.throwNoConnectivitySettingsError();
                }
            }
            else {
                yield this.throwNoConnectivitySettingsError();
            }
            return { res, data };
        });
    }
    /**
     * Gets contracts from Sigfox platform.
     * @param connectionName The name of connection for which contracts will be retrieved
     * @returns The result list with contract, or throws an error with exception.
     */
    getContracts(connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.header,
                params: {
                    sigfoxConnectionName: connectionName
                }
            };
            const res = yield this.client.fetch(this.contractsUrl, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoContractsError();
                }
            }
            else {
                this.throwContractError(data);
            }
            return { res, data };
        });
    }
    createDevice(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'POST',
                headers: this.header,
                body: JSON.stringify(device)
            };
            const res = yield this.client.fetch(this.registrationUrl, options);
            const data = yield res.json();
            if (res.status !== 201) {
                this.throwRegistrationError(data);
            }
            return { res, data };
        });
    }
    getAvailableProtocols(filter = { withTotalPages: true }) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                __filter: {
                    __and: [
                        { __has: 'c8y_IsDeviceType' },
                        {
                            type: { __in: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'] }
                        }
                    ]
                },
                __orderby: [{ name: 1 }]
            };
            const { res, data } = yield this.inventoryService.listQuery(query, filter);
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoDeviceProtocolsError();
                }
            }
            else {
                this.throwDeviceProtocolsFetchError();
            }
            return { res, data };
        });
    }
    hasConnectivitySettings() {
        return __awaiter(this, void 0, void 0, function* () {
            const option = {
                category: 'sigfox-agent',
                key: 'provider.token'
            };
            try {
                yield this.tenantOptions.detail(option);
                return true;
            }
            catch (e) {
                yield this.throwNoConnectivitySettingsError();
            }
        });
    }
    throwNoConnectivitySettingsError() {
        return __awaiter(this, void 0, void 0, function* () {
            const error = new Error();
            error.name = ErrorName.NoConnectivitySettingsError;
            const hasAdminRight = (yield this.applicationService.isAvailable('administration')).data;
            if (hasAdminRight) {
                error.message = this.translateService.instant(gettext(`Connectivity settings are not configured. Configure them in the Administration app under <a href="{{ link }}">Settings</a>.`), {
                    link: '/apps/administration/index.html#/connectivitySettings/sigfox_provider_settings'
                });
            }
            else {
                error.message = gettext('Connectivity settings are not configured. Contact the administrator.');
            }
            throw error;
        });
    }
    throwRegistrationError(data) {
        const error = new Error();
        error.name = ErrorName.RegistrationError;
        error.message = data.message;
        throw error;
    }
    throwDeviceProtocolsFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProtocolsFetchError;
        error.message = gettext('Could not load device protocols.');
        throw error;
    }
    throwNoDeviceProtocolsError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProtocolsError;
        error.message = this.translateService.instant(gettext(`No device protocols configured. Create a Sigfox device protocol in <a href="{{ link }}">Device protocols</a>.`), {
            link: '/apps/devicemanagement/#/deviceprotocols'
        });
        throw error;
    }
    throwContractError(data) {
        const error = new Error();
        error.name = ErrorName.ContractError;
        error.message = data.message;
        throw error;
    }
    throwNoContractsError() {
        const error = new Error();
        error.name = ErrorName.NoContractsError;
        error.message = gettext('No contracts found. New contracts must be created via the Sigfox platform.');
        throw error;
    }
}
SigfoxProviderService.ɵfac = function SigfoxProviderService_Factory(t) { return new (t || SigfoxProviderService)(ɵngcc0.ɵɵinject(ɵngcc1.FetchClient), ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc1.TenantOptionsService), ɵngcc0.ɵɵinject(ɵngcc2.TranslateService), ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService)); };
SigfoxProviderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SigfoxProviderService_Factory() { return new SigfoxProviderService(i0.ɵɵinject(i1.FetchClient), i0.ɵɵinject(i2.InventoryService), i0.ɵɵinject(i3.TenantOptionsService), i0.ɵɵinject(i4.TranslateService), i0.ɵɵinject(i5.ApplicationService)); }, token: SigfoxProviderService, providedIn: "root" });
SigfoxProviderService.ctorParameters = () => [
    { type: FetchClient },
    { type: InventoryService },
    { type: TenantOptionsService },
    { type: TranslateService },
    { type: ApplicationService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(SigfoxProviderService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.FetchClient }, { type: ɵngcc1.InventoryService }, { type: ɵngcc1.TenantOptionsService }, { type: ɵngcc2.TranslateService }, { type: ɵngcc1.ApplicationService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnZm94LXByb3ZpZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NpZ2ZveC1kZXZpY2UtcmVnaXN0cmF0aW9uL3NpZ2ZveC1wcm92aWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsV0FBVyxFQUdYLGdCQUFnQixFQUloQixvQkFBb0IsRUFDckIsTUFBTSxhQUFhLENBQUM7QUFFckIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDO0FBRVk7QUFDTztBQUNPO0FBRUc7QUFDQTs7OztBQU43QixNQUFNLENBQU4sSUFBWSxTQU9YO0FBUEQsV0FBWSxTQUFTO0FBQ3BCLElBQUMsOERBQWlELENBQUE7QUFBQyxJQUNsRCx3RUFBMkQsQ0FBQTtBQUFDLElBQzVELDRDQUErQixDQUFBO0FBQUMsSUFDaEMsa0RBQXFDLENBQUE7QUFBQyxJQUN0QyxvREFBdUMsQ0FBQTtBQUFDLElBQ3hDLG9FQUF1RCxDQUFBO0FBQ3pELENBQUMsRUFQVyxTQUFTLEtBQVQsU0FBUyxRQU9wQjtBQUtELE1BQU0sT0FBTyxxQkFBcUI7QUFDbEMsSUFLRSxZQUNVLE1BQW1CLEVBQ25CLGdCQUFrQyxFQUNsQyxhQUFtQyxFQUNuQyxnQkFBa0MsRUFDbEMsa0JBQXNDO0FBQy9DLFFBTFMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtBQUFDLFFBQ3BCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7QUFBQyxRQUNwQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUNsRCxRQVhtQixZQUFPLEdBQVcsd0JBQXdCLENBQUM7QUFDOUQsUUFBbUIsb0JBQWUsR0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLGtCQUFrQixDQUFDO0FBQy9FLFFBQW1CLGlCQUFZLEdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxVQUFVLENBQUM7QUFDcEUsUUFBbUIsV0FBTSxHQUFRLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7QUFDeEUsSUFPSyxDQUFDO0FBQ04sSUFBUSxjQUFjO0FBQ3RCO0FBRUksWUFGQSxNQUFNLE9BQU8sR0FBa0I7QUFDbkMsZ0JBQU0sTUFBTSxFQUFFLEtBQUs7QUFDbkIsZ0JBQU0sT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNO0FBQzFCLGFBQUssQ0FBQztBQUNOLFlBQUksTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2xGLFlBQUksTUFBTSxJQUFJLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDbEMsWUFDSSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO0FBQzVCLGdCQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDN0Isb0JBQU0sTUFBTSxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztBQUNwRCxpQkFBTztBQUNQLGFBQUs7QUFBQyxpQkFBSztBQUNYLGdCQUFNLE1BQU0sSUFBSSxDQUFDLGdDQUFnQyxFQUFFLENBQUM7QUFDcEQsYUFBSztBQUNMLFlBQUksT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUN6QixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUVKLE9BREs7QUFDTCxJQUFRLFlBQVksQ0FBQyxjQUFzQjtBQUFJO0FBQ1osWUFBL0IsTUFBTSxPQUFPLEdBQWtCO0FBQ25DLGdCQUFNLE1BQU0sRUFBRSxLQUFLO0FBQ25CLGdCQUFNLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTTtBQUMxQixnQkFBTSxNQUFNLEVBQUU7QUFDZCxvQkFBUSxvQkFBb0IsRUFBRSxjQUFjO0FBQzVDLGlCQUFPO0FBQ1AsYUFBSyxDQUFDO0FBQ04sWUFBSSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDcEUsWUFDSSxNQUFNLElBQUksR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNsQyxZQUNJLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7QUFDNUIsZ0JBQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUM3QixvQkFBUSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztBQUNyQyxpQkFBTztBQUNQLGFBQUs7QUFBQyxpQkFBSztBQUNYLGdCQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNwQyxhQUFLO0FBQ0wsWUFBSSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO0FBQ3pCLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNRLFlBQVksQ0FBQyxNQUFvQjtBQUFJO0FBQ2YsWUFBMUIsTUFBTSxPQUFPLEdBQWtCO0FBQ25DLGdCQUFNLE1BQU0sRUFBRSxNQUFNO0FBQ3BCLGdCQUFNLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTTtBQUMxQixnQkFBTSxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7QUFDbEMsYUFBSyxDQUFDO0FBQ04sWUFBSSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDdkUsWUFBSSxNQUFNLElBQUksR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNsQyxZQUNJLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7QUFDNUIsZ0JBQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3hDLGFBQUs7QUFDTCxZQUFJLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDekIsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EscUJBQXFCLENBQ3pCLFNBQWlCLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRTtBQUMxQztBQUVGLFlBREcsTUFBTSxLQUFLLEdBQUc7QUFDbEIsZ0JBQU0sUUFBUSxFQUFFO0FBQ2hCLG9CQUFRLEtBQUssRUFBRTtBQUNmLHdCQUFVLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixFQUFFO0FBQ3ZDLHdCQUFVO0FBQ1YsNEJBQVksSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsc0JBQXNCLEVBQUUscUJBQXFCLENBQUMsRUFBRTtBQUMzRSx5QkFBVztBQUNYLHFCQUFTO0FBQ1QsaUJBQU87QUFDUCxnQkFBTSxTQUFTLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQztBQUM5QixhQUFLLENBQUM7QUFDTixZQUFJLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztBQUMvRSxZQUNJLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7QUFDNUIsZ0JBQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUM3QixvQkFBUSxJQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztBQUMzQyxpQkFBTztBQUNQLGFBQUs7QUFBQyxpQkFBSztBQUNYLGdCQUFNLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO0FBQzVDLGFBQUs7QUFDTCxZQUNJLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDekIsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EsdUJBQXVCO0FBQUs7QUFFNUIsWUFESixNQUFNLE1BQU0sR0FBa0I7QUFDbEMsZ0JBQU0sUUFBUSxFQUFFLGNBQWM7QUFDOUIsZ0JBQU0sR0FBRyxFQUFFLGdCQUFnQjtBQUMzQixhQUFLLENBQUM7QUFDTixZQUFJLElBQUk7QUFDUixnQkFBTSxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzlDLGdCQUFNLE9BQU8sSUFBSSxDQUFDO0FBQ2xCLGFBQUs7QUFBQyxZQUFBLE9BQU8sQ0FBQyxFQUFFO0FBQ2hCLGdCQUFNLE1BQU0sSUFBSSxDQUFDLGdDQUFnQyxFQUFFLENBQUM7QUFDcEQsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNnQixnQ0FBZ0M7QUFDaEQ7QUFDK0IsWUFEM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUM5QixZQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLDJCQUEyQixDQUFDO0FBQ3ZELFlBQUksTUFBTSxhQUFhLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUM3RixZQUFJLElBQUksYUFBYSxFQUFFO0FBQ3ZCLGdCQUFNLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDM0MsT0FBTyxDQUNMLDZIQUE2SCxDQUM5SCxFQUNEO0FBQ1Isb0JBQVUsSUFBSSxFQUFFLGdGQUFnRjtBQUNoRyxpQkFBUyxDQUNGLENBQUM7QUFDUixhQUFLO0FBQUMsaUJBQUs7QUFDWCxnQkFBTSxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FDckIsc0VBQXNFLENBQ3ZFLENBQUM7QUFDUixhQUFLO0FBQ0wsWUFDSSxNQUFNLEtBQUssQ0FBQztBQUNoQixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDVSxzQkFBc0IsQ0FBQyxJQUF5QjtBQUMxRCxRQUFJLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7QUFDOUIsUUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQztBQUM3QyxRQUFJLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztBQUNqQyxRQUFJLE1BQU0sS0FBSyxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNILElBQ1UsOEJBQThCO0FBQ3hDLFFBQUksTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUM5QixRQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLHlCQUF5QixDQUFDO0FBQ3JELFFBQUksS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsa0NBQWtDLENBQUMsQ0FBQztBQUNoRSxRQUFJLE1BQU0sS0FBSyxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNILElBQ1UsMkJBQTJCO0FBQ3JDLFFBQUksTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUM5QixRQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLHNCQUFzQixDQUFDO0FBQ2xELFFBQUksS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUMzQyxPQUFPLENBQ0wsK0dBQStHLENBQ2hILEVBQ0Q7QUFDTixZQUFRLElBQUksRUFBRSwwQ0FBMEM7QUFDeEQsU0FBTyxDQUNGLENBQUM7QUFDTixRQUFJLE1BQU0sS0FBSyxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNILElBQ1Usa0JBQWtCLENBQUMsSUFBeUI7QUFDdEQsUUFBSSxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO0FBQzlCLFFBQUksS0FBSyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDO0FBQ3pDLFFBQUksS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQ2pDLFFBQUksTUFBTSxLQUFLLENBQUM7QUFDaEIsSUFBRSxDQUFDO0FBQ0gsSUFDVSxxQkFBcUI7QUFDL0IsUUFBSSxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO0FBQzlCLFFBQUksS0FBSyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7QUFDNUMsUUFBSSxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FDckIsNEVBQTRFLENBQzdFLENBQUM7QUFDTixRQUFJLE1BQU0sS0FBSyxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNIO3VVQUFDO0FBQ0QsOFdBbkxLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBSUksWUExQmQsV0FBVztZQXVCWCxVQUFVLEVBQUUsTUFBTSw5QkF0QmxCLFlBRUEsZ0JBQWdCO1lBcUJqQixaQXBCQyxZQUdBLG9CQUFvQjtBQUNuQixZQUVNLGdCQUFnQjtBQUFJLFlBWDNCLGtCQUFrQjtBQUNuQjs7Ozs7OzhOQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBBcHBsaWNhdGlvblNlcnZpY2UsXG4gIEZldGNoQ2xpZW50LFxuICBJRmV0Y2hPcHRpb25zLFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSVJlc3VsdCxcbiAgSVJlc3VsdExpc3QsXG4gIElUZW5hbnRPcHRpb24sXG4gIFRlbmFudE9wdGlvbnNTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFNpZ2ZveERldmljZSB9IGZyb20gJy4vc2lnZm94LWRldmljZS1yZWdpc3RyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5leHBvcnQgZW51bSBFcnJvck5hbWUge1xuICBOb0RldmljZVByb3RvY29sc0Vycm9yID0gJ05vRGV2aWNlUHJvdG9jb2xzRXJyb3InLFxuICBOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IgPSAnTm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yJyxcbiAgQ29udHJhY3RFcnJvciA9ICdDb250cmFjdEVycm9yJyxcbiAgTm9Db250cmFjdHNFcnJvciA9ICdOb0NvbnRyYWN0c0Vycm9yJyxcbiAgUmVnaXN0cmF0aW9uRXJyb3IgPSAnUmVnaXN0cmF0aW9uRXJyb3InLFxuICBEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yID0gJ0RldmljZVByb3RvY29sc0ZldGNoRXJyb3InXG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNpZ2ZveFByb3ZpZGVyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgYmFzZVVybDogc3RyaW5nID0gJy9zZXJ2aWNlL3NpZ2ZveC1hZ2VudC8nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZ2lzdHJhdGlvblVybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfW5ld0RldmljZVJlcXVlc3RgO1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbnRyYWN0c1VybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfWNvbnRyYWN0YDtcbiAgcHJpdmF0ZSByZWFkb25seSBoZWFkZXI6IGFueSA9IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRPcHRpb25zOiBUZW5hbnRPcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZVxuICApIHt9XG4gIGFzeW5jIGdldENvbm5lY3Rpb25zKCkge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJcbiAgICB9O1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKGAke3RoaXMuYmFzZVVybH1sbnMtY29ubmVjdGlvbmAsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICBhd2FpdCB0aGlzLnRocm93Tm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKTtcbiAgICB9XG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBjb250cmFjdHMgZnJvbSBTaWdmb3ggcGxhdGZvcm0uXG4gICAqIEBwYXJhbSBjb25uZWN0aW9uTmFtZSBUaGUgbmFtZSBvZiBjb25uZWN0aW9uIGZvciB3aGljaCBjb250cmFjdHMgd2lsbCBiZSByZXRyaWV2ZWRcbiAgICogQHJldHVybnMgVGhlIHJlc3VsdCBsaXN0IHdpdGggY29udHJhY3QsIG9yIHRocm93cyBhbiBlcnJvciB3aXRoIGV4Y2VwdGlvbi5cbiAgICovXG4gIGFzeW5jIGdldENvbnRyYWN0cyhjb25uZWN0aW9uTmFtZTogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxhbnk+PiB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcixcbiAgICAgIHBhcmFtczoge1xuICAgICAgICBzaWdmb3hDb25uZWN0aW9uTmFtZTogY29ubmVjdGlvbk5hbWVcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKHRoaXMuY29udHJhY3RzVXJsLCBvcHRpb25zKTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMudGhyb3dOb0NvbnRyYWN0c0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dDb250cmFjdEVycm9yKGRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZURldmljZShkZXZpY2U6IFNpZ2ZveERldmljZSk6IFByb21pc2U8SVJlc3VsdDxTaWdmb3hEZXZpY2U+PiB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXIsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkZXZpY2UpXG4gICAgfTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh0aGlzLnJlZ2lzdHJhdGlvblVybCwgb3B0aW9ucyk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAxKSB7XG4gICAgICB0aGlzLnRocm93UmVnaXN0cmF0aW9uRXJyb3IoZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0QXZhaWxhYmxlUHJvdG9jb2xzKFxuICAgIGZpbHRlcjogb2JqZWN0ID0geyB3aXRoVG90YWxQYWdlczogdHJ1ZSB9XG4gICk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICBfX2FuZDogW1xuICAgICAgICAgIHsgX19oYXM6ICdjOHlfSXNEZXZpY2VUeXBlJyB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IHsgX19pbjogWydjOHlfU2lnZm94RGV2aWNlVHlwZScsICdjOHlfTHB3YW5EZXZpY2VUeXBlJ10gfVxuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgIH07XG4gICAgY29uc3QgeyByZXMsIGRhdGEgfSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIGZpbHRlcik7XG5cbiAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy50aHJvd05vRGV2aWNlUHJvdG9jb2xzRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aHJvd0RldmljZVByb3RvY29sc0ZldGNoRXJyb3IoKTtcbiAgICB9XG5cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIGFzeW5jIGhhc0Nvbm5lY3Rpdml0eVNldHRpbmdzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IG9wdGlvbjogSVRlbmFudE9wdGlvbiA9IHtcbiAgICAgIGNhdGVnb3J5OiAnc2lnZm94LWFnZW50JyxcbiAgICAgIGtleTogJ3Byb3ZpZGVyLnRva2VuJ1xuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMudGVuYW50T3B0aW9ucy5kZXRhaWwob3B0aW9uKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMudGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHRocm93Tm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3I7XG4gICAgY29uc3QgaGFzQWRtaW5SaWdodCA9IChhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5pc0F2YWlsYWJsZSgnYWRtaW5pc3RyYXRpb24nKSkuZGF0YTtcbiAgICBpZiAoaGFzQWRtaW5SaWdodCkge1xuICAgICAgZXJyb3IubWVzc2FnZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICBnZXR0ZXh0KFxuICAgICAgICAgIGBDb25uZWN0aXZpdHkgc2V0dGluZ3MgYXJlIG5vdCBjb25maWd1cmVkLiBDb25maWd1cmUgdGhlbSBpbiB0aGUgQWRtaW5pc3RyYXRpb24gYXBwIHVuZGVyIDxhIGhyZWY9XCJ7eyBsaW5rIH19XCI+U2V0dGluZ3M8L2E+LmBcbiAgICAgICAgKSxcbiAgICAgICAge1xuICAgICAgICAgIGxpbms6ICcvYXBwcy9hZG1pbmlzdHJhdGlvbi9pbmRleC5odG1sIy9jb25uZWN0aXZpdHlTZXR0aW5ncy9zaWdmb3hfcHJvdmlkZXJfc2V0dGluZ3MnXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgICAnQ29ubmVjdGl2aXR5IHNldHRpbmdzIGFyZSBub3QgY29uZmlndXJlZC4gQ29udGFjdCB0aGUgYWRtaW5pc3RyYXRvci4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd1JlZ2lzdHJhdGlvbkVycm9yKGRhdGE6IHsgbWVzc2FnZTogc3RyaW5nIH0pIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuUmVnaXN0cmF0aW9uRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGRhdGEubWVzc2FnZTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5EZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KCdDb3VsZCBub3QgbG9hZCBkZXZpY2UgcHJvdG9jb2xzLicpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vRGV2aWNlUHJvdG9jb2xzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vRGV2aWNlUHJvdG9jb2xzRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgZ2V0dGV4dChcbiAgICAgICAgYE5vIGRldmljZSBwcm90b2NvbHMgY29uZmlndXJlZC4gQ3JlYXRlIGEgU2lnZm94IGRldmljZSBwcm90b2NvbCBpbiA8YSBocmVmPVwie3sgbGluayB9fVwiPkRldmljZSBwcm90b2NvbHM8L2E+LmBcbiAgICAgICksXG4gICAgICB7XG4gICAgICAgIGxpbms6ICcvYXBwcy9kZXZpY2VtYW5hZ2VtZW50LyMvZGV2aWNlcHJvdG9jb2xzJ1xuICAgICAgfVxuICAgICk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93Q29udHJhY3RFcnJvcihkYXRhOiB7IG1lc3NhZ2U6IHN0cmluZyB9KSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLkNvbnRyYWN0RXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGRhdGEubWVzc2FnZTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0NvbnRyYWN0c0Vycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0NvbnRyYWN0c0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgJ05vIGNvbnRyYWN0cyBmb3VuZC4gTmV3IGNvbnRyYWN0cyBtdXN0IGJlIGNyZWF0ZWQgdmlhIHRoZSBTaWdmb3ggcGxhdGZvcm0uJ1xuICAgICk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cbiJdfQ==