import { __awaiter } from "tslib";
import { Component, Input } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryBinaryService, InventoryService } from '@c8y/client';
import { AlertService, AssetTypesService, ContextRouteService, gettext } from '@c8y/ngx-components';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from '@angular/router';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from './asset-properties-item.component';

function AssetPropertiesComponent_div_6_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 5);
    ɵngcc0.ɵɵelement(1, "c8y-loading");
    ɵngcc0.ɵɵelementEnd();
} }
function AssetPropertiesComponent_ng_container_7_div_1_div_3_Template(rf, ctx) { if (rf & 1) {
    const _r9 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "div", 13);
    ɵngcc0.ɵɵelementStart(1, "p", 14);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "humanize");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(4, "button", 15);
    ɵngcc0.ɵɵlistener("click", function AssetPropertiesComponent_ng_container_7_div_1_div_3_Template_button_click_4_listener() { ɵngcc0.ɵɵrestoreView(_r9); const prop_r3 = ɵngcc0.ɵɵnextContext().$implicit; const ctx_r7 = ɵngcc0.ɵɵnextContext(2); return ctx_r7.toggleEdit(prop_r3); });
    ɵngcc0.ɵɵpipe(5, "translate");
    ɵngcc0.ɵɵelement(6, "i", 16);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const prop_r3 = ɵngcc0.ɵɵnextContext().$implicit;
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(3, 2, prop_r3 == null ? null : prop_r3.label));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(5, 4, "Edit"));
} }
function AssetPropertiesComponent_ng_container_7_div_1_div_6_Template(rf, ctx) { if (rf & 1) {
    const _r13 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "div", 17);
    ɵngcc0.ɵɵelementStart(1, "button", 18);
    ɵngcc0.ɵɵlistener("click", function AssetPropertiesComponent_ng_container_7_div_1_div_6_Template_button_click_1_listener() { ɵngcc0.ɵɵrestoreView(_r13); const prop_r3 = ɵngcc0.ɵɵnextContext().$implicit; const ctx_r11 = ɵngcc0.ɵɵnextContext(2); return ctx_r11.toggleEdit(prop_r3); });
    ɵngcc0.ɵɵtext(2, " Cancel ");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(3, "button", 19);
    ɵngcc0.ɵɵlistener("click", function AssetPropertiesComponent_ng_container_7_div_1_div_6_Template_button_click_3_listener() { ɵngcc0.ɵɵrestoreView(_r13); const prop_r3 = ɵngcc0.ɵɵnextContext().$implicit; const _r5 = ɵngcc0.ɵɵreference(5); const ctx_r14 = ɵngcc0.ɵɵnextContext(2); return ctx_r14.save(_r5.model, prop_r3); });
    ɵngcc0.ɵɵtext(4, " Save ");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵnextContext();
    const _r5 = ɵngcc0.ɵɵreference(5);
    ɵngcc0.ɵɵadvance(3);
    ɵngcc0.ɵɵproperty("disabled", !(_r5 == null ? null : _r5.form == null ? null : _r5.form.valid));
} }
const _c0 = function (a0) { return { "card-highlight": a0 }; };
const _c1 = function (a0) { return { "p-b-0": a0 }; };
function AssetPropertiesComponent_ng_container_7_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 7);
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵelementStart(2, "div", 8);
    ɵngcc0.ɵɵtemplate(3, AssetPropertiesComponent_ng_container_7_div_1_div_3_Template, 7, 6, "div", 9);
    ɵngcc0.ɵɵelement(4, "c8y-asset-properties-item", 10, 11);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(6, AssetPropertiesComponent_ng_container_7_div_1_div_6_Template, 5, 1, "div", 12);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const prop_r3 = ctx.$implicit;
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 12, prop_r3.description));
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(14, _c0, prop_r3.isEdit));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(16, _c1, prop_r3.isEdit));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", !prop_r3.isEdit);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("file", prop_r3.file)("key", prop_r3.key)("type", prop_r3.type)("value", prop_r3.value)("complex", prop_r3.complex)("isEdit", prop_r3.isEdit)("jsonSchema", prop_r3.jsonSchema);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", prop_r3.isEdit);
} }
function AssetPropertiesComponent_ng_container_7_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, AssetPropertiesComponent_ng_container_7_div_1_Template, 7, 18, "div", 6);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r1.customProperties);
} }
const _c2 = function (a0) { return { label: a0 }; };
export class AssetPropertiesComponent {
    constructor(assetTypes, inventory, inventoryBinary, alert, contextRouteService, activatedRoute) {
        this.assetTypes = assetTypes;
        this.inventory = inventory;
        this.inventoryBinary = inventoryBinary;
        this.alert = alert;
        this.contextRouteService = contextRouteService;
        this.activatedRoute = activatedRoute;
        this.properties = [];
        this.customProperties = [];
        this.isEdit = false;
        this.isLoading = false;
    }
    ngOnChanges(changes) {
        if (changes.asset) {
            // Back button handling, as component is not destroyed
            this.assetType = undefined;
            this.customProperties = [];
            this.loadAsset();
        }
    }
    loadAsset() {
        return __awaiter(this, void 0, void 0, function* () {
            this.isLoading = true;
            this.assetType = this.assetTypes.getAssetTypeByName(this.asset.type);
            this.customProperties = yield this.resolveCustomProperties(this.properties);
            this.isLoading = false;
        });
    }
    resolveCustomProperties(managedObjects) {
        return __awaiter(this, void 0, void 0, function* () {
            const properties = [];
            for (const mo of managedObjects) {
                if (mo.c8y_JsonSchema) {
                    const items = yield this.parseItem(mo, mo.c8y_JsonSchema.properties, this.asset);
                    properties.push(items[0]);
                }
            }
            return properties;
        });
    }
    parseItem(mo, properties, asset) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            if (!asset) {
                return [];
            }
            const keys = Object.keys(properties);
            const items = [];
            for (const key of keys) {
                let value = asset[key];
                const type = properties[key].type;
                const title = properties[key].title;
                let file;
                if (type === 'file' && value) {
                    const fileId = typeof value === 'object' ? (_b = (_a = value[0]) === null || _a === void 0 ? void 0 : _a.file) === null || _b === void 0 ? void 0 : _b.id : value;
                    const fileData = yield this.getFileManagedObject(fileId);
                    file = fileData;
                    value = [fileData];
                }
                items.push({
                    key,
                    value,
                    label: title || mo.label,
                    type,
                    description: mo.description,
                    file,
                    complex: type === 'object'
                        ? yield this.parseItem(mo, properties[key].properties, asset[key])
                        : undefined,
                    isEdit: false,
                    jsonSchema: mo.c8y_JsonSchema
                });
            }
            return items;
        });
    }
    toggleEdit(prop) {
        prop.isEdit = !prop.isEdit;
    }
    getFileManagedObject(id) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { data } = yield this.inventory.detail(id);
                return data;
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
        });
    }
    save(model, prop) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (prop.type === 'object') {
                    model[prop.key] = yield this.uploadFiles(model[prop.key], prop.value);
                }
                else {
                    model = yield this.uploadFiles(model, prop.value);
                }
                const updatedAsset = Object.assign({ id: this.asset.id }, model);
                const { data } = yield this.inventory.update(updatedAsset);
                this.toggleEdit(prop);
                this.asset = data;
                yield this.loadAsset();
                this.contextRouteService.refreshContext();
                this.alert.success(gettext('Asset properties updated.'));
                this.contextRouteService.setContext(this.activatedRoute, data);
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
        });
    }
    uploadFiles(model, moId) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const keys = Object.keys(model);
            for (const key of keys) {
                if (Array.isArray(model[key]) && ((_a = model[key][0]) === null || _a === void 0 ? void 0 : _a.file) instanceof File) {
                    try {
                        const upload = yield this.inventoryBinary.create(model[key][0].file);
                        try {
                            if (moId && moId[0]) {
                                yield this.inventory.childAdditionsRemove(moId[0], this.asset.id);
                            }
                        }
                        catch (ex) {
                            this.alert.addServerFailure(ex);
                        }
                        model[key] = upload.data.id;
                        yield this.inventory.childAdditionsAdd(upload.data.id, this.asset.id);
                    }
                    catch (ex) {
                        this.alert.addServerFailure(ex);
                    }
                }
            }
            return model;
        });
    }
}
AssetPropertiesComponent.ɵfac = function AssetPropertiesComponent_Factory(t) { return new (t || AssetPropertiesComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AssetTypesService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.InventoryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.InventoryBinaryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AlertService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ContextRouteService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.ActivatedRoute)); };
AssetPropertiesComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: AssetPropertiesComponent, selectors: [["c8y-asset-properties"]], inputs: { properties: "properties", asset: "asset" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 8, vars: 7, consts: [[1, "card-header", "bg-inherit", "separator", "sticky-top"], ["translate", "", 1, "card-title", "p-t-4", "p-b-4", 3, "translateParams"], [1, "card-block"], ["class", "text-center", 4, "ngIf"], [4, "ngIf"], [1, "text-center"], ["class", "card m-b-8", 3, "ngClass", "title", 4, "ngFor", "ngForOf"], [1, "card", "m-b-8", 3, "ngClass", "title"], [1, "card-block", 3, "ngClass"], ["class", "d-flex p-b-8", 4, "ngIf"], [3, "file", "key", "type", "value", "complex", "isEdit", "jsonSchema"], ["assetProps", ""], ["class", "card-footer p-t-0", 4, "ngIf"], [1, "d-flex", "p-b-8"], [1, "text-medium"], [1, "btn", "btn-clean", "text-primary", "m-l-auto", "text-12", 3, "title", "click"], ["c8yIcon", "pencil"], [1, "card-footer", "p-t-0"], ["type", "button", "translate", "", 1, "btn", "btn-default", "btn-sm", 3, "click"], ["type", "button", "translate", "", 1, "btn", "btn-primary", "btn-sm", 3, "disabled", "click"]], template: function AssetPropertiesComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementContainerStart(0);
        ɵngcc0.ɵɵelementStart(1, "div", 0);
        ɵngcc0.ɵɵelementStart(2, "h4", 1);
        ɵngcc0.ɵɵdisableBindings();
        ɵngcc0.ɵɵpipe(3, "humanize");
        ɵngcc0.ɵɵtext(4, " {{ label }} properties ");
        ɵngcc0.ɵɵenableBindings();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(5, "div", 2);
        ɵngcc0.ɵɵtemplate(6, AssetPropertiesComponent_div_6_Template, 2, 0, "div", 3);
        ɵngcc0.ɵɵtemplate(7, AssetPropertiesComponent_ng_container_7_Template, 2, 1, "ng-container", 4);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementContainerEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction1(5, _c2, ɵngcc0.ɵɵpipeBind1(3, 3, (ctx.assetType == null ? null : ctx.assetType.label) || "")));
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isLoading);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isLoading);
    } }, directives: [ɵngcc1.C8yTranslateDirective, ɵngcc4.NgIf, ɵngcc1.LoadingComponent, ɵngcc4.NgForOf, ɵngcc4.NgClass, ɵngcc5.AssetPropertiesItemComponent, ɵngcc1.IconDirective], pipes: [ɵngcc1.HumanizePipe, ɵngcc1.C8yTranslatePipe], encapsulation: 2 });
AssetPropertiesComponent.ctorParameters = () => [
    { type: AssetTypesService },
    { type: InventoryService },
    { type: InventoryBinaryService },
    { type: AlertService },
    { type: ContextRouteService },
    { type: ActivatedRoute }
];
AssetPropertiesComponent.propDecorators = {
    asset: [{ type: Input }],
    properties: [{ type: Input }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AssetPropertiesComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-asset-properties',
                template: "<ng-container>\n  <div class=\"card-header bg-inherit separator sticky-top\">\n    <h4\n      class=\"card-title p-t-4 p-b-4\"\n      ngNonBindable\n      translate\n      [translateParams]=\"{ label: (assetType?.label || '') | humanize }\"\n    >\n      {{ label }} properties\n    </h4>\n  </div>\n  <div class=\"card-block\">\n    <div class=\"text-center\" *ngIf=\"isLoading\">\n      <c8y-loading></c8y-loading>\n    </div>\n\n    <ng-container *ngIf=\"!isLoading\">\n      <div\n        class=\"card m-b-8\"\n        *ngFor=\"let prop of customProperties\"\n        [ngClass]=\"{ 'card-highlight': prop.isEdit }\"\n        title=\"{{ prop.description | translate }}\"\n      >\n        <div class=\"card-block \" [ngClass]=\"{'p-b-0': prop.isEdit}\">\n          <div class=\"d-flex p-b-8\" *ngIf=\"!prop.isEdit\">\n            <p class=\"text-medium\">{{ prop?.label | humanize }}</p>\n            <button\n              class=\"btn btn-clean text-primary m-l-auto text-12\"\n              title=\"{{ 'Edit' | translate }}\"\n              (click)=\"toggleEdit(prop)\"\n            >\n              <i c8yIcon=\"pencil\"></i>\n            </button>\n          </div>\n          <c8y-asset-properties-item\n            #assetProps\n            [file]=\"prop.file\"\n            [key]=\"prop.key\"\n            [type]=\"prop.type\"\n            [value]=\"prop.value\"\n            [complex]=\"prop.complex\"\n            [isEdit]=\"prop.isEdit\"\n            [jsonSchema]=\"prop.jsonSchema\"\n          ></c8y-asset-properties-item>\n        </div>\n        <div class=\"card-footer p-t-0\" *ngIf=\"prop.isEdit\">\n          <button type=\"button\" class=\"btn btn-default btn-sm\" translate (click)=\"toggleEdit(prop)\">\n            Cancel\n          </button>\n          <button\n            type=\"button\"\n            class=\"btn btn-primary btn-sm\"\n            translate\n            [disabled]=\"!assetProps?.form?.valid\"\n            (click)=\"save(assetProps.model, prop)\"\n          >\n            Save\n          </button>\n        </div>\n      </div>\n    </ng-container>\n  </div>\n</ng-container>\n"
            }]
    }], function () { return [{ type: ɵngcc1.AssetTypesService }, { type: ɵngcc2.InventoryService }, { type: ɵngcc2.InventoryBinaryService }, { type: ɵngcc1.AlertService }, { type: ɵngcc1.ContextRouteService }, { type: ɵngcc3.ActivatedRoute }]; }, { properties: [{
            type: Input
        }], asset: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtcHJvcGVydGllcy5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3N1Yi1hc3NldHMvYXNzZXQtcHJvcGVydGllcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUE0QixNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUdMLHNCQUFzQixFQUN0QixnQkFBZ0IsRUFDakIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLFlBQVksRUFBRSxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU9wRyxNQUFNLE9BQU8sd0JBQXdCO0FBQUcsSUFVdEMsWUFDVSxVQUE2QixFQUM3QixTQUEyQixFQUMzQixlQUF1QyxFQUN2QyxLQUFtQixFQUNuQixtQkFBd0MsRUFDeEMsY0FBOEI7QUFDdkMsUUFOUyxlQUFVLEdBQVYsVUFBVSxDQUFtQjtBQUFDLFFBQzlCLGNBQVMsR0FBVCxTQUFTLENBQWtCO0FBQUMsUUFDNUIsb0JBQWUsR0FBZixlQUFlLENBQXdCO0FBQUMsUUFDeEMsVUFBSyxHQUFMLEtBQUssQ0FBYztBQUFDLFFBQ3BCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7QUFBQyxRQUN6QyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7QUFDMUMsUUFiRSxlQUFVLEdBQXFCLEVBQUUsQ0FBQztBQUNwQyxRQUNFLHFCQUFnQixHQUEwQixFQUFFLENBQUM7QUFDL0MsUUFBRSxXQUFNLEdBQUcsS0FBSyxDQUFDO0FBQ2pCLFFBQUUsY0FBUyxHQUFHLEtBQUssQ0FBQztBQUNwQixJQVFLLENBQUM7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Q0FBQyxFQUFFLENBQUMsQ0FBQztBQUNoRixxQkFBUztBQUFDLG9CQUFBLE9BQU8sRUFBRSxFQUFFO0FBQ3JCLHdCQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDMUMscUJBQVM7QUFDVCxpQkFBTztBQUNQLGFBQUs7QUFDTCxZQUFJLE9BQU8sS0FBSyxDQUFDO0FBQ2pCO0FBRU0sS0FGSDtBQUNIO29EQTVJQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLHNCQUFzQixrQkFDaEM7Ozs7Ozs7Ozs7Ozs7K0ZBQWdEO0lBQ2pEOzs7Ozs7Ozs7aVFBQ0k7QUFBQztBQUFrRCxZQVBqQyxpQkFBaUI7QUFBSSxZQUYxQyxnQkFBZ0I7QUFDZixZQUZELHNCQUFzQjtBQUN0QixZQUVPLFlBQVk7QUFBSSxZQUFpQixtQkFBbUI7QUFBSSxZQVB4RCxjQUFjO0FBQUc7QUFBRztBQUVmLG9CQWFYLEtBQUs7QUFDTix5QkFDQyxLQUFLO0FBQ1A7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJTWFuYWdlZE9iamVjdEJpbmFyeSxcbiAgSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgSW52ZW50b3J5U2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIEFzc2V0VHlwZXNTZXJ2aWNlLCBDb250ZXh0Um91dGVTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBBc3NldFByb3BlcnRpZXNJdGVtIH0gZnJvbSAnLi9hc3NldC1wcm9wZXJ0aWVzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFzc2V0LXByb3BlcnRpZXMnLFxuICB0ZW1wbGF0ZVVybDogJy4vYXNzZXQtcHJvcGVydGllcy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQXNzZXRQcm9wZXJ0aWVzQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgQElucHV0KClcbiAgYXNzZXQ6IElNYW5hZ2VkT2JqZWN0O1xuICBASW5wdXQoKVxuICBwcm9wZXJ0aWVzOiBJTWFuYWdlZE9iamVjdFtdID0gW107XG4gIGFzc2V0VHlwZTogSU1hbmFnZWRPYmplY3Q7XG4gIGN1c3RvbVByb3BlcnRpZXM6IEFzc2V0UHJvcGVydGllc0l0ZW1bXSA9IFtdO1xuICBpc0VkaXQgPSBmYWxzZTtcbiAgaXNMb2FkaW5nID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhc3NldFR5cGVzOiBBc3NldFR5cGVzU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeTogSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb250ZXh0Um91dGVTZXJ2aWNlOiBDb250ZXh0Um91dGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlXG4gICkge31cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuYXNzZXQpIHtcbiAgICAgIC8vIEJhY2sgYnV0dG9uIGhhbmRsaW5nLCBhcyBjb21wb25lbnQgaXMgbm90IGRlc3Ryb3llZFxuICAgICAgdGhpcy5hc3NldFR5cGUgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmN1c3RvbVByb3BlcnRpZXMgPSBbXTtcbiAgICAgIHRoaXMubG9hZEFzc2V0KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZEFzc2V0KCkge1xuICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLmFzc2V0VHlwZSA9IHRoaXMuYXNzZXRUeXBlcy5nZXRBc3NldFR5cGVCeU5hbWUodGhpcy5hc3NldC50eXBlKTtcbiAgICB0aGlzLmN1c3RvbVByb3BlcnRpZXMgPSBhd2FpdCB0aGlzLnJlc29sdmVDdXN0b21Qcm9wZXJ0aWVzKHRoaXMucHJvcGVydGllcyk7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHJlc29sdmVDdXN0b21Qcm9wZXJ0aWVzKG1hbmFnZWRPYmplY3RzOiBJTWFuYWdlZE9iamVjdFtdKSB7XG4gICAgY29uc3QgcHJvcGVydGllcyA9IFtdO1xuICAgIGZvciAoY29uc3QgbW8gb2YgbWFuYWdlZE9iamVjdHMpIHtcbiAgICAgIGlmIChtby5jOHlfSnNvblNjaGVtYSkge1xuICAgICAgICBjb25zdCBpdGVtcyA9IGF3YWl0IHRoaXMucGFyc2VJdGVtKG1vLCBtby5jOHlfSnNvblNjaGVtYS5wcm9wZXJ0aWVzLCB0aGlzLmFzc2V0KTtcbiAgICAgICAgcHJvcGVydGllcy5wdXNoKGl0ZW1zWzBdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gIH1cblxuICBhc3luYyBwYXJzZUl0ZW0obW86IElNYW5hZ2VkT2JqZWN0LCBwcm9wZXJ0aWVzLCBhc3NldCk6IFByb21pc2U8QXNzZXRQcm9wZXJ0aWVzSXRlbVtdPiB7XG4gICAgaWYgKCFhc3NldCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7XG4gICAgY29uc3QgaXRlbXM6IEFzc2V0UHJvcGVydGllc0l0ZW1bXSA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGFzc2V0W2tleV07XG4gICAgICBjb25zdCB0eXBlID0gcHJvcGVydGllc1trZXldLnR5cGU7XG4gICAgICBjb25zdCB0aXRsZSA9IHByb3BlcnRpZXNba2V5XS50aXRsZTtcbiAgICAgIGxldCBmaWxlO1xuICAgICAgaWYgKHR5cGUgPT09ICdmaWxlJyAmJiB2YWx1ZSkge1xuICAgICAgICBjb25zdCBmaWxlSWQgPSB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnID8gdmFsdWVbMF0/LmZpbGU/LmlkIDogdmFsdWU7XG4gICAgICAgIGNvbnN0IGZpbGVEYXRhID0gYXdhaXQgdGhpcy5nZXRGaWxlTWFuYWdlZE9iamVjdChmaWxlSWQpO1xuICAgICAgICBmaWxlID0gZmlsZURhdGE7XG4gICAgICAgIHZhbHVlID0gW2ZpbGVEYXRhXTtcbiAgICAgIH1cbiAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICBrZXksXG4gICAgICAgIHZhbHVlLFxuICAgICAgICBsYWJlbDogdGl0bGUgfHwgbW8ubGFiZWwsXG4gICAgICAgIHR5cGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBtby5kZXNjcmlwdGlvbixcbiAgICAgICAgZmlsZSxcbiAgICAgICAgY29tcGxleDpcbiAgICAgICAgICB0eXBlID09PSAnb2JqZWN0J1xuICAgICAgICAgICAgPyBhd2FpdCB0aGlzLnBhcnNlSXRlbShtbywgcHJvcGVydGllc1trZXldLnByb3BlcnRpZXMsIGFzc2V0W2tleV0pXG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgaXNFZGl0OiBmYWxzZSxcbiAgICAgICAganNvblNjaGVtYTogbW8uYzh5X0pzb25TY2hlbWFcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gaXRlbXM7XG4gIH1cblxuICB0b2dnbGVFZGl0KHByb3A6IEFzc2V0UHJvcGVydGllc0l0ZW0pIHtcbiAgICBwcm9wLmlzRWRpdCA9ICFwcm9wLmlzRWRpdDtcbiAgfVxuXG4gIGFzeW5jIGdldEZpbGVNYW5hZ2VkT2JqZWN0KGlkOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoaWQpO1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZShtb2RlbCwgcHJvcDogQXNzZXRQcm9wZXJ0aWVzSXRlbSkge1xuICAgIHRyeSB7XG4gICAgICBpZiAocHJvcC50eXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgICBtb2RlbFtwcm9wLmtleV0gPSBhd2FpdCB0aGlzLnVwbG9hZEZpbGVzKG1vZGVsW3Byb3Aua2V5XSwgcHJvcC52YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtb2RlbCA9IGF3YWl0IHRoaXMudXBsb2FkRmlsZXMobW9kZWwsIHByb3AudmFsdWUpO1xuICAgICAgfVxuICAgICAgY29uc3QgdXBkYXRlZEFzc2V0ID0geyBpZDogdGhpcy5hc3NldC5pZCwgLi4ubW9kZWwgfTtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkudXBkYXRlKHVwZGF0ZWRBc3NldCk7XG4gICAgICB0aGlzLnRvZ2dsZUVkaXQocHJvcCk7XG4gICAgICB0aGlzLmFzc2V0ID0gZGF0YTtcbiAgICAgIGF3YWl0IHRoaXMubG9hZEFzc2V0KCk7XG4gICAgICB0aGlzLmNvbnRleHRSb3V0ZVNlcnZpY2UucmVmcmVzaENvbnRleHQoKTtcbiAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdBc3NldCBwcm9wZXJ0aWVzIHVwZGF0ZWQuJykpO1xuICAgICAgdGhpcy5jb250ZXh0Um91dGVTZXJ2aWNlLnNldENvbnRleHQodGhpcy5hY3RpdmF0ZWRSb3V0ZSwgZGF0YSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGxvYWRGaWxlcyhtb2RlbDogb2JqZWN0LCBtb0lkPzogSU1hbmFnZWRPYmplY3RCaW5hcnlbXSk6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG1vZGVsKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShtb2RlbFtrZXldKSAmJiBtb2RlbFtrZXldWzBdPy5maWxlIGluc3RhbmNlb2YgRmlsZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHVwbG9hZCA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmNyZWF0ZShtb2RlbFtrZXldWzBdLmZpbGUpO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAobW9JZCAmJiBtb0lkWzBdKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5LmNoaWxkQWRkaXRpb25zUmVtb3ZlKG1vSWRbMF0sIHRoaXMuYXNzZXQuaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBtb2RlbFtrZXldID0gdXBsb2FkLmRhdGEuaWQ7XG4gICAgICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQodXBsb2FkLmRhdGEuaWQsIHRoaXMuYXNzZXQuaWQpO1xuICAgICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG1vZGVsO1xuICB9XG59XG4iXX0=