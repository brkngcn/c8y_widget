import { __awaiter } from "tslib";
import { Component, Input } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryBinaryService, InventoryService } from '@c8y/client';
import { AlertService, AssetTypesService, ContextRouteService, gettext } from '@c8y/ngx-components';
export class AssetPropertiesComponent {
    constructor(assetTypes, inventory, inventoryBinary, alert, contextRouteService, activatedRoute) {
        this.assetTypes = assetTypes;
        this.inventory = inventory;
        this.inventoryBinary = inventoryBinary;
        this.alert = alert;
        this.contextRouteService = contextRouteService;
        this.activatedRoute = activatedRoute;
        this.properties = [];
        this.customProperties = [];
        this.isEdit = false;
        this.isLoading = false;
    }
    ngOnChanges(changes) {
        if (changes.asset) {
            // Back button handling, as component is not destroyed
            this.assetType = undefined;
            this.customProperties = [];
            this.loadAsset();
        }
    }
    loadAsset() {
        return __awaiter(this, void 0, void 0, function* () {
            this.isLoading = true;
            this.assetType = this.assetTypes.getAssetTypeByName(this.asset.type);
            this.customProperties = yield this.resolveCustomProperties(this.properties);
            this.isLoading = false;
        });
    }
    resolveCustomProperties(managedObjects) {
        return __awaiter(this, void 0, void 0, function* () {
            const properties = [];
            for (const mo of managedObjects) {
                if (mo.c8y_JsonSchema) {
                    const items = yield this.parseItem(mo, mo.c8y_JsonSchema.properties, this.asset);
                    properties.push(items[0]);
                }
            }
            return properties;
        });
    }
    parseItem(mo, properties, asset) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            if (!asset) {
                return [];
            }
            const keys = Object.keys(properties);
            const items = [];
            for (const key of keys) {
                let value = asset[key];
                const type = properties[key].type;
                const title = properties[key].title;
                let file;
                if (type === 'file' && value) {
                    const fileId = typeof value === 'object' ? (_b = (_a = value[0]) === null || _a === void 0 ? void 0 : _a.file) === null || _b === void 0 ? void 0 : _b.id : value;
                    const fileData = yield this.getFileManagedObject(fileId);
                    file = fileData;
                    value = [fileData];
                }
                items.push({
                    key,
                    value,
                    label: title || mo.label,
                    type,
                    description: mo.description,
                    file,
                    complex: type === 'object'
                        ? yield this.parseItem(mo, properties[key].properties, asset[key])
                        : undefined,
                    isEdit: false,
                    jsonSchema: mo.c8y_JsonSchema
                });
            }
            return items;
        });
    }
    toggleEdit(prop) {
        prop.isEdit = !prop.isEdit;
    }
    getFileManagedObject(id) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { data } = yield this.inventory.detail(id);
                return data;
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
        });
    }
    save(model, prop) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (prop.type === 'object') {
                    model[prop.key] = yield this.uploadFiles(model[prop.key], prop.value);
                }
                else {
                    model = yield this.uploadFiles(model, prop.value);
                }
                const updatedAsset = Object.assign({ id: this.asset.id }, model);
                const { data } = yield this.inventory.update(updatedAsset);
                this.toggleEdit(prop);
                this.asset = data;
                yield this.loadAsset();
                this.contextRouteService.refreshContext();
                this.alert.success(gettext('Asset properties updated.'));
                this.contextRouteService.setContext(this.activatedRoute, data);
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
        });
    }
    uploadFiles(model, moId) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const keys = Object.keys(model);
            for (const key of keys) {
                if (Array.isArray(model[key]) && ((_a = model[key][0]) === null || _a === void 0 ? void 0 : _a.file) instanceof File) {
                    try {
                        const upload = yield this.inventoryBinary.create(model[key][0].file);
                        try {
                            if (moId && moId[0]) {
                                yield this.inventory.childAdditionsRemove(moId[0], this.asset.id);
                            }
                        }
                        catch (ex) {
                            this.alert.addServerFailure(ex);
                        }
                        model[key] = upload.data.id;
                        yield this.inventory.childAdditionsAdd(upload.data.id, this.asset.id);
                    }
                    catch (ex) {
                        this.alert.addServerFailure(ex);
                    }
                }
            }
            return model;
        });
    }
}
AssetPropertiesComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-asset-properties',
                template: "<ng-container>\n  <div class=\"card-header bg-inherit separator sticky-top\">\n    <h4\n      class=\"card-title p-t-4 p-b-4\"\n      ngNonBindable\n      translate\n      [translateParams]=\"{ label: (assetType?.label || '') | humanize }\"\n    >\n      {{ label }} properties\n    </h4>\n  </div>\n  <div class=\"card-block\">\n    <div class=\"text-center\" *ngIf=\"isLoading\">\n      <c8y-loading></c8y-loading>\n    </div>\n\n    <ng-container *ngIf=\"!isLoading\">\n      <div\n        class=\"card m-b-8\"\n        *ngFor=\"let prop of customProperties\"\n        [ngClass]=\"{ 'card-highlight': prop.isEdit }\"\n        title=\"{{ prop.description | translate }}\"\n      >\n        <div class=\"card-block \" [ngClass]=\"{'p-b-0': prop.isEdit}\">\n          <div class=\"d-flex p-b-8\" *ngIf=\"!prop.isEdit\">\n            <p class=\"text-medium\">{{ prop?.label | humanize }}</p>\n            <button\n              class=\"btn btn-clean text-primary m-l-auto text-12\"\n              title=\"{{ 'Edit' | translate }}\"\n              (click)=\"toggleEdit(prop)\"\n            >\n              <i c8yIcon=\"pencil\"></i>\n            </button>\n          </div>\n          <c8y-asset-properties-item\n            #assetProps\n            [file]=\"prop.file\"\n            [key]=\"prop.key\"\n            [type]=\"prop.type\"\n            [value]=\"prop.value\"\n            [complex]=\"prop.complex\"\n            [isEdit]=\"prop.isEdit\"\n            [jsonSchema]=\"prop.jsonSchema\"\n          ></c8y-asset-properties-item>\n        </div>\n        <div class=\"card-footer p-t-0\" *ngIf=\"prop.isEdit\">\n          <button type=\"button\" class=\"btn btn-default btn-sm\" translate (click)=\"toggleEdit(prop)\">\n            Cancel\n          </button>\n          <button\n            type=\"button\"\n            class=\"btn btn-primary btn-sm\"\n            translate\n            [disabled]=\"!assetProps?.form?.valid\"\n            (click)=\"save(assetProps.model, prop)\"\n          >\n            Save\n          </button>\n        </div>\n      </div>\n    </ng-container>\n  </div>\n</ng-container>\n"
            },] }
];
AssetPropertiesComponent.ctorParameters = () => [
    { type: AssetTypesService },
    { type: InventoryService },
    { type: InventoryBinaryService },
    { type: AlertService },
    { type: ContextRouteService },
    { type: ActivatedRoute }
];
AssetPropertiesComponent.propDecorators = {
    asset: [{ type: Input }],
    properties: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtcHJvcGVydGllcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zdWItYXNzZXRzL2Fzc2V0LXByb3BlcnRpZXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFHTCxzQkFBc0IsRUFDdEIsZ0JBQWdCLEVBQ2pCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFPcEcsTUFBTSxPQUFPLHdCQUF3QjtJQVVuQyxZQUNVLFVBQTZCLEVBQzdCLFNBQTJCLEVBQzNCLGVBQXVDLEVBQ3ZDLEtBQW1CLEVBQ25CLG1CQUF3QyxFQUN4QyxjQUE4QjtRQUw5QixlQUFVLEdBQVYsVUFBVSxDQUFtQjtRQUM3QixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBd0I7UUFDdkMsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQVp4QyxlQUFVLEdBQXFCLEVBQUUsQ0FBQztRQUVsQyxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBQzdDLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFDZixjQUFTLEdBQUcsS0FBSyxDQUFDO0lBU2YsQ0FBQztJQUVKLFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDakIsc0RBQXNEO1lBQ3RELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1lBQzNCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxF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QUFDO3lCQUNqQzt3QkFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7d0JBQzVCLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUN2RTtvQkFBQyxPQUFPLEVBQUUsRUFBRTt3QkFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUNqQztpQkFDRjthQUNGO1lBQ0QsT0FBTyxLQUFLLENBQUM7O0tBQ2Q7OztZQTNJRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHNCQUFzQjtnQkFDaEMsc2xFQUFnRDthQUNqRDs7O1lBTnNCLGlCQUFpQjtZQUZ0QyxnQkFBZ0I7WUFEaEIsc0JBQXNCO1lBR2YsWUFBWTtZQUFxQixtQkFBbUI7WUFQcEQsY0FBYzs7O29CQWVwQixLQUFLO3lCQUVMLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJTWFuYWdlZE9iamVjdEJpbmFyeSxcbiAgSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgSW52ZW50b3J5U2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIEFzc2V0VHlwZXNTZXJ2aWNlLCBDb250ZXh0Um91dGVTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBBc3NldFByb3BlcnRpZXNJdGVtIH0gZnJvbSAnLi9hc3NldC1wcm9wZXJ0aWVzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFzc2V0LXByb3BlcnRpZXMnLFxuICB0ZW1wbGF0ZVVybDogJy4vYXNzZXQtcHJvcGVydGllcy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQXNzZXRQcm9wZXJ0aWVzQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgQElucHV0KClcbiAgYXNzZXQ6IElNYW5hZ2VkT2JqZWN0O1xuICBASW5wdXQoKVxuICBwcm9wZXJ0aWVzOiBJTWFuYWdlZE9iamVjdFtdID0gW107XG4gIGFzc2V0VHlwZTogSU1hbmFnZWRPYmplY3Q7XG4gIGN1c3RvbVByb3BlcnRpZXM6IEFzc2V0UHJvcGVydGllc0l0ZW1bXSA9IFtdO1xuICBpc0VkaXQgPSBmYWxzZTtcbiAgaXNMb2FkaW5nID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhc3NldFR5cGVzOiBBc3NldFR5cGVzU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeTogSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb250ZXh0Um91dGVTZXJ2aWNlOiBDb250ZXh0Um91dGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlXG4gICkge31cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuYXNzZXQpIHtcbiAgICAgIC8vIEJhY2sgYnV0dG9uIGhhbmRsaW5nLCBhcyBjb21wb25lbnQgaXMgbm90IGRlc3Ryb3llZFxuICAgICAgdGhpcy5hc3NldFR5cGUgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmN1c3RvbVByb3BlcnRpZXMgPSBbXTtcbiAgICAgIHRoaXMubG9hZEFzc2V0KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZEFzc2V0KCkge1xuICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLmFzc2V0VHlwZSA9IHRoaXMuYXNzZXRUeXBlcy5nZXRBc3NldFR5cGVCeU5hbWUodGhpcy5hc3NldC50eXBlKTtcbiAgICB0aGlzLmN1c3RvbVByb3BlcnRpZXMgPSBhd2FpdCB0aGlzLnJlc29sdmVDdXN0b21Qcm9wZXJ0aWVzKHRoaXMucHJvcGVydGllcyk7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHJlc29sdmVDdXN0b21Qcm9wZXJ0aWVzKG1hbmFnZWRPYmplY3RzOiBJTWFuYWdlZE9iamVjdFtdKSB7XG4gICAgY29uc3QgcHJvcGVydGllcyA9IFtdO1xuICAgIGZvciAoY29uc3QgbW8gb2YgbWFuYWdlZE9iamVjdHMpIHtcbiAgICAgIGlmIChtby5jOHlfSnNvblNjaGVtYSkge1xuICAgICAgICBjb25zdCBpdGVtcyA9IGF3YWl0IHRoaXMucGFyc2VJdGVtKG1vLCBtby5jOHlfSnNvblNjaGVtYS5wcm9wZXJ0aWVzLCB0aGlzLmFzc2V0KTtcbiAgICAgICAgcHJvcGVydGllcy5wdXNoKGl0ZW1zWzBdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gIH1cblxuICBhc3luYyBwYXJzZUl0ZW0obW86IElNYW5hZ2VkT2JqZWN0LCBwcm9wZXJ0aWVzLCBhc3NldCk6IFByb21pc2U8QXNzZXRQcm9wZXJ0aWVzSXRlbVtdPiB7XG4gICAgaWYgKCFhc3NldCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7XG4gICAgY29uc3QgaXRlbXM6IEFzc2V0UHJvcGVydGllc0l0ZW1bXSA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGFzc2V0W2tleV07XG4gICAgICBjb25zdCB0eXBlID0gcHJvcGVydGllc1trZXldLnR5cGU7XG4gICAgICBjb25zdCB0aXRsZSA9IHByb3BlcnRpZXNba2V5XS50aXRsZTtcbiAgICAgIGxldCBmaWxlO1xuICAgICAgaWYgKHR5cGUgPT09ICdmaWxlJyAmJiB2YWx1ZSkge1xuICAgICAgICBjb25zdCBmaWxlSWQgPSB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnID8gdmFsdWVbMF0/LmZpbGU/LmlkIDogdmFsdWU7XG4gICAgICAgIGNvbnN0IGZpbGVEYXRhID0gYXdhaXQgdGhpcy5nZXRGaWxlTWFuYWdlZE9iamVjdChmaWxlSWQpO1xuICAgICAgICBmaWxlID0gZmlsZURhdGE7XG4gICAgICAgIHZhbHVlID0gW2ZpbGVEYXRhXTtcbiAgICAgIH1cbiAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICBrZXksXG4gICAgICAgIHZhbHVlLFxuICAgICAgICBsYWJlbDogdGl0bGUgfHwgbW8ubGFiZWwsXG4gICAgICAgIHR5cGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBtby5kZXNjcmlwdGlvbixcbiAgICAgICAgZmlsZSxcbiAgICAgICAgY29tcGxleDpcbiAgICAgICAgICB0eXBlID09PSAnb2JqZWN0J1xuICAgICAgICAgICAgPyBhd2FpdCB0aGlzLnBhcnNlSXRlbShtbywgcHJvcGVydGllc1trZXldLnByb3BlcnRpZXMsIGFzc2V0W2tleV0pXG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgaXNFZGl0OiBmYWxzZSxcbiAgICAgICAganNvblNjaGVtYTogbW8uYzh5X0pzb25TY2hlbWFcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gaXRlbXM7XG4gIH1cblxuICB0b2dnbGVFZGl0KHByb3A6IEFzc2V0UHJvcGVydGllc0l0ZW0pIHtcbiAgICBwcm9wLmlzRWRpdCA9ICFwcm9wLmlzRWRpdDtcbiAgfVxuXG4gIGFzeW5jIGdldEZpbGVNYW5hZ2VkT2JqZWN0KGlkOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoaWQpO1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZShtb2RlbCwgcHJvcDogQXNzZXRQcm9wZXJ0aWVzSXRlbSkge1xuICAgIHRyeSB7XG4gICAgICBpZiAocHJvcC50eXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgICBtb2RlbFtwcm9wLmtleV0gPSBhd2FpdCB0aGlzLnVwbG9hZEZpbGVzKG1vZGVsW3Byb3Aua2V5XSwgcHJvcC52YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtb2RlbCA9IGF3YWl0IHRoaXMudXBsb2FkRmlsZXMobW9kZWwsIHByb3AudmFsdWUpO1xuICAgICAgfVxuICAgICAgY29uc3QgdXBkYXRlZEFzc2V0ID0geyBpZDogdGhpcy5hc3NldC5pZCwgLi4ubW9kZWwgfTtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkudXBkYXRlKHVwZGF0ZWRBc3NldCk7XG4gICAgICB0aGlzLnRvZ2dsZUVkaXQocHJvcCk7XG4gICAgICB0aGlzLmFzc2V0ID0gZGF0YTtcbiAgICAgIGF3YWl0IHRoaXMubG9hZEFzc2V0KCk7XG4gICAgICB0aGlzLmNvbnRleHRSb3V0ZVNlcnZpY2UucmVmcmVzaENvbnRleHQoKTtcbiAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdBc3NldCBwcm9wZXJ0aWVzIHVwZGF0ZWQuJykpO1xuICAgICAgdGhpcy5jb250ZXh0Um91dGVTZXJ2aWNlLnNldENvbnRleHQodGhpcy5hY3RpdmF0ZWRSb3V0ZSwgZGF0YSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGxvYWRGaWxlcyhtb2RlbDogb2JqZWN0LCBtb0lkPzogSU1hbmFnZWRPYmplY3RCaW5hcnlbXSk6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG1vZGVsKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShtb2RlbFtrZXldKSAmJiBtb2RlbFtrZXldWzBdPy5maWxlIGluc3RhbmNlb2YgRmlsZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHVwbG9hZCA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmNyZWF0ZShtb2RlbFtrZXldWzBdLmZpbGUpO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAobW9JZCAmJiBtb0lkWzBdKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5LmNoaWxkQWRkaXRpb25zUmVtb3ZlKG1vSWRbMF0sIHRoaXMuYXNzZXQuaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBtb2RlbFtrZXldID0gdXBsb2FkLmRhdGEuaWQ7XG4gICAgICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQodXBsb2FkLmRhdGEuaWQsIHRoaXMuYXNzZXQuaWQpO1xuICAgICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG1vZGVsO1xuICB9XG59XG4iXX0=