import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { FetchClient, ApplicationService, InventoryService } from '@c8y/client';
import { gettext, OptionsService } from '@c8y/ngx-components';
import { some } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client/lib/src/inventory/InventoryService";
import * as i2 from "@c8y/client/lib/src/core/FetchClient";
import * as i3 from "@ngx-translate/core";
import * as i4 from "@c8y/client/lib/src/application/ApplicationService";
import * as i5 from "@c8y/ngx-components";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@ngx-translate/core';
import * as ɵngcc3 from '@c8y/ngx-components';
export var ErrorName;
(function (ErrorName) {
    ErrorName["NoConnectivityPlansError"] = "NoConnectivityPlansError";
    ErrorName["NoFreeSlotsInConnectivityPlansError"] = "NoFreeSlotsInConnectivityPlansError";
    ErrorName["NoConnectivitySettingsError"] = "NoConnectivitySettingsError";
    ErrorName["NoDeviceProfilesError"] = "NoDeviceProfilesError";
    ErrorName["DeviceProfilesFetchError"] = "DeviceProfilesFetchError";
    ErrorName["NoDeviceProtocolsError"] = "NoDeviceProtocolsError";
    ErrorName["DeviceProtocolsFetchError"] = "DeviceProtocolsFetchError";
    ErrorName["RegistrationError"] = "RegistrationError";
})(ErrorName || (ErrorName = {}));
export class ActilityDeviceRegistrationService {
    constructor(inventoryService, client, translateService, applicationService, optionsService) {
        this.inventoryService = inventoryService;
        this.client = client;
        this.translateService = translateService;
        this.applicationService = applicationService;
        this.optionsService = optionsService;
        this.baseUrl = '/service/actility';
        this.registrationUrl = `${this.baseUrl}/newDeviceRequest`;
        this.connectivityPlansUrl = `${this.baseUrl}/connectivityPlans`;
        this.deviceProfilesUrl = `${this.baseUrl}/deviceProfiles`;
        this.headers = {
            'Content-Type': 'application/json'
        };
    }
    getConnections() {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.headers
            };
            const res = yield this.client.fetch(`${this.baseUrl}/lns-connection`, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    yield this.throwNoConnectivitySettingsError();
                }
            }
            else {
                yield this.throwNoConnectivitySettingsError();
            }
            return { res, data };
        });
    }
    /**
     * Gets connectivity plans from LoRa platform.
     * @param connectionName The name of connection for which connectivity plans will be retrieved
     * @returns The result list with connectivity plans, or throws an error with exception.
     */
    getConnectivityPlans(connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.headers,
                params: {
                    actilityConnectionName: connectionName
                }
            };
            const res = yield this.client.fetch(this.connectivityPlansUrl, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoConnectivityPlansError();
                }
                else {
                    if (!this.hasAvailableConnections(data)) {
                        this.throwNoFreeSlotsInConnectivityPlansError();
                    }
                }
            }
            else {
                yield this.throwNoConnectivitySettingsError();
            }
            return { res, data };
        });
    }
    /**
     * Gets the device profiles from LoRa platform.
     * @param connectionName The name of connection for which device profiles will be retrieved
     * @returns The result list with device profiles, or throws an error with exception.
     */
    getDeviceProfiles(connectionName) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'GET',
                headers: this.headers,
                params: {
                    actilityConnectionName: connectionName
                }
            };
            const res = yield this.client.fetch(this.deviceProfilesUrl, options);
            const data = yield res.json();
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoDeviceProfilesError();
                }
            }
            else {
                this.throwDeviceProfilesFetchError();
            }
            return { res, data };
        });
    }
    /**
     * Gets the device protocols
     */
    getDeviceProtocols() {
        return __awaiter(this, void 0, void 0, function* () {
            const filters = {
                pageSize: 20,
                withTotalPages: true
            };
            const query = {
                __filter: {
                    __and: [
                        { __has: 'c8y_IsDeviceType' },
                        {
                            type: { __in: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType', 'c8y_LpwanDeviceType'] }
                        }
                    ]
                },
                __orderby: [{ name: 1 }]
            };
            const { res, data } = yield this.inventoryService.listQuery(query, filters);
            if (res.status === 200) {
                if (data.length === 0) {
                    this.throwNoDeviceProtocolsError();
                }
            }
            else {
                this.throwDeviceProtocolsFetchError();
            }
            return { res, data };
        });
    }
    /**
     * Creates device registration
     */
    register(registration) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'POST',
                headers: this.headers,
                body: JSON.stringify(registration)
            };
            const res = yield this.client.fetch(this.registrationUrl, options);
            const data = yield res.json();
            if (res.status !== 201) {
                this.throwRegistrationError(data);
            }
            return { res, data };
        });
    }
    /**
     * checks if used connections is less then granted connections
     */
    hasAvailableConnections(connectivityPlans) {
        return some(connectivityPlans, plan => parseInt(plan.grantedConnections, 10) > parseInt(plan.usedConnections, 10));
    }
    throwNoConnectivitySettingsError() {
        return __awaiter(this, void 0, void 0, function* () {
            const error = new Error();
            error.name = ErrorName.NoConnectivitySettingsError;
            if ((yield this.applicationService.isAvailable('administration')).data) {
                error.message = this.translateService.instant(gettext(`Could not get connectivity plans from the LoRa platform. Verify the ThingPark credentials in the Administration app under <a href="{{ link }}">Settings</a>.`), {
                    link: '/apps/administration/index.html#/connectivitySettings/actility_lora_provider_settings'
                });
            }
            else {
                error.message = gettext('Could not get connectivity plans from the LoRa platform. Please contact the administrator.');
            }
            throw error;
        });
    }
    throwNoConnectivityPlansError() {
        const error = new Error();
        error.name = ErrorName.NoConnectivityPlansError;
        error.message = gettext('No connectivity plans found. New connectivity plans must be created via the LoRa platform.');
        throw error;
    }
    throwNoFreeSlotsInConnectivityPlansError() {
        const companyName = this.optionsService.get('companyName', 'Cumulocity IoT');
        const error = new Error();
        error.name = ErrorName.NoFreeSlotsInConnectivityPlansError;
        error.message = this.translateService.instant(gettext(`No connectivity plans with free slots available. Please contact ThingPark on the device quota limits for your connectivity plans or remove unused devices from ThingPark and retry registering the device in the {{companyName}} platform.`), {
            companyName
        });
        throw error;
    }
    throwDeviceProfilesFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProfilesFetchError;
        error.message = gettext('Could not load device profiles from the LoRa platform.');
        throw error;
    }
    throwNoDeviceProfilesError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProfilesError;
        error.message = gettext('No device profiles found. Create a new device profile via the LoRa platform.');
        throw error;
    }
    throwDeviceProtocolsFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProtocolsFetchError;
        error.message = gettext('Could not load device protocols.');
        throw error;
    }
    throwNoDeviceProtocolsError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProtocolsError;
        error.message = this.translateService.instant(gettext(`No device protocols configured. Create a LoRa device protocol in <a href="{{ link }}">Device protocols</a>.`), {
            link: '/apps/devicemanagement/#/deviceprotocols'
        });
        throw error;
    }
    throwRegistrationError(data) {
        const error = new Error();
        error.name = ErrorName.RegistrationError;
        error.message = data.message;
        throw error;
    }
}
ActilityDeviceRegistrationService.ɵfac = function ActilityDeviceRegistrationService_Factory(t) { return new (t || ActilityDeviceRegistrationService)(ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc1.FetchClient), ɵngcc0.ɵɵinject(ɵngcc2.TranslateService), ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService), ɵngcc0.ɵɵinject(ɵngcc3.OptionsService)); };
ActilityDeviceRegistrationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ActilityDeviceRegistrationService_Factory() { return new ActilityDeviceRegistrationService(i0.ɵɵinject(i1.InventoryService), i0.ɵɵinject(i2.FetchClient), i0.ɵɵinject(i3.TranslateService), i0.ɵɵinject(i4.ApplicationService), i0.ɵɵinject(i5.OptionsService)); }, token: ActilityDeviceRegistrationService, providedIn: "root" });
ActilityDeviceRegistrationService.ctorParameters = () => [
    { type: InventoryService },
    { type: FetchClient },
    { type: TranslateService },
    { type: ApplicationService },
    { type: OptionsService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ActilityDeviceRegistrationService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc1.InventoryService }, { type: ɵngcc1.FetchClient }, { type: ɵngcc2.TranslateService }, { type: ɵngcc1.ApplicationService }, { type: ɵngcc3.OptionsService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aWxpdHktZGV2aWNlLXJlZ2lzdHJhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9hY3RpbGl0eS1kZXZpY2UtcmVnaXN0cmF0aW9uL2FjdGlsaXR5LWRldmljZS1yZWdpc3RyYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQ0wsV0FBVyxFQUVYLGtCQUFrQixFQUVsQixnQkFBZ0IsRUFFakIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQU05RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDO0FBRVk7QUFDYTtBQUNuQjtBQUEyQztBQUV4Qzs7Ozs7QUFMVCxNQUFNLENBQU4sSUFBWSxTQVNYO0FBVEQsV0FBWSxTQUFTO0FBQ3BCLElBQUMsa0VBQXFELENBQUE7QUFBQyxJQUN0RCx3RkFBMkUsQ0FBQTtBQUFDLElBQzVFLHdFQUEyRCxDQUFBO0FBQUMsSUFDNUQsNERBQStDLENBQUE7QUFBQyxJQUNoRCxrRUFBcUQsQ0FBQTtBQUFDLElBQ3RELDhEQUFpRCxDQUFBO0FBQUMsSUFDbEQsb0VBQXVELENBQUE7QUFBQyxJQUN4RCxvREFBdUMsQ0FBQTtBQUN6QyxDQUFDLEVBVFcsU0FBUyxLQUFULFNBQVMsUUFTcEI7QUFHRCxNQUFNLE9BQU8saUNBQWlDO0FBQzlDLElBUUUsWUFDVSxnQkFBa0MsRUFDbEMsTUFBbUIsRUFDbkIsZ0JBQWtDLEVBQ2xDLGtCQUFzQyxFQUN0QyxjQUE4QjtBQUN2QyxRQUxTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxXQUFNLEdBQU4sTUFBTSxDQUFhO0FBQUMsUUFDcEIscUJB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QztBQUNIO3FXQUFDO0FBQ0Qsd1pBdFBLO0FBQUM7RUFETCxVQUFVLFNBQUMsRUFBRSx2QkFFRSxZQXhCZCxnQkFBZ0I7Q0FzQk0sRUFBRSxNQUFNLEVBQUUsWEFyQmhDLFlBTEEsV0FBVztBQUNYLFlBSE8sZ0JBQWdCO0FBQUksWUFJM0Isa0JBQWtCO0FBQ2xCLFlBSWdCLGNBQWM7QUFBRzs7Ozt3TkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHtcbiAgRmV0Y2hDbGllbnQsXG4gIElGZXRjaE9wdGlvbnMsXG4gIEFwcGxpY2F0aW9uU2VydmljZSxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElSZXN1bHRMaXN0XG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldHRleHQsIE9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBBY3RpbGl0eURldmljZVJlZ2lzdHJhdGlvbixcbiAgQ29ubmVjdGl2aXR5UGxhbixcbiAgRGV2aWNlUHJvZmlsZVxufSBmcm9tICcuL2FjdGlsaXR5LWRldmljZS1yZWdpc3RyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgc29tZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbmV4cG9ydCBlbnVtIEVycm9yTmFtZSB7XG4gIE5vQ29ubmVjdGl2aXR5UGxhbnNFcnJvciA9ICdOb0Nvbm5lY3Rpdml0eVBsYW5zRXJyb3InLFxuICBOb0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvciA9ICdOb0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvcicsXG4gIE5vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvciA9ICdOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3InLFxuICBOb0RldmljZVByb2ZpbGVzRXJyb3IgPSAnTm9EZXZpY2VQcm9maWxlc0Vycm9yJyxcbiAgRGV2aWNlUHJvZmlsZXNGZXRjaEVycm9yID0gJ0RldmljZVByb2ZpbGVzRmV0Y2hFcnJvcicsXG4gIE5vRGV2aWNlUHJvdG9jb2xzRXJyb3IgPSAnTm9EZXZpY2VQcm90b2NvbHNFcnJvcicsXG4gIERldmljZVByb3RvY29sc0ZldGNoRXJyb3IgPSAnRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcicsXG4gIFJlZ2lzdHJhdGlvbkVycm9yID0gJ1JlZ2lzdHJhdGlvbkVycm9yJ1xufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEFjdGlsaXR5RGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgYmFzZVVybCA9ICcvc2VydmljZS9hY3RpbGl0eSc7XG4gIHByaXZhdGUgcmVnaXN0cmF0aW9uVXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L25ld0RldmljZVJlcXVlc3RgO1xuICBwcml2YXRlIGNvbm5lY3Rpdml0eVBsYW5zVXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L2Nvbm5lY3Rpdml0eVBsYW5zYDtcbiAgcHJpdmF0ZSBkZXZpY2VQcm9maWxlc1VybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfS9kZXZpY2VQcm9maWxlc2A7XG4gIHByaXZhdGUgaGVhZGVyczogb2JqZWN0ID0ge1xuICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgb3B0aW9uc1NlcnZpY2U6IE9wdGlvbnNTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBnZXRDb25uZWN0aW9ucygpIHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyc1xuICAgIH07XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5iYXNlVXJsfS9sbnMtY29ubmVjdGlvbmAsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICBhd2FpdCB0aGlzLnRocm93Tm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKTtcbiAgICB9XG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cbiAgLyoqXG4gICAqIEdldHMgY29ubmVjdGl2aXR5IHBsYW5zIGZyb20gTG9SYSBwbGF0Zm9ybS5cbiAgICogQHBhcmFtIGNvbm5lY3Rpb25OYW1lIFRoZSBuYW1lIG9mIGNvbm5lY3Rpb24gZm9yIHdoaWNoIGNvbm5lY3Rpdml0eSBwbGFucyB3aWxsIGJlIHJldHJpZXZlZFxuICAgKiBAcmV0dXJucyBUaGUgcmVzdWx0IGxpc3Qgd2l0aCBjb25uZWN0aXZpdHkgcGxhbnMsIG9yIHRocm93cyBhbiBlcnJvciB3aXRoIGV4Y2VwdGlvbi5cbiAgICovXG4gIGFzeW5jIGdldENvbm5lY3Rpdml0eVBsYW5zKGNvbm5lY3Rpb25OYW1lOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHRMaXN0PENvbm5lY3Rpdml0eVBsYW4+PiB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsXG4gICAgICBwYXJhbXM6IHtcbiAgICAgICAgYWN0aWxpdHlDb25uZWN0aW9uTmFtZTogY29ubmVjdGlvbk5hbWVcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godGhpcy5jb25uZWN0aXZpdHlQbGFuc1VybCwgb3B0aW9ucyk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy50aHJvd05vQ29ubmVjdGl2aXR5UGxhbnNFcnJvcigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKCF0aGlzLmhhc0F2YWlsYWJsZUNvbm5lY3Rpb25zKGRhdGEpKSB7XG4gICAgICAgICAgdGhpcy50aHJvd05vRnJlZVNsb3RzSW5Db25uZWN0aXZpdHlQbGFuc0Vycm9yKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy50aHJvd05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcigpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGRldmljZSBwcm9maWxlcyBmcm9tIExvUmEgcGxhdGZvcm0uXG4gICAqIEBwYXJhbSBjb25uZWN0aW9uTmFtZSBUaGUgbmFtZSBvZiBjb25uZWN0aW9uIGZvciB3aGljaCBkZXZpY2UgcHJvZmlsZXMgd2lsbCBiZSByZXRyaWV2ZWRcbiAgICogQHJldHVybnMgVGhlIHJlc3VsdCBsaXN0IHdpdGggZGV2aWNlIHByb2ZpbGVzLCBvciB0aHJvd3MgYW4gZXJyb3Igd2l0aCBleGNlcHRpb24uXG4gICAqL1xuICBhc3luYyBnZXREZXZpY2VQcm9maWxlcyhjb25uZWN0aW9uTmFtZTogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxEZXZpY2VQcm9maWxlPj4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLFxuICAgICAgcGFyYW1zOiB7XG4gICAgICAgIGFjdGlsaXR5Q29ubmVjdGlvbk5hbWU6IGNvbm5lY3Rpb25OYW1lXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKHRoaXMuZGV2aWNlUHJvZmlsZXNVcmwsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMudGhyb3dOb0RldmljZVByb2ZpbGVzRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aHJvd0RldmljZVByb2ZpbGVzRmV0Y2hFcnJvcigpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGRldmljZSBwcm90b2NvbHNcbiAgICovXG4gIGFzeW5jIGdldERldmljZVByb3RvY29scygpOiBQcm9taXNlPElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pj4ge1xuICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICBwYWdlU2l6ZTogMjAsXG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgIH07XG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICBfX2FuZDogW1xuICAgICAgICAgIHsgX19oYXM6ICdjOHlfSXNEZXZpY2VUeXBlJyB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IHsgX19pbjogWydjOHlfQWN0aWxpdHlEZXZpY2VUeXBlJywgJ2M4eV9Mb3JhRGV2aWNlVHlwZScsICdjOHlfTHB3YW5EZXZpY2VUeXBlJ10gfVxuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgIH07XG4gICAgY29uc3QgeyByZXMsIGRhdGEgfSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIGZpbHRlcnMpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMudGhyb3dOb0RldmljZVByb3RvY29sc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBkZXZpY2UgcmVnaXN0cmF0aW9uXG4gICAqL1xuICBhc3luYyByZWdpc3RlcihyZWdpc3RyYXRpb246IEFjdGlsaXR5RGV2aWNlUmVnaXN0cmF0aW9uKSB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVnaXN0cmF0aW9uKVxuICAgIH07XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh0aGlzLnJlZ2lzdHJhdGlvblVybCwgb3B0aW9ucyk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAxKSB7XG4gICAgICB0aGlzLnRocm93UmVnaXN0cmF0aW9uRXJyb3IoZGF0YSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cblxuICAvKipcbiAgICogY2hlY2tzIGlmIHVzZWQgY29ubmVjdGlvbnMgaXMgbGVzcyB0aGVuIGdyYW50ZWQgY29ubmVjdGlvbnNcbiAgICovXG4gIHByaXZhdGUgaGFzQXZhaWxhYmxlQ29ubmVjdGlvbnMoY29ubmVjdGl2aXR5UGxhbnMpIHtcbiAgICByZXR1cm4gc29tZShcbiAgICAgIGNvbm5lY3Rpdml0eVBsYW5zLFxuICAgICAgcGxhbiA9PiBwYXJzZUludChwbGFuLmdyYW50ZWRDb25uZWN0aW9ucywgMTApID4gcGFyc2VJbnQocGxhbi51c2VkQ29ubmVjdGlvbnMsIDEwKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHRocm93Tm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3I7XG5cbiAgICBpZiAoKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmlzQXZhaWxhYmxlKCdhZG1pbmlzdHJhdGlvbicpKS5kYXRhKSB7XG4gICAgICBlcnJvci5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgYENvdWxkIG5vdCBnZXQgY29ubmVjdGl2aXR5IHBsYW5zIGZyb20gdGhlIExvUmEgcGxhdGZvcm0uIFZlcmlmeSB0aGUgVGhpbmdQYXJrIGNyZWRlbnRpYWxzIGluIHRoZSBBZG1pbmlzdHJhdGlvbiBhcHAgdW5kZXIgPGEgaHJlZj1cInt7IGxpbmsgfX1cIj5TZXR0aW5nczwvYT4uYFxuICAgICAgICApLFxuICAgICAgICB7XG4gICAgICAgICAgbGluazogJy9hcHBzL2FkbWluaXN0cmF0aW9uL2luZGV4Lmh0bWwjL2Nvbm5lY3Rpdml0eVNldHRpbmdzL2FjdGlsaXR5X2xvcmFfcHJvdmlkZXJfc2V0dGluZ3MnXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgICAnQ291bGQgbm90IGdldCBjb25uZWN0aXZpdHkgcGxhbnMgZnJvbSB0aGUgTG9SYSBwbGF0Zm9ybS4gUGxlYXNlIGNvbnRhY3QgdGhlIGFkbWluaXN0cmF0b3IuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0Nvbm5lY3Rpdml0eVBsYW5zRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vQ29ubmVjdGl2aXR5UGxhbnNFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dChcbiAgICAgICdObyBjb25uZWN0aXZpdHkgcGxhbnMgZm91bmQuIE5ldyBjb25uZWN0aXZpdHkgcGxhbnMgbXVzdCBiZSBjcmVhdGVkIHZpYSB0aGUgTG9SYSBwbGF0Zm9ybS4nXG4gICAgKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvcigpIHtcbiAgICBjb25zdCBjb21wYW55TmFtZSA9IHRoaXMub3B0aW9uc1NlcnZpY2UuZ2V0KCdjb21wYW55TmFtZScsICdDdW11bG9jaXR5IElvVCcpO1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICBnZXR0ZXh0KFxuICAgICAgICBgTm8gY29ubmVjdGl2aXR5IHBsYW5zIHdpdGggZnJlZSBzbG90cyBhdmFpbGFibGUuIFBsZWFzZSBjb250YWN0IFRoaW5nUGFyayBvbiB0aGUgZGV2aWNlIHF1b3RhIGxpbWl0cyBmb3IgeW91ciBjb25uZWN0aXZpdHkgcGxhbnMgb3IgcmVtb3ZlIHVudXNlZCBkZXZpY2VzIGZyb20gVGhpbmdQYXJrIGFuZCByZXRyeSByZWdpc3RlcmluZyB0aGUgZGV2aWNlIGluIHRoZSB7e2NvbXBhbnlOYW1lfX0gcGxhdGZvcm0uYFxuICAgICAgKSxcbiAgICAgIHtcbiAgICAgICAgY29tcGFueU5hbWVcbiAgICAgIH1cbiAgICApO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd0RldmljZVByb2ZpbGVzRmV0Y2hFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuRGV2aWNlUHJvZmlsZXNGZXRjaEVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KCdDb3VsZCBub3QgbG9hZCBkZXZpY2UgcHJvZmlsZXMgZnJvbSB0aGUgTG9SYSBwbGF0Zm9ybS4nKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0RldmljZVByb2ZpbGVzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vRGV2aWNlUHJvZmlsZXNFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dChcbiAgICAgICdObyBkZXZpY2UgcHJvZmlsZXMgZm91bmQuIENyZWF0ZSBhIG5ldyBkZXZpY2UgcHJvZmlsZSB2aWEgdGhlIExvUmEgcGxhdGZvcm0uJ1xuICAgICk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93RGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dCgnQ291bGQgbm90IGxvYWQgZGV2aWNlIHByb3RvY29scy4nKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0RldmljZVByb3RvY29sc0Vycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0RldmljZVByb3RvY29sc0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgIGdldHRleHQoXG4gICAgICAgIGBObyBkZXZpY2UgcHJvdG9jb2xzIGNvbmZpZ3VyZWQuIENyZWF0ZSBhIExvUmEgZGV2aWNlIHByb3RvY29sIGluIDxhIGhyZWY9XCJ7eyBsaW5rIH19XCI+RGV2aWNlIHByb3RvY29sczwvYT4uYFxuICAgICAgKSxcbiAgICAgIHtcbiAgICAgICAgbGluazogJy9hcHBzL2RldmljZW1hbmFnZW1lbnQvIy9kZXZpY2Vwcm90b2NvbHMnXG4gICAgICB9XG4gICAgKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dSZWdpc3RyYXRpb25FcnJvcihkYXRhOiB7IG1lc3NhZ2U6IHN0cmluZyB9KSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLlJlZ2lzdHJhdGlvbkVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBkYXRhLm1lc3NhZ2U7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cbiJdfQ==