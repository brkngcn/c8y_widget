import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { DeviceRegistrationService, InventoryService } from '@c8y/client';
import { AppStateService, GainsightService, gettext } from '@c8y/ngx-components';
import { head } from 'lodash-es';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@c8y/client';
export class SensorPhoneService {
    constructor(ui, inventoryService, deviceRegistrationService, gainsightService) {
        this.ui = ui;
        this.inventoryService = inventoryService;
        this.deviceRegistrationService = deviceRegistrationService;
        this.gainsightService = gainsightService;
        this.HTTP_STATUS_CODE = {
            OK: 200,
            CREATED: 201
        };
        this.PHONE_GROUP_FRAGMENT = 'c8y_IsSensorPhoneGroup';
        this.PHONE_GROUP_NAME = gettext('Phones');
        this.ui.currentTenant.subscribe(data => {
            if (data) {
                this.domainName = data.domainName;
                this.tenantId = data.name;
            }
        });
    }
    getHost() {
        return this.domainName.substring(this.domainName.indexOf('.') + 1);
    }
    getTenantName() {
        return this.domainName.split('.')[0];
    }
    getTenantId() {
        return this.tenantId;
    }
    checkPhoneGroupExists() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data, res } = yield this.inventoryService.list({
                fragmentType: this.PHONE_GROUP_FRAGMENT
            });
            if (data && res && res.status === this.HTTP_STATUS_CODE.OK) {
                return head(data);
            }
            return null;
        });
    }
    addPhoneGroup() {
        return __awaiter(this, void 0, void 0, function* () {
            const group = yield this.checkPhoneGroupExists();
            if (group) {
                return group;
            }
            return yield this.createPhoneGroup();
        });
    }
    createPhoneGroup() {
        return __awaiter(this, void 0, void 0, function* () {
            const newPhoneGroup = {
                c8y_Global: {},
                c8y_IsDeviceGroup: {},
                type: 'c8y_DeviceGroup',
                name: this.PHONE_GROUP_NAME,
                [this.PHONE_GROUP_FRAGMENT]: {}
            };
            const { data, res } = yield this.inventoryService.create(newPhoneGroup);
            if (data && res && res.status === this.HTTP_STATUS_CODE.CREATED) {
                return data;
            }
            return null;
        });
    }
    generateRegistrationData(deviceId) {
        const res = 'c8y://' + this.getTenantName() + '.' + this.getHost() + '/?deviceId=' + deviceId;
        return res;
    }
    createPhoneRegistrationRequest(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const group = yield this.addPhoneGroup();
            const device = { id: deviceId, groupId: group.id };
            const { res } = yield this.deviceRegistrationService.create(device);
            if (res.status !== this.HTTP_STATUS_CODE.CREATED) {
                throw res;
            }
        });
    }
    acceptPhoneRegistrationRequest(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const { res } = yield this.deviceRegistrationService.accept(deviceId);
            if (res.status !== this.HTTP_STATUS_CODE.OK) {
                throw res;
            }
            this.gainsightService.triggerEvent('connectSmartphone:Success');
        });
    }
}
SensorPhoneService.ɵfac = function SensorPhoneService_Factory(t) { return new (t || SensorPhoneService)(ɵngcc0.ɵɵinject(ɵngcc1.AppStateService), ɵngcc0.ɵɵinject(ɵngcc2.InventoryService), ɵngcc0.ɵɵinject(ɵngcc2.DeviceRegistrationService), ɵngcc0.ɵɵinject(ɵngcc1.GainsightService)); };
SensorPhoneService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: SensorPhoneService, factory: SensorPhoneService.ɵfac });
SensorPhoneService.ctorParameters = () => [
    { type: AppStateService },
    { type: InventoryService },
    { type: DeviceRegistrationService },
    { type: GainsightService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(SensorPhoneService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.AppStateService }, { type: ɵngcc2.InventoryService }, { type: ɵngcc2.DeviceRegistrationService }, { type: ɵngcc1.GainsightService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vuc29yLXBob25lLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlbnNvci1waG9uZS9zZW5zb3ItcGhvbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7O0FBR2pDLE1BQU0sT0FBTyxrQkFBa0I7QUFDL0IsSUFTRSxZQUNVLEVBQW1CLEVBQ25CLGdCQUFrQyxFQUNsQyx5QkFBb0QsRUFDcEQsZ0JBQWtDO0FBQzNDLFFBSlMsT0FBRSxHQUFGLEVBQUUsQ0FBaUI7QUFBQyxRQUNwQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtBQUFDLFFBQ3JELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFDOUMsUUFkVyxxQkFBZ0IsR0FBRztBQUM5QixZQUFJLEVBQUUsRUFBRSxHQUFHO0FBQ1gsWUFBSSxPQUFPLEVBQUUsR0FBRztBQUNoQixTQUFHLENBQUM7QUFDSixRQUVVLHlCQUFvQixHQUFHLHdCQUF3QixDQUFDO0FBQzFELFFBQW1CLHFCQUFnQixHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN4RCxRQU9JLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUMzQyxZQUFNLElBQUksSUFBSSxFQUFFO0FBQ2hCLGdCQUFRLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztBQUMxQyxnQkFBUSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDbEMsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUFFLENBQUM7QUFDSCxJQUNFLE9BQU87QUFDVCxRQUFJLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDdkUsSUFBRSxDQUFDO0FBQ0gsSUFDRSxhQUFhO0FBQ2YsUUFBSSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pDLElBQUUsQ0FBQztBQUNILElBQ0UsV0FBVztBQUNiLFFBQUksT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQ3pCLElBQUUsQ0FBQztBQUNILElBQ1EscUJBQXFCO0FBQzdCO0FBQ0MsWUFERyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztBQUMzRCxnQkFBTSxZQUFZLEVBQUUsSUFBSSxDQUFDLG9CQUFvQjtBQUM3QyxhQUFLLENBQUMsQ0FBQztBQUNQLFlBQUksSUFBSSxJQUFJLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtBQUNoRSxnQkFBTSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4QixhQUFLO0FBQ0wsWUFBSSxPQUFPLElBQUksQ0FBQztBQUNoQixRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDUSxhQUFhO0FBQ3JCO0FBQ1EsWUFESixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0FBQ3JELFlBQUksSUFBSSxLQUFLLEVBQUU7QUFDZixnQkFBTSxPQUFPLEtBQUssQ0FBQztBQUNuQixhQUFLO0FBQ0wsWUFBSSxPQUFPLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7QUFDekMsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EsZ0JBQWdCO0FBQ3hCO0FBRVksWUFGUixNQUFNLGFBQWEsR0FBRztBQUMxQixnQkFBTSxVQUFVLEVBQUUsRUFBRTtBQUNwQixnQkFBTSxpQkFBaUIsRUFBRSxFQUFFO0FBQzNCLGdCQUFNLElBQUksRUFBRSxpQkFBaUI7QUFDN0IsZ0JBQU0sSUFBSSxFQUFFLElBQUksQ0FBQyxnQkFBZ0I7QUFDakMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsRUFBRSxFQUFFO0FBQ3JDLGFBQUssQ0FBQztBQUNOLFlBQ0ksTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDNUUsWUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFO0FBQ3JFLGdCQUFNLE9BQU8sSUFBSSxDQUFDO0FBQ2xCLGFBQUs7QUFDTCxZQUFJLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNFLHdCQUF3QixDQUFDLFFBQVE7QUFDbkMsUUFBSSxNQUFNLEdBQUcsR0FBRyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsYUFBYSxHQUFHLFFBQVEsQ0FBQztBQUNsRyxRQUFJLE9BQU8sR0FBRyxDQUFDO0FBQ2YsSUFBRSxDQUFDO0FBQ0gsSUFDUSw4QkFBOEIsQ0FBQyxRQUFRO0FBQy9DO0FBQ2dCLFlBRFosTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDN0MsWUFBSSxNQUFNLE1BQU0sR0FBRyxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUN2RCxZQUNJLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDeEUsWUFBSSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRTtBQUN0RCxnQkFBTSxNQUFNLEdBQUcsQ0FBQztBQUNoQixhQUFLO0FBQ0wsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EsOEJBQThCLENBQUMsUUFBUTtBQUMvQztBQUE4RCxZQUExRCxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFFLFlBQUksSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUU7QUFDakQsZ0JBQU0sTUFBTSxHQUFHLENBQUM7QUFDaEIsYUFBSztBQUNMLFlBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLFFBQUUsQ0FBQztBQUVILEtBRkc7QUFDSDs4Q0E3RkMsVUFBVTtvSUFDVDtBQUFDO0FBQ1UsWUFMSixlQUFlO0FBQUksWUFEUSxnQkFBZ0I7QUFBSSxZQUEvQyx5QkFBeUI7QUFBSSxZQUNaLGdCQUFnQjtBQUFHOzs7a01BQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UsIEludmVudG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UsIEdhaW5zaWdodFNlcnZpY2UsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGhlYWQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU2Vuc29yUGhvbmVTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgSFRUUF9TVEFUVVNfQ09ERSA9IHtcbiAgICBPSzogMjAwLFxuICAgIENSRUFURUQ6IDIwMVxuICB9O1xuICBwcml2YXRlIGRvbWFpbk5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSB0ZW5hbnRJZDogc3RyaW5nO1xuICBwcml2YXRlIFBIT05FX0dST1VQX0ZSQUdNRU5UID0gJ2M4eV9Jc1NlbnNvclBob25lR3JvdXAnO1xuICBwcml2YXRlIHJlYWRvbmx5IFBIT05FX0dST1VQX05BTUUgPSBnZXR0ZXh0KCdQaG9uZXMnKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHVpOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZTogRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGdhaW5zaWdodFNlcnZpY2U6IEdhaW5zaWdodFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy51aS5jdXJyZW50VGVuYW50LnN1YnNjcmliZShkYXRhID0+IHtcbiAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgIHRoaXMuZG9tYWluTmFtZSA9IGRhdGEuZG9tYWluTmFtZTtcbiAgICAgICAgdGhpcy50ZW5hbnRJZCA9IGRhdGEubmFtZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldEhvc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9tYWluTmFtZS5zdWJzdHJpbmcodGhpcy5kb21haW5OYW1lLmluZGV4T2YoJy4nKSArIDEpO1xuICB9XG5cbiAgZ2V0VGVuYW50TmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5kb21haW5OYW1lLnNwbGl0KCcuJylbMF07XG4gIH1cblxuICBnZXRUZW5hbnRJZCgpIHtcbiAgICByZXR1cm4gdGhpcy50ZW5hbnRJZDtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrUGhvbmVHcm91cEV4aXN0cygpIHtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3Qoe1xuICAgICAgZnJhZ21lbnRUeXBlOiB0aGlzLlBIT05FX0dST1VQX0ZSQUdNRU5UXG4gICAgfSk7XG4gICAgaWYgKGRhdGEgJiYgcmVzICYmIHJlcy5zdGF0dXMgPT09IHRoaXMuSFRUUF9TVEFUVVNfQ09ERS5PSykge1xuICAgICAgcmV0dXJuIGhlYWQoZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgYXN5bmMgYWRkUGhvbmVHcm91cCgpIHtcbiAgICBjb25zdCBncm91cCA9IGF3YWl0IHRoaXMuY2hlY2tQaG9uZUdyb3VwRXhpc3RzKCk7XG4gICAgaWYgKGdyb3VwKSB7XG4gICAgICByZXR1cm4gZ3JvdXA7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNyZWF0ZVBob25lR3JvdXAoKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVBob25lR3JvdXAoKSB7XG4gICAgY29uc3QgbmV3UGhvbmVHcm91cCA9IHtcbiAgICAgIGM4eV9HbG9iYWw6IHt9LFxuICAgICAgYzh5X0lzRGV2aWNlR3JvdXA6IHt9LFxuICAgICAgdHlwZTogJ2M4eV9EZXZpY2VHcm91cCcsXG4gICAgICBuYW1lOiB0aGlzLlBIT05FX0dST1VQX05BTUUsXG4gICAgICBbdGhpcy5QSE9ORV9HUk9VUF9GUkFHTUVOVF06IHt9XG4gICAgfTtcblxuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKG5ld1Bob25lR3JvdXApO1xuICAgIGlmIChkYXRhICYmIHJlcyAmJiByZXMuc3RhdHVzID09PSB0aGlzLkhUVFBfU1RBVFVTX0NPREUuQ1JFQVRFRCkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2VuZXJhdGVSZWdpc3RyYXRpb25EYXRhKGRldmljZUlkKSB7XG4gICAgY29uc3QgcmVzID0gJ2M4eTovLycgKyB0aGlzLmdldFRlbmFudE5hbWUoKSArICcuJyArIHRoaXMuZ2V0SG9zdCgpICsgJy8/ZGV2aWNlSWQ9JyArIGRldmljZUlkO1xuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBhc3luYyBjcmVhdGVQaG9uZVJlZ2lzdHJhdGlvblJlcXVlc3QoZGV2aWNlSWQpIHtcbiAgICBjb25zdCBncm91cCA9IGF3YWl0IHRoaXMuYWRkUGhvbmVHcm91cCgpO1xuICAgIGNvbnN0IGRldmljZSA9IHsgaWQ6IGRldmljZUlkLCBncm91cElkOiBncm91cC5pZCB9O1xuXG4gICAgY29uc3QgeyByZXMgfSA9IGF3YWl0IHRoaXMuZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZS5jcmVhdGUoZGV2aWNlKTtcbiAgICBpZiAocmVzLnN0YXR1cyAhPT0gdGhpcy5IVFRQX1NUQVRVU19DT0RFLkNSRUFURUQpIHtcbiAgICAgIHRocm93IHJlcztcbiAgICB9XG4gIH1cblxuICBhc3luYyBhY2NlcHRQaG9uZVJlZ2lzdHJhdGlvblJlcXVlc3QoZGV2aWNlSWQpIHtcbiAgICBjb25zdCB7IHJlcyB9ID0gYXdhaXQgdGhpcy5kZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLmFjY2VwdChkZXZpY2VJZCk7XG4gICAgaWYgKHJlcy5zdGF0dXMgIT09IHRoaXMuSFRUUF9TVEFUVVNfQ09ERS5PSykge1xuICAgICAgdGhyb3cgcmVzO1xuICAgIH1cbiAgICB0aGlzLmdhaW5zaWdodFNlcnZpY2UudHJpZ2dlckV2ZW50KCdjb25uZWN0U21hcnRwaG9uZTpTdWNjZXNzJyk7XG4gIH1cbn1cbiJdfQ==