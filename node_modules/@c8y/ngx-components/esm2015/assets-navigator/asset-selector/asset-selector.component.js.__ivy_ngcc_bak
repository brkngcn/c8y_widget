import { __awaiter } from "tslib";
import { Component, EventEmitter, Input, Output, forwardRef, ChangeDetectorRef } from '@angular/core';
import { NG_VALIDATORS, NG_VALUE_ACCESSOR } from '@angular/forms';
import { InventoryService } from '@c8y/client';
import { GroupNodeService } from './group-node.service';
import { AssetSelectorService } from './asset-selector.service';
import { CONFIG_OPTIONS_DEFAULT } from './asset-selector.model';
import { UnassignedDevicesNode } from './unassigned-devices-node';
import { AssetSelectorBase } from './asset-selector-base';
import { Subject } from 'rxjs';
/**
 * Displays a hierarchical tree selector for assets.
 */
export class AssetSelectorComponent extends AssetSelectorBase {
    /**
     * @ignore only DI
     */
    constructor(groupNodeService, inventory, assetSelectorService, cd) {
        super(groupNodeService, inventory, assetSelectorService);
        this.groupNodeService = groupNodeService;
        this.inventory = inventory;
        this.assetSelectorService = assetSelectorService;
        this.cd = cd;
        /**
         * Config object containing all options for the asset selector.
         */
        this.config = {};
        /**
         * Used only for miller-view, displays the column level for the current node.
         * E.g if the index is one, this will be second column.
         */
        this.index = 0;
        /**
         * The asset to use as root.
         */
        this.asset = undefined;
        /**
         * The selected device.
         */
        this.selectedDevice = undefined;
        /**
         * An array of predefined nodes.
         */
        this.selected = [];
        /**
         * All currently selected assets.
         */
        this.selectedItems = [];
        this.container = 'body';
        /**
         * Emits if one item was selected (all currently selected nodes).
         */
        this.onSelected = new EventEmitter();
        /**
         * Used only for miller view. Emit the selected node and use it as a 'rootNode' for the new column.
         */
        this.onRowSelected = new EventEmitter();
        /**
         * Emits the current loading state of the node.
         */
        this.onLoad = new EventEmitter();
        /**
         * The current filter applied.
         */
        this.filterText = '';
        /**
         * Displays the global search at all times if the miller view is used
         * on root group level.
         */
        this.root = false;
        /**
         * @ignore
         */
        this.unsubscribe$ = new Subject();
    }
    /**
     * Checks when a node was selected, if a new column needs to be added.
     * @param node The node that was clicked.
     * @param index The current index of this node.
     * @returns True if the click was handled and a new column was added.
     */
    handleNextMillerViewColumn(node, index) {
        const nodeCopy = Object.create(node);
        const isSameAsRoot = this.rootNode === node;
        const isUnassignedDevicesNode = node.toString() === UnassignedDevicesNode.NAME;
        const isNewColumnNeeded = !isSameAsRoot && (node.isGroup() || isUnassignedDevicesNode || node.hasChildDevices());
        if (isNewColumnNeeded) {
            this.onRowSelected.emit({ nodeCopy, index });
            return false;
        }
        return true;
    }
    /**
     * @ignore
     */
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.index === 0) {
                this.config = Object.assign(Object.assign({}, CONFIG_OPTIONS_DEFAULT), this.config);
            }
            const shouldResetNameFilter = this.rootNode && this.rootNode.mo && this.config.view === 'miller';
            if (shouldResetNameFilter) {
                this.applyFilter('');
            }
            const isOnlyAssetNodeDefined = this.asset;
            if (isOnlyAssetNodeDefined) {
                this.rootNode = yield this.createManagedObjectRootNode(this.asset);
            }
            const isAnyNodeDefined = !this.rootNode && (!this.asset || Object.keys(this.asset).length === 0);
            if (isAnyNodeDefined) {
                this.rootNode = this.createDefaultRootNode();
            }
            if (this.config.showUnassignedDevices &&
                (!this.asset || Object.keys(this.asset).length === 0) &&
                this.rootNode.root) {
                this.rootNode.add(new UnassignedDevicesNode(this.groupNodeService, {
                    showChildDevices: this.config.showChildDevices
                }));
            }
            this.root = this.rootNode.root;
        });
    }
    ngOnChanges(changes) {
        return __awaiter(this, void 0, void 0, function* () {
            if (changes.asset &&
                changes.asset.currentValue &&
                Object.keys(changes.asset.currentValue).length !== 0) {
                this.rootNode = yield this.createManagedObjectRootNode(changes.asset.currentValue);
            }
        });
    }
    /**
     * Changes the current root to one level back.
     */
    back() {
        const index = this.index - 1;
        const nodeCopy = Object.create(this.rootNode.parents[0]);
        this.onRowSelected.emit({ nodeCopy, index });
    }
    /**
     * Clears the current filter.
     */
    clearFilters() {
        this.filterText = '';
        this.applyFilter('');
    }
    clearSelectedDevices() {
        this.selectedDevice = undefined;
        this.applyFilter('');
    }
    isGroupSelected() {
        if (this.selectedItems.some(selectedNode => { var _a; return selectedNode.id === ((_a = this.rootNode.mo) === null || _a === void 0 ? void 0 : _a.id); })) {
            return true;
        }
        return false;
    }
    groupNameFilter(nameFilter, moId, showUnassignedDevices) {
        if (nameFilter) {
            const filterByName = showUnassignedDevices
                ? {
                    __filter: {
                        name: nameFilter
                    },
                    __orderby: [{ name: 1 }]
                }
                : {
                    __filter: {
                        name: nameFilter,
                        __bygroupid: moId
                    }
                };
            return this.assetSelectorService.queriesUtil.buildQuery(filterByName);
        }
        const defaultFilter = {
            __filter: {
                __bygroupid: moId
            },
            __orderby: [{ name: 1 }]
        };
        return this.assetSelectorService.queriesUtil.buildQuery(defaultFilter);
    }
    /**
     * Applies a filter.
     * @param filter The filter to apply.
     */
    applyFilter(filter) {
        return __awaiter(this, void 0, void 0, function* () {
            this.rootNode.filterQuery$.next(this.groupNameFilter(filter, this.rootNode.mo.id, this.isUnassignedDevicesNode() ? true : false));
            this.rootNode.refresh();
            this.onLoad.emit({
                loading: true,
                filterText: this.filterText,
                index: this.index,
                selectedDevice: this.selectedDevice
            });
            this.cd.detectChanges();
        });
    }
    /**
     * Check if the UnassignedDevice node is the rootNode.
     */
    isUnassignedDevicesNode() {
        return this.rootNode.toString() === UnassignedDevicesNode.NAME;
    }
    /**
     * Called when the user resets the search result.
     */
    onSearchResultReset(term) {
        if (term) {
            this.deselectAll();
            this.rootNode = this.createDefaultRootNode();
            if (this.config.showUnassignedDevices) {
                this.rootNode.add(new UnassignedDevicesNode(this.groupNodeService, {
                    showChildDevices: this.config.showChildDevices
                }));
            }
            if (this.config.view === 'miller') {
                this.onRowSelected.emit({ root: true });
            }
            this.rootNode.click({ open: true });
            if (this.config.view === 'tree') {
                this.rootNode.open = true;
            }
        }
    }
    /**
     * Called if the user clicks on a search result.
     */
    onSearchResultClick(mo) {
        return __awaiter(this, void 0, void 0, function* () {
            const canSelectNode = this.config.groupsSelectable || !this.groupNodeService.isGroup(mo);
            this.rootNode = yield this.createManagedObjectRootNode(mo);
            this.rootNode.click({ open: true });
            if (this.config.view === 'miller') {
                const nodeCopy = Object.create(this.rootNode);
                this.onRowSelected.emit({
                    nodeCopy,
                    index: 0,
                    selectedDevices: this.selectedDevice,
                    root: true
                });
            }
            this.deselectAll();
            if (canSelectNode) {
                this.select(this.rootNode.mo);
            }
        });
    }
}
AssetSelectorComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-asset-selector',
                template: "<div\n  class=\"p-b-8 bg-inherit\"\n  [ngClass]=\"{ 'p-l-16 p-absolute p-r-16': config.view === 'miller' }\"\n  style=\"left: 0; right: 4px\"\n  [ngStyle]=\"{ 'z-index': config.singleColumn ? '30' : '20' }\"\n  *ngIf=\"!selectedDevice && index === 0 && (config.search || config.singleColumn)\"\n>\n  <p class=\"text-medium m-b-4 p-t-8\">\n    {{ config.label | translate }}\n  </p>\n  <c8y-search-input\n    *ngIf=\"config.search && root\"\n    (onClick)=\"onSearchResultClick($event)\"\n    (reset)=\"onSearchResultReset($event)\"\n    [mode]=\"'select'\"\n    [container]=\"container\"\n  ></c8y-search-input>\n</div>\n\n<div *ngIf=\"selectedDevice\" class=\"p-r-16\">\n  <div class=\"d-flex p-b-4\">\n    <p *ngIf=\"selectedDevice; else multiAssets\" class=\"text-medium p-t-8 m-r-8\">\n      {{ 'Selected asset' | translate }}\n    </p>\n    <ng-template #multiAssets>\n      <p class=\"text-medium m-r-8\">{{ 'Selected assets' | translate }}</p>\n    </ng-template>\n    <button\n      class=\"btn btn-default btn-xs a-s-center m-t-4 m-l-auto\"\n      (click)=\"clearSelectedDevices()\"\n      title=\"{{ 'Edit' | translate }}\"\n    >\n      {{ 'Change' | translate }}\n    </button>\n  </div>\n  <div class=\"d-flex\">\n    <i [c8yIcon]=\"'check-circle'\" class=\"text-success p-l-0 p-r-8\"></i>\n    <i\n      c8yIcon=\"{{ selectedDevice.type === 'c8y_DeviceGroup' ? 'c8y-group' : 'exchange' }}\"\n      class=\"m-r-4 icon-20\"\n    ></i>\n    <span>{{ selectedDevice.name }}</span>\n  </div>\n</div>\n\n<!-- miller columns header -->\n<div\n  *ngIf=\"\n    config.view === 'miller' &&\n    ((config.showFilter && !rootNode.root) || config.columnHeaders || config.singleColumn) &&\n    !selectedDevice\n  \"\n  class=\"miller-column__header sticky-top bg-inherit separator-top-bottom\"\n  [ngClass]=\"{ 'm-t-72 ': config.search, 'm-t-32': !config.search && config.singleColumn }\"\n  [ngStyle]=\"{ top: config.search && !config.singleColumn ? '72px' : '0' }\"\n>\n  <p\n    class=\"text-12 text-muted text-truncate m-b-4\"\n    *ngIf=\"config.singleColumn && index !== 0\"\n    title=\"{{ rootNode.breadcrumb || rootNode.label | translate }}\"\n  >\n    <i c8yIcon=\"home\" class=\"m-r-4\"></i>\n    {{ rootNode.breadcrumb || rootNode.label | translate }}\n  </p>\n  <div *ngIf=\"config.columnHeaders || config.singleColumn\" class=\"d-flex a-i-center p-b-4\">\n    <button\n      class=\"btn btn-default btn-xs m-r-8 p-t-0 p-b-0 p-l-4 p-r-4 l-h-1\"\n      *ngIf=\"config.singleColumn && !rootNode.root && index !== 0\"\n      title=\"{{ 'Back' | translate }}\"\n      (click)=\"back()\"\n    >\n      <i c8yIcon=\"angle-left\"></i>\n    </button>\n    <label\n      *ngIf=\"!rootNode.root && index === 0 && (config.groupsSelectable || !rootNode.isGroup())\"\n      class=\"c8y-radio checkbox-inline m-r-8\"\n    >\n      <input\n        type=\"radio\"\n        (change)=\"select(rootNode.mo)\"\n        [checked]=\"isGroupSelected()\"\n        title=\"{{ 'Select group' | translate }}\"\n      /><span></span>\n    </label>\n\n    <p\n      class=\"text-truncate\"\n      title=\"{{ rootNode.label | translate }}\"\n      *ngIf=\"config.columnHeaders\"\n      [ngClass]=\"{\n        'text-label-small': !config.singleColumn,\n        'text-medium': config.singleColumn\n      }\"\n    >\n      <i\n        *ngIf=\"config.singleColumn || (!rootNode.root && index === 0)\"\n        c8yIcon=\"c8y-group-open\"\n        class=\"icon-20 c8y-icon-duocolor m-r-4\"\n      ></i>\n      {{ rootNode.label | translate }}\n    </p>\n  </div>\n\n  <div *ngIf=\"!rootNode.root && config.showFilter\" [ngClass]=\"{ 'p-t-4': config.columnHeaders }\">\n    <div class=\"input-group input-group-sm input-group-search\">\n      <input\n        [(ngModel)]=\"filterText\"\n        placeholder=\"{{ 'Filter this column\u2026' | translate }}\"\n        class=\"form-control\"\n        (keyup.enter)=\"applyFilter('*' + filterText + '*')\"\n      />\n      <span class=\"input-group-btn\">\n        <button\n          title=\"{{ 'Apply filter' | translate }}\"\n          class=\"btn btn-clean p-r-8 p-l-4\"\n          (click)=\"applyFilter('*' + filterText + '*')\"\n        >\n          <i c8yIcon=\"filter\"></i>\n        </button>\n        <button\n          title=\" {{ 'Clear filters' | translate }}\"\n          class=\"btn btn-clean p-r-8 p-l-4\"\n          (click)=\"clearFilters()\"\n          *ngIf=\"filterText.length\"\n        >\n          <i c8yIcon=\"times\"></i>\n        </button>\n      </span>\n    </div>\n  </div>\n</div>\n\n<c8y-asset-selector-node\n  *ngIf=\"rootNode && !selectedDevice\"\n  [node]=\"rootNode\"\n  [preselected]=\"selected\"\n  [multi]=\"config.multi\"\n  [view]=\"config.view\"\n  [index]=\"index\"\n  [selectedItems]=\"selectedItems\"\n  [active]=\"active\"\n  class=\"d-block bg-inherit p-relative\"\n  [ngClass]=\"{ 'collapse show': !rootNode.root && !rootNode.hidden && config.view !== 'miller' }\"\n  style=\"z-index: 9\"\n></c8y-asset-selector-node>\n",
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        multi: true,
                        useExisting: forwardRef(() => AssetSelectorComponent)
                    },
                    {
                        provide: NG_VALIDATORS,
                        useExisting: forwardRef(() => AssetSelectorComponent),
                        multi: true
                    }
                ]
            },] }
];
AssetSelectorComponent.ctorParameters = () => [
    { type: GroupNodeService },
    { type: InventoryService },
    { type: AssetSelectorService },
    { type: ChangeDetectorRef }
];
AssetSelectorComponent.propDecorators = {
    config: [{ type: Input }],
    active: [{ type: Input }],
    index: [{ type: Input }],
    asset: [{ type: Input }],
    selectedDevice: [{ type: Input }],
    selected: [{ type: Input }],
    rootNode: [{ type: Input }],
    selectedItems: [{ type: Input }],
    container: [{ type: Input }],
    onSelected: [{ type: Output }],
    onRowSelected: [{ type: Output }],
    onLoad: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtc2VsZWN0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vYXNzZXRzLW5hdmlnYXRvci9hc3NldC1zZWxlY3Rvci9hc3NldC1zZWxlY3Rvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sVUFBVSxFQUNWLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUErQixnQkFBZ0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVoRSxPQUFPLEVBR0wsc0JBQXNCLEVBQ3ZCLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQjs7R0FFRztBQWlCSCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsaUJBQWlCO0lBOEQzRDs7T0FFRztJQUNILFlBQ1ksZ0JBQWtDLEVBQ2xDLFNBQTJCLEVBQzNCLG9CQUEwQyxFQUMxQyxFQUFxQjtRQUUvQixLQUFLLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFML0MscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFD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SUFBSSxFQUFFLElBQUk7aUJBQ1gsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbkIsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUMvQjtRQUNILENBQUM7S0FBQTs7O1lBOVJGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsb0JBQW9CO2dCQUM5QixzNEpBQThDO2dCQUM5QyxTQUFTLEVBQUU7b0JBQ1Q7d0JBQ0UsT0FBTyxFQUFFLGlCQUFpQjt3QkFDMUIsS0FBSyxFQUFFLElBQUk7d0JBQ1gsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQztxQkFDdEQ7b0JBQ0Q7d0JBQ0UsT0FBTyxFQUFFLGFBQWE7d0JBQ3RCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsc0JBQXNCLENBQUM7d0JBQ3JELEtBQUssRUFBRSxJQUFJO3FCQUNaO2lCQUNGO2FBQ0Y7OztZQTlCUSxnQkFBZ0I7WUFEYSxnQkFBZ0I7WUFFN0Msb0JBQW9CO1lBTDNCLGlCQUFpQjs7O3FCQXVDaEIsS0FBSztxQkFJTCxLQUFLO29CQUtMLEtBQUs7b0JBSUwsS0FBSzs2QkFJTCxLQUFLO3VCQUlMLEtBQUs7dUJBSUwsS0FBSzs0QkFJTCxLQUFLO3dCQUNMLEtBQUs7eUJBSUwsTUFBTTs0QkFLTixNQUFNO3FCQUlOLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBmb3J3YXJkUmVmLFxuICBDaGFuZ2VEZXRlY3RvclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTElEQVRPUlMsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgSUlkZW50aWZpZWQsIElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgR3JvdXBOb2RlU2VydmljZSB9IGZyb20gJy4vZ3JvdXAtbm9kZS5zZXJ2aWNlJztcbmltcG9ydCB7IEFzc2V0U2VsZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi9hc3NldC1zZWxlY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IEdyb3VwTm9kZSB9IGZyb20gJy4vZ3JvdXAtbm9kZSc7XG5pbXBvcnQge1xuICBBc3NldFNlbGVjdGlvbkNoYW5nZUV2ZW50LFxuICBBc3NldFNlbGVjdG9yT3B0aW9ucyxcbiAgQ09ORklHX09QVElPTlNfREVGQVVMVFxufSBmcm9tICcuL2Fzc2V0LXNlbGVjdG9yLm1vZGVsJztcbmltcG9ydCB7IFVuYXNzaWduZWREZXZpY2VzTm9kZSB9IGZyb20gJy4vdW5hc3NpZ25lZC1kZXZpY2VzLW5vZGUnO1xuaW1wb3J0IHsgQXNzZXRTZWxlY3RvckJhc2UgfSBmcm9tICcuL2Fzc2V0LXNlbGVjdG9yLWJhc2UnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG4vKipcbiAqIERpc3BsYXlzIGEgaGllcmFyY2hpY2FsIHRyZWUgc2VsZWN0b3IgZm9yIGFzc2V0cy5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFzc2V0LXNlbGVjdG9yJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Fzc2V0LXNlbGVjdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEFzc2V0U2VsZWN0b3JDb21wb25lbnQpXG4gICAgfSxcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxJREFUT1JTLFxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gQXNzZXRTZWxlY3RvckNvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZVxuICAgIH1cbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBBc3NldFNlbGVjdG9yQ29tcG9uZW50IGV4dGVuZHMgQXNzZXRTZWxlY3RvckJhc2UgaW1wbGVtZW50cyBPbkluaXQge1xuICAvKipcbiAgICogQ29uZmlnIG9iamVjdCBjb250YWluaW5nIGFsbCBvcHRpb25zIGZvciB0aGUgYXNzZXQgc2VsZWN0b3IuXG4gICAqL1xuICBASW5wdXQoKSBjb25maWc6IEFzc2V0U2VsZWN0b3JPcHRpb25zID0ge307XG4gIC8qKlxuICAgKiBEZWZpbmVzIHRoZSBub2RlLCB3aGljaCBzaG91bGQgYmUgZGlzcGxheWVkIGFzIGFjdGl2ZS5cbiAgICovXG4gIEBJbnB1dCgpIGFjdGl2ZTogR3JvdXBOb2RlO1xuICAvKipcbiAgICogVXNlZCBvbmx5IGZvciBtaWxsZXItdmlldywgZGlzcGxheXMgdGhlIGNvbHVtbiBsZXZlbCBmb3IgdGhlIGN1cnJlbnQgbm9kZS5cbiAgICogRS5nIGlmIHRoZSBpbmRleCBpcyBvbmUsIHRoaXMgd2lsbCBiZSBzZWNvbmQgY29sdW1uLlxuICAgKi9cbiAgQElucHV0KCkgaW5kZXg6IG51bWJlciA9IDA7XG4gIC8qKlxuICAgKiBUaGUgYXNzZXQgdG8gdXNlIGFzIHJvb3QuXG4gICAqL1xuICBASW5wdXQoKSBhc3NldDogSUlkZW50aWZpZWQgPSB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBUaGUgc2VsZWN0ZWQgZGV2aWNlLlxuICAgKi9cbiAgQElucHV0KCkgc2VsZWN0ZWREZXZpY2U6IElNYW5hZ2VkT2JqZWN0ID0gdW5kZWZpbmVkO1xuICAvKipcbiAgICogQW4gYXJyYXkgb2YgcHJlZGVmaW5lZCBub2Rlcy5cbiAgICovXG4gIEBJbnB1dCgpIHNlbGVjdGVkOiBBcnJheTxQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0Pj4gfCBJSWRlbnRpZmllZFtdIHwgSUlkZW50aWZpZWQgPSBbXTtcbiAgLyoqXG4gICAqIFRoZSBub2RlIHRvIHVzZSBhcyByb290LiBZb3UgY2FuIGVpdGhlciBzZXQgdGhpcywgb3IgdGhlIGFzc2V0IHRvIHN0YXJ0IGZyb20uXG4gICAqL1xuICBASW5wdXQoKSByb290Tm9kZTogR3JvdXBOb2RlO1xuICAvKipcbiAgICogQWxsIGN1cnJlbnRseSBzZWxlY3RlZCBhc3NldHMuXG4gICAqL1xuICBASW5wdXQoKSBzZWxlY3RlZEl0ZW1zOiBJSWRlbnRpZmllZFtdIHwgSUlkZW50aWZpZWQgPSBbXTtcbiAgQElucHV0KCkgY29udGFpbmVyOiAnJyB8ICdib2R5JyA9ICdib2R5JztcbiAgLyoqXG4gICAqIEVtaXRzIGlmIG9uZSBpdGVtIHdhcyBzZWxlY3RlZCAoYWxsIGN1cnJlbnRseSBzZWxlY3RlZCBub2RlcykuXG4gICAqL1xuICBAT3V0cHV0KCkgb25TZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXI8QXNzZXRTZWxlY3Rpb25DaGFuZ2VFdmVudD4oKTtcblxuICAvKipcbiAgICogVXNlZCBvbmx5IGZvciBtaWxsZXIgdmlldy4gRW1pdCB0aGUgc2VsZWN0ZWQgbm9kZSBhbmQgdXNlIGl0IGFzIGEgJ3Jvb3ROb2RlJyBmb3IgdGhlIG5ldyBjb2x1bW4uXG4gICAqL1xuICBAT3V0cHV0KCkgb25Sb3dTZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICAvKipcbiAgICogRW1pdHMgdGhlIGN1cnJlbnQgbG9hZGluZyBzdGF0ZSBvZiB0aGUgbm9kZS5cbiAgICovXG4gIEBPdXRwdXQoKSBvbkxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgLyoqXG4gICAqIFRoZSBjdXJyZW50IGZpbHRlciBhcHBsaWVkLlxuICAgKi9cbiAgZmlsdGVyVGV4dCA9ICcnO1xuICAvKipcbiAgICogRGlzcGxheXMgdGhlIGdsb2JhbCBzZWFyY2ggYXQgYWxsIHRpbWVzIGlmIHRoZSBtaWxsZXIgdmlldyBpcyB1c2VkXG4gICAqIG9uIHJvb3QgZ3JvdXAgbGV2ZWwuXG4gICAqL1xuICByb290OiBib29sZWFuID0gZmFsc2U7XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICB1bnN1YnNjcmliZSQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgLyoqXG4gICAqIEBpZ25vcmUgb25seSBESVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGdyb3VwTm9kZVNlcnZpY2U6IEdyb3VwTm9kZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgYXNzZXRTZWxlY3RvclNlcnZpY2U6IEFzc2V0U2VsZWN0b3JTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjZDogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7XG4gICAgc3VwZXIoZ3JvdXBOb2RlU2VydmljZSwgaW52ZW50b3J5LCBhc3NldFNlbGVjdG9yU2VydmljZSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIHdoZW4gYSBub2RlIHdhcyBzZWxlY3RlZCwgaWYgYSBuZXcgY29sdW1uIG5lZWRzIHRvIGJlIGFkZGVkLlxuICAgKiBAcGFyYW0gbm9kZSBUaGUgbm9kZSB0aGF0IHdhcyBjbGlja2VkLlxuICAgKiBAcGFyYW0gaW5kZXggVGhlIGN1cnJlbnQgaW5kZXggb2YgdGhpcyBub2RlLlxuICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBjbGljayB3YXMgaGFuZGxlZCBhbmQgYSBuZXcgY29sdW1uIHdhcyBhZGRlZC5cbiAgICovXG4gIGhhbmRsZU5leHRNaWxsZXJWaWV3Q29sdW1uKG5vZGU6IEdyb3VwTm9kZSwgaW5kZXg6IG51bWJlcikge1xuICAgIGNvbnN0IG5vZGVDb3B5ID0gT2JqZWN0LmNyZWF0ZShub2RlKTtcbiAgICBjb25zdCBpc1NhbWVBc1Jvb3QgPSB0aGlzLnJvb3ROb2RlID09PSBub2RlO1xuICAgIGNvbnN0IGlzVW5hc3NpZ25lZERldmljZXNOb2RlID0gbm9kZS50b1N0cmluZygpID09PSBVbmFzc2lnbmVkRGV2aWNlc05vZGUuTkFNRTtcbiAgICBjb25zdCBpc05ld0NvbHVtbk5lZWRlZCA9XG4gICAgICAhaXNTYW1lQXNSb290ICYmIChub2RlLmlzR3JvdXAoKSB8fCBpc1VuYXNzaWduZWREZXZpY2VzTm9kZSB8fCBub2RlLmhhc0NoaWxkRGV2aWNlcygpKTtcblxuICAgIGlmIChpc05ld0NvbHVtbk5lZWRlZCkge1xuICAgICAgdGhpcy5vblJvd1NlbGVjdGVkLmVtaXQoeyBub2RlQ29weSwgaW5kZXggfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLmluZGV4ID09PSAwKSB7XG4gICAgICB0aGlzLmNvbmZpZyA9IHsgLi4uQ09ORklHX09QVElPTlNfREVGQVVMVCwgLi4udGhpcy5jb25maWcgfTtcbiAgICB9XG4gICAgY29uc3Qgc2hvdWxkUmVzZXROYW1lRmlsdGVyID1cbiAgICAgIHRoaXMucm9vdE5vZGUgJiYgdGhpcy5yb290Tm9kZS5tbyAmJiB0aGlzLmNvbmZpZy52aWV3ID09PSAnbWlsbGVyJztcbiAgICBpZiAoc2hvdWxkUmVzZXROYW1lRmlsdGVyKSB7XG4gICAgICB0aGlzLmFwcGx5RmlsdGVyKCcnKTtcbiAgICB9XG5cbiAgICBjb25zdCBpc09ubHlBc3NldE5vZGVEZWZpbmVkID0gdGhpcy5hc3NldDtcbiAgICBpZiAoaXNPbmx5QXNzZXROb2RlRGVmaW5lZCkge1xuICAgICAgdGhpcy5yb290Tm9kZSA9IGF3YWl0IHRoaXMuY3JlYXRlTWFuYWdlZE9iamVjdFJvb3ROb2RlKHRoaXMuYXNzZXQpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzQW55Tm9kZURlZmluZWQgPVxuICAgICAgIXRoaXMucm9vdE5vZGUgJiYgKCF0aGlzLmFzc2V0IHx8IE9iamVjdC5rZXlzKHRoaXMuYXNzZXQpLmxlbmd0aCA9PT0gMCk7XG4gICAgaWYgKGlzQW55Tm9kZURlZmluZWQpIHtcbiAgICAgIHRoaXMucm9vdE5vZGUgPSB0aGlzLmNyZWF0ZURlZmF1bHRSb290Tm9kZSgpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuY29uZmlnLnNob3dVbmFzc2lnbmVkRGV2aWNlcyAmJlxuICAgICAgKCF0aGlzLmFzc2V0IHx8IE9iamVjdC5rZXlzKHRoaXMuYXNzZXQpLmxlbmd0aCA9PT0gMCkgJiZcbiAgICAgIHRoaXMucm9vdE5vZGUucm9vdFxuICAgICkge1xuICAgICAgdGhpcy5yb290Tm9kZS5hZGQoXG4gICAgICAgIG5ldyBVbmFzc2lnbmVkRGV2aWNlc05vZGUodGhpcy5ncm91cE5vZGVTZXJ2aWNlLCB7XG4gICAgICAgICAgc2hvd0NoaWxkRGV2aWNlczogdGhpcy5jb25maWcuc2hvd0NoaWxkRGV2aWNlc1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5yb290ID0gdGhpcy5yb290Tm9kZS5yb290O1xuICB9XG5cbiAgYXN5bmMgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChcbiAgICAgIGNoYW5nZXMuYXNzZXQgJiZcbiAgICAgIGNoYW5nZXMuYXNzZXQuY3VycmVudFZhbHVlICYmXG4gICAgICBPYmplY3Qua2V5cyhjaGFuZ2VzLmFzc2V0LmN1cnJlbnRWYWx1ZSkubGVuZ3RoICE9PSAwXG4gICAgKSB7XG4gICAgICB0aGlzLnJvb3ROb2RlID0gYXdhaXQgdGhpcy5jcmVhdGVNYW5hZ2VkT2JqZWN0Um9vdE5vZGUoY2hhbmdlcy5hc3NldC5jdXJyZW50VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGFuZ2VzIHRoZSBjdXJyZW50IHJvb3QgdG8gb25lIGxldmVsIGJhY2suXG4gICAqL1xuICBiYWNrKCkge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5pbmRleCAtIDE7XG4gICAgY29uc3Qgbm9kZUNvcHkgPSBPYmplY3QuY3JlYXRlKHRoaXMucm9vdE5vZGUucGFyZW50c1swXSk7XG4gICAgdGhpcy5vblJvd1NlbGVjdGVkLmVtaXQoeyBub2RlQ29weSwgaW5kZXggfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIHRoZSBjdXJyZW50IGZpbHRlci5cbiAgICovXG4gIGNsZWFyRmlsdGVycygpIHtcbiAgICB0aGlzLmZpbHRlclRleHQgPSAnJztcbiAgICB0aGlzLmFwcGx5RmlsdGVyKCcnKTtcbiAgfVxuXG4gIGNsZWFyU2VsZWN0ZWREZXZpY2VzKCkge1xuICAgIHRoaXMuc2VsZWN0ZWREZXZpY2UgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5hcHBseUZpbHRlcignJyk7XG4gIH1cblxuICBpc0dyb3VwU2VsZWN0ZWQoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRJdGVtcy5zb21lKHNlbGVjdGVkTm9kZSA9PiBzZWxlY3RlZE5vZGUuaWQgPT09IHRoaXMucm9vdE5vZGUubW8/LmlkKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGdyb3VwTmFtZUZpbHRlcihuYW1lRmlsdGVyOiBzdHJpbmcsIG1vSWQsIHNob3dVbmFzc2lnbmVkRGV2aWNlcz86IGJvb2xlYW4pIHtcbiAgICBpZiAobmFtZUZpbHRlcikge1xuICAgICAgY29uc3QgZmlsdGVyQnlOYW1lID0gc2hvd1VuYXNzaWduZWREZXZpY2VzXG4gICAgICAgID8ge1xuICAgICAgICAgICAgX19maWx0ZXI6IHtcbiAgICAgICAgICAgICAgbmFtZTogbmFtZUZpbHRlclxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgICAgICAgIH1cbiAgICAgICAgOiB7XG4gICAgICAgICAgICBfX2ZpbHRlcjoge1xuICAgICAgICAgICAgICBuYW1lOiBuYW1lRmlsdGVyLFxuICAgICAgICAgICAgICBfX2J5Z3JvdXBpZDogbW9JZFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH07XG4gICAgICByZXR1cm4gdGhpcy5hc3NldFNlbGVjdG9yU2VydmljZS5xdWVyaWVzVXRpbC5idWlsZFF1ZXJ5KGZpbHRlckJ5TmFtZSk7XG4gICAgfVxuICAgIGNvbnN0IGRlZmF1bHRGaWx0ZXIgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICBfX2J5Z3JvdXBpZDogbW9JZFxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuYXNzZXRTZWxlY3RvclNlcnZpY2UucXVlcmllc1V0aWwuYnVpbGRRdWVyeShkZWZhdWx0RmlsdGVyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBsaWVzIGEgZmlsdGVyLlxuICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBmaWx0ZXIgdG8gYXBwbHkuXG4gICAqL1xuICBhc3luYyBhcHBseUZpbHRlcihmaWx0ZXI6IHN0cmluZykge1xuICAgIHRoaXMucm9vdE5vZGUuZmlsdGVyUXVlcnkkLm5leHQoXG4gICAgICB0aGlzLmdyb3VwTmFtZUZpbHRlcihcbiAgICAgICAgZmlsdGVyLFxuICAgICAgICB0aGlzLnJvb3ROb2RlLm1vLmlkLFxuICAgICAgICB0aGlzLmlzVW5hc3NpZ25lZERldmljZXNOb2RlKCkgPyB0cnVlIDogZmFsc2VcbiAgICAgIClcbiAgICApO1xuICAgIHRoaXMucm9vdE5vZGUucmVmcmVzaCgpO1xuICAgIHRoaXMub25Mb2FkLmVtaXQoe1xuICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgIGZpbHRlclRleHQ6IHRoaXMuZmlsdGVyVGV4dCxcbiAgICAgIGluZGV4OiB0aGlzLmluZGV4LFxuICAgICAgc2VsZWN0ZWREZXZpY2U6IHRoaXMuc2VsZWN0ZWREZXZpY2VcbiAgICB9KTtcbiAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGUgVW5hc3NpZ25lZERldmljZSBub2RlIGlzIHRoZSByb290Tm9kZS5cbiAgICovXG4gIGlzVW5hc3NpZ25lZERldmljZXNOb2RlKCkge1xuICAgIHJldHVybiB0aGlzLnJvb3ROb2RlLnRvU3RyaW5nKCkgPT09IFVuYXNzaWduZWREZXZpY2VzTm9kZS5OQU1FO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxlZCB3aGVuIHRoZSB1c2VyIHJlc2V0cyB0aGUgc2VhcmNoIHJlc3VsdC5cbiAgICovXG4gIG9uU2VhcmNoUmVzdWx0UmVzZXQodGVybTogc3RyaW5nKSB7XG4gICAgaWYgKHRlcm0pIHtcbiAgICAgIHRoaXMuZGVzZWxlY3RBbGwoKTtcbiAgICAgIHRoaXMucm9vdE5vZGUgPSB0aGlzLmNyZWF0ZURlZmF1bHRSb290Tm9kZSgpO1xuICAgICAgaWYgKHRoaXMuY29uZmlnLnNob3dVbmFzc2lnbmVkRGV2aWNlcykge1xuICAgICAgICB0aGlzLnJvb3ROb2RlLmFkZChcbiAgICAgICAgICBuZXcgVW5hc3NpZ25lZERldmljZXNOb2RlKHRoaXMuZ3JvdXBOb2RlU2VydmljZSwge1xuICAgICAgICAgICAgc2hvd0NoaWxkRGV2aWNlczogdGhpcy5jb25maWcuc2hvd0NoaWxkRGV2aWNlc1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5jb25maWcudmlldyA9PT0gJ21pbGxlcicpIHtcbiAgICAgICAgdGhpcy5vblJvd1NlbGVjdGVkLmVtaXQoeyByb290OiB0cnVlIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy5yb290Tm9kZS5jbGljayh7IG9wZW46IHRydWUgfSk7XG4gICAgICBpZiAodGhpcy5jb25maWcudmlldyA9PT0gJ3RyZWUnKSB7XG4gICAgICAgIHRoaXMucm9vdE5vZGUub3BlbiA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhbGxlZCBpZiB0aGUgdXNlciBjbGlja3Mgb24gYSBzZWFyY2ggcmVzdWx0LlxuICAgKi9cbiAgYXN5bmMgb25TZWFyY2hSZXN1bHRDbGljayhtbzogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBjYW5TZWxlY3ROb2RlID0gdGhpcy5jb25maWcuZ3JvdXBzU2VsZWN0YWJsZSB8fCAhdGhpcy5ncm91cE5vZGVTZXJ2aWNlLmlzR3JvdXAobW8pO1xuICAgIHRoaXMucm9vdE5vZGUgPSBhd2FpdCB0aGlzLmNyZWF0ZU1hbmFnZWRPYmplY3RSb290Tm9kZShtbyk7XG4gICAgdGhpcy5yb290Tm9kZS5jbGljayh7IG9wZW46IHRydWUgfSk7XG4gICAgaWYgKHRoaXMuY29uZmlnLnZpZXcgPT09ICdtaWxsZXInKSB7XG4gICAgICBjb25zdCBub2RlQ29weSA9IE9iamVjdC5jcmVhdGUodGhpcy5yb290Tm9kZSk7XG4gICAgICB0aGlzLm9uUm93U2VsZWN0ZWQuZW1pdCh7XG4gICAgICAgIG5vZGVDb3B5LFxuICAgICAgICBpbmRleDogMCxcbiAgICAgICAgc2VsZWN0ZWREZXZpY2VzOiB0aGlzLnNlbGVjdGVkRGV2aWNlLFxuICAgICAgICByb290OiB0cnVlXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5kZXNlbGVjdEFsbCgpO1xuICAgIGlmIChjYW5TZWxlY3ROb2RlKSB7XG4gICAgICB0aGlzLnNlbGVjdCh0aGlzLnJvb3ROb2RlLm1vKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==