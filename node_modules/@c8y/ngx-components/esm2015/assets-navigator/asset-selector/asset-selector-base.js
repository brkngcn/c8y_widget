import { __awaiter } from "tslib";
import { EventEmitter } from '@angular/core';
export class AssetSelectorBase {
    constructor(groupNodeService, inventory, assetSelectorService) {
        this.groupNodeService = groupNodeService;
        this.inventory = inventory;
        this.assetSelectorService = assetSelectorService;
        /**
         * Config object containing all options for the asset selector.
         */
        this.config = {};
        /**
         * The loading state of the current node.
         */
        this.isLoading = false;
        /**
         * Emit the selected asset or assets.
         */
        this.onSelected = new EventEmitter();
    }
    /**
     * @ignore
     */
    validate(control) {
        if (this.config.required && (!control.value || control.value.length === 0)) {
            return { required: true };
        }
        return null;
    }
    /**
     * @ignore
     */
    writeValue(obj) {
        this.selected = this.assetSelectorService.normalizeValue(obj, this.config.modelMode);
    }
    /**
     * @ignore
     */
    registerOnChange(fn) {
        this.onChange = fn;
    }
    /**
     * @ignore
     */
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    /**
     * @ignore
     */
    doBlur() {
        if (this.onTouched) {
            this.onTouched();
        }
    }
    /**
     * Deselects all expect the given one.
     * @param selectedMo The selected asset (optional, if empty -> just deselect all).
     */
    deselectAll(selectedMo) {
        this.selected = [];
        if (selectedMo) {
            this.selected = [this.assetSelectorService.simplifyModel(selectedMo, this.config.modelMode)];
        }
        this.emitChange(this.selected, selectedMo, !!selectedMo);
        this.doBlur();
    }
    /**
     * Adds an managed object to the selected array and emits the change.
     * @param selectedMo The selected asset.
     */
    select(selectedMo) {
        if (!this.config.multi) {
            this.selected = [];
        }
        const index = this.getIndexOfSelected(this.selected, selectedMo);
        if (index === -1) {
            this.selected.push(this.assetSelectorService.simplifyModel(selectedMo, this.config.modelMode));
        }
        this.emitChange(this.selected, selectedMo, true);
        this.doBlur();
    }
    /**
     * Removes a managed object from the selected array and emits the change.
     * @param selectedMo The selected asset.
     */
    deselect(selectedMo) {
        const index = this.getIndexOfSelected(this.selected, selectedMo);
        if (index > -1) {
            this.selected.splice(index, 1);
        }
        this.emitChange(this.selected, selectedMo, false);
        this.doBlur();
    }
    /**
     * Returns the index of the currently selected item.
     * @param selected All selected items
     * @param selectedMo The new selected item-
     * @returns An index, or -1 if not found.
     */
    getIndexOfSelected(selected, selectedMo) {
        return selected.findIndex(mo => mo.id === selectedMo.id);
    }
    emitChange(selected, item, isSelected) {
        const changes = this.config.multi ? selected : selected[0];
        if (this.onChange) {
            this.onChange(changes);
        }
        this.onSelected.emit({ items: changes, change: { item, isSelected } });
    }
    createDefaultRootNode() {
        return this.groupNodeService.createGroupNode({
            root: true,
            groupsSelectable: this.config.groupsSelectable,
            groupsOnly: this.config.groupsOnly,
            showChildDevices: this.config.showChildDevices
        });
    }
    createManagedObjectRootNode(asset) {
        return __awaiter(this, void 0, void 0, function* () {
            if (asset.id) {
                return this.groupNodeService.createGroupNode({
                    mo: asset,
                    groupsSelectable: this.config.groupsSelectable,
                    groupsOnly: this.config.groupsOnly,
                    showChildDevices: this.config.showChildDevices
                });
            }
            const { data: mo } = yield this.inventory.detail(asset);
            return this.groupNodeService.createGroupNode({
                mo,
                groupsSelectable: this.config.groupsSelectable,
                groupsOnly: this.config.groupsOnly,
                showChildDevices: this.config.showChildDevices
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtc2VsZWN0b3ItYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2Fzc2V0cy1uYXZpZ2F0b3IvYXNzZXQtc2VsZWN0b3IvYXNzZXQtc2VsZWN0b3ItYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQU83QyxNQUFNLE9BQU8saUJBQWlCO0lBcUI1QixZQUNZLGdCQUFrQyxFQUNsQyxTQUEyQixFQUMzQixvQkFBMEM7UUFGMUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBdkJ0RDs7V0FFRztRQUNILFdBQU0sR0FBeUIsRUFBRSxDQUFDO1FBS2xDOztXQUVHO1FBQ0gsY0FBUyxHQUFZLEtBQUssQ0FBQztRQUMzQjs7V0FFRztRQUNILGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztJQVN4RCxDQUFDO0lBRUo7O09BRUc7SUFDSCxRQUFRLENBQUMsT0FBd0I7UUFDL0IsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsRUFBRTtZQUMxRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO1NBQzNCO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsR0FBUTtRQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdkYsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCLENBQUMsRUFB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OlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCwgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBHcm91cE5vZGVTZXJ2aWNlIH0gZnJvbSAnLi9ncm91cC1ub2RlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXNzZXRTZWxlY3RvclNlcnZpY2UgfSBmcm9tICcuL2Fzc2V0LXNlbGVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXNzZXRTZWxlY3Rpb25DaGFuZ2VFdmVudCwgQXNzZXRTZWxlY3Rvck9wdGlvbnMgfSBmcm9tICcuL2Fzc2V0LXNlbGVjdG9yLm1vZGVsJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuZXhwb3J0IGNsYXNzIEFzc2V0U2VsZWN0b3JCYXNlIHtcbiAgLyoqXG4gICAqIENvbmZpZyBvYmplY3QgY29udGFpbmluZyBhbGwgb3B0aW9ucyBmb3IgdGhlIGFzc2V0IHNlbGVjdG9yLlxuICAgKi9cbiAgY29uZmlnOiBBc3NldFNlbGVjdG9yT3B0aW9ucyA9IHt9O1xuICAvKipcbiAgICogQW4gYXJyYXkgb2YgcHJlZGVmaW5lZCBub2Rlcy5cbiAgICovXG4gIHNlbGVjdGVkOiBBcnJheTxQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0Pj4gfCBJSWRlbnRpZmllZFtdIHwgSUlkZW50aWZpZWQ7XG4gIC8qKlxuICAgKiBUaGUgbG9hZGluZyBzdGF0ZSBvZiB0aGUgY3VycmVudCBub2RlLlxuICAgKi9cbiAgaXNMb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIC8qKlxuICAgKiBFbWl0IHRoZSBzZWxlY3RlZCBhc3NldCBvciBhc3NldHMuXG4gICAqL1xuICBvblNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxBc3NldFNlbGVjdGlvbkNoYW5nZUV2ZW50PigpO1xuXG4gIHByaXZhdGUgb25DaGFuZ2U6IChtbzogSUlkZW50aWZpZWRbXSB8IElJZGVudGlmaWVkKSA9PiB2b2lkO1xuICBwcml2YXRlIG9uVG91Y2hlZDogKCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgZ3JvdXBOb2RlU2VydmljZTogR3JvdXBOb2RlU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaW52ZW50b3J5OiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBhc3NldFNlbGVjdG9yU2VydmljZTogQXNzZXRTZWxlY3RvclNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICB2YWxpZGF0ZShjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHtcbiAgICBpZiAodGhpcy5jb25maWcucmVxdWlyZWQgJiYgKCFjb250cm9sLnZhbHVlIHx8IGNvbnRyb2wudmFsdWUubGVuZ3RoID09PSAwKSkge1xuICAgICAgcmV0dXJuIHsgcmVxdWlyZWQ6IHRydWUgfTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgd3JpdGVWYWx1ZShvYmo6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuc2VsZWN0ZWQgPSB0aGlzLmFzc2V0U2VsZWN0b3JTZXJ2aWNlLm5vcm1hbGl6ZVZhbHVlKG9iaiwgdGhpcy5jb25maWcubW9kZWxNb2RlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46IGFueSk6IHZvaWQge1xuICAgIHRoaXMub25Ub3VjaGVkID0gZm47XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZG9CbHVyKCkge1xuICAgIGlmICh0aGlzLm9uVG91Y2hlZCkge1xuICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVzZWxlY3RzIGFsbCBleHBlY3QgdGhlIGdpdmVuIG9uZS5cbiAgICogQHBhcmFtIHNlbGVjdGVkTW8gVGhlIHNlbGVjdGVkIGFzc2V0IChvcHRpb25hbCwgaWYgZW1wdHkgLT4ganVzdCBkZXNlbGVjdCBhbGwpLlxuICAgKi9cbiAgZGVzZWxlY3RBbGwoc2VsZWN0ZWRNbz86IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgdGhpcy5zZWxlY3RlZCA9IFtdO1xuICAgIGlmIChzZWxlY3RlZE1vKSB7XG4gICAgICB0aGlzLnNlbGVjdGVkID0gW3RoaXMuYXNzZXRTZWxlY3RvclNlcnZpY2Uuc2ltcGxpZnlNb2RlbChzZWxlY3RlZE1vLCB0aGlzLmNvbmZpZy5tb2RlbE1vZGUpXTtcbiAgICB9XG4gICAgdGhpcy5lbWl0Q2hhbmdlKHRoaXMuc2VsZWN0ZWQsIHNlbGVjdGVkTW8sICEhc2VsZWN0ZWRNbyk7XG4gICAgdGhpcy5kb0JsdXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFuIG1hbmFnZWQgb2JqZWN0IHRvIHRoZSBzZWxlY3RlZCBhcnJheSBhbmQgZW1pdHMgdGhlIGNoYW5nZS5cbiAgICogQHBhcmFtIHNlbGVjdGVkTW8gVGhlIHNlbGVjdGVkIGFzc2V0LlxuICAgKi9cbiAgc2VsZWN0KHNlbGVjdGVkTW86IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5tdWx0aSkge1xuICAgICAgdGhpcy5zZWxlY3RlZCA9IFtdO1xuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0SW5kZXhPZlNlbGVjdGVkKHRoaXMuc2VsZWN0ZWQsIHNlbGVjdGVkTW8pO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWQucHVzaChcbiAgICAgICAgdGhpcy5hc3NldFNlbGVjdG9yU2VydmljZS5zaW1wbGlmeU1vZGVsKHNlbGVjdGVkTW8sIHRoaXMuY29uZmlnLm1vZGVsTW9kZSlcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuZW1pdENoYW5nZSh0aGlzLnNlbGVjdGVkLCBzZWxlY3RlZE1vLCB0cnVlKTtcbiAgICB0aGlzLmRvQmx1cigpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYSBtYW5hZ2VkIG9iamVjdCBmcm9tIHRoZSBzZWxlY3RlZCBhcnJheSBhbmQgZW1pdHMgdGhlIGNoYW5nZS5cbiAgICogQHBhcmFtIHNlbGVjdGVkTW8gVGhlIHNlbGVjdGVkIGFzc2V0LlxuICAgKi9cbiAgZGVzZWxlY3Qoc2VsZWN0ZWRNbzogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0SW5kZXhPZlNlbGVjdGVkKHRoaXMuc2VsZWN0ZWQsIHNlbGVjdGVkTW8pO1xuICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICB0aGlzLnNlbGVjdGVkLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICAgIHRoaXMuZW1pdENoYW5nZSh0aGlzLnNlbGVjdGVkLCBzZWxlY3RlZE1vLCBmYWxzZSk7XG4gICAgdGhpcy5kb0JsdXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgY3VycmVudGx5IHNlbGVjdGVkIGl0ZW0uXG4gICAqIEBwYXJhbSBzZWxlY3RlZCBBbGwgc2VsZWN0ZWQgaXRlbXNcbiAgICogQHBhcmFtIHNlbGVjdGVkTW8gVGhlIG5ldyBzZWxlY3RlZCBpdGVtLVxuICAgKiBAcmV0dXJucyBBbiBpbmRleCwgb3IgLTEgaWYgbm90IGZvdW5kLlxuICAgKi9cbiAgZ2V0SW5kZXhPZlNlbGVjdGVkKFxuICAgIHNlbGVjdGVkOiBBcnJheTxQYXJ0aWFsPElJZGVudGlmaWVkPj4gfCBQYXJ0aWFsPElJZGVudGlmaWVkPixcbiAgICBzZWxlY3RlZE1vOiBJSWRlbnRpZmllZFxuICApIHtcbiAgICByZXR1cm4gc2VsZWN0ZWQuZmluZEluZGV4KG1vID0+IG1vLmlkID09PSBzZWxlY3RlZE1vLmlkKTtcbiAgfVxuXG4gIGVtaXRDaGFuZ2Uoc2VsZWN0ZWQ6IElJZGVudGlmaWVkIHwgSUlkZW50aWZpZWRbXSwgaXRlbTogSU1hbmFnZWRPYmplY3QsIGlzU2VsZWN0ZWQ6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5jb25maWcubXVsdGkgPyBzZWxlY3RlZCA6IHNlbGVjdGVkWzBdO1xuICAgIGlmICh0aGlzLm9uQ2hhbmdlKSB7XG4gICAgICB0aGlzLm9uQ2hhbmdlKGNoYW5nZXMpO1xuICAgIH1cbiAgICB0aGlzLm9uU2VsZWN0ZWQuZW1pdCh7IGl0ZW1zOiBjaGFuZ2VzLCBjaGFuZ2U6IHsgaXRlbSwgaXNTZWxlY3RlZCB9IH0pO1xuICB9XG5cbiAgY3JlYXRlRGVmYXVsdFJvb3ROb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmdyb3VwTm9kZVNlcnZpY2UuY3JlYXRlR3JvdXBOb2RlKHtcbiAgICAgIHJvb3Q6IHRydWUsXG4gICAgICBncm91cHNTZWxlY3RhYmxlOiB0aGlzLmNvbmZpZy5ncm91cHNTZWxlY3RhYmxlLFxuICAgICAgZ3JvdXBzT25seTogdGhpcy5jb25maWcuZ3JvdXBzT25seSxcbiAgICAgIHNob3dDaGlsZERldmljZXM6IHRoaXMuY29uZmlnLnNob3dDaGlsZERldmljZXNcbiAgICB9KTtcbiAgfVxuICBhc3luYyBjcmVhdGVNYW5hZ2VkT2JqZWN0Um9vdE5vZGUoYXNzZXQ6IElJZGVudGlmaWVkKSB7XG4gICAgaWYgKChhc3NldCBhcyBJSWRlbnRpZmllZCkuaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdyb3VwTm9kZVNlcnZpY2UuY3JlYXRlR3JvdXBOb2RlKHtcbiAgICAgICAgbW86IGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0LFxuICAgICAgICBncm91cHNTZWxlY3RhYmxlOiB0aGlzLmNvbmZpZy5ncm91cHNTZWxlY3RhYmxlLFxuICAgICAgICBncm91cHNPbmx5OiB0aGlzLmNvbmZpZy5ncm91cHNPbmx5LFxuICAgICAgICBzaG93Q2hpbGREZXZpY2VzOiB0aGlzLmNvbmZpZy5zaG93Q2hpbGREZXZpY2VzXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBkYXRhOiBtbyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkuZGV0YWlsKGFzc2V0KTtcbiAgICByZXR1cm4gdGhpcy5ncm91cE5vZGVTZXJ2aWNlLmNyZWF0ZUdyb3VwTm9kZSh7XG4gICAgICBtbyxcbiAgICAgIGdyb3Vwc1NlbGVjdGFibGU6IHRoaXMuY29uZmlnLmdyb3Vwc1NlbGVjdGFibGUsXG4gICAgICBncm91cHNPbmx5OiB0aGlzLmNvbmZpZy5ncm91cHNPbmx5LFxuICAgICAgc2hvd0NoaWxkRGV2aWNlczogdGhpcy5jb25maWcuc2hvd0NoaWxkRGV2aWNlc1xuICAgIH0pO1xuICB9XG59XG4iXX0=