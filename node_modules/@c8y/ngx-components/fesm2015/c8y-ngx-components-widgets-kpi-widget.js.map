{"version":3,"file":"c8y-ngx-components-widgets-kpi-widget.js","sources":["../../widgets/kpi-widget/kpi-widget-config/kpi-widget-config.component.ts","../../widgets/kpi-widget/kpi-widget-view/kpi-widget-view.component.ts","../../widgets/kpi-widget/kpi-widget.module.ts","../../widgets/kpi-widget/c8y-ngx-components-widgets-kpi-widget.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, Input, OnInit } from '@angular/core';\nimport {\n  AbstractControl,\n  ControlContainer,\n  FormBuilder,\n  FormGroup,\n  NgForm,\n  ValidationErrors,\n  ValidatorFn,\n  Validators\n} from '@angular/forms';\nimport { OnBeforeSave } from '@c8y/ngx-components';\nimport { WidgetConfigComponent } from '@c8y/ngx-components/context-dashboard';\nimport {\n  DatapointAttributesFormConfig,\n  DatapointLibraryService,\n  DatapointSelectorModalOptions,\n  KPIDetails\n} from '@c8y/ngx-components/datapoint-selector';\nimport { IconSelectorService } from '@c8y/ngx-components/icon-selector';\nimport { Observable } from 'rxjs';\nimport { KpiWidgetConfig } from '../kpi-widget.model';\n\nexport function exactlyASingleDatapointActive(): ValidatorFn {\n  return (control: AbstractControl): ValidationErrors | null => {\n    const datapoints: KPIDetails[] = control.value;\n\n    if (!datapoints || !datapoints.length) {\n      return null;\n    }\n\n    const activeDatapoints = datapoints.filter(datapoint => datapoint.__active);\n\n    if (activeDatapoints.length === 1) {\n      return null;\n    }\n\n    return { exactlyOneDatapointNeedsToBeActive: true };\n  };\n}\n\n@Component({\n  selector: 'c8y-kpi-widget-config',\n  templateUrl: './kpi-widget-config.component.html',\n  viewProviders: [{ provide: ControlContainer, useExisting: NgForm }]\n})\nexport class KpiWidgetConfigComponent implements OnInit, OnBeforeSave {\n  @Input() config: KpiWidgetConfig;\n  datapointSelectionConfig: Partial<DatapointSelectorModalOptions> = {};\n  defaultFormOptions: Partial<DatapointAttributesFormConfig> = {\n    showRedRange: true,\n    showYellowRange: true\n  };\n  formGroup: FormGroup;\n  availableIcons: string[] = [];\n  limits = {\n    fontSizeMax: 72,\n    fontSizeMin: 18,\n    numberOfDecimalPlacesMax: 10,\n    numberOfDecimalPlacesMin: 0\n  };\n\n  constructor(\n    private formBuilder: FormBuilder,\n    private form: NgForm,\n    private iconSelector: IconSelectorService,\n    private widgetConfig: WidgetConfigComponent,\n    private datapointLibrary: DatapointLibraryService\n  ) {}\n\n  onBeforeSave(config?: KpiWidgetConfig): boolean | Promise<boolean> | Observable<boolean> {\n    if (this.formGroup.valid) {\n      Object.assign(config, this.formGroup.value);\n      return true;\n    }\n    return false;\n  }\n\n  async ngOnInit() {\n    if (this.widgetConfig.context?.id) {\n      this.datapointSelectionConfig.contextAsset = this.widgetConfig?.context;\n    }\n    this.initForm();\n    if (this.config?.datapoints) {\n      this.config.datapoints = await this.datapointLibrary.updateDatapoints(\n        this.config?.datapoints\n      );\n      this.formGroup.patchValue({ datapoints: this.config.datapoints });\n    }\n  }\n\n  async openIconSelector() {\n    try {\n      const icon = await this.iconSelector.selectIcon({\n        currentSelection: this.formGroup.value.icon\n      });\n      this.formGroup.patchValue({ icon });\n    } catch {\n      // nothing to do\n    }\n  }\n\n  private initForm(): void {\n    this.formGroup = this.formBuilder.group({\n      numberOfDecimalPlaces: [\n        1,\n        [\n          Validators.required,\n          Validators.min(this.limits.numberOfDecimalPlacesMin),\n          Validators.max(this.limits.numberOfDecimalPlacesMax)\n        ]\n      ],\n      showTimestamp: [true, []],\n      showTrend: [true, []],\n      showIcon: [true, []],\n      icon: ['water', [Validators.required, Validators.minLength(1)]],\n      fontSize: [\n        36,\n        [\n          Validators.required,\n          Validators.min(this.limits.fontSizeMin),\n          Validators.max(this.limits.fontSizeMax)\n        ]\n      ],\n      datapoints: [\n        [],\n        [Validators.required, Validators.minLength(1), exactlyASingleDatapointActive()]\n      ]\n    });\n    this.form.form.addControl('config', this.formGroup);\n    this.formGroup.patchValue(this.config);\n  }\n}\n","import { Component, Input, OnInit, Optional } from '@angular/core';\nimport { MeasurementRealtimeService } from '@c8y/ngx-components';\nimport { DatapointLibraryService, KPIDetails } from '@c8y/ngx-components/datapoint-selector';\nimport { combineLatest, from, NEVER, Observable } from 'rxjs';\nimport { distinctUntilChanged, filter, map, pairwise, startWith, tap } from 'rxjs/operators';\nimport { ContextDashboardComponent } from '@c8y/ngx-components/context-dashboard';\nimport { KpiWidgetConfig } from '../kpi-widget.model';\n\ninterface MeasurementValue {\n  unit?: string;\n  value: number;\n  date: string;\n}\n\nenum ColorClass {\n  danger = 'text-danger',\n  warning = 'text-warning',\n  unknown = ''\n}\n\n@Component({\n  selector: 'c8y-kpi-widget-view',\n  templateUrl: './kpi-widget-view.component.html',\n  providers: [MeasurementRealtimeService]\n})\nexport class KpiWidgetViewComponent implements OnInit {\n  @Input() config: KpiWidgetConfig = { datapoints: [] };\n  state$: Observable<{\n    latestMeasurement: MeasurementValue;\n    previousValue: MeasurementValue;\n    trend: string;\n    unit: string;\n    colorClass: ColorClass;\n  }> = NEVER;\n\n  // used to differentiate between loading state and empty state\n  noDataInitiallyInDB = false;\n\n  constructor(\n    private measurementRealtime: MeasurementRealtimeService,\n    private datapointLib: DatapointLibraryService,\n    @Optional() private dashboard: ContextDashboardComponent\n  ) {}\n\n  async ngOnInit() {\n    const datapoints = this.config.datapoints || [];\n    const datapoint: KPIDetails = datapoints.find(tmp => tmp.__active);\n    if (!datapoint) {\n      return;\n    }\n\n    this.state$ = this.setupObservable(datapoint);\n  }\n\n  setupObservable(datapoint: KPIDetails): Observable<{\n    latestMeasurement: MeasurementValue;\n    previousValue: any;\n    trend: string;\n    unit: string;\n    colorClass: ColorClass;\n  }> {\n    this.assignContextFromContextDashboard(datapoint);\n    const latestMeasurement$ = this.getLatestMeasurement$(datapoint);\n    const lastTwoValues$ = this.getLastTwoValuesOfObservable$(latestMeasurement$);\n\n    const previousValue$ = lastTwoValues$.pipe(\n      map(res => res[0]),\n      startWith(undefined as any)\n    );\n\n    const datapointUpdate$ = this.getDatapointLibraryEntry$(datapoint);\n\n    const combineMeasurementAndDatapointLibEntry$ = combineLatest([\n      latestMeasurement$,\n      datapointUpdate$\n    ]);\n\n    const unit$ = combineMeasurementAndDatapointLibEntry$.pipe(\n      map(\n        ([latestMeasurementValue, currentDatapoint]) =>\n          currentDatapoint.unit || latestMeasurementValue.unit || ''\n      ),\n      startWith(''),\n      distinctUntilChanged()\n    );\n\n    return combineLatest([\n      latestMeasurement$,\n      previousValue$,\n      this.getTrendOfLatestMeasurements$(lastTwoValues$),\n      unit$,\n      this.getColorClass$(combineMeasurementAndDatapointLibEntry$)\n    ]).pipe(\n      map(([latestMeasurement, previousValue, trend, unit, colorClass]) => {\n        return {\n          latestMeasurement,\n          previousValue,\n          trend,\n          unit,\n          colorClass\n        };\n      })\n    );\n  }\n\n  private getLatestMeasurement$(datapoint: KPIDetails): Observable<MeasurementValue> {\n    return this.measurementRealtime\n      .latestValueOfSpecificMeasurement$(\n        datapoint.fragment,\n        datapoint.series,\n        datapoint.__target,\n        // we only need the last two values in case we want to show a trend\n        this.config.showTrend ? 2 : 1,\n        // null will be emitted in case no measurement was found initially\n        true\n      )\n      .pipe(\n        tap(measurement => {\n          if (!measurement) {\n            this.noDataInitiallyInDB = true;\n          }\n        }),\n        filter(measurement => !!measurement),\n        map(measurement => {\n          return {\n            unit: measurement[datapoint.fragment][datapoint.series].unit,\n            value: measurement[datapoint.fragment][datapoint.series].value,\n            date: measurement.time as string\n          };\n        })\n      );\n  }\n\n  private getDatapointLibraryEntry$(datapoint: KPIDetails): Observable<KPIDetails> {\n    return from(this.datapointLib.updateDatapoints([datapoint], true)).pipe(\n      map(tmp => tmp[0]),\n      filter(tmp => !!tmp),\n      startWith(datapoint)\n    );\n  }\n\n  private getColorClass$(\n    measurementAndDatapointCombination$: Observable<[MeasurementValue, KPIDetails]>\n  ): Observable<ColorClass> {\n    return measurementAndDatapointCombination$.pipe(\n      map(([latestMeasurementValue, currentDatapoint]) => {\n        if (\n          this.inRangeOf(\n            currentDatapoint,\n            latestMeasurementValue.value,\n            'redRangeMin',\n            'redRangeMax'\n          )\n        ) {\n          return ColorClass.danger;\n        }\n\n        if (\n          this.inRangeOf(\n            currentDatapoint,\n            latestMeasurementValue.value,\n            'yellowRangeMin',\n            'yellowRangeMax'\n          )\n        ) {\n          return ColorClass.warning;\n        }\n\n        return ColorClass.unknown;\n      }),\n      startWith(ColorClass.unknown),\n      distinctUntilChanged()\n    );\n  }\n\n  private getLastTwoValuesOfObservable$<T>(input$: Observable<T>): Observable<T[]> {\n    return input$.pipe(pairwise());\n  }\n\n  private getTrendOfLatestMeasurements$(latestMeasurement$: Observable<MeasurementValue[]>) {\n    return latestMeasurement$.pipe(\n      map(res => {\n        if (res.length === 2) {\n          const oldValue = res[0].value;\n          const newValue = res[1].value;\n          if (oldValue < newValue) {\n            return '45deg';\n          }\n          if (oldValue > newValue) {\n            return '135deg';\n          }\n        }\n        return '90deg';\n      }),\n      startWith('90deg'),\n      distinctUntilChanged()\n    );\n  }\n\n  private inRangeOf(\n    datapoint: KPIDetails,\n    measurementValue: number,\n    minAttribute: string,\n    maxAttribute: string\n  ): boolean {\n    if (\n      typeof datapoint[minAttribute] === 'number' &&\n      typeof datapoint[maxAttribute] === 'number'\n    ) {\n      if (\n        measurementValue >= datapoint[minAttribute] &&\n        measurementValue < datapoint[maxAttribute]\n      ) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private assignContextFromContextDashboard(datapoint: KPIDetails) {\n    if (!this.dashboard?.isDeviceTypeDashboard) {\n      return;\n    }\n    const context = this.dashboard?.context;\n    if (context?.id) {\n      const { name, id } = context;\n      datapoint.__target = { name, id };\n    }\n  }\n}\n","import { NgModule } from '@angular/core';\nimport {\n  CoreModule,\n  DynamicComponentDefinition,\n  gettext,\n  HOOK_COMPONENTS\n} from '@c8y/ngx-components';\nimport { ContextWidgetConfig } from '@c8y/ngx-components/context-dashboard';\nimport { DatapointSelectorModule } from '@c8y/ngx-components/datapoint-selector';\nimport { IconSelectorModule } from '@c8y/ngx-components/icon-selector';\nimport { PopoverModule } from 'ngx-bootstrap/popover';\nimport { KpiWidgetConfigComponent } from './kpi-widget-config/kpi-widget-config.component';\nimport { KpiWidgetViewComponent } from './kpi-widget-view/kpi-widget-view.component';\n\n// import for the preview img to get into the build.\nlet previewImage = '';\ntry {\n  // tslint:disable-next-line: no-var-requires\n  previewImage = require('@c8y/style/img/kpi-widget.png');\n} catch (ex) {\n  // intended empty\n}\n\n@NgModule({\n  imports: [CoreModule, DatapointSelectorModule, IconSelectorModule, PopoverModule],\n  declarations: [KpiWidgetViewComponent, KpiWidgetConfigComponent],\n  providers: [\n    {\n      provide: HOOK_COMPONENTS,\n      useValue: [\n        {\n          id: 'kpi.widget',\n          label: gettext('KPI Widget'),\n          description: gettext('Displays the last measurement value of a device.'),\n          component: KpiWidgetViewComponent,\n          configComponent: KpiWidgetConfigComponent,\n          previewImage,\n          data: {\n            settings: {\n              noNewWidgets: false,\n              widgetDefaults: {\n                _width: 2,\n                _height: 2\n              },\n              ng1: {\n                options: {\n                  noDeviceTarget: true,\n                  groupsSelectable: false\n                }\n              }\n            }\n          } as ContextWidgetConfig\n        }\n      ] as DynamicComponentDefinition[],\n      multi: true\n    }\n  ]\n})\nexport class KpiWidgetModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n\nexport {KpiWidgetConfigComponent as ɵb} from './kpi-widget-config/kpi-widget-config.component';\nexport {KpiWidgetViewComponent as ɵa} from './kpi-widget-view/kpi-widget-view.component';"]}